(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{"./node_modules/jquery/dist/jquery.js":function(e,t,r){var n;
/*!
 * jQuery JavaScript Library v3.3.1
 * https://jquery.com/
 *
 * Includes Sizzle.js
 * https://sizzlejs.com/
 *
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2018-01-20T17:24Z
 */
/*!
 * jQuery JavaScript Library v3.3.1
 * https://jquery.com/
 *
 * Includes Sizzle.js
 * https://sizzlejs.com/
 *
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2018-01-20T17:24Z
 */
!function(t,r){"use strict";"object"==typeof e.exports?e.exports=t.document?r(t,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return r(e)}:r(t)}("undefined"!=typeof window?window:this,function(r,i){"use strict";var o=[],a=r.document,s=Object.getPrototypeOf,l=o.slice,u=o.concat,c=o.push,h=o.indexOf,p={},d=p.toString,f=p.hasOwnProperty,m=f.toString,g=m.call(Object),v={},y=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},b=function(e){return null!=e&&e===e.window},w={type:!0,src:!0,noModule:!0};function x(e,t,r){var n,i=(t=t||a).createElement("script");if(i.text=e,r)for(n in w)r[n]&&(i[n]=r[n]);t.head.appendChild(i).parentNode.removeChild(i)}function _(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?p[d.call(e)]||"object":typeof e}var S=function(e,t){return new S.fn.init(e,t)},C=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;function M(e){var t=!!e&&"length"in e&&e.length,r=_(e);return!y(e)&&!b(e)&&("array"===r||0===t||"number"==typeof t&&t>0&&t-1 in e)}S.fn=S.prototype={jquery:"3.3.1",constructor:S,length:0,toArray:function(){return l.call(this)},get:function(e){return null==e?l.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=S.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return S.each(this,e)},map:function(e){return this.pushStack(S.map(this,function(t,r){return e.call(t,r,t)}))},slice:function(){return this.pushStack(l.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,r=+e+(e<0?t:0);return this.pushStack(r>=0&&r<t?[this[r]]:[])},end:function(){return this.prevObject||this.constructor()},push:c,sort:o.sort,splice:o.splice},S.extend=S.fn.extend=function(){var e,t,r,n,i,o,a=arguments[0]||{},s=1,l=arguments.length,u=!1;for("boolean"==typeof a&&(u=a,a=arguments[s]||{},s++),"object"==typeof a||y(a)||(a={}),s===l&&(a=this,s--);s<l;s++)if(null!=(e=arguments[s]))for(t in e)r=a[t],a!==(n=e[t])&&(u&&n&&(S.isPlainObject(n)||(i=Array.isArray(n)))?(i?(i=!1,o=r&&Array.isArray(r)?r:[]):o=r&&S.isPlainObject(r)?r:{},a[t]=S.extend(u,o,n)):void 0!==n&&(a[t]=n));return a},S.extend({expando:"jQuery"+("3.3.1"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,r;return!(!e||"[object Object]"!==d.call(e))&&(!(t=s(e))||"function"==typeof(r=f.call(t,"constructor")&&t.constructor)&&m.call(r)===g)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e){x(e)},each:function(e,t){var r,n=0;if(M(e))for(r=e.length;n<r&&!1!==t.call(e[n],n,e[n]);n++);else for(n in e)if(!1===t.call(e[n],n,e[n]))break;return e},trim:function(e){return null==e?"":(e+"").replace(C,"")},makeArray:function(e,t){var r=t||[];return null!=e&&(M(Object(e))?S.merge(r,"string"==typeof e?[e]:e):c.call(r,e)),r},inArray:function(e,t,r){return null==t?-1:h.call(t,e,r)},merge:function(e,t){for(var r=+t.length,n=0,i=e.length;n<r;n++)e[i++]=t[n];return e.length=i,e},grep:function(e,t,r){for(var n=[],i=0,o=e.length,a=!r;i<o;i++)!t(e[i],i)!==a&&n.push(e[i]);return n},map:function(e,t,r){var n,i,o=0,a=[];if(M(e))for(n=e.length;o<n;o++)null!=(i=t(e[o],o,r))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,r))&&a.push(i);return u.apply([],a)},guid:1,support:v}),"function"==typeof Symbol&&(S.fn[Symbol.iterator]=o[Symbol.iterator]),S.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){p["[object "+t+"]"]=t.toLowerCase()});var T=
/*!
 * Sizzle CSS Selector Engine v2.3.3
 * https://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2016-08-08
 */
function(e){var t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w="sizzle"+1*new Date,x=e.document,_=0,S=0,C=ae(),M=ae(),T=ae(),A=function(e,t){return e===t&&(h=!0),0},E={}.hasOwnProperty,P=[],R=P.pop,I=P.push,N=P.push,D=P.slice,k=function(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1},O="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",F="[\\x20\\t\\r\\n\\f]",L="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",U="\\["+F+"*("+L+")(?:"+F+"*([*^$|!~]?=)"+F+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+L+"))|)"+F+"*\\]",V=":("+L+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+U+")*)|.*)\\)|)",B=new RegExp(F+"+","g"),z=new RegExp("^"+F+"+|((?:^|[^\\\\])(?:\\\\.)*)"+F+"+$","g"),j=new RegExp("^"+F+"*,"+F+"*"),H=new RegExp("^"+F+"*([>+~]|"+F+")"+F+"*"),$=new RegExp("="+F+"*([^\\]'\"]*?)"+F+"*\\]","g"),G=new RegExp(V),W=new RegExp("^"+L+"$"),q={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L+"|[*])"),ATTR:new RegExp("^"+U),PSEUDO:new RegExp("^"+V),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+F+"*(even|odd|(([+-]|)(\\d*)n|)"+F+"*(?:([+-]|)"+F+"*(\\d+)|))"+F+"*\\)|)","i"),bool:new RegExp("^(?:"+O+")$","i"),needsContext:new RegExp("^"+F+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+F+"*((?:-\\d)?\\d*)"+F+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,K=/^h\d$/i,Y=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,J=/[+~]/,Q=new RegExp("\\\\([\\da-f]{1,6}"+F+"?|("+F+")|.)","ig"),ee=function(e,t,r){var n="0x"+t-65536;return n!=n||r?t:n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320)},te=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,re=function(e,t){return t?"\0"===e?"ï¿½":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},ne=function(){p()},ie=ye(function(e){return!0===e.disabled&&("form"in e||"label"in e)},{dir:"parentNode",next:"legend"});try{N.apply(P=D.call(x.childNodes),x.childNodes),P[x.childNodes.length].nodeType}catch(e){N={apply:P.length?function(e,t){I.apply(e,D.call(t))}:function(e,t){for(var r=e.length,n=0;e[r++]=t[n++];);e.length=r-1}}}function oe(e,t,n,i){var o,s,u,c,h,f,v,y=t&&t.ownerDocument,_=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==_&&9!==_&&11!==_)return n;if(!i&&((t?t.ownerDocument||t:x)!==d&&p(t),t=t||d,m)){if(11!==_&&(h=Z.exec(e)))if(o=h[1]){if(9===_){if(!(u=t.getElementById(o)))return n;if(u.id===o)return n.push(u),n}else if(y&&(u=y.getElementById(o))&&b(t,u)&&u.id===o)return n.push(u),n}else{if(h[2])return N.apply(n,t.getElementsByTagName(e)),n;if((o=h[3])&&r.getElementsByClassName&&t.getElementsByClassName)return N.apply(n,t.getElementsByClassName(o)),n}if(r.qsa&&!T[e+" "]&&(!g||!g.test(e))){if(1!==_)y=t,v=e;else if("object"!==t.nodeName.toLowerCase()){for((c=t.getAttribute("id"))?c=c.replace(te,re):t.setAttribute("id",c=w),s=(f=a(e)).length;s--;)f[s]="#"+c+" "+ve(f[s]);v=f.join(","),y=J.test(e)&&me(t.parentNode)||t}if(v)try{return N.apply(n,y.querySelectorAll(v)),n}catch(e){}finally{c===w&&t.removeAttribute("id")}}}return l(e.replace(z,"$1"),t,n,i)}function ae(){var e=[];return function t(r,i){return e.push(r+" ")>n.cacheLength&&delete t[e.shift()],t[r+" "]=i}}function se(e){return e[w]=!0,e}function le(e){var t=d.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function ue(e,t){for(var r=e.split("|"),i=r.length;i--;)n.attrHandle[r[i]]=t}function ce(e,t){var r=t&&e,n=r&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(n)return n;if(r)for(;r=r.nextSibling;)if(r===t)return-1;return e?1:-1}function he(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}function pe(e){return function(t){var r=t.nodeName.toLowerCase();return("input"===r||"button"===r)&&t.type===e}}function de(e){return function(t){return"form"in t?t.parentNode&&!1===t.disabled?"label"in t?"label"in t.parentNode?t.parentNode.disabled===e:t.disabled===e:t.isDisabled===e||t.isDisabled!==!e&&ie(t)===e:t.disabled===e:"label"in t&&t.disabled===e}}function fe(e){return se(function(t){return t=+t,se(function(r,n){for(var i,o=e([],r.length,t),a=o.length;a--;)r[i=o[a]]&&(r[i]=!(n[i]=r[i]))})})}function me(e){return e&&void 0!==e.getElementsByTagName&&e}for(t in r=oe.support={},o=oe.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},p=oe.setDocument=function(e){var t,i,a=e?e.ownerDocument||e:x;return a!==d&&9===a.nodeType&&a.documentElement?(f=(d=a).documentElement,m=!o(d),x!==d&&(i=d.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",ne,!1):i.attachEvent&&i.attachEvent("onunload",ne)),r.attributes=le(function(e){return e.className="i",!e.getAttribute("className")}),r.getElementsByTagName=le(function(e){return e.appendChild(d.createComment("")),!e.getElementsByTagName("*").length}),r.getElementsByClassName=Y.test(d.getElementsByClassName),r.getById=le(function(e){return f.appendChild(e).id=w,!d.getElementsByName||!d.getElementsByName(w).length}),r.getById?(n.filter.ID=function(e){var t=e.replace(Q,ee);return function(e){return e.getAttribute("id")===t}},n.find.ID=function(e,t){if(void 0!==t.getElementById&&m){var r=t.getElementById(e);return r?[r]:[]}}):(n.filter.ID=function(e){var t=e.replace(Q,ee);return function(e){var r=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return r&&r.value===t}},n.find.ID=function(e,t){if(void 0!==t.getElementById&&m){var r,n,i,o=t.getElementById(e);if(o){if((r=o.getAttributeNode("id"))&&r.value===e)return[o];for(i=t.getElementsByName(e),n=0;o=i[n++];)if((r=o.getAttributeNode("id"))&&r.value===e)return[o]}return[]}}),n.find.TAG=r.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):r.qsa?t.querySelectorAll(e):void 0}:function(e,t){var r,n=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;r=o[i++];)1===r.nodeType&&n.push(r);return n}return o},n.find.CLASS=r.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&m)return t.getElementsByClassName(e)},v=[],g=[],(r.qsa=Y.test(d.querySelectorAll))&&(le(function(e){f.appendChild(e).innerHTML="<a id='"+w+"'></a><select id='"+w+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&g.push("[*^$]="+F+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||g.push("\\["+F+"*(?:value|"+O+")"),e.querySelectorAll("[id~="+w+"-]").length||g.push("~="),e.querySelectorAll(":checked").length||g.push(":checked"),e.querySelectorAll("a#"+w+"+*").length||g.push(".#.+[+~]")}),le(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=d.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&g.push("name"+F+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&g.push(":enabled",":disabled"),f.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&g.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),g.push(",.*:")})),(r.matchesSelector=Y.test(y=f.matches||f.webkitMatchesSelector||f.mozMatchesSelector||f.oMatchesSelector||f.msMatchesSelector))&&le(function(e){r.disconnectedMatch=y.call(e,"*"),y.call(e,"[s!='']:x"),v.push("!=",V)}),g=g.length&&new RegExp(g.join("|")),v=v.length&&new RegExp(v.join("|")),t=Y.test(f.compareDocumentPosition),b=t||Y.test(f.contains)?function(e,t){var r=9===e.nodeType?e.documentElement:e,n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(r.contains?r.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},A=t?function(e,t){if(e===t)return h=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!r.sortDetached&&t.compareDocumentPosition(e)===n?e===d||e.ownerDocument===x&&b(x,e)?-1:t===d||t.ownerDocument===x&&b(x,t)?1:c?k(c,e)-k(c,t):0:4&n?-1:1)}:function(e,t){if(e===t)return h=!0,0;var r,n=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===d?-1:t===d?1:i?-1:o?1:c?k(c,e)-k(c,t):0;if(i===o)return ce(e,t);for(r=e;r=r.parentNode;)a.unshift(r);for(r=t;r=r.parentNode;)s.unshift(r);for(;a[n]===s[n];)n++;return n?ce(a[n],s[n]):a[n]===x?-1:s[n]===x?1:0},d):d},oe.matches=function(e,t){return oe(e,null,null,t)},oe.matchesSelector=function(e,t){if((e.ownerDocument||e)!==d&&p(e),t=t.replace($,"='$1']"),r.matchesSelector&&m&&!T[t+" "]&&(!v||!v.test(t))&&(!g||!g.test(t)))try{var n=y.call(e,t);if(n||r.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){}return oe(t,d,null,[e]).length>0},oe.contains=function(e,t){return(e.ownerDocument||e)!==d&&p(e),b(e,t)},oe.attr=function(e,t){(e.ownerDocument||e)!==d&&p(e);var i=n.attrHandle[t.toLowerCase()],o=i&&E.call(n.attrHandle,t.toLowerCase())?i(e,t,!m):void 0;return void 0!==o?o:r.attributes||!m?e.getAttribute(t):(o=e.getAttributeNode(t))&&o.specified?o.value:null},oe.escape=function(e){return(e+"").replace(te,re)},oe.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},oe.uniqueSort=function(e){var t,n=[],i=0,o=0;if(h=!r.detectDuplicates,c=!r.sortStable&&e.slice(0),e.sort(A),h){for(;t=e[o++];)t===e[o]&&(i=n.push(o));for(;i--;)e.splice(n[i],1)}return c=null,e},i=oe.getText=function(e){var t,r="",n=0,o=e.nodeType;if(o){if(1===o||9===o||11===o){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)r+=i(e)}else if(3===o||4===o)return e.nodeValue}else for(;t=e[n++];)r+=i(t);return r},(n=oe.selectors={cacheLength:50,createPseudo:se,match:q,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Q,ee),e[3]=(e[3]||e[4]||e[5]||"").replace(Q,ee),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||oe.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&oe.error(e[0]),e},PSEUDO:function(e){var t,r=!e[6]&&e[2];return q.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":r&&G.test(r)&&(t=a(r,!0))&&(t=r.indexOf(")",r.length-t)-r.length)&&(e[0]=e[0].slice(0,t),e[2]=r.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Q,ee).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=C[e+" "];return t||(t=new RegExp("(^|"+F+")"+e+"("+F+"|$)"))&&C(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,t,r){return function(n){var i=oe.attr(n,e);return null==i?"!="===t:!t||(i+="","="===t?i===r:"!="===t?i!==r:"^="===t?r&&0===i.indexOf(r):"*="===t?r&&i.indexOf(r)>-1:"$="===t?r&&i.slice(-r.length)===r:"~="===t?(" "+i.replace(B," ")+" ").indexOf(r)>-1:"|="===t&&(i===r||i.slice(0,r.length+1)===r+"-"))}},CHILD:function(e,t,r,n,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===n&&0===i?function(e){return!!e.parentNode}:function(t,r,l){var u,c,h,p,d,f,m=o!==a?"nextSibling":"previousSibling",g=t.parentNode,v=s&&t.nodeName.toLowerCase(),y=!l&&!s,b=!1;if(g){if(o){for(;m;){for(p=t;p=p[m];)if(s?p.nodeName.toLowerCase()===v:1===p.nodeType)return!1;f=m="only"===e&&!f&&"nextSibling"}return!0}if(f=[a?g.firstChild:g.lastChild],a&&y){for(b=(d=(u=(c=(h=(p=g)[w]||(p[w]={}))[p.uniqueID]||(h[p.uniqueID]={}))[e]||[])[0]===_&&u[1])&&u[2],p=d&&g.childNodes[d];p=++d&&p&&p[m]||(b=d=0)||f.pop();)if(1===p.nodeType&&++b&&p===t){c[e]=[_,d,b];break}}else if(y&&(b=d=(u=(c=(h=(p=t)[w]||(p[w]={}))[p.uniqueID]||(h[p.uniqueID]={}))[e]||[])[0]===_&&u[1]),!1===b)for(;(p=++d&&p&&p[m]||(b=d=0)||f.pop())&&((s?p.nodeName.toLowerCase()!==v:1!==p.nodeType)||!++b||(y&&((c=(h=p[w]||(p[w]={}))[p.uniqueID]||(h[p.uniqueID]={}))[e]=[_,b]),p!==t)););return(b-=i)===n||b%n==0&&b/n>=0}}},PSEUDO:function(e,t){var r,i=n.pseudos[e]||n.setFilters[e.toLowerCase()]||oe.error("unsupported pseudo: "+e);return i[w]?i(t):i.length>1?(r=[e,e,"",t],n.setFilters.hasOwnProperty(e.toLowerCase())?se(function(e,r){for(var n,o=i(e,t),a=o.length;a--;)e[n=k(e,o[a])]=!(r[n]=o[a])}):function(e){return i(e,0,r)}):i}},pseudos:{not:se(function(e){var t=[],r=[],n=s(e.replace(z,"$1"));return n[w]?se(function(e,t,r,i){for(var o,a=n(e,null,i,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,n(t,null,o,r),t[0]=null,!r.pop()}}),has:se(function(e){return function(t){return oe(e,t).length>0}}),contains:se(function(e){return e=e.replace(Q,ee),function(t){return(t.textContent||t.innerText||i(t)).indexOf(e)>-1}}),lang:se(function(e){return W.test(e||"")||oe.error("unsupported lang: "+e),e=e.replace(Q,ee).toLowerCase(),function(t){var r;do{if(r=m?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(r=r.toLowerCase())===e||0===r.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var r=e.location&&e.location.hash;return r&&r.slice(1)===t.id},root:function(e){return e===f},focus:function(e){return e===d.activeElement&&(!d.hasFocus||d.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:de(!1),disabled:de(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!n.pseudos.empty(e)},header:function(e){return K.test(e.nodeName)},input:function(e){return X.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:fe(function(){return[0]}),last:fe(function(e,t){return[t-1]}),eq:fe(function(e,t,r){return[r<0?r+t:r]}),even:fe(function(e,t){for(var r=0;r<t;r+=2)e.push(r);return e}),odd:fe(function(e,t){for(var r=1;r<t;r+=2)e.push(r);return e}),lt:fe(function(e,t,r){for(var n=r<0?r+t:r;--n>=0;)e.push(n);return e}),gt:fe(function(e,t,r){for(var n=r<0?r+t:r;++n<t;)e.push(n);return e})}}).pseudos.nth=n.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})n.pseudos[t]=he(t);for(t in{submit:!0,reset:!0})n.pseudos[t]=pe(t);function ge(){}function ve(e){for(var t=0,r=e.length,n="";t<r;t++)n+=e[t].value;return n}function ye(e,t,r){var n=t.dir,i=t.next,o=i||n,a=r&&"parentNode"===o,s=S++;return t.first?function(t,r,i){for(;t=t[n];)if(1===t.nodeType||a)return e(t,r,i);return!1}:function(t,r,l){var u,c,h,p=[_,s];if(l){for(;t=t[n];)if((1===t.nodeType||a)&&e(t,r,l))return!0}else for(;t=t[n];)if(1===t.nodeType||a)if(c=(h=t[w]||(t[w]={}))[t.uniqueID]||(h[t.uniqueID]={}),i&&i===t.nodeName.toLowerCase())t=t[n]||t;else{if((u=c[o])&&u[0]===_&&u[1]===s)return p[2]=u[2];if(c[o]=p,p[2]=e(t,r,l))return!0}return!1}}function be(e){return e.length>1?function(t,r,n){for(var i=e.length;i--;)if(!e[i](t,r,n))return!1;return!0}:e[0]}function we(e,t,r,n,i){for(var o,a=[],s=0,l=e.length,u=null!=t;s<l;s++)(o=e[s])&&(r&&!r(o,n,i)||(a.push(o),u&&t.push(s)));return a}function xe(e,t,r,n,i,o){return n&&!n[w]&&(n=xe(n)),i&&!i[w]&&(i=xe(i,o)),se(function(o,a,s,l){var u,c,h,p=[],d=[],f=a.length,m=o||function(e,t,r){for(var n=0,i=t.length;n<i;n++)oe(e,t[n],r);return r}(t||"*",s.nodeType?[s]:s,[]),g=!e||!o&&t?m:we(m,p,e,s,l),v=r?i||(o?e:f||n)?[]:a:g;if(r&&r(g,v,s,l),n)for(u=we(v,d),n(u,[],s,l),c=u.length;c--;)(h=u[c])&&(v[d[c]]=!(g[d[c]]=h));if(o){if(i||e){if(i){for(u=[],c=v.length;c--;)(h=v[c])&&u.push(g[c]=h);i(null,v=[],u,l)}for(c=v.length;c--;)(h=v[c])&&(u=i?k(o,h):p[c])>-1&&(o[u]=!(a[u]=h))}}else v=we(v===a?v.splice(f,v.length):v),i?i(null,a,v,l):N.apply(a,v)})}function _e(e){for(var t,r,i,o=e.length,a=n.relative[e[0].type],s=a||n.relative[" "],l=a?1:0,c=ye(function(e){return e===t},s,!0),h=ye(function(e){return k(t,e)>-1},s,!0),p=[function(e,r,n){var i=!a&&(n||r!==u)||((t=r).nodeType?c(e,r,n):h(e,r,n));return t=null,i}];l<o;l++)if(r=n.relative[e[l].type])p=[ye(be(p),r)];else{if((r=n.filter[e[l].type].apply(null,e[l].matches))[w]){for(i=++l;i<o&&!n.relative[e[i].type];i++);return xe(l>1&&be(p),l>1&&ve(e.slice(0,l-1).concat({value:" "===e[l-2].type?"*":""})).replace(z,"$1"),r,l<i&&_e(e.slice(l,i)),i<o&&_e(e=e.slice(i)),i<o&&ve(e))}p.push(r)}return be(p)}return ge.prototype=n.filters=n.pseudos,n.setFilters=new ge,a=oe.tokenize=function(e,t){var r,i,o,a,s,l,u,c=M[e+" "];if(c)return t?0:c.slice(0);for(s=e,l=[],u=n.preFilter;s;){for(a in r&&!(i=j.exec(s))||(i&&(s=s.slice(i[0].length)||s),l.push(o=[])),r=!1,(i=H.exec(s))&&(r=i.shift(),o.push({value:r,type:i[0].replace(z," ")}),s=s.slice(r.length)),n.filter)!(i=q[a].exec(s))||u[a]&&!(i=u[a](i))||(r=i.shift(),o.push({value:r,type:a,matches:i}),s=s.slice(r.length));if(!r)break}return t?s.length:s?oe.error(e):M(e,l).slice(0)},s=oe.compile=function(e,t){var r,i=[],o=[],s=T[e+" "];if(!s){for(t||(t=a(e)),r=t.length;r--;)(s=_e(t[r]))[w]?i.push(s):o.push(s);(s=T(e,function(e,t){var r=t.length>0,i=e.length>0,o=function(o,a,s,l,c){var h,f,g,v=0,y="0",b=o&&[],w=[],x=u,S=o||i&&n.find.TAG("*",c),C=_+=null==x?1:Math.random()||.1,M=S.length;for(c&&(u=a===d||a||c);y!==M&&null!=(h=S[y]);y++){if(i&&h){for(f=0,a||h.ownerDocument===d||(p(h),s=!m);g=e[f++];)if(g(h,a||d,s)){l.push(h);break}c&&(_=C)}r&&((h=!g&&h)&&v--,o&&b.push(h))}if(v+=y,r&&y!==v){for(f=0;g=t[f++];)g(b,w,a,s);if(o){if(v>0)for(;y--;)b[y]||w[y]||(w[y]=R.call(l));w=we(w)}N.apply(l,w),c&&!o&&w.length>0&&v+t.length>1&&oe.uniqueSort(l)}return c&&(_=C,u=x),b};return r?se(o):o}(o,i))).selector=e}return s},l=oe.select=function(e,t,r,i){var o,l,u,c,h,p="function"==typeof e&&e,d=!i&&a(e=p.selector||e);if(r=r||[],1===d.length){if((l=d[0]=d[0].slice(0)).length>2&&"ID"===(u=l[0]).type&&9===t.nodeType&&m&&n.relative[l[1].type]){if(!(t=(n.find.ID(u.matches[0].replace(Q,ee),t)||[])[0]))return r;p&&(t=t.parentNode),e=e.slice(l.shift().value.length)}for(o=q.needsContext.test(e)?0:l.length;o--&&(u=l[o],!n.relative[c=u.type]);)if((h=n.find[c])&&(i=h(u.matches[0].replace(Q,ee),J.test(l[0].type)&&me(t.parentNode)||t))){if(l.splice(o,1),!(e=i.length&&ve(l)))return N.apply(r,i),r;break}}return(p||s(e,d))(i,t,!m,r,!t||J.test(e)&&me(t.parentNode)||t),r},r.sortStable=w.split("").sort(A).join("")===w,r.detectDuplicates=!!h,p(),r.sortDetached=le(function(e){return 1&e.compareDocumentPosition(d.createElement("fieldset"))}),le(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||ue("type|href|height|width",function(e,t,r){if(!r)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),r.attributes&&le(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||ue("value",function(e,t,r){if(!r&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),le(function(e){return null==e.getAttribute("disabled")})||ue(O,function(e,t,r){var n;if(!r)return!0===e[t]?t.toLowerCase():(n=e.getAttributeNode(t))&&n.specified?n.value:null}),oe}(r);S.find=T,S.expr=T.selectors,S.expr[":"]=S.expr.pseudos,S.uniqueSort=S.unique=T.uniqueSort,S.text=T.getText,S.isXMLDoc=T.isXML,S.contains=T.contains,S.escapeSelector=T.escape;var A=function(e,t,r){for(var n=[],i=void 0!==r;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&S(e).is(r))break;n.push(e)}return n},E=function(e,t){for(var r=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&r.push(e);return r},P=S.expr.match.needsContext;function R(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var I=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function N(e,t,r){return y(t)?S.grep(e,function(e,n){return!!t.call(e,n,e)!==r}):t.nodeType?S.grep(e,function(e){return e===t!==r}):"string"!=typeof t?S.grep(e,function(e){return h.call(t,e)>-1!==r}):S.filter(t,e,r)}S.filter=function(e,t,r){var n=t[0];return r&&(e=":not("+e+")"),1===t.length&&1===n.nodeType?S.find.matchesSelector(n,e)?[n]:[]:S.find.matches(e,S.grep(t,function(e){return 1===e.nodeType}))},S.fn.extend({find:function(e){var t,r,n=this.length,i=this;if("string"!=typeof e)return this.pushStack(S(e).filter(function(){for(t=0;t<n;t++)if(S.contains(i[t],this))return!0}));for(r=this.pushStack([]),t=0;t<n;t++)S.find(e,i[t],r);return n>1?S.uniqueSort(r):r},filter:function(e){return this.pushStack(N(this,e||[],!1))},not:function(e){return this.pushStack(N(this,e||[],!0))},is:function(e){return!!N(this,"string"==typeof e&&P.test(e)?S(e):e||[],!1).length}});var D,k=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(S.fn.init=function(e,t,r){var n,i;if(!e)return this;if(r=r||D,"string"==typeof e){if(!(n="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:k.exec(e))||!n[1]&&t)return!t||t.jquery?(t||r).find(e):this.constructor(t).find(e);if(n[1]){if(t=t instanceof S?t[0]:t,S.merge(this,S.parseHTML(n[1],t&&t.nodeType?t.ownerDocument||t:a,!0)),I.test(n[1])&&S.isPlainObject(t))for(n in t)y(this[n])?this[n](t[n]):this.attr(n,t[n]);return this}return(i=a.getElementById(n[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):y(e)?void 0!==r.ready?r.ready(e):e(S):S.makeArray(e,this)}).prototype=S.fn,D=S(a);var O=/^(?:parents|prev(?:Until|All))/,F={children:!0,contents:!0,next:!0,prev:!0};function L(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}S.fn.extend({has:function(e){var t=S(e,this),r=t.length;return this.filter(function(){for(var e=0;e<r;e++)if(S.contains(this,t[e]))return!0})},closest:function(e,t){var r,n=0,i=this.length,o=[],a="string"!=typeof e&&S(e);if(!P.test(e))for(;n<i;n++)for(r=this[n];r&&r!==t;r=r.parentNode)if(r.nodeType<11&&(a?a.index(r)>-1:1===r.nodeType&&S.find.matchesSelector(r,e))){o.push(r);break}return this.pushStack(o.length>1?S.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?h.call(S(e),this[0]):h.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(S.uniqueSort(S.merge(this.get(),S(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),S.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return A(e,"parentNode")},parentsUntil:function(e,t,r){return A(e,"parentNode",r)},next:function(e){return L(e,"nextSibling")},prev:function(e){return L(e,"previousSibling")},nextAll:function(e){return A(e,"nextSibling")},prevAll:function(e){return A(e,"previousSibling")},nextUntil:function(e,t,r){return A(e,"nextSibling",r)},prevUntil:function(e,t,r){return A(e,"previousSibling",r)},siblings:function(e){return E((e.parentNode||{}).firstChild,e)},children:function(e){return E(e.firstChild)},contents:function(e){return R(e,"iframe")?e.contentDocument:(R(e,"template")&&(e=e.content||e),S.merge([],e.childNodes))}},function(e,t){S.fn[e]=function(r,n){var i=S.map(this,t,r);return"Until"!==e.slice(-5)&&(n=r),n&&"string"==typeof n&&(i=S.filter(n,i)),this.length>1&&(F[e]||S.uniqueSort(i),O.test(e)&&i.reverse()),this.pushStack(i)}});var U=/[^\x20\t\r\n\f]+/g;function V(e){return e}function B(e){throw e}function z(e,t,r,n){var i;try{e&&y(i=e.promise)?i.call(e).done(t).fail(r):e&&y(i=e.then)?i.call(e,t,r):t.apply(void 0,[e].slice(n))}catch(e){r.apply(void 0,[e])}}S.Callbacks=function(e){e="string"==typeof e?function(e){var t={};return S.each(e.match(U)||[],function(e,r){t[r]=!0}),t}(e):S.extend({},e);var t,r,n,i,o=[],a=[],s=-1,l=function(){for(i=i||e.once,n=t=!0;a.length;s=-1)for(r=a.shift();++s<o.length;)!1===o[s].apply(r[0],r[1])&&e.stopOnFalse&&(s=o.length,r=!1);e.memory||(r=!1),t=!1,i&&(o=r?[]:"")},u={add:function(){return o&&(r&&!t&&(s=o.length-1,a.push(r)),function t(r){S.each(r,function(r,n){y(n)?e.unique&&u.has(n)||o.push(n):n&&n.length&&"string"!==_(n)&&t(n)})}(arguments),r&&!t&&l()),this},remove:function(){return S.each(arguments,function(e,t){for(var r;(r=S.inArray(t,o,r))>-1;)o.splice(r,1),r<=s&&s--}),this},has:function(e){return e?S.inArray(e,o)>-1:o.length>0},empty:function(){return o&&(o=[]),this},disable:function(){return i=a=[],o=r="",this},disabled:function(){return!o},lock:function(){return i=a=[],r||t||(o=r=""),this},locked:function(){return!!i},fireWith:function(e,r){return i||(r=[e,(r=r||[]).slice?r.slice():r],a.push(r),t||l()),this},fire:function(){return u.fireWith(this,arguments),this},fired:function(){return!!n}};return u},S.extend({Deferred:function(e){var t=[["notify","progress",S.Callbacks("memory"),S.Callbacks("memory"),2],["resolve","done",S.Callbacks("once memory"),S.Callbacks("once memory"),0,"resolved"],["reject","fail",S.Callbacks("once memory"),S.Callbacks("once memory"),1,"rejected"]],n="pending",i={state:function(){return n},always:function(){return o.done(arguments).fail(arguments),this},catch:function(e){return i.then(null,e)},pipe:function(){var e=arguments;return S.Deferred(function(r){S.each(t,function(t,n){var i=y(e[n[4]])&&e[n[4]];o[n[1]](function(){var e=i&&i.apply(this,arguments);e&&y(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[n[0]+"With"](this,i?[e]:arguments)})}),e=null}).promise()},then:function(e,n,i){var o=0;function a(e,t,n,i){return function(){var s=this,l=arguments,u=function(){var r,u;if(!(e<o)){if((r=n.apply(s,l))===t.promise())throw new TypeError("Thenable self-resolution");u=r&&("object"==typeof r||"function"==typeof r)&&r.then,y(u)?i?u.call(r,a(o,t,V,i),a(o,t,B,i)):(o++,u.call(r,a(o,t,V,i),a(o,t,B,i),a(o,t,V,t.notifyWith))):(n!==V&&(s=void 0,l=[r]),(i||t.resolveWith)(s,l))}},c=i?u:function(){try{u()}catch(r){S.Deferred.exceptionHook&&S.Deferred.exceptionHook(r,c.stackTrace),e+1>=o&&(n!==B&&(s=void 0,l=[r]),t.rejectWith(s,l))}};e?c():(S.Deferred.getStackHook&&(c.stackTrace=S.Deferred.getStackHook()),r.setTimeout(c))}}return S.Deferred(function(r){t[0][3].add(a(0,r,y(i)?i:V,r.notifyWith)),t[1][3].add(a(0,r,y(e)?e:V)),t[2][3].add(a(0,r,y(n)?n:B))}).promise()},promise:function(e){return null!=e?S.extend(e,i):i}},o={};return S.each(t,function(e,r){var a=r[2],s=r[5];i[r[1]]=a.add,s&&a.add(function(){n=s},t[3-e][2].disable,t[3-e][3].disable,t[0][2].lock,t[0][3].lock),a.add(r[3].fire),o[r[0]]=function(){return o[r[0]+"With"](this===o?void 0:this,arguments),this},o[r[0]+"With"]=a.fireWith}),i.promise(o),e&&e.call(o,o),o},when:function(e){var t=arguments.length,r=t,n=Array(r),i=l.call(arguments),o=S.Deferred(),a=function(e){return function(r){n[e]=this,i[e]=arguments.length>1?l.call(arguments):r,--t||o.resolveWith(n,i)}};if(t<=1&&(z(e,o.done(a(r)).resolve,o.reject,!t),"pending"===o.state()||y(i[r]&&i[r].then)))return o.then();for(;r--;)z(i[r],a(r),o.reject);return o.promise()}});var j=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;S.Deferred.exceptionHook=function(e,t){r.console&&r.console.warn&&e&&j.test(e.name)&&r.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},S.readyException=function(e){r.setTimeout(function(){throw e})};var H=S.Deferred();function $(){a.removeEventListener("DOMContentLoaded",$),r.removeEventListener("load",$),S.ready()}S.fn.ready=function(e){return H.then(e).catch(function(e){S.readyException(e)}),this},S.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--S.readyWait:S.isReady)||(S.isReady=!0,!0!==e&&--S.readyWait>0||H.resolveWith(a,[S]))}}),S.ready.then=H.then,"complete"===a.readyState||"loading"!==a.readyState&&!a.documentElement.doScroll?r.setTimeout(S.ready):(a.addEventListener("DOMContentLoaded",$),r.addEventListener("load",$));var G=function(e,t,r,n,i,o,a){var s=0,l=e.length,u=null==r;if("object"===_(r))for(s in i=!0,r)G(e,t,s,r[s],!0,o,a);else if(void 0!==n&&(i=!0,y(n)||(a=!0),u&&(a?(t.call(e,n),t=null):(u=t,t=function(e,t,r){return u.call(S(e),r)})),t))for(;s<l;s++)t(e[s],r,a?n:n.call(e[s],s,t(e[s],r)));return i?e:u?t.call(e):l?t(e[0],r):o},W=/^-ms-/,q=/-([a-z])/g;function X(e,t){return t.toUpperCase()}function K(e){return e.replace(W,"ms-").replace(q,X)}var Y=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function Z(){this.expando=S.expando+Z.uid++}Z.uid=1,Z.prototype={cache:function(e){var t=e[this.expando];return t||(t={},Y(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,r){var n,i=this.cache(e);if("string"==typeof t)i[K(t)]=r;else for(n in t)i[K(n)]=t[n];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][K(t)]},access:function(e,t,r){return void 0===t||t&&"string"==typeof t&&void 0===r?this.get(e,t):(this.set(e,t,r),void 0!==r?r:t)},remove:function(e,t){var r,n=e[this.expando];if(void 0!==n){if(void 0!==t){r=(t=Array.isArray(t)?t.map(K):(t=K(t))in n?[t]:t.match(U)||[]).length;for(;r--;)delete n[t[r]]}(void 0===t||S.isEmptyObject(n))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!S.isEmptyObject(t)}};var J=new Z,Q=new Z,ee=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,te=/[A-Z]/g;function re(e,t,r){var n;if(void 0===r&&1===e.nodeType)if(n="data-"+t.replace(te,"-$&").toLowerCase(),"string"==typeof(r=e.getAttribute(n))){try{r=function(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:ee.test(e)?JSON.parse(e):e)}(r)}catch(e){}Q.set(e,t,r)}else r=void 0;return r}S.extend({hasData:function(e){return Q.hasData(e)||J.hasData(e)},data:function(e,t,r){return Q.access(e,t,r)},removeData:function(e,t){Q.remove(e,t)},_data:function(e,t,r){return J.access(e,t,r)},_removeData:function(e,t){J.remove(e,t)}}),S.fn.extend({data:function(e,t){var r,n,i,o=this[0],a=o&&o.attributes;if(void 0===e){if(this.length&&(i=Q.get(o),1===o.nodeType&&!J.get(o,"hasDataAttrs"))){for(r=a.length;r--;)a[r]&&0===(n=a[r].name).indexOf("data-")&&(n=K(n.slice(5)),re(o,n,i[n]));J.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof e?this.each(function(){Q.set(this,e)}):G(this,function(t){var r;if(o&&void 0===t)return void 0!==(r=Q.get(o,e))?r:void 0!==(r=re(o,e))?r:void 0;this.each(function(){Q.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){Q.remove(this,e)})}}),S.extend({queue:function(e,t,r){var n;if(e)return t=(t||"fx")+"queue",n=J.get(e,t),r&&(!n||Array.isArray(r)?n=J.access(e,t,S.makeArray(r)):n.push(r)),n||[]},dequeue:function(e,t){t=t||"fx";var r=S.queue(e,t),n=r.length,i=r.shift(),o=S._queueHooks(e,t);"inprogress"===i&&(i=r.shift(),n--),i&&("fx"===t&&r.unshift("inprogress"),delete o.stop,i.call(e,function(){S.dequeue(e,t)},o)),!n&&o&&o.empty.fire()},_queueHooks:function(e,t){var r=t+"queueHooks";return J.get(e,r)||J.access(e,r,{empty:S.Callbacks("once memory").add(function(){J.remove(e,[t+"queue",r])})})}}),S.fn.extend({queue:function(e,t){var r=2;return"string"!=typeof e&&(t=e,e="fx",r--),arguments.length<r?S.queue(this[0],e):void 0===t?this:this.each(function(){var r=S.queue(this,e,t);S._queueHooks(this,e),"fx"===e&&"inprogress"!==r[0]&&S.dequeue(this,e)})},dequeue:function(e){return this.each(function(){S.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var r,n=1,i=S.Deferred(),o=this,a=this.length,s=function(){--n||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(r=J.get(o[a],e+"queueHooks"))&&r.empty&&(n++,r.empty.add(s));return s(),i.promise(t)}});var ne=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ie=new RegExp("^(?:([+-])=|)("+ne+")([a-z%]*)$","i"),oe=["Top","Right","Bottom","Left"],ae=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&S.contains(e.ownerDocument,e)&&"none"===S.css(e,"display")},se=function(e,t,r,n){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=r.apply(e,n||[]),t)e.style[o]=a[o];return i};function le(e,t,r,n){var i,o,a=20,s=n?function(){return n.cur()}:function(){return S.css(e,t,"")},l=s(),u=r&&r[3]||(S.cssNumber[t]?"":"px"),c=(S.cssNumber[t]||"px"!==u&&+l)&&ie.exec(S.css(e,t));if(c&&c[3]!==u){for(l/=2,u=u||c[3],c=+l||1;a--;)S.style(e,t,c+u),(1-o)*(1-(o=s()/l||.5))<=0&&(a=0),c/=o;c*=2,S.style(e,t,c+u),r=r||[]}return r&&(c=+c||+l||0,i=r[1]?c+(r[1]+1)*r[2]:+r[2],n&&(n.unit=u,n.start=c,n.end=i)),i}var ue={};function ce(e){var t,r=e.ownerDocument,n=e.nodeName,i=ue[n];return i||(t=r.body.appendChild(r.createElement(n)),i=S.css(t,"display"),t.parentNode.removeChild(t),"none"===i&&(i="block"),ue[n]=i,i)}function he(e,t){for(var r,n,i=[],o=0,a=e.length;o<a;o++)(n=e[o]).style&&(r=n.style.display,t?("none"===r&&(i[o]=J.get(n,"display")||null,i[o]||(n.style.display="")),""===n.style.display&&ae(n)&&(i[o]=ce(n))):"none"!==r&&(i[o]="none",J.set(n,"display",r)));for(o=0;o<a;o++)null!=i[o]&&(e[o].style.display=i[o]);return e}S.fn.extend({show:function(){return he(this,!0)},hide:function(){return he(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ae(this)?S(this).show():S(this).hide()})}});var pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]+)/i,fe=/^$|^module$|\/(?:java|ecma)script/i,me={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ge(e,t){var r;return r=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&R(e,t)?S.merge([e],r):r}function ve(e,t){for(var r=0,n=e.length;r<n;r++)J.set(e[r],"globalEval",!t||J.get(t[r],"globalEval"))}me.optgroup=me.option,me.tbody=me.tfoot=me.colgroup=me.caption=me.thead,me.th=me.td;var ye=/<|&#?\w+;/;function be(e,t,r,n,i){for(var o,a,s,l,u,c,h=t.createDocumentFragment(),p=[],d=0,f=e.length;d<f;d++)if((o=e[d])||0===o)if("object"===_(o))S.merge(p,o.nodeType?[o]:o);else if(ye.test(o)){for(a=a||h.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),l=me[s]||me._default,a.innerHTML=l[1]+S.htmlPrefilter(o)+l[2],c=l[0];c--;)a=a.lastChild;S.merge(p,a.childNodes),(a=h.firstChild).textContent=""}else p.push(t.createTextNode(o));for(h.textContent="",d=0;o=p[d++];)if(n&&S.inArray(o,n)>-1)i&&i.push(o);else if(u=S.contains(o.ownerDocument,o),a=ge(h.appendChild(o),"script"),u&&ve(a),r)for(c=0;o=a[c++];)fe.test(o.type||"")&&r.push(o);return h}!function(){var e=a.createDocumentFragment().appendChild(a.createElement("div")),t=a.createElement("input");t.setAttribute("type","radio"),t.setAttribute("checked","checked"),t.setAttribute("name","t"),e.appendChild(t),v.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,e.innerHTML="<textarea>x</textarea>",v.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue}();var we=a.documentElement,xe=/^key/,_e=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Se=/^([^.]*)(?:\.(.+)|)/;function Ce(){return!0}function Me(){return!1}function Te(){try{return a.activeElement}catch(e){}}function Ae(e,t,r,n,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof r&&(n=n||r,r=void 0),t)Ae(e,s,r,n,t[s],o);return e}if(null==n&&null==i?(i=r,n=r=void 0):null==i&&("string"==typeof r?(i=n,n=void 0):(i=n,n=r,r=void 0)),!1===i)i=Me;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return S().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=S.guid++)),e.each(function(){S.event.add(this,t,i,n,r)})}S.event={global:{},add:function(e,t,r,n,i){var o,a,s,l,u,c,h,p,d,f,m,g=J.get(e);if(g)for(r.handler&&(r=(o=r).handler,i=o.selector),i&&S.find.matchesSelector(we,i),r.guid||(r.guid=S.guid++),(l=g.events)||(l=g.events={}),(a=g.handle)||(a=g.handle=function(t){return void 0!==S&&S.event.triggered!==t.type?S.event.dispatch.apply(e,arguments):void 0}),u=(t=(t||"").match(U)||[""]).length;u--;)d=m=(s=Se.exec(t[u])||[])[1],f=(s[2]||"").split(".").sort(),d&&(h=S.event.special[d]||{},d=(i?h.delegateType:h.bindType)||d,h=S.event.special[d]||{},c=S.extend({type:d,origType:m,data:n,handler:r,guid:r.guid,selector:i,needsContext:i&&S.expr.match.needsContext.test(i),namespace:f.join(".")},o),(p=l[d])||((p=l[d]=[]).delegateCount=0,h.setup&&!1!==h.setup.call(e,n,f,a)||e.addEventListener&&e.addEventListener(d,a)),h.add&&(h.add.call(e,c),c.handler.guid||(c.handler.guid=r.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),S.event.global[d]=!0)},remove:function(e,t,r,n,i){var o,a,s,l,u,c,h,p,d,f,m,g=J.hasData(e)&&J.get(e);if(g&&(l=g.events)){for(u=(t=(t||"").match(U)||[""]).length;u--;)if(d=m=(s=Se.exec(t[u])||[])[1],f=(s[2]||"").split(".").sort(),d){for(h=S.event.special[d]||{},p=l[d=(n?h.delegateType:h.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+f.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;o--;)c=p[o],!i&&m!==c.origType||r&&r.guid!==c.guid||s&&!s.test(c.namespace)||n&&n!==c.selector&&("**"!==n||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,h.remove&&h.remove.call(e,c));a&&!p.length&&(h.teardown&&!1!==h.teardown.call(e,f,g.handle)||S.removeEvent(e,d,g.handle),delete l[d])}else for(d in l)S.event.remove(e,d+t[u],r,n,!0);S.isEmptyObject(l)&&J.remove(e,"handle events")}},dispatch:function(e){var t,r,n,i,o,a,s=S.event.fix(e),l=new Array(arguments.length),u=(J.get(this,"events")||{})[s.type]||[],c=S.event.special[s.type]||{};for(l[0]=s,t=1;t<arguments.length;t++)l[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){for(a=S.event.handlers.call(this,s,u),t=0;(i=a[t++])&&!s.isPropagationStopped();)for(s.currentTarget=i.elem,r=0;(o=i.handlers[r++])&&!s.isImmediatePropagationStopped();)s.rnamespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(n=((S.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,l))&&!1===(s.result=n)&&(s.preventDefault(),s.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var r,n,i,o,a,s=[],l=t.delegateCount,u=e.target;if(l&&u.nodeType&&!("click"===e.type&&e.button>=1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&("click"!==e.type||!0!==u.disabled)){for(o=[],a={},r=0;r<l;r++)void 0===a[i=(n=t[r]).selector+" "]&&(a[i]=n.needsContext?S(i,this).index(u)>-1:S.find(i,this,null,[u]).length),a[i]&&o.push(n);o.length&&s.push({elem:u,handlers:o})}return u=this,l<t.length&&s.push({elem:u,handlers:t.slice(l)}),s},addProp:function(e,t){Object.defineProperty(S.Event.prototype,e,{enumerable:!0,configurable:!0,get:y(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[S.expando]?e:new S.Event(e)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==Te()&&this.focus)return this.focus(),!1},delegateType:"focusin"},blur:{trigger:function(){if(this===Te()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if("checkbox"===this.type&&this.click&&R(this,"input"))return this.click(),!1},_default:function(e){return R(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},S.removeEvent=function(e,t,r){e.removeEventListener&&e.removeEventListener(t,r)},S.Event=function(e,t){if(!(this instanceof S.Event))return new S.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ce:Me,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&S.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[S.expando]=!0},S.Event.prototype={constructor:S.Event,isDefaultPrevented:Me,isPropagationStopped:Me,isImmediatePropagationStopped:Me,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ce,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ce,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ce,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},S.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&xe.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&_e.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},S.event.addProp),S.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){S.event.special[e]={delegateType:t,bindType:t,handle:function(e){var r,n=e.relatedTarget,i=e.handleObj;return n&&(n===this||S.contains(this,n))||(e.type=i.origType,r=i.handler.apply(this,arguments),e.type=t),r}}}),S.fn.extend({on:function(e,t,r,n){return Ae(this,e,t,r,n)},one:function(e,t,r,n){return Ae(this,e,t,r,n,1)},off:function(e,t,r){var n,i;if(e&&e.preventDefault&&e.handleObj)return n=e.handleObj,S(e.delegateTarget).off(n.namespace?n.origType+"."+n.namespace:n.origType,n.selector,n.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(r=t,t=void 0),!1===r&&(r=Me),this.each(function(){S.event.remove(this,e,r,t)})}});var Ee=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,Pe=/<script|<style|<link/i,Re=/checked\s*(?:[^=]|=\s*.checked.)/i,Ie=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Ne(e,t){return R(e,"table")&&R(11!==t.nodeType?t:t.firstChild,"tr")&&S(e).children("tbody")[0]||e}function De(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function ke(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Oe(e,t){var r,n,i,o,a,s,l,u;if(1===t.nodeType){if(J.hasData(e)&&(o=J.access(e),a=J.set(t,o),u=o.events))for(i in delete a.handle,a.events={},u)for(r=0,n=u[i].length;r<n;r++)S.event.add(t,i,u[i][r]);Q.hasData(e)&&(s=Q.access(e),l=S.extend({},s),Q.set(t,l))}}function Fe(e,t){var r=t.nodeName.toLowerCase();"input"===r&&pe.test(e.type)?t.checked=e.checked:"input"!==r&&"textarea"!==r||(t.defaultValue=e.defaultValue)}function Le(e,t,r,n){t=u.apply([],t);var i,o,a,s,l,c,h=0,p=e.length,d=p-1,f=t[0],m=y(f);if(m||p>1&&"string"==typeof f&&!v.checkClone&&Re.test(f))return e.each(function(i){var o=e.eq(i);m&&(t[0]=f.call(this,i,o.html())),Le(o,t,r,n)});if(p&&(o=(i=be(t,e[0].ownerDocument,!1,e,n)).firstChild,1===i.childNodes.length&&(i=o),o||n)){for(s=(a=S.map(ge(i,"script"),De)).length;h<p;h++)l=i,h!==d&&(l=S.clone(l,!0,!0),s&&S.merge(a,ge(l,"script"))),r.call(e[h],l,h);if(s)for(c=a[a.length-1].ownerDocument,S.map(a,ke),h=0;h<s;h++)l=a[h],fe.test(l.type||"")&&!J.access(l,"globalEval")&&S.contains(c,l)&&(l.src&&"module"!==(l.type||"").toLowerCase()?S._evalUrl&&S._evalUrl(l.src):x(l.textContent.replace(Ie,""),c,l))}return e}function Ue(e,t,r){for(var n,i=t?S.filter(t,e):e,o=0;null!=(n=i[o]);o++)r||1!==n.nodeType||S.cleanData(ge(n)),n.parentNode&&(r&&S.contains(n.ownerDocument,n)&&ve(ge(n,"script")),n.parentNode.removeChild(n));return e}S.extend({htmlPrefilter:function(e){return e.replace(Ee,"<$1></$2>")},clone:function(e,t,r){var n,i,o,a,s=e.cloneNode(!0),l=S.contains(e.ownerDocument,e);if(!(v.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||S.isXMLDoc(e)))for(a=ge(s),n=0,i=(o=ge(e)).length;n<i;n++)Fe(o[n],a[n]);if(t)if(r)for(o=o||ge(e),a=a||ge(s),n=0,i=o.length;n<i;n++)Oe(o[n],a[n]);else Oe(e,s);return(a=ge(s,"script")).length>0&&ve(a,!l&&ge(e,"script")),s},cleanData:function(e){for(var t,r,n,i=S.event.special,o=0;void 0!==(r=e[o]);o++)if(Y(r)){if(t=r[J.expando]){if(t.events)for(n in t.events)i[n]?S.event.remove(r,n):S.removeEvent(r,n,t.handle);r[J.expando]=void 0}r[Q.expando]&&(r[Q.expando]=void 0)}}}),S.fn.extend({detach:function(e){return Ue(this,e,!0)},remove:function(e){return Ue(this,e)},text:function(e){return G(this,function(e){return void 0===e?S.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Le(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Ne(this,e).appendChild(e)})},prepend:function(){return Le(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Ne(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return Le(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Le(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(S.cleanData(ge(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return S.clone(this,e,t)})},html:function(e){return G(this,function(e){var t=this[0]||{},r=0,n=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Pe.test(e)&&!me[(de.exec(e)||["",""])[1].toLowerCase()]){e=S.htmlPrefilter(e);try{for(;r<n;r++)1===(t=this[r]||{}).nodeType&&(S.cleanData(ge(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return Le(this,arguments,function(t){var r=this.parentNode;S.inArray(this,e)<0&&(S.cleanData(ge(this)),r&&r.replaceChild(t,this))},e)}}),S.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){S.fn[e]=function(e){for(var r,n=[],i=S(e),o=i.length-1,a=0;a<=o;a++)r=a===o?this:this.clone(!0),S(i[a])[t](r),c.apply(n,r.get());return this.pushStack(n)}});var Ve=new RegExp("^("+ne+")(?!px)[a-z%]+$","i"),Be=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=r),t.getComputedStyle(e)},ze=new RegExp(oe.join("|"),"i");function je(e,t,r){var n,i,o,a,s=e.style;return(r=r||Be(e))&&(""!==(a=r.getPropertyValue(t)||r[t])||S.contains(e.ownerDocument,e)||(a=S.style(e,t)),!v.pixelBoxStyles()&&Ve.test(a)&&ze.test(t)&&(n=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=r.width,s.width=n,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function He(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(c){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",c.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",we.appendChild(u).appendChild(c);var e=r.getComputedStyle(c);n="1%"!==e.top,l=12===t(e.marginLeft),c.style.right="60%",s=36===t(e.right),i=36===t(e.width),c.style.position="absolute",o=36===c.offsetWidth||"absolute",we.removeChild(u),c=null}}function t(e){return Math.round(parseFloat(e))}var n,i,o,s,l,u=a.createElement("div"),c=a.createElement("div");c.style&&(c.style.backgroundClip="content-box",c.cloneNode(!0).style.backgroundClip="",v.clearCloneStyle="content-box"===c.style.backgroundClip,S.extend(v,{boxSizingReliable:function(){return e(),i},pixelBoxStyles:function(){return e(),s},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),l},scrollboxSize:function(){return e(),o}}))}();var $e=/^(none|table(?!-c[ea]).+)/,Ge=/^--/,We={position:"absolute",visibility:"hidden",display:"block"},qe={letterSpacing:"0",fontWeight:"400"},Xe=["Webkit","Moz","ms"],Ke=a.createElement("div").style;function Ye(e){var t=S.cssProps[e];return t||(t=S.cssProps[e]=function(e){if(e in Ke)return e;for(var t=e[0].toUpperCase()+e.slice(1),r=Xe.length;r--;)if((e=Xe[r]+t)in Ke)return e}(e)||e),t}function Ze(e,t,r){var n=ie.exec(t);return n?Math.max(0,n[2]-(r||0))+(n[3]||"px"):t}function Je(e,t,r,n,i,o){var a="width"===t?1:0,s=0,l=0;if(r===(n?"border":"content"))return 0;for(;a<4;a+=2)"margin"===r&&(l+=S.css(e,r+oe[a],!0,i)),n?("content"===r&&(l-=S.css(e,"padding"+oe[a],!0,i)),"margin"!==r&&(l-=S.css(e,"border"+oe[a]+"Width",!0,i))):(l+=S.css(e,"padding"+oe[a],!0,i),"padding"!==r?l+=S.css(e,"border"+oe[a]+"Width",!0,i):s+=S.css(e,"border"+oe[a]+"Width",!0,i));return!n&&o>=0&&(l+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-l-s-.5))),l}function Qe(e,t,r){var n=Be(e),i=je(e,t,n),o="border-box"===S.css(e,"boxSizing",!1,n),a=o;if(Ve.test(i)){if(!r)return i;i="auto"}return a=a&&(v.boxSizingReliable()||i===e.style[t]),("auto"===i||!parseFloat(i)&&"inline"===S.css(e,"display",!1,n))&&(i=e["offset"+t[0].toUpperCase()+t.slice(1)],a=!0),(i=parseFloat(i)||0)+Je(e,t,r||(o?"border":"content"),a,n,i)+"px"}function et(e,t,r,n,i){return new et.prototype.init(e,t,r,n,i)}S.extend({cssHooks:{opacity:{get:function(e,t){if(t){var r=je(e,"opacity");return""===r?"1":r}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,r,n){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=K(t),l=Ge.test(t),u=e.style;if(l||(t=Ye(s)),a=S.cssHooks[t]||S.cssHooks[s],void 0===r)return a&&"get"in a&&void 0!==(i=a.get(e,!1,n))?i:u[t];"string"===(o=typeof r)&&(i=ie.exec(r))&&i[1]&&(r=le(e,t,i),o="number"),null!=r&&r==r&&("number"===o&&(r+=i&&i[3]||(S.cssNumber[s]?"":"px")),v.clearCloneStyle||""!==r||0!==t.indexOf("background")||(u[t]="inherit"),a&&"set"in a&&void 0===(r=a.set(e,r,n))||(l?u.setProperty(t,r):u[t]=r))}},css:function(e,t,r,n){var i,o,a,s=K(t);return Ge.test(t)||(t=Ye(s)),(a=S.cssHooks[t]||S.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,r)),void 0===i&&(i=je(e,t,n)),"normal"===i&&t in qe&&(i=qe[t]),""===r||r?(o=parseFloat(i),!0===r||isFinite(o)?o||0:i):i}}),S.each(["height","width"],function(e,t){S.cssHooks[t]={get:function(e,r,n){if(r)return!$e.test(S.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?Qe(e,t,n):se(e,We,function(){return Qe(e,t,n)})},set:function(e,r,n){var i,o=Be(e),a="border-box"===S.css(e,"boxSizing",!1,o),s=n&&Je(e,t,n,a,o);return a&&v.scrollboxSize()===o.position&&(s-=Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-parseFloat(o[t])-Je(e,t,"border",!1,o)-.5)),s&&(i=ie.exec(r))&&"px"!==(i[3]||"px")&&(e.style[t]=r,r=S.css(e,t)),Ze(0,r,s)}}}),S.cssHooks.marginLeft=He(v.reliableMarginLeft,function(e,t){if(t)return(parseFloat(je(e,"marginLeft"))||e.getBoundingClientRect().left-se(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),S.each({margin:"",padding:"",border:"Width"},function(e,t){S.cssHooks[e+t]={expand:function(r){for(var n=0,i={},o="string"==typeof r?r.split(" "):[r];n<4;n++)i[e+oe[n]+t]=o[n]||o[n-2]||o[0];return i}},"margin"!==e&&(S.cssHooks[e+t].set=Ze)}),S.fn.extend({css:function(e,t){return G(this,function(e,t,r){var n,i,o={},a=0;if(Array.isArray(t)){for(n=Be(e),i=t.length;a<i;a++)o[t[a]]=S.css(e,t[a],!1,n);return o}return void 0!==r?S.style(e,t,r):S.css(e,t)},e,t,arguments.length>1)}}),S.Tween=et,et.prototype={constructor:et,init:function(e,t,r,n,i,o){this.elem=e,this.prop=r,this.easing=i||S.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=n,this.unit=o||(S.cssNumber[r]?"":"px")},cur:function(){var e=et.propHooks[this.prop];return e&&e.get?e.get(this):et.propHooks._default.get(this)},run:function(e){var t,r=et.propHooks[this.prop];return this.options.duration?this.pos=t=S.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),r&&r.set?r.set(this):et.propHooks._default.set(this),this}},et.prototype.init.prototype=et.prototype,et.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=S.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){S.fx.step[e.prop]?S.fx.step[e.prop](e):1!==e.elem.nodeType||null==e.elem.style[S.cssProps[e.prop]]&&!S.cssHooks[e.prop]?e.elem[e.prop]=e.now:S.style(e.elem,e.prop,e.now+e.unit)}}},et.propHooks.scrollTop=et.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},S.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},S.fx=et.prototype.init,S.fx.step={};var tt,rt,nt=/^(?:toggle|show|hide)$/,it=/queueHooks$/;function ot(){rt&&(!1===a.hidden&&r.requestAnimationFrame?r.requestAnimationFrame(ot):r.setTimeout(ot,S.fx.interval),S.fx.tick())}function at(){return r.setTimeout(function(){tt=void 0}),tt=Date.now()}function st(e,t){var r,n=0,i={height:e};for(t=t?1:0;n<4;n+=2-t)i["margin"+(r=oe[n])]=i["padding"+r]=e;return t&&(i.opacity=i.width=e),i}function lt(e,t,r){for(var n,i=(ut.tweeners[t]||[]).concat(ut.tweeners["*"]),o=0,a=i.length;o<a;o++)if(n=i[o].call(r,t,e))return n}function ut(e,t,r){var n,i,o=0,a=ut.prefilters.length,s=S.Deferred().always(function(){delete l.elem}),l=function(){if(i)return!1;for(var t=tt||at(),r=Math.max(0,u.startTime+u.duration-t),n=1-(r/u.duration||0),o=0,a=u.tweens.length;o<a;o++)u.tweens[o].run(n);return s.notifyWith(e,[u,n,r]),n<1&&a?r:(a||s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:S.extend({},t),opts:S.extend(!0,{specialEasing:{},easing:S.easing._default},r),originalProperties:t,originalOptions:r,startTime:tt||at(),duration:r.duration,tweens:[],createTween:function(t,r){var n=S.Tween(e,u.opts,t,r,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(n),n},stop:function(t){var r=0,n=t?u.tweens.length:0;if(i)return this;for(i=!0;r<n;r++)u.tweens[r].run(1);return t?(s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u,t])):s.rejectWith(e,[u,t]),this}}),c=u.props;for(!function(e,t){var r,n,i,o,a;for(r in e)if(i=t[n=K(r)],o=e[r],Array.isArray(o)&&(i=o[1],o=e[r]=o[0]),r!==n&&(e[n]=o,delete e[r]),(a=S.cssHooks[n])&&"expand"in a)for(r in o=a.expand(o),delete e[n],o)r in e||(e[r]=o[r],t[r]=i);else t[n]=i}(c,u.opts.specialEasing);o<a;o++)if(n=ut.prefilters[o].call(u,e,c,u.opts))return y(n.stop)&&(S._queueHooks(u.elem,u.opts.queue).stop=n.stop.bind(n)),n;return S.map(c,lt,u),y(u.opts.start)&&u.opts.start.call(e,u),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always),S.fx.timer(S.extend(l,{elem:e,anim:u,queue:u.opts.queue})),u}S.Animation=S.extend(ut,{tweeners:{"*":[function(e,t){var r=this.createTween(e,t);return le(r.elem,e,ie.exec(t),r),r}]},tweener:function(e,t){y(e)?(t=e,e=["*"]):e=e.match(U);for(var r,n=0,i=e.length;n<i;n++)r=e[n],ut.tweeners[r]=ut.tweeners[r]||[],ut.tweeners[r].unshift(t)},prefilters:[function(e,t,r){var n,i,o,a,s,l,u,c,h="width"in t||"height"in t,p=this,d={},f=e.style,m=e.nodeType&&ae(e),g=J.get(e,"fxshow");for(n in r.queue||(null==(a=S._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,S.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[n],nt.test(i)){if(delete t[n],o=o||"toggle"===i,i===(m?"hide":"show")){if("show"!==i||!g||void 0===g[n])continue;m=!0}d[n]=g&&g[n]||S.style(e,n)}if((l=!S.isEmptyObject(t))||!S.isEmptyObject(d))for(n in h&&1===e.nodeType&&(r.overflow=[f.overflow,f.overflowX,f.overflowY],null==(u=g&&g.display)&&(u=J.get(e,"display")),"none"===(c=S.css(e,"display"))&&(u?c=u:(he([e],!0),u=e.style.display||u,c=S.css(e,"display"),he([e]))),("inline"===c||"inline-block"===c&&null!=u)&&"none"===S.css(e,"float")&&(l||(p.done(function(){f.display=u}),null==u&&(c=f.display,u="none"===c?"":c)),f.display="inline-block")),r.overflow&&(f.overflow="hidden",p.always(function(){f.overflow=r.overflow[0],f.overflowX=r.overflow[1],f.overflowY=r.overflow[2]})),l=!1,d)l||(g?"hidden"in g&&(m=g.hidden):g=J.access(e,"fxshow",{display:u}),o&&(g.hidden=!m),m&&he([e],!0),p.done(function(){for(n in m||he([e]),J.remove(e,"fxshow"),d)S.style(e,n,d[n])})),l=lt(m?g[n]:0,n,p),n in g||(g[n]=l.start,m&&(l.end=l.start,l.start=0))}],prefilter:function(e,t){t?ut.prefilters.unshift(e):ut.prefilters.push(e)}}),S.speed=function(e,t,r){var n=e&&"object"==typeof e?S.extend({},e):{complete:r||!r&&t||y(e)&&e,duration:e,easing:r&&t||t&&!y(t)&&t};return S.fx.off?n.duration=0:"number"!=typeof n.duration&&(n.duration in S.fx.speeds?n.duration=S.fx.speeds[n.duration]:n.duration=S.fx.speeds._default),null!=n.queue&&!0!==n.queue||(n.queue="fx"),n.old=n.complete,n.complete=function(){y(n.old)&&n.old.call(this),n.queue&&S.dequeue(this,n.queue)},n},S.fn.extend({fadeTo:function(e,t,r,n){return this.filter(ae).css("opacity",0).show().end().animate({opacity:t},e,r,n)},animate:function(e,t,r,n){var i=S.isEmptyObject(e),o=S.speed(t,r,n),a=function(){var t=ut(this,S.extend({},e),o);(i||J.get(this,"finish"))&&t.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(e,t,r){var n=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=t,t=e,e=void 0),t&&!1!==e&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=S.timers,a=J.get(this);if(i)a[i]&&a[i].stop&&n(a[i]);else for(i in a)a[i]&&a[i].stop&&it.test(i)&&n(a[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(r),t=!1,o.splice(i,1));!t&&r||S.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,r=J.get(this),n=r[e+"queue"],i=r[e+"queueHooks"],o=S.timers,a=n?n.length:0;for(r.finish=!0,S.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;t<a;t++)n[t]&&n[t].finish&&n[t].finish.call(this);delete r.finish})}}),S.each(["toggle","show","hide"],function(e,t){var r=S.fn[t];S.fn[t]=function(e,n,i){return null==e||"boolean"==typeof e?r.apply(this,arguments):this.animate(st(t,!0),e,n,i)}}),S.each({slideDown:st("show"),slideUp:st("hide"),slideToggle:st("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){S.fn[e]=function(e,r,n){return this.animate(t,e,r,n)}}),S.timers=[],S.fx.tick=function(){var e,t=0,r=S.timers;for(tt=Date.now();t<r.length;t++)(e=r[t])()||r[t]!==e||r.splice(t--,1);r.length||S.fx.stop(),tt=void 0},S.fx.timer=function(e){S.timers.push(e),S.fx.start()},S.fx.interval=13,S.fx.start=function(){rt||(rt=!0,ot())},S.fx.stop=function(){rt=null},S.fx.speeds={slow:600,fast:200,_default:400},S.fn.delay=function(e,t){return e=S.fx&&S.fx.speeds[e]||e,t=t||"fx",this.queue(t,function(t,n){var i=r.setTimeout(t,e);n.stop=function(){r.clearTimeout(i)}})},function(){var e=a.createElement("input"),t=a.createElement("select").appendChild(a.createElement("option"));e.type="checkbox",v.checkOn=""!==e.value,v.optSelected=t.selected,(e=a.createElement("input")).value="t",e.type="radio",v.radioValue="t"===e.value}();var ct,ht=S.expr.attrHandle;S.fn.extend({attr:function(e,t){return G(this,S.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){S.removeAttr(this,e)})}}),S.extend({attr:function(e,t,r){var n,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?S.prop(e,t,r):(1===o&&S.isXMLDoc(e)||(i=S.attrHooks[t.toLowerCase()]||(S.expr.match.bool.test(t)?ct:void 0)),void 0!==r?null===r?void S.removeAttr(e,t):i&&"set"in i&&void 0!==(n=i.set(e,r,t))?n:(e.setAttribute(t,r+""),r):i&&"get"in i&&null!==(n=i.get(e,t))?n:null==(n=S.find.attr(e,t))?void 0:n)},attrHooks:{type:{set:function(e,t){if(!v.radioValue&&"radio"===t&&R(e,"input")){var r=e.value;return e.setAttribute("type",t),r&&(e.value=r),t}}}},removeAttr:function(e,t){var r,n=0,i=t&&t.match(U);if(i&&1===e.nodeType)for(;r=i[n++];)e.removeAttribute(r)}}),ct={set:function(e,t,r){return!1===t?S.removeAttr(e,r):e.setAttribute(r,r),r}},S.each(S.expr.match.bool.source.match(/\w+/g),function(e,t){var r=ht[t]||S.find.attr;ht[t]=function(e,t,n){var i,o,a=t.toLowerCase();return n||(o=ht[a],ht[a]=i,i=null!=r(e,t,n)?a:null,ht[a]=o),i}});var pt=/^(?:input|select|textarea|button)$/i,dt=/^(?:a|area)$/i;function ft(e){return(e.match(U)||[]).join(" ")}function mt(e){return e.getAttribute&&e.getAttribute("class")||""}function gt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(U)||[]}S.fn.extend({prop:function(e,t){return G(this,S.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[S.propFix[e]||e]})}}),S.extend({prop:function(e,t,r){var n,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&S.isXMLDoc(e)||(t=S.propFix[t]||t,i=S.propHooks[t]),void 0!==r?i&&"set"in i&&void 0!==(n=i.set(e,r,t))?n:e[t]=r:i&&"get"in i&&null!==(n=i.get(e,t))?n:e[t]},propHooks:{tabIndex:{get:function(e){var t=S.find.attr(e,"tabindex");return t?parseInt(t,10):pt.test(e.nodeName)||dt.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),v.optSelected||(S.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),S.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){S.propFix[this.toLowerCase()]=this}),S.fn.extend({addClass:function(e){var t,r,n,i,o,a,s,l=0;if(y(e))return this.each(function(t){S(this).addClass(e.call(this,t,mt(this)))});if((t=gt(e)).length)for(;r=this[l++];)if(i=mt(r),n=1===r.nodeType&&" "+ft(i)+" "){for(a=0;o=t[a++];)n.indexOf(" "+o+" ")<0&&(n+=o+" ");i!==(s=ft(n))&&r.setAttribute("class",s)}return this},removeClass:function(e){var t,r,n,i,o,a,s,l=0;if(y(e))return this.each(function(t){S(this).removeClass(e.call(this,t,mt(this)))});if(!arguments.length)return this.attr("class","");if((t=gt(e)).length)for(;r=this[l++];)if(i=mt(r),n=1===r.nodeType&&" "+ft(i)+" "){for(a=0;o=t[a++];)for(;n.indexOf(" "+o+" ")>-1;)n=n.replace(" "+o+" "," ");i!==(s=ft(n))&&r.setAttribute("class",s)}return this},toggleClass:function(e,t){var r=typeof e,n="string"===r||Array.isArray(e);return"boolean"==typeof t&&n?t?this.addClass(e):this.removeClass(e):y(e)?this.each(function(r){S(this).toggleClass(e.call(this,r,mt(this),t),t)}):this.each(function(){var t,i,o,a;if(n)for(i=0,o=S(this),a=gt(e);t=a[i++];)o.hasClass(t)?o.removeClass(t):o.addClass(t);else void 0!==e&&"boolean"!==r||((t=mt(this))&&J.set(this,"__className__",t),this.setAttribute&&this.setAttribute("class",t||!1===e?"":J.get(this,"__className__")||""))})},hasClass:function(e){var t,r,n=0;for(t=" "+e+" ";r=this[n++];)if(1===r.nodeType&&(" "+ft(mt(r))+" ").indexOf(t)>-1)return!0;return!1}});var vt=/\r/g;S.fn.extend({val:function(e){var t,r,n,i=this[0];return arguments.length?(n=y(e),this.each(function(r){var i;1===this.nodeType&&(null==(i=n?e.call(this,r,S(this).val()):e)?i="":"number"==typeof i?i+="":Array.isArray(i)&&(i=S.map(i,function(e){return null==e?"":e+""})),(t=S.valHooks[this.type]||S.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))})):i?(t=S.valHooks[i.type]||S.valHooks[i.nodeName.toLowerCase()])&&"get"in t&&void 0!==(r=t.get(i,"value"))?r:"string"==typeof(r=i.value)?r.replace(vt,""):null==r?"":r:void 0}}),S.extend({valHooks:{option:{get:function(e){var t=S.find.attr(e,"value");return null!=t?t:ft(S.text(e))}},select:{get:function(e){var t,r,n,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],l=a?o+1:i.length;for(n=o<0?l:a?o:0;n<l;n++)if(((r=i[n]).selected||n===o)&&!r.disabled&&(!r.parentNode.disabled||!R(r.parentNode,"optgroup"))){if(t=S(r).val(),a)return t;s.push(t)}return s},set:function(e,t){for(var r,n,i=e.options,o=S.makeArray(t),a=i.length;a--;)((n=i[a]).selected=S.inArray(S.valHooks.option.get(n),o)>-1)&&(r=!0);return r||(e.selectedIndex=-1),o}}}}),S.each(["radio","checkbox"],function(){S.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=S.inArray(S(e).val(),t)>-1}},v.checkOn||(S.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),v.focusin="onfocusin"in r;var yt=/^(?:focusinfocus|focusoutblur)$/,bt=function(e){e.stopPropagation()};S.extend(S.event,{trigger:function(e,t,n,i){var o,s,l,u,c,h,p,d,m=[n||a],g=f.call(e,"type")?e.type:e,v=f.call(e,"namespace")?e.namespace.split("."):[];if(s=d=l=n=n||a,3!==n.nodeType&&8!==n.nodeType&&!yt.test(g+S.event.triggered)&&(g.indexOf(".")>-1&&(g=(v=g.split(".")).shift(),v.sort()),c=g.indexOf(":")<0&&"on"+g,(e=e[S.expando]?e:new S.Event(g,"object"==typeof e&&e)).isTrigger=i?2:3,e.namespace=v.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+v.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:S.makeArray(t,[e]),p=S.event.special[g]||{},i||!p.trigger||!1!==p.trigger.apply(n,t))){if(!i&&!p.noBubble&&!b(n)){for(u=p.delegateType||g,yt.test(u+g)||(s=s.parentNode);s;s=s.parentNode)m.push(s),l=s;l===(n.ownerDocument||a)&&m.push(l.defaultView||l.parentWindow||r)}for(o=0;(s=m[o++])&&!e.isPropagationStopped();)d=s,e.type=o>1?u:p.bindType||g,(h=(J.get(s,"events")||{})[e.type]&&J.get(s,"handle"))&&h.apply(s,t),(h=c&&s[c])&&h.apply&&Y(s)&&(e.result=h.apply(s,t),!1===e.result&&e.preventDefault());return e.type=g,i||e.isDefaultPrevented()||p._default&&!1!==p._default.apply(m.pop(),t)||!Y(n)||c&&y(n[g])&&!b(n)&&((l=n[c])&&(n[c]=null),S.event.triggered=g,e.isPropagationStopped()&&d.addEventListener(g,bt),n[g](),e.isPropagationStopped()&&d.removeEventListener(g,bt),S.event.triggered=void 0,l&&(n[c]=l)),e.result}},simulate:function(e,t,r){var n=S.extend(new S.Event,r,{type:e,isSimulated:!0});S.event.trigger(n,null,t)}}),S.fn.extend({trigger:function(e,t){return this.each(function(){S.event.trigger(e,t,this)})},triggerHandler:function(e,t){var r=this[0];if(r)return S.event.trigger(e,t,r,!0)}}),v.focusin||S.each({focus:"focusin",blur:"focusout"},function(e,t){var r=function(e){S.event.simulate(t,e.target,S.event.fix(e))};S.event.special[t]={setup:function(){var n=this.ownerDocument||this,i=J.access(n,t);i||n.addEventListener(e,r,!0),J.access(n,t,(i||0)+1)},teardown:function(){var n=this.ownerDocument||this,i=J.access(n,t)-1;i?J.access(n,t,i):(n.removeEventListener(e,r,!0),J.remove(n,t))}}});var wt=r.location,xt=Date.now(),_t=/\?/;S.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new r.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||S.error("Invalid XML: "+e),t};var St=/\[\]$/,Ct=/\r?\n/g,Mt=/^(?:submit|button|image|reset|file)$/i,Tt=/^(?:input|select|textarea|keygen)/i;function At(e,t,r,n){var i;if(Array.isArray(t))S.each(t,function(t,i){r||St.test(e)?n(e,i):At(e+"["+("object"==typeof i&&null!=i?t:"")+"]",i,r,n)});else if(r||"object"!==_(t))n(e,t);else for(i in t)At(e+"["+i+"]",t[i],r,n)}S.param=function(e,t){var r,n=[],i=function(e,t){var r=y(t)?t():t;n[n.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==r?"":r)};if(Array.isArray(e)||e.jquery&&!S.isPlainObject(e))S.each(e,function(){i(this.name,this.value)});else for(r in e)At(r,e[r],t,i);return n.join("&")},S.fn.extend({serialize:function(){return S.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=S.prop(this,"elements");return e?S.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!S(this).is(":disabled")&&Tt.test(this.nodeName)&&!Mt.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var r=S(this).val();return null==r?null:Array.isArray(r)?S.map(r,function(e){return{name:t.name,value:e.replace(Ct,"\r\n")}}):{name:t.name,value:r.replace(Ct,"\r\n")}}).get()}});var Et=/%20/g,Pt=/#.*$/,Rt=/([?&])_=[^&]*/,It=/^(.*?):[ \t]*([^\r\n]*)$/gm,Nt=/^(?:GET|HEAD)$/,Dt=/^\/\//,kt={},Ot={},Ft="*/".concat("*"),Lt=a.createElement("a");function Ut(e){return function(t,r){"string"!=typeof t&&(r=t,t="*");var n,i=0,o=t.toLowerCase().match(U)||[];if(y(r))for(;n=o[i++];)"+"===n[0]?(n=n.slice(1)||"*",(e[n]=e[n]||[]).unshift(r)):(e[n]=e[n]||[]).push(r)}}function Vt(e,t,r,n){var i={},o=e===Ot;function a(s){var l;return i[s]=!0,S.each(e[s]||[],function(e,s){var u=s(t,r,n);return"string"!=typeof u||o||i[u]?o?!(l=u):void 0:(t.dataTypes.unshift(u),a(u),!1)}),l}return a(t.dataTypes[0])||!i["*"]&&a("*")}function Bt(e,t){var r,n,i=S.ajaxSettings.flatOptions||{};for(r in t)void 0!==t[r]&&((i[r]?e:n||(n={}))[r]=t[r]);return n&&S.extend(!0,e,n),e}Lt.href=wt.href,S.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:wt.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(wt.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Ft,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":S.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Bt(Bt(e,S.ajaxSettings),t):Bt(S.ajaxSettings,e)},ajaxPrefilter:Ut(kt),ajaxTransport:Ut(Ot),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var n,i,o,s,l,u,c,h,p,d,f=S.ajaxSetup({},t),m=f.context||f,g=f.context&&(m.nodeType||m.jquery)?S(m):S.event,v=S.Deferred(),y=S.Callbacks("once memory"),b=f.statusCode||{},w={},x={},_="canceled",C={readyState:0,getResponseHeader:function(e){var t;if(c){if(!s)for(s={};t=It.exec(o);)s[t[1].toLowerCase()]=t[2];t=s[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return c?o:null},setRequestHeader:function(e,t){return null==c&&(e=x[e.toLowerCase()]=x[e.toLowerCase()]||e,w[e]=t),this},overrideMimeType:function(e){return null==c&&(f.mimeType=e),this},statusCode:function(e){var t;if(e)if(c)C.always(e[C.status]);else for(t in e)b[t]=[b[t],e[t]];return this},abort:function(e){var t=e||_;return n&&n.abort(t),M(0,t),this}};if(v.promise(C),f.url=((e||f.url||wt.href)+"").replace(Dt,wt.protocol+"//"),f.type=t.method||t.type||f.method||f.type,f.dataTypes=(f.dataType||"*").toLowerCase().match(U)||[""],null==f.crossDomain){u=a.createElement("a");try{u.href=f.url,u.href=u.href,f.crossDomain=Lt.protocol+"//"+Lt.host!=u.protocol+"//"+u.host}catch(e){f.crossDomain=!0}}if(f.data&&f.processData&&"string"!=typeof f.data&&(f.data=S.param(f.data,f.traditional)),Vt(kt,f,t,C),c)return C;for(p in(h=S.event&&f.global)&&0==S.active++&&S.event.trigger("ajaxStart"),f.type=f.type.toUpperCase(),f.hasContent=!Nt.test(f.type),i=f.url.replace(Pt,""),f.hasContent?f.data&&f.processData&&0===(f.contentType||"").indexOf("application/x-www-form-urlencoded")&&(f.data=f.data.replace(Et,"+")):(d=f.url.slice(i.length),f.data&&(f.processData||"string"==typeof f.data)&&(i+=(_t.test(i)?"&":"?")+f.data,delete f.data),!1===f.cache&&(i=i.replace(Rt,"$1"),d=(_t.test(i)?"&":"?")+"_="+xt+++d),f.url=i+d),f.ifModified&&(S.lastModified[i]&&C.setRequestHeader("If-Modified-Since",S.lastModified[i]),S.etag[i]&&C.setRequestHeader("If-None-Match",S.etag[i])),(f.data&&f.hasContent&&!1!==f.contentType||t.contentType)&&C.setRequestHeader("Content-Type",f.contentType),C.setRequestHeader("Accept",f.dataTypes[0]&&f.accepts[f.dataTypes[0]]?f.accepts[f.dataTypes[0]]+("*"!==f.dataTypes[0]?", "+Ft+"; q=0.01":""):f.accepts["*"]),f.headers)C.setRequestHeader(p,f.headers[p]);if(f.beforeSend&&(!1===f.beforeSend.call(m,C,f)||c))return C.abort();if(_="abort",y.add(f.complete),C.done(f.success),C.fail(f.error),n=Vt(Ot,f,t,C)){if(C.readyState=1,h&&g.trigger("ajaxSend",[C,f]),c)return C;f.async&&f.timeout>0&&(l=r.setTimeout(function(){C.abort("timeout")},f.timeout));try{c=!1,n.send(w,M)}catch(e){if(c)throw e;M(-1,e)}}else M(-1,"No Transport");function M(e,t,a,s){var u,p,d,w,x,_=t;c||(c=!0,l&&r.clearTimeout(l),n=void 0,o=s||"",C.readyState=e>0?4:0,u=e>=200&&e<300||304===e,a&&(w=function(e,t,r){for(var n,i,o,a,s=e.contents,l=e.dataTypes;"*"===l[0];)l.shift(),void 0===n&&(n=e.mimeType||t.getResponseHeader("Content-Type"));if(n)for(i in s)if(s[i]&&s[i].test(n)){l.unshift(i);break}if(l[0]in r)o=l[0];else{for(i in r){if(!l[0]||e.converters[i+" "+l[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==l[0]&&l.unshift(o),r[o]}(f,C,a)),w=function(e,t,r,n){var i,o,a,s,l,u={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];for(o=c.shift();o;)if(e.responseFields[o]&&(r[e.responseFields[o]]=t),!l&&n&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=o,o=c.shift())if("*"===o)o=l;else if("*"!==l&&l!==o){if(!(a=u[l+" "+o]||u["* "+o]))for(i in u)if((s=i.split(" "))[1]===o&&(a=u[l+" "+s[0]]||u["* "+s[0]])){!0===a?a=u[i]:!0!==u[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+l+" to "+o}}}return{state:"success",data:t}}(f,w,C,u),u?(f.ifModified&&((x=C.getResponseHeader("Last-Modified"))&&(S.lastModified[i]=x),(x=C.getResponseHeader("etag"))&&(S.etag[i]=x)),204===e||"HEAD"===f.type?_="nocontent":304===e?_="notmodified":(_=w.state,p=w.data,u=!(d=w.error))):(d=_,!e&&_||(_="error",e<0&&(e=0))),C.status=e,C.statusText=(t||_)+"",u?v.resolveWith(m,[p,_,C]):v.rejectWith(m,[C,_,d]),C.statusCode(b),b=void 0,h&&g.trigger(u?"ajaxSuccess":"ajaxError",[C,f,u?p:d]),y.fireWith(m,[C,_]),h&&(g.trigger("ajaxComplete",[C,f]),--S.active||S.event.trigger("ajaxStop")))}return C},getJSON:function(e,t,r){return S.get(e,t,r,"json")},getScript:function(e,t){return S.get(e,void 0,t,"script")}}),S.each(["get","post"],function(e,t){S[t]=function(e,r,n,i){return y(r)&&(i=i||n,n=r,r=void 0),S.ajax(S.extend({url:e,type:t,dataType:i,data:r,success:n},S.isPlainObject(e)&&e))}}),S._evalUrl=function(e){return S.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,throws:!0})},S.fn.extend({wrapAll:function(e){var t;return this[0]&&(y(e)&&(e=e.call(this[0])),t=S(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(e){return y(e)?this.each(function(t){S(this).wrapInner(e.call(this,t))}):this.each(function(){var t=S(this),r=t.contents();r.length?r.wrapAll(e):t.append(e)})},wrap:function(e){var t=y(e);return this.each(function(r){S(this).wrapAll(t?e.call(this,r):e)})},unwrap:function(e){return this.parent(e).not("body").each(function(){S(this).replaceWith(this.childNodes)}),this}}),S.expr.pseudos.hidden=function(e){return!S.expr.pseudos.visible(e)},S.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},S.ajaxSettings.xhr=function(){try{return new r.XMLHttpRequest}catch(e){}};var zt={0:200,1223:204},jt=S.ajaxSettings.xhr();v.cors=!!jt&&"withCredentials"in jt,v.ajax=jt=!!jt,S.ajaxTransport(function(e){var t,n;if(v.cors||jt&&!e.crossDomain)return{send:function(i,o){var a,s=e.xhr();if(s.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(a in e.xhrFields)s[a]=e.xhrFields[a];for(a in e.mimeType&&s.overrideMimeType&&s.overrideMimeType(e.mimeType),e.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest"),i)s.setRequestHeader(a,i[a]);t=function(e){return function(){t&&(t=n=s.onload=s.onerror=s.onabort=s.ontimeout=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?o(0,"error"):o(s.status,s.statusText):o(zt[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=t(),n=s.onerror=s.ontimeout=t("error"),void 0!==s.onabort?s.onabort=n:s.onreadystatechange=function(){4===s.readyState&&r.setTimeout(function(){t&&n()})},t=t("abort");try{s.send(e.hasContent&&e.data||null)}catch(e){if(t)throw e}},abort:function(){t&&t()}}}),S.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),S.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return S.globalEval(e),e}}}),S.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),S.ajaxTransport("script",function(e){var t,r;if(e.crossDomain)return{send:function(n,i){t=S("<script>").prop({charset:e.scriptCharset,src:e.url}).on("load error",r=function(e){t.remove(),r=null,e&&i("error"===e.type?404:200,e.type)}),a.head.appendChild(t[0])},abort:function(){r&&r()}}});var Ht=[],$t=/(=)\?(?=&|$)|\?\?/;S.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Ht.pop()||S.expando+"_"+xt++;return this[e]=!0,e}}),S.ajaxPrefilter("json jsonp",function(e,t,n){var i,o,a,s=!1!==e.jsonp&&($t.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&$t.test(e.data)&&"data");if(s||"jsonp"===e.dataTypes[0])return i=e.jsonpCallback=y(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,s?e[s]=e[s].replace($t,"$1"+i):!1!==e.jsonp&&(e.url+=(_t.test(e.url)?"&":"?")+e.jsonp+"="+i),e.converters["script json"]=function(){return a||S.error(i+" was not called"),a[0]},e.dataTypes[0]="json",o=r[i],r[i]=function(){a=arguments},n.always(function(){void 0===o?S(r).removeProp(i):r[i]=o,e[i]&&(e.jsonpCallback=t.jsonpCallback,Ht.push(i)),a&&y(o)&&o(a[0]),a=o=void 0}),"script"}),v.createHTMLDocument=function(){var e=a.implementation.createHTMLDocument("").body;return e.innerHTML="<form></form><form></form>",2===e.childNodes.length}(),S.parseHTML=function(e,t,r){return"string"!=typeof e?[]:("boolean"==typeof t&&(r=t,t=!1),t||(v.createHTMLDocument?((n=(t=a.implementation.createHTMLDocument("")).createElement("base")).href=a.location.href,t.head.appendChild(n)):t=a),i=I.exec(e),o=!r&&[],i?[t.createElement(i[1])]:(i=be([e],t,o),o&&o.length&&S(o).remove(),S.merge([],i.childNodes)));var n,i,o},S.fn.load=function(e,t,r){var n,i,o,a=this,s=e.indexOf(" ");return s>-1&&(n=ft(e.slice(s)),e=e.slice(0,s)),y(t)?(r=t,t=void 0):t&&"object"==typeof t&&(i="POST"),a.length>0&&S.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(n?S("<div>").append(S.parseHTML(e)).find(n):e)}).always(r&&function(e,t){a.each(function(){r.apply(this,o||[e.responseText,t,e])})}),this},S.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){S.fn[t]=function(e){return this.on(t,e)}}),S.expr.pseudos.animated=function(e){return S.grep(S.timers,function(t){return e===t.elem}).length},S.offset={setOffset:function(e,t,r){var n,i,o,a,s,l,u=S.css(e,"position"),c=S(e),h={};"static"===u&&(e.style.position="relative"),s=c.offset(),o=S.css(e,"top"),l=S.css(e,"left"),("absolute"===u||"fixed"===u)&&(o+l).indexOf("auto")>-1?(a=(n=c.position()).top,i=n.left):(a=parseFloat(o)||0,i=parseFloat(l)||0),y(t)&&(t=t.call(e,r,S.extend({},s))),null!=t.top&&(h.top=t.top-s.top+a),null!=t.left&&(h.left=t.left-s.left+i),"using"in t?t.using.call(e,h):c.css(h)}},S.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){S.offset.setOffset(this,e,t)});var t,r,n=this[0];return n?n.getClientRects().length?(t=n.getBoundingClientRect(),r=n.ownerDocument.defaultView,{top:t.top+r.pageYOffset,left:t.left+r.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,r,n=this[0],i={top:0,left:0};if("fixed"===S.css(n,"position"))t=n.getBoundingClientRect();else{for(t=this.offset(),r=n.ownerDocument,e=n.offsetParent||r.documentElement;e&&(e===r.body||e===r.documentElement)&&"static"===S.css(e,"position");)e=e.parentNode;e&&e!==n&&1===e.nodeType&&((i=S(e).offset()).top+=S.css(e,"borderTopWidth",!0),i.left+=S.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-S.css(n,"marginTop",!0),left:t.left-i.left-S.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===S.css(e,"position");)e=e.offsetParent;return e||we})}}),S.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var r="pageYOffset"===t;S.fn[e]=function(n){return G(this,function(e,n,i){var o;if(b(e)?o=e:9===e.nodeType&&(o=e.defaultView),void 0===i)return o?o[t]:e[n];o?o.scrollTo(r?o.pageXOffset:i,r?i:o.pageYOffset):e[n]=i},e,n,arguments.length)}}),S.each(["top","left"],function(e,t){S.cssHooks[t]=He(v.pixelPosition,function(e,r){if(r)return r=je(e,t),Ve.test(r)?S(e).position()[t]+"px":r})}),S.each({Height:"height",Width:"width"},function(e,t){S.each({padding:"inner"+e,content:t,"":"outer"+e},function(r,n){S.fn[n]=function(i,o){var a=arguments.length&&(r||"boolean"!=typeof i),s=r||(!0===i||!0===o?"margin":"border");return G(this,function(t,r,i){var o;return b(t)?0===n.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(o=t.documentElement,Math.max(t.body["scroll"+e],o["scroll"+e],t.body["offset"+e],o["offset"+e],o["client"+e])):void 0===i?S.css(t,r,s):S.style(t,r,i,s)},t,a?i:void 0,a)}})}),S.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,t){S.fn[t]=function(e,r){return arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),S.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),S.fn.extend({bind:function(e,t,r){return this.on(e,null,t,r)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,r,n){return this.on(t,e,r,n)},undelegate:function(e,t,r){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",r)}}),S.proxy=function(e,t){var r,n,i;if("string"==typeof t&&(r=e[t],t=e,e=r),y(e))return n=l.call(arguments,2),(i=function(){return e.apply(t||this,n.concat(l.call(arguments)))}).guid=e.guid=e.guid||S.guid++,i},S.holdReady=function(e){e?S.readyWait++:S.ready(!0)},S.isArray=Array.isArray,S.parseJSON=JSON.parse,S.nodeName=R,S.isFunction=y,S.isWindow=b,S.camelCase=K,S.type=_,S.now=Date.now,S.isNumeric=function(e){var t=S.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},void 0===(n=function(){return S}.apply(t,[]))||(e.exports=n);var Gt=r.jQuery,Wt=r.$;return S.noConflict=function(e){return r.$===S&&(r.$=Wt),e&&r.jQuery===S&&(r.jQuery=Gt),S},i||(r.jQuery=r.$=S),S})},"./node_modules/lodash/lodash.js":function(e,t,r){(function(e,n){var i;
/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */(function(){var o,a=200,s="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",l="Expected a function",u="__lodash_hash_undefined__",c=500,h="__lodash_placeholder__",p=1,d=2,f=4,m=1,g=2,v=1,y=2,b=4,w=8,x=16,_=32,S=64,C=128,M=256,T=512,A=30,E="...",P=800,R=16,I=1,N=2,D=1/0,k=9007199254740991,O=1.7976931348623157e308,F=NaN,L=4294967295,U=L-1,V=L>>>1,B=[["ary",C],["bind",v],["bindKey",y],["curry",w],["curryRight",x],["flip",T],["partial",_],["partialRight",S],["rearg",M]],z="[object Arguments]",j="[object Array]",H="[object AsyncFunction]",$="[object Boolean]",G="[object Date]",W="[object DOMException]",q="[object Error]",X="[object Function]",K="[object GeneratorFunction]",Y="[object Map]",Z="[object Number]",J="[object Null]",Q="[object Object]",ee="[object Proxy]",te="[object RegExp]",re="[object Set]",ne="[object String]",ie="[object Symbol]",oe="[object Undefined]",ae="[object WeakMap]",se="[object WeakSet]",le="[object ArrayBuffer]",ue="[object DataView]",ce="[object Float32Array]",he="[object Float64Array]",pe="[object Int8Array]",de="[object Int16Array]",fe="[object Int32Array]",me="[object Uint8Array]",ge="[object Uint8ClampedArray]",ve="[object Uint16Array]",ye="[object Uint32Array]",be=/\b__p \+= '';/g,we=/\b(__p \+=) '' \+/g,xe=/(__e\(.*?\)|\b__t\)) \+\n'';/g,_e=/&(?:amp|lt|gt|quot|#39);/g,Se=/[&<>"']/g,Ce=RegExp(_e.source),Me=RegExp(Se.source),Te=/<%-([\s\S]+?)%>/g,Ae=/<%([\s\S]+?)%>/g,Ee=/<%=([\s\S]+?)%>/g,Pe=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Re=/^\w*$/,Ie=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ne=/[\\^$.*+?()[\]{}|]/g,De=RegExp(Ne.source),ke=/^\s+|\s+$/g,Oe=/^\s+/,Fe=/\s+$/,Le=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Ue=/\{\n\/\* \[wrapped with (.+)\] \*/,Ve=/,? & /,Be=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,ze=/\\(\\)?/g,je=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,He=/\w*$/,$e=/^[-+]0x[0-9a-f]+$/i,Ge=/^0b[01]+$/i,We=/^\[object .+?Constructor\]$/,qe=/^0o[0-7]+$/i,Xe=/^(?:0|[1-9]\d*)$/,Ke=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Ye=/($^)/,Ze=/['\n\r\u2028\u2029\\]/g,Je="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Qe="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",et="[\\ud800-\\udfff]",tt="["+Qe+"]",rt="["+Je+"]",nt="\\d+",it="[\\u2700-\\u27bf]",ot="[a-z\\xdf-\\xf6\\xf8-\\xff]",at="[^\\ud800-\\udfff"+Qe+nt+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",st="\\ud83c[\\udffb-\\udfff]",lt="[^\\ud800-\\udfff]",ut="(?:\\ud83c[\\udde6-\\uddff]){2}",ct="[\\ud800-\\udbff][\\udc00-\\udfff]",ht="[A-Z\\xc0-\\xd6\\xd8-\\xde]",pt="(?:"+ot+"|"+at+")",dt="(?:"+ht+"|"+at+")",ft="(?:"+rt+"|"+st+")"+"?",mt="[\\ufe0e\\ufe0f]?"+ft+("(?:\\u200d(?:"+[lt,ut,ct].join("|")+")[\\ufe0e\\ufe0f]?"+ft+")*"),gt="(?:"+[it,ut,ct].join("|")+")"+mt,vt="(?:"+[lt+rt+"?",rt,ut,ct,et].join("|")+")",yt=RegExp("['â]","g"),bt=RegExp(rt,"g"),wt=RegExp(st+"(?="+st+")|"+vt+mt,"g"),xt=RegExp([ht+"?"+ot+"+(?:['â](?:d|ll|m|re|s|t|ve))?(?="+[tt,ht,"$"].join("|")+")",dt+"+(?:['â](?:D|LL|M|RE|S|T|VE))?(?="+[tt,ht+pt,"$"].join("|")+")",ht+"?"+pt+"+(?:['â](?:d|ll|m|re|s|t|ve))?",ht+"+(?:['â](?:D|LL|M|RE|S|T|VE))?","\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",nt,gt].join("|"),"g"),_t=RegExp("[\\u200d\\ud800-\\udfff"+Je+"\\ufe0e\\ufe0f]"),St=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,Ct=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],Mt=-1,Tt={};Tt[ce]=Tt[he]=Tt[pe]=Tt[de]=Tt[fe]=Tt[me]=Tt[ge]=Tt[ve]=Tt[ye]=!0,Tt[z]=Tt[j]=Tt[le]=Tt[$]=Tt[ue]=Tt[G]=Tt[q]=Tt[X]=Tt[Y]=Tt[Z]=Tt[Q]=Tt[te]=Tt[re]=Tt[ne]=Tt[ae]=!1;var At={};At[z]=At[j]=At[le]=At[ue]=At[$]=At[G]=At[ce]=At[he]=At[pe]=At[de]=At[fe]=At[Y]=At[Z]=At[Q]=At[te]=At[re]=At[ne]=At[ie]=At[me]=At[ge]=At[ve]=At[ye]=!0,At[q]=At[X]=At[ae]=!1;var Et={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Pt=parseFloat,Rt=parseInt,It="object"==typeof e&&e&&e.Object===Object&&e,Nt="object"==typeof self&&self&&self.Object===Object&&self,Dt=It||Nt||Function("return this")(),kt=t&&!t.nodeType&&t,Ot=kt&&"object"==typeof n&&n&&!n.nodeType&&n,Ft=Ot&&Ot.exports===kt,Lt=Ft&&It.process,Ut=function(){try{var e=Ot&&Ot.require&&Ot.require("util").types;return e||Lt&&Lt.binding&&Lt.binding("util")}catch(e){}}(),Vt=Ut&&Ut.isArrayBuffer,Bt=Ut&&Ut.isDate,zt=Ut&&Ut.isMap,jt=Ut&&Ut.isRegExp,Ht=Ut&&Ut.isSet,$t=Ut&&Ut.isTypedArray;function Gt(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}function Wt(e,t,r,n){for(var i=-1,o=null==e?0:e.length;++i<o;){var a=e[i];t(n,a,r(a),e)}return n}function qt(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e}function Xt(e,t){for(var r=null==e?0:e.length;r--&&!1!==t(e[r],r,e););return e}function Kt(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(!t(e[r],r,e))return!1;return!0}function Yt(e,t){for(var r=-1,n=null==e?0:e.length,i=0,o=[];++r<n;){var a=e[r];t(a,r,e)&&(o[i++]=a)}return o}function Zt(e,t){return!!(null==e?0:e.length)&&sr(e,t,0)>-1}function Jt(e,t,r){for(var n=-1,i=null==e?0:e.length;++n<i;)if(r(t,e[n]))return!0;return!1}function Qt(e,t){for(var r=-1,n=null==e?0:e.length,i=Array(n);++r<n;)i[r]=t(e[r],r,e);return i}function er(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}function tr(e,t,r,n){var i=-1,o=null==e?0:e.length;for(n&&o&&(r=e[++i]);++i<o;)r=t(r,e[i],i,e);return r}function rr(e,t,r,n){var i=null==e?0:e.length;for(n&&i&&(r=e[--i]);i--;)r=t(r,e[i],i,e);return r}function nr(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}var ir=hr("length");function or(e,t,r){var n;return r(e,function(e,r,i){if(t(e,r,i))return n=r,!1}),n}function ar(e,t,r,n){for(var i=e.length,o=r+(n?1:-1);n?o--:++o<i;)if(t(e[o],o,e))return o;return-1}function sr(e,t,r){return t==t?function(e,t,r){var n=r-1,i=e.length;for(;++n<i;)if(e[n]===t)return n;return-1}(e,t,r):ar(e,ur,r)}function lr(e,t,r,n){for(var i=r-1,o=e.length;++i<o;)if(n(e[i],t))return i;return-1}function ur(e){return e!=e}function cr(e,t){var r=null==e?0:e.length;return r?fr(e,t)/r:F}function hr(e){return function(t){return null==t?o:t[e]}}function pr(e){return function(t){return null==e?o:e[t]}}function dr(e,t,r,n,i){return i(e,function(e,i,o){r=n?(n=!1,e):t(r,e,i,o)}),r}function fr(e,t){for(var r,n=-1,i=e.length;++n<i;){var a=t(e[n]);a!==o&&(r=r===o?a:r+a)}return r}function mr(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}function gr(e){return function(t){return e(t)}}function vr(e,t){return Qt(t,function(t){return e[t]})}function yr(e,t){return e.has(t)}function br(e,t){for(var r=-1,n=e.length;++r<n&&sr(t,e[r],0)>-1;);return r}function wr(e,t){for(var r=e.length;r--&&sr(t,e[r],0)>-1;);return r}var xr=pr({"Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã£":"a","Ã¤":"a","Ã¥":"a","Ã":"C","Ã§":"c","Ã":"D","Ã°":"d","Ã":"E","Ã":"E","Ã":"E","Ã":"E","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","Ã":"I","Ã":"I","Ã":"I","Ã":"I","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã":"N","Ã±":"n","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã²":"o","Ã³":"o","Ã´":"o","Ãµ":"o","Ã¶":"o","Ã¸":"o","Ã":"U","Ã":"U","Ã":"U","Ã":"U","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u","Ã":"Y","Ã½":"y","Ã¿":"y","Ã":"Ae","Ã¦":"ae","Ã":"Th","Ã¾":"th","Ã":"ss","Ä":"A","Ä":"A","Ä":"A","Ä":"a","Ä":"a","Ä":"a","Ä":"C","Ä":"C","Ä":"C","Ä":"C","Ä":"c","Ä":"c","Ä":"c","Ä":"c","Ä":"D","Ä":"D","Ä":"d","Ä":"d","Ä":"E","Ä":"E","Ä":"E","Ä":"E","Ä":"E","Ä":"e","Ä":"e","Ä":"e","Ä":"e","Ä":"e","Ä":"G","Ä":"G","Ä ":"G","Ä¢":"G","Ä":"g","Ä":"g","Ä¡":"g","Ä£":"g","Ä¤":"H","Ä¦":"H","Ä¥":"h","Ä§":"h","Ä¨":"I","Äª":"I","Ä¬":"I","Ä®":"I","Ä°":"I","Ä©":"i","Ä«":"i","Ä­":"i","Ä¯":"i","Ä±":"i","Ä´":"J","Äµ":"j","Ä¶":"K","Ä·":"k","Ä¸":"k","Ä¹":"L","Ä»":"L","Ä½":"L","Ä¿":"L","Å":"L","Äº":"l","Ä¼":"l","Ä¾":"l","Å":"l","Å":"l","Å":"N","Å":"N","Å":"N","Å":"N","Å":"n","Å":"n","Å":"n","Å":"n","Å":"O","Å":"O","Å":"O","Å":"o","Å":"o","Å":"o","Å":"R","Å":"R","Å":"R","Å":"r","Å":"r","Å":"r","Å":"S","Å":"S","Å":"S","Å ":"S","Å":"s","Å":"s","Å":"s","Å¡":"s","Å¢":"T","Å¤":"T","Å¦":"T","Å£":"t","Å¥":"t","Å§":"t","Å¨":"U","Åª":"U","Å¬":"U","Å®":"U","Å°":"U","Å²":"U","Å©":"u","Å«":"u","Å­":"u","Å¯":"u","Å±":"u","Å³":"u","Å´":"W","Åµ":"w","Å¶":"Y","Å·":"y","Å¸":"Y","Å¹":"Z","Å»":"Z","Å½":"Z","Åº":"z","Å¼":"z","Å¾":"z","Ä²":"IJ","Ä³":"ij","Å":"Oe","Å":"oe","Å":"'n","Å¿":"s"}),_r=pr({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function Sr(e){return"\\"+Et[e]}function Cr(e){return _t.test(e)}function Mr(e){var t=-1,r=Array(e.size);return e.forEach(function(e,n){r[++t]=[n,e]}),r}function Tr(e,t){return function(r){return e(t(r))}}function Ar(e,t){for(var r=-1,n=e.length,i=0,o=[];++r<n;){var a=e[r];a!==t&&a!==h||(e[r]=h,o[i++]=r)}return o}function Er(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}function Pr(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=[e,e]}),r}function Rr(e){return Cr(e)?function(e){var t=wt.lastIndex=0;for(;wt.test(e);)++t;return t}(e):ir(e)}function Ir(e){return Cr(e)?function(e){return e.match(wt)||[]}(e):function(e){return e.split("")}(e)}var Nr=pr({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});var Dr=function e(t){var r=(t=null==t?Dt:Dr.defaults(Dt.Object(),t,Dr.pick(Dt,Ct))).Array,n=t.Date,i=t.Error,Je=t.Function,Qe=t.Math,et=t.Object,tt=t.RegExp,rt=t.String,nt=t.TypeError,it=r.prototype,ot=Je.prototype,at=et.prototype,st=t["__core-js_shared__"],lt=ot.toString,ut=at.hasOwnProperty,ct=0,ht=function(){var e=/[^.]+$/.exec(st&&st.keys&&st.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),pt=at.toString,dt=lt.call(et),ft=Dt._,mt=tt("^"+lt.call(ut).replace(Ne,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),gt=Ft?t.Buffer:o,vt=t.Symbol,wt=t.Uint8Array,_t=gt?gt.allocUnsafe:o,Et=Tr(et.getPrototypeOf,et),It=et.create,Nt=at.propertyIsEnumerable,kt=it.splice,Ot=vt?vt.isConcatSpreadable:o,Lt=vt?vt.iterator:o,Ut=vt?vt.toStringTag:o,ir=function(){try{var e=Uo(et,"defineProperty");return e({},"",{}),e}catch(e){}}(),pr=t.clearTimeout!==Dt.clearTimeout&&t.clearTimeout,kr=n&&n.now!==Dt.Date.now&&n.now,Or=t.setTimeout!==Dt.setTimeout&&t.setTimeout,Fr=Qe.ceil,Lr=Qe.floor,Ur=et.getOwnPropertySymbols,Vr=gt?gt.isBuffer:o,Br=t.isFinite,zr=it.join,jr=Tr(et.keys,et),Hr=Qe.max,$r=Qe.min,Gr=n.now,Wr=t.parseInt,qr=Qe.random,Xr=it.reverse,Kr=Uo(t,"DataView"),Yr=Uo(t,"Map"),Zr=Uo(t,"Promise"),Jr=Uo(t,"Set"),Qr=Uo(t,"WeakMap"),en=Uo(et,"create"),tn=Qr&&new Qr,rn={},nn=ca(Kr),on=ca(Yr),an=ca(Zr),sn=ca(Jr),ln=ca(Qr),un=vt?vt.prototype:o,cn=un?un.valueOf:o,hn=un?un.toString:o;function pn(e){if(As(e)&&!gs(e)&&!(e instanceof gn)){if(e instanceof mn)return e;if(ut.call(e,"__wrapped__"))return ha(e)}return new mn(e)}var dn=function(){function e(){}return function(t){if(!Ts(t))return{};if(It)return It(t);e.prototype=t;var r=new e;return e.prototype=o,r}}();function fn(){}function mn(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=o}function gn(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=L,this.__views__=[]}function vn(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function yn(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function bn(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function wn(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new bn;++t<r;)this.add(e[t])}function xn(e){var t=this.__data__=new yn(e);this.size=t.size}function _n(e,t){var r=gs(e),n=!r&&ms(e),i=!r&&!n&&ws(e),o=!r&&!n&&!i&&Os(e),a=r||n||i||o,s=a?mr(e.length,rt):[],l=s.length;for(var u in e)!t&&!ut.call(e,u)||a&&("length"==u||i&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||Go(u,l))||s.push(u);return s}function Sn(e){var t=e.length;return t?e[wi(0,t-1)]:o}function Cn(e,t){return sa(to(e),Dn(t,0,e.length))}function Mn(e){return sa(to(e))}function Tn(e,t,r){(r===o||ps(e[t],r))&&(r!==o||t in e)||In(e,t,r)}function An(e,t,r){var n=e[t];ut.call(e,t)&&ps(n,r)&&(r!==o||t in e)||In(e,t,r)}function En(e,t){for(var r=e.length;r--;)if(ps(e[r][0],t))return r;return-1}function Pn(e,t,r,n){return Un(e,function(e,i,o){t(n,e,r(e),o)}),n}function Rn(e,t){return e&&ro(t,nl(t),e)}function In(e,t,r){"__proto__"==t&&ir?ir(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}function Nn(e,t){for(var n=-1,i=t.length,a=r(i),s=null==e;++n<i;)a[n]=s?o:Js(e,t[n]);return a}function Dn(e,t,r){return e==e&&(r!==o&&(e=e<=r?e:r),t!==o&&(e=e>=t?e:t)),e}function kn(e,t,r,n,i,a){var s,l=t&p,u=t&d,c=t&f;if(r&&(s=i?r(e,n,i,a):r(e)),s!==o)return s;if(!Ts(e))return e;var h=gs(e);if(h){if(s=function(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&ut.call(e,"index")&&(r.index=e.index,r.input=e.input),r}(e),!l)return to(e,s)}else{var m=zo(e),g=m==X||m==K;if(ws(e))return Ki(e,l);if(m==Q||m==z||g&&!i){if(s=u||g?{}:Ho(e),!l)return u?function(e,t){return ro(e,Bo(e),t)}(e,function(e,t){return e&&ro(t,il(t),e)}(s,e)):function(e,t){return ro(e,Vo(e),t)}(e,Rn(s,e))}else{if(!At[m])return i?e:{};s=function(e,t,r){var n=e.constructor;switch(t){case le:return Yi(e);case $:case G:return new n(+e);case ue:return function(e,t){var r=t?Yi(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,r);case ce:case he:case pe:case de:case fe:case me:case ge:case ve:case ye:return Zi(e,r);case Y:return new n;case Z:case ne:return new n(e);case te:return function(e){var t=new e.constructor(e.source,He.exec(e));return t.lastIndex=e.lastIndex,t}(e);case re:return new n;case ie:return function(e){return cn?et(cn.call(e)):{}}(e)}}(e,m,l)}}a||(a=new xn);var v=a.get(e);if(v)return v;if(a.set(e,s),Ns(e))return e.forEach(function(n){s.add(kn(n,t,r,n,e,a))}),s;if(Es(e))return e.forEach(function(n,i){s.set(i,kn(n,t,r,i,e,a))}),s;var y=h?o:(c?u?Io:Ro:u?il:nl)(e);return qt(y||e,function(n,i){y&&(n=e[i=n]),An(s,i,kn(n,t,r,i,e,a))}),s}function On(e,t,r){var n=r.length;if(null==e)return!n;for(e=et(e);n--;){var i=r[n],a=t[i],s=e[i];if(s===o&&!(i in e)||!a(s))return!1}return!0}function Fn(e,t,r){if("function"!=typeof e)throw new nt(l);return na(function(){e.apply(o,r)},t)}function Ln(e,t,r,n){var i=-1,o=Zt,s=!0,l=e.length,u=[],c=t.length;if(!l)return u;r&&(t=Qt(t,gr(r))),n?(o=Jt,s=!1):t.length>=a&&(o=yr,s=!1,t=new wn(t));e:for(;++i<l;){var h=e[i],p=null==r?h:r(h);if(h=n||0!==h?h:0,s&&p==p){for(var d=c;d--;)if(t[d]===p)continue e;u.push(h)}else o(t,p,n)||u.push(h)}return u}pn.templateSettings={escape:Te,evaluate:Ae,interpolate:Ee,variable:"",imports:{_:pn}},pn.prototype=fn.prototype,pn.prototype.constructor=pn,mn.prototype=dn(fn.prototype),mn.prototype.constructor=mn,gn.prototype=dn(fn.prototype),gn.prototype.constructor=gn,vn.prototype.clear=function(){this.__data__=en?en(null):{},this.size=0},vn.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},vn.prototype.get=function(e){var t=this.__data__;if(en){var r=t[e];return r===u?o:r}return ut.call(t,e)?t[e]:o},vn.prototype.has=function(e){var t=this.__data__;return en?t[e]!==o:ut.call(t,e)},vn.prototype.set=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=en&&t===o?u:t,this},yn.prototype.clear=function(){this.__data__=[],this.size=0},yn.prototype.delete=function(e){var t=this.__data__,r=En(t,e);return!(r<0||(r==t.length-1?t.pop():kt.call(t,r,1),--this.size,0))},yn.prototype.get=function(e){var t=this.__data__,r=En(t,e);return r<0?o:t[r][1]},yn.prototype.has=function(e){return En(this.__data__,e)>-1},yn.prototype.set=function(e,t){var r=this.__data__,n=En(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this},bn.prototype.clear=function(){this.size=0,this.__data__={hash:new vn,map:new(Yr||yn),string:new vn}},bn.prototype.delete=function(e){var t=Fo(this,e).delete(e);return this.size-=t?1:0,t},bn.prototype.get=function(e){return Fo(this,e).get(e)},bn.prototype.has=function(e){return Fo(this,e).has(e)},bn.prototype.set=function(e,t){var r=Fo(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this},wn.prototype.add=wn.prototype.push=function(e){return this.__data__.set(e,u),this},wn.prototype.has=function(e){return this.__data__.has(e)},xn.prototype.clear=function(){this.__data__=new yn,this.size=0},xn.prototype.delete=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r},xn.prototype.get=function(e){return this.__data__.get(e)},xn.prototype.has=function(e){return this.__data__.has(e)},xn.prototype.set=function(e,t){var r=this.__data__;if(r instanceof yn){var n=r.__data__;if(!Yr||n.length<a-1)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new bn(n)}return r.set(e,t),this.size=r.size,this};var Un=oo(Wn),Vn=oo(qn,!0);function Bn(e,t){var r=!0;return Un(e,function(e,n,i){return r=!!t(e,n,i)}),r}function zn(e,t,r){for(var n=-1,i=e.length;++n<i;){var a=e[n],s=t(a);if(null!=s&&(l===o?s==s&&!ks(s):r(s,l)))var l=s,u=a}return u}function jn(e,t){var r=[];return Un(e,function(e,n,i){t(e,n,i)&&r.push(e)}),r}function Hn(e,t,r,n,i){var o=-1,a=e.length;for(r||(r=$o),i||(i=[]);++o<a;){var s=e[o];t>0&&r(s)?t>1?Hn(s,t-1,r,n,i):er(i,s):n||(i[i.length]=s)}return i}var $n=ao(),Gn=ao(!0);function Wn(e,t){return e&&$n(e,t,nl)}function qn(e,t){return e&&Gn(e,t,nl)}function Xn(e,t){return Yt(t,function(t){return Ss(e[t])})}function Kn(e,t){for(var r=0,n=(t=Gi(t,e)).length;null!=e&&r<n;)e=e[ua(t[r++])];return r&&r==n?e:o}function Yn(e,t,r){var n=t(e);return gs(e)?n:er(n,r(e))}function Zn(e){return null==e?e===o?oe:J:Ut&&Ut in et(e)?function(e){var t=ut.call(e,Ut),r=e[Ut];try{e[Ut]=o;var n=!0}catch(e){}var i=pt.call(e);return n&&(t?e[Ut]=r:delete e[Ut]),i}(e):function(e){return pt.call(e)}(e)}function Jn(e,t){return e>t}function Qn(e,t){return null!=e&&ut.call(e,t)}function ei(e,t){return null!=e&&t in et(e)}function ti(e,t,n){for(var i=n?Jt:Zt,a=e[0].length,s=e.length,l=s,u=r(s),c=1/0,h=[];l--;){var p=e[l];l&&t&&(p=Qt(p,gr(t))),c=$r(p.length,c),u[l]=!n&&(t||a>=120&&p.length>=120)?new wn(l&&p):o}p=e[0];var d=-1,f=u[0];e:for(;++d<a&&h.length<c;){var m=p[d],g=t?t(m):m;if(m=n||0!==m?m:0,!(f?yr(f,g):i(h,g,n))){for(l=s;--l;){var v=u[l];if(!(v?yr(v,g):i(e[l],g,n)))continue e}f&&f.push(g),h.push(m)}}return h}function ri(e,t,r){var n=null==(e=ea(e,t=Gi(t,e)))?e:e[ua(_a(t))];return null==n?o:Gt(n,e,r)}function ni(e){return As(e)&&Zn(e)==z}function ii(e,t,r,n,i){return e===t||(null==e||null==t||!As(e)&&!As(t)?e!=e&&t!=t:function(e,t,r,n,i,a){var s=gs(e),l=gs(t),u=s?j:zo(e),c=l?j:zo(t),h=(u=u==z?Q:u)==Q,p=(c=c==z?Q:c)==Q,d=u==c;if(d&&ws(e)){if(!ws(t))return!1;s=!0,h=!1}if(d&&!h)return a||(a=new xn),s||Os(e)?Eo(e,t,r,n,i,a):function(e,t,r,n,i,o,a){switch(r){case ue:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case le:return!(e.byteLength!=t.byteLength||!o(new wt(e),new wt(t)));case $:case G:case Z:return ps(+e,+t);case q:return e.name==t.name&&e.message==t.message;case te:case ne:return e==t+"";case Y:var s=Mr;case re:var l=n&m;if(s||(s=Er),e.size!=t.size&&!l)return!1;var u=a.get(e);if(u)return u==t;n|=g,a.set(e,t);var c=Eo(s(e),s(t),n,i,o,a);return a.delete(e),c;case ie:if(cn)return cn.call(e)==cn.call(t)}return!1}(e,t,u,r,n,i,a);if(!(r&m)){var f=h&&ut.call(e,"__wrapped__"),v=p&&ut.call(t,"__wrapped__");if(f||v){var y=f?e.value():e,b=v?t.value():t;return a||(a=new xn),i(y,b,r,n,a)}}return!!d&&(a||(a=new xn),function(e,t,r,n,i,a){var s=r&m,l=Ro(e),u=l.length,c=Ro(t).length;if(u!=c&&!s)return!1;for(var h=u;h--;){var p=l[h];if(!(s?p in t:ut.call(t,p)))return!1}var d=a.get(e);if(d&&a.get(t))return d==t;var f=!0;a.set(e,t),a.set(t,e);for(var g=s;++h<u;){p=l[h];var v=e[p],y=t[p];if(n)var b=s?n(y,v,p,t,e,a):n(v,y,p,e,t,a);if(!(b===o?v===y||i(v,y,r,n,a):b)){f=!1;break}g||(g="constructor"==p)}if(f&&!g){var w=e.constructor,x=t.constructor;w!=x&&"constructor"in e&&"constructor"in t&&!("function"==typeof w&&w instanceof w&&"function"==typeof x&&x instanceof x)&&(f=!1)}return a.delete(e),a.delete(t),f}(e,t,r,n,i,a))}(e,t,r,n,ii,i))}function oi(e,t,r,n){var i=r.length,a=i,s=!n;if(null==e)return!a;for(e=et(e);i--;){var l=r[i];if(s&&l[2]?l[1]!==e[l[0]]:!(l[0]in e))return!1}for(;++i<a;){var u=(l=r[i])[0],c=e[u],h=l[1];if(s&&l[2]){if(c===o&&!(u in e))return!1}else{var p=new xn;if(n)var d=n(c,h,u,e,t,p);if(!(d===o?ii(h,c,m|g,n,p):d))return!1}}return!0}function ai(e){return!(!Ts(e)||function(e){return!!ht&&ht in e}(e))&&(Ss(e)?mt:We).test(ca(e))}function si(e){return"function"==typeof e?e:null==e?Pl:"object"==typeof e?gs(e)?di(e[0],e[1]):pi(e):Ul(e)}function li(e){if(!Yo(e))return jr(e);var t=[];for(var r in et(e))ut.call(e,r)&&"constructor"!=r&&t.push(r);return t}function ui(e){if(!Ts(e))return function(e){var t=[];if(null!=e)for(var r in et(e))t.push(r);return t}(e);var t=Yo(e),r=[];for(var n in e)("constructor"!=n||!t&&ut.call(e,n))&&r.push(n);return r}function ci(e,t){return e<t}function hi(e,t){var n=-1,i=ys(e)?r(e.length):[];return Un(e,function(e,r,o){i[++n]=t(e,r,o)}),i}function pi(e){var t=Lo(e);return 1==t.length&&t[0][2]?Jo(t[0][0],t[0][1]):function(r){return r===e||oi(r,e,t)}}function di(e,t){return qo(e)&&Zo(t)?Jo(ua(e),t):function(r){var n=Js(r,e);return n===o&&n===t?Qs(r,e):ii(t,n,m|g)}}function fi(e,t,r,n,i){e!==t&&$n(t,function(a,s){if(Ts(a))i||(i=new xn),function(e,t,r,n,i,a,s){var l=ta(e,r),u=ta(t,r),c=s.get(u);if(c)Tn(e,r,c);else{var h=a?a(l,u,r+"",e,t,s):o,p=h===o;if(p){var d=gs(u),f=!d&&ws(u),m=!d&&!f&&Os(u);h=u,d||f||m?gs(l)?h=l:bs(l)?h=to(l):f?(p=!1,h=Ki(u,!0)):m?(p=!1,h=Zi(u,!0)):h=[]:Rs(u)||ms(u)?(h=l,ms(l)?h=Hs(l):Ts(l)&&!Ss(l)||(h=Ho(u))):p=!1}p&&(s.set(u,h),i(h,u,n,a,s),s.delete(u)),Tn(e,r,h)}}(e,t,s,r,fi,n,i);else{var l=n?n(ta(e,s),a,s+"",e,t,i):o;l===o&&(l=a),Tn(e,s,l)}},il)}function mi(e,t){var r=e.length;if(r)return Go(t+=t<0?r:0,r)?e[t]:o}function gi(e,t,r){var n=-1;return t=Qt(t.length?t:[Pl],gr(Oo())),function(e,t){var r=e.length;for(e.sort(t);r--;)e[r]=e[r].value;return e}(hi(e,function(e,r,i){return{criteria:Qt(t,function(t){return t(e)}),index:++n,value:e}}),function(e,t){return function(e,t,r){for(var n=-1,i=e.criteria,o=t.criteria,a=i.length,s=r.length;++n<a;){var l=Ji(i[n],o[n]);if(l){if(n>=s)return l;var u=r[n];return l*("desc"==u?-1:1)}}return e.index-t.index}(e,t,r)})}function vi(e,t,r){for(var n=-1,i=t.length,o={};++n<i;){var a=t[n],s=Kn(e,a);r(s,a)&&Mi(o,Gi(a,e),s)}return o}function yi(e,t,r,n){var i=n?lr:sr,o=-1,a=t.length,s=e;for(e===t&&(t=to(t)),r&&(s=Qt(e,gr(r)));++o<a;)for(var l=0,u=t[o],c=r?r(u):u;(l=i(s,c,l,n))>-1;)s!==e&&kt.call(s,l,1),kt.call(e,l,1);return e}function bi(e,t){for(var r=e?t.length:0,n=r-1;r--;){var i=t[r];if(r==n||i!==o){var o=i;Go(i)?kt.call(e,i,1):Li(e,i)}}return e}function wi(e,t){return e+Lr(qr()*(t-e+1))}function xi(e,t){var r="";if(!e||t<1||t>k)return r;do{t%2&&(r+=e),(t=Lr(t/2))&&(e+=e)}while(t);return r}function _i(e,t){return ia(Qo(e,t,Pl),e+"")}function Si(e){return Sn(pl(e))}function Ci(e,t){var r=pl(e);return sa(r,Dn(t,0,r.length))}function Mi(e,t,r,n){if(!Ts(e))return e;for(var i=-1,a=(t=Gi(t,e)).length,s=a-1,l=e;null!=l&&++i<a;){var u=ua(t[i]),c=r;if(i!=s){var h=l[u];(c=n?n(h,u,l):o)===o&&(c=Ts(h)?h:Go(t[i+1])?[]:{})}An(l,u,c),l=l[u]}return e}var Ti=tn?function(e,t){return tn.set(e,t),e}:Pl,Ai=ir?function(e,t){return ir(e,"toString",{configurable:!0,enumerable:!1,value:Tl(t),writable:!0})}:Pl;function Ei(e){return sa(pl(e))}function Pi(e,t,n){var i=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(n=n>o?o:n)<0&&(n+=o),o=t>n?0:n-t>>>0,t>>>=0;for(var a=r(o);++i<o;)a[i]=e[i+t];return a}function Ri(e,t){var r;return Un(e,function(e,n,i){return!(r=t(e,n,i))}),!!r}function Ii(e,t,r){var n=0,i=null==e?n:e.length;if("number"==typeof t&&t==t&&i<=V){for(;n<i;){var o=n+i>>>1,a=e[o];null!==a&&!ks(a)&&(r?a<=t:a<t)?n=o+1:i=o}return i}return Ni(e,t,Pl,r)}function Ni(e,t,r,n){t=r(t);for(var i=0,a=null==e?0:e.length,s=t!=t,l=null===t,u=ks(t),c=t===o;i<a;){var h=Lr((i+a)/2),p=r(e[h]),d=p!==o,f=null===p,m=p==p,g=ks(p);if(s)var v=n||m;else v=c?m&&(n||d):l?m&&d&&(n||!f):u?m&&d&&!f&&(n||!g):!f&&!g&&(n?p<=t:p<t);v?i=h+1:a=h}return $r(a,U)}function Di(e,t){for(var r=-1,n=e.length,i=0,o=[];++r<n;){var a=e[r],s=t?t(a):a;if(!r||!ps(s,l)){var l=s;o[i++]=0===a?0:a}}return o}function ki(e){return"number"==typeof e?e:ks(e)?F:+e}function Oi(e){if("string"==typeof e)return e;if(gs(e))return Qt(e,Oi)+"";if(ks(e))return hn?hn.call(e):"";var t=e+"";return"0"==t&&1/e==-D?"-0":t}function Fi(e,t,r){var n=-1,i=Zt,o=e.length,s=!0,l=[],u=l;if(r)s=!1,i=Jt;else if(o>=a){var c=t?null:_o(e);if(c)return Er(c);s=!1,i=yr,u=new wn}else u=t?[]:l;e:for(;++n<o;){var h=e[n],p=t?t(h):h;if(h=r||0!==h?h:0,s&&p==p){for(var d=u.length;d--;)if(u[d]===p)continue e;t&&u.push(p),l.push(h)}else i(u,p,r)||(u!==l&&u.push(p),l.push(h))}return l}function Li(e,t){return null==(e=ea(e,t=Gi(t,e)))||delete e[ua(_a(t))]}function Ui(e,t,r,n){return Mi(e,t,r(Kn(e,t)),n)}function Vi(e,t,r,n){for(var i=e.length,o=n?i:-1;(n?o--:++o<i)&&t(e[o],o,e););return r?Pi(e,n?0:o,n?o+1:i):Pi(e,n?o+1:0,n?i:o)}function Bi(e,t){var r=e;return r instanceof gn&&(r=r.value()),tr(t,function(e,t){return t.func.apply(t.thisArg,er([e],t.args))},r)}function zi(e,t,n){var i=e.length;if(i<2)return i?Fi(e[0]):[];for(var o=-1,a=r(i);++o<i;)for(var s=e[o],l=-1;++l<i;)l!=o&&(a[o]=Ln(a[o]||s,e[l],t,n));return Fi(Hn(a,1),t,n)}function ji(e,t,r){for(var n=-1,i=e.length,a=t.length,s={};++n<i;){var l=n<a?t[n]:o;r(s,e[n],l)}return s}function Hi(e){return bs(e)?e:[]}function $i(e){return"function"==typeof e?e:Pl}function Gi(e,t){return gs(e)?e:qo(e,t)?[e]:la($s(e))}var Wi=_i;function qi(e,t,r){var n=e.length;return r=r===o?n:r,!t&&r>=n?e:Pi(e,t,r)}var Xi=pr||function(e){return Dt.clearTimeout(e)};function Ki(e,t){if(t)return e.slice();var r=e.length,n=_t?_t(r):new e.constructor(r);return e.copy(n),n}function Yi(e){var t=new e.constructor(e.byteLength);return new wt(t).set(new wt(e)),t}function Zi(e,t){var r=t?Yi(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}function Ji(e,t){if(e!==t){var r=e!==o,n=null===e,i=e==e,a=ks(e),s=t!==o,l=null===t,u=t==t,c=ks(t);if(!l&&!c&&!a&&e>t||a&&s&&u&&!l&&!c||n&&s&&u||!r&&u||!i)return 1;if(!n&&!a&&!c&&e<t||c&&r&&i&&!n&&!a||l&&r&&i||!s&&i||!u)return-1}return 0}function Qi(e,t,n,i){for(var o=-1,a=e.length,s=n.length,l=-1,u=t.length,c=Hr(a-s,0),h=r(u+c),p=!i;++l<u;)h[l]=t[l];for(;++o<s;)(p||o<a)&&(h[n[o]]=e[o]);for(;c--;)h[l++]=e[o++];return h}function eo(e,t,n,i){for(var o=-1,a=e.length,s=-1,l=n.length,u=-1,c=t.length,h=Hr(a-l,0),p=r(h+c),d=!i;++o<h;)p[o]=e[o];for(var f=o;++u<c;)p[f+u]=t[u];for(;++s<l;)(d||o<a)&&(p[f+n[s]]=e[o++]);return p}function to(e,t){var n=-1,i=e.length;for(t||(t=r(i));++n<i;)t[n]=e[n];return t}function ro(e,t,r,n){var i=!r;r||(r={});for(var a=-1,s=t.length;++a<s;){var l=t[a],u=n?n(r[l],e[l],l,r,e):o;u===o&&(u=e[l]),i?In(r,l,u):An(r,l,u)}return r}function no(e,t){return function(r,n){var i=gs(r)?Wt:Pn,o=t?t():{};return i(r,e,Oo(n,2),o)}}function io(e){return _i(function(t,r){var n=-1,i=r.length,a=i>1?r[i-1]:o,s=i>2?r[2]:o;for(a=e.length>3&&"function"==typeof a?(i--,a):o,s&&Wo(r[0],r[1],s)&&(a=i<3?o:a,i=1),t=et(t);++n<i;){var l=r[n];l&&e(t,l,n,a)}return t})}function oo(e,t){return function(r,n){if(null==r)return r;if(!ys(r))return e(r,n);for(var i=r.length,o=t?i:-1,a=et(r);(t?o--:++o<i)&&!1!==n(a[o],o,a););return r}}function ao(e){return function(t,r,n){for(var i=-1,o=et(t),a=n(t),s=a.length;s--;){var l=a[e?s:++i];if(!1===r(o[l],l,o))break}return t}}function so(e){return function(t){var r=Cr(t=$s(t))?Ir(t):o,n=r?r[0]:t.charAt(0),i=r?qi(r,1).join(""):t.slice(1);return n[e]()+i}}function lo(e){return function(t){return tr(Sl(ml(t).replace(yt,"")),e,"")}}function uo(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var r=dn(e.prototype),n=e.apply(r,t);return Ts(n)?n:r}}function co(e){return function(t,r,n){var i=et(t);if(!ys(t)){var a=Oo(r,3);t=nl(t),r=function(e){return a(i[e],e,i)}}var s=e(t,r,n);return s>-1?i[a?t[s]:s]:o}}function ho(e){return Po(function(t){var r=t.length,n=r,i=mn.prototype.thru;for(e&&t.reverse();n--;){var a=t[n];if("function"!=typeof a)throw new nt(l);if(i&&!s&&"wrapper"==Do(a))var s=new mn([],!0)}for(n=s?n:r;++n<r;){var u=Do(a=t[n]),c="wrapper"==u?No(a):o;s=c&&Xo(c[0])&&c[1]==(C|w|_|M)&&!c[4].length&&1==c[9]?s[Do(c[0])].apply(s,c[3]):1==a.length&&Xo(a)?s[u]():s.thru(a)}return function(){var e=arguments,n=e[0];if(s&&1==e.length&&gs(n))return s.plant(n).value();for(var i=0,o=r?t[i].apply(this,e):n;++i<r;)o=t[i].call(this,o);return o}})}function po(e,t,n,i,a,s,l,u,c,h){var p=t&C,d=t&v,f=t&y,m=t&(w|x),g=t&T,b=f?o:uo(e);return function v(){for(var y=arguments.length,w=r(y),x=y;x--;)w[x]=arguments[x];if(m)var _=ko(v),S=function(e,t){for(var r=e.length,n=0;r--;)e[r]===t&&++n;return n}(w,_);if(i&&(w=Qi(w,i,a,m)),s&&(w=eo(w,s,l,m)),y-=S,m&&y<h){var C=Ar(w,_);return wo(e,t,po,v.placeholder,n,w,C,u,c,h-y)}var M=d?n:this,T=f?M[e]:e;return y=w.length,u?w=function(e,t){for(var r=e.length,n=$r(t.length,r),i=to(e);n--;){var a=t[n];e[n]=Go(a,r)?i[a]:o}return e}(w,u):g&&y>1&&w.reverse(),p&&c<y&&(w.length=c),this&&this!==Dt&&this instanceof v&&(T=b||uo(T)),T.apply(M,w)}}function fo(e,t){return function(r,n){return function(e,t,r,n){return Wn(e,function(e,i,o){t(n,r(e),i,o)}),n}(r,e,t(n),{})}}function mo(e,t){return function(r,n){var i;if(r===o&&n===o)return t;if(r!==o&&(i=r),n!==o){if(i===o)return n;"string"==typeof r||"string"==typeof n?(r=Oi(r),n=Oi(n)):(r=ki(r),n=ki(n)),i=e(r,n)}return i}}function go(e){return Po(function(t){return t=Qt(t,gr(Oo())),_i(function(r){var n=this;return e(t,function(e){return Gt(e,n,r)})})})}function vo(e,t){var r=(t=t===o?" ":Oi(t)).length;if(r<2)return r?xi(t,e):t;var n=xi(t,Fr(e/Rr(t)));return Cr(t)?qi(Ir(n),0,e).join(""):n.slice(0,e)}function yo(e){return function(t,n,i){return i&&"number"!=typeof i&&Wo(t,n,i)&&(n=i=o),t=Vs(t),n===o?(n=t,t=0):n=Vs(n),function(e,t,n,i){for(var o=-1,a=Hr(Fr((t-e)/(n||1)),0),s=r(a);a--;)s[i?a:++o]=e,e+=n;return s}(t,n,i=i===o?t<n?1:-1:Vs(i),e)}}function bo(e){return function(t,r){return"string"==typeof t&&"string"==typeof r||(t=js(t),r=js(r)),e(t,r)}}function wo(e,t,r,n,i,a,s,l,u,c){var h=t&w;t|=h?_:S,(t&=~(h?S:_))&b||(t&=~(v|y));var p=[e,t,i,h?a:o,h?s:o,h?o:a,h?o:s,l,u,c],d=r.apply(o,p);return Xo(e)&&ra(d,p),d.placeholder=n,oa(d,e,t)}function xo(e){var t=Qe[e];return function(e,r){if(e=js(e),r=null==r?0:$r(Bs(r),292)){var n=($s(e)+"e").split("e");return+((n=($s(t(n[0]+"e"+(+n[1]+r)))+"e").split("e"))[0]+"e"+(+n[1]-r))}return t(e)}}var _o=Jr&&1/Er(new Jr([,-0]))[1]==D?function(e){return new Jr(e)}:kl;function So(e){return function(t){var r=zo(t);return r==Y?Mr(t):r==re?Pr(t):function(e,t){return Qt(t,function(t){return[t,e[t]]})}(t,e(t))}}function Co(e,t,n,i,a,s,u,c){var p=t&y;if(!p&&"function"!=typeof e)throw new nt(l);var d=i?i.length:0;if(d||(t&=~(_|S),i=a=o),u=u===o?u:Hr(Bs(u),0),c=c===o?c:Bs(c),d-=a?a.length:0,t&S){var f=i,m=a;i=a=o}var g=p?o:No(e),T=[e,t,n,i,a,f,m,s,u,c];if(g&&function(e,t){var r=e[1],n=t[1],i=r|n,o=i<(v|y|C),a=n==C&&r==w||n==C&&r==M&&e[7].length<=t[8]||n==(C|M)&&t[7].length<=t[8]&&r==w;if(!o&&!a)return e;n&v&&(e[2]=t[2],i|=r&v?0:b);var s=t[3];if(s){var l=e[3];e[3]=l?Qi(l,s,t[4]):s,e[4]=l?Ar(e[3],h):t[4]}(s=t[5])&&(l=e[5],e[5]=l?eo(l,s,t[6]):s,e[6]=l?Ar(e[5],h):t[6]),(s=t[7])&&(e[7]=s),n&C&&(e[8]=null==e[8]?t[8]:$r(e[8],t[8])),null==e[9]&&(e[9]=t[9]),e[0]=t[0],e[1]=i}(T,g),e=T[0],t=T[1],n=T[2],i=T[3],a=T[4],!(c=T[9]=T[9]===o?p?0:e.length:Hr(T[9]-d,0))&&t&(w|x)&&(t&=~(w|x)),t&&t!=v)A=t==w||t==x?function(e,t,n){var i=uo(e);return function a(){for(var s=arguments.length,l=r(s),u=s,c=ko(a);u--;)l[u]=arguments[u];var h=s<3&&l[0]!==c&&l[s-1]!==c?[]:Ar(l,c);return(s-=h.length)<n?wo(e,t,po,a.placeholder,o,l,h,o,o,n-s):Gt(this&&this!==Dt&&this instanceof a?i:e,this,l)}}(e,t,c):t!=_&&t!=(v|_)||a.length?po.apply(o,T):function(e,t,n,i){var o=t&v,a=uo(e);return function t(){for(var s=-1,l=arguments.length,u=-1,c=i.length,h=r(c+l),p=this&&this!==Dt&&this instanceof t?a:e;++u<c;)h[u]=i[u];for(;l--;)h[u++]=arguments[++s];return Gt(p,o?n:this,h)}}(e,t,n,i);else var A=function(e,t,r){var n=t&v,i=uo(e);return function t(){return(this&&this!==Dt&&this instanceof t?i:e).apply(n?r:this,arguments)}}(e,t,n);return oa((g?Ti:ra)(A,T),e,t)}function Mo(e,t,r,n){return e===o||ps(e,at[r])&&!ut.call(n,r)?t:e}function To(e,t,r,n,i,a){return Ts(e)&&Ts(t)&&(a.set(t,e),fi(e,t,o,To,a),a.delete(t)),e}function Ao(e){return Rs(e)?o:e}function Eo(e,t,r,n,i,a){var s=r&m,l=e.length,u=t.length;if(l!=u&&!(s&&u>l))return!1;var c=a.get(e);if(c&&a.get(t))return c==t;var h=-1,p=!0,d=r&g?new wn:o;for(a.set(e,t),a.set(t,e);++h<l;){var f=e[h],v=t[h];if(n)var y=s?n(v,f,h,t,e,a):n(f,v,h,e,t,a);if(y!==o){if(y)continue;p=!1;break}if(d){if(!nr(t,function(e,t){if(!yr(d,t)&&(f===e||i(f,e,r,n,a)))return d.push(t)})){p=!1;break}}else if(f!==v&&!i(f,v,r,n,a)){p=!1;break}}return a.delete(e),a.delete(t),p}function Po(e){return ia(Qo(e,o,va),e+"")}function Ro(e){return Yn(e,nl,Vo)}function Io(e){return Yn(e,il,Bo)}var No=tn?function(e){return tn.get(e)}:kl;function Do(e){for(var t=e.name+"",r=rn[t],n=ut.call(rn,t)?r.length:0;n--;){var i=r[n],o=i.func;if(null==o||o==e)return i.name}return t}function ko(e){return(ut.call(pn,"placeholder")?pn:e).placeholder}function Oo(){var e=pn.iteratee||Rl;return e=e===Rl?si:e,arguments.length?e(arguments[0],arguments[1]):e}function Fo(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function Lo(e){for(var t=nl(e),r=t.length;r--;){var n=t[r],i=e[n];t[r]=[n,i,Zo(i)]}return t}function Uo(e,t){var r=function(e,t){return null==e?o:e[t]}(e,t);return ai(r)?r:o}var Vo=Ur?function(e){return null==e?[]:(e=et(e),Yt(Ur(e),function(t){return Nt.call(e,t)}))}:zl,Bo=Ur?function(e){for(var t=[];e;)er(t,Vo(e)),e=Et(e);return t}:zl,zo=Zn;function jo(e,t,r){for(var n=-1,i=(t=Gi(t,e)).length,o=!1;++n<i;){var a=ua(t[n]);if(!(o=null!=e&&r(e,a)))break;e=e[a]}return o||++n!=i?o:!!(i=null==e?0:e.length)&&Ms(i)&&Go(a,i)&&(gs(e)||ms(e))}function Ho(e){return"function"!=typeof e.constructor||Yo(e)?{}:dn(Et(e))}function $o(e){return gs(e)||ms(e)||!!(Ot&&e&&e[Ot])}function Go(e,t){var r=typeof e;return!!(t=null==t?k:t)&&("number"==r||"symbol"!=r&&Xe.test(e))&&e>-1&&e%1==0&&e<t}function Wo(e,t,r){if(!Ts(r))return!1;var n=typeof t;return!!("number"==n?ys(r)&&Go(t,r.length):"string"==n&&t in r)&&ps(r[t],e)}function qo(e,t){if(gs(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!ks(e))||Re.test(e)||!Pe.test(e)||null!=t&&e in et(t)}function Xo(e){var t=Do(e),r=pn[t];if("function"!=typeof r||!(t in gn.prototype))return!1;if(e===r)return!0;var n=No(r);return!!n&&e===n[0]}(Kr&&zo(new Kr(new ArrayBuffer(1)))!=ue||Yr&&zo(new Yr)!=Y||Zr&&"[object Promise]"!=zo(Zr.resolve())||Jr&&zo(new Jr)!=re||Qr&&zo(new Qr)!=ae)&&(zo=function(e){var t=Zn(e),r=t==Q?e.constructor:o,n=r?ca(r):"";if(n)switch(n){case nn:return ue;case on:return Y;case an:return"[object Promise]";case sn:return re;case ln:return ae}return t});var Ko=st?Ss:jl;function Yo(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||at)}function Zo(e){return e==e&&!Ts(e)}function Jo(e,t){return function(r){return null!=r&&r[e]===t&&(t!==o||e in et(r))}}function Qo(e,t,n){return t=Hr(t===o?e.length-1:t,0),function(){for(var i=arguments,o=-1,a=Hr(i.length-t,0),s=r(a);++o<a;)s[o]=i[t+o];o=-1;for(var l=r(t+1);++o<t;)l[o]=i[o];return l[t]=n(s),Gt(e,this,l)}}function ea(e,t){return t.length<2?e:Kn(e,Pi(t,0,-1))}function ta(e,t){if("__proto__"!=t)return e[t]}var ra=aa(Ti),na=Or||function(e,t){return Dt.setTimeout(e,t)},ia=aa(Ai);function oa(e,t,r){var n=t+"";return ia(e,function(e,t){var r=t.length;if(!r)return e;var n=r-1;return t[n]=(r>1?"& ":"")+t[n],t=t.join(r>2?", ":" "),e.replace(Le,"{\n/* [wrapped with "+t+"] */\n")}(n,function(e,t){return qt(B,function(r){var n="_."+r[0];t&r[1]&&!Zt(e,n)&&e.push(n)}),e.sort()}(function(e){var t=e.match(Ue);return t?t[1].split(Ve):[]}(n),r)))}function aa(e){var t=0,r=0;return function(){var n=Gr(),i=R-(n-r);if(r=n,i>0){if(++t>=P)return arguments[0]}else t=0;return e.apply(o,arguments)}}function sa(e,t){var r=-1,n=e.length,i=n-1;for(t=t===o?n:t;++r<t;){var a=wi(r,i),s=e[a];e[a]=e[r],e[r]=s}return e.length=t,e}var la=function(e){var t=as(e,function(e){return r.size===c&&r.clear(),e}),r=t.cache;return t}(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Ie,function(e,r,n,i){t.push(n?i.replace(ze,"$1"):r||e)}),t});function ua(e){if("string"==typeof e||ks(e))return e;var t=e+"";return"0"==t&&1/e==-D?"-0":t}function ca(e){if(null!=e){try{return lt.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function ha(e){if(e instanceof gn)return e.clone();var t=new mn(e.__wrapped__,e.__chain__);return t.__actions__=to(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var pa=_i(function(e,t){return bs(e)?Ln(e,Hn(t,1,bs,!0)):[]}),da=_i(function(e,t){var r=_a(t);return bs(r)&&(r=o),bs(e)?Ln(e,Hn(t,1,bs,!0),Oo(r,2)):[]}),fa=_i(function(e,t){var r=_a(t);return bs(r)&&(r=o),bs(e)?Ln(e,Hn(t,1,bs,!0),o,r):[]});function ma(e,t,r){var n=null==e?0:e.length;if(!n)return-1;var i=null==r?0:Bs(r);return i<0&&(i=Hr(n+i,0)),ar(e,Oo(t,3),i)}function ga(e,t,r){var n=null==e?0:e.length;if(!n)return-1;var i=n-1;return r!==o&&(i=Bs(r),i=r<0?Hr(n+i,0):$r(i,n-1)),ar(e,Oo(t,3),i,!0)}function va(e){return null!=e&&e.length?Hn(e,1):[]}function ya(e){return e&&e.length?e[0]:o}var ba=_i(function(e){var t=Qt(e,Hi);return t.length&&t[0]===e[0]?ti(t):[]}),wa=_i(function(e){var t=_a(e),r=Qt(e,Hi);return t===_a(r)?t=o:r.pop(),r.length&&r[0]===e[0]?ti(r,Oo(t,2)):[]}),xa=_i(function(e){var t=_a(e),r=Qt(e,Hi);return(t="function"==typeof t?t:o)&&r.pop(),r.length&&r[0]===e[0]?ti(r,o,t):[]});function _a(e){var t=null==e?0:e.length;return t?e[t-1]:o}var Sa=_i(Ca);function Ca(e,t){return e&&e.length&&t&&t.length?yi(e,t):e}var Ma=Po(function(e,t){var r=null==e?0:e.length,n=Nn(e,t);return bi(e,Qt(t,function(e){return Go(e,r)?+e:e}).sort(Ji)),n});function Ta(e){return null==e?e:Xr.call(e)}var Aa=_i(function(e){return Fi(Hn(e,1,bs,!0))}),Ea=_i(function(e){var t=_a(e);return bs(t)&&(t=o),Fi(Hn(e,1,bs,!0),Oo(t,2))}),Pa=_i(function(e){var t=_a(e);return t="function"==typeof t?t:o,Fi(Hn(e,1,bs,!0),o,t)});function Ra(e){if(!e||!e.length)return[];var t=0;return e=Yt(e,function(e){if(bs(e))return t=Hr(e.length,t),!0}),mr(t,function(t){return Qt(e,hr(t))})}function Ia(e,t){if(!e||!e.length)return[];var r=Ra(e);return null==t?r:Qt(r,function(e){return Gt(t,o,e)})}var Na=_i(function(e,t){return bs(e)?Ln(e,t):[]}),Da=_i(function(e){return zi(Yt(e,bs))}),ka=_i(function(e){var t=_a(e);return bs(t)&&(t=o),zi(Yt(e,bs),Oo(t,2))}),Oa=_i(function(e){var t=_a(e);return t="function"==typeof t?t:o,zi(Yt(e,bs),o,t)}),Fa=_i(Ra);var La=_i(function(e){var t=e.length,r=t>1?e[t-1]:o;return Ia(e,r="function"==typeof r?(e.pop(),r):o)});function Ua(e){var t=pn(e);return t.__chain__=!0,t}function Va(e,t){return t(e)}var Ba=Po(function(e){var t=e.length,r=t?e[0]:0,n=this.__wrapped__,i=function(t){return Nn(t,e)};return!(t>1||this.__actions__.length)&&n instanceof gn&&Go(r)?((n=n.slice(r,+r+(t?1:0))).__actions__.push({func:Va,args:[i],thisArg:o}),new mn(n,this.__chain__).thru(function(e){return t&&!e.length&&e.push(o),e})):this.thru(i)});var za=no(function(e,t,r){ut.call(e,r)?++e[r]:In(e,r,1)});var ja=co(ma),Ha=co(ga);function $a(e,t){return(gs(e)?qt:Un)(e,Oo(t,3))}function Ga(e,t){return(gs(e)?Xt:Vn)(e,Oo(t,3))}var Wa=no(function(e,t,r){ut.call(e,r)?e[r].push(t):In(e,r,[t])});var qa=_i(function(e,t,n){var i=-1,o="function"==typeof t,a=ys(e)?r(e.length):[];return Un(e,function(e){a[++i]=o?Gt(t,e,n):ri(e,t,n)}),a}),Xa=no(function(e,t,r){In(e,r,t)});function Ka(e,t){return(gs(e)?Qt:hi)(e,Oo(t,3))}var Ya=no(function(e,t,r){e[r?0:1].push(t)},function(){return[[],[]]});var Za=_i(function(e,t){if(null==e)return[];var r=t.length;return r>1&&Wo(e,t[0],t[1])?t=[]:r>2&&Wo(t[0],t[1],t[2])&&(t=[t[0]]),gi(e,Hn(t,1),[])}),Ja=kr||function(){return Dt.Date.now()};function Qa(e,t,r){return t=r?o:t,t=e&&null==t?e.length:t,Co(e,C,o,o,o,o,t)}function es(e,t){var r;if("function"!=typeof t)throw new nt(l);return e=Bs(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=o),r}}var ts=_i(function(e,t,r){var n=v;if(r.length){var i=Ar(r,ko(ts));n|=_}return Co(e,n,t,r,i)}),rs=_i(function(e,t,r){var n=v|y;if(r.length){var i=Ar(r,ko(rs));n|=_}return Co(t,n,e,r,i)});function ns(e,t,r){var n,i,a,s,u,c,h=0,p=!1,d=!1,f=!0;if("function"!=typeof e)throw new nt(l);function m(t){var r=n,a=i;return n=i=o,h=t,s=e.apply(a,r)}function g(e){var r=e-c;return c===o||r>=t||r<0||d&&e-h>=a}function v(){var e=Ja();if(g(e))return y(e);u=na(v,function(e){var r=t-(e-c);return d?$r(r,a-(e-h)):r}(e))}function y(e){return u=o,f&&n?m(e):(n=i=o,s)}function b(){var e=Ja(),r=g(e);if(n=arguments,i=this,c=e,r){if(u===o)return function(e){return h=e,u=na(v,t),p?m(e):s}(c);if(d)return u=na(v,t),m(c)}return u===o&&(u=na(v,t)),s}return t=js(t)||0,Ts(r)&&(p=!!r.leading,a=(d="maxWait"in r)?Hr(js(r.maxWait)||0,t):a,f="trailing"in r?!!r.trailing:f),b.cancel=function(){u!==o&&Xi(u),h=0,n=c=i=u=o},b.flush=function(){return u===o?s:y(Ja())},b}var is=_i(function(e,t){return Fn(e,1,t)}),os=_i(function(e,t,r){return Fn(e,js(t)||0,r)});function as(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new nt(l);var r=function(){var n=arguments,i=t?t.apply(this,n):n[0],o=r.cache;if(o.has(i))return o.get(i);var a=e.apply(this,n);return r.cache=o.set(i,a)||o,a};return r.cache=new(as.Cache||bn),r}function ss(e){if("function"!=typeof e)throw new nt(l);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}as.Cache=bn;var ls=Wi(function(e,t){var r=(t=1==t.length&&gs(t[0])?Qt(t[0],gr(Oo())):Qt(Hn(t,1),gr(Oo()))).length;return _i(function(n){for(var i=-1,o=$r(n.length,r);++i<o;)n[i]=t[i].call(this,n[i]);return Gt(e,this,n)})}),us=_i(function(e,t){var r=Ar(t,ko(us));return Co(e,_,o,t,r)}),cs=_i(function(e,t){var r=Ar(t,ko(cs));return Co(e,S,o,t,r)}),hs=Po(function(e,t){return Co(e,M,o,o,o,t)});function ps(e,t){return e===t||e!=e&&t!=t}var ds=bo(Jn),fs=bo(function(e,t){return e>=t}),ms=ni(function(){return arguments}())?ni:function(e){return As(e)&&ut.call(e,"callee")&&!Nt.call(e,"callee")},gs=r.isArray,vs=Vt?gr(Vt):function(e){return As(e)&&Zn(e)==le};function ys(e){return null!=e&&Ms(e.length)&&!Ss(e)}function bs(e){return As(e)&&ys(e)}var ws=Vr||jl,xs=Bt?gr(Bt):function(e){return As(e)&&Zn(e)==G};function _s(e){if(!As(e))return!1;var t=Zn(e);return t==q||t==W||"string"==typeof e.message&&"string"==typeof e.name&&!Rs(e)}function Ss(e){if(!Ts(e))return!1;var t=Zn(e);return t==X||t==K||t==H||t==ee}function Cs(e){return"number"==typeof e&&e==Bs(e)}function Ms(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=k}function Ts(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function As(e){return null!=e&&"object"==typeof e}var Es=zt?gr(zt):function(e){return As(e)&&zo(e)==Y};function Ps(e){return"number"==typeof e||As(e)&&Zn(e)==Z}function Rs(e){if(!As(e)||Zn(e)!=Q)return!1;var t=Et(e);if(null===t)return!0;var r=ut.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&lt.call(r)==dt}var Is=jt?gr(jt):function(e){return As(e)&&Zn(e)==te};var Ns=Ht?gr(Ht):function(e){return As(e)&&zo(e)==re};function Ds(e){return"string"==typeof e||!gs(e)&&As(e)&&Zn(e)==ne}function ks(e){return"symbol"==typeof e||As(e)&&Zn(e)==ie}var Os=$t?gr($t):function(e){return As(e)&&Ms(e.length)&&!!Tt[Zn(e)]};var Fs=bo(ci),Ls=bo(function(e,t){return e<=t});function Us(e){if(!e)return[];if(ys(e))return Ds(e)?Ir(e):to(e);if(Lt&&e[Lt])return function(e){for(var t,r=[];!(t=e.next()).done;)r.push(t.value);return r}(e[Lt]());var t=zo(e);return(t==Y?Mr:t==re?Er:pl)(e)}function Vs(e){return e?(e=js(e))===D||e===-D?(e<0?-1:1)*O:e==e?e:0:0===e?e:0}function Bs(e){var t=Vs(e),r=t%1;return t==t?r?t-r:t:0}function zs(e){return e?Dn(Bs(e),0,L):0}function js(e){if("number"==typeof e)return e;if(ks(e))return F;if(Ts(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Ts(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(ke,"");var r=Ge.test(e);return r||qe.test(e)?Rt(e.slice(2),r?2:8):$e.test(e)?F:+e}function Hs(e){return ro(e,il(e))}function $s(e){return null==e?"":Oi(e)}var Gs=io(function(e,t){if(Yo(t)||ys(t))ro(t,nl(t),e);else for(var r in t)ut.call(t,r)&&An(e,r,t[r])}),Ws=io(function(e,t){ro(t,il(t),e)}),qs=io(function(e,t,r,n){ro(t,il(t),e,n)}),Xs=io(function(e,t,r,n){ro(t,nl(t),e,n)}),Ks=Po(Nn);var Ys=_i(function(e,t){e=et(e);var r=-1,n=t.length,i=n>2?t[2]:o;for(i&&Wo(t[0],t[1],i)&&(n=1);++r<n;)for(var a=t[r],s=il(a),l=-1,u=s.length;++l<u;){var c=s[l],h=e[c];(h===o||ps(h,at[c])&&!ut.call(e,c))&&(e[c]=a[c])}return e}),Zs=_i(function(e){return e.push(o,To),Gt(al,o,e)});function Js(e,t,r){var n=null==e?o:Kn(e,t);return n===o?r:n}function Qs(e,t){return null!=e&&jo(e,t,ei)}var el=fo(function(e,t,r){null!=t&&"function"!=typeof t.toString&&(t=pt.call(t)),e[t]=r},Tl(Pl)),tl=fo(function(e,t,r){null!=t&&"function"!=typeof t.toString&&(t=pt.call(t)),ut.call(e,t)?e[t].push(r):e[t]=[r]},Oo),rl=_i(ri);function nl(e){return ys(e)?_n(e):li(e)}function il(e){return ys(e)?_n(e,!0):ui(e)}var ol=io(function(e,t,r){fi(e,t,r)}),al=io(function(e,t,r,n){fi(e,t,r,n)}),sl=Po(function(e,t){var r={};if(null==e)return r;var n=!1;t=Qt(t,function(t){return t=Gi(t,e),n||(n=t.length>1),t}),ro(e,Io(e),r),n&&(r=kn(r,p|d|f,Ao));for(var i=t.length;i--;)Li(r,t[i]);return r});var ll=Po(function(e,t){return null==e?{}:function(e,t){return vi(e,t,function(t,r){return Qs(e,r)})}(e,t)});function ul(e,t){if(null==e)return{};var r=Qt(Io(e),function(e){return[e]});return t=Oo(t),vi(e,r,function(e,r){return t(e,r[0])})}var cl=So(nl),hl=So(il);function pl(e){return null==e?[]:vr(e,nl(e))}var dl=lo(function(e,t,r){return t=t.toLowerCase(),e+(r?fl(t):t)});function fl(e){return _l($s(e).toLowerCase())}function ml(e){return(e=$s(e))&&e.replace(Ke,xr).replace(bt,"")}var gl=lo(function(e,t,r){return e+(r?"-":"")+t.toLowerCase()}),vl=lo(function(e,t,r){return e+(r?" ":"")+t.toLowerCase()}),yl=so("toLowerCase");var bl=lo(function(e,t,r){return e+(r?"_":"")+t.toLowerCase()});var wl=lo(function(e,t,r){return e+(r?" ":"")+_l(t)});var xl=lo(function(e,t,r){return e+(r?" ":"")+t.toUpperCase()}),_l=so("toUpperCase");function Sl(e,t,r){return e=$s(e),(t=r?o:t)===o?function(e){return St.test(e)}(e)?function(e){return e.match(xt)||[]}(e):function(e){return e.match(Be)||[]}(e):e.match(t)||[]}var Cl=_i(function(e,t){try{return Gt(e,o,t)}catch(e){return _s(e)?e:new i(e)}}),Ml=Po(function(e,t){return qt(t,function(t){t=ua(t),In(e,t,ts(e[t],e))}),e});function Tl(e){return function(){return e}}var Al=ho(),El=ho(!0);function Pl(e){return e}function Rl(e){return si("function"==typeof e?e:kn(e,p))}var Il=_i(function(e,t){return function(r){return ri(r,e,t)}}),Nl=_i(function(e,t){return function(r){return ri(e,r,t)}});function Dl(e,t,r){var n=nl(t),i=Xn(t,n);null!=r||Ts(t)&&(i.length||!n.length)||(r=t,t=e,e=this,i=Xn(t,nl(t)));var o=!(Ts(r)&&"chain"in r&&!r.chain),a=Ss(e);return qt(i,function(r){var n=t[r];e[r]=n,a&&(e.prototype[r]=function(){var t=this.__chain__;if(o||t){var r=e(this.__wrapped__);return(r.__actions__=to(this.__actions__)).push({func:n,args:arguments,thisArg:e}),r.__chain__=t,r}return n.apply(e,er([this.value()],arguments))})}),e}function kl(){}var Ol=go(Qt),Fl=go(Kt),Ll=go(nr);function Ul(e){return qo(e)?hr(ua(e)):function(e){return function(t){return Kn(t,e)}}(e)}var Vl=yo(),Bl=yo(!0);function zl(){return[]}function jl(){return!1}var Hl=mo(function(e,t){return e+t},0),$l=xo("ceil"),Gl=mo(function(e,t){return e/t},1),Wl=xo("floor");var ql=mo(function(e,t){return e*t},1),Xl=xo("round"),Kl=mo(function(e,t){return e-t},0);return pn.after=function(e,t){if("function"!=typeof t)throw new nt(l);return e=Bs(e),function(){if(--e<1)return t.apply(this,arguments)}},pn.ary=Qa,pn.assign=Gs,pn.assignIn=Ws,pn.assignInWith=qs,pn.assignWith=Xs,pn.at=Ks,pn.before=es,pn.bind=ts,pn.bindAll=Ml,pn.bindKey=rs,pn.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return gs(e)?e:[e]},pn.chain=Ua,pn.chunk=function(e,t,n){t=(n?Wo(e,t,n):t===o)?1:Hr(Bs(t),0);var i=null==e?0:e.length;if(!i||t<1)return[];for(var a=0,s=0,l=r(Fr(i/t));a<i;)l[s++]=Pi(e,a,a+=t);return l},pn.compact=function(e){for(var t=-1,r=null==e?0:e.length,n=0,i=[];++t<r;){var o=e[t];o&&(i[n++]=o)}return i},pn.concat=function(){var e=arguments.length;if(!e)return[];for(var t=r(e-1),n=arguments[0],i=e;i--;)t[i-1]=arguments[i];return er(gs(n)?to(n):[n],Hn(t,1))},pn.cond=function(e){var t=null==e?0:e.length,r=Oo();return e=t?Qt(e,function(e){if("function"!=typeof e[1])throw new nt(l);return[r(e[0]),e[1]]}):[],_i(function(r){for(var n=-1;++n<t;){var i=e[n];if(Gt(i[0],this,r))return Gt(i[1],this,r)}})},pn.conforms=function(e){return function(e){var t=nl(e);return function(r){return On(r,e,t)}}(kn(e,p))},pn.constant=Tl,pn.countBy=za,pn.create=function(e,t){var r=dn(e);return null==t?r:Rn(r,t)},pn.curry=function e(t,r,n){var i=Co(t,w,o,o,o,o,o,r=n?o:r);return i.placeholder=e.placeholder,i},pn.curryRight=function e(t,r,n){var i=Co(t,x,o,o,o,o,o,r=n?o:r);return i.placeholder=e.placeholder,i},pn.debounce=ns,pn.defaults=Ys,pn.defaultsDeep=Zs,pn.defer=is,pn.delay=os,pn.difference=pa,pn.differenceBy=da,pn.differenceWith=fa,pn.drop=function(e,t,r){var n=null==e?0:e.length;return n?Pi(e,(t=r||t===o?1:Bs(t))<0?0:t,n):[]},pn.dropRight=function(e,t,r){var n=null==e?0:e.length;return n?Pi(e,0,(t=n-(t=r||t===o?1:Bs(t)))<0?0:t):[]},pn.dropRightWhile=function(e,t){return e&&e.length?Vi(e,Oo(t,3),!0,!0):[]},pn.dropWhile=function(e,t){return e&&e.length?Vi(e,Oo(t,3),!0):[]},pn.fill=function(e,t,r,n){var i=null==e?0:e.length;return i?(r&&"number"!=typeof r&&Wo(e,t,r)&&(r=0,n=i),function(e,t,r,n){var i=e.length;for((r=Bs(r))<0&&(r=-r>i?0:i+r),(n=n===o||n>i?i:Bs(n))<0&&(n+=i),n=r>n?0:zs(n);r<n;)e[r++]=t;return e}(e,t,r,n)):[]},pn.filter=function(e,t){return(gs(e)?Yt:jn)(e,Oo(t,3))},pn.flatMap=function(e,t){return Hn(Ka(e,t),1)},pn.flatMapDeep=function(e,t){return Hn(Ka(e,t),D)},pn.flatMapDepth=function(e,t,r){return r=r===o?1:Bs(r),Hn(Ka(e,t),r)},pn.flatten=va,pn.flattenDeep=function(e){return null!=e&&e.length?Hn(e,D):[]},pn.flattenDepth=function(e,t){return null!=e&&e.length?Hn(e,t=t===o?1:Bs(t)):[]},pn.flip=function(e){return Co(e,T)},pn.flow=Al,pn.flowRight=El,pn.fromPairs=function(e){for(var t=-1,r=null==e?0:e.length,n={};++t<r;){var i=e[t];n[i[0]]=i[1]}return n},pn.functions=function(e){return null==e?[]:Xn(e,nl(e))},pn.functionsIn=function(e){return null==e?[]:Xn(e,il(e))},pn.groupBy=Wa,pn.initial=function(e){return null!=e&&e.length?Pi(e,0,-1):[]},pn.intersection=ba,pn.intersectionBy=wa,pn.intersectionWith=xa,pn.invert=el,pn.invertBy=tl,pn.invokeMap=qa,pn.iteratee=Rl,pn.keyBy=Xa,pn.keys=nl,pn.keysIn=il,pn.map=Ka,pn.mapKeys=function(e,t){var r={};return t=Oo(t,3),Wn(e,function(e,n,i){In(r,t(e,n,i),e)}),r},pn.mapValues=function(e,t){var r={};return t=Oo(t,3),Wn(e,function(e,n,i){In(r,n,t(e,n,i))}),r},pn.matches=function(e){return pi(kn(e,p))},pn.matchesProperty=function(e,t){return di(e,kn(t,p))},pn.memoize=as,pn.merge=ol,pn.mergeWith=al,pn.method=Il,pn.methodOf=Nl,pn.mixin=Dl,pn.negate=ss,pn.nthArg=function(e){return e=Bs(e),_i(function(t){return mi(t,e)})},pn.omit=sl,pn.omitBy=function(e,t){return ul(e,ss(Oo(t)))},pn.once=function(e){return es(2,e)},pn.orderBy=function(e,t,r,n){return null==e?[]:(gs(t)||(t=null==t?[]:[t]),gs(r=n?o:r)||(r=null==r?[]:[r]),gi(e,t,r))},pn.over=Ol,pn.overArgs=ls,pn.overEvery=Fl,pn.overSome=Ll,pn.partial=us,pn.partialRight=cs,pn.partition=Ya,pn.pick=ll,pn.pickBy=ul,pn.property=Ul,pn.propertyOf=function(e){return function(t){return null==e?o:Kn(e,t)}},pn.pull=Sa,pn.pullAll=Ca,pn.pullAllBy=function(e,t,r){return e&&e.length&&t&&t.length?yi(e,t,Oo(r,2)):e},pn.pullAllWith=function(e,t,r){return e&&e.length&&t&&t.length?yi(e,t,o,r):e},pn.pullAt=Ma,pn.range=Vl,pn.rangeRight=Bl,pn.rearg=hs,pn.reject=function(e,t){return(gs(e)?Yt:jn)(e,ss(Oo(t,3)))},pn.remove=function(e,t){var r=[];if(!e||!e.length)return r;var n=-1,i=[],o=e.length;for(t=Oo(t,3);++n<o;){var a=e[n];t(a,n,e)&&(r.push(a),i.push(n))}return bi(e,i),r},pn.rest=function(e,t){if("function"!=typeof e)throw new nt(l);return _i(e,t=t===o?t:Bs(t))},pn.reverse=Ta,pn.sampleSize=function(e,t,r){return t=(r?Wo(e,t,r):t===o)?1:Bs(t),(gs(e)?Cn:Ci)(e,t)},pn.set=function(e,t,r){return null==e?e:Mi(e,t,r)},pn.setWith=function(e,t,r,n){return n="function"==typeof n?n:o,null==e?e:Mi(e,t,r,n)},pn.shuffle=function(e){return(gs(e)?Mn:Ei)(e)},pn.slice=function(e,t,r){var n=null==e?0:e.length;return n?(r&&"number"!=typeof r&&Wo(e,t,r)?(t=0,r=n):(t=null==t?0:Bs(t),r=r===o?n:Bs(r)),Pi(e,t,r)):[]},pn.sortBy=Za,pn.sortedUniq=function(e){return e&&e.length?Di(e):[]},pn.sortedUniqBy=function(e,t){return e&&e.length?Di(e,Oo(t,2)):[]},pn.split=function(e,t,r){return r&&"number"!=typeof r&&Wo(e,t,r)&&(t=r=o),(r=r===o?L:r>>>0)?(e=$s(e))&&("string"==typeof t||null!=t&&!Is(t))&&!(t=Oi(t))&&Cr(e)?qi(Ir(e),0,r):e.split(t,r):[]},pn.spread=function(e,t){if("function"!=typeof e)throw new nt(l);return t=null==t?0:Hr(Bs(t),0),_i(function(r){var n=r[t],i=qi(r,0,t);return n&&er(i,n),Gt(e,this,i)})},pn.tail=function(e){var t=null==e?0:e.length;return t?Pi(e,1,t):[]},pn.take=function(e,t,r){return e&&e.length?Pi(e,0,(t=r||t===o?1:Bs(t))<0?0:t):[]},pn.takeRight=function(e,t,r){var n=null==e?0:e.length;return n?Pi(e,(t=n-(t=r||t===o?1:Bs(t)))<0?0:t,n):[]},pn.takeRightWhile=function(e,t){return e&&e.length?Vi(e,Oo(t,3),!1,!0):[]},pn.takeWhile=function(e,t){return e&&e.length?Vi(e,Oo(t,3)):[]},pn.tap=function(e,t){return t(e),e},pn.throttle=function(e,t,r){var n=!0,i=!0;if("function"!=typeof e)throw new nt(l);return Ts(r)&&(n="leading"in r?!!r.leading:n,i="trailing"in r?!!r.trailing:i),ns(e,t,{leading:n,maxWait:t,trailing:i})},pn.thru=Va,pn.toArray=Us,pn.toPairs=cl,pn.toPairsIn=hl,pn.toPath=function(e){return gs(e)?Qt(e,ua):ks(e)?[e]:to(la($s(e)))},pn.toPlainObject=Hs,pn.transform=function(e,t,r){var n=gs(e),i=n||ws(e)||Os(e);if(t=Oo(t,4),null==r){var o=e&&e.constructor;r=i?n?new o:[]:Ts(e)&&Ss(o)?dn(Et(e)):{}}return(i?qt:Wn)(e,function(e,n,i){return t(r,e,n,i)}),r},pn.unary=function(e){return Qa(e,1)},pn.union=Aa,pn.unionBy=Ea,pn.unionWith=Pa,pn.uniq=function(e){return e&&e.length?Fi(e):[]},pn.uniqBy=function(e,t){return e&&e.length?Fi(e,Oo(t,2)):[]},pn.uniqWith=function(e,t){return t="function"==typeof t?t:o,e&&e.length?Fi(e,o,t):[]},pn.unset=function(e,t){return null==e||Li(e,t)},pn.unzip=Ra,pn.unzipWith=Ia,pn.update=function(e,t,r){return null==e?e:Ui(e,t,$i(r))},pn.updateWith=function(e,t,r,n){return n="function"==typeof n?n:o,null==e?e:Ui(e,t,$i(r),n)},pn.values=pl,pn.valuesIn=function(e){return null==e?[]:vr(e,il(e))},pn.without=Na,pn.words=Sl,pn.wrap=function(e,t){return us($i(t),e)},pn.xor=Da,pn.xorBy=ka,pn.xorWith=Oa,pn.zip=Fa,pn.zipObject=function(e,t){return ji(e||[],t||[],An)},pn.zipObjectDeep=function(e,t){return ji(e||[],t||[],Mi)},pn.zipWith=La,pn.entries=cl,pn.entriesIn=hl,pn.extend=Ws,pn.extendWith=qs,Dl(pn,pn),pn.add=Hl,pn.attempt=Cl,pn.camelCase=dl,pn.capitalize=fl,pn.ceil=$l,pn.clamp=function(e,t,r){return r===o&&(r=t,t=o),r!==o&&(r=(r=js(r))==r?r:0),t!==o&&(t=(t=js(t))==t?t:0),Dn(js(e),t,r)},pn.clone=function(e){return kn(e,f)},pn.cloneDeep=function(e){return kn(e,p|f)},pn.cloneDeepWith=function(e,t){return kn(e,p|f,t="function"==typeof t?t:o)},pn.cloneWith=function(e,t){return kn(e,f,t="function"==typeof t?t:o)},pn.conformsTo=function(e,t){return null==t||On(e,t,nl(t))},pn.deburr=ml,pn.defaultTo=function(e,t){return null==e||e!=e?t:e},pn.divide=Gl,pn.endsWith=function(e,t,r){e=$s(e),t=Oi(t);var n=e.length,i=r=r===o?n:Dn(Bs(r),0,n);return(r-=t.length)>=0&&e.slice(r,i)==t},pn.eq=ps,pn.escape=function(e){return(e=$s(e))&&Me.test(e)?e.replace(Se,_r):e},pn.escapeRegExp=function(e){return(e=$s(e))&&De.test(e)?e.replace(Ne,"\\$&"):e},pn.every=function(e,t,r){var n=gs(e)?Kt:Bn;return r&&Wo(e,t,r)&&(t=o),n(e,Oo(t,3))},pn.find=ja,pn.findIndex=ma,pn.findKey=function(e,t){return or(e,Oo(t,3),Wn)},pn.findLast=Ha,pn.findLastIndex=ga,pn.findLastKey=function(e,t){return or(e,Oo(t,3),qn)},pn.floor=Wl,pn.forEach=$a,pn.forEachRight=Ga,pn.forIn=function(e,t){return null==e?e:$n(e,Oo(t,3),il)},pn.forInRight=function(e,t){return null==e?e:Gn(e,Oo(t,3),il)},pn.forOwn=function(e,t){return e&&Wn(e,Oo(t,3))},pn.forOwnRight=function(e,t){return e&&qn(e,Oo(t,3))},pn.get=Js,pn.gt=ds,pn.gte=fs,pn.has=function(e,t){return null!=e&&jo(e,t,Qn)},pn.hasIn=Qs,pn.head=ya,pn.identity=Pl,pn.includes=function(e,t,r,n){e=ys(e)?e:pl(e),r=r&&!n?Bs(r):0;var i=e.length;return r<0&&(r=Hr(i+r,0)),Ds(e)?r<=i&&e.indexOf(t,r)>-1:!!i&&sr(e,t,r)>-1},pn.indexOf=function(e,t,r){var n=null==e?0:e.length;if(!n)return-1;var i=null==r?0:Bs(r);return i<0&&(i=Hr(n+i,0)),sr(e,t,i)},pn.inRange=function(e,t,r){return t=Vs(t),r===o?(r=t,t=0):r=Vs(r),function(e,t,r){return e>=$r(t,r)&&e<Hr(t,r)}(e=js(e),t,r)},pn.invoke=rl,pn.isArguments=ms,pn.isArray=gs,pn.isArrayBuffer=vs,pn.isArrayLike=ys,pn.isArrayLikeObject=bs,pn.isBoolean=function(e){return!0===e||!1===e||As(e)&&Zn(e)==$},pn.isBuffer=ws,pn.isDate=xs,pn.isElement=function(e){return As(e)&&1===e.nodeType&&!Rs(e)},pn.isEmpty=function(e){if(null==e)return!0;if(ys(e)&&(gs(e)||"string"==typeof e||"function"==typeof e.splice||ws(e)||Os(e)||ms(e)))return!e.length;var t=zo(e);if(t==Y||t==re)return!e.size;if(Yo(e))return!li(e).length;for(var r in e)if(ut.call(e,r))return!1;return!0},pn.isEqual=function(e,t){return ii(e,t)},pn.isEqualWith=function(e,t,r){var n=(r="function"==typeof r?r:o)?r(e,t):o;return n===o?ii(e,t,o,r):!!n},pn.isError=_s,pn.isFinite=function(e){return"number"==typeof e&&Br(e)},pn.isFunction=Ss,pn.isInteger=Cs,pn.isLength=Ms,pn.isMap=Es,pn.isMatch=function(e,t){return e===t||oi(e,t,Lo(t))},pn.isMatchWith=function(e,t,r){return r="function"==typeof r?r:o,oi(e,t,Lo(t),r)},pn.isNaN=function(e){return Ps(e)&&e!=+e},pn.isNative=function(e){if(Ko(e))throw new i(s);return ai(e)},pn.isNil=function(e){return null==e},pn.isNull=function(e){return null===e},pn.isNumber=Ps,pn.isObject=Ts,pn.isObjectLike=As,pn.isPlainObject=Rs,pn.isRegExp=Is,pn.isSafeInteger=function(e){return Cs(e)&&e>=-k&&e<=k},pn.isSet=Ns,pn.isString=Ds,pn.isSymbol=ks,pn.isTypedArray=Os,pn.isUndefined=function(e){return e===o},pn.isWeakMap=function(e){return As(e)&&zo(e)==ae},pn.isWeakSet=function(e){return As(e)&&Zn(e)==se},pn.join=function(e,t){return null==e?"":zr.call(e,t)},pn.kebabCase=gl,pn.last=_a,pn.lastIndexOf=function(e,t,r){var n=null==e?0:e.length;if(!n)return-1;var i=n;return r!==o&&(i=(i=Bs(r))<0?Hr(n+i,0):$r(i,n-1)),t==t?function(e,t,r){for(var n=r+1;n--;)if(e[n]===t)return n;return n}(e,t,i):ar(e,ur,i,!0)},pn.lowerCase=vl,pn.lowerFirst=yl,pn.lt=Fs,pn.lte=Ls,pn.max=function(e){return e&&e.length?zn(e,Pl,Jn):o},pn.maxBy=function(e,t){return e&&e.length?zn(e,Oo(t,2),Jn):o},pn.mean=function(e){return cr(e,Pl)},pn.meanBy=function(e,t){return cr(e,Oo(t,2))},pn.min=function(e){return e&&e.length?zn(e,Pl,ci):o},pn.minBy=function(e,t){return e&&e.length?zn(e,Oo(t,2),ci):o},pn.stubArray=zl,pn.stubFalse=jl,pn.stubObject=function(){return{}},pn.stubString=function(){return""},pn.stubTrue=function(){return!0},pn.multiply=ql,pn.nth=function(e,t){return e&&e.length?mi(e,Bs(t)):o},pn.noConflict=function(){return Dt._===this&&(Dt._=ft),this},pn.noop=kl,pn.now=Ja,pn.pad=function(e,t,r){e=$s(e);var n=(t=Bs(t))?Rr(e):0;if(!t||n>=t)return e;var i=(t-n)/2;return vo(Lr(i),r)+e+vo(Fr(i),r)},pn.padEnd=function(e,t,r){e=$s(e);var n=(t=Bs(t))?Rr(e):0;return t&&n<t?e+vo(t-n,r):e},pn.padStart=function(e,t,r){e=$s(e);var n=(t=Bs(t))?Rr(e):0;return t&&n<t?vo(t-n,r)+e:e},pn.parseInt=function(e,t,r){return r||null==t?t=0:t&&(t=+t),Wr($s(e).replace(Oe,""),t||0)},pn.random=function(e,t,r){if(r&&"boolean"!=typeof r&&Wo(e,t,r)&&(t=r=o),r===o&&("boolean"==typeof t?(r=t,t=o):"boolean"==typeof e&&(r=e,e=o)),e===o&&t===o?(e=0,t=1):(e=Vs(e),t===o?(t=e,e=0):t=Vs(t)),e>t){var n=e;e=t,t=n}if(r||e%1||t%1){var i=qr();return $r(e+i*(t-e+Pt("1e-"+((i+"").length-1))),t)}return wi(e,t)},pn.reduce=function(e,t,r){var n=gs(e)?tr:dr,i=arguments.length<3;return n(e,Oo(t,4),r,i,Un)},pn.reduceRight=function(e,t,r){var n=gs(e)?rr:dr,i=arguments.length<3;return n(e,Oo(t,4),r,i,Vn)},pn.repeat=function(e,t,r){return t=(r?Wo(e,t,r):t===o)?1:Bs(t),xi($s(e),t)},pn.replace=function(){var e=arguments,t=$s(e[0]);return e.length<3?t:t.replace(e[1],e[2])},pn.result=function(e,t,r){var n=-1,i=(t=Gi(t,e)).length;for(i||(i=1,e=o);++n<i;){var a=null==e?o:e[ua(t[n])];a===o&&(n=i,a=r),e=Ss(a)?a.call(e):a}return e},pn.round=Xl,pn.runInContext=e,pn.sample=function(e){return(gs(e)?Sn:Si)(e)},pn.size=function(e){if(null==e)return 0;if(ys(e))return Ds(e)?Rr(e):e.length;var t=zo(e);return t==Y||t==re?e.size:li(e).length},pn.snakeCase=bl,pn.some=function(e,t,r){var n=gs(e)?nr:Ri;return r&&Wo(e,t,r)&&(t=o),n(e,Oo(t,3))},pn.sortedIndex=function(e,t){return Ii(e,t)},pn.sortedIndexBy=function(e,t,r){return Ni(e,t,Oo(r,2))},pn.sortedIndexOf=function(e,t){var r=null==e?0:e.length;if(r){var n=Ii(e,t);if(n<r&&ps(e[n],t))return n}return-1},pn.sortedLastIndex=function(e,t){return Ii(e,t,!0)},pn.sortedLastIndexBy=function(e,t,r){return Ni(e,t,Oo(r,2),!0)},pn.sortedLastIndexOf=function(e,t){if(null!=e&&e.length){var r=Ii(e,t,!0)-1;if(ps(e[r],t))return r}return-1},pn.startCase=wl,pn.startsWith=function(e,t,r){return e=$s(e),r=null==r?0:Dn(Bs(r),0,e.length),t=Oi(t),e.slice(r,r+t.length)==t},pn.subtract=Kl,pn.sum=function(e){return e&&e.length?fr(e,Pl):0},pn.sumBy=function(e,t){return e&&e.length?fr(e,Oo(t,2)):0},pn.template=function(e,t,r){var n=pn.templateSettings;r&&Wo(e,t,r)&&(t=o),e=$s(e),t=qs({},t,n,Mo);var i,a,s=qs({},t.imports,n.imports,Mo),l=nl(s),u=vr(s,l),c=0,h=t.interpolate||Ye,p="__p += '",d=tt((t.escape||Ye).source+"|"+h.source+"|"+(h===Ee?je:Ye).source+"|"+(t.evaluate||Ye).source+"|$","g"),f="//# sourceURL="+("sourceURL"in t?t.sourceURL:"lodash.templateSources["+ ++Mt+"]")+"\n";e.replace(d,function(t,r,n,o,s,l){return n||(n=o),p+=e.slice(c,l).replace(Ze,Sr),r&&(i=!0,p+="' +\n__e("+r+") +\n'"),s&&(a=!0,p+="';\n"+s+";\n__p += '"),n&&(p+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),c=l+t.length,t}),p+="';\n";var m=t.variable;m||(p="with (obj) {\n"+p+"\n}\n"),p=(a?p.replace(be,""):p).replace(we,"$1").replace(xe,"$1;"),p="function("+(m||"obj")+") {\n"+(m?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(i?", __e = _.escape":"")+(a?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+p+"return __p\n}";var g=Cl(function(){return Je(l,f+"return "+p).apply(o,u)});if(g.source=p,_s(g))throw g;return g},pn.times=function(e,t){if((e=Bs(e))<1||e>k)return[];var r=L,n=$r(e,L);t=Oo(t),e-=L;for(var i=mr(n,t);++r<e;)t(r);return i},pn.toFinite=Vs,pn.toInteger=Bs,pn.toLength=zs,pn.toLower=function(e){return $s(e).toLowerCase()},pn.toNumber=js,pn.toSafeInteger=function(e){return e?Dn(Bs(e),-k,k):0===e?e:0},pn.toString=$s,pn.toUpper=function(e){return $s(e).toUpperCase()},pn.trim=function(e,t,r){if((e=$s(e))&&(r||t===o))return e.replace(ke,"");if(!e||!(t=Oi(t)))return e;var n=Ir(e),i=Ir(t);return qi(n,br(n,i),wr(n,i)+1).join("")},pn.trimEnd=function(e,t,r){if((e=$s(e))&&(r||t===o))return e.replace(Fe,"");if(!e||!(t=Oi(t)))return e;var n=Ir(e);return qi(n,0,wr(n,Ir(t))+1).join("")},pn.trimStart=function(e,t,r){if((e=$s(e))&&(r||t===o))return e.replace(Oe,"");if(!e||!(t=Oi(t)))return e;var n=Ir(e);return qi(n,br(n,Ir(t))).join("")},pn.truncate=function(e,t){var r=A,n=E;if(Ts(t)){var i="separator"in t?t.separator:i;r="length"in t?Bs(t.length):r,n="omission"in t?Oi(t.omission):n}var a=(e=$s(e)).length;if(Cr(e)){var s=Ir(e);a=s.length}if(r>=a)return e;var l=r-Rr(n);if(l<1)return n;var u=s?qi(s,0,l).join(""):e.slice(0,l);if(i===o)return u+n;if(s&&(l+=u.length-l),Is(i)){if(e.slice(l).search(i)){var c,h=u;for(i.global||(i=tt(i.source,$s(He.exec(i))+"g")),i.lastIndex=0;c=i.exec(h);)var p=c.index;u=u.slice(0,p===o?l:p)}}else if(e.indexOf(Oi(i),l)!=l){var d=u.lastIndexOf(i);d>-1&&(u=u.slice(0,d))}return u+n},pn.unescape=function(e){return(e=$s(e))&&Ce.test(e)?e.replace(_e,Nr):e},pn.uniqueId=function(e){var t=++ct;return $s(e)+t},pn.upperCase=xl,pn.upperFirst=_l,pn.each=$a,pn.eachRight=Ga,pn.first=ya,Dl(pn,function(){var e={};return Wn(pn,function(t,r){ut.call(pn.prototype,r)||(e[r]=t)}),e}(),{chain:!1}),pn.VERSION="4.17.11",qt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){pn[e].placeholder=pn}),qt(["drop","take"],function(e,t){gn.prototype[e]=function(r){r=r===o?1:Hr(Bs(r),0);var n=this.__filtered__&&!t?new gn(this):this.clone();return n.__filtered__?n.__takeCount__=$r(r,n.__takeCount__):n.__views__.push({size:$r(r,L),type:e+(n.__dir__<0?"Right":"")}),n},gn.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}}),qt(["filter","map","takeWhile"],function(e,t){var r=t+1,n=r==I||3==r;gn.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:Oo(e,3),type:r}),t.__filtered__=t.__filtered__||n,t}}),qt(["head","last"],function(e,t){var r="take"+(t?"Right":"");gn.prototype[e]=function(){return this[r](1).value()[0]}}),qt(["initial","tail"],function(e,t){var r="drop"+(t?"":"Right");gn.prototype[e]=function(){return this.__filtered__?new gn(this):this[r](1)}}),gn.prototype.compact=function(){return this.filter(Pl)},gn.prototype.find=function(e){return this.filter(e).head()},gn.prototype.findLast=function(e){return this.reverse().find(e)},gn.prototype.invokeMap=_i(function(e,t){return"function"==typeof e?new gn(this):this.map(function(r){return ri(r,e,t)})}),gn.prototype.reject=function(e){return this.filter(ss(Oo(e)))},gn.prototype.slice=function(e,t){e=Bs(e);var r=this;return r.__filtered__&&(e>0||t<0)?new gn(r):(e<0?r=r.takeRight(-e):e&&(r=r.drop(e)),t!==o&&(r=(t=Bs(t))<0?r.dropRight(-t):r.take(t-e)),r)},gn.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},gn.prototype.toArray=function(){return this.take(L)},Wn(gn.prototype,function(e,t){var r=/^(?:filter|find|map|reject)|While$/.test(t),n=/^(?:head|last)$/.test(t),i=pn[n?"take"+("last"==t?"Right":""):t],a=n||/^find/.test(t);i&&(pn.prototype[t]=function(){var t=this.__wrapped__,s=n?[1]:arguments,l=t instanceof gn,u=s[0],c=l||gs(t),h=function(e){var t=i.apply(pn,er([e],s));return n&&p?t[0]:t};c&&r&&"function"==typeof u&&1!=u.length&&(l=c=!1);var p=this.__chain__,d=!!this.__actions__.length,f=a&&!p,m=l&&!d;if(!a&&c){t=m?t:new gn(this);var g=e.apply(t,s);return g.__actions__.push({func:Va,args:[h],thisArg:o}),new mn(g,p)}return f&&m?e.apply(this,s):(g=this.thru(h),f?n?g.value()[0]:g.value():g)})}),qt(["pop","push","shift","sort","splice","unshift"],function(e){var t=it[e],r=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",n=/^(?:pop|shift)$/.test(e);pn.prototype[e]=function(){var e=arguments;if(n&&!this.__chain__){var i=this.value();return t.apply(gs(i)?i:[],e)}return this[r](function(r){return t.apply(gs(r)?r:[],e)})}}),Wn(gn.prototype,function(e,t){var r=pn[t];if(r){var n=r.name+"";(rn[n]||(rn[n]=[])).push({name:t,func:r})}}),rn[po(o,y).name]=[{name:"wrapper",func:o}],gn.prototype.clone=function(){var e=new gn(this.__wrapped__);return e.__actions__=to(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=to(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=to(this.__views__),e},gn.prototype.reverse=function(){if(this.__filtered__){var e=new gn(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},gn.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,r=gs(e),n=t<0,i=r?e.length:0,o=function(e,t,r){for(var n=-1,i=r.length;++n<i;){var o=r[n],a=o.size;switch(o.type){case"drop":e+=a;break;case"dropRight":t-=a;break;case"take":t=$r(t,e+a);break;case"takeRight":e=Hr(e,t-a)}}return{start:e,end:t}}(0,i,this.__views__),a=o.start,s=o.end,l=s-a,u=n?s:a-1,c=this.__iteratees__,h=c.length,p=0,d=$r(l,this.__takeCount__);if(!r||!n&&i==l&&d==l)return Bi(e,this.__actions__);var f=[];e:for(;l--&&p<d;){for(var m=-1,g=e[u+=t];++m<h;){var v=c[m],y=v.iteratee,b=v.type,w=y(g);if(b==N)g=w;else if(!w){if(b==I)continue e;break e}}f[p++]=g}return f},pn.prototype.at=Ba,pn.prototype.chain=function(){return Ua(this)},pn.prototype.commit=function(){return new mn(this.value(),this.__chain__)},pn.prototype.next=function(){this.__values__===o&&(this.__values__=Us(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?o:this.__values__[this.__index__++]}},pn.prototype.plant=function(e){for(var t,r=this;r instanceof fn;){var n=ha(r);n.__index__=0,n.__values__=o,t?i.__wrapped__=n:t=n;var i=n;r=r.__wrapped__}return i.__wrapped__=e,t},pn.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof gn){var t=e;return this.__actions__.length&&(t=new gn(this)),(t=t.reverse()).__actions__.push({func:Va,args:[Ta],thisArg:o}),new mn(t,this.__chain__)}return this.thru(Ta)},pn.prototype.toJSON=pn.prototype.valueOf=pn.prototype.value=function(){return Bi(this.__wrapped__,this.__actions__)},pn.prototype.first=pn.prototype.head,Lt&&(pn.prototype[Lt]=function(){return this}),pn}();Dt._=Dr,(i=function(){return Dr}.call(t,r,t,n))===o||(n.exports=i)}).call(this)}).call(this,r("./node_modules/webpack/buildin/global.js"),r("./node_modules/webpack/buildin/module.js")(e))},"./node_modules/morpheus-app/js/morpheus-esm-latest.min.js":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(module,global,process){let morpheus;morpheus=function(){var morpheus=void 0!==morpheus?morpheus:{};module.exports?module.exports=morpheus:"function"==typeof define&&__webpack_require__("./node_modules/webpack/buildin/amd-options.js")?define(function(){return morpheus}):global.morpheus=morpheus,morpheus.Util=function(){},morpheus.Util.isNode=function(){return!1},morpheus.Util.RIGHT_ARROW=String.fromCharCode(8594),morpheus.Util.extend=function(e,t){for(var r in t.prototype)r in e.prototype||(e.prototype[r]=t.prototype[r])},morpheus.Util.isFetchStreamingSupported=function(){return"undefined"!=typeof navigator&&-1!==navigator.userAgent.indexOf("Chrome")},morpheus.Util.viewPortSize=function(){return window.getComputedStyle(document.body,":before").content.replace(/"/g,"")},morpheus.Util.TRACKING_ENABLED=!0,morpheus.Util.TRACKING_CODE_LOADED=!1,morpheus.Util.loadTrackingCode=function(){if(morpheus.Util.TRACKING_ENABLED&&"undefined"!=typeof window&&"undefined"!=typeof navigator&&navigator.onLine){if(morpheus.Util.TRACKING_CODE_LOADED)return;"undefined"==typeof ga&&(morpheus.Util.TRACKING_CODE_LOADED=!0,e=window,t=document,r="script","ga",e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,n=t.createElement(r),i=t.getElementsByTagName(r)[0],n.async=1,n.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(n,i)),"undefined"!=typeof ga&&(ga("create","UA-53973555-1","auto","morpheus"),ga("morpheus.send","pageview")),morpheus.Util.TRACKING_CODE_LOADED=!0}var e,t,r,n,i},morpheus.Util.measureScrollbar=function(){var e=$("<div style='position:absolute; top:-10000px; left:-10000px; width:100px; height:100px; overflow:scroll;'></div>").appendTo("body"),t={width:Math.max(0,e.width()-e[0].clientWidth),height:e.height()-e[0].clientHeight};return e.remove(),t},morpheus.Util.trackEvent=function(e){"undefined"!=typeof window&&(morpheus.Util.TRACKING_CODE_LOADED||morpheus.Util.loadTrackingCode(),morpheus.Util.TRACKING_CODE_LOADED&&"undefined"!=typeof ga&&ga("morpheus.send",{hitType:"event",eventCategory:e.eventCategory,eventAction:e.eventAction,eventLabel:e.eventLabel}))},morpheus.Util.isString=function(e){return"string"==typeof e||e instanceof String},morpheus.Util.getDataType=function(e){var t,r=morpheus.Util.isArray(e);return r&&e.length>0&&(e=e[0]),t=morpheus.Util.isString(e)?"string":_.isNumber(e)?"number":"object",r&&(t="["+t+"]"),t},morpheus.Util.isArray=function(e){for(var t=[Array,Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],r=0,n=t.length;r<n;r++)if(e instanceof t[r])return!0;return!1},morpheus.Util.getWindowSearchObject=function(){var e={},t={};return window.location.search.length>0&&(e=morpheus.Util.getQueryParams(window.location.search.substring(1))),window.location.hash.length>0&&(t=morpheus.Util.getQueryParams(window.location.hash.substring(1))),_.extend(t,e)},morpheus.Util.copyString=function(e){return(" "+e).substr(1)},morpheus.Util.getQueryParams=function(e){var t={};if(!e)return t;for(var r=decodeURIComponent(e).split("&"),n=0;n<r.length;n++){var i=r[n].split("=");if(null!=i[1]&&""!==i[1]){var o=t[i[0]];void 0===o&&(o=[],t[i[0]]=o),o.push(i[1])}}return t},morpheus.Util.getScriptPath=function(e){e||(e="morpheus-latest.min.js");for(var t=document.getElementsByTagName("script"),r=t.length-1;r>=0;r--){var n=t[r].src,i=n.lastIndexOf("/");if(-1!==i&&(n=n.substring(i+1)),n===e)return t[r].src}return"morpheus-latest.min.js"===e?morpheus.Util.getScriptPath("morpheus.js"):t.length>0?t[0].src:""},morpheus.Util.forceDelete=function(e){try{(t=URL.createObjectURL(new Blob([""],{type:"text/javascript"})),r=new Worker(t),URL.revokeObjectURL(t),r).postMessage(e,[e])}catch(e){console.log("Unable to delete")}var t,r},morpheus.Util.getFileName=function(e){if(morpheus.Util.isFile(e))return e.name;if(void 0!==e.name)return e.name;var t=""+e,r=t.indexOf("?");if(-1!==r)for(var n=t.substring(r+1),i=decodeURIComponent(n).split("&"),o=0;o<i.length;o++){var a=i[o].split("=");if("file"===a[0]||"name"===a[0]){t=a[1];break}}else{var s=t.lastIndexOf("/");s===t.length-1&&(s=(t=t.substring(0,t.length-1)).lastIndexOf("/")),-1!==s&&(t=t.substring(s+1))}return t},morpheus.Util.prefixWithZero=function(e){return e<10?"0"+e:e},morpheus.Util.detectSeparator=function(e){for(var t=["\t",","," "],r=t[0],n=e.replace(/\s+$/,""),i=0;i<t.length;i++){var o=t[i];if(n.split(new RegExp(o)).length>1){r=o;break}}return r},morpheus.Util.getExtension=function(e){var t=(e=""+e).lastIndexOf(".");if(t>0){var r=e.substring(t+1).toLowerCase();if("txt"===r||"gz"===r||"tsv"===r||"csv"===r){var n=e.substring(0,t),i=n.lastIndexOf(".");if(i>0){var o=n.substring(i+1,n.length).toLowerCase();if("segtab"===o||"seg"===o||"maf"===o||"gct"===o||"txt"===o||"gmt"===o)return o}}return r}return""},morpheus.Util.getBaseFileName=function(e){var t=e.lastIndexOf(".");if(t>0){var r=e.substring(t+1,e.length);return"gz"===r||"zip"===r||"bz2"===r?morpheus.Util.getBaseFileName(e.substring(0,t)):e.substring(0,t)}return e},morpheus.Util.seq=function(e){for(var t=[],r=0;r<e;r++)t.push(r);return t},morpheus.Util.sequ32=function(e){for(var t=new Uint32Array(e),r=0;r<e;r++)t[r]=r;return t},morpheus.Util.paramsToObject=function(e){var t=e?window.location.hash:window.location.search;if(t.length<=1)return{};for(var r=(t=decodeURIComponent(t)).substring(1).split("&"),n={},i=0,o=r.length;i<o;i++){var a=r[i].split("="),s=n[a[0]];void 0===s&&(s=[],n[a[0]]=s),s.push(a[1])}return n},morpheus.Util.isHeadless=function(){return void 0===$.ui},morpheus.Util.isFile=function(e){return"undefined"!=typeof File&&e instanceof File},morpheus.Util.endsWith=function(e,t){return e.length>=t.length&&e.substr(e.length-t.length)===t},morpheus.Util.measureSvgText=function(e,t){if(!e||0===e.length)return{height:0,width:0};var r=d3.select("body").append("svg");t&&r.attr("class",t),r.append("text").attr({x:-1e3,y:-1e3}).text(e);var n=r.node().getBBox();return r.remove(),{height:n.height,width:n.width}},morpheus.Util.IS_MAC=!1,"undefined"!=typeof navigator&&(morpheus.Util.IS_MAC=!!navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)),morpheus.Util.COMMAND_KEY=morpheus.Util.IS_MAC?"&#8984;":"Ctrl+",morpheus.Util.SHIFT_KEY=morpheus.Util.IS_MAC?"&#8679;":"Shift+",morpheus.Util.hammer=function(e,t){if("undefined"!=typeof Hammer){var r=new Hammer(e,{recognizers:[]});return-1!==_.indexOf(t,"pan")?r.add(new Hammer.Pan({threshold:1,direction:Hammer.DIRECTION_ALL})):-1!==_.indexOf(t,"panh")?r.add(new Hammer.Pan({threshold:1,direction:Hammer.DIRECTION_HORIZONTAL})):-1!==_.indexOf(t,"panv")&&r.add(new Hammer.Pan({threshold:1,direction:Hammer.DIRECTION_VERTICAL})),-1!==_.indexOf(t,"tap")&&r.add(new Hammer.Tap),-1!==_.indexOf(t,"pinch")&&r.add(new Hammer.Pinch),-1!==_.indexOf(t,"longpress")&&r.add(new Hammer.Press({event:"longpress",time:1e3})),-1!==_.indexOf(t,"press")&&r.add(new Hammer.Press),-1!==_.indexOf(t,"swipe")&&r.add(new Hammer.Swipe),r}return $()},morpheus.Util.createTextDecoder=function(){if("undefined"!=typeof TextDecoder){var e=new TextDecoder;return function(t,r,n){return e.decode(t.subarray(r,n))}}return function(e,t,r){for(var n=[],i=t;i<r;i++)n.push(String.fromCharCode(e[i]));return n.join("")}},morpheus.Util.autocompleteArrayMatcher=function(e,t,r,n,i){var o=new morpheus.Set,a=new RegExp(morpheus.Util.escapeRegex(e),"i"),s=new RegExp("("+morpheus.Util.escapeRegex(e)+")","i");if(n)for(var l=n.length,u=0,c=r.length;u<c;u++){for(var h=r[u],p=0;p<l;p++){var d=h[n[p]];if(a.test(d)){o.add(d);break}}if(o.size()===i)break}else for(u=0,c=r.length;u<c&&(d=r[u],!a.test(d)||(o.add(d),o.size()!==i));u++);var f=[];o.forEach(function(e){var t=e;-1!==t.indexOf(" ")&&(t='"'+t+'"'),f.push({value:t,label:"<span>"+e.replace(s,"<b>$1</b>")+"</span>"})}),t(f)},morpheus.Util.setClipboardData=function(e,t){var r="rtl"==document.documentElement.getAttribute("dir"),n=document.createElement("div");n.contentEditable=!0,n.style.fontSize="12pt",n.style.border="0",n.style.padding="0",n.style.margin="0",n.style.position="absolute",n.style[r?"right":"left"]="-999999px",n.style.top=(window.pageYOffset||document.documentElement.scrollTop)+"px",n.setAttribute("readonly","");var i=function(t){e.forEach(function(e){t.clipboardData.setData(e.format,e.data)}),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),n.removeEventListener("copy",i)};n.addEventListener("copy",i),document.body.appendChild(n),n.focus();var o=window.getSelection(),a=document.createRange();a.selectNodeContents(n),o.removeAllRanges(),o.addRange(a),t?setTimeout(function(){document.execCommand("copy")||console.log("copy failed"),document.body.removeChild(n)},20):(document.execCommand("copy")||console.log("copy failed"),document.body.removeChild(n))},morpheus.Util.autosuggest=function(e){var t=!1;function r(r,n,i){if(n.item.skip)return!1;if(e.multi){var o=morpheus.Util.getAutocompleteTokens(e.$el[0].value,{trim:!1,selectionStart:e.$el[0].selectionStart}),a=r.toElement&&r.toElement.dataset?r.toElement.dataset.autocomplete:null,s=a?n.item[a]:n.item.value,l=n.item.show;return 0===o.length?o.push(s):n.item.clear?o=[s]:o[-1===o.selectionStartIndex||void 0===o.selectionStartIndex?o.length-1:o.selectionStartIndex]=s,e.$el[0].value=o.join(" "),(l&&!i||i&&13===r.which)&&(t=!0,setTimeout(function(){e.$el.autocomplete("search",e.$el.val())},20),setTimeout(function(){t=!1},100)),!i&&e.select&&e.select(),!1}!i&&e.select&&e.select(),i||13!==r.which||r.stopImmediatePropagation()}(e=$.extend({},{multi:!0,delay:500,minLength:0,suggestWhenEmpty:!0},e)).$el.on("keydown",function(e){e.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&e.preventDefault()}).autocomplete({minLength:e.minLength,delay:e.delay,source:function(t,r){if(t.term.history&&e.history)return e.history(r);var n=morpheus.Util.getAutocompleteTokens(t.term,{trim:!1,selectionStart:e.$el[0].selectionStart});void 0!==n.selectionStartIndex&&-1!==n.selectionStartIndex||(n.selectionStartIndex=n.length-1),(e.suggestWhenEmpty||n.length>0)&&e.filter(n,r)},focus:function(e,t){for(var n=e.originalEvent;null!=n.originalEvent;)n=n.originalEvent;return!(!n||!/^key/.test(n.type))&&r(n,t,!0)},select:function(e,t){return r(e,t,!1)}});var n=e.$el.autocomplete("instance");null!=n&&(n._renderItem=function(e,t){return null==t.value?$('<li class="'+(t.class?" "+t.class:"")+' search-category">').append($("<div>").html(t.label)).appendTo(e):$('<li class="'+(t.class?" "+t.class:"")+' search-item">').append($("<div>").html(t.label)).appendTo(e)},n._normalize=function(e){return e},n._resizeMenu=function(){this.menu.element.outerWidth(n.element.outerWidth())});var i=e.$el.autocomplete("widget");i.menu("option","items","> :not(.search-category)"),i&&i.addClass("search-menu"),e.suggestWhenEmpty&&e.$el.on("focus",function(){e.$el.autocomplete("search",e.$el.val())}),e.$el.on("keyup",function(r){13!==r.which||t?38===r.which&&e.history?e.$el.autocomplete("search",{history:!0}):e.suggestWhenEmpty&&""===e.$el.val()&&e.$el.autocomplete("search",""):e.$el.autocomplete("close")})},morpheus.Util.getAutocompleteTokens=function(e,t){if((t=$.extend({},{trim:!0},t)).trim&&(e=$.trim(e)),""===e)return[];for(var r=!1,n=!1,i=[],o=[],a=0,s=e.length;a<s;a++){var l=e[a];'"'===l?(r=!r,o.push(l)):"("===l||")"===l?(n="("===l,o.push(l)):" "!==l&&"\t"!==l||r||n?o.push(l):(i.push({s:o.join(""),inSelectionStart:o.inSelectionStart}),o=[]),a===t.selectionStart-1&&(o.inSelectionStart=!0)}i.push({s:o.join(""),inSelectionStart:o.inSelectionStart}),t.trim||r||" "!==e[e.length-1]||i.push({s:" ",inSelectionStart:!1});for(var u=[],c=-1,h=(a=0,i.length);a<h;a++){var p=i[a],d=p.s;(t.trim||a<h-1)&&(d=$.trim(d)),""!==d&&(p.inSelectionStart&&(c=u.length),u.push(d))}return u.selectionStartIndex=c,u},morpheus.Util.showDialog=function(e,t,r){var n=$("<div></div>");e.appendTo(n),n.appendTo($(document.body)),r||(r={}),n.dialog({width:670,height:590,title:t,close:function(e,t){n.remove(),r.close&&r.close()}})},morpheus.Util.sheetToArray=function(e,t){for(var r=XLSX.utils.decode_range(e["!ref"]),n=[],i=[],o=[],a=r.s.c;a<=r.e.c;++a){var s=e[XLSX.utils.encode_cell({c:a,r:r.s.r})],l=String(XLSX.utils.format_cell(s));o.push(l)}for(var u=r.s.r;u<=r.e.r;++u){var c=[],h=!0;for(a=r.s.c;a<=r.e.c;++a)if(s=e[XLSX.utils.encode_cell({c:a,r:u})]){if(h=!1,l=String(XLSX.utils.format_cell(s)),null!=s.s&&null!=s.s.fgColor){var p="#"+s.s.fgColor.rgb;i.push({header:o[c.length],color:p,value:l})}c.push(l)}else c.push("");h||n.push(t?c.join(t):c)}return n.colors=i,n},morpheus.Util.linesToObjects=function(e){for(var t=e[0],r=[],n=t.length,i=1,o=e.length;i<o;i++){for(var a=e[i],s={},l=0;l<n;l++){var u=a[l];s[t[l]]=u}r.push(s)}return r},morpheus.Util.xlsxTo2dArray=function(e,t){var r=XLSX.read(e.data,{type:"binary",cellFormula:!1,cellHTML:!1,cellStyles:!0}),n=r.SheetNames;if(e.prompt&&n.length>1){var i=new morpheus.FormBuilder;i.append({name:"sheet",type:"bootstrap-select",options:n,required:!0,style:"max-width:100px;"}),morpheus.FormBuilder.showInModal({title:"Choose Sheet",html:i.$form,focus:document.activeElement,onClose:function(){var e=r.Sheets[i.getValue("sheet")],n=morpheus.Util.sheetToArray(e);t(null,n)}})}else{var o=r.Sheets[n[0]],a=morpheus.Util.sheetToArray(o);t(null,a)}},morpheus.Util.xlsxTo1dArray=function(e,t){var r=XLSX.read(e.data,{type:"binary",cellFormula:!1,cellHTML:!1,cellStyles:!0}),n=r.SheetNames;if(e.prompt&&n.length>1){var i=new morpheus.FormBuilder;i.append({name:"sheet",type:"bootstrap-select",options:n,required:!0,style:"max-width:100px;"}),morpheus.FormBuilder.showOkCancel({title:"Choose Sheet",cancel:!1,focus:document.activeElement,content:i.$form,okCallback:function(){var e=r.Sheets[i.getValue("sheet")];t(null,morpheus.Util.sheetToArray(e,"\t"))}})}else{var o=r.Sheets[n[0]];t(null,morpheus.Util.sheetToArray(o,"\t"))}},morpheus.Util.getText=function(e){return new Promise(function(t,r){if(morpheus.Util.isString(e))fetch(e).then(function(e){if(e.ok)return e.text();r(e.status+" "+e.statusText)}).then(function(e){t(e)}).catch(function(e){r(e)});else if(morpheus.Util.isFile(e)){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsText(e)}else t(e)})},morpheus.Util.createOptions=function(e,t){var r=[];return t&&r.push('<option value="">(None)</option>'),_.each(e,function(e){r.push('<option value="'),r.push(e),r.push('">'),r.push(e),r.push("</option>")}),r.join("")},morpheus.Util.rankIndexArray=function(e){for(var t=[],r=e.length,n=0;n<r;n++)t[e[n]]=n+1;return t},morpheus.Util.indexSort=function(e,t){for(var r=[],n=0,i=e.length;n<i;n++)r.push({value:e[n],index:n});return morpheus.Util.indexSortPairs(r,t)},morpheus.Util.indexSortPairs=function(e,t){t?e.sort(function(e,t){return e.value<t.value?-1:e.value===t.value&&e.index<t.index?-1:1}):e.sort(function(e,t){return e.value<t.value?1:e.value===t.value&&e.index<t.index?1:-1});var r=[];return e.forEach(function(e){r.push(e.index)}),r},morpheus.Util.arrayEquals=function(e,t,r){if(e==t)return!0;if(null==e||null==t)return!1;r||(r=function(e,t){return e===t});var n=e.length;if(t.length!==n)return!1;for(var i=0;i<n;i++)if(!r(e[i],t[i]))return!1;return!0},morpheus.Util._intFormat="undefined"!=typeof d3?d3.format(",i"):function(e){return""+Math.round(e)},morpheus.Util.intFormat=function(e){return morpheus.Util._intFormat(e)},morpheus.Util._nf="undefined"!=typeof d3?d3.format(".2f"):function(e){return""+e},morpheus.Util.getNumberFormatPatternFractionDigits=function(e){return parseInt(e.substring(1,e.length-1))||0},morpheus.Util.nf=function(e){return morpheus.Util._nf(e)},morpheus.Util.createNumberFormat=function(e){var t=d3.format(e);return t.toJSON=function(){return{pattern:e}},t},morpheus.Util.wrapNumber=function(e,t){var r=new Number(e);return r.toObject=function(){return t},r},morpheus.Util.toString=function(e){return null==e?"":_.isNumber(e)?morpheus.Util.nf(e):morpheus.Util.isArray(e)?morpheus.Util.arrayToString(e,", "):""+e},morpheus.Util.arrayToString=function(e,t){for(var r=[],n=0,i=e.length;n<i;n++){var o=e[n];_.isNumber(o)?r.push(morpheus.Util.nf(o)):r.push(""+o)}return r.join(t)},morpheus.Util.removeTrailingZerosInFraction=function(e){var t=e.lastIndexOf(".");if(-1!==t){for(var r=e.length,n=r,i=r-1;i>t&&"0"==e[i];i--,n--);if(n===t+1)return e.substring(0,t);if(n<r)return e.substring(0,t)+e.substring(t,n)}return e},morpheus.Util.s=function(e){return 1===e?"":"s"},morpheus.Util.create2dArray=function(e,t){for(var r=[],n=0;n<e;n++){for(var i=[],o=0;o<t;o++)i[o]=NaN;r.push(i)}return r},morpheus.Util.escapeRegex=function(e){return e.replace(/[*]/g,".*").replace(/[-[\]{}()+?,\\^$|#\s]/g,"\\$&")},morpheus.Util.createSearchPredicates=function(e){var t=(e=$.extend({},{validateFieldNames:!0,caseSensitive:!0},e)).tokens;if(null==t)return[];var r=e.fields;if(!e.caseSensitive&&null!=r)for(var n=0;n<r.length;n++)r[n]=r[n].toLowerCase();var i=e.validateFieldNames,o=!i||null!=r&&r.length>0,a=/\\:/g,s=[],l="exact"===e.defaultMatchMode;return t.forEach(function(t){var n=!1;"-"===t[0]&&(t=t.substring(1),n=!0);var u,c=null,h=t.indexOf(":");if(h>0)if(o&&92!==t.charCodeAt(h-1)){var p=$.trim(t.substring(h+1)),d=$.trim(t.substring(0,h));d.length>0&&'"'===d[0]&&'"'===d[d.length-1]?d=d.substring(1,d.length-1):d.length>0&&'"'===d[0]&&'"'===p[p.length-1]&&'"'!==p[0]&&(d=d.substring(1,d.length),p='"'+p),i&&-1===r.indexOf(e.caseSensitive?d:d.toLowerCase())||(t=p,c=d)}else t=t.replace(a,":");for(var f=-1,m=null,g=["..",">=",">","<=","<","="],v=0;v<g.length;v++)if(-1!==(f=t.indexOf(g[v]))){m=g[v];break}if(-1!==f)if(".."===m){var y=parseFloat(t.substring(0,f)),b=parseFloat(t.substring(f+2));isNaN(y)||isNaN(b)||(u=new morpheus.Util.NumberRangePredicate(c,y,b))}else if(">"===m){var w=parseFloat(t.substring(f+1));isNaN(w)||(u=new morpheus.Util.GreaterThanPredicate(c,w))}else">="===m?(w=parseFloat(t.substring(f+2)),isNaN(w)||(u=new morpheus.Util.GreaterThanOrEqualPredicate(c,w))):"<"===m?(w=parseFloat(t.substring(f+1)),isNaN(w)||(u=new morpheus.Util.LessThanPredicate(c,w))):"<="===m?(w=parseFloat(t.substring(f+2)),isNaN(w)||(u=new morpheus.Util.LessThanOrEqualPredicate(c,w))):"="===m?(w=parseFloat(t.substring(f+1)),u=new morpheus.Util.EqualsPredicate(c,w)):console.log("Unknown range token:"+m);else if('"'===t[0]&&'"'===t[t.length-1])t=t.substring(1,t.length-1),u=new morpheus.Util.ExactTermPredicate(c,t);else if("("===t[0]&&")"===t[t.length-1]){t=t.substring(1,t.length-1);var x=morpheus.Util.getAutocompleteTokens(t);x.length>0&&(u=new morpheus.Util.ExactTermsPredicate(c,x.map(function(e){return'"'===e[0]&&'"'===e[e.length-1]&&(e=e.substring(1,e.length-1)),e.toLowerCase()})))}else u=-1!==t.indexOf("*")?new morpheus.Util.RegexPredicate(c,t):l?new morpheus.Util.ExactTermPredicate(c,t):new morpheus.Util.RegexPredicate(c,t);null!=u&&s.push(n?new morpheus.Util.NotPredicate(u):u)}),s},morpheus.Util.createRegExpStringToMatchText=function(e){var t=morpheus.Util.getAutocompleteTokens(e);if(0===t.length)return null;var r=[];return _.each(t,function(e){'"'===e[0]&&'"'===e[e.length-1]?(e=e.substring(1,e.length-1),r.push("^"+morpheus.Util.escapeRegex(e)+"$")):r.push(morpheus.Util.escapeRegex(e))}),"("+r.join("|")+")"},morpheus.Util.createRegExpToMatchText=function(e){var t=morpheus.Util.createRegExpStringToMatchText(e);return null==t?null:new RegExp(t,"i")},morpheus.Util.reorderArray=function(e,t){for(var r=[],n=0;n<t.length;n++)r.push(e[t[n]]);return r},morpheus.Util.getSearchString=function(){var e=window.location.search;return e.length>1?e.substring(1):""},morpheus.Util.splitLines=function(e){for(var t=/\t/,r=[],n=0,i=e.length;n<i;n++){var o=e[n];""!==o&&r.push(o.split(t))}return r},morpheus.Util.readLines=function(e,t){return new Promise(function(r,n){var i=morpheus.Util.isFile(e),o=morpheus.Util.isString(e),a=morpheus.Util.getFileName(e),s=morpheus.Util.getExtension(a);if(o)if("xlsx"===s){var l={};if(e.headers)for(var u in l.headers=new Headers,e.headers)l.headers.append(u,e.headers[u]);fetch(e,l).then(function(e){if(e.ok)return e.arrayBuffer();deferred.reject(e)}).then(function(e){if(e){for(var r=new Uint8Array(e),n=[],i=0;i!=r.length;++i)n[i]=String.fromCharCode(r[i]);var o=n.join("");morpheus.Util.xlsxTo1dArray({data:o,prompt:t},function(e,t){deferred.resolve(t)})}else deferred.reject()})}else fetch(e,l).then(function(e){if(e.ok)return e.text();n()}).then(function(e){r(morpheus.Util.splitOnNewLine(e))}).catch(function(e){n(e)});else if(i){var c=new FileReader;c.onerror=function(){console.log("Unable to read file"),n("Unable to read file")},c.onload=function(e){var n=e.target.result,i=new Uint8Array(n);if("xlsx"===s||"xls"===s){for(var o=[],a=0;a!=i.length;++a)o[a]=String.fromCharCode(i[a]);var l=o.join("");morpheus.Util.xlsxTo1dArray({data:l,prompt:t},function(e,t){r(t)})}else{for(var u,c=new morpheus.ArrayBufferReader(i),h=[],p=/\s+$/;null!==(u=c.readLine());){var d=u.replace(p,"");""!==d&&h.push(d)}r(h)}},c.readAsArrayBuffer(e)}else r(e)})},morpheus.Util.createValueToIndices=function(e,t){var r=new morpheus.Map;return _.each(e,function(e){var n=e[t],i=r.get(n);void 0===i&&(i=[],r.set(n,i)),i.push(e)}),r},morpheus.Util.createMorpheusHeader=function(){var e=[];e.push('<div style="display:inline-block; vertical-align:top;font-size:24px;font-family:sans-serif;">'),e.push("<span>M</span>"),e.push("<span>O</span>"),e.push("<span>R</span>"),e.push("<span>P</span>"),e.push("<span>H</span>"),e.push("<span>E</span>"),e.push("<span>U</span>"),e.push("<span>S</span>"),e.push("</span>"),e.push("</div>");var t=$(e.join("")),r=d3.scale.linear().domain([0,4,7]).range(["#ca0020","#999999","#0571b0"]).clamp(!0),n=t.find("span"),i=0,o=function(){n[i].style.color=r(i),++i<n.length&&setTimeout(o,200)};return setTimeout(o,500),t},morpheus.Util.createLoadingEl=function(){return $('<div style="overflow:hidden;text-align:center;"><i class="fa fa-spinner fa-spin fa-3x"></i><span style="padding-left:4px;vertical-align:middle;font-weight:bold;">Loading...</span></div>')},morpheus.Util.splitOnNewLine=function(e,t){var r=void 0!==t?t.charCodeAt(0):void 0,n=e.split(/\n/);if(1===n.length){var i=e.split(/\r/);i.length>1&&(n=i)}for(var o=[],a=/\s+$/,s=0,l=n.length;s<l;s++){var u=n[s].replace(a,"");""!==u&&(void 0!==r?u.charCodeAt(0)!==r&&o.push(u):o.push(u))}return o},morpheus.Util.ContainsPredicate=function(e,t){this.field=e,t=t.toLowerCase(),this.text=t},morpheus.Util.ContainsPredicate.prototype={accept:function(e){return null!=e&&-1!==(e=(""+e).toLowerCase()).indexOf(this.text)},getField:function(){return this.field},getText:function(){return this.text},isNumber:function(){return!1},toString:function(){return"ContainsPredicate "+this.field+":"+this.text}},morpheus.Util.ExactTermsPredicate=function(e,t){this.field=e,this.values=new morpheus.Set;for(var r=0,n=t.length;r<n;r++)this.values.add(t[r])},morpheus.Util.ExactTermsPredicate.prototype={accept:function(e){return null!=e&&(e=(""+e).toLowerCase(),this.values.has(e))},getField:function(){return this.field},getValues:function(){return this.values},isNumber:function(){return!1},toString:function(){return"ExactTermsPredicate "+this.field+":"+this.text}},morpheus.Util.ExactTermPredicate=function(e,t){this.field=e,t=t.toLowerCase(),this.text=t},morpheus.Util.ExactTermPredicate.prototype={accept:function(e){return null!=e&&(e=(""+e).toLowerCase())===this.text},getField:function(){return this.field},getText:function(){return this.text},isNumber:function(){return!1},toString:function(){return"ExactTermPredicate "+this.field+":"+this.text}},morpheus.Util.RegexPredicate=function(e,t){this.field=e,this.text=t,this.regex=new RegExp(morpheus.Util.escapeRegex(t),"i")},morpheus.Util.RegexPredicate.prototype={accept:function(e){return this.regex.test(""+e)},getField:function(){return this.field},getText:function(){return this.text},isNumber:function(){return!1},toString:function(){return"RegexPredicate "+this.field+":"+this.regex}},morpheus.Util.NumberRangePredicate=function(e,t,r){this.field=e,this.min=t,this.max=r},morpheus.Util.NumberRangePredicate.prototype={accept:function(e){return e>=this.min&&e<=this.max},getField:function(){return this.field},isNumber:function(){return!0},toString:function(){return"NumberRangePredicate "+this.field+":"+this.min+"..."+this.max}},morpheus.Util.GreaterThanPredicate=function(e,t){this.field=e,this.val=t},morpheus.Util.GreaterThanPredicate.prototype={accept:function(e){return e>this.val},getField:function(){return this.field},isNumber:function(){return!0}},morpheus.Util.GreaterThanOrEqualPredicate=function(e,t){this.field=e,this.val=t},morpheus.Util.GreaterThanOrEqualPredicate.prototype={accept:function(e){return e>=this.val},getField:function(){return this.field},isNumber:function(){return!0}},morpheus.Util.LessThanPredicate=function(e,t){this.field=e,this.val=t},morpheus.Util.LessThanPredicate.prototype={accept:function(e){return e<this.val},getField:function(){return this.field},isNumber:function(){return!0}},morpheus.Util.LessThanOrEqualPredicate=function(e,t){this.field=e,this.val=t},morpheus.Util.LessThanOrEqualPredicate.prototype={accept:function(e){return e<=this.val},getField:function(){return this.field},isNumber:function(){return!0}},morpheus.Util.EqualsPredicate=function(e,t){this.field=e,this.val=t},morpheus.Util.EqualsPredicate.prototype={accept:function(e){return e===this.val},getField:function(){return this.field},isNumber:function(){return!0}},morpheus.Util.NotPredicate=function(e){this.p=e},morpheus.Util.NotPredicate.prototype={accept:function(e){return!this.p.accept(e)},getField:function(){return this.p.getField()},isNumber:function(){return this.p.isNumber()},toString:function(){return"NotPredicate "+this.p}},morpheus.Events=function(){},morpheus.Events.prototype={on:function(e,t){if(!t)throw Error("Handler not specified");this.eventListeners||(this.eventListeners={});var r,n,i,o,a=e.split(" "),s=a.length;for(r=0;r<s;r++)i=(n=a[r].split("."))[0],o=n[1]||"",this.eventListeners[i]||(this.eventListeners[i]=[]),this.eventListeners[i].push({name:o,handler:t});return this},getListeners:function(){return this.eventListeners||(this.eventListeners={}),this.eventListeners},setListeners:function(e){this.eventListeners=e},trigger:function(e,t){this.eventListeners||(this.eventListeners={}),t||(t={}),t.type=e,t.source||(t.source=this);var r=this.eventListeners[e];if(r)for(var n=r.length,i=0;i<n;i++)r[i].handler.apply(this,[t]);return this},off:function(e,t){this.eventListeners||(this.eventListeners={});var r,n,i,o,a,s=(e||"").split(" "),l=s.length;if(!e)for(n in this.eventListeners)this._off(n,null,t);for(r=0;r<l;r++)if(o=(i=s[r].split("."))[0],a=i[1],o)this.eventListeners[o]&&this._off(o,a,t);else for(n in this.eventListeners)this._off(n,a,t);return this},_off:function(e,t,r){var n,i,o=this.eventListeners[e];for(n=0;n<o.length;n++)if(i=o[n].name,!(t&&i!==t||null!=r&&r!=o[n].handler)){if(o.splice(n,1),0===o.length){delete this.eventListeners[e];break}n--}}},morpheus.Identifier=function(e){this.array=e},morpheus.Identifier.prototype={toString:function(){return this.array.join(",")},equals:function(e){var t=e.getArray(),r=this.array.length;if(t.length!==r)return!1;for(var n=0;n<r;n++)if(this.array[n]!==t[n])return!1;return!0},getArray:function(){return this.array}},morpheus.Map=function(){this.map={},this.n=0},morpheus.Map.prototype={toJSON:function(){var e={};return this.forEach(function(t,r){e[r]=t}),e},toString:function(){var e=[];return this.forEach(function(t,r){e.length>0&&e.push(", "),e.push(r),e.push("="),e.push(t)}),e.join("")},keys:function(){var e=[];for(var t in this.map){var r=this.map[t];e.push(r.key)}return e},size:function(){return this.n},equals:function(e){if(e.size()!==this.size())return!1;var t=!0;try{this.forEach(function(r,n){if(r!==e.get(n))throw t=!1,"break"})}catch(e){}return t},setAll:function(e){var t=this;e.forEach(function(e,r){t.set(r,e)})},set:function(e,t){var r="\0"+e;void 0===this.map[r]&&this.n++,this.map[r]={key:e,value:t}},forEach:function(e){for(var t in this.map){var r=this.map[t];e(r.value,r.key)}},entries:function(){var e=[];return this.forEach(function(t,r){e.push({value:t,key:r})}),e},values:function(){var e=[];for(var t in this.map){var r=this.map[t];e.push(r.value)}return e},get:function(e){var t="\0"+e,r=this.map[t];return void 0!==r?r.value:void 0},clear:function(){this.map={},this.n=0},remove:function(e){var t="\0"+e,r=this.map[t];if(void 0!==r)return delete this.map[t],this.n--,r.value},has:function(e){var t="\0"+e;return void 0!==this.map[t]}},morpheus.Map.fromJSON=function(e){var t=new morpheus.Map;for(var r in e)t.set(r,e[r]);return t},morpheus.Set=function(){this._map=new morpheus.Map},morpheus.Set.prototype={toJSON:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},toString:function(){var e=[];return this.forEach(function(t){e.length>0&&e.push(", "),e.push(t)}),e.join("")},size:function(){return this._map.size()},equals:function(e){return this._map.equals(e)},forEach:function(e){this._map.forEach(function(t,r){e(r)})},add:function(e){this._map.set(e,!0)},values:function(){var e=[];return this._map.forEach(function(t,r){e.push(r)}),e},clear:function(){this._map.clear()},remove:function(e){this._map.remove(e)},has:function(e){return this._map.has(e)}},morpheus.Set.fromJSON=function(e){for(var t=new morpheus.Set,r=0,n=e.length;r<n;r++)t.add(e[r]);return t},morpheus.ArrayBufferReader=function(e){this.buffer=e,this.bufferLength=e.length,this.index=0,this.decoder=morpheus.Util.createTextDecoder()},morpheus.ArrayBufferReader.prototype={reset:function(){this.index=0},readLine:function(){var e=this.index,t=this.bufferLength;if(e>=t)return null;for(var r=this.buffer,n=e,i=n;e<t;e++){var o=r[e];if(10===o||13===o){i=e,e!==t-1&&10===r[e+1]&&e++,e++;break}}return this.index=e,n===i&&e===t?this.decoder(this.buffer,n,t):this.decoder(this.buffer,n,i)}},morpheus.ArrayBufferReader.getArrayBuffer=function(e,t){if("string"==typeof e||e instanceof String){var r={};if(e.headers)for(var n in r.headers=new Headers,e.headers)r.headers.append(n,e.headers[n]);fetch(e,r).then(function(r){if(r.ok)return r.arrayBuffer();t(new Error(e+" status: "+r.status))}).then(function(e){t(null,e)}).catch(function(e){console.log("Fetch error",e),t(e)})}else{var i=new FileReader;i.onload=function(e){t(null,e.target.result)},i.onerror=function(e){t(e)},i.readAsArrayBuffer(e)}},morpheus.Array2dReaderInteractive=function(){},morpheus.Array2dReaderInteractive.prototype={_getReader:function(e,t){var r=morpheus.Util.getFileName(e),n=morpheus.Util.getExtension(r);morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,r){if(e)return console.log(e),t(e);var i=new Uint8Array(r);if("xls"===n||"xlsx"===n){for(var o=[],a=0;a!=i.length;++a)o[a]=String.fromCharCode(i[a]);var s=o.join("");morpheus.Util.xlsxTo1dArray({data:s,prompt:!0},function(e,r){t(e,new morpheus.LineReader(r))})}else t(null,new morpheus.ArrayBufferReader(i))})},read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e)),i=[];i.push("<div>"),i.push("<label>Click the table cell containing the first data row and column.</label><br />"),i.push('<div style="display:inline-block;width:10px;height:10px;background-color:#b3cde3;"></div><span> Data Matrix</span>'),i.push('<br /><div style="display:inline-block;width:10px;height:10px;background-color:#fbb4ae;"></div><span> Column Annotations</span>'),i.push('<br /><div style="display:inline-block; width:10px;height:10px;background-color:#ccebc5;"></div><span> Row Annotations</span>'),i.push('<div class="slick-bordered-table" style="width:550px;height:300px;"></div>'),i.push("</div>");var o=$(i.join(""));this._getReader(e,function(e,i){if(e)return console.log(e),t(e);for(var a,s=[],l=/\t/,u=i.readLine(),c=["\t",","," "],h=0;h<c.length;h++){var p=c[h],d=u.split(new RegExp(p));if(d.length>1){l=p,s.push(d);break}}for(;null!==(a=i.readLine())&&s.length<100;)s.push(a.split(l));if("#1.3"===s[0][0])return i.reset(),void t(null,(new morpheus.GctReader)._read(n,i));for(var f=[],m=0,g=s[0].length;m<g;m++)f.push({id:m,field:m});var v,y,b=1,w=1,x=s,S=new Slick.Grid(o.find(".slick-bordered-table")[0],s,f,{enableCellNavigation:!0,headerRowHeight:0,showHeaderRow:!1,multiColumnSort:!1,multiSelect:!1,topPanelHeight:0,enableColumnReorder:!1,enableTextSelectionOnCells:!0,forceFitColumns:!1,defaultFormatter:function(e,t,r,n,i){var o="white";t>=w&&e>=b?o="#b3cde3":e<=b-1&&t>=w?o="#fbb4ae":t<w&&e>=b&&(o="#ccebc5");var a=['<div style="width:100%;height:100%;background-color:'+o+'">'];if(_.isNumber(r))a.push(morpheus.Util.nf(r));else if(morpheus.Util.isArray(r)){for(var s=[],l=0,u=r.length;l<u;l++)l>0&&s.push(", "),r[l],s.push(r[l]);a.push(s.join(""))}else a.push(r);return a.push("</div>"),a.join("")}});o.find("[name=transpose]").on("click",function(e){if($(this).prop("checked")){if(null==v){v=[];for(var t=0,r=s[0].length;t<r;t++){var n=[];v.push(n);for(var i=0,o=s.length;i<o;i++)n.push(s[i][t])}for(y=[],t=0,r=v[0].length;t<r;t++)y.push({id:t,field:t})}s=v,S.setData(v),S.setColumns(y),S.resizeCanvas(),S.invalidate()}else S.setData(x),S.setColumns(f),S.resizeCanvas(),S.invalidate(),s=x}),S.onClick.subscribe(function(e,t){b=t.row,w=t.cell,S.invalidate()}),o.find(".slick-header").remove();var C=[];C.push('<button name="ok" type="button" class="btn btn-default">OK</button>'),C.push('<button name="cancel" type="button" data-dismiss="modal" class="btn btn-default">Cancel</button>'),$(C.join("")),morpheus.FormBuilder.showOkCancel({title:"Open",content:o,close:!1,focus:document.activeElement,cancelCallback:function(){t(new Error("Cancel"),null)},okCallback:function(){i.reset(),r._read(n,i,w,b,l,t)}}),S.resizeCanvas()})},_read:function(e,t,r,n,i,o){o(null,new morpheus.TxtReader({separator:i,columnMetadata:!0,dataRowStart:n,dataColumnStart:r})._read(e,t))}},morpheus.BufferedReader=function(e,t,r){var n=morpheus.Util.createTextDecoder(),i=!1,o="";e.read().then(function a(s){for(var l=0,u=0,c=(o+=s.done?"":n(s.value,0,s.value.length)).length;u<c;u++){var h=o[u];if(i&&"\n"===h)l++,i=!1;else if("\n"===h||"\r"===h){i="\r"===h;var p=morpheus.Util.copyString(o.substring(l,u));t(p),l=u+1}else i=!1}if(o=l<o.length?o.substring(l):"",!s.done)return e.read().then(a);""!==o&&"\r"!==o&&t(o),r()})},morpheus.BufferedReader.parse=function(e,t){var r=t.delimiter,n=new RegExp(r),i=t.handleTokens,o=t.complete,a={};if(e.headers)for(var s in a.headers=new Headers,e.headers)a.headers.append(s,e.headers[s]);fetch(e,a).then(function(e){if(e.ok){var r=e.body.getReader();new morpheus.BufferedReader(r,function(e){i(e.split(n))},function(){o()})}else t.error("Network error")}).catch(function(e){t.error(e)})},morpheus.ClsReader=function(){},morpheus.ClsReader.prototype={read:function(e){var t=/[ ,]+/,r=e[0].split(t);if(r.length<3)throw new Error("Header line needs three numbers");var n=[];try{for(var i=0;i<3;i++)n[i]=parseInt($.trim(r[i]))}catch(e){throw new Error("Header line element "+i+" is not a number")}if(n[0]<=0)throw new Error("Header line missing first number, number of data points");if(n[1]<=0)throw new Error("Header line missing second number, number of classes");var o=n[1],a=(n[0],e[1]);a=a.substring(a.indexOf("#")+1);var s=$.trim(a).split(t);if(s.length<o)throw new Error("First line specifies "+o+" classes, but found "+s.length+".");var l=e[2].split(t);for(i=0;i<l.length;i++){var u=$.trim(l[i]),c=s[parseInt(u)];void 0!==c&&(l[i]=c)}return l}},morpheus.ClsWriter=function(){},morpheus.ClsWriter.prototype={write:function(e){var t=[],r=e.size();t.push(r),t.push(" ");var n=morpheus.VectorUtil.getSet(e);t.push(n.size()),t.push(" "),t.push("1\n"),t.push("#");var i=new morpheus.Map,o=0;n.forEach(function(e){t.push(" "),t.push(e),i.set(e,o++)}),t.push("\n");for(var a=0;a<r;a++)a>0&&t.push(" "),t.push(i.get(e.getValue(a)));return t.push("\n"),t.join("")}},morpheus.GctReader=function(){},morpheus.GctReader.prototype={getFormatName:function(){return"gct"},read:function(e,t){morpheus.Util.isFile(e)?this._readChunking(e,t,!1):morpheus.Util.isFetchStreamingSupported()?this._readChunking(e,t,!0):this._readNoChunking(e,t)},_readChunking:function(e,t,r){var n,i,o,a=0,s=1,l=0,u=-1,c=-1,h=2,p=[],d=[],f=[[]],m=[[]],g=[],v="id",y="id",b=!1,w=null,x=function(e){if(0===a){var r=e[0].trim();"#1.2"===r?h=2:"#1.3"===r?h=3:console.log("Unknown version: assuming version 2")}else if(1===a){var x=e;3===h?x.length>=4?(u=parseInt(x[0]),c=parseInt(x[1]),s=parseInt(x[2]),l=parseInt(x[3])):(s=parseInt(x[0]),l=parseInt(x[1])):(u=parseInt(x[0]),c=parseInt(x[1]),(u<=0||c<=0)&&t("Number of rows and columns must be greater than 0.")),n=s+1}else if(2===a){o=e;for(var _=0;_<o.length;_++)o[_]=morpheus.Util.copyString(o[_]);if(-1===c&&(c=o.length-s-1),2==h){var S=c+2;if(o.length!==S){if(o.length>S){var C=o.length-1;for(_=o.length-1;_>=0&&""===o[_];_--,C--);C!==o.length-1&&(o=o.slice(0,C+1))}if(o.length!==S)return t("Expected "+(S-2)+" column names, but read "+(o.length-2)+" column names.")}}var M=o[0],T=M.lastIndexOf("/");-1!=T&&T<M.length-1&&(y=M.substring(0,T),v=M.substring(T+1)),p.push(y),d.push(v);for(var A=0;A<c;A++){var E=A+s+1,P=E<o.length?o[E]:null;m[0].push(morpheus.Util.copyString(P))}for(A=0;A<s;A++){var R=""===o[1]?"description":o[A+1];p.push(R),f.push([])}i=3+l}else if(a<i){var I=morpheus.Util.copyString(e[0]),N=[];for(m.push(N),d.push(I),A=0;A<c;A++)N.push(morpheus.Util.copyString(e[A+n]))}else if(""!==e[0]){for(var D=new Float32Array(c),k=0;k<=s;k++){var O=e[k];f[k].push(morpheus.Util.copyString(O))}for(var F=0;F<c;F++){var L=e[F+n];D[F]=parseFloat(L)}if(null==w){var U=0;for(A=0;A<c;A++)0===D[0]&&U++;w=U/D.length,b=w>.3}if(b){var V=0;for(A=0;A<c;A++)0!==D[A]&&V++;for(var B={values:new Float32Array(V),indices:new Uint32Array(V)},z=(A=0,0);A<c;A++)0!==D[A]&&(B.values[z]=D[A],B.indices[z]=A,z++);g.push(B)}else g.push(D)}a++};(r?morpheus.BufferedReader:Papa).parse(e,{delimiter:"\t",newline:"",header:!1,dynamicTyping:!1,preview:0,encoding:"",worker:!1,comments:!1,handleTokens:x,step:function(e){x(e.data[0])},complete:function(){for(var r=new morpheus.Dataset({name:morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e)),rows:g.length,columns:c,array:g,dataType:"Float32",defaultValue:b?0:void 0}),n=0;n<p.length;n++)r.getRowMetadata().add(p[n]).array=f[n];for(n=0;n<d.length;n++)r.getColumnMetadata().add(d[n]).array=m[n];morpheus.MetadataUtil.maybeConvertStrings(r.getRowMetadata(),1),morpheus.MetadataUtil.maybeConvertStrings(r.getColumnMetadata(),1),t(null,r)},error:function(e){t(e)},download:!morpheus.Util.isFile(e),skipEmptyLines:!1,chunk:void 0,fastMode:!0,beforeFirstChunk:void 0,withCredentials:void 0})},_read:function(e,t){var r=/\t/,n=morpheus.Util.copyString(t.readLine().trim());if(""===n)throw new Error("Missing version line");var i=2;"#1.2"===n?i=2:"#1.3"===n?i=3:console.log("Unknown version: assuming version 2");var o=morpheus.Util.copyString(t.readLine());if(null==o)throw new Error("No dimensions specified");var a=o.split(/[ \t]/),s=1,l=0,u=-1,c=-1;if(3===i)a.length>=4?(u=parseInt(a[0]),c=parseInt(a[1]),s=parseInt(a[2]),l=parseInt(a[3])):(s=parseInt(a[0]),l=parseInt(a[1]));else if(u=parseInt(a[0]),c=parseInt(a[1]),u<=0||c<=0)throw new Error("Number of rows and columns must be greater than 0.");var h=morpheus.Util.copyString(t.readLine());if(null==h)throw new Error("No column annotations");var p=h.split(r);if(-1===c&&(c=p.length-s-1),2==i){var d=c+2;if(p.length!==d)throw new Error("Expected "+(d-2)+" column names, but read "+(p.length-2)+" column names.")}var f=p[0],m=f.lastIndexOf("/"),g="id",v="id";if(-1!=m&&m<f.length-1&&(v=f.substring(0,m),g=f.substring(m+1)),-1===u){for(var y=[],b=[v],w=[g],x=[[]],_=[[]],S=0;S<c;S++){var C=(z=S+s+1)<p.length?p[z]:null;_[0].push(morpheus.Util.copyString(C))}for(S=0;S<s;S++){var M=""===p[1]?"description":p[S+1];b.push(M),x.push([])}var T=s+1;if(l>0)for(var A=0;A<l;A++){var E=(D=t.readLine().split(r))[0],P=[];for(_.push(P),w.push(E),S=0;S<c;S++)P.push(morpheus.Util.copyString(D[S+T]))}for(var R=!1,I=s+1;null!==($=t.readLine());)if(""!==$){var N=new Float32Array(c);y.push(N);for(var D=$.split(r),k=0;k<I;k++){var O=D[k];x[k].push(morpheus.Util.copyString(O))}for(var F=0;F<c;F++){var L=D[F+T];N[F]=parseFloat(L)}}for(var U=new morpheus.Dataset({name:e,rows:y.length,columns:c,array:y,dataType:"Float32"}),V=0;V<b.length;V++)U.getRowMetadata().add(b[V]).array=x[V];for(V=0;V<w.length;V++)U.getColumnMetadata().add(w[V]).array=_[V];return morpheus.MetadataUtil.maybeConvertStrings(U.getRowMetadata(),1),morpheus.MetadataUtil.maybeConvertStrings(U.getColumnMetadata(),1),U}var B=(U=new morpheus.Dataset({dataType:"Float32",name:e,rows:u,columns:c})).getColumnMetadata().add(g);if(3==i)for(S=0;S<c;S++){var z;C=(z=S+s+1)<p.length?p[z]:null,B.setValue(S,morpheus.Util.copyString(C))}else for(S=0;S<c;S++)C=p[S+s+1],B.setValue(S,morpheus.Util.copyString(C));var j=[U.getRowMetadata().add(v)];if(3===i)for(S=0;S<s;S++)M=""===p[1]?"description":p[S+1],j.push(U.getRowMetadata().add(M));else j.push(U.getRowMetadata().add(p[1]));if(T=s+1,l>0)for(A=0;A<l;A++)for(E=(D=t.readLine().split(r))[0],P=U.getColumnMetadata().add(E),S=0;S<c;S++)P.setValue(S,morpheus.Util.copyString(D[S+T]));R=!1,I=s+1;var H=0;for(u=U.getRowCount();H<u;H++){var $;if(null===($=t.readLine()))throw new Error("Missing data rows.");if(D=$.split(r),2===i){j[0].setValue(H,morpheus.Util.copyString(D[0]));var G=D[1];R||(R=""!==G),j[1].setValue(H,morpheus.Util.copyString(G))}else for(k=0;k<I;k++)O=D[k],j[k].setValue(H,morpheus.Util.copyString(O));for(F=0;F<c;F++)L=D[F+T],U.setValue(H,F,parseFloat(L))}if(2!==i||R||U.getRowMetadata().remove(1),H!==u)throw new Error("Missing data rows");return morpheus.MetadataUtil.maybeConvertStrings(U.getRowMetadata(),1),morpheus.MetadataUtil.maybeConvertStrings(U.getColumnMetadata(),1),U},_readNoChunking:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){e?t(e):t(null,r._read(n,new morpheus.ArrayBufferReader(new Uint8Array(i))))})}},morpheus.GctWriter=function(){this.nf=morpheus.Util.createNumberFormat(".2f")},morpheus.GctWriter.idFirst=function(e){for(var t=["id","Id","pr_id"],r=-1,n=0;n<t.length&&-1===(r=morpheus.MetadataUtil.indexOf(e,t[n]));n++);if(-1!==r){var i=[];i[0]=r,n=0;for(var o=1,a=e.getMetadataCount();n<a;n++)n!==r&&(i[o++]=n);return new morpheus.MetadataModelColumnView(e,i)}return e},morpheus.GctWriter.prototype={setNumberFormat:function(e){this.nf=e},getExtension:function(){return"gct"},write:function(e,t){null==t&&(t=[]);var r=morpheus.GctWriter.idFirst(e.getRowMetadata()),n=morpheus.GctWriter.idFirst(e.getColumnMetadata());return this.writeHeader(r,n,t),this.writeData(e,r,t),t.join("")},writeData:function(e,t,r){for(var n=e.getColumnCount(),i=t.getMetadataCount(),o=this.nf,a=0,s=e.getRowCount();a<s;a++){for(var l=0;l<i;l++){l>0&&r.push("\t");var u=t.get(l);if(null!==(p=u.getValue(a))){var c=morpheus.VectorTrack.vectorToString(u);r.push(c(p))}}for(var h=0;h<n;h++){r.push("\t");var p=e.getValue(a,h);r.push(o(p))}r.push("\n")}},writeHeader:function(e,t,r){var n=e.getItemCount(),i=t.getItemCount();r.push("#1.3\n");var o=e.getMetadataCount();r.push(n+"\t"+i+"\t"+(o-1)+"\t"+(t.getMetadataCount()-1)),r.push("\n");for(var a=0;a<o;a++){a>0&&r.push("\t");var s=e.get(a).getName();0===a&&s!==t.get(0).getName()&&(s=s+"/"+t.get(0).getName()),r.push(s)}for(var l=morpheus.VectorTrack.vectorToString(t.get(0)),u=0;u<i;u++)r.push("\t"),r.push(l(t.get(0).getValue(u)));r.push("\n");for(var c=1,h=t.getMetadataCount();c<h;c++){var p=t.get(c);for(r.push(p.getName()),a=1;a<o;a++)r.push("\t"),r.push("na");for(u=0;u<i;u++){r.push("\t");var d=p.getValue(u);if(null!=d){var f=morpheus.VectorTrack.vectorToString(p);r.push(f(d))}}r.push("\n")}}},morpheus.GctWriter12=function(){this.options={rowDescription:"Description",rowId:"id",columnId:"id"},this.nf=morpheus.Util.createNumberFormat(".2f")},morpheus.GctWriter12.prototype={setNumberFormat:function(e){this.nf=e},getExtension:function(){return"gct"},write:function(e,t){null==t&&(t=[]);var r=e.getRowCount(),n=e.getColumnCount();t.push("#1.2"),t.push("\n"),t.push(r+"\t"+n),t.push("\n");var i=morpheus.GctWriter.idFirst(e.getRowMetadata()),o=morpheus.GctWriter.idFirst(e.getColumnMetadata());t.push("Name"),t.push("\t"),t.push("Description");var a=o.getByName(this.options.columnId);a||(a=o.get(0));for(var s=morpheus.VectorTrack.vectorToString(a),l=0;l<n;l++)t.push("\t"),t.push(s(a.getValue(l)));var u=i.get(this.options.rowId);u||(u=i.get(0));var c=i.getByName(this.options.rowDescription);null==c&&i.getMetadataCount()>1&&(c=i.get(1));for(var h=morpheus.VectorTrack.vectorToString(u),p=null!=c?morpheus.VectorTrack.vectorToString(c):null,d=this.nf,f=0;f<r;f++){t.push("\n"),t.push(h(u.getValue(f))),t.push("\t");var m=null!=c?c.getValue(f):null;for(null!=m&&t.push(p(m)),l=0;l<n;l++)t.push("\t"),t.push(d(e.getValue(f,l)))}return t.push("\n"),t.join("")}},morpheus.GisticReader=function(){},morpheus.GisticReader.prototype={read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){if(e)t(e);else try{t(null,r._read(n,new morpheus.ArrayBufferReader(new Uint8Array(i))))}catch(e){e.stack&&console.log(e.stack),t(e)}})},_read:function(e,t){for(var r,n=/\t/,i=t.readLine().trim().split(n),o=i.length-9,a=[],s=[],l=[];null!==(r=t.readLine());)if(""!==(r=r.trim())){var u=r.split(n);if("Actual Copy Change Given"===u[8]){var c=new Float32Array(o);a.push(c),s.push(String($.trim(u[1]))),l.push(parseFloat(u[5]));for(var h=9;h<=o;h++){var p=u[h];c[h-9]=parseFloat(p)}}}var d=new morpheus.Dataset({name:e,rows:a.length,columns:o,array:a,dataType:"Float32"}),f=d.getColumnMetadata().add("id");for(h=0;h<o;h++)f.setValue(h,String(i[h+9]));return d.getRowMetadata().add("id").array=s,d.getRowMetadata().add("q_value").array=l,d}},morpheus.GmtDatasetReader=function(){},morpheus.GmtDatasetReader.prototype={getFormatName:function(){return"gmt"},read:function(e,t){var r=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,n){if(e)t(e);else try{t(null,morpheus.DatasetUtil.geneSetsToDataset(r,(new morpheus.GmtReader).read(new morpheus.ArrayBufferReader(new Uint8Array(n)))))}catch(e){t(e)}})}},morpheus.GmtReader=function(){},morpheus.GmtReader.prototype={read:function(e){for(var t,r=[],n=/\t/;null!=(t=e.readLine());)if(""!==t&&"#"!==t[0]){var i=t.split(n),o=i[0].trim(),a=i.length>1?i[1].trim():"";"BLANK"===a&&(a="");for(var s=[],l=2;l<i.length;l++){var u=i[l].trim();""!==u&&s.push(u)}var c={name:o,description:a,ids:s,toString:function(){return this.name}};r.push(c)}return r}},morpheus.Hdf5Reader=function(e){null==e&&(e={}),this.options=e},morpheus.Hdf5Reader.prototype={read:function(e,t){}},morpheus.Hdf5Reader.getGctxInstance=function(){return new morpheus.Hdf5Reader({dataset:"0/DATA/0/matrix",rowMeta:"0/META/ROW/",colMeta:"0/META/COL/",columnMajorOrder:!0})},morpheus.Hdf5Reader.getLoomInstance=function(){return new morpheus.Hdf5Reader({dataset:"matrix",rowMeta:"row_attrs",colMeta:"col_attrs",transpose:!1})},morpheus.Hdf5Reader.getH5adInstance=function(){return new morpheus.Hdf5Reader({dataset:"X",rowMeta:"obs",colMeta:"var",transpose:!1})},morpheus.JsonDatasetReader=function(){},morpheus.JsonDatasetReader.prototype={read:function(e,t){if(morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e)),"string"==typeof e||e instanceof String)fetch(e).then(function(e){if(e.ok)return e.text();t(e.status+" "+e.statusText)}).then(function(e){t(null,morpheus.Dataset.fromJSON(JSON.parse(e.trim())))}).catch(function(e){t(e)});else{var r=new FileReader;r.onload=function(e){t(null,morpheus.Dataset.fromJSON(JSON.parse(e.target.result)))},r.onerror=function(e){t(e)},r.readAsText(e)}}},morpheus.LineReader=function(e){this.lines=e,this.index=0},morpheus.LineReader.prototype={reset:function(){this.index=0},readLine:function(){var e=this.index;return e>=this.lines.length?null:(this.index++,this.lines[e])}},morpheus.MafFileReader=function(){this.geneFilter=null},morpheus.MafFileReader.summarizeMutations=function(e){var t=e.dataset,r=e.fields,n=r.length,i=t.getRowMetadata().add("mutation_summary");i.getProperties().set(morpheus.VectorKeys.FIELDS,r),i.getProperties().set(morpheus.VectorKeys.DATA_TYPE,"[number]");for(var o=0,a=t.getRowCount();o<a;o++){for(var s=new Int32Array(n),l=0,u=t.getColumnCount();l<u;l++){var c=t.getValue(o,l);c>0&&s[c-1]++}i.setValue(o,s)}},morpheus.MafFileReader.getField=function(e,t){for(var r,n,i=0;i<e.length&&void 0===(n=t[(r=e[i]).toLowerCase()]);i++);if(void 0!==n)return{name:r,index:n}},morpheus.MafFileReader.VARIANT_MAP=new morpheus.Map,morpheus.MafFileReader.VARIANT_MAP.set("Silent",1),morpheus.MafFileReader.VARIANT_MAP.set("In_Frame_Del",2),morpheus.MafFileReader.VARIANT_MAP.set("In_Frame_Ins",2),morpheus.MafFileReader.VARIANT_MAP.set("Inframe_Del",2),morpheus.MafFileReader.VARIANT_MAP.set("Inframe_Ins",2),morpheus.MafFileReader.VARIANT_MAP.set("Translation_Start_Site",3),morpheus.MafFileReader.VARIANT_MAP.set("Nonstop_Mutation",3),morpheus.MafFileReader.VARIANT_MAP.set("3'UTR",3),morpheus.MafFileReader.VARIANT_MAP.set("3'Flank",3),morpheus.MafFileReader.VARIANT_MAP.set("5'UTR",3),morpheus.MafFileReader.VARIANT_MAP.set("5'Flank",3),morpheus.MafFileReader.VARIANT_MAP.set("IGR",3),morpheus.MafFileReader.VARIANT_MAP.set("Intron",3),morpheus.MafFileReader.VARIANT_MAP.set("RNA",3),morpheus.MafFileReader.VARIANT_MAP.set("Targeted_Region",3),morpheus.MafFileReader.VARIANT_MAP.set("Unknown",3),morpheus.MafFileReader.VARIANT_MAP.set("1DEL",3),morpheus.MafFileReader.VARIANT_MAP.set("HA",3),morpheus.MafFileReader.VARIANT_MAP.set("Missense_Mutation",4),morpheus.MafFileReader.VARIANT_MAP.set("Missense",4),morpheus.MafFileReader.VARIANT_MAP.set("Splice_Site",5),morpheus.MafFileReader.VARIANT_MAP.set("Splice_Acceptor",5),morpheus.MafFileReader.VARIANT_MAP.set("Splice_Region",5),morpheus.MafFileReader.VARIANT_MAP.set("Frame_Shift_Del",6),morpheus.MafFileReader.VARIANT_MAP.set("Frame_Shift_Ins",6),morpheus.MafFileReader.VARIANT_MAP.set("Frameshift",6),morpheus.MafFileReader.VARIANT_MAP.set("Nonsense_Mutation",7),morpheus.MafFileReader.VARIANT_MAP.set("Nonsense",7),morpheus.MafFileReader.VARIANT_MAP.set("2DEL",7),morpheus.MafFileReader.FIELD_NAMES=["Synonymous","In Frame Indel","Other Non-Synonymous","Missense","Splice Site","Frame Shift","Nonsense"],morpheus.MafFileReader.prototype={setGeneFilter:function(e){this.geneFilter=e},getFormatName:function(){return"maf"},_getGeneLevelDataset:function(e,t){for(var r=t.readLine(),n=morpheus.Util.detectSeparator(r),i=r.split(n),o={},a=0,s=i.length;a<s;a++)o[i[a].toLowerCase()]=a;var l=morpheus.MafFileReader.getField(["Tumor_Sample_Barcode","tumor_name","Tumor_Sample_UUID","cell_line_name"],o),u=morpheus.MafFileReader.getField(["encoding"],o);if(null==l)throw new Error("Sample id column not found.");var c,h=null==u?-1:u.index,p=(l.name,l.index),d=morpheus.MafFileReader.getField(["ccf_hat","tumor_f","i_tumor_f"],o);void 0!==d&&(d.name,c=d.index);var f=o["Chromosome".toLowerCase()],m=o["Start_position".toLowerCase()],g=o["Reference_Allele".toLowerCase()],v=o["Tumor_Seq_Allele2".toLowerCase()],y=o["Protein_Change".toLowerCase()];null==y&&(y=o["Protein".toLowerCase()]);var b=o["Hugo_Symbol".toLowerCase()];if(null==b&&(b=o.gene),null==b)throw new Error("Gene symbol column not found.");var w=o["Variant_Classification".toLowerCase()];if(null==w&&(w=o["variant".toLowerCase()]),null==w)throw new Error("Variant_Classification not found");for(var x,_=new morpheus.Map,S=new morpheus.Map,C=[],M=[],T=new morpheus.Map,A=void 0!==f&&void 0!==m&&void 0!==g&&void 0!==v;null!==(x=t.readLine());){var E=x.split(n),P=String(E[p]),R=S.get(P);if(void 0===R&&(R=S.size(),S.set(P,R)),"Unknown"!==(Y=String(E[b]))&&(null==this.geneFilter||this.geneFilter.has(E[b]))){var I=_.get(Y);void 0===I&&(I=_.size(),_.set(Y,I));var N,D=String(E[w]);-1===h?void 0===(N=morpheus.MafFileReader.VARIANT_MAP.get(D))&&(N=3):(N=parseInt(E[h]),T.set(N,D));var k={},O=E[y];O&&(k.Protein=String(O)),k.__v=N,k.Variant=D,A&&(k.Mutation=String(E[f])+":"+String(E[m])+" "+String(E[g])+" > "+String(E[v]));var F=morpheus.Util.wrapNumber(N,k),L=C[I];void 0===L&&(L=[],C[I]=L);var U=-1,V=-1;if(void 0!==c){var B=M[I];void 0===B&&(B=[],M[I]=B),U=parseFloat(E[c]),V=B[R]||-1}var z=L[R]||-1;N>z?(L[R]=F,void 0!==c&&(B[R]=U)):N===z&&U>V&&(L[R]=F,B[R]=U)}}var j=new morpheus.Dataset({name:e,array:C,dataType:"Number",rows:_.size(),columns:S.size()}),H=j.getColumnMetadata().add("id");S.forEach(function(e,t){H.setValue(e,t)});var $=j.getRowMetadata().add("id");_.forEach(function(e,t){$.setValue(e,t)}),a=0;for(var G=j.getRowCount(),W=j.getColumnCount();a<G;a++)for(var q=0;q<W;q++)void 0===C[a][q]&&(C[a][q]=0);if(void 0!==c&&j.addSeries({dataType:"Float32",name:"allelic_fraction",array:M}),this.geneFilter){for(var X=j.getRowMetadata().add("order"),K=(a=0,X.size());a<K;a++){var Y=$.getValue(a),Z=this.geneFilter.get(Y);X.setValue(a,Z)}var J=new morpheus.Project(j);J.setRowSortKeys([new morpheus.SortKey("order",morpheus.SortKey.SortOrder.ASCENDING)],!0);var Q=J.getSortedFilteredDataset();J=new morpheus.Project(Q);var ee=morpheus.Util.seq(Q.getColumnCount());ee.sort(function(e,t){for(var r=0,n=Q.getRowCount();r<n;r++)for(var i=0,o=Q.getSeriesCount();i<o;i++){var a=Q.getValue(r,e,i);isNaN(a)&&(a=Number.NEGATIVE_INFINITY),a=a.valueOf();var s=Q.getValue(r,t,i);isNaN(s)&&(s=Number.NEGATIVE_INFINITY);var l=a===(s=s.valueOf())?0:a<s?1:-1;if(0!==l)return l}return 0}),j=new morpheus.SlicedDatasetView(j,null,ee)}var te=morpheus.MafFileReader.FIELD_NAMES;if(T.size()>0){var re=[];T.forEach(function(e,t){re.push({key:t,value:e})}),re.sort(function(e,t){return e.key===t.key?0:e.key<t.key?-1:1}),te=re.map(function(e){return e.value})}te.length,morpheus.MafFileReader.summarizeMutations({dataset:j,fields:te}),morpheus.MafFileReader.summarizeMutations({dataset:new morpheus.TransposedDatasetView(j),fields:te});var ne=j.getColumnMetadata().add("mutation_summary_selection");return ne.getProperties().set(morpheus.VectorKeys.FIELDS,te),ne.getProperties().set(morpheus.VectorKeys.DATA_TYPE,"[number]"),ne.getProperties().set(morpheus.VectorKeys.RECOMPUTE_FUNCTION_SELECTION,!0),e=j.getName(),ne.getProperties().set(morpheus.VectorKeys.FUNCTION,{binSize:1,domain:[1,8],cumulative:!1}),j},read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){if(e)t(e);else try{t(null,r._getGeneLevelDataset(n,new morpheus.ArrayBufferReader(new Uint8Array(i))))}catch(e){t(e)}})}},morpheus.MtxReader=function(){},morpheus.MtxReader.prototype={getFormatName:function(){return"mtx"},read:function(e,t){morpheus.Util.isFile(e)?this._read(e,t,!1,!0):morpheus.Util.isFetchStreamingSupported()?this._read(e,t,!0,!0):this._read(e,t,!1,!1)},_read:function(e,t,r,n){var i,o,a,s=!0,l=[],u=-1,c=-1,h=function(){for(var t=new Uint32Array(o),r=new Uint32Array(a),n=0;n<o;n++){var s=l[n];if(null!=s.values){var u=new Uint16Array(s.length),c=new Uint32Array(s.length);u.set(s.values.slice(0,s.length)),c.set(s.indices.slice(0,s.length)),l[n]={values:u,indices:c},t[n]=u.length;for(var h=0;h<s.length;h++)r[c[h]]+=1}}(i=new morpheus.Dataset({rows:o,columns:a,name:morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e)),array:l,dataType:"Int16",defaultValue:0})).getRowMetadata().add("count>0").array=t,i.getColumnMetadata().add("count>0").array=r},p=function(e){if("%"!==e[0][0]&&1!==e.length)if(s){s=!1,o=parseInt(e[0]),a=parseInt(e[1]);for(var r=0;r<o;r++)l.push({})}else{var n=parseInt(e[0])-1,i=parseInt(e[1])-1,h=parseInt(e[2]),p=l[n];if(null==p.values){var d=Math.max(1,Math.min(100,Math.floor(.01*a)));p.values=new Uint16Array(d),p.indices=new Uint32Array(d),p.length=0}if(p.length>=p.values.length){var f=Math.min(a,Math.floor(1.1*p.values.length)),m=new Uint16Array(f),g=new Uint32Array(f);m.set(p.values),g.set(p.indices),p.values=m,p.indices=g}p.values[p.length]=h,p.indices[p.length]=i,p.length++,n!==u&&(c=-1,u=n),i<c&&t(new Error("Column indices are not sorted"))}};n?(r?morpheus.BufferedReader:Papa).parse(e,{delimiter:" ",newline:"",header:!1,dynamicTyping:!1,preview:0,encoding:"",worker:!1,comments:!1,handleTokens:p,step:function(e){p(e.data[0])},complete:function(){h(),t(null,i)},error:function(e){t(e)},download:!morpheus.Util.isFile(e),skipEmptyLines:!1,chunk:void 0,fastMode:!0,beforeFirstChunk:void 0,withCredentials:void 0}):morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,r){if(e)t(e);else{for(var n,o=new morpheus.ArrayBufferReader(new Uint8Array(r)),a=/ /;null!==(n=o.readLine());)if("%"!==n[0]){var s=n.split(a);p(s)}h(),t(null,i)}})}},morpheus.SegTabReader=function(){this.regions=null},morpheus.SegTabReader.binByRegion=function(e,t){var r=e.getRowMetadata().getByName("Chromosome"),n=e.getRowMetadata().getByName("Start_bp"),i=e.getRowMetadata().getByName("End_bp"),o=new morpheus.Dataset({name:e.getName(),rows:t.length,columns:e.getColumnCount(),dataType:"Float32"});morpheus.DatasetUtil.fill(o,NaN);for(var a=o.getRowMetadata().add("id"),s=o.getRowMetadata().add("chromosome"),l=o.getRowMetadata().add("start"),u=o.getRowMetadata().add("end"),c=o.getRowMetadata().add("nsegments"),h=e.getSeriesCount(),p=1;p<h;p++)o.addSeries({name:e.getName(p),dataType:"Float32"});var d=morpheus.Mean;o.setColumnMetadata(e.getColumnMetadata());for(var f=0;f<t.length;f++){for(var m=t[f],g=[],v=0,y=e.getRowCount();v<y;v++){var b=r.getValue(v),w=n.getValue(v),x=i.getValue(v);m.chromosome==b&&w>=m.start&&x<=m.end&&g.push(v)}if(g.length>0)for(var _=new morpheus.SlicedDatasetView(e,g,null),S=new morpheus.DatasetColumnView(_),C=0;C<e.getColumnCount();C++)for(S.setIndex(C),p=0;p<h;p++)S.setSeriesIndex(p),o.setValue(f,C,d(S),p);c.setValue(f,g.length),a.setValue(f,m.id),s.setValue(f,m.chromosome),l.setValue(f,m.start),u.setValue(f,m.end)}return o},morpheus.SegTabReader.prototype={getFormatName:function(){return"seg"},setRegions:function(e){this.regions=e},_read:function(e,t){for(var r=/\t/,n=t.readLine().split(r),i={},o=0,a=n.length;o<a;o++)i[n[o].toLowerCase()]=o;var s,l=morpheus.MafFileReader.getField(["pair_id","Tumor_Sample_Barcode","tumor_name","Tumor_Sample_UUID","Sample"],i),u=(l.name,l.index),c=morpheus.MafFileReader.getField(["ccf_hat","tumor_f","i_tumor_f"],i);void 0!==c&&(c.name,s=c.index);for(var h,p=i.Chromosome,d=morpheus.MafFileReader.getField(["Start_bp","Start"],i).index,f=morpheus.MafFileReader.getField(["End_bp","End"],i,{remove:!1,lc:!0}).index,m=morpheus.MafFileReader.getField(["tau","Segment_Mean"]).index,g=[],v=[],y=new morpheus.Map,b=new morpheus.Map;null!==(h=t.readLine());)if(""!==h){var w=h.split(r),x=String(w[u]),_=y.get(x);void 0===_&&(_=y.size(),y.set(x,_));var S=new morpheus.Identifier([String(w[p]),String(w[d]),String(w[f])]),C=b.get(S);void 0===C&&(C=b.size(),b.set(S,C));var M=parseFloat(String(w[m]));M=isNaN(M)?M:morpheus.Log2(M)-1;var T=g[C];void 0===T&&(T=[],g[C]=T,void 0!==s&&(v[C]=[])),T[_]=M,void 0!==s&&(v[C][_]=parseFloat(w[s]))}var A=new morpheus.Dataset({name:e,array:g,dataType:"number",rows:b.size(),columns:y.size()}),E=A.getColumnMetadata().add("id");y.forEach(function(e,t){E.setValue(e,t)});var P=A.getRowMetadata().add("Chromosome"),R=A.getRowMetadata().add("Start_bp"),I=A.getRowMetadata().add("End_bp");return b.forEach(function(e,t){P.setValue(e,t.getArray()[0]),R.setValue(e,t.getArray()[1]),I.setValue(e,t.getArray()[2])}),void 0!==s&&A.addSeries({dataType:"number",name:"ccf",array:v}),null!=this.regions&&this.regions.length>0&&(A=morpheus.SegTabReader.binByRegion(A,this.regions)),A},read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){e?t(e):t(null,r._read(n,new morpheus.ArrayBufferReader(new Uint8Array(i))))})}},morpheus.TcgaUtil=function(){},morpheus.TcgaUtil.DISEASE_STUDIES={ACC:"Adrenocortical carcinoma",BLCA:"Bladder Urothelial Carcinoma",BRCA:"Breast invasive carcinoma",CESC:"Cervical squamous cell carcinoma and endocervical adenocarcinoma",CHOL:"Cholangiocarcinoma",COAD:"Colon adenocarcinoma",COADREAD:"Colonrectal adenocarcinoma",DLBC:"Lymphoid Neoplasm Diffuse Large B-cell Lymphoma",ESCA:"Esophageal carcinoma ",GBM:"Glioblastoma multiforme",GBMLGG:"Glioma",HNSC:"Head and Neck squamous cell carcinoma",KICH:"Kidney Chromophobe",KIPAN:"Pan-Kidney Cohort",KIRC:"Kidney renal clear cell carcinoma",KIRP:"Kidney renal papillary cell carcinoma",LAML:"Acute Myeloid Leukemia",LCML:"Chronic Myelogenous Leukemia",LGG:"Brain Lower Grade Glioma",LIHC:"Liver hepatocellular carcinoma",LUAD:"Lung adenocarcinoma",LUSC:"Lung squamous cell carcinoma",MESO:"Mesothelioma",OV:"Ovarian serous cystadenocarcinoma",PAAD:"Pancreatic adenocarcinoma",PCPG:"Pheochromocytoma and Paraganglioma",PRAD:"Prostate adenocarcinoma",READ:"Rectum adenocarcinoma",SARC:"Sarcoma",SKCM:"Skin Cutaneous Melanoma",STAD:"Stomach adenocarcinoma",STES:"Stomach and Esophageal Carcinoma",TGCT:"Testicular Germ Cell Tumors",THCA:"Thyroid carcinoma",THYM:"Thymoma",UCEC:"Uterine Corpus Endometrial Carcinoma",UCS:"Uterine Carcinosarcoma",UVM:"Uveal Melanoma"},morpheus.TcgaUtil.SAMPLE_TYPES={"01":"Primary solid Tumor","02":"Recurrent Solid Tumor","03":"Primary Blood Derived Cancer - Peripheral Blood","04":"Recurrent Blood Derived Cancer - Bone Marrow","05":"Additional - New Primary","06":"Metastatic","07":"Additional Metastatic","08":"Human Tumor Original Cells","09":"Primary Blood Derived Cancer - Bone Marrow",10:"Blood Derived Normal",11:"Solid Tissue Normal",12:"Buccal Cell Normal",13:"EBV Immortalized Normal",14:"Bone Marrow Normal",20:"Control Analyte",40:"Recurrent Blood Derived Cancer - Peripheral Blood",50:"Cell Lines",60:"Primary Xenograft Tissue",61:"Cell Line Derived Xenograft Tissue"},morpheus.TcgaUtil.barcode=function(e){var t,r=e.split("-"),n=r[2];return r.length>3?((t=r[3]).length>2&&(t=t.substring(0,2)),t=morpheus.TcgaUtil.SAMPLE_TYPES[t]):t=morpheus.TcgaUtil.SAMPLE_TYPES["01"],{id:n.toLowerCase(),sampleType:t}},morpheus.TcgaUtil.setIdAndSampleType=function(e){for(var t=e.getColumnMetadata().get(0),r=e.getColumnMetadata().add("participant_id"),n=e.getColumnMetadata().add("sample_type"),i=0,o=t.size();i<o;i++){var a=morpheus.TcgaUtil.barcode(t.getValue(i));t.setValue(i,a.id+"-"+a.sampleType),n.setValue(i,a.sampleType),r.setValue(i,a.id)}},morpheus.TcgaUtil.getDataset=function(e){var t,r=[],n=[];if(e.mrna&&r.push(new Promise(function(t,r){(new morpheus.TxtReader).read(e.mrna,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})})),e.mutation){r.push(new Promise(function(t,r){(new morpheus.MafFileReader).read(e.mutation,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})}));var i=morpheus.Util.readLines(e.sigGenes);i.then(function(e){t=e}),r.push(i)}e.gistic&&r.push(new Promise(function(t,r){(new morpheus.GisticReader).read(e.gistic,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})})),e.gisticGene&&r.push(new Promise(function(t,r){new morpheus.TxtReader({dataColumnStart:3}).read(e.gisticGene,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})})),e.seg&&r.push(new Promise(function(t,r){(new morpheus.SegTabReader).read(e.seg,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})})),e.rppa&&r.push(new Promise(function(t,r){new morpheus.TxtReader({dataColumnStart:2}).read(e.rppa,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})})),e.methylation&&r.push(new Promise(function(t,r){new morpheus.TxtReader({}).read(e.methylation,function(e,r){e?console.log("Error reading file:"+e):(n.push(r),morpheus.TcgaUtil.setIdAndSampleType(r)),t()})}));var o,a=morpheus.Util.readLines(e.mrnaClust);r.push(a),a.then(function(e){o=new morpheus.Map;for(var t=0;-1!==e[t].indexOf("SampleName");)t++;for(var r=/\t/;t<e.length;t++){var n=e[t].split(r),i=morpheus.TcgaUtil.barcode(n[0]);o.set(i.id+"-"+i.sampleType,n[1])}});var s=[],l=null;return e.columnAnnotations&&(l=morpheus.DatasetUtil.annotate({annotations:e.columnAnnotations,isColumns:!0}),r.push(l),l.then(function(e){s=e})),Promise.all(r).then(function(){var r=null;if(1===n.length){for(var i=n[0].getName(),a=n[0].getRowMetadata().add("Source"),u=0;u<a.size();u++)a.setValue(u,i);r=n[0]}else{var c=0,h=n[0].getColumnCount();for(u=1;u<n.length;u++)n[u].getColumnCount()>h&&(h=n[u].getColumnCount(),c=u),"mutations_merged.maf"===n[u].getName()&&(h=Number.MAX_VALUE,c=u);var p=[];for(p.push(c),u=0;u<n.length;u++)u!==c&&p.push(u);var d=new morpheus.JoinedDataset(n[p[0]],n[p[1]],"id","id");for(u=2;u<p.length;u++)d=new morpheus.JoinedDataset(d,n[p[u]],"id","id");r=d}for(var f=r.getColumnMetadata().add("mRNAseq_cluster"),m=r.getColumnMetadata().getByName("id"),g=0,v=m.size();g<v;g++)f.setValue(g,o.get(m.getValue(g)));if(e.mutation){var y=morpheus.VectorUtil.createValueToIndicesMap(r.getRowMetadata().getByName("Source")),b=new morpheus.SlicedDatasetView(r,y.get("mutations_merged.maf"));(new morpheus.OpenFileTool).annotate({lines:t,dataset:b,isColumns:!1,metadataName:"id",fileColumnName:"gene",fileColumnNamesToInclude:["q"]});var w=b.getRowMetadata().getByName("q"),x=b.getRowMetadata().getByName("q_value");for(null==x&&(x=b.getRowMetadata().add("q_value")),u=0,v=x.size();u<v;u++)x.setValue(u,w.getValue(u));b.getRowMetadata().remove(morpheus.MetadataUtil.indexOf(b.getRowMetadata(),"q"))}return l&&s.forEach(function(e){e(r)}),Promise.resolve(r)})},morpheus.TxtReader=function(e){null==e&&(e={}),this.options=e},morpheus.TxtReader.prototype={read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){if(e)t(e);else try{t(null,r._read(n,new morpheus.ArrayBufferReader(new Uint8Array(i))))}catch(e){t(e)}})},_read:function(e,t){var r=this.options.dataColumnStart,n=this.options.dataRowStart;null==n&&(n=1);var i=t.readLine(),o=morpheus.Util.detectSeparator(i),a=null,s=/\s+$/,l=i.split(o);if(null==r){for(var u=(a=t.readLine().replace(s,"")).split(o),c=1;c<u.length;c++)if(""===(M=u[c])||"NA"===M||"NaN"===M||$.isNumeric(M)){r=c;break}null==r&&(r=1)}var h=[],p=l.length-r;if(n>1)if(this.options.columnMetadata)for(var d=1;d<n;d++){var f=t.readLine().split(o),m=f[0];null!=m&&""!==m&&"na"!==m||(m="id");for(var g=new morpheus.Vector(m,p),v=(c=0,r);c<p;c++,v++)g.setValue(c,morpheus.Util.copyString(f[v]));h.push(g)}else for(c=1;c<n;c++)t.readLine();var y,b=[],w=[];for(c=0;c<r;c++)w.push([]);var x=!1;if(null==a&&(a=t.readLine()),null!=a){var _=new Float32Array(p);for(u=a.split(o),v=0;v<r;v++)w[v].push(morpheus.Util.copyString(u[v]));for(var S=0,C=(v=r,0);C<p;v++,C++){var M=u[v];0===(E=parseFloat(M))&&S++,_[v-r]=E}if(S/_.length>.3){x=!0;var T={values:new Float32Array(_.length-S),indices:new Uint32Array(_.length-S)};for(v=0,C=0;v<_.length;v++)0!==_[v]&&(T.values[C]=_[v],T.indices[C]=v,C++);_=T}b.push(_)}for(;null!==(y=t.readLine());)if(""!==(y=y.replace(s,""))){for(u=y.split(o),v=0;v<r;v++)w[v].push(morpheus.Util.copyString(u[v]));var A=new Float32Array(p);for(v=r,C=0;C<p;v++,C++){M=u[v];var E=parseFloat(M);A[v-r]=E}if(x){var P=0;for(v=0,C=0;v<p;v++)0!==A[v]&&P++;for(T={values:new Float32Array(P),indices:new Uint32Array(P)},v=0,C=0;v<p;v++)0!==A[v]&&(T.values[C]=A[v],T.indices[C]=v,C++);b.push(T)}else b.push(A)}var R=new morpheus.Dataset({name:e,rows:b.length,columns:p,array:b,dataType:"Float32",defaultValue:x?0:void 0}),I=R.getColumnMetadata().add("id");for(c=0,v=r;c<p;c++,v++)I.setValue(c,morpheus.Util.copyString(l[v]));for(h.forEach(function(e){for(var t=1,r=e.getName();null!=R.getColumnMetadata().getByName(r);)r=r+"-"+t,t++;R.getColumnMetadata().add(r).array=e.array}),R.getRowMetadata().add("id").array=w[0],c=1;c<r;c++)(g=R.getRowMetadata().add(l[c])).array=w[c];for(c=0;c<R.getRowMetadata().getMetadataCount();c++)morpheus.VectorUtil.maybeConvertStringToNumber(R.getRowMetadata().get(c));for(c=0;c<R.getColumnMetadata().getMetadataCount();c++)morpheus.VectorUtil.maybeConvertStringToNumber(R.getColumnMetadata().get(c));return R}},morpheus.XlsxDatasetReader=function(){},morpheus.XlsxDatasetReader.prototype={read:function(e,t){var r=this,n=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e));morpheus.ArrayBufferReader.getArrayBuffer(e,function(e,i){if(e)t(e);else try{for(var o=new Uint8Array(i),a=[],s=0;s!=o.length;++s)a[s]=String.fromCharCode(o[s]);var l=a.join("");r._read(n,l,t)}catch(e){t(e)}})},_read:function(e,t,r){morpheus.Util.xlsxTo2dArray({data:t},function(t,n){for(var i=n.length-1,o=n[0],a=o.length-1,s=new morpheus.Dataset({name:e,rows:i,columns:a}),l=s.getColumnMetadata().add("id"),u=1;u<=a;u++)l.setValue(u-1,o[u]);for(var c=s.getRowMetadata().add("id"),h=1;h<n.length;h++){var p=n[h];for(c.setValue(h-1,p[0]),u=1;u<=a;u++){var d=p[u],f=parseFloat(d);s.setValue(h-1,u-1,f)}}r(null,s)})}},morpheus.VectorAdapter=function(e){if(null==e)throw"vector is null";this.v=e},morpheus.VectorAdapter.prototype={setValue:function(e,t){this.v.setValue(e,t)},getValue:function(e){return this.v.getValue(e)},getProperties:function(){return this.v.getProperties()},size:function(){return this.v.size()},getName:function(){return this.v.getName()},setName:function(e){this.v.setName(e)}},morpheus.AbstractDataset=function(e,t){this.seriesNames=[],this.seriesArrays=[],this.seriesDataTypes=[],this.rows=e,this.columns=t,this.rowMetadataModel=new morpheus.MetadataModel(e),this.columnMetadataModel=new morpheus.MetadataModel(t)},morpheus.AbstractDataset.prototype={setRowMetadata:function(e){this.rowMetadataModel=e},setColumnMetadata:function(e){this.columnMetadataModel=e},getName:function(e){return this.seriesNames[e||0]},setName:function(e,t){this.seriesNames[e||0]=t},getRowMetadata:function(){return this.rowMetadataModel},getColumnMetadata:function(){return this.columnMetadataModel},getRowCount:function(){return this.rows},getColumnCount:function(){return this.columns},getValue:function(e,t,r){},setValue:function(e,t,r,n){},addSeries:function(e){},removeSeries:function(e){this.seriesArrays.splice(e,1),this.seriesNames.splice(e,1),this.seriesDataTypes.splice(e,1)},getSeriesCount:function(){return this.seriesArrays.length},getDataType:function(e){return this.seriesDataTypes[e||0]},toString:function(){return this.getName()}},morpheus.AbstractVector=function(e,t){this.name=e,this.n=t,this.properties=new morpheus.Map},morpheus.AbstractVector.prototype={getValue:function(e){throw new Error("Not implemented")},getProperties:function(){return this.properties},size:function(){return this.n},getName:function(){return this.name}},morpheus.SignalToNoise=function(e,t){var r=morpheus.Mean(e),n=morpheus.Mean(t);return(r-n)/(Math.sqrt(morpheus.Variance(e,r))+Math.sqrt(morpheus.Variance(t,n)))},morpheus.SignalToNoise.toString=function(){return"Signal to noise"},morpheus.createSignalToNoiseAdjust=function(e){e=e||.2;var t=function(t,r){var n=morpheus.Mean(t),i=morpheus.Mean(r),o=Math.sqrt(morpheus.Variance(t,n)),a=Math.sqrt(morpheus.Variance(r,i));return(n-i)/((o=morpheus.SignalToNoise.thresholdStandardDeviation(n,o,e))+morpheus.SignalToNoise.thresholdStandardDeviation(i,a,e))};return t.toString=function(){return"Signal to noise (adjust standard deviation)"},t},morpheus.SignalToNoise.thresholdStandardDeviation=function(e,t,r){var n=t,i=r*Math.abs(e);return i>t&&(n=i),n<r&&(n=r),n},morpheus.createContingencyTable=function(e,t,r){(null==r||isNaN(r))&&(r=1);for(var n=0,i=0,o=0,a=e.size();o<a;o++){var s=e.getValue(o);isNaN(s)||(s>=r?n++:i++)}var l=0,u=0;for(o=0,a=t.size();o<a;o++)s=t.getValue(o),isNaN(s)||(s>=r?l++:u++);var c=n+l,h=n+i;return[n,c-n,h-n,n+i+l+u+n-h-c]},morpheus.FisherExact=function(e,t){var r=morpheus.createContingencyTable(e,t,1);return morpheus.FisherExact.fisherTest(r[0],r[1],r[2],r[3])},morpheus.createFisherExact=function(e){return function(t,r){var n=morpheus.createContingencyTable(t,r,e);return morpheus.FisherExact.fisherTest(n[0],n[1],n[2],n[3])}},morpheus.FisherExact.phyper=function(e,t,r,n){return Math.exp(morpheus.FisherExact.logFactorial(e+t)+morpheus.FisherExact.logFactorial(r+n)+morpheus.FisherExact.logFactorial(e+r)+morpheus.FisherExact.logFactorial(t+n)-(morpheus.FisherExact.logFactorial(e)+morpheus.FisherExact.logFactorial(t)+morpheus.FisherExact.logFactorial(r)+morpheus.FisherExact.logFactorial(n)+morpheus.FisherExact.logFactorial(e+t+r+n)))},morpheus.FisherExact.logFactorials=[0,0,.6931471805599453,1.791759469228055,3.1780538303479458,4.787491742782046,6.579251212010101,8.525161361065415,10.60460290274525,12.801827480081469,15.104412573075516,17.502307845873887,19.987214495661885,22.552163853123425,25.19122118273868,27.89927138384089,30.671860106080672,33.50507345013689,36.39544520803305,39.339884187199495,42.335616460753485,45.38013889847691,48.47118135183523,51.60667556776438,54.78472939811232,58.00360522298052,61.261701761002,64.55753862700634,67.88974313718154,71.25703896716801],morpheus.FisherExact.logFactorial=function(e){if(e>=30){var t=1/e,r=t*t;return(e+.5)*Math.log(e)-e+.9189385332046728+t*(.08333333333333333+r*(r*(.0007936507936507937+-.0005952380952380953*r)-.002777777777777778))}return morpheus.FisherExact.logFactorials[e]},morpheus.FisherExact.fisherTest=function(e,t,r,n){for(var i=morpheus.FisherExact.phyper(e,t,r,n),o=i,a=0,s=e+t+r+n;a<=s;a++){var l=e+t-a,u=e+r-a,c=t+n-l;if(a!==e&&l>=0&&u>=0&&c>=0){var h=morpheus.FisherExact.phyper(a,l,u,c);h<=i&&(o+=h)}}return Math.min(1,o)},morpheus.FisherExact.toString=function(){return"Fisher Exact Test"},morpheus.FoldChange=function(e,t){return morpheus.Mean(e)/morpheus.Mean(t)},morpheus.FoldChange.toString=function(){return"Fold Change"},morpheus.MeanDifference=function(e,t){return morpheus.Mean(e)-morpheus.Mean(t)},morpheus.MeanDifference.toString=function(){return"Mean Difference"},morpheus.TTest=function(e,t){var r=morpheus.Mean(e),n=morpheus.Mean(t),i=Math.sqrt(morpheus.Variance(e,r)),o=Math.sqrt(morpheus.Variance(t,n)),a=morpheus.CountNonNaN(e),s=morpheus.CountNonNaN(t);return(r-n)/Math.sqrt(i*i/a+o*o/s)},morpheus.TTest.toString=function(){return"T-Test"},morpheus.DegreesOfFreedom=function(e,t,r,n){return(e/r+t/n)*(e/r+t/n)/(e*e/(r*r*(r-1))+t*t/(n*n*(n-1)))},morpheus.Spearman=function(e,t){for(var r=[],n=[],i=0,o=e.size();i<o;i++){var a=e.getValue(i),s=t.getValue(i);isNaN(a)||isNaN(s)||(r.push(a),n.push(s))}var l=morpheus.Ranking(r),u=morpheus.Ranking(n);return morpheus.Pearson(new morpheus.Vector("",l.length).setArray(l),new morpheus.Vector("",u.length).setArray(u))},morpheus.Spearman.toString=function(){return"Spearman rank correlation"},morpheus.WeightedMean=function(e,t){for(var r=0,n=0,i=0,o=t.size();i<o;i++){var a=t.getValue(i);if(!isNaN(a)){var s=Math.abs(e.getValue(i));isNaN(s)||(r+=s*a,n+=s)}}return 0===n?NaN:r/n},morpheus.WeightedMean.toString=function(){return"Weighted average"},morpheus.createOneMinusMatrixValues=function(e){var t=function(t,r){return 1-e.getValue(t.getIndex(),r.getIndex())};return t.toString=function(){return"One minus matrix values (for a precomputed similarity matrix)"},t},morpheus.Pearson=function(e,t){for(var r=0,n=0,i=0,o=0,a=0,s=0,l=0,u=e.size();l<u;l++){var c=e.getValue(l),h=t.getValue(l);isNaN(c)||isNaN(h)||(r+=c,n+=c*c,i+=h,o+=h*h,a+=c*h,s++)}var p=a-r*i/s,d=Math.sqrt((n-r*r/s)*(o-i*i/s));return 0==d?1:p/d},morpheus.Pearson.toString=function(){return"Pearson correlation"},morpheus.Jaccard=function(e,t){for(var r=0,n=0,i=0,o=e.size();i<o;i++){var a=e.getValue(i),s=t.getValue(i);if(!isNaN(a)&&!isNaN(s)){var l=a>0,u=s>0;l&&u?n++:(l||u)&&r++}}return 0===r?1:1-n/r},morpheus.Jaccard.toString=function(){return"Jaccard distance"},morpheus.Cosine=function(e,t){for(var r=0,n=0,i=0,o=0,a=e.size();o<a;o++){var s=e.getValue(o),l=t.getValue(o);isNaN(s)||isNaN(l)||(r+=s*s,n+=l*l,i+=s*l)}return i/Math.sqrt(r*n)},morpheus.Cosine.toString=function(){return"Cosine similarity"},morpheus.Euclidean=function(e,t){for(var r=0,n=0,i=e.size();n<i;++n){var o=e.getValue(n),a=t.getValue(n);isNaN(o)||isNaN(a)||(r+=(o-a)*(o-a))}return Math.sqrt(r)},morpheus.Euclidean.toString=function(){return"Euclidean distance"},morpheus.OneMinusFunction=function(e){var t=function(t,r){return 1-e(t,r)};return t.toString=function(){var t=e.toString();return"One minus "+t[0].toLowerCase()+t.substring(1)},t},morpheus.LinearRegression=function(e,t){for(var r=0,n=0,i=0,o=0,a=0,s=0,l=e.size();s<l;s++){var u=e.getValue(s),c=t.getValue(s);isNaN(u)||isNaN(c)||(r+=u,n+=c,i+=u*u,o+=u*c,a++)}var h=(a*o-r*n)/(a*i-r*r);return{m:h,b:n/a-h*r/a}},morpheus.KendallsCorrelation=function(e,t){function r(e){return e*(e+1)/2}for(var n=[],i=[],o=0,a=e.size();o<a;++o){var s=e.getValue(o),l=t.getValue(o);isNaN(s)||isNaN(l)||(n.push(s),i.push(l))}var u=n.length,c=r(u-1),h=[];for(o=0;o<u;o++)h[o]=[n[o],i[o]];h.sort(function(e,t){var r=e[0],n=t[0],i=r===n?0:r<n?-1:1;return 0!==i?i:(r=e[1])===(n=t[1])?0:r<n?-1:1});var p=0,d=0,f=1,m=1,g=h[0];for(o=1;o<u;o++)(E=h[o])[0]===g[0]?(f++,E[1]===g[1]?m++:(d+=r(m-1),m=1)):(p+=r(f-1),f=1,d+=r(m-1),m=1),g=E;p+=r(f-1),d+=r(m-1);for(var v=0,y=[],b=1;b<u;b<<=1){for(var w=0;w<u;w+=2*b){o=w;for(var x=Math.min(o+b,u),_=x,S=Math.min(_+b,u),C=w;o<x||_<S;)o<x?_<S?(h[o][1]===h[_][1]?0:h[o][1]<h[_][1]?-1:1)<=0?(y[C]=h[o],o++):(y[C]=h[_],_++,v+=x-o):(y[C]=h[o],o++):(y[C]=h[_],_++),C++}var M=h;h=y,y=M}var T=0,A=1;for(g=h[0],o=1;o<u;o++){var E;(E=h[o])[1]===g[1]?A++:(T+=r(A-1),A=1),g=E}var P=(c-p)*(c-(T+=r(A-1)));return(c-p-T+d-2*v)/Math.sqrt(P)},morpheus.KendallsCorrelation.toString=function(){return"Kendall's correlation"},morpheus.ComputedVector=function(e,t,r){morpheus.AbstractVector.call(this,e,t),this.callback=r},morpheus.ComputedVector.prototype={getValue:function(e){return this.callback(e)}},morpheus.Util.extend(morpheus.ComputedVector,morpheus.AbstractVector),morpheus.DatasetAdapter=function(e,t,r){if(null==e)throw"dataset is null";this.dataset=e,this.rowMetadata=t||e.getRowMetadata(),this.columnMetadata=r||e.getColumnMetadata()},morpheus.DatasetAdapter.prototype={getDataset:function(){return this.dataset},getName:function(e){return this.dataset.getName(e)},setName:function(e,t){this.dataset.setName(e,t)},getRowMetadata:function(){return this.rowMetadata},getColumnMetadata:function(){return this.columnMetadata},getRowCount:function(){return this.dataset.getRowCount()},getColumnCount:function(){return this.dataset.getColumnCount()},getValue:function(e,t,r){return this.dataset.getValue(e,t,r)},setValue:function(e,t,r,n){this.dataset.setValue(e,t,r,n)},addSeries:function(e){return this.dataset.addSeries(e)},removeSeries:function(e){this.dataset.removeSeries(e)},getSeriesCount:function(){return this.dataset.getSeriesCount()},getDataType:function(e){return this.dataset.getDataType(e)},toString:function(){return this.dataset.toString()}},morpheus.DatasetColumnView=function(e){this.dataset=e,this.columnIndex=0,this.seriesIndex=0},morpheus.DatasetColumnView.prototype={columnIndex:-1,size:function(){return this.dataset.getRowCount()},getValue:function(e){return this.dataset.getValue(e,this.columnIndex,this.seriesIndex)},setIndex:function(e){return this.columnIndex=e,this},setSeriesIndex:function(e){return this.seriesIndex=e,this}},morpheus.DatasetRowView=function(e){this.dataset=e,this.index=0,this.seriesIndex=0},morpheus.DatasetRowView.prototype={size:function(){return this.dataset.getColumnCount()},getIndex:function(){return this.index},getValue:function(e){return this.dataset.getValue(this.index,e,this.seriesIndex)},setIndex:function(e){return this.index=e,this},setSeriesIndex:function(e){return this.seriesIndex=e,this},setDataset:function(e){return this.dataset=e,this}},morpheus.DatasetSeriesView=function(e,t){morpheus.DatasetAdapter.call(this,e),this.seriesIndices=t},morpheus.DatasetSeriesView.prototype={getValue:function(e,t,r){return r=r||0,this.dataset.getValue(e,t,this.seriesIndices[r])},setValue:function(e,t,r,n){n=n||0,this.dataset.setValue(e,t,r,this.seriesIndices[n])},getName:function(e){return e=e||0,this.dataset.getName(this.seriesIndices[e])},setName:function(e,t){e=e||0,this.dataset.setName(this.seriesIndices[e],t)},addSeries:function(e){var t=this.dataset.addSeries(e);return this.seriesIndices.push(t),t},getSeriesCount:function(){return this.seriesIndices.length},toString:function(){return this.getName()}},morpheus.Util.extend(morpheus.DatasetSeriesView,morpheus.DatasetAdapter),morpheus.DatasetUtil=function(){},morpheus.DatasetUtil.min=function(e,t){t=t||0;for(var r=Number.MAX_VALUE,n=0,i=e.getRowCount();n<i;n++)for(var o=0,a=e.getColumnCount();o<a;o++){var s=e.getValue(n,o,t);isNaN(s)||(r=Math.min(r,s))}return r},morpheus.DatasetUtil.max=function(e,t){t=t||0;for(var r=-Number.MAX_VALUE,n=0,i=e.getRowCount();n<i;n++)for(var o=0,a=e.getColumnCount();o<a;o++){var s=e.getValue(n,o,t);isNaN(s)||(r=Math.max(r,s))}return r},morpheus.DatasetUtil.extensionToReader=new morpheus.Map,morpheus.DatasetUtil.registerDatasetReader=function(e,t){if(morpheus.Util.isArray(e))for(var r=0;r<e.length;r++)morpheus.DatasetUtil.extensionToReader.set(e[r],t);else morpheus.DatasetUtil.extensionToReader.set(e,t)},morpheus.DatasetUtil.registerDatasetReader("maf",function(e){var t=new morpheus.MafFileReader;return e&&e.mafGeneFilter&&t.setGeneFilter(e.mafGeneFilter),t}),morpheus.Util.isNode()&&(morpheus.DatasetUtil.registerDatasetReader("gctx",function(e){return morpheus.Hdf5Reader.getGctxInstance()}),morpheus.DatasetUtil.registerDatasetReader("loom",function(e){return morpheus.Hdf5Reader.getLoomInstance()}),morpheus.DatasetUtil.registerDatasetReader("h5ad",function(e){return morpheus.Hdf5Reader.getH5adInstance()})),morpheus.DatasetUtil.registerDatasetReader("gct",function(e){return new morpheus.GctReader}),morpheus.DatasetUtil.registerDatasetReader("gmt",function(e){return new morpheus.GmtDatasetReader}),morpheus.DatasetUtil.registerDatasetReader(["xlsx","xls"],function(e){return e.interactive?new morpheus.Array2dReaderInteractive:new morpheus.XlsxDatasetReader}),morpheus.DatasetUtil.registerDatasetReader(["segtab","seg"],function(e){return new morpheus.SegTabReader}),morpheus.DatasetUtil.registerDatasetReader(["txt","tsv","csv"],function(e){return e.interactive?new morpheus.Array2dReaderInteractive:new morpheus.TxtReader}),morpheus.DatasetUtil.registerDatasetReader("json",function(e){return new morpheus.JsonDatasetReader}),morpheus.DatasetUtil.registerDatasetReader("mtx",function(e){return new morpheus.MtxReader}),morpheus.DatasetUtil.getDatasetReader=function(e,t){null==t&&(t={});var r=morpheus.DatasetUtil.extensionToReader.get(e);if(null!=r)return r(t)},morpheus.DatasetUtil.readDatasetArray=function(e){var t=[],r=[];return e.forEach(function(e,n){var i=morpheus.DatasetUtil.read(e);r.push(i),i.then(function(e){t[n]=e}).catch(function(t){var r=["Error opening "+morpheus.Util.getFileName(e)+"."];return t.message&&(r.push("<br />Cause: "),r.push(t.message)),Promise.reject(r.join(""))})}),0===r.length?Promise.reject("No datasets specified"):Promise.all(r).then(function(){return Promise.resolve(morpheus.DatasetUtil.join(t,"id"))})},morpheus.DatasetUtil.annotate=function(e){var t=[],r=[],n=e.isColumns;return _.each(e.annotations,function(e,i){if(morpheus.Util.isArray(e.file))r[i]=function(t){(new morpheus.OpenFileTool).annotate({lines:e.file,dataset:t,isColumns:n,metadataName:e.datasetField,fileColumnName:e.fileField,fileColumnNamesToInclude:e.include})};else{var o=morpheus.Util.readLines(e.file);t.push(o);var a=morpheus.Util.getFileName(e.file);o.then(function(t){if(morpheus.Util.endsWith(a,".gmt")){var o=(new morpheus.GmtReader).parseLines(t);r[i]=function(t){(new morpheus.OpenFileTool).annotate(null,t,n,o,e.datasetField,e.fileField)}}else morpheus.Util.endsWith(a,".cls")?r[i]=function(e){(new morpheus.OpenFileTool).annotateCls(null,e,a,n,t)}:r[i]=function(r){(new morpheus.OpenFileTool).annotate({lines:t,dataset:r,isColumns:n,metadataName:e.datasetField,fileColumnName:e.fileField,fileColumnNamesToInclude:e.include,transposed:e.transposed})}})}}),Promise.all(t).then(function(){return r})},morpheus.DatasetUtil.read=function(e,t){return new Promise(function(r,n){null==e&&n("File is null"),null==t&&(t={});var i,o=morpheus.Util.isFile(e),a=morpheus.Util.isString(e),s=t.extension?t.extension:morpheus.Util.getExtension(morpheus.Util.getFileName(e)),l=e.toString();if(""===s&&null!=l&&0===l.indexOf("blob:")||t.clipboard?i=t.interactive?new morpheus.Array2dReaderInteractive:new morpheus.TxtReader:null==(i=morpheus.DatasetUtil.getDatasetReader(s,t))&&(i=o?t.interactive?new morpheus.Array2dReaderInteractive:new morpheus.TxtReader:new morpheus.GctReader),a||o)if(t.background){var u=morpheus.Util.getScriptPath(),c=new Blob(["self.onmessage = function(e) {importScripts(e.data.path);var ext = morpheus.Util.getExtension(morpheus.Util.getFileName(e.data.fileOrUrl));var datasetReader = morpheus.DatasetUtil.getDatasetReader(ext,\te.data.options);datasetReader.read(e.data.fileOrUrl, function(err,dataset) {\tself.postMessage(dataset);\t});}"]),h=window.URL.createObjectURL(c),p=new Worker(h);p.addEventListener("message",function(e){r(morpheus.Dataset.fromJSON(e.data)),window.URL.revokeObjectURL(h)},!1),p.postMessage({path:u,fileOrUrl:e,options:t})}else i.read(e,function(e,t){e?n(e):r(t)});else{if("function"==typeof e.then)return r(e);e.getRowCount?r(e):r(morpheus.Dataset.fromJSON(e))}})},morpheus.DatasetUtil.toObjectArray=function(e,t){var r=t.columns||[0],n=t.columnFields||["value"];if(n.length!==r.length)throw"columns.length !== columnFields.length";var i=t.metadataFields,o=e.getRowMetadata();i||(i=morpheus.MetadataUtil.getMetadataNames(o));for(var a=morpheus.MetadataUtil.getVectors(o,i),s=[],l=0;l<e.getRowCount();l++){for(var u={},c=0;c<r.length;c++)u[n[c]]=e.getValue(l,r[c]);for(c=0;c<a.length;c++)u[a[c].getName()]=a[c].getValue(l);s.push(u)}return s},morpheus.DatasetUtil.geneSetsToDataset=function(e,t){for(var r=new morpheus.Map,n=0,i=t.length;n<i;n++)for(var o=0,a=(d=t[n].ids).length;o<a;o++)r.set(d[o],1);var s=r.keys(),l=new morpheus.Dataset({name:e,rows:s.length,columns:t.length}),u=l.getColumnMetadata().add("id");for(n=0,i=t.length;n<i;n++)u.setValue(n,t[n].name);for(var c=l.getRowMetadata().add("id"),h=(n=0,s.length);n<h;n++)c.setValue(n,s[n]);var p=morpheus.VectorUtil.createValueToIndexMap(c);for(n=0,i=t.length;n<i;n++){var d;for(o=0,a=(d=t[n].ids).length;o<a;o++)l.setValue(p.get(d[o]),n,1)}return l},morpheus.DatasetUtil.getRootDataset=function(e){for(;e.getDataset;)e=e.getDataset();return e},morpheus.DatasetUtil.getSeriesIndex=function(e,t){for(var r=0,n=e.getSeriesCount();r<n;r++)if(t===e.getName(r))return r;return-1},morpheus.DatasetUtil.getSeriesNames=function(e){for(var t=[],r=0,n=e.getSeriesCount();r<n;r++)t.push(e.getName(r));return t},morpheus.DatasetUtil.searchValues=function(e){if(""!==r){var t=e.dataset,r=e.text,n=morpheus.Util.getAutocompleteTokens(r);if(0!=n.length){for(var i=morpheus.Util.createSearchPredicates({tokens:n,defaultMatchMode:e.defaultMatchMode}),o=!0===e.matchAllPredicates,a=i.length,s=new morpheus.Set,l=0,u=t.getRowCount();l<u;l++)for(var c=0,h=t.getColumnCount();c<h;c++){var p=!1;e:if(o){p=!0;for(var d=0;d<a;d++){for(var f=i[d],m=!1,g=0,v=t.getSeriesCount();g<v;g++){if((b=null!=(y=t.getValue(l,c,g))&&null!=y.toObject)&&(y=y.toObject()),w(y,b,f)){m=!0;break}}if(!m){p=!1;break e}}}else for(g=0,v=t.getSeriesCount();g<v;g++){var y,b;(b=null!=(y=t.getValue(l,c,g))&&null!=y.toObject)&&(y=y.toObject());for(d=0;d<a;d++){if(w(y,b,f=i[d])){p=!0;break e}}}p&&s.add(new morpheus.Identifier([l,c]))}return s}}function w(e,r,n){if(null!=e)if(r){if(null!=(a=n.getField())){var i=e[a];return n.accept(i)}for(var o in e){i=e[o];return n.accept(i)}}else{var a;if(null==(a=n.getField())||a===t.getName(g))return n.accept(e)}}},morpheus.DatasetUtil.autocompleteValues=function(e){return function(t,r){var n=null!=t&&t.length>0?t[t.selectionStartIndex]:"";n=$.trim(n);for(var i,o=[],a=0,s=e.getRowCount();a<s;a++)for(var l=0,u=e.getSeriesCount();l<u;l++)"Number"===e.getDataType(a,l)&&o.push([a,l]);if(0===o.length)return r();e:for(l=0,u=o.length;l<u;l++)for(var c=o[l],h=0,p=e.getColumnCount();h<p;h++){if(null!=(w=e.getValue(c[0],h,c[1]))&&w.toObject){i=w.toObject();break e}}var d=[],f=null==i?[]:_.keys(i);if(""===n)return f.sort(function(e,t){return e===t?0:e<t?-1:1}),f.forEach(function(e){d.push({value:e+":",label:'<span style="font-weight:300;">'+e+":</span>",show:!0})}),r(d);var m=null,g=n.indexOf(":");if(g>0&&92!==n.charCodeAt(g-1)){var v=$.trim(n.substring(0,g));v.length>0&&'"'===v[0]&&'"'===v[n.length-1]&&(v=v.substring(1,v.length-1)),-1!==f.indexOf(v)&&(n=$.trim(n.substring(g+1)),m=v)}var y=new morpheus.Set,b=new RegExp("^"+morpheus.Util.escapeRegex(n),"i");e:for(l=0,u=o.length;l<u;l++)for(c=o[l],h=0,p=e.getColumnCount();h<p;h++){var w;if((w=e.getValue(c[0],h,c[1]))&&w.toObject){var x=w.toObject();if(null!==m){if(null!=(M=x[m])){var S=new morpheus.Identifier([M,m]);if(!y.has(S)&&b.test(M)&&(y.add(S),10===y.size()))break e}}else for(var C in x){var M=x[C];S=new morpheus.Identifier([M,C]);if(!y.has(S)&&b.test(M)&&(y.add(S),10===y.size()))break e}}}y.forEach(function(e){var t=e.getArray(),r=t[1],n=t[0];d.push({value:r+":"+n,label:'<span style="font-weight:300;">'+r+':</span><span style="font-weight:900;">'+n+"</span>"})}),null==m&&f.forEach(function(e){b.test(e)&&d.push({value:e+":",label:'<span style="font-weight:300;">'+e+":</span>",show:!0})}),r(d)}},morpheus.DatasetUtil.fill=function(e,t,r){r=r||0;for(var n=0,i=e.getRowCount(),o=e.getColumnCount();n<i;n++)for(var a=0;a<o;a++)e.setValue(n,a,t,r)},morpheus.DatasetUtil.overlay=function(e){for(var t=e.dataset,r=e.newDataset,n=e.rowAnnotationName,i=e.columnAnnotationName,o=e.newRowAnnotationName,a=e.newColumnAnnotationName,s=morpheus.VectorUtil.createValueToIndexMap(t.getRowMetadata().getByName(n)),l=morpheus.VectorUtil.createValueToIndexMap(t.getColumnMetadata().getByName(i)),u=t.addSeries({name:r.getName(),dataType:r.getDataType(0)}),c=r.getRowMetadata().getByName(o),h=[],p=[],d=0,f=c.size();d<f;d++){void 0!==(y=s.get(c.getValue(d)))&&(h.push(y),p.push(d))}var m=r.getColumnMetadata().getByName(a),g=[],v=[];for(d=0,f=m.size();d<f;d++){var y;void 0!==(y=l.get(m.getValue(d)))&&(g.push(y),v.push(d))}d=0;for(var b=(r=new morpheus.SlicedDatasetView(r,p,v)).getRowCount();d<b;d++)for(var w=0,x=r.getColumnCount();w<x;w++)t.setValue(h[d],g[w],r.getValue(d,w),u)},morpheus.DatasetUtil.join=function(e,t){if(0===e.length)throw"No datasets";if(1===e.length){for(var r=e[0].getName(),n=e[0].getRowMetadata().add("Source"),i=0,o=n.size();i<o;i++)n.setValue(i,r);return e[0]}var a=new morpheus.Set;for(i=0;i<e.length;i++){var s=e[i].getColumnMetadata().getByName(t),l=0;for(o=s.size();l<o;l++)a.add(s.getValue(l))}var u=new morpheus.Dataset({rows:0,columns:a.size(),name:e[0].getName()}),c=u.getColumnMetadata().add(t),h=0;a.forEach(function(e){c.setValue(h++,e)});var p=new morpheus.JoinedDataset(u,e[0],t,t);for(i=1;i<e.length;i++)p=new morpheus.JoinedDataset(p,e[i],t,t);return p},morpheus.DatasetUtil.shallowCopy=function(e){var t=morpheus.MetadataUtil.shallowCopy(e.getRowMetadata()),r=morpheus.MetadataUtil.shallowCopy(e.getColumnMetadata());return e.getRowMetadata=function(){return t},e.getColumnMetadata=function(){return r},e},morpheus.DatasetUtil.copy=function(e){for(var t=new morpheus.Dataset({name:e.getName(),rows:e.getRowCount(),columns:e.getColumnCount(),dataType:e.getDataType(0)}),r=0,n=e.getSeriesCount();r<n;r++){r>0&&t.addSeries({name:e.getName(r),rows:e.getRowCount(),columns:e.getColumnCount(),dataType:e.getDataType(r)});for(var i=0,o=e.getRowCount(),a=e.getColumnCount();i<o;i++)for(var s=0;s<a;s++)t.setValue(i,s,e.getValue(i,s,r),r)}var l=morpheus.MetadataUtil.shallowCopy(e.getRowMetadata()),u=morpheus.MetadataUtil.shallowCopy(e.getColumnMetadata());return t.getRowMetadata=function(){return l},t.getColumnMetadata=function(){return u},t},morpheus.DatasetUtil.toString=function(e,t,r){r=r||0;for(var n=[],i=0,o=e.getRowCount(),a=e.getColumnCount();i<o;i++){for(var s=0;s<a;s++)s>0&&n.push(", "),n.push(morpheus.Util.nf(e.getValue(i,s,r)));n.push("\n")}return n.join("")},morpheus.DatasetUtil.getNonEmptyRows=function(e){for(var t=[],r=0,n=e.getRowCount();r<n;r++){for(var i=!1,o=0,a=e.getColumnCount();o<a;o++){var s=e.getValue(r,o);if(!isNaN(s)){i=!0;break}}i&&t.push(r)}return t},morpheus.Dataset=function(e){morpheus.AbstractDataset.call(this,e.rows,e.columns),null==e.dataType&&(e.dataType="Float32"),this.seriesNames.push(e.name),this.seriesArrays.push(morpheus.Dataset.createMatrix(e)),this.seriesDataTypes.push(e.dataType)},morpheus.Dataset.toJSON=function(e,t){var r=[],n=[],i=[],o=(t=t||{}).seriesIndices;null==o&&(o=morpheus.Util.sequ32(e.getSeriesCount()));for(var a=0;a<o.length;a++){var s=o[a];i.push(e.getName(s)),n.push(e.getDataType(s));var l=[];r.push(l);for(var u=0,c=e.getRowCount();u<c;u++){var h=[];l.push(h);for(var p=0,d=e.getColumnCount();p<d;p++)h[p]=e.getValue(u,p,s)}}var f=function(e){for(var t=[],r=0,n=e.size();r<n;r++)t[r]=e.getValue(r);var i=new morpheus.Map;return e.getProperties().forEach(function(e,t){morpheus.VectorKeys.JSON_WHITELIST.has(t)&&i.set(t,e)}),{properties:i,name:e.getName(),array:t}},m=function(e,t){var r,n=[];t&&(r=new morpheus.Set,t.forEach(function(e){r.add(e)}));for(var i=0,o=e.getMetadataCount();i<o;i++){var a=e.get(i);a.getProperties().has(morpheus.VectorKeys.IS_INDEX)||(r?r.has(a.getName())&&n.push(f(a)):n.push(f(a)))}return n};return{rows:e.getRowCount(),columns:e.getColumnCount(),seriesArrays:r,seriesDataTypes:n,seriesNames:i,rowMetadataModel:{vectors:m(e.getRowMetadata(),t.rowFields)},columnMetadataModel:{vectors:m(e.getColumnMetadata(),t.columnFields)}}},morpheus.Dataset.fromJSON=function(e){for(var t=0;t<e.seriesArrays.length;t++)for(var r=e.seriesArrays[t],n=0;n<e.rows;n++)for(var i=0;i<e.columns;i++){null==r[n][i]&&(r[n][i]=NaN)}var o=new morpheus.Dataset({name:e.seriesNames[0],dataType:e.seriesDataTypes[0],array:e.seriesArrays[0],rows:e.rows,columns:e.columns});e.rowMetadataModel&&e.rowMetadataModel.vectors.forEach(function(e){var t=new morpheus.Vector(e.name,o.getRowCount());t.array=e.array,t.properties=morpheus.Map.fromJSON(e.properties),o.rowMetadataModel.vectors.push(t)}),e.columnMetadataModel&&e.columnMetadataModel.vectors.forEach(function(e){var t=new morpheus.Vector(e.name,o.getColumnCount());t.array=e.array,t.properties=morpheus.Map.fromJSON(e.properties),o.columnMetadataModel.vectors.push(t)});for(n=1;n<e.seriesArrays.length;n++)o.addSeries({name:e.seriesNames[n],dataType:e.seriesDataTypes[n],array:e.seriesArrays[n]});return o},morpheus.Matrix1DFileBacked=function(e){},morpheus.Matrix1DFileBacked.prototype={setValue:function(e,t,r){throw new Error("Unsupported operation.")},toJSON:function(){for(var e=[],t=this.options.rows,r=this.options.columns,n=(this.options.array,0);n<t;n++){var i=[];e.push(i);for(var o=0;o<r;o++)i[o]=this.getValue(n,o)}return e}},morpheus.ColumnMajorMatrix1D=function(e){this.options=e},morpheus.ColumnMajorMatrix1D.prototype={getValue:function(e,t){return this.options.array[t*this.options.rows+e]},setValue:function(e,t,r){this.options.array[t*this.options.rows+e]=r},toJSON:function(){for(var e=[],t=this.options.rows,r=this.options.columns,n=(this.options.array,0);n<t;n++){var i=[];e.push(i);for(var o=0;o<r;o++)i[o]=this.getValue(n,o)}return e}},morpheus.RowMajorMatrix1D=function(e){this.options=e},morpheus.RowMajorMatrix1D.prototype={getValue:function(e,t){return this.options.array[e*this.options.columns+t]},setValue:function(e,t,r){this.options.array[e*this.options.columns+t]=r},toJSON:function(){for(var e=[],t=this.options.rows,r=this.options.columns,n=(this.options.array,0);n<t;n++){var i=[];e.push(i);for(var o=0;o<r;o++)i[o]=this.getValue(n,o)}return e}},morpheus.RowMajorMatrix=function(e){this.options=e},morpheus.RowMajorMatrix.prototype={getValue:function(e,t){return this.options.array[e][t]},setValue:function(e,t,r){this.options.array[e][t]=r},toJSON:function(){for(var e=[],t=this.options.rows,r=this.options.columns,n=this.options.array,i=0;i<t;i++){var o=[];e.push(o);for(var a=0;a<r;a++)o[a]=n[i][a]}return e}},morpheus.SparseMatrix=function(e){this.options=e},morpheus.SparseMatrix.binarySearch=function(e,t,r,n){for(var i,o;r<=n;)if((o=e[i=(r+n)/2|0])<t)r=i+1;else{if(!(o>t))return i;n=i-1}return-1},morpheus.SparseMatrix.prototype={getValue:function(e,t){var r=this.options.array[e];if(void 0===r.values)return this.options.defaultValue;var n=morpheus.SparseMatrix.binarySearch(r.indices,t,0,r.values.length-1);return n>=0?r.values[n]:this.options.defaultValue},setValue:function(e,t,r){var n=this.options.array[e];if(void 0===n.values)throw"Invalid index";var i=morpheus.SparseMatrix.binarySearch(n.indices,t,0,n.values.length-1);if(i<0)throw"Invalid index";n.values[i]=r}},morpheus.Dataset.createMatrix=function(e){if(e.array)return null!=e.defaultValue?new morpheus.SparseMatrix(e):"1d_backed"===e.type?new morpheus.Matrix1DFileBacked(e):"1d"===e.type?e.columnMajorOrder?new morpheus.ColumnMajorMatrix1D(e):new morpheus.RowMajorMatrix1D(e):new morpheus.RowMajorMatrix(e);var t=[];if(null==e.dataType||"Float32"===e.dataType)for(var r=0;r<e.rows;r++)t.push(new Float32Array(e.columns));else if("Int8"===e.dataType)for(r=0;r<e.rows;r++)t.push(new Int8Array(e.columns));else if("Int16"===e.dataType)for(r=0;r<e.rows;r++)t.push(new Int16Array(e.columns));else for(r=0;r<e.rows;r++)t.push([]);return e.array=t,new morpheus.RowMajorMatrix(e)},morpheus.Dataset.prototype={getValue:function(e,t,r){return r=r||0,this.seriesArrays[r].getValue(e,t)},toString:function(){return this.getName()},setValue:function(e,t,r,n){n=n||0,this.seriesArrays[n].setValue(e,t,r)},addSeries:function(e){return e=$.extend({},{rows:this.getRowCount(),columns:this.getColumnCount(),dataType:"Float32"},e),this.seriesDataTypes.push(e.dataType),this.seriesNames.push(e.name),this.seriesArrays.push(morpheus.Dataset.createMatrix(e)),this.seriesNames.length-1}},morpheus.Util.extend(morpheus.Dataset,morpheus.AbstractDataset),morpheus.ElementSelectionModel=function(e){this.viewIndices=new morpheus.Set,this.project=e},morpheus.ElementSelectionModel.prototype={click:function(e,t,r){var n=new morpheus.Identifier([e,t]),i=this.viewIndices.has(n);r?i?this.viewIndices.remove(n):this.viewIndices.add(n):(this.viewIndices.clear(),i||this.viewIndices.add(n)),this.trigger("selectionChanged")},getProject:function(){return this.project},setViewIndices:function(e){this.viewIndices=e,this.trigger("selectionChanged")},clear:function(){this.viewIndices=new morpheus.Set},getViewIndices:function(){return this.viewIndices},count:function(){return this.viewIndices.size()},toModelIndices:function(){var e=this.project,t=[];return this.viewIndices.forEach(function(r){t.push(e.convertViewRowIndexToModel(r.getArray()[0]),e.convertViewColumnIndexToModel(r.getArray()[1]))}),t},save:function(){this.modelIndices=this.toModelIndices()},restore:function(){var e=this.project;this.viewIndices=new morpheus.Set;for(var t=0,r=this.modelIndices.length;t<r;t++){var n=e.convertModelRowIndexToView(this.modelIndices[t][0]),i=e.convertModelColumnIndexToView(this.modelIndices[t][1]);-1!==n&&-1!==i&&this.viewIndices.add(new morpheus.Identifier([n,i]))}}},morpheus.Util.extend(morpheus.ElementSelectionModel,morpheus.Events),morpheus.CombinedFilter=function(e){this.filters=[],this.isAndFilter=e,this.enabledFilters=[],this.name="combined filter"},morpheus.CombinedFilter.prototype={shallowClone:function(){var e=new morpheus.CombinedFilter(this.isAndFilter);return e.filters=this.filters.slice(0),e},isColumns:function(){return this.filters[0].isColumns()},toString:function(){return this.name},setAnd:function(e,t){this.isAndFilter=e,t&&this.trigger("and",{})},isAnd:function(){return this.isAndFilter},equals:function(e){if(!(e instanceof morpheus.CombinedFilter))return!1;if(this.isAndFilter!==e.isAndFilter)return!1;if(this.filters.length!==e.filters.length)return!1;for(var t=0,r=this.filters.length;t<r;t++)if(!this.filters[t].equals(e.filters[t]))return!1;return!0},add:function(e,t){null!=e&&(this.filters.push(e),t&&this.trigger("add",{filter:e}))},getFilters:function(){return this.filters},get:function(e){return this.filters[e]},indexOf:function(e,t){for(var r=0,n=this.filters.length;r<n;r++)if(this.filters[r].toString()===e&&(null==t||this.filters[r]instanceof t))return r;return-1},remove:function(e,t){this.filters.splice(e,1),t&&this.trigger("remove",{index:e})},set:function(e,t){this.filters[e]=t},insert:function(e,t){this.filters.splice(e,0,t)},clear:function(){this.filters=[]},init:function(e){for(var t=0,r=this.filters.length;t<r;t++)this.filters[t].isColumns()?this.filters[t].init(new morpheus.TransposedDatasetView(e)):this.filters[t].init(e);this.enabledFilters=this.filters.filter(function(e){return e.isEnabled()})},accept:function(e){var t=this.enabledFilters;if(this.isAndFilter){for(var r=0,n=t.length;r<n;r++)if(!1===t[r].accept(e))return!1;return!0}for(r=0,n=t.length;r<n;r++)if(t[r].accept(e))return!0;return!1},isEnabled:function(){return this.enabledFilters.length>0}},morpheus.Util.extend(morpheus.CombinedFilter,morpheus.Events),morpheus.IndexFilter=function(e,t,r){this.acceptIndicesSet=e,this.name=t,this.columns=r},morpheus.IndexFilter.prototype={enabled:!0,isColumns:function(){return this.columns},isEnabled:function(){return this.enabled},setAcceptIndicesSet:function(e){this.acceptIndicesSet=e},setEnabled:function(e){this.enabled=e},equals:function(e){return e instanceof morpheus.IndexFilter&&this.acceptIndicesSet.equals(e.acceptIndicesSet)},init:function(e){},toString:function(){return this.name},accept:function(e){return this.acceptIndicesSet.has(e)}},morpheus.VectorFilter=function(e,t,r,n){this.set=e,this.name=r,this.maxSetSize=t,this.columns=n},morpheus.VectorFilter.prototype={enabled:!0,isColumns:function(){return this.columns},isEnabled:function(){return this.enabled&&this.set.size()>0&&this.set.size()!==this.maxSetSize&&null!=this.vector},setEnabled:function(e){this.enabled=e},equals:function(e){return e instanceof morpheus.VectorFilter&&this.name===e.name},init:function(e){this.vector=e.getRowMetadata().getByName(this.name)},toString:function(){return this.name},accept:function(e){return this.set.has(this.vector.getValue(e))}},morpheus.NotNullFilter=function(e,t){this.name=e,this.columns=t},morpheus.NotNullFilter.prototype={enabled:!0,isColumns:function(){return this.columns},isEnabled:function(){return this.enabled&&null!=this.vector},setEnabled:function(e){this.enabled=e},equals:function(e){return e instanceof morpheus.NotNullFilter&&this.name===e.name},init:function(e){this.vector=e.getRowMetadata().getByName(this.name)},toString:function(){return this.name},accept:function(e){return null!=this.vector.getValue(e)}},morpheus.RangeFilter=function(e,t,r,n){this.min=e,this.max=t,this.name=r,this.columns=n},morpheus.RangeFilter.prototype={enabled:!0,isColumns:function(){return this.columns},isEnabled:function(){return this.enabled&&(!isNaN(this.min)||!isNaN(this.max))&&this.vector},setEnabled:function(e){this.enabled=e},setMin:function(e){this.min=isNaN(e)?-Number.MAX_VALUE:e},setMax:function(e){this.max=isNaN(e)?Number.MAX_VALUE:e},equals:function(e){return e instanceof morpheus.RangeFilter&&this.name===e.name},init:function(e){this.vector=e.getRowMetadata().getByName(this.name)},toString:function(){return this.name},accept:function(e){var t=this.vector.getValue(e);return t>=this.min&&t<=this.max}},morpheus.TopNFilter=function(e,t,r,n){this.n=e,this.direction=t,this.name=r,this.columns=n},morpheus.TopNFilter.TOP=0,morpheus.TopNFilter.BOTTOM=1,morpheus.TopNFilter.TOP_BOTTOM=2,morpheus.TopNFilter.prototype={enabled:!0,isColumns:function(){return this.columns},isEnabled:function(){return this.enabled&&this.n>0&&this.vector},setEnabled:function(e){this.enabled=e},setN:function(e){this.n=e},setDirection:function(e){this.direction=e},equals:function(e){return e instanceof morpheus.TopNFilter&&this.name===e.name&&this.n===e.n&&this.direction===e.direction},init:function(e){if(!this.vector||this.vector!==e.getRowMetadata().getByName(this.name)){var t=e.getRowMetadata().getByName(this.name);null==t&&(t={getValue:function(){},size:function(){return 0}}),this.vector=t;for(var r=new morpheus.Set,n=0,i=t.size();n<i;n++){var o=t.getValue(n);isNaN(o)||r.add(o)}var a=r.values();a.sort(function(e,t){return e===t?0:e<t?-1:1}),this.sortedValues=a}var s=[this.sortedValues.length-this.n,this.n-1];for(n=0;n<s.length;n++)s[n]=Math.max(0,s[n]),s[n]=Math.min(this.sortedValues.length-1,s[n]);var l=[this.sortedValues[s[0]],this.sortedValues[s[1]]];this.direction===morpheus.TopNFilter.TOP?this.f=function(e){return!isNaN(e)&&e>=l[0]}:this.direction===morpheus.TopNFilter.BOTTOM?this.f=function(e){return!isNaN(e)&&e<=l[1]}:this.f=function(e){return!isNaN(e)&&(e>=l[0]||e<=l[1])}},accept:function(e){return this.f(this.vector.getValue(e))},toString:function(){return this.name}},morpheus.AlwaysTrueFilter=function(e){this.isColumns=e},morpheus.AlwaysTrueFilter.prototype={isEnabled:function(){return!1},isColumns:function(){return this.isColumns},setEnabled:function(e){},equals:function(e){return e instanceof morpheus.AlwaysTrueFilter},init:function(e){},toString:function(){return"AlwaysTrue"},accept:function(e){return!0}},morpheus.CombinedFilter.fromJSON=function(e,t){e.setAnd(t.isAnd),t.filters.forEach(function(t){var r=null!=t.name?t.name:t.field;if("set"===t.type){var n=new morpheus.Set;t.values.forEach(function(e){n.add(e)}),e.add(new morpheus.VectorFilter(n,t.maxSetSize,r,t.isColumns))}else if("range"===t.type)e.add(new morpheus.RangeFilter(t.min,t.max,r,t.isColumns));else if("top"===t.type)_.isString(t.direction)&&("top"===t.direction?t.direction=morpheus.TopNFilter.TOP:"bottom"===t.direction?t.direction=morpheus.TopNFilter.BOTTOM:"topAndBottom"===t.direction&&(t.direction=morpheus.TopNFilter.TOP_BOTTOM)),e.add(new morpheus.TopNFilter(t.n,t.direction,r,t.isColumns));else if("index"===t.type){n=new morpheus.Set;t.indices.forEach(function(e){n.add(e)}),e.add(new morpheus.IndexFilter(n,r,t.isColumns))}else console.log("Unknown filter type")})},morpheus.CombinedFilter.toJSON=function(e){var t={isAnd:e.isAnd(),filters:[]};return e.getFilters().forEach(function(e){e.isEnabled()&&(e instanceof morpheus.VectorFilter?t.filters.push({name:e.name,isColumns:e.isColumns(),values:e.set.values(),maxSetSize:e.maxSetSize,type:"set"}):e instanceof morpheus.RangeFilter?t.filters.push({name:e.name,isColumns:e.isColumns(),min:e.min,max:e.max,type:"range"}):e instanceof morpheus.TopNFilter?t.filters.push({name:e.name,isColumns:e.isColumns(),n:e.n,direction:e.direction,type:"top"}):e instanceof morpheus.IndexFilter&&t.filters.push({name:e.name,isColumns:e.isColumns(),indices:e.acceptIndicesSet.values(),type:"index"}))}),t},morpheus.IndexMapper=function(e,t){this.project=e,this.isRows=t,this.sortKeys=[],this.modelToView=null,this.filteredModelIndices=null,this.filteredSortedModelIndices=null,this.filter=new morpheus.CombinedFilter(!0),this._filter(),this._sort()},morpheus.IndexMapper.prototype={convertModelIndexToView:function(e){var t=this.modelToView.get(e);return void 0!==t?t:-1},convertViewIndexToModel:function(e){return e<this.filteredSortedModelIndices.length&&e>=0?this.filteredSortedModelIndices[e]:-1},convertToView:function(){return this.filteredSortedModelIndices},setFilter:function(e){this.filter=e,this._filter(),this._sort()},_filter:function(){var e,t=this.filter,r=this.project.getFullDataset(),n=this.isRows?r.getRowCount():r.getColumnCount();if(null!=t&&(t.init(r),t.isEnabled())){e=[];for(var i=0;i<n;i++)t.accept(i)&&e.push(i)}this.filteredModelIndices=null!=e?e:morpheus.Util.seq(n)},_sort:function(){var e=this.sortKeys;if(e.length>0){for(var t=this.project.getFullDataset(),r=e.length,n=0;n<r;n++)e[n].init(e[n].isColumns()?new morpheus.TransposedDatasetView(t):t,this.filteredSortedModelIndices);this.filteredSortedModelIndices=this.filteredModelIndices.slice(0),this.filteredSortedModelIndices.sort(function(t,n){for(var i=0;i<r;i++){var o=e[i],a=o.getComparator()(o.getValue(t),o.getValue(n));if(0!==a)return a}return 0})}else this.filteredSortedModelIndices=this.filteredModelIndices;for(var i=new morpheus.Map,o=(n=0,this.filteredSortedModelIndices.length);n<o;n++)i.set(this.filteredSortedModelIndices[n],n);this.modelToView=i},getFilter:function(){return this.filter},getViewCount:function(){return null==this.project.getFullDataset()?0:this.filteredSortedModelIndices.length},setSelectedModelIndices:function(e){this.selectionModel.setSelectedModelIndices(e)},setSortKeys:function(e){null==e&&(e=[]),this.sortKeys=e,this._sort()}},morpheus.JoinedDataset=function(e,t,r,n,i){if(i=i||"Source",this.dataset1Field=r,this.dataset2Field=n,null==e)throw"dataset1 is null";if(null==t)throw"dataset2 is null";if(r){for(var o=e.getColumnMetadata().getByName(r),a=morpheus.VectorUtil.createValueToIndexMap(t.getColumnMetadata().getByName(n)),s=[],l=0;l<o.size();l++)s[l]=a.get(o.getValue(l));t=new morpheus.SlicedDatasetWithNulls(t,s,e.getColumnCount(),e.getColumnMetadata())}if(!e.getRowMetadata().getByName(i))for(var u=e.getRowMetadata().add(i),c=e.getName(),h=(l=0,u.size());l<h;l++)u.setValue(l,c);if(!t.getRowMetadata().getByName(i))for(u=t.getRowMetadata().add(i),c=t.getName(),l=0,h=u.size();l<h;l++)u.setValue(l,c);l=0;for(var p=e.getRowMetadata().getMetadataCount();l<p;l++){c=e.getRowMetadata().get(l).getName();null==t.getRowMetadata().getByName(c)&&t.getRowMetadata().add(c)}for(l=0,p=t.getRowMetadata().getMetadataCount();l<p;l++){c=t.getRowMetadata().get(l).getName();null==e.getRowMetadata().getByName(c)&&e.getRowMetadata().add(c)}var d=[],f=!1;for(l=0,p=e.getRowMetadata().getMetadataCount();l<p;l++){c=e.getRowMetadata().get(l).getName();var m=morpheus.MetadataUtil.indexOf(t.getRowMetadata(),c);d.push(m),m!==l&&(f=!0)}this.dataset1=e,this.dataset2=t;var g=Math.max(this.dataset1.getSeriesCount(),this.dataset2.getSeriesCount());for(l=this.dataset1.getSeriesCount();l<g;l++)this.dataset1.addSeries({name:this.dataset2.getName(l)});for(l=this.dataset2.getSeriesCount();l<g;l++)this.dataset2.addSeries({name:this.dataset1.getName(l)});this.rowMetadata=new morpheus.JoinedMetadataModel(this.dataset1.getRowMetadata(),f?new morpheus.MetadataModelColumnView(this.dataset2.getRowMetadata(),d):this.dataset2.getRowMetadata())},morpheus.JoinedDataset.prototype={getName:function(e){return this.dataset1.getName(e)},setName:function(e,t){this.dataset1.setName(e,t)},getDataType:function(e){return this.dataset1.getDataType(e)},getDatasets:function(){return[this.dataset1,this.dataset2]},getDataset1:function(){return this.dataset1},getRowMetadata:function(){return this.rowMetadata},getColumnMetadata:function(){return this.dataset1.getColumnMetadata()},getRowCount:function(){return this.dataset1.getRowCount()+this.dataset2.getRowCount()},getColumnCount:function(){return this.dataset1.getColumnCount()},getValue:function(e,t,r){return e<this.dataset1.getRowCount()?this.dataset1.getValue(e,t,r):this.dataset2.getValue(e-this.dataset1.getRowCount(),t,r)},setValue:function(e,t,r,n){e<this.dataset1.getRowCount()?this.dataset1.setValue(e,t,r,n):this.dataset2.setValue(e-this.dataset1.getRowCount(),t,r,n)},getSeriesCount:function(){return this.dataset1.getSeriesCount()},addSeries:function(e){return this.dataset1.addSeries(e),this.dataset2.addSeries(e)},removeSeries:function(e){this.dataset1.removeSeries(e),this.dataset2.removeSeries(e)},toString:function(){return this.getName()}},morpheus.SlicedDatasetWithNulls=function(e,t,r,n){morpheus.DatasetAdapter.call(this,e),this.columnIndices=t,this.columnCount=r,this.columnMetadata=n},morpheus.SlicedDatasetWithNulls.prototype={getColumnMetadata:function(){return this.columnMetadata},getColumnCount:function(){return this.columnCount},getValue:function(e,t,r){var n=this.columnIndices[t];return void 0===n?void 0:this.dataset.getValue(e,n,r)},setValue:function(e,t,r,n){var i=this.columnIndices[t];void 0!==i?this.dataset.setValue(e,i,r,n):console.log(t+" out of range")}},morpheus.Util.extend(morpheus.SlicedDatasetWithNulls,morpheus.DatasetAdapter),morpheus.JoinedVector=function(e,t){this.v1=e,this.v2=t,morpheus.VectorAdapter.call(this,e),this.properties=new morpheus.Map},morpheus.JoinedVector.prototype={setValue:function(e,t){e<this.v1.size()?this.v1.setValue(e,t):this.v2.setValue(e-this.v1.size(),t)},getValue:function(e){return e<this.v1.size()?this.v1.getValue(e):this.v2.getValue(e-this.v1.size())},size:function(){return this.v1.size()+this.v2.size()},getProperties:function(){return this.properties}},morpheus.Util.extend(morpheus.JoinedVector,morpheus.VectorAdapter),morpheus.JoinedMetadataModel=function(e,t){this.m1=e,this.m2=t,this.vectors=[];for(var r=0,n=e.getMetadataCount();r<n;r++){var i=this.m1.get(r),o=this.m2.get(r),a=new morpheus.JoinedVector(i,o);i.getProperties().forEach(function(e,t){morpheus.VectorKeys.COPY_IGNORE.has(t)||a.properties.set(t,e)}),o.getProperties().forEach(function(e,t){morpheus.VectorKeys.COPY_IGNORE.has(t)||a.properties.set(t,e)}),this.vectors.push(a)}},morpheus.JoinedMetadataModel.prototype={add:function(e){var t,r=morpheus.MetadataUtil.indexOf(this,e);-1!==r&&(t=this.remove(r));var n=new morpheus.Vector(e,this.getItemCount());if(null!=t){t.getProperties().forEach(function(e,t){n.getProperties().set(t,e)});for(var i=0,o=t.size();i<o;i++)n.setValue(i,t.getValue(i))}return this.vectors.push(n),n},getItemCount:function(){return this.m1.getItemCount()+this.m2.getItemCount()},get:function(e){return this.vectors[e]},remove:function(e){return this.vectors.splice(e,1)[0]},getByName:function(e){for(var t=0,r=this.vectors.length;t<r;t++)if(e===this.vectors[t].getName())return this.vectors[t]},getMetadataCount:function(){return this.vectors.length}},morpheus.MetadataModelAdapter=function(e){this.model=e},morpheus.MetadataModelAdapter.prototype={add:function(e){return this.model.add(e)},getItemCount:function(){return this.model.getItemCount()},get:function(e){return this.model.get(e)},remove:function(e){return this.model.remove(e)},getByName:function(e){return this.model.getByName(e)},getMetadataCount:function(){return this.model.getMetadataCount()}},morpheus.MetadataModelColumnView=function(e,t){this.model=e,this.indices=t},morpheus.MetadataModelColumnView.prototype={add:function(e){var t=this.model.add(e),r=morpheus.MetadataUtil.indexOf(this.model,e);return this.indices.push(r),t},getMetadataCount:function(){return this.indices.length},get:function(e){if(e<0||e>=this.indices.length)throw"index out of bounds";return this.model.get(this.indices[e])},remove:function(e){if(e<0||e>=this.indices.length)throw"index out of bounds";var t=this.model.remove(this.indices[e]);return this.indices.splice(e,1),t},getByName:function(e){var t=morpheus.MetadataUtil.indexOf(this,e);return-1!==t?this.get(t):void 0}},morpheus.Util.extend(morpheus.MetadataModelColumnView,morpheus.MetadataModelAdapter),morpheus.MetadataModelItemView=function(e,t){this.model=e,this.indices=t},morpheus.MetadataModelItemView.prototype={add:function(e){var t=this.model.add(e);return new morpheus.SlicedVector(t,this.indices)},getItemCount:function(){return this.indices.length},get:function(e){var t=this.model.get(e);if(void 0!==t)return new morpheus.SlicedVector(t,this.indices)},getByName:function(e){var t=this.model.getByName(e);if(void 0!==t)return new morpheus.SlicedVector(t,this.indices)},getMetadataCount:function(){return this.model.getMetadataCount()}},morpheus.Util.extend(morpheus.MetadataModelItemView,morpheus.MetadataModelAdapter),morpheus.MetadataModel=function(e){this.itemCount=e,this.vectors=[]},morpheus.MetadataModel.prototype={add:function(e,t){var r,n=morpheus.MetadataUtil.indexOf(this,e);-1!==n&&(r=this.get(n));var i=new morpheus.Vector(e,this.getItemCount());if(null!=r)for(var o=0,a=r.size();o<a;o++){var s=r.getValue(o);i.setValue(o,s)}return-1!==n?this.vectors.splice(n,1,i):this.vectors.push(i),i},getItemCount:function(){return this.itemCount},get:function(e){return this.vectors[e]},remove:function(e){return this.vectors.splice(e,1)[0]},getByName:function(e){var t=morpheus.MetadataUtil.indexOf(this,e);return-1!==t?this.get(t):void 0},getMetadataCount:function(){return this.vectors.length}},morpheus.MetadataUtil=function(){},morpheus.MetadataUtil.renameFields=function(e,t){_.each(t.rows,function(t){if(t.renameTo){var r=e.getRowMetadata().getByName(t.field);r&&r.setName(t.renameTo)}}),_.each(t.columns,function(t){if(t.renameTo){var r=e.getColumnMetadata().getByName(t.field);r&&r.setName(t.renameTo)}})},morpheus.MetadataUtil.search=function(e){var t=e.model,r=e.fullModel;r||(r=t);var n=e.text;if(e.isColumns,""===(n=$.trim(n)))return null;var i=morpheus.Util.getAutocompleteTokens(n);if(0==i.length)return null;var o="#",a=morpheus.MetadataUtil.getMetadataNames(r);a.push(o);for(var s=morpheus.Util.createSearchPredicates({tokens:i,fields:a,defaultMatchMode:e.defaultMatchMode}),l=[],u=new morpheus.Map,c=0;c<r.getMetadataCount();c++){var h=r.get(c),p=morpheus.VectorUtil.getDataType(h),d={vector:h,dataType:p,isArray:0===p.indexOf("[")};u.set(h.getName(),d),null!=t.getByName(h.getName())&&l.push(d)}for(var f=[],m=s.length,g=0;g<m;g++){var v=(M=s[g]).getField();if(null!=v&&!M.isNumber())if((d=u.get(v))&&("number"===d.dataType||"[number]"===d.dataType))if(M.getText)s[g]=new morpheus.Util.EqualsPredicate(v,parseFloat(M.getText()));else if(M.getValues){var y=[];M.getValues().forEach(function(e){y.push(parseFloat(e))}),M[g]=new morpheus.Util.ExactTermsPredicate(v,y)}}var b=!0===e.matchAllPredicates;function w(e){var t=e.getField();if(null!=t){var r=null;if(t===o){if(r=_+1,e.accept(r))return!0}else if(a=u.get(t))if(r=a.vector.getValue(_),a.isArray){if(null!=r)for(var n=0;n<r.length;n++)if(e.accept(r[n]))return!0}else if(e.accept(r))return!0}else for(var i=0;i<x;i++){var a;r=(a=l[i]).vector.getValue(_);if(a.isArray){if(null!=r)for(n=0;n<r.length;n++)if(e.accept(r[n]))return!0}else if(e.accept(r))return!0}}for(var x=l.length,_=0,S=t.getItemCount();_<S;_++)if(b){var C=!0;for(g=0;g<m;g++){if(!w(M=s[g])){C=!1;break}}C&&f.push(_)}else for(g=0;g<m;g++){var M;if(w(M=s[g])){f.push(_);break}}return f},morpheus.MetadataUtil.shallowCopy=function(e){for(var t=new morpheus.MetadataModel(e.getItemCount()),r=0;r<e.getMetadataCount();r++){var n=e.get(r),i=new morpheus.VectorAdapter(n);i.properties=new morpheus.Map,i.getProperties=function(){return this.properties},n.getProperties().forEach(function(e,t){morpheus.VectorKeys.COPY_IGNORE.has(t)||i.properties.set(t,e)}),t.vectors.push(i)}return t},morpheus.MetadataUtil.autocomplete=function(e){return function(t,r){var n=[],i=null,o=null,a=e,s=null!=t&&t.length>0?t[t.selectionStartIndex]:"",l=null;if(""!==(s=$.trim(s))){var u=s.indexOf(":");if(u>0&&92!==s.charCodeAt(u-1)){var c=$.trim(s.substring(0,u));c.length>0&&'"'===c[0]&&'"'===c[s.length-1]&&(c=c.substring(1,c.length-1));var h=morpheus.MetadataUtil.indexOf(a,c);-1!==h&&(l=c,s=$.trim(s.substring(u+1)),a=new morpheus.MetadataModelColumnView(e,[h]))}var p=new morpheus.Set;i=new RegExp(morpheus.Util.escapeRegex(s),"i"),o=new RegExp("("+morpheus.Util.escapeRegex(s)+")","i");for(var d=[],f=[],m=0;m<a.getMetadataCount();m++){var g=a.get(m);"string"!==(S=morpheus.VectorUtil.getDataType(g))&&"[string]"!==S||(d.push(g),f.push("[string]"===S))}var v=d.length;e:for(var y=0,b=a.getItemCount();y<b;y++)for(m=0;m<v;m++){var w=(g=d[m]).getValue(y);if(null!=w)if(f[m])for(var x=0;x<w.length;x++){var _=new morpheus.Identifier([w[x],g.getName()]);if(!p.has(_)&&i.test(w[x])&&(p.add(_),10===p.size()))break e}else{_=new morpheus.Identifier([w,g.getName()]);if(!p.has(_)&&i.test(w)&&(p.add(_),10===p.size()))break e}}p.forEach(function(e){var t=e.getArray(),r=t[1],i=t[0],a=r;-1!==a.indexOf(" ")&&(a='"'+a+'"');var s=i;-1!==s.indexOf(" ")&&(s='"'+s+'"'),n.push({value:a+":"+s,label:'<span style="font-weight:300;">'+r+":</span><span>"+i.replace(o,"<b>$1</b>")+"</span>"})})}null==i&&(i=new RegExp(".*","i"));for(m=0;m<a.getMetadataCount();m++){g=a.get(m);var S=morpheus.VectorUtil.getDataType(g),C=g.getName();if(("number"===S||"string"===S||"[string]"===S)&&i.test(C)&&C!==l){var M=C;-1!==M.indexOf(" ")&&(M='"'+M+'"'),n.push({value:M+":",label:'<span style="font-weight:300;">'+(null==o?C:C.replace(o,"<b>$1</b>"))+":</span>"+("number"===S?'<span style="font-weight:300;font-size:85%;">.., >, <, >=, <=, =</span>':""),show:!0})}}r(n)}},morpheus.MetadataUtil.getMetadataNames=function(e){for(var t=[],r=0,n=e.getMetadataCount();r<n;r++)t.push(e.get(r).getName(r));return t.sort(function(e,t){return(e=e.toLowerCase())<(t=t.toLowerCase())?-1:e===t?0:1}),t},morpheus.MetadataUtil.getVectors=function(e,t){var r=[];return t.forEach(function(t){var n=e.getByName(t);if(!n)throw t+" not found. Available fields are "+morpheus.MetadataUtil.getMetadataNames(e);r.push(n)}),r},morpheus.MetadataUtil.indexOf=function(e,t){for(var r=0,n=e.getMetadataCount();r<n;r++)if(t===e.get(r).getName())return r;return-1},morpheus.MetadataUtil.maybeConvertStrings=function(e,t){for(var r=t,n=e.getMetadataCount();r<n;r++)morpheus.VectorUtil.maybeConvertStringToNumber(e.get(r))},morpheus.MetadataUtil.copy=function(e,t){if(e.getItemCount()!=t.getItemCount())throw"Item count not equal in source and destination. "+e.getItemCount()+" != "+t.getItemCount();for(var r=e.getItemCount(),n=e.getMetadataCount(),i=0;i<n;i++){var o=e.get(i),a=t.getByName(o.getName());null==a&&(a=t.add(o.getName()));for(var s=0;s<r;s++)a.setValue(s,o.getValue(s))}},morpheus.MetadataUtil.addVectorIfNotExists=function(e,t){var r=e.getByName(t);return r||(r=e.add(t)),r},morpheus.MetadataUtil.getMatchingIndices=function(e,t){for(var r={},n=0,i=e.getItemCount();n<i;n++){for(var o=!1,a=0,s=e.getMetadataCount();a<s&&!o;a++)for(var l=e.get(e.getColumnName(a)).getValue(n),u=0,c=t.length;u<c;u++)if(t[u]==l){o=!0;break}o&&(r[n]=1)}return r},morpheus.MolarConcentration=function(){},morpheus.MolarConcentration.getMicroMolarConcentration=function(e){e=e.toLowerCase();for(var t=0;t<morpheus.MolarConcentration.CONCENTRATIONS.length;t++){var r=morpheus.MolarConcentration.CONCENTRATIONS[t],n=r[0],i=r[1],o=e.indexOf(n);if(-1!=o){var a=e.substring(0,o).trim(),s=i/1e7;return parseFloat(a)/s}}},morpheus.MolarConcentration.CONCENTRATIONS=[["mm",1e4],["um",1e7],["Âµm",1e7],["nm",1e10],["pm",1e13],["fm",1e16],["am",1e19],["zm",1e22],["ym",1e25],["m",1]],morpheus.Positions=function(){this.spaces=void 0,this.defaultPositionFunction=function(e){return this.size*e},this.squishedPositionFunction=function(e){return this.positions[e]},this.positionFunction=this.defaultPositionFunction,this.squishedIndices={},this.isSquished=!1},morpheus.Positions.getBottom=function(e,t){var r=t.getLength();return null!=e&&(r=1+t.getIndex(e.y+e.height,!1),r=Math.max(0,r),r=Math.min(t.getLength(),r)),r},morpheus.Positions.getTop=function(e,t){var r=0;return null!=e&&(r=t.getIndex(e.y,!1)-1,r=Math.max(0,r),r=Math.min(t.getLength(),r)),r},morpheus.Positions.getLeft=function(e,t){var r=0;return null!=e&&(r=t.getIndex(e.x,!1)-1,r=Math.max(0,r),r=Math.min(t.getLength(),r)),r},morpheus.Positions.getRight=function(e,t){var r=t.getLength();return null!=e&&(r=1+t.getIndex(e.x+e.width,!1),r=Math.min(t.getLength(),r)),r},morpheus.Positions.prototype={length:0,size:13,squishFactor:.1,compress:!0,copy:function(){var e=new morpheus.Positions;return this.spaces&&(e.spaces=this.spaces.slice()),e.compress=this.compress,e.squishFactor=this.squishFactor,e.size=this.size,e.length=this.length,this.isSquished&&(e.positionFunction=e.squishedPositionFunction,e.squishedIndices=_.clone(this.squishedIndices),e.isSquished=!0),e},getIndex:function(e,t){return 0===this.getLength()?-1:t?this.binaryExactSearch(e):this.binaryInExactSearch(e)},getLength:function(){return this.length},getPosition:function(e){return this.positionFunction(e)+(void 0!==this.spaces?this.spaces[e]:0)},getItemSize:function(e){return!0===this.squishedIndices[e]?this.size*this.squishFactor:this.size},getSize:function(){return this.size},setSpaces:function(e){this.spaces=e},setLength:function(e){this.length=e,this.trigger("change",{source:this,value:"length"})},setSize:function(e){this.size=e,this.isSquished&&this.setSquishedIndices(this.squishedIndices),this.trigger("change",{source:this,value:"size"})},setSquishedIndices:function(e){if(null!=e){var t=this.compress;this.squishedIndices=e;for(var r=[],n=this.squishFactor,i=this.size,o=0,a=0,s=this.getLength();a<s;a++)!0===e[a]?(r.push(o),o+=i*n):(t||(o=i*a),r.push(o),o+=i);this.isSquished=!0,this.positions=r,this.positionFunction=this.squishedPositionFunction}else this.squishedIndices={},this.isSquished=!1,this.positionFunction=this.defaultPositionFunction;this.trigger("change",{source:this,value:"squishedIndices"})},setSquishFactor:function(e){this.squishFactor!==e&&(this.squishFactor=e,this.isSquished&&this.setSquishedIndices(this.squishedIndices),this.trigger("change",{source:this,value:"squishFactor"}))},getSquishFactor:function(){return this.squishFactor},binaryExactSearch:function(e){for(var t=0,r=this.length-1;t<=r;){var n=t+r>>1,i=this.getPosition(n),o=this.getItemSize(n);if(i<=e&&e<i+o)return n;if(i<e)t=n+1;else{if(!(i>e))return n;r=n-1}}return-1},binaryInExactSearch:function(e){var t=0,r=this.getLength()-1,n=this.getLength()-1;if(e<=this.getPosition(0))return 0;for(;t<=r;){var i=t+r>>1,o=this.getPosition(i),a=this.getItemSize(i),s=n===i?o+a:this.getPosition(i+1);if(o<=e&&e<s)return i;if(o<e)t=i+1;else{if(!(o>e))return i;r=i-1}}return t-1}},morpheus.Util.extend(morpheus.Positions,morpheus.Events),morpheus.Project=function(e){this.originalDataset=e,this.rowIndexMapper=new morpheus.IndexMapper(this,!0),this.columnIndexMapper=new morpheus.IndexMapper(this,!1),this.groupRows=[],this.groupColumns=[],this.rowColorModel=new morpheus.VectorColorModel,this.columnColorModel=new morpheus.VectorColorModel,this.rowShapeModel=new morpheus.VectorShapeModel,this.columnShapeModel=new morpheus.VectorShapeModel,this.rowFontModel=new morpheus.VectorFontModel,this.columnFontModel=new morpheus.VectorFontModel,this.hoverColumnIndex=-1,this.hoverRowIndex=-1,this.columnSelectionModel=new morpheus.SelectionModel(this,!0),this.rowSelectionModel=new morpheus.SelectionModel(this,!1),this.elementSelectionModel=new morpheus.ElementSelectionModel(this),this.symmetricProjectListener=null,morpheus.Project._recomputeCalculatedColumnFields(this.originalDataset,morpheus.VectorKeys.RECOMPUTE_FUNCTION_NEW_HEAT_MAP),morpheus.Project._recomputeCalculatedColumnFields(new morpheus.TransposedDatasetView(this.originalDataset),morpheus.VectorKeys.RECOMPUTE_FUNCTION_NEW_HEAT_MAP)},morpheus.Project.Events={DATASET_CHANGED:"datasetChanged",ROW_GROUP_BY_CHANGED:"rowGroupByChanged",COLUMN_GROUP_BY_CHANGED:"columnGroupByChanged",ROW_FILTER_CHANGED:"rowFilterChanged",COLUMN_FILTER_CHANGED:"columnFilterChanged",ROW_SORT_ORDER_CHANGED:"rowSortOrderChanged",COLUMN_SORT_ORDER_CHANGED:"columnSortOrderChanged",ROW_TRACK_REMOVED:"rowTrackRemoved",COLUMN_TRACK_REMOVED:"columnTrackRemoved"},morpheus.Project._recomputeCalculatedColumnFields=function(e,t){for(var r=e.getColumnMetadata(),n=new morpheus.DatasetColumnView(e),i=0,o=0,a=r.getMetadataCount();o<a;o++){var s=r.get(o);if(null!=s.getProperties().get(morpheus.VectorKeys.FUNCTION)&&s.getProperties().get(t)){for(var l=morpheus.VectorUtil.jsonToFunction(s,morpheus.VectorKeys.FUNCTION),u=0,c=s.size();u<c;u++)n.setIndex(u),s.setValue(u,l(n,e,u));i++}}return i},morpheus.Project.prototype={isSymmetric:function(){return null!=this.symmetricProjectListener},setSymmetric:function(e){null!=e?null==this.symmetricProjectListener&&(this.symmetricProjectListener=new morpheus.SymmetricProjectListener(e.getProject(),e.vscroll,e.hscroll)):(null!=this.symmetricProjectListener&&this.symmetricProjectListener.dispose(),this.symmetricProjectListener=null)},getHoverColumnIndex:function(){return this.hoverColumnIndex},setHoverColumnIndex:function(e){this.hoverColumnIndex=e},getHoverRowIndex:function(){return this.hoverRowIndex},setHoverRowIndex:function(e){this.hoverRowIndex=e},getRowColorModel:function(){return this.rowColorModel},getRowShapeModel:function(){return this.rowShapeModel},getColumnShapeModel:function(){return this.columnShapeModel},getRowFontModel:function(){return this.rowFontModel},getColumnFontModel:function(){return this.columnFontModel},getGroupRows:function(){return this.groupRows},getGroupColumns:function(){return this.groupColumns},getFullDataset:function(){return this.originalDataset},getColumnSelectionModel:function(){return this.columnSelectionModel},getRowSelectionModel:function(){return this.rowSelectionModel},getFilteredSortedRowIndices:function(){return this.rowIndexMapper.convertToView()},getFilteredSortedColumnIndices:function(){return this.columnIndexMapper.convertToView()},getElementSelectionModel:function(){return this.elementSelectionModel},setFullDataset:function(e,t){this.originalDataset=e,this.rowIndexMapper.setFilter(this.rowIndexMapper.getFilter()),this.columnIndexMapper.setFilter(this.columnIndexMapper.getFilter()),this.columnSelectionModel.clear(),this.rowSelectionModel.clear(),this.elementSelectionModel.clear(),t&&this.trigger(morpheus.Project.Events.DATASET_CHANGED)},setGroupRows:function(e,t){this.groupRows=e;for(var r=0,n=e.length;r<n;r++)void 0===e[r].isColumns()&&e[r].setColumns(!1);t&&this.trigger(morpheus.Project.Events.ROW_GROUP_BY_CHANGED)},setGroupColumns:function(e,t){this.groupColumns=e;for(var r=0,n=e.length;r<n;r++)void 0===e[r].isColumns()&&e[r].setColumns(!0);t&&this.trigger(morpheus.Project.Events.COLUMN_GROUP_BY_CHANGED)},setRowFilter:function(e,t){this._saveSelection(!1),this.rowIndexMapper.setFilter(e),this._restoreSelection(!1),t&&this.trigger(morpheus.Project.Events.ROW_FILTER_CHANGED)},getRowFilter:function(){return this.rowIndexMapper.getFilter()},getColumnFilter:function(){return this.columnIndexMapper.getFilter()},setColumnFilter:function(e,t){this._saveSelection(!0),this.columnIndexMapper.setFilter(e),this._restoreSelection(!0),t&&this.trigger(morpheus.Project.Events.COLUMN_FILTER_CHANGED)},getColumnColorModel:function(){return this.columnColorModel},getSortedFilteredDataset:function(){return new morpheus.SlicedDatasetView(this.getFullDataset(),this.rowIndexMapper.convertToView(),this.columnIndexMapper.convertToView())},getSelectedDataset:function(e){e=$.extend({},{selectedRows:!0,selectedColumns:!0,emptyToAll:!0},e);var t=this.getSortedFilteredDataset(),r=null;e.selectedRows&&0===(r=this.rowSelectionModel.getViewIndices().values().sort(function(e,t){return e===t?0:e<t?-1:1})).length&&e.emptyToAll&&(r=null);var n=null;return e.selectedColumns&&0===(n=this.columnSelectionModel.getViewIndices().values().sort(function(e,t){return e===t?0:e<t?-1:1})).length&&e.emptyToAll&&(n=null),null==r&&null==n?t:new morpheus.SlicedDatasetView(t,r,n)},_saveSelection:function(e){this.elementSelectionModel.save(),e?this.columnSelectionModel.save():this.rowSelectionModel.save()},_restoreSelection:function(e){e?this.columnSelectionModel.restore():this.rowSelectionModel.restore(),this.elementSelectionModel.restore()},setRowSortKeys:function(e,t){this._saveSelection(!1);for(var r=0,n=e.length;r<n;r++)void 0===e[r].isColumns()&&e[r].setColumns(!1);this.rowIndexMapper.setSortKeys(e),this._restoreSelection(!1),t&&this.trigger(morpheus.Project.Events.ROW_SORT_ORDER_CHANGED)},setColumnSortKeys:function(e,t){this._saveSelection(!0);for(var r=0,n=e.length;r<n;r++)void 0===e[r].isColumns()&&e[r].setColumns(!0);this.columnIndexMapper.setSortKeys(e),this._restoreSelection(!0),t&&this.trigger(morpheus.Project.Events.COLUMN_SORT_ORDER_CHANGED)},getRowSortKeys:function(){return this.rowIndexMapper.sortKeys},getColumnSortKeys:function(){return this.columnIndexMapper.sortKeys},convertViewColumnIndexToModel:function(e){return this.columnIndexMapper.convertViewIndexToModel(e)},convertViewRowIndexToModel:function(e){return this.rowIndexMapper.convertViewIndexToModel(e)},convertModelRowIndexToView:function(e){return this.rowIndexMapper.convertModelIndexToView(e)},convertModelColumnIndexToView:function(e){return this.columnIndexMapper.convertModelIndexToView(e)},isColumnViewIndexSelected:function(e){return this.columnSelectionModel.isViewIndexSelected(e)},isRowViewIndexSelected:function(e){return this.rowSelectionModel.isViewIndexSelected(e)}},morpheus.Util.extend(morpheus.Project,morpheus.Events),morpheus.QNorm=function(){},morpheus.QNorm.execute=function(e){var t,r,n,i,o=e.getRowCount(),a=e.getColumnCount(),s=new Float32Array(o),l=new Float32Array(o);for(i=morpheus.QNorm.get_di_matrix(e),r=0;r<a;r++)i[r].sort(function(e,t){return e.data<t.data?-1:e.data>t.data?1:0});for(t=0;t<o;t++){var u=0,c=0;for(r=0;r<a;r++){var h=i[r][t].data;isNaN(h)||(u+=h,c++)}s[t]=u/c}for(r=0;r<a;r++)for(morpheus.QNorm.get_ranks(l,i[r],o),t=0;t<o;t++)n=i[r][t].rank,l[t]-Math.floor(l[t])>.4?e.setValue(n,r,.5*(s[Math.floor(l[t])-1]+s[Math.floor(l[t])])):e.setValue(n,r,s[Math.floor(l[t])-1])},morpheus.QNorm.get_di_matrix=function(e){var t,r,n=e.getRowCount(),i=e.getColumnCount(),o=[];for(r=0;r<i;r++)for(o.push([]),t=0;t<n;t++)o[r][t]={},o[r][t].data=e.getValue(t,r),o[r][t].rank=t;return o},morpheus.QNorm.get_ranks=function(e,t,r){var n,i,o;for(n=0;n<r;){for(i=n;i<r-1&&t[i].data==t[i+1].data;)i++;if(n!=i)for(o=n;o<=i;o++)e[o]=(n+i+2)/2;else e[n]=n+1;n=i+1}},morpheus.SelectionModel=function(e,t){this.viewIndices=new morpheus.Set,this.project=e,this.isColumns=t},morpheus.SelectionModel.prototype={setViewIndices:function(e,t){this.viewIndices=e,t&&this.trigger("selectionChanged")},isViewIndexSelected:function(e){return this.viewIndices.has(e)},clear:function(){this.viewIndices=new morpheus.Set},getViewIndices:function(){return this.viewIndices},count:function(){return this.viewIndices.size()},toModelIndices:function(){var e=this.project,t=this.isColumns?e.convertViewColumnIndexToModel:e.convertViewRowIndexToModel;t=_.bind(t,e);var r=[];return this.viewIndices.forEach(function(e){var n=t(e);r.push(n)}),r},save:function(){this.modelIndices=this.toModelIndices()},restore:function(){var e=this.project;this.viewIndices=new morpheus.Set;var t=this.isColumns?e.convertModelColumnIndexToView:e.convertModelRowIndexToView;t=_.bind(t,e);for(var r=0,n=this.modelIndices.length;r<n;r++){var i=t(this.modelIndices[r]);-1!==i&&this.viewIndices.add(i)}}},morpheus.Util.extend(morpheus.SelectionModel,morpheus.Events),morpheus.SlicedDatasetView=function(e,t,r){morpheus.DatasetAdapter.call(this,e),null==t&&(t=null),null==r&&(r=null),this.rowIndices=t,this.columnIndices=r},morpheus.SlicedDatasetView.prototype={getRowCount:function(){return null!==this.rowIndices?this.rowIndices.length:this.dataset.getRowCount()},getColumnCount:function(){return null!==this.columnIndices?this.columnIndices.length:this.dataset.getColumnCount()},getValue:function(e,t,r){return this.dataset.getValue(null!==this.rowIndices?this.rowIndices[e]:e,null!==this.columnIndices?this.columnIndices[t]:t,r)},setValue:function(e,t,r,n){this.dataset.setValue(null!==this.rowIndices?this.rowIndices[e]:e,null!==this.columnIndices?this.columnIndices[t]:t,r,n)},getRowMetadata:function(){return null!==this.rowIndices?new morpheus.MetadataModelItemView(this.dataset.getRowMetadata(),this.rowIndices):this.dataset.getRowMetadata()},getColumnMetadata:function(){return null!==this.columnIndices?new morpheus.MetadataModelItemView(this.dataset.getColumnMetadata(),this.columnIndices):this.dataset.getColumnMetadata()},toString:function(){return this.getName()}},morpheus.Util.extend(morpheus.SlicedDatasetView,morpheus.DatasetAdapter),morpheus.SlicedVector=function(e,t){morpheus.VectorAdapter.call(this,e),this.indices=t},morpheus.SlicedVector.prototype={setValue:function(e,t){this.v.setValue(this.indices[e],t)},getValue:function(e){return this.v.getValue(this.indices[e])},size:function(){return this.indices.length}},morpheus.Util.extend(morpheus.SlicedVector,morpheus.VectorAdapter),morpheus.AbstractSortKey=function(e,t){this.name=e,this.columns=t},morpheus.AbstractSortKey.prototype={lockOrder:0,columns:!0,preservesDendrogram:!1,unlockable:!0,isColumns:function(){return this.columns},setColumns:function(e){this.columns=e},isPreservesDendrogram:function(){return this.preservesDendrogram},setPreservesDendrogram:function(e){this.preservesDendrogram=e},getLockOrder:function(){return this.lockOrder},isUnlockable:function(){return this.unlockable},setUnlockable:function(e){this.unlockable=e},setLockOrder:function(e){this.lockOrder=e},setSortOrder:function(e){this.sortOrder=e},getSortOrder:function(){return this.sortOrder},init:function(){}},morpheus.MatchesOnTopSortKey=function(e,t,r,n){morpheus.AbstractSortKey.call(this,r,n);for(var i={},o=[],a=0,s=t.length,l=t.length;a<l;a++,s--)i[t[a]]=-1,o.push(a);this.comparator=function(e,t){var r=i[e];void 0===r&&(r=0);var n=i[t];return void 0===n&&(n=0),r===n?0:r<n?-1:1},this.modelIndices=t,this.indices=o},morpheus.MatchesOnTopSortKey.prototype={toString:function(){return this.name},getSortOrder:function(){return 2},getComparator:function(){return this.comparator},getValue:function(e){return e}},morpheus.Util.extend(morpheus.MatchesOnTopSortKey,morpheus.AbstractSortKey),morpheus.SortKey=function(e,t,r){morpheus.AbstractSortKey.call(this,e,r),"string"==typeof t&&void 0===(t=morpheus.SortKey.SortOrder[t.toUpperCase()])&&(t=0),this.v=null,this.c=null,this.setSortOrder(t)},morpheus.SortKey.prototype={toString:function(){return this.name},init:function(e,t){if(this.v=e.getRowMetadata().getByName(this.name),this.v){var r=morpheus.VectorUtil.getDataType(this.v);if("number"===r)this.c=this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR:morpheus.SortKey.NUMBER_DESCENDING_COMPARATOR;else if("[number]"===r){var n=this.v.getProperties().get(morpheus.VectorKeys.ARRAY_SUMMARY_FUNCTION)||morpheus.SortKey.ARRAY_MAX_SUMMARY_FUNCTION;this.c=this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.ARRAY_ASCENDING_COMPARATOR(n):morpheus.SortKey.ARRAY_DESCENDING_COMPARATOR(n)}else this.c=this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.ASCENDING_COMPARATOR:morpheus.SortKey.DESCENDING_COMPARATOR;if(null!=this.customComparator){var i=this.c,o=this.customComparator;this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?this.c=function(e,t){var r=o(e,t);return 0===r?i(e,t):r}:this.c=function(e,t){var r=o(t,e);return 0===r?i(e,t):r}}}else this.v={},this.v.getValue=function(){return 0},this.c=this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.ASCENDING_COMPARATOR:morpheus.SortKey.DESCENDING_COMPARATOR;if(this.sortOrder===morpheus.SortKey.SortOrder.TOP_N){for(var a=[],s=[],l=0,u=t.length;l<u;l++){var c=t[l],h=this.v.getValue(c);isNaN(h)?s.push(c):a.push({index:c,value:h})}var p=this.c;this.c=morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR,a.sort(function(e,t){return p(e.value,t.value)});for(var d=[],f=Math.min(a.length,10),m=0,g=0,v=Math.floor(a.length/2),y=a.slice(0,v),b=a.slice(v),w=b.length-1,x=y.length,_=a.length;m<_;){for(l=0;l<f&&g<x;l++,g++,m++)d[y[g].index]=m;var S=[];for(l=0;l<f&&w>=0;l++,w--,m++)S.push([b[w].index,m]);l=S.length-1;for(var C=0;l>=0;l--,C++){var M=S[l],T=S[C];d[M[0]]=T[1]}}l=0;for(var A=s.length;l<A;l++,m++)d[s[l]]=m;this.modelIndexToValue=d}else delete this.modelIndexToValue},getComparator:function(){return this.c},getValue:function(e){return this.modelIndexToValue?this.modelIndexToValue[e]:this.v.getValue(e)}},morpheus.Util.extend(morpheus.SortKey,morpheus.AbstractSortKey),morpheus.SortByValuesKey=function(e,t,r){morpheus.AbstractSortKey.call(this,"values",r),this.bothCount=10,this.modelIndices=e,this.sortOrder=t,this.setSortOrder(t)},morpheus.SortByValuesKey.prototype={toString:function(){return this.name},init:function(e,t){if(this.dataset=new morpheus.SlicedDatasetView(e,null,this.modelIndices),this.rowView=new morpheus.DatasetRowView(this.dataset),this.summaryFunction=this.modelIndices.length>1?morpheus.Median:function(e){return e.getValue(0)},this.sortOrder===morpheus.SortKey.SortOrder.TOP_N){for(var r=[],n=[],i=0,o=t.length;i<o;i++){var a=t[i],s=this.summaryFunction(this.rowView.setIndex(a));isNaN(s)?n.push(a):r.push({index:a,value:s})}r.sort(function(e,t){return e.value<t.value?1:e.value===t.value?0:-1});for(var l=[],u=Math.min(r.length,this.bothCount),c=0,h=0,p=Math.floor(r.length/2),d=r.slice(0,p),f=r.slice(p),m=f.length-1,g=d.length,v=r.length;c<v;){for(i=0;i<u&&h<g;i++,h++,c++)l[d[h].index]=c;var y=[];for(i=0;i<u&&m>=0;i++,m--,c++)y.push([f[m].index,c]);i=y.length-1;for(var b=0;i>=0;i--,b++){var w=y[i],x=y[b];l[w[0]]=x[1]}}i=0;for(var _=n.length;i<_;i++,c++)l[n[i]]=c;this.modelIndexToValue=l}else delete this.modelIndexToValue},getComparator:function(){return this.c},getValue:function(e){return this.modelIndexToValue?this.modelIndexToValue[e]:this.summaryFunction(this.rowView.setIndex(e))},setSortOrder:function(e){"string"==typeof e&&(e=morpheus.SortKey.SortOrder[e.toUpperCase()]),this.sortOrder=e,this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?this.c=morpheus.SortKey.ELEMENT_ASCENDING_COMPARATOR:this.sortOrder===morpheus.SortKey.SortOrder.DESCENDING?this.c=morpheus.SortKey.ELEMENT_DESCENDING_COMPARATOR:this.c=morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR}},morpheus.Util.extend(morpheus.SortByValuesKey,morpheus.AbstractSortKey),morpheus.SpecifiedModelSortOrder=function(e,t,r,n){morpheus.AbstractSortKey.call(this,r,n),this.nvisible=t;for(var i=[],o=0,a=e.length;o<a;o++)i[e[o]]=o;this.modelIndices=e,this.modelIndexToValue=i,this.c=morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR},morpheus.SpecifiedModelSortOrder.prototype={toString:function(){return this.name},getComparator:function(e,t){return this.c},getValue:function(e){return this.modelIndexToValue[e]},setSortOrder:function(e){this.sortOrder=e,this.c=this.sortOrder===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR:morpheus.SortKey.NUMBER_DESCENDING_COMPARATOR}},morpheus.Util.extend(morpheus.SpecifiedModelSortOrder,morpheus.AbstractSortKey),morpheus.SpecifiedGroupByKey=function(e,t){morpheus.AbstractSortKey.call(this,"Dendrogram Cut",t),this.clusterIds=e,this.c=function(e,t){return e===t?0:e<t?-1:1}},morpheus.SpecifiedGroupByKey.prototype={toString:function(){return this.name},getComparator:function(e,t){return this.c},getValue:function(e){return this.clusterIds[e]}},morpheus.Util.extend(morpheus.SpecifiedGroupByKey,morpheus.AbstractSortKey),morpheus.SortKey.SortOrder={ASCENDING:0,DESCENDING:1,UNSORTED:2,CUSTOM:3,TOP_N:4},morpheus.SortKey.ASCENDING_COMPARATOR=function(e,t){var r=null==e,n=null==t;return r&&n?0:r?1:n?-1:(e=(""+e).toLowerCase())===(t=(""+t).toLowerCase())?0:e<t?-1:1},morpheus.SortKey.DESCENDING_COMPARATOR=function(e,t){var r=null==e,n=null==t;return r&&n?0:r?1:n?-1:(e=(""+e).toLowerCase())===(t=(""+t).toLowerCase())?0:e<t?1:-1},morpheus.SortKey.NUMBER_ASCENDING_COMPARATOR=function(e,t){var r=null==e||isNaN(e),n=null==t||isNaN(t);return r&&n?0:r?1:n?-1:e===t?0:e<t?-1:1},morpheus.SortKey.NUMBER_DESCENDING_COMPARATOR=function(e,t){var r=null==e||isNaN(e),n=null==t||isNaN(t);return r&&n?0:r?1:n?-1:e===t?0:e<t?1:-1},morpheus.SortKey.STRING_ASCENDING_COMPARATOR=function(e,t){return(e=null==e||void 0===e.toLowerCase?null:e.toLowerCase())===(t=null==t||void 0===t.toLowerCase?null:t.toLowerCase())?0:e<t?-1:1},morpheus.SortKey.STRING_DESCENDING_COMPARATOR=function(e,t){return(e=null==e||void 0===e.toLowerCase?null:e.toLowerCase())===(t=null==t||void 0===t.toLowerCase?null:t.toLowerCase())?0:e<t?1:-1},morpheus.SortKey.ELEMENT_ASCENDING_COMPARATOR=function(e,t){var r=+e,n=+t,i=isNaN(r),o=isNaN(n);if(i&&o)return 0;if(i)return 1;if(o)return-1;if(r===n&&null!=e&&e.toObject&&null!=t&&t.toObject){var a=e.toObject(),s=t.toObject();for(var l in a){var u=(r=a[l])===(n=s[l])?0:r<n?-1:1;if(0!==u)return u}}return r===n?0:r<n?-1:1},morpheus.SortKey.ELEMENT_DESCENDING_COMPARATOR=function(e,t){var r=+e,n=+t,i=isNaN(r),o=isNaN(n);if(i&&o)return 0;if(i)return 1;if(o)return-1;if(r===n&&null!=e&&e.toObject&&null!=t&&t.toObject){var a=e.toObject(),s=t.toObject();for(var l in a){var u=(r=a[l])===(n=s[l])?0:r<n?1:-1;if(0!==u)return u}}return r===n?0:r<n?1:-1},morpheus.SortKey.BOX_PLOT_SUMMARY_FUNCTION=function(e){var t=e.box;if(null==t){var r=morpheus.VectorUtil.arrayAsVector(e);t=morpheus.BoxPlotItem(null!=this.indices?new morpheus.SlicedVector(r,this.indices):r),e.box=t}return t.q3},morpheus.SortKey.ARRAY_MAX_SUMMARY_FUNCTION=function(e){var t=0;if(null!=e){for(var r=-Number.MAX_VALUE,n=Number.MAX_VALUE,i=0,o=e.length;i<o;i++){var a=e[i];isNaN(a)||(a>=0?r=a>r?a:r:n=a<n?a:n)}r!==-Number.MAX_VALUE&&(t=r),n!==Number.MAX_VALUE&&(t=Math.abs(n)>t?n:t)}return t},morpheus.SortKey.ARRAY_ASCENDING_COMPARATOR=function(e){return function(t,r){var n=null==t,i=null==r;return n&&i?0:n?1:i?-1:(t=e(t),r=e(r),n=isNaN(t),i=isNaN(r),n&&i?0:n?1:i?-1:t===r?0:t<r?-1:1)}},morpheus.SortKey.ARRAY_DESCENDING_COMPARATOR=function(e){return function(t,r){var n=null==t,i=null==r;return n&&i?0:n?1:i?-1:(t=e(t),r=e(r),n=isNaN(t),i=isNaN(r),n&&i?0:n?1:i?-1:t===r?0:t<r?1:-1)}},morpheus.SortKey.reverseComparator=function(e){return function(t,r){return e(r,t)}},morpheus.SortKey.keepExistingSortKeys=function(e,t){for(var r=0,n=t.length;r<n;r++){var i=t[r];if(i.getLockOrder()>0){for(var o=-1,a=0;a<e.length;a++)if(e[a]===i){o=a;break}-1!==o&&e.splice(o,1),e.splice(1===i.getLockOrder()?0:e.length,0,i)}}return e},morpheus.SortKey.fromJSON=function(e,t){var r=[];return t.forEach(function(t){var n=null;if("annotation"===t.type){if(n=new morpheus.SortKey(t.field,t.order,t.isColumns),null!=t.customSortOrder){for(var i=new morpheus.Map,o=0,a=t.customSortOrder.length;o<a;o++)i.set(t.customSortOrder[o],o);n.customComparator=function(e,t){var r=i.get(e),n=i.get(t);return void 0===r&&void 0===n?0:(void 0===r&&(r=1/0),void 0===n&&(n=1/0),r<n?-1:1)},t.preservesDendrogram&&(n.nvisible=t.customSortOrder.length)}}else"byValues"===t.type?n=new morpheus.SortByValuesKey(t.modelIndices,t.order,t.isColumns):"specified"===t.type?n=new morpheus.SpecifiedModelSortOrder(t.modelIndices,t.nvisible,t.name,t.isColumns):"matchesOnTop"===t.type?n=new morpheus.MatchesOnTopSortKey(e,t.modelIndices,t.name,t.isColumns):null!=t.field?n=new morpheus.SortKey(t.field,t.order):console.log("Unknown key: "+t);null!=n&&(null!=t.preservesDendrogram&&n.setPreservesDendrogram(t.preservesDendrogram),null!=t.lockOrder&&0!==t.lockOrder&&(n.setLockOrder(t.lockOrder),n.setUnlockable(t.unlockable)),r.push(n))}),r},morpheus.SortKey.toJSON=function(e){var t=[];return e.forEach(function(e){var r=null;e instanceof morpheus.SortKey?r={isColumns:e.isColumns(),order:e.getSortOrder(),type:"annotation",field:""+e}:e instanceof morpheus.SortByValuesKey?r={isColumns:e.isColumns(),order:e.getSortOrder(),type:"byValues",modelIndices:e.modelIndices}:e instanceof morpheus.SpecifiedModelSortOrder?r={isColumns:e.isColumns(),order:e.getSortOrder(),type:"specified",modelIndices:e.modelIndices,name:e.name,nvisible:e.nvisible}:e instanceof morpheus.MatchesOnTopSortKey?r={isColumns:e.isColumns(),order:e.getSortOrder(),type:"matchesOnTop",modelIndices:e.modelIndices,name:e.name}:console.log("Unknown sort key type "+r),null!=r?(r.preservesDendrogram=e.isPreservesDendrogram(),e.getLockOrder&&0!==e.getLockOrder()&&(r.lockOrder=e.getLockOrder(),r.unlockable=!!e.isUnlockable&&e.isUnlockable()),t.push(r)):console.log("Unknown sort key type")}),t},morpheus.SymmetricProjectListener=function(e,t,r){var n,i,o,a,s,l,u,c,h,p,d=!1;e.on(morpheus.Project.Events.ROW_GROUP_BY_CHANGED,n=function(){d||(d=!0,e.setGroupColumns(e.getGroupRows(),!0),d=!1)}),e.on(morpheus.Project.Events.COLUMN_GROUP_BY_CHANGED,i=function(){d||(d=!0,e.setGroupRows(e.getGroupColumns(),!0),d=!1)}),e.on(morpheus.Project.Events.ROW_FILTER_CHANGED,o=function(){d||(d=!0,e.setColumnFilter(e.getRowFilter(),!0),d=!1)}),e.on(morpheus.Project.Events.COLUMN_FILTER_CHANGED,a=function(){d||(d=!0,e.setRowFilter(e.getColumnFilter(),!0),d=!1)}),e.on(morpheus.Project.Events.ROW_SORT_ORDER_CHANGED,s=function(){d||(d=!0,e.setColumnSortKeys(e.getRowSortKeys(),!0),d=!1)}),e.on(morpheus.Project.Events.COLUMN_SORT_ORDER_CHANGED,l=function(){d||(d=!0,e.setRowSortKeys(e.getColumnSortKeys(),!0),d=!1)}),e.getColumnSelectionModel().on("selectionChanged",u=function(){d||(d=!0,e.getRowSelectionModel().setViewIndices(e.getColumnSelectionModel().getViewIndices(),!0),d=!1)}),e.getRowSelectionModel().on("selectionChanged",c=function(){d||(d=!0,e.getColumnSelectionModel().setViewIndices(e.getRowSelectionModel().getViewIndices(),!0),d=!1)}),t.on("scroll",h=function(){if(!d){d=!0;var e=0===t.getMaxValue()?0:t.getValue()/t.getMaxValue();r.setValue(e*r.getMaxValue(),!0),d=!1}}),r.on("scroll",p=function(){if(!d){d=!0;var e=0===r.getMaxValue()?0:r.getValue()/r.getMaxValue();t.setValue(e*t.getMaxValue(),!0),d=!1}}),this.dispose=function(){e.off(morpheus.Project.Events.ROW_GROUP_BY_CHANGED,n),e.off(morpheus.Project.Events.COLUMN_GROUP_BY_CHANGED,i),e.off(morpheus.Project.Events.ROW_FILTER_CHANGED,o),e.off(morpheus.Project.Events.COLUMN_FILTER_CHANGED,a),e.off(morpheus.Project.Events.ROW_SORT_ORDER_CHANGED,s),e.off(morpheus.Project.Events.COLUMN_SORT_ORDER_CHANGED,l),e.getColumnSelectionModel().off("selectionChanged",u),e.getRowSelectionModel().off("selectionChanged",c),t.off("scroll",h),r.off("scroll",p)}},morpheus.TransposedDatasetView=function(e){morpheus.DatasetAdapter.call(this,e)},morpheus.TransposedDatasetView.prototype={getRowCount:function(){return this.dataset.getColumnCount()},getColumnCount:function(){return this.dataset.getRowCount()},getValue:function(e,t,r){return this.dataset.getValue(t,e,r)},setValue:function(e,t,r,n){this.dataset.setValue(t,e,r,n)},getRowMetadata:function(){return this.dataset.getColumnMetadata()},getColumnMetadata:function(){return this.dataset.getRowMetadata()}},morpheus.Util.extend(morpheus.TransposedDatasetView,morpheus.DatasetAdapter),morpheus.Percentile=function(e,t,r){return morpheus.ArrayPercentile(morpheus.RemoveNaN(e),t,r)},morpheus.Percentile.toString=function(){return"Percentile"},morpheus.RemoveNaN=function(e){for(var t=[],r=0,n=e.size();r<n;r++){var i=e.getValue(r);isNaN(i)||t.push(i)}return t},morpheus.Median=function(e){return morpheus.ArrayPercentile(morpheus.RemoveNaN(e),50,!1)},morpheus.Median.toString=function(){return"Median"},morpheus.ArrayPercentile=function(e,t,r){return r||e.sort(function(e,t){return e<t?-1:e===t?0:1}),d3.quantile(e,t/100)},morpheus.MaxPercentiles=function(e){var t=function(t){for(var r=[],n=0,i=t.size();n<i;n++){var o=t.getValue(n);isNaN(o)||r.push(o)}if(0===r.length)return NaN;r.sort(function(e,t){return e<t?-1:e===t?0:1});var a=0;for(n=0;n<e.length;n++){var s=morpheus.ArrayPercentile(r,e[n],!0);Math.abs(s)>Math.abs(a)&&(a=s)}return a};return t.toString=function(){for(var t=["Maximum of "],r=0,n=e.length;r<n;r++)r>0&&n>2&&t.push(", "),r===n-1&&t.push(2==n?" and ":"and "),t.push(e[r]);return t.push(" percentiles"),t.join("")},t},morpheus.CountIf=function(vector,criteria){/[<>=!]/.test(criteria)||(criteria='=="'+criteria+'"');for(var matches=0,i=0,size=vector.size();i<size;i++){var value=vector.getValue(i);eval(value+criteria)&&matches++}return matches},morpheus.Mean=function(e){for(var t=0,r=0,n=0,i=e.size();n<i;n++){var o=e.getValue(n);isNaN(o)||(t+=o,r++)}return 0===r?NaN:t/r},morpheus.Mean.toString=function(){return"Mean"},morpheus.Sum=function(e){for(var t=0,r=!1,n=0,i=e.size();n<i;n++){var o=e.getValue(n);isNaN(o)||(r=!0,t+=o)}return r?t:NaN},morpheus.Sum.toString=function(){return"Sum"},morpheus.CountNonNaN=function(e){for(var t=0,r=0,n=e.size();r<n;r++){var i=e.getValue(r);isNaN(i)||t++}return t},morpheus.CountNonNaN.toString=function(){return"Count non-NaN"},morpheus.Max=function(e){for(var t=-Number.MAX_VALUE,r=!1,n=0,i=e.size();n<i;n++){var o=e.getValue(n);isNaN(o)||(r=!0,t=Math.max(t,o))}return r?t:NaN},morpheus.Max.toString=function(){return"Max"},morpheus.Min=function(e){for(var t=Number.MAX_VALUE,r=!1,n=0,i=e.size();n<i;n++){var o=e.getValue(n);isNaN(o)||(r=!0,t=Math.min(t,o))}return r?t:NaN},morpheus.Min.toString=function(){return"Min"},morpheus.Variance=function(e,t){void 0==t&&(t=morpheus.Mean(e));for(var r=0,n=0,i=0,o=e.size();i<o;i++){var a=e.getValue(i);if(!isNaN(a)){var s=a-t;r+=s*=s,n++}}return n<=1?NaN:((n-=1)<1&&(n=1),r/n)},morpheus.Variance.toString=function(){return"Variance"},morpheus.StandardDeviation=function(e,t){return Math.sqrt(morpheus.Variance(e,t))},morpheus.StandardDeviation.toString=function(){return"Standard deviation"};var LOG_10=Math.log(10);morpheus.Log10=function(e){return e<=0?0:Math.log(e)/LOG_10};var LOG_2=Math.log(2);return morpheus.Log2=function(e){return e<=0?0:Math.log(e)/LOG_2},morpheus.FDR_BH=function(e){for(var t=e.length,r=0;r<t;r++){var n=e[r];(n>1||isNaN(n))&&(e[r]=1)}var i=morpheus.Util.indexSort(e,!0),o=morpheus.Util.rankIndexArray(i);for(r=i.length-1;r>0;r--)e[i[r]]==e[i[r-1]]&&(o[i[r-1]]=o[i[r]]);var a=new Float32Array(t);for(r=0;r<t;r++){var s=o[r],l=e[r];a[r]=l*t/s}var u=morpheus.Util.indexSort(e,!1);for(r=0;r<u.length-1;r++){var c=u[r],h=u[r+1];a[h]=Math.min(a[h],a[c])}for(r=0;r<t;r++)a[r]=Math.min(a[r],1);return a},morpheus.FDR_BH.tString=function(){return"FDR(BH)"},morpheus.MAD=function(e,t){null==t&&(t=morpheus.Percentile(e,50));for(var r=[],n=0,i=e.size();n<i;n++){var o=e.getValue(n);isNaN(o)||r.push(Math.abs(o-t))}return 1.4826*morpheus.Percentile(new morpheus.Vector("",r.length).setArray(r),50)},morpheus.MAD.toString=function(){return"Median absolute deviation"},morpheus.CV=function(e){var t=morpheus.Mean(e);return Math.sqrt(morpheus.Variance(e,t))/t},morpheus.CV.toString=function(){return"Coefficient of variation"},morpheus.BoxPlotItem=function(e){var t=morpheus.RemoveNaN(e);return t.sort(function(e,t){return e===t?0:e<t?-1:1}),0===t.length?{median:NaN,q1:NaN,q3:NaN,lowerAdjacentValue:NaN,upperAdjacentValue:NaN}:morpheus.BoxPlotArrayItem(t)},morpheus.BoxPlotArrayItem=function(e){for(var t=morpheus.ArrayPercentile(e,50,!0),r=morpheus.ArrayPercentile(e,25,!0),n=morpheus.ArrayPercentile(e,75,!0),i=-Number.MAX_VALUE,o=Number.MAX_VALUE,a=n+1.5*(n-r),s=r-1.5*(n-r),l=0,u=0,c=e.length;u<c;u++){var h=e[u];h<=a&&(i=Math.max(i,h)),h>=s&&(o=Math.min(o,h)),l+=h}var p=l/e.length;return o>r&&(o=r),i<n&&(i=n),{mean:p,median:t,q1:r,q3:n,lowerAdjacentValue:o,upperAdjacentValue:i}},morpheus.VectorColorModel=function(){this.vectorNameToColorMap=new morpheus.Map,this.vectorNameToColorScheme=new morpheus.Map,this.colors=morpheus.VectorColorModel.TWENTY_COLORS},morpheus.VectorColorModel.YES_COLOR="#d8b365",morpheus.VectorColorModel.FEMALE="#ff99ff",morpheus.VectorColorModel.MALE="#66ccff",morpheus.VectorColorModel.TWENTY_COLORS=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],morpheus.VectorColorModel.CATEGORY_20A=morpheus.VectorColorModel.TWENTY_COLORS,morpheus.VectorColorModel.CATEGORY_20B=["#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6"],morpheus.VectorColorModel.CATEGORY_20C=["#3182bd","#6baed6","#9ecae1","#c6dbef","#e6550d","#fd8d3c","#fdae6b","#fdd0a2","#31a354","#74c476","#a1d99b","#c7e9c0","#756bb1","#9e9ac8","#bcbddc","#dadaeb","#636363","#969696","#bdbdbd","#d9d9d9"],morpheus.VectorColorModel.CATEGORY_ALL=[].concat(morpheus.VectorColorModel.CATEGORY_20A,morpheus.VectorColorModel.CATEGORY_20B,morpheus.VectorColorModel.CATEGORY_20C),morpheus.VectorColorModel.TABLEAU10=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],morpheus.VectorColorModel.STANDARD_COLORS={na:"#c0c0c0",nan:"#c0c0c0","":"#ffffff",wt:"#ffffff",n:"#ffffff",0:"#ffffff",y:morpheus.VectorColorModel.YES_COLOR,1:morpheus.VectorColorModel.YES_COLOR,male:morpheus.VectorColorModel.MALE,m:morpheus.VectorColorModel.MALE,female:morpheus.VectorColorModel.FEMALE,f:morpheus.VectorColorModel.FEMALE},morpheus.VectorColorModel.getStandardColor=function(e){if(null==e)return"#ffffff";var t=e.toString().toLowerCase();return morpheus.VectorColorModel.STANDARD_COLORS[t]},morpheus.VectorColorModel.getColorMapForNumber=function(e){return(e<3?colorbrewer.Set1[3]:colorbrewer.Paired[e])||morpheus.VectorColorModel.TWENTY_COLORS},morpheus.VectorColorModel.prototype={toJSON:function(e){var t=this,r={};return e.forEach(function(e){if(e.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)){var n=t.vectorNameToColorMap.get(e.getName());null!=n&&(r[e.getName()]=n)}else{var i=t.vectorNameToColorScheme.get(e.getName());if(null!=i&&void 0!==i.getCurrentColorSupplier){var o=morpheus.AbstractColorSupplier.toJSON(i.getCurrentColorSupplier());r[e.getName()]=o}else console.log("Unknown color scheme")}}),r},fromJSON:function(e){for(var t in e){var r=e[t];r.colors?(r.scalingMode="fixed",this.vectorNameToColorScheme.set(t,morpheus.AbstractColorSupplier.fromJSON(r))):this.vectorNameToColorMap.set(t,morpheus.Map.fromJSON(r))}},clear:function(e){this.vectorNameToColorMap.remove(e.getName()),this.vectorNameToColorScheme.remove(e.getName())},copy:function(){var e=new morpheus.VectorColorModel;return e.colors=this.colors.slice(0),this.vectorNameToColorMap.forEach(function(t,r){var n=new morpheus.Map;n.setAll(t),e.vectorNameToColorMap.set(r,n)}),this.vectorNameToColorScheme.forEach(function(t,r){e.vectorNameToColorScheme.set(r,t.copy(new morpheus.Project(new morpheus.Dataset({name:"",rows:1,columns:1}))))}),e},clearAll:function(){this.vectorNameToColorMap=new morpheus.Map,this.vectorNameToColorScheme=new morpheus.Map},containsDiscreteColor:function(e,t){var r=this.vectorNameToColorMap.get(e.getName());return void 0!==r&&null!=r.get(t)},setDiscreteColorMap:function(e){this.colors=e},getContinuousColorScheme:function(e){return this.vectorNameToColorScheme.get(e.getName())},getDiscreteColorScheme:function(e){return this.vectorNameToColorMap.get(e.getName())},createContinuousColorMap:function(e){var t=morpheus.VectorUtil.getMinMax(e),r=t.min,n=t.max,i=new morpheus.HeatMapColorScheme(new morpheus.Project(new morpheus.Dataset({name:"",rows:1,columns:1})),{type:"fixed",map:[{value:r,color:"white"},{value:(n+r)/2,color:"#feb24c"},{value:n,color:"#f03b20"}]});return this.vectorNameToColorScheme.set(e.getName(),i),i},_getColorForValue:function(e){var t=morpheus.VectorColorModel.getStandardColor(e);if(null==t)for(var r=this.vectorNameToColorMap.values(),n=0,i=r.length;n<i;n++)if(void 0!==(t=r[n].get(e)))return t;return t},getContinuousMappedValue:function(e,t){var r=this.vectorNameToColorScheme.get(e.getName());return void 0===r&&(r=this.createContinuousColorMap(e)),r.getColor(0,0,t)},getMappedValue:function(e,t){var r=this.vectorNameToColorMap.get(e.getName());if(void 0===r){r=new morpheus.Map,this.vectorNameToColorMap.set(e.getName(),r);var n=morpheus.VectorUtil.getValues(e),i=0,o=null;if((o=n.length<3?colorbrewer.Dark2[3]:colorbrewer.Paired[n.length])||(o=n.length<=20?d3.scale.category20().range():morpheus.VectorColorModel.CATEGORY_ALL),o){i=o.length;for(var a=0,s=n.length;a<s;a++){var l;null==(l=this._getColorForValue(n[a]))&&(l=o[a%i]),r.set(n[a],l)}}else{var u=this;_.each(n,function(t){u.getMappedValue(e,t)})}}if(null==(l=r.get(t))){if(null==(l=this._getColorForValue(t))){var c=r.size();l=this.colors[c%this.colors.length]}r.set(t,l)}return l},setMappedValue:function(e,t,r){var n=this.vectorNameToColorMap.get(e.getName());void 0===n&&(n=new morpheus.Map,this.vectorNameToColorMap.set(e.getName(),n)),n.set(t,r)}},morpheus.VectorFontModel=function(){this.vectorNameToMappedValue=new morpheus.Map,this.fonts=morpheus.VectorFontModel.FONTS},morpheus.VectorFontModel.FONTS=[{weight:400},{weight:700},{weight:900}],morpheus.VectorFontModel.prototype={toJSON:function(e){var t=this,r={};return e.forEach(function(e){if(e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)&&e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)){var n=t.vectorNameToMappedValue.get(e.getName());null!=n&&(r[e.getName()]=n)}}),r},fromJSON:function(e){for(var t in e){var r=e[t];this.vectorNameToMappedValue.set(t,morpheus.Map.fromJSON(r))}},clear:function(e){this.vectorNameToMappedValue.remove(e.getName())},copy:function(){var e=new morpheus.VectorFontModel;return e.fonts=this.fonts.slice(0),this.vectorNameToMappedValue.forEach(function(t,r){var n=new morpheus.Map;n.setAll(t),e.vectorNameToMappedValue.set(r,n)}),e},clearAll:function(){this.vectorNameToMappedValue=new morpheus.Map},_getFontForValue:function(e){if(null==e)return morpheus.VectorFontModel.FONTS[0];for(var t=this.vectorNameToMappedValue.values(),r=0,n=t.length;r<n;r++){var i=t[r].get(e);if(void 0!==i)return i}},getMap:function(e){return this.vectorNameToMappedValue.get(e)},getMappedValue:function(e,t){var r=this.vectorNameToMappedValue.get(e.getName());if(void 0===r){r=new morpheus.Map,this.vectorNameToMappedValue.set(e.getName(),r);for(var n=morpheus.VectorUtil.getValues(e),i=0,o=n.length;i<o;i++){var a;null==(a=this._getFontForValue(n[i]))&&(a=this.fonts[0]),r.set(n[i],a)}}return null==(a=r.get(t))&&(null==(a=this._getFontForValue(t))&&(a=this.fonts[0]),r.set(t,a)),a},setMappedValue:function(e,t,r){var n=this.vectorNameToMappedValue.get(e.getName());void 0===n&&(n=new morpheus.Map,this.vectorNameToMappedValue.set(e.getName(),n)),n.set(t,r)}},morpheus.VectorKeys={},morpheus.VectorKeys.FIELDS="morpheus.fields",morpheus.VectorKeys.VALUE_TO_INDICES="morpheus.valueToIndices",morpheus.VectorKeys.VISIBLE_FIELDS="morpheus.visibleFields",morpheus.VectorKeys.DATA_TYPE="morpheus.dataType",morpheus.VectorKeys.ARRAY_SUMMARY_FUNCTION="morpheus.arraySummaryFunct",morpheus.VectorKeys.HEADER_SUMMARY="morpheus.headerSummary",morpheus.VectorKeys.SHOW_HEADER_SUMMARY="morpheus.showHeaderSummary",morpheus.VectorKeys.TITLE="morpheus.title",morpheus.VectorKeys.FUNCTION="morpheus.funct",morpheus.VectorKeys.SELECTION="morpheus.selection",morpheus.VectorKeys.RECOMPUTE_FUNCTION_NEW_HEAT_MAP="morpheus.recompute.funct.new.heat.map",morpheus.VectorKeys.RECOMPUTE_FUNCTION_SELECTION="morpheus.recompute.funct.selection",morpheus.VectorKeys.FORMATTER="morpheus.formatter",morpheus.VectorKeys.IS_INDEX="morpheus.isIndex",morpheus.VectorKeys.DISCRETE="morpheus.discrete",morpheus.VectorKeys.COPY_IGNORE=new morpheus.Set,morpheus.VectorKeys.COPY_IGNORE.add(morpheus.VectorKeys.HEADER_SUMMARY),morpheus.VectorKeys.COPY_IGNORE.add(morpheus.VectorKeys.DATA_TYPE),morpheus.VectorKeys.COPY_IGNORE.add(morpheus.VectorKeys.VALUE_TO_INDICES),morpheus.VectorKeys.JSON_WHITELIST=new morpheus.Set,morpheus.VectorKeys.JSON_WHITELIST.add(morpheus.VectorKeys.FIELDS),morpheus.VectorKeys.JSON_WHITELIST.add(morpheus.VectorKeys.FORMATTER),morpheus.VectorKeys.JSON_WHITELIST.add(morpheus.VectorKeys.DATA_TYPE),morpheus.VectorKeys.JSON_WHITELIST.add(morpheus.VectorKeys.TITLE),morpheus.VectorShapeModel=function(){this.shapes=morpheus.VectorShapeModel.SHAPES,this.vectorNameToMappedValue=new morpheus.Map},morpheus.VectorShapeModel.SHAPES=["circle","square","plus","x","asterisk","diamond","triangle-up","triangle-down","triangle-left","triangle-right","circle-minus"],morpheus.VectorShapeModel.FILLED_SHAPES=["circle","square","diamond","triangle-up","triangle-down","triangle-left","triangle-right"],morpheus.VectorShapeModel.prototype={toJSON:function(e){var t=this,r={};return e.forEach(function(e){if(e.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)){var n=t.vectorNameToMappedValue.get(e.getName());null!=n&&(r[e.getName()]=n)}}),r},fromJSON:function(e){for(var t in e){var r=e[t];this.vectorNameToMappedValue.set(t,morpheus.Map.fromJSON(r))}},clear:function(e){this.vectorNameToMappedValue.remove(e.getName())},copy:function(){var e=new morpheus.VectorShapeModel;return e.shapes=this.shapes.slice(0),this.vectorNameToMappedValue.forEach(function(t,r){var n=new morpheus.Map;n.setAll(t),e.vectorNameToMappedValue.set(r,n)}),e},clearAll:function(){this.vectorNameToMappedValue=new morpheus.Map},_getShapeForValue:function(e){if(null==e)return"none";for(var t=this.vectorNameToMappedValue.values(),r=0,n=t.length;r<n;r++){var i=t[r].get(e);if(void 0!==i)return i}},getMap:function(e){return this.vectorNameToMappedValue.get(e)},getMappedValue:function(e,t){var r=this.vectorNameToMappedValue.get(e.getName());if(void 0===r){r=new morpheus.Map,this.vectorNameToMappedValue.set(e.getName(),r);for(var n=morpheus.VectorUtil.getValues(e),i=0,o=n.length;i<o;i++){var a;null==(a=this._getShapeForValue(n[i]))&&(a=this.shapes[i%this.shapes.length]),r.set(n[i],a)}}if(null==(a=r.get(t))){if(null==(a=this._getShapeForValue(t))){var s=r.size();a=this.shapes[s%this.shapes.length]}r.set(t,a)}return a},setMappedValue:function(e,t,r){var n=this.vectorNameToMappedValue.get(e.getName());void 0===n&&(n=new morpheus.Map,this.vectorNameToMappedValue.set(e.getName(),n)),n.set(t,r)}},morpheus.VectorUtil=function(){},morpheus.VectorUtil.jsonToFunction=function(e,t){var r=e.getProperties().get(t);if("object"==typeof r){var n=r.binSize,i=r.domain[0],o=r.domain[1],a=Math.ceil((o-i)/n),s=r.percent,l=r.cumulative,u=function(e,t,r){for(var u=0,c=new Uint32Array(a),h=0,p=t.getRowCount();h<p;h++){var d=t.getValue(h,r);if(!isNaN(d)){if(d>=i&&d<=o){var f=Math.floor((d-i)/n);f<0?f=0:f>=a&&(f=a-1),c[f]++}u++}}if(l)for(h=a-2;h>=0;h--)c[h]+=c[h+1];if(s){var m=new Float32Array(a);for(h=0;h<a;h++)m[h]=c[h]/u*100;return m}return c};e.getProperties().set(t,u);var c=r;(r=u).toJSON=function(){return c}}return r},morpheus.VectorUtil.createValueToIndexMap=function(e,t){for(var r=new morpheus.Map,n=t&&"["===morpheus.VectorUtil.getDataType(e)[0],i=0,o=e.size();i<o;i++){var a=e.getValue(i);if(n){if(null!=a)for(var s=0;s<a.length;s++)r.set(a[s],i)}else r.set(a,i)}return r},morpheus.VectorUtil.createValueToIndicesMap=function(e,t){if(!e)throw"vector is null";for(var r=t&&"["===morpheus.VectorUtil.getDataType(e)[0],n=new morpheus.Map,i=0,o=e.size();i<o;i++){var a=e.getValue(i);if(r){if(null!=a)for(var s=0;s<a.length;s++){var l;void 0===(l=n.get(a[s]))&&(l=[],n.set(a[s],l)),l.push(i)}}else void 0===(l=n.get(a))&&(l=[],n.set(a,l)),l.push(i)}return n},morpheus.VectorUtil.createValueToCountMap=function(e){if(!e)throw"vector is null";for(var t=new morpheus.Map,r="["===morpheus.VectorUtil.getDataType(e)[0],n=0,i=e.size();n<i;n++){var o=e.getValue(n);if(null!=o)if(r)for(var a=0;a<o.length;a++){var s=t.get(o[a])||0;t.set(o[a],s+1)}else s=t.get(o)||0,t.set(o,s+1)}return t},morpheus.VectorUtil.createValuesToIndicesMap=function(e){var t=new morpheus.Map,r=e.length;if(null==e[0])throw"no vectors found";for(var n=0,i=e[0].size();n<i;n++){for(var o=[],a=0;a<r;a++){var s=e[a].getValue(n);o.push(s)}var l=new morpheus.Identifier(o),u=t.get(l);void 0===u&&(u=[],t.set(l,u)),u.push(n)}return t},morpheus.VectorUtil.createValuesToIndexMap=function(e){var t=new morpheus.Map,r=e.length;if(null==e[0])throw"no vectors found";for(var n=0,i=e[0].size();n<i;n++){for(var o=[],a=0;a<r;a++){var s=e[a].getValue(n);o.push(s)}var l=new morpheus.Identifier(o);t.set(l,n)}return t},morpheus.VectorUtil.createValuesToCountMap=function(e){var t=new morpheus.Map,r=e.length;if(null==e[0])throw"no vectors found";for(var n=0,i=e[0].size();n<i;n++){for(var o=[],a=0;a<r;a++){var s=e[a].getValue(n);o.push(s)}var l=new morpheus.Identifier(o),u=t.get(l)||0;t.set(l,u+1)}return t},morpheus.VectorUtil.getValues=function(e,t){for(var r=new morpheus.Set,n=0,i=e.size();n<i;n++){var o=e.getValue(n);t&&null==o||r.add(o)}var a=r.values();return a.sort(morpheus.SortKey.ASCENDING_COMPARATOR),a},morpheus.VectorUtil.getSet=function(e,t){for(var r=new morpheus.Set,n=t&&"["===morpheus.VectorUtil.getDataType(e)[0],i=0,o=e.size();i<o;i++){var a=e.getValue(i);if(n){if(null!=a)for(var s=0,l=a.length;s<l;s++)r.add(a[s])}else r.add(a)}return r},morpheus.VectorUtil.maybeConvertToStringArray=function(e,t){for(var r=[],n=new RegExp(t),i=!1,o=0,a=e.size();o<a;o++){var s=e.getValue(o);if(null!=s){if(!s.split)return!1;var l=s.split(n);r.push(l),!i&&l.length>1&&(i=!0)}}if(i){for(o=0,a=r.length;o<a;o++)e.setValue(o,r[o]);e.getProperties().set(morpheus.VectorKeys.DATA_TYPE,"[string]")}return i},morpheus.VectorUtil.maybeConvertStringToNumber=function(e){for(var t=[],r=!1,n=0,i=e.size();n<i;n++){var o=e.getValue(n);if(null!=o&&""!==o&&"NA"!==o&&"NaN"!==o){if(!$.isNumeric(o))return!1;r=!0}t.push(parseFloat(o))}if(!r)return!1;for(n=0,i=t.length;n<i;n++)e.setValue(n,t[n]);return e.getProperties().set(morpheus.VectorKeys.DISCRETE,!1),e.getProperties().set(morpheus.VectorKeys.DATA_TYPE,"number"),!0},morpheus.VectorUtil.containsMoreThanOneValue=function(e){return morpheus.VectorUtil.containsMoreThanNValues(e,1)},morpheus.VectorUtil.containsMoreThanNValues=function(e,t){for(var r=new morpheus.Set,n=0,i=e.size();n<i;n++){var o=e.getValue(n);if(r.add(o),r.size()>t)return!0}return!1},morpheus.VectorUtil.createSpanMap=function(e){for(var t=e.getValue(0),r=new morpheus.Map,n=0,i=1,o=e.size();i<o;i++){var a=e.getValue(i);t!==a&&(t=a,r.set(n,i),n=i)}return r.set(n,e.size()),r},morpheus.VectorUtil.toArray=function(e){for(var t=[],r=0,n=e.size();r<n;r++){var i=e.getValue(r);t.push(i)}return t},morpheus.VectorUtil.arrayAsVector=function(e,t){var r=new morpheus.Vector(t,e.length);return r.array=e,r},morpheus.VectorUtil.toString=function(e){for(var t=[],r=0,n=e.size();r<n;r++){var i=e.getValue(r);t.push(i)}return t.join(", ")},morpheus.VectorUtil.getDataType=function(e){var t=e.getProperties().get(morpheus.VectorKeys.DATA_TYPE);if(void 0===t){var r=morpheus.VectorUtil.getFirstNonNull(e);t=morpheus.Util.getDataType(r),e.getProperties().set(morpheus.VectorKeys.DATA_TYPE,t)}return t},morpheus.VectorUtil.getMinMax=function(e){var t=Number.MAX_VALUE,r=-Number.MAX_VALUE,n=e.getProperties().get(morpheus.VectorKeys.FIELDS),i="["===morpheus.VectorUtil.getDataType(e)[0];if(null!=n){for(var o=n.length,a=0,s=e.size();a<s;a++)if(c=e.getValue(a))for(var l=0;l<o;l++){var u=c[l];isNaN(u)||(t=u<t?u:t,r=u>r?u:r)}}else if(i)for(a=0,s=e.size();a<s;a++){var c;if(null!=(c=e.getValue(a)))for(l=0,o=c.length;l<o;l++)u=c[l],isNaN(u)||(t=u<t?u:t,r=u>r?u:r)}else for(a=0,s=e.size();a<s;a++)u=e.getValue(a),isNaN(u)||(t=u<t?u:t,r=u>r?u:r);return{min:t,max:r}},morpheus.VectorUtil.getFirstNonNull=function(e){for(var t=0,r=e.size();t<r;t++){var n=e.getValue(t);if(null!=n)return n}return null},morpheus.VectorUtil.isNumber=function(e){return"number"===morpheus.VectorUtil.getDataType(e)},morpheus.Vector=function(e,t){this.array=[],morpheus.AbstractVector.call(this,e,t)},morpheus.Vector.fromArray=function(e,t,r){var n=new morpheus.Vector(e,null==r?t.length:r);return n.array=t,n},morpheus.Vector.prototype={push:function(e){this.array.push(e)},setValue:function(e,t){this.array[e]=t},getValue:function(e){return this.array[e]},setName:function(e){this.name=e},setArray:function(e){return this.array=e,this}},morpheus.Util.extend(morpheus.Vector,morpheus.AbstractVector),morpheus.LandingPage=function(e){e=$.extend({},{el:$("#vis")},e),this.pageOptions=e;var t=this,r=[];r.push('<div style="display:none;" class="container-fluid">'),r.push('<div style="min-height:78vh" class="row">'),r.push('<div class="col-xs-12 col-md-offset-1 col-md-7"><div data-name="input"></div>'),r.push('<div class="clearfix"></div>'),r.push("</div>"),r.push('<div data-name="desc" class="col-xs-12 col-md-3"><p><img src="https://software.broadinstitute.org/morpheus/css/morpheus_landing_img.png" style="width:100%;"></p></div>'),r.push("</div>"),r.push('<div class="row"><div class="col-xs-12 morpheus-footer"></div></div>'),r.push("</div>");var n=$(r.join(""));(new morpheus.HelpMenu).$el.appendTo(n.find(".morpheus-footer")),this.$el=n;var i=n.find("[data-name=desc]");morpheus.Util.createMorpheusHeader().appendTo(i),$('<p>Versatile matrix visualization and analysis software</p><p>View your dataset as a heat map, then explore the interactive tools in Morpheus. Cluster, create new annotations, search, filter, sort, display charts, and more.</p><p style="color:#586069;">30,000+ users <br />100,000+ matrices analyzed.</p><p style="font-size:12px;">If you use Morpheus for published work, please cite:<br />Morpheus, https://software.broadinstitute.org/morpheus</p>').appendTo(i);var o=n.find("[data-name=input]");$('<svg width="32px" height="32px"><g><rect x="0" y="0" width="32" height="14" style="fill:#ca0020;stroke:none"/><rect x="0" y="18" width="32" height="14" style="fill:#0571b0;stroke:none"/></g></svg><h2 style="padding-left: 4px; display:inline-block;">Open</h2>').appendTo(o),$('<div style="margin-bottom:20px;"><small>All data is processed on your computer and never sent to any server.</small></div>').appendTo(o),new morpheus.FilePicker({fileCallback:function(e){t.openFile(e)},optionsCallback:function(e){t.open(e)}}).$el.appendTo(o),e.tabManager?this.tabManager=e.tabManager:(this.tabManager=new morpheus.TabManager({landingPage:this}),this.tabManager.on("change rename add remove",function(e){var r=t.tabManager.getTabText(t.tabManager.getActiveTabId());null!=r&&""!==r||(r="Morpheus"),document.title=r}),this.tabManager.$nav.appendTo($(this.pageOptions.el)),this.tabManager.$tabContent.appendTo($(this.pageOptions.el)))},morpheus.LandingPage.prototype={open:function(e){this.dispose();for(var t=_.isArray(e)?e:[e],r=0;r<t.length;r++){var n=t[r];n.tabManager=this.tabManager,n.focus=0===r,n.standalone=!0,n.landingPage=this,new morpheus.HeatMap(n)}},dispose:function(){this.$el.hide()},show:function(){var e=this;this.$el.show(),morpheus.Util.isNode()||$(window).on("beforeunload.morpheus",function(){if(e.tabManager.getTabCount()>0)return"Are you sure you want to close Morpheus?"})},openFile:function(e){if(3!==e.length){var t=this,r=e[0],n=morpheus.Util.getFileName(r);if(n.toLowerCase().indexOf(".json")===n.length-5)morpheus.Util.getText(r).then(function(e){t.open(JSON.parse(e))}).catch(function(e){morpheus.FormBuilder.showMessageModal({title:"Error",message:"Unable to load session"})});else{var i={dataset:{file:r,options:{interactive:!0}}};morpheus.OpenDatasetTool.fileExtensionPrompt(n,function(e){if(e)for(var r in e)i.dataset.options[r]=e[r];t.open(i)})}}else{i={dataset:{file:e[0],options:{interactive:!0}}};var o,a,s=morpheus.Util.readLines(e[1]);s.then(function(e){o=e});var l=morpheus.Util.readLines(e[2]);l.then(function(e){a=e}),i.promises=[s,l],i.datasetReady=function(e){for(var t=e.getColumnMetadata().add("id"),r=/\t/,n=0,i=e.getColumnCount();n<i;n++)t.setValue(n,a[n].split(r)[0]);var s=e.getRowMetadata().add("id"),l=e.getRowMetadata().add("symbol"),u=0;for(i=e.getRowCount();u<i;u++){var c=o[u].split(r);s.setValue(u,c[0]),l.setValue(u,c[1])}},this.open(i)}}},morpheus.SampleDatasets=function(e){var t=this,r=e.$el;this.callback=e.callback,r.on("click","[name=dmapLink]",function(e){var r=[];$(this).parents(".collapse").find("input:checked").each(function(e,t){r.push($(t).data("file"))}),t.openDepMap(r),e.preventDefault()}),r.on("click","[name=tcgaLink]",function(e){e.preventDefault();var r,n=$(this),i=n.data("disease-type"),o={};n.parents(".collapse").find("input:checked").each(function(e,t){o[$(t).data("type")]=!0});for(var a=0;a<t.diseases.length;a++)if(t.diseases[a].type===i){r=t.diseases[a];break}o.type=i,o.name=r.name,t.openTcga(o)}),r.on("click","[data-toggle=dataTypeToggle]",function(e){var t=$(this),r=t.parents(".collapse").find("button"),n=0===t.parents(".collapse").find("input:checked").length;r.prop("disabled",n)}),fetch("https://software.broadinstitute.org/morpheus/preloaded-datasets/tcga/tcga_index.txt").then(function(e){if(e.ok)return e.text()}).then(function(n){var i=[],o=_.uniqueId("morpheus");i.push("<div>"),i.push('<h4><a data-toggle="collapse" href="#'+o+'" aria-expanded="false" aria-controls="'+o+'">Cancer Dependency Map</a></h4>'),i.push('<div class="collapse in" id="'+o+'">');var a=[];a.push({name:"CRISPR (Broad Avana)",file:"portal-Avana-2018-05-07.csv",help:"The latest (2018Q2) release of 436 cell lines screened with the Avana 1.0 library."}),a.push({name:"CRISPR (Broad GeCKO)",file:"portal-GeCKO-2018-05-07.csv",help:"This Achilles dataset contains the results of genome-scale CRISPR knockout screens using the GeCKO library in 33 cell lines."}),a.push({name:"RNAi (Broad Achilles)",file:"portal-RNAi_Ach-2018-05-07.csv",help:"Final RNAi dataset containing 501 cell lines that was used to support the publication Tsherniak A, Vasquez F, et al., Cell, 2017. Defining a cancer dependency map."}),a.push({name:"RNAi (Novartis Drive)",file:"portal-RNAi_Nov_DEM-2018-05-07.csv",help:"RNAi dataset containing 398 cell lines generated by Novartis published in McDonald III et al., Cell, 2017. Project DRIVE: A Compendium of Cancer Dependencies and Synthetic Lethal Relationships Uncovered by Large-Scale, Deep RNAi Screening"}),a.push({name:"RNAi (Combined Broad, Novartis, Marcotte)",file:"portal-RNAi_merged-2018-05-07.csv",help:"An integrated RNAi dataset of gene dependencies covering a total of 713 cell lines, as described in McFarland J, et al., bioRxiv, 2018. Improved estimation of cancer dependencies from large-scale RNAi screens using model-based normalization and data integration."}),a.push({name:"GENE EXPRESSION",file:"portal-expression_rpkm-2018-05-07.csv",help:"CCLE RNAseq gene expression data (RPKM)"}),a.push({name:"MUTATION",file:"portal-mutation-2018-05-07.maf.csv",help:"Merged mutation calls (coding region, germline filtered)"}),a.push({name:"COPY NUMBER BY GENE",file:"portal-copy_number_relative-2018-05-07.csv",help:"Copy Number (per gene) relative to ploidy"}),a.push({name:"PROTEOMICS",file:"portal-rppa-2018-05-07.csv",help:"CCLE Reverse Phase Protein Array (RPPA) data"}),a.push({name:"DRUG SENSITIVITY IC50",file:"portal-GDSC_IC50-2018-05-07.csv",help:"Fitted dose response data, log(IC50) values"}),a.push({name:"DRUG SENSITIVITY AUC",file:"portal-GDSC_AUC-2018-05-07.csv",help:"Fitted dose response data, AUC values"});for(var s=0;s<a.length;s++){var l=a[s];s%3==0&&(s>0&&i.push("</div>"),i.push('<div style="margin: 6px 0 0 20px;display: inline-block;vertical-align:top;">')),i.push('<label title="'+l.help+'"><input type="checkbox" style="margin-left:4px;" data-toggle="dataTypeToggle" data-file="'+l.file+'"> '+l.name+"</label>")}i.push("</div>"),i.push('<div style="margin: 6px 0 0 20px;display: inline-block;vertical-align:top;">'),i.push('<button disabled type="button" class="btn btn-default" name="dmapLink">Open</button>'),i.push("</div>"),i.push("</div>"),i.push("</div>"),i.push("<hr>"),i.push('<div><h4>TCGA <a target="_blank" href="https://confluence.broadinstitute.org/display/GDAC/Dashboard-Stddata">(Broad GDAC 1/28/2016)</a></h4></div>'),i.push('<div data-name="tcga"></div>'),$(i.join("")).appendTo(r),e.show&&r.css("display","");for(var u=n.split("\n"),c=[],h=0;h<u.length;h++){var p=u[h];if(""!==p){var d=p.split("\t"),f=d[0],m=d[1].split(","),g=morpheus.TcgaUtil.DISEASE_STUDIES[f];((y={mrna:-1!==m.indexOf("mRNAseq_RSEM_normalized_log2.txt"),sig_genes:-1!==m.indexOf("sig_genes.txt"),gistic:-1!==m.indexOf("all_lesions.conf_99.txt"),sample_info:-1!==m.indexOf("All_CDEs.txt"),mutation:-1!==m.indexOf("mutations_merged.maf.txt"),rppa:-1!==m.indexOf("rppa.txt"),methylation:-1!==m.indexOf("meth.by_mean.data.txt"),name:g,type:f,dataTypes:m}).mrna||y.gistic||y.sig_genes||y.rppa||y.methylation)&&c.push(y)}}c.sort(function(e,t){return(e=e.name.toLowerCase())===(t=t.name.toLowerCase())?0:e<t?-1:1});var v=[];for(t.diseases=c,h=0;h<c.length;h++){o=_.uniqueId("morpheus");var y=c[h];for(v.push("<div>"),v.push('<a data-toggle="collapse" href="#'+o+'" aria-expanded="false" aria-controls="'+o+'">'+y.name+" ("+y.type+")</a>"),v.push('<div class="collapse" id="'+o+'">'),s=0;s<morpheus.SampleDatasets.TCGA_DISEASE_TYPES_INFO.length;s++)l=morpheus.SampleDatasets.TCGA_DISEASE_TYPES_INFO[s],s%2==0&&(s>0&&v.push("</div>"),v.push('<div style="margin: 6px 0 0 20px;display: inline-block;vertical-align:top;">')),v.push('<label><input type="checkbox" style="margin-left:4px;" data-toggle="dataTypeToggle" data-type="'+l.type+'"'+(y[l.id]?"":" disabled")+"> "+l.name+"</label>");v.push("</div>"),v.push('<div style="margin: 6px 0 0 20px;display: inline-block;vertical-align:top;">'),v.push('<button disabled type="button" class="btn btn-default" name="tcgaLink" data-disease-type="'+y.type+'">Open</button>'),v.push("</div>"),v.push("</div>"),v.push("</div>")}$(v.join("")).appendTo(r.find("[data-name=tcga]"))}).catch(function(e){morpheus.FormBuilder.showInModal({title:"Error",html:"Unable to download data",appendTo:t.getContentEl(),focus:t.getFocusEl()}),console.log(e)})},morpheus.SampleDatasets.getTcgaDataset=function(e){var t="https://software.broadinstitute.org/morpheus/preloaded-datasets/tcga/"+e.type+"/",r={};return e.mrna&&(r.mrna=t+"mRNAseq_RSEM_normalized_log2.txt"),e.methylation&&(r.methylation=t+"meth.by_mean.data.txt"),e.sig_genes&&(r.mutation=t+"mutations_merged.maf.txt",r.sigGenes=t+"sig_genes.txt"),e.rppa&&(r.rppa=t+"rppa.txt"),e.gistic&&(r.gistic=t+"all_lesions.conf_99.txt"),e.gisticGene&&(r.gisticGene=t+"all_data_by_genes.txt"),r.mrnaClust=t+"bestclus.txt",r.columnAnnotations=[{file:t+"All_CDEs.txt",datasetField:"participant_id",fileField:"patient_id",transposed:!1}],morpheus.TcgaUtil.getDataset(r)},morpheus.SampleDatasets.getDepMapDataset=function(e){var t=[];return e.forEach(function(e){t.push("https://software.broadinstitute.org/morpheus/preloaded-datasets/depmap/"+e)}),new Promise(function(e,r){morpheus.DatasetUtil.readDatasetArray(t).then(function(t){for(var r=t.getColumnMetadata().get(0),n=t.getColumnMetadata().add("site"),i=0,o=n.size();i<o;i++){var a=r.getValue(i),s=a.indexOf("_");-1!==s&&n.setValue(i,a.substring(s+1))}e(t)}).catch(function(e){r(e)})})},morpheus.SampleDatasets.prototype={openTcga:function(e){this.callback({name:e.name,renderReady:function(t){for(var r=["age_at_initial_pathologic_diagnosis","breast_carcinoma_estrogen_receptor_status","breast_carcinoma_progesterone_receptor_status","lab_proc_her2_neu_immunohistochemistry_receptor_status","days_to_death","ethnicity","gender","histological_type","pathologic_stage"],n=t.getProject().getFullDataset().getColumnMetadata(),i=0;i<r.length;i++)n.getByName(r[i])&&t.addTrack(r[i],!0,"color");e.sig_genes&&-1===t.getTrackIndex("q_value",!1)&&t.addTrack("q_value",!1,"text")},columns:[{field:"participant_id",display:"text"},{field:"sample_type",display:"color"},{field:"mutation_summary",display:"stacked_bar"},{field:"mutation_summary_selection",display:"stacked_bar"},{field:"mRNAseq_cluster",display:"color, highlight"}],dataset:morpheus.SampleDatasets.getTcgaDataset(e)})},openDepMap:function(e){this.callback({rows:[{field:"id",display:"text"},{field:"Description",display:"text, tooltip"},{field:"mutation_summary",display:"stacked_bar"},{field:"Source",display:"color"}],columns:[{field:"id",display:"text,tooltip"},{field:"mutation_summary",display:"stacked_bar"},{field:"site",display:"color, highlight"}],dataset:morpheus.SampleDatasets.getDepMapDataset(e),name:"depmap"})}},morpheus.SampleDatasets.TCGA_DISEASE_TYPES_INFO=[{id:"mrna",name:"GENE EXPRESSION",type:"mrna"},{id:"gistic",name:"GISTIC COPY NUMBER",type:"gistic"},{id:"sig_genes",name:"MUTATION",type:"sig_genes"},{id:"rppa",name:"PROTEOMICS",type:"rppa"},{id:"methylation",name:"METHYLATION",type:"methylation"}],morpheus.AdjustDataTool=function(){},morpheus.AdjustDataTool.log2=function(e){for(var t=0,r=e.getRowCount();t<r;t++)for(var n=0,i=e.getColumnCount();n<i;n++)e.setValue(t,n,morpheus.Log2(e.getValue(t,n)))},morpheus.AdjustDataTool.log2_plus=function(e){for(var t=0,r=e.getRowCount();t<r;t++)for(var n=0,i=e.getColumnCount();n<i;n++)e.setValue(t,n,morpheus.Log2(e.getValue(t,n)+1))},morpheus.AdjustDataTool.zScore=function(e){for(var t=new morpheus.DatasetRowView(e),r=0,n=e.getRowCount();r<n;r++){t.setIndex(r);for(var i=morpheus.Mean(t),o=Math.sqrt(morpheus.Variance(t)),a=0,s=e.getColumnCount();a<s;a++)e.setValue(r,a,0===o?NaN:(e.getValue(r,a)-i)/o)}},morpheus.AdjustDataTool.robustZScore=function(e){for(var t=new morpheus.DatasetRowView(e),r=0,n=e.getRowCount();r<n;r++){t.setIndex(r);for(var i=morpheus.Median(t),o=morpheus.MAD(t,i),a=0,s=e.getColumnCount();a<s;a++)e.setValue(r,a,0===o?NaN:(e.getValue(r,a)-i)/o)}},morpheus.AdjustDataTool.prototype={toString:function(){return"Adjust"},init:function(e,t){t.$form.find("[name=scale_column_sum]").on("change",function(e){t.setVisible("column_sum",t.getValue("scale_column_sum"))}),t.setVisible("column_sum",!1)},gui:function(){return[{name:"scale_column_sum",type:"checkbox",help:"Whether to scale each column sum to a specified value"},{name:"column_sum",type:"text",style:"max-width:150px;"},{name:"log_2",type:"checkbox"},{name:"one_plus_log_2",type:"checkbox",help:"Take log2(1 + x)"},{name:"inverse_log_2",type:"checkbox"},{name:"quantile_normalize",type:"checkbox"},{name:"z-score",type:"checkbox",help:"Subtract mean, divide by standard deviation"},{name:"robust_z-score",type:"checkbox",help:"Subtract median, divide by median absolute deviation"},{name:"use_selected_rows_and_columns_only",type:"checkbox"}]},execute:function(e){var t=e.project;if(e.input.log_2||e.input.inverse_log_2||e.input["z-score"]||e.input["robust_z-score"]||e.input.quantile_normalize||e.input.scale_column_sum||e.input.one_plus_log_2){var r=morpheus.DatasetUtil.copy(t.getSortedFilteredDataset()),n=t.getRowSelectionModel().getViewIndices().values().sort(function(e,t){return e===t?0:e<t?-1:1});0===n.length&&(n=null);var i=t.getColumnSelectionModel().getViewIndices().values().sort(function(e,t){return e===t?0:e<t?-1:1});0===i.length&&(i=null);var o=e.input.use_selected_rows_and_columns_only?new morpheus.Slice:r;if(new morpheus.DatasetRowView(o),e.input.scale_column_sum){var a=parseFloat(e.input.column_sum);if(!isNaN(a))for(var s=0,l=o.getColumnCount();s<l;s++){for(var u=0,c=0,h=o.getRowCount();c<h;c++){var p=o.getValue(c,s);isNaN(p)||(u+=p)}var d=a/u;for(c=0,h=o.getRowCount();c<h;c++)p=o.getValue(c,s),o.setValue(c,s,p*d)}}if(e.input.log_2&&morpheus.AdjustDataTool.log2(o),e.input.one_plus_log_2&&morpheus.AdjustDataTool.log2_plus(o),e.input.inverse_log_2)for(c=0,h=o.getRowCount();c<h;c++)for(s=0,l=o.getColumnCount();s<l;s++)(p=o.getValue(c,s))>=0&&o.setValue(c,s,Math.pow(2,p));return e.input.quantile_normalize&&morpheus.QNorm.execute(o),e.input["z-score"]&&morpheus.AdjustDataTool.zScore(o),e.input["robust_z-score"]&&morpheus.AdjustDataTool.robustZScore(o),new morpheus.HeatMap({name:e.input.name||e.heatMap.getName(),dataset:o,parent:e.heatMap,symmetric:t.isSymmetric()&&o.getColumnCount()===o.getRowCount()})}}},morpheus.AnnotateDendrogramTool=function(e){this._isColumns=e},morpheus.AnnotateDendrogramTool.prototype={toString:function(){return"Annotate Dendrogram"},gui:function(){return[{name:"file",value:"",type:"file",required:!0,help:"an xlsx file or a tab-delimitted text file"}]},execute:function(e){var t=e.input.file,r=this._isColumns,n=e.heatMap,i=morpheus.Util.readLines(t),o=(morpheus.Util.getFileName(t),r?n.columnDendrogram:n.rowDendrogram),a=new morpheus.Map;morpheus.DendrogramUtil.dfs(o.tree.rootNode,function(e){return a.set(e.name,e),!0});var s=/\t/;i.then(function(e){var t=e[0].split(s),i={execute:function(i){for(var l=i.input.node_id_field,u=_.indexOf(t,l),c=1;c<e.length;c++){var h=e[c].split(s),p=h[u],d=a.get(p);if(void 0!==d)for(var f=d.info||(d.info={}),m=0;m<h.length;m++)if(m!==u){var g=f[t[m]];void 0===g&&(g=[],f[t[m]]=g),g.push(h[m])}}n.trigger("dendrogramAnnotated",{isColumns:r}),o.setInvalid(!0),o.repaint()},toString:function(){return"Select Node Id Field"},gui:function(){return[{name:"node_id_field",type:"select",options:_.map(t,function(e){return{name:e,value:e}}),required:!0}]}};morpheus.HeatMap.showTool(i,n)})}},morpheus.ChartTool=function(e){var t=this;this.project=e.project,this.heatmap=e.heatmap;var r=this.project;this.$el=$('<div class="container-fluid"><div class="row"><div data-name="configPane" class="col-xs-2"></div><div class="col-xs-10"><div style="position:relative;" data-name="chartDiv"></div></div></div><div data-name="legend"></div></div>');var n=new morpheus.FormBuilder({formStyle:"vertical"});this.formBuilder=n,n.append({name:"chart_type",type:"bootstrap-select",options:["boxplot","embedding","row profile","column profile","row scatter matrix","column scatter matrix"]});var i=[],o=[],a=[],s=[],l=[],u=[],c=function(){var e=r.getFullDataset();i=[{name:"(None)",value:""}],o=[{name:"(None)",value:""}],a=[{name:"(None)",value:""}],s=[{name:"(None)",value:""}],l=[{name:"(None)",value:""}],u=[{name:"(None)",value:""}],morpheus.MetadataUtil.getMetadataNames(e.getRowMetadata()).forEach(function(t){var r=morpheus.VectorUtil.getDataType(e.getRowMetadata().getByName(t));"number"!==r&&"[number]"!==r||a.push({name:t+" (row)",value:t+"_r"}),i.push({name:t+" (row)",value:t+"_r"})}),morpheus.MetadataUtil.getMetadataNames(e.getColumnMetadata()).forEach(function(t){var r=morpheus.VectorUtil.getDataType(e.getColumnMetadata().getByName(t));"number"!==r&&"[number]"!==r||s.push({name:t+" (column)",value:t+"_c"}),o.push({name:t+" (column)",value:t+"_c"})}),l=(l=l.concat(i.slice(1))).concat(o.slice(1)),u=(u=u.concat(a.slice(1))).concat(s.slice(1))};c(),n.append({name:"group_by",type:"bootstrap-select",options:l,multiple:!0,search:!0}),n.append({name:"axis_label",type:"bootstrap-select",options:i}),n.append({name:"show_outliers",type:"checkbox",value:!0}),n.append({name:"color",type:"bootstrap-select",options:l,search:!0}),n.append({name:"tooltip",type:"bootstrap-select",multiple:!0,search:!0,options:l.slice(1)}),n.append({name:"x_axis",type:"bootstrap-select",multiple:!1,search:!0,options:s}),n.append({name:"y_axis",type:"bootstrap-select",multiple:!1,search:!0,options:s}),n.append({name:"transform_values",type:"bootstrap-select",multiple:!0,options:["log2","log2(1+x)","z-score","robust z-score"]});var h=morpheus.CollapseDatasetTool.Functions;h.splice(morpheus.CollapseDatasetTool.Functions.indexOf(morpheus.Percentile),1),n.append({name:"combine_values",type:"bootstrap-select",multiple:!1,options:h,value:morpheus.Max}),n.append({name:"symbol_size",type:"text",value:"2",style:"width:50px;"}),this.legend=new morpheus.AbstractCanvas(!1),$(this.legend.getCanvas()).css("position",""),this.legend.setBounds({width:300,height:30}),this.$legend=this.$el.find("[data-name=legend]"),this.$legend.hide(),$(this.legend.getCanvas()).appendTo(this.$legend);var p=$('<div><button class="btn btn-default">Edit</button></div>');p.appendTo(this.$legend),p.find("button").on("click",function(e){var r=new morpheus.ColorSchemeChooser({isColumns:!0,heatMap:t.heatmap}),i=morpheus.ChartTool.getVectorInfo(n.getValue("color"));r.setAnnotationName(i.field),r.on("change",function(){m()}),morpheus.FormBuilder.showInModal({title:"Edit Colors",html:r.$div,close:"Close",draggable:!0,onClose:function(){r.off("change")}})}),n.append({name:"chart_width",type:"range",value:400,min:60,max:800,step:10}),n.append({name:"chart_height",type:"range",value:400,min:20,max:800,step:10});var d={"row profile":{axis_label:"columns",tooltip:"columns",color:"rows"},embedding:{combine_values:!0,color:["Selected Rows","columns"],x_axis:"columns",y_axis:"columns",symbol_size:!0,transform_values:!0},"column profile":{axis_label:"rows",tooltip:"rows",color:"columns"},"row scatter matrix":{axis_label:"rows",color:"columns",tooltip:"columns"},"column scatter matrix":{axis_label:"columns",color:"rows",tooltip:"rows"},boxplot:{group_by:!0,show_outliers:!0,tooltip:"both"}};function f(){var e=n.getValue("chart_type"),r=d[e];null!=r.axis_label&&n.setOptions("axis_label","rows"===r.axis_label?i:o,!0),t.$legend.css("display","embedding"===e&&null!=n.getValue("color")&&"Selected Rows"!==n.getValue("color")?"":"none"),n.setVisible("combine_values",r.combine_values&&"Selected Rows"===n.getValue("color")),n.setVisible("transform_values",r.transform_values&&"Selected Rows"===n.getValue("color")),n.setVisible("symbol_size",r.symbol_size),n.setVisible("x_axis",null!=r.x_axis),n.setVisible("y_axis",null!=r.y_axis),n.setVisible("color",null!=r.color),n.setVisible("axis_label",null!=r.axis_label),n.setVisible("group_by",r.group_by),n.setVisible("show_outliers",r.show_outliers),n.setVisible("tooltip",null!=r.tooltip),n.setOptions("tooltip","rows"===r.tooltip?i.slice(1):"columns"===r.tooltip?o.slice(1):l),n.setOptions("x_axis",s),n.setOptions("y_axis",s),null!=r.color&&("rows"===r.color?n.setOptions("color",i):"columns"===r.color?n.setOptions("color",o):_.isArray(r.color)&&n.setOptions("color",o.concat([r.color[0]])))}this.tooltip=[];var m=function(){_.debounce(t.draw(),100)};n.$form.on("change","select,input[type=range]",function(e){if("tooltip"===$(this).attr("name")){var r=t.formBuilder.getValue("tooltip");t.tooltip.length=0,null!=r&&r.forEach(function(e){t.tooltip.push(morpheus.ChartTool.getVectorInfo(e))})}else f(),m()}),n.$form.on("click","input[type=checkbox]",function(e){m()}),n.$form.on("keypress","input[type=text]",function(e){13===e.which&&m()}),f();var g=function(){c(),f(),n.setOptions("group_by",l,!0)};r.getColumnSelectionModel().on("selectionChanged.chart",m),r.getRowSelectionModel().on("selectionChanged.chart",m),r.on("trackChanged.chart",g),this.$chart=this.$el.find("[data-name=chartDiv]");var v=$('<div style="background:white;" title="Chart"></div>'),y=this.$el.find("[data-name=configPane]");n.$form.appendTo(y),this.$el.appendTo(v),v.dialog({dialogClass:"morpheus",close:function(e,n){r.off("trackChanged.chart",g),r.getRowSelectionModel().off("selectionChanged.chart",m),r.getColumnSelectionModel().off("selectionChanged.chart",m),t.$el.empty()},resizable:!0,height:600,width:900}),this.$dialog=v,this.draw()},morpheus.ChartTool.getVectorInfo=function(e){return{field:e.substring(0,e.length-2),isColumns:"_c"===e.substring(e.length-2)}},morpheus.ChartTool.prototype={_createScatter:function(e){for(var t=this,r=e.dataset,n=e.colorByVector,i=e.colorModel,o=(this.heatmap,e.chartWidth),a=e.chartHeight,s=e.axisLabelVector,l=e.transpose,u={animation:!1,toolbox:{feature:{brush:{title:{rect:"Rectangle selection",polygon:"Polygon selection",clear:"Clear Selection",keep:"Keep previous selection"}}}},brush:{brushLink:"all",xAxisIndex:[],yAxisIndex:[],inBrush:{opacity:1}},tooltip:{trigger:"item"},grid:[],xAxis:[],yAxis:[],series:[]},c=0,h=1,p=r.getRowCount();h<p;h++)for(var d=0;d<h;d++)!function(){for(var e=[],f=[],m=0,g=r.getColumnCount();m<g;m++)e.push([r.getValue(h,m),r.getValue(d,m),m]);if(n)for(m=0,g=r.getColumnCount();m<g;m++){var v=n.getValue(m);f.push(i.getMappedValue(n,v))}u.grid.push({left:20+(h-1)*(o+20),top:40+d*(a+20),width:o,height:a}),u.brush.xAxisIndex&&u.brush.xAxisIndex.push(c),u.brush.yAxisIndex&&u.brush.yAxisIndex.push(c),u.xAxis.push({splitNumber:3,position:"top",name:null!=s&&0===d?s.getValue(h):"",nameGap:25,nameLocation:"middle",axisLine:{show:!1,onZero:!1},axisTick:{show:0===d,inside:!0},axisLabel:{show:0===d},type:"value",gridIndex:c,scale:!0}),u.yAxis.push({splitNumber:3,nameGap:50,name:null!=s&&h===p-1?s.getValue(d):"",nameLocation:"middle",position:"right",axisLine:{show:!1,onZero:!1},axisTick:{show:h===p-1,inside:!0},axisLabel:{show:h===p-1},type:"value",gridIndex:c,scale:!0}),u.series.push({symbolSize:4,tooltip:{formatter:function(e){var n=e.value,i=[];return i.push("x: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(n[0])),i.push("<br>"),i.push("y "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(n[1])),l?morpheus.ChartTool.getTooltip({text:i,tooltip:t.tooltip,dataset:new morpheus.TransposedDatasetView(r),rowIndex:n[2],columnIndex:-1}):morpheus.ChartTool.getTooltip({text:i,tooltip:t.tooltip,dataset:r,rowIndex:-1,columnIndex:n[2]}),i.join("")}},itemStyle:{normal:{color:function(e){return 0===f.length?"#1f78b4":f[e.dataIndex]}}},type:"scatter",xAxisIndex:c,yAxisIndex:c,data:e}),c++}();echarts.init(e.el).setOption(u)},_createProfile:function(e){for(var t=this,r=e.dataset,n=e.colorByVector,i=e.colorModel,o=(this.heatmap,e.chartWidth,e.chartHeight,e.axisLabelVector),a=(e.transpose,[]),s=0,l=r.getColumnCount();s<l;s++)a.push(null!=o?o.getValue(s):""+s);for(var u=[],c=morpheus.VectorColorModel.getColorMapForNumber(r.getRowCount()),h=0,p=r.getRowCount();h<p;h++){var d=null!=n?n.getValue(h):""+h,f=(null!=n?i.getMappedValue(n,d):c[h%c.length],[]);for(s=0,l=r.getColumnCount();s<l;s++)f.push([s,r.getValue(h,s),h]);u.push({name:d,type:"line",data:f,tooltip:{formatter:function(e){var n=e.value,i=[];return i.push(t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(n[1])),morpheus.ChartTool.getTooltip({text:i,tooltip:t.tooltip,dataset:r,rowIndex:n[2],columnIndex:n[0]}),i.join("")}}})}var m={legend:{orient:"vertical",left:"right",top:2,itemWidth:14,height:20*r.getRowCount(),data:u.map(function(e){return e.name})},animation:!1,tooltip:{trigger:"item"},xAxis:{type:"category",data:a},yAxis:{axisLine:{show:!0,onZero:!1},type:"value",name:""},grid:{right:120},series:u};echarts.init(e.el).setOption(m)},_createEmbedding:function(e){var t=this,r=e.fullDataset,n=e.dataset,i=e.transpose,o=e.xVector,a=e.yVector,s=e.collapseFunction,l=e.symbolSize,u=e.dataTransformations;if(null!=o&&null!=a){var c,h=e.colorByVector,p=e.colorModel,d=(this.heatmap,e.chartWidth,void e.chartHeight);if(null!=n){c=new Float32Array(n.getColumnCount()),u.length>0&&(n=morpheus.DatasetUtil.copy(n),u.forEach(function(e){e(n)}));for(var f=new morpheus.DatasetColumnView(n),m=0,g=n.getColumnCount();m<g;m++)c[m]=s(f.setIndex(m));var v=morpheus.Vector.fromArray("",c),y=morpheus.VectorUtil.getMinMax(v);d={type:"continuous",min:y.min,max:y.max,dimension:3,orient:"horizontal",left:0,top:"bottom",text:["",""],calculable:!0,inRange:{color:["#ffeda0","#feb24c","#f03b20"]},outOfRange:{color:["rgb(217,217,217)"],opacity:.5}}}var b=[],w=[],x=!1;null!=h&&(x=!h.getProperties().get(morpheus.VectorKeys.DISCRETE)),m=0;for(var _=o.size();m<_;m++)null!=n?b.push([o.getValue(m),a.getValue(m),m,c[m]]):null!=h?(x?w.push(p.getContinuousMappedValue(h,h.getValue(m))):w.push(p.getMappedValue(h,h.getValue(m))),b.push([o.getValue(m),a.getValue(m),m])):b.push([o.getValue(m),a.getValue(m),m]);var S={animation:!1,tooltip:{trigger:"item"},xAxis:[{axisTick:{show:!1},axisLabel:{show:!1},axisLine:{show:!0,onZero:!1},splitLine:{show:!1},boundaryGap:!1,type:"value",name:""}],visualMap:d,yAxis:[{axisTick:{show:!1},axisLabel:{show:!1},axisLine:{show:!0,onZero:!1},splitLine:{show:!1},boundaryGap:!1,type:"value",name:""}],series:[{type:"scatterGL",data:b,large:!1,symbolSize:l,tooltip:{formatter:function(e){var n=e.value,o=[];return i?morpheus.ChartTool.getTooltip({text:o,tooltip:t.tooltip,dataset:new morpheus.TransposedDatasetView(r),rowIndex:n[2],columnIndex:-1}):morpheus.ChartTool.getTooltip({text:o,tooltip:t.tooltip,dataset:r,rowIndex:-1,columnIndex:n[2]}),o.join("")}},itemStyle:{color:function(e){return 0===w.length?"#1f78b4":w[e.dataIndex]}}}]};echarts.init(e.el).setOption(S)}},_createBoxPlot:function(e){for(var t=this,r=e.datasets,n=e.ids,i=(this.heatmap,[]),o=[],a=0,s=r.length;a<s;a++){for(var l=r[a],u=n[a],c=new Float32Array(l.getRowCount()*l.getColumnCount()),h=0,p=0,d=l.getRowCount();p<d;p++)for(var f=0,m=l.getColumnCount();f<m;f++){var g=l.getValue(p,f);isNaN(g)||(c[h]=g,h++)}h!==c.length&&(c=c.slice(0,h)),c.sort();var v=morpheus.BoxPlotArrayItem(c);if(i.push([v.lowerAdjacentValue,v.q1,v.median,v.q3,v.upperAdjacentValue]),e.showOutliers){var y=v.q3+1.5*(v.q3-v.q1),b=v.q1-1.5*(v.q3-v.q1);for(p=0,d=l.getRowCount();p<d;p++)for(f=0,m=l.getColumnCount();f<m;f++)((g=l.getValue(p,f))>y||g<b)&&o.push([u,g,p,f])}}var w={animation:!1,tooltip:{trigger:"item"},xAxis:{type:"category",data:n},yAxis:{axisLine:{show:!0,onZero:!1},type:"value",name:""},series:[{animationDuration:0,hoverAnimation:!1,name:"boxplot",type:"boxplot",data:i,tooltip:{formatter:function(e){var r=[];return""!==e.name&&r.push(e.name),(r=r.concat(["upper: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(e.data[4]),"Q3: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(e.data[3]),"median: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(e.data[2]),"Q1: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(e.data[1]),"lower: "+t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(e.data[0])])).join("<br/>")}}},{name:"outlier",type:"scatter",data:o,symbolSize:5,itemStyle:{normal:{borderWidth:1,borderColor:"black",opacity:.8}},tooltip:{formatter:function(e){var r=e.value,n=[];return""!==r[0]&&(n.push(r[0]),n.push("<br>")),n.push(t.heatmap.getHeatMapElementComponent().getDrawValuesFormat()(r[1])),morpheus.ChartTool.getTooltip({text:n,tooltip:t.tooltip,dataset:l,rowIndex:r[2],columnIndex:r[3]}),n.join("")}}}]};echarts.init(e.el).setOption(w)},draw:function(){this.$chart.empty();var e=parseInt(this.formBuilder.getValue("chart_width")),t=parseInt(this.formBuilder.getValue("chart_height")),r=this.formBuilder.getValue("show_outliers"),n=this.formBuilder.getValue("group_by"),i=this.formBuilder.getValue("axis_label"),o=this.formBuilder.getValue("chart_type"),a="embedding"!==o?this.project.getSelectedDataset({emptyToAll:!1}):this.project.getFullDataset();if(this.dataset=a,"embedding"!==o){if(0===a.getRowCount()&&0===a.getColumnCount())return void $("<h4>Please select rows and columns in the heat map.</h4>").appendTo(this.$chart);if(0===a.getRowCount())return void $("<h4>Please select rows in the heat map.</h4>").appendTo(this.$chart);if(0===a.getColumnCount())return void $("<h4>Please select columns in the heat map.</h4>").appendTo(this.$chart)}this.heatmap;var s=morpheus.ChartTool.getVectorInfo(i),l=s.isColumns?a.getColumnMetadata().getByName(s.field):a.getRowMetadata().getByName(s.field),u=this.formBuilder.getValue("color"),c=null,h=null;if(null!=u&&"Selected Rows"!==u){var p=morpheus.ChartTool.getVectorInfo(u);if(h=p.isColumns?this.project.getColumnColorModel():this.project.getRowColorModel(),null==(c=p.isColumns?a.getColumnMetadata().getByName(p.field):a.getRowMetadata().getByName(p.field))||"embedding"!==o||c.getProperties().get(morpheus.VectorKeys.DISCRETE))this.$legend.hide();else{var d=this.legend.getCanvas().getContext("2d"),f=this.heatmap.getProject().getColumnColorModel().getContinuousColorScheme(c);null==f&&(f=this.heatmap.getProject().getColumnColorModel().createContinuousColorMap(c)),morpheus.CanvasUtil.resetTransform(d),d.clearRect(0,0,this.legend.getUnscaledWidth(),this.legend.getUnscaledWidth()),d.translate(15,0),morpheus.HeatMapColorSchemeLegend.drawColorScheme(d,f,200),this.$legend.show()}}if("embedding"===o){var m=morpheus.ChartTool.getVectorInfo(this.formBuilder.getValue("x_axis")),g=m.isColumns?a.getColumnMetadata().getByName(m.field):a.getRowMetadata().getByName(m.field),v=morpheus.ChartTool.getVectorInfo(this.formBuilder.getValue("y_axis")),y=v.isColumns?a.getColumnMetadata().getByName(v.field):a.getRowMetadata().getByName(v.field),b=this.formBuilder.getValue("transform_values");null==b&&(b=[]);var w=[];-1!==b.indexOf("log2")&&w.push(morpheus.AdjustDataTool.log2),-1!==b.indexOf("log2(1+x)")&&w.push(morpheus.AdjustDataTool.log2_plus),-1!==b.indexOf("z-score")&&w.push(morpheus.AdjustDataTool.zScore),-1!==b.indexOf("robust z-score")&&w.push(morpheus.AdjustDataTool.robustZScore),(_=$('<div style="width: '+e+"px;height:"+(t+120)+'px;"></div>')).appendTo(this.$chart),this._createEmbedding({xVector:g,yVector:y,width:e,collapseFunction:morpheus.CollapseDatasetTool.Functions.fromString(this.formBuilder.getValue("combine_values")),dataTransformations:w,symbolSize:parseFloat(this.formBuilder.getValue("symbol_size")),el:_[0],fullDataset:a,dataset:"Selected Rows"===u?this.project.getSelectedDataset({emptyToAll:!1,selectedColumns:!1}):null,chartWidth:e,chartHeight:t,transpose:!1,colorModel:h,colorByVector:c})}else if("row profile"===o||"column profile"===o){if((x="column profile"===o)&&(a=new morpheus.TransposedDatasetView(a)),a.getRowCount()>100)return void $("<h4>Maximum chart size exceeded.</h4>").appendTo(this.$chart);(_=$('<div style="width: '+(e+120)+"px;height:"+t+'px;"></div>')).appendTo(this.$chart),this._createProfile({width:e,el:_[0],dataset:a,chartWidth:e,chartHeight:t,transpose:x,colorModel:h,colorByVector:c,axisLabelVector:l})}else if("row scatter matrix"===o||"column scatter matrix"===o){var x,_;if((x="column scatter matrix"===o)&&(a=new morpheus.TransposedDatasetView(a)),a.getRowCount()>20)return void $("<h4>Maximum chart size exceeded.</h4>").appendTo(this.$chart);(_=$('<div style="width:'+(80+(a.getRowCount()-1)*(e+20))+"px;height:"+(80+a.getRowCount()*(t+20))+'px;"></div>')).appendTo(this.$chart),this._createScatter({el:_[0],dataset:a,chartWidth:e,chartHeight:t,transpose:x,colorModel:h,colorByVector:c,axisLabelVector:l})}else if("boxplot"===o){var S=[],C=[];if(n&&n.length>0){var M,T,A=[],E=[];n.forEach(function(e){var t,r=morpheus.ChartTool.getVectorInfo(e);r.isColumns?null!=(t=a.getColumnMetadata().getByName(r.field))?A.push(t):console.log(t.getName()+" not found"):null!=(t=a.getRowMetadata().getByName(r.field))?E.push(t):console.log(t.getName()+" not found")}),0===A.length?(M=new morpheus.Map).set("",null):M=morpheus.VectorUtil.createValuesToIndicesMap(A),0===E.length?(T=new morpheus.Map).set("",null):(console.log(E),T=morpheus.VectorUtil.createValuesToIndicesMap(E)),M.forEach(function(e,t){T.forEach(function(r,n){S.push(new morpheus.SlicedDatasetView(a,r,e));var i=t;""!==i&&(i+=" "),i+=n,C.push(i)})})}else S.push(a),C.push("");var P=$('<div style="width: '+e+"px;height:"+t+'px;"></div>');P.appendTo(this.$chart),this._createBoxPlot({showOutliers:r,el:P[0],datasets:S,ids:C})}}},morpheus.ChartTool.getTooltip=function(e){for(var t=0;t<e.tooltip.length;t++){var r,n,i=e.tooltip[t];if(i.isColumns?(r=e.dataset.getColumnMetadata(),n=e.columnIndex):(r=e.dataset.getRowMetadata(),n=e.rowIndex),-1!==n){var o=r.getByName(i.field);morpheus.HeatMapTooltipProvider.vectorToString(o,n,e.text,"<br>")}}},morpheus.CollapseDatasetTool=function(){},morpheus.CollapseDatasetTool.Functions=[morpheus.Mean,morpheus.Median,new morpheus.MaxPercentiles([25,75]),morpheus.Min,morpheus.Max,morpheus.Percentile,morpheus.Sum],morpheus.CollapseDatasetTool.Functions.fromString=function(e){for(var t=0;t<morpheus.CollapseDatasetTool.Functions.length;t++)if(morpheus.CollapseDatasetTool.Functions[t].toString()===e)return morpheus.CollapseDatasetTool.Functions[t];throw new Error(e+" not found")},morpheus.CollapseDatasetTool.prototype={toString:function(){return"Collapse"},init:function(e,t){var r=function(r){var n="Rows"===r,i=morpheus.MetadataUtil.getMetadataNames(n?e.getFullDataset().getRowMetadata():e.getFullDataset().getColumnMetadata());t.setOptions("collapse_to_fields",i)};t.$form.find("[name=collapse]").on("change",function(e){r($(this).val())}),t.setVisible("percentile",!1),t.$form.find("[name=collapse_method]").on("change",function(e){t.setVisible("percentile",$(this).val()===morpheus.Percentile.toString())}),r("Rows"),t.setVisible("percentile",!1),t.$form.find("[name=collapse_method]").on("change",function(e){t.setVisible("percentile",$(this).val()===morpheus.Percentile.toString())}),t.$form.find("[name=compute_percent]").on("change",function(e){t.setVisible("pass_expression",t.getValue("compute_percent")),t.setVisible("pass_value",t.getValue("compute_percent"))}),t.setVisible("pass_expression",!1),t.setVisible("pass_value",!1)},gui:function(e){return[{name:"collapse_method",options:morpheus.CollapseDatasetTool.Functions,value:morpheus.CollapseDatasetTool.Functions[1].toString(),type:"select"},{name:"percentile",value:75,type:"text"},{name:"collapse",options:["Columns","Rows"],value:"Rows",type:"radio"},{name:"collapse_to_fields",options:[],type:"select",multiple:!0},{name:"compute_percent",type:"checkbox",help:"Whether to calculate the percentage of items in a collapsed group that passed an expression"},{name:"pass_expression",options:[">=",">","<","<="],type:"bootstrap-select"},{name:"pass_value",type:"text",help:'The corresponding value for "percent operator"'}]},execute:function(e){var t=e.project,r=morpheus.CollapseDatasetTool.Functions.fromString(e.input.collapse_method);if(r.toString()===morpheus.Percentile.toString()){var n=parseFloat(e.input.percentile);r=function(e){return morpheus.Percentile(e,n)}}var i=e.input.collapse_to_fields;if(0===i.length)throw new Error("Please select one or more fields to collapse to");var o=t.getFullDataset(),a="Rows"==e.input.collapse;a||(o=new morpheus.TransposedDatasetView(o));var s=null;if(e.input.compute_percent){var l=parseFloat(e.input.pass_value);if(!isNaN(l)){var u=e.input.pass_expression;">="===u?s=function(e){return e>=l}:">"===u?s=function(e){return e>l}:"<="===u?s=function(e){return e<=l}:"<"===u&&(s=function(e){return e<l})}}o=morpheus.CollapseDataset(o,i,r,!0,s),a||(o=new morpheus.TransposedDatasetView(o));var c=new morpheus.HeatMap({name:e.input.name||e.heatMap.getName(),dataset:o,parent:e.heatMap,symmetric:!1,shape:null!=s?"circle":null});return e.input.compute_percent&&(c.heatmap.colorScheme.getSizer().setSeriesName("percent"),c.heatmap.colorScheme.getSizer().setMin(0),c.heatmap.colorScheme.getSizer().setMax(75),c.heatmap.setShape("circle"),c.heatmap.setInvalid(!0),c.heatmap.repaint()),c}},morpheus.CreateAnnotation=function(){},morpheus.CreateAnnotation.prototype={toString:function(){return"Create Calculated Annotation"},gui:function(){return[{name:"annotate",options:["Columns","Rows"],value:"Rows",type:"radio"},{name:"annotation_name",value:"",type:"text",required:!0,autocomplete:"off"},{name:"formula",value:"",type:"textarea",placeholder:"e.g MAD()",required:!0,help:"JavaScript formula. Built-in functions (case-sensitive): COUNTIF(expression), MAD(), MAX(), MEAN(), MEDIAN(), MIN(), PERCENTILE(p), SUM(), VARIANCE(). Refer to a field using FIELD(name)"},{name:"use_selected_rows_and_columns_only",type:"checkbox"}]},execute:function(options){var __project=options.project,isColumns="Columns"==options.input.annotate,__formula=options.input.formula,__dataset=options.input.use_selected_rows_and_columns_only?__project.getSelectedDataset():__project.getSortedFilteredDataset();isColumns&&(__dataset=new morpheus.TransposedDatasetView(__dataset));for(var __rowView=new morpheus.DatasetRowView(__dataset),__vector=__dataset.getRowMetadata().add(options.input.annotation_name),COUNTIF=function(e){return morpheus.CountIf(__rowView,e)},MAD=function(){return morpheus.MAD(__rowView)},MAX=function(){return morpheus.Max(__rowView)},MEAN=function(){return morpheus.Mean(__rowView)},MEDIAN=function(e){return morpheus.Percentile(__rowView,50)},MIN=function(){return morpheus.Min(__rowView)},PERCENTILE=function(e){return morpheus.Percentile(__rowView,e)},SUM=function(){return morpheus.Sum(__rowView)},VARIANCE=function(){return morpheus.Variance(__rowView)},__index=0,FIELD=function(e){var t=__dataset.getRowMetadata().getByName(e);return t?t.getValue(__index):void 0},size=__dataset.getRowCount();__index<size;__index++){__rowView.setIndex(__index);var __val=eval(__formula);"function"==typeof __val&&(__val=""),__vector.setValue(__index,__val)}morpheus.VectorUtil.maybeConvertStringToNumber(__vector),__project.trigger("trackChanged",{vectors:[__vector],display:["text"],columns:isColumns})}},morpheus.DendrogramEnrichmentTool=function(e){this.isColumns=e},morpheus.DendrogramEnrichmentTool.prototype={toString:function(){return"Dendrogram Enrichment"},gui:function(e){var t=e.getSortedFilteredDataset();return[{name:"field",options:morpheus.MetadataUtil.getMetadataNames(this.isColumns?t.getColumnMetadata():t.getRowMetadata()),type:"bootstrap-select",multiple:!1},{name:"min_p-value_for_enrichment",type:"text",value:"0.05"},{name:"minimum_number_of_total_members_in_group",type:"text",value:"5"},{name:"minimum_number_of_members_in_group",type:"text",value:"3"}]},execute:function(e){var t=e.project,r=e.heatMap,n=e.input["min_p-value_for_enrichment"],i=e.input.minimum_number_of_total_members_in_group,o=e.input.minimum_number_of_members_in_group,a=t.getSortedFilteredDataset(),s=this.isColumns?r.columnDendrogram:r.rowDendrogram,l=this.isColumns?a.getColumnMetadata().getByName(e.input.field):a.getRowMetadata().getByName(e.input.field),u=morpheus.VectorUtil.createValueToIndicesMap(l),c=new morpheus.Map,h=[];u.forEach(function(e,t){c.set(t,e.length),h.push(t)});var p=h.length,d=l.size();morpheus.DendrogramUtil.dfs(s.tree.rootNode,function(e){delete e.info;for(var t=new morpheus.Map,r=0;r<p;r++)t.set(h[r],0);var a=e.minIndex,s=e.maxIndex,u=s-a+1;if(u>1&&u>=i){for(r=a;r<=s;r++){var f=l.getValue(r);t.set(f,t.get(f)+1)}for(r=0;r<p;r++){var m=c.get(h[r]),g=t.get(h[r]);if(g>=o){var v=g,y=m-g,b=u-g,w=d+g-u-m,x=morpheus.FisherExact.fisherTest(v,y,b,w);x<=n&&(e.info||(e.info={}),e.info[h[r]]=x)}}}return!0}),s.setInvalid(!0),s.repaint()}},morpheus.DevAPI=function(){},morpheus.DevAPI.prototype={toString:function(){return"API"},gui:function(){return[{name:"code",value:"",type:"textarea",required:!0,help:"Enter your code"}]},execute:function(options){var heatMap=options.heatMap,code=options.input.code;eval(code),heatMap.getProject().setFullDataset(heatMap.getProject().getFullDataset(),!0)}},morpheus.HClusterTool=function(){},morpheus.HClusterTool.PRECOMPUTED_DIST="Matrix values (for a precomputed distance matrix)",morpheus.HClusterTool.PRECOMPUTED_SIM="Matrix values (for a precomputed similarity matrix)",morpheus.HClusterTool.Functions=[morpheus.Euclidean,morpheus.Jaccard,new morpheus.OneMinusFunction(morpheus.Cosine),new morpheus.OneMinusFunction(morpheus.KendallsCorrelation),new morpheus.OneMinusFunction(morpheus.Pearson),new morpheus.OneMinusFunction(morpheus.Spearman),morpheus.HClusterTool.PRECOMPUTED_DIST,morpheus.HClusterTool.PRECOMPUTED_SIM],morpheus.HClusterTool.Functions.fromString=function(e){for(var t=0;t<morpheus.HClusterTool.Functions.length;t++)if(morpheus.HClusterTool.Functions[t].toString()===e)return morpheus.HClusterTool.Functions[t];throw new Error(e+" not found")},morpheus.HClusterTool.createLinkageMethod=function(e){var t;if("Average"===e)t=morpheus.AverageLinkage;else if("Complete"===e)t=morpheus.CompleteLinkage;else{if("Single"!==e)throw new Error("Unknown linkage method "+e);t=morpheus.SingleLinkage}return t},morpheus.HClusterTool.execute=function(e,t){var r=morpheus.HClusterTool.createLinkageMethod(t.linkage_method),n=morpheus.HClusterTool.Functions.fromString(t.metric);n===morpheus.HClusterTool.PRECOMPUTED_DIST?n=0:n===morpheus.HClusterTool.PRECOMPUTED_SIM&&(n=1);var i,o,a="Rows"==t.cluster||"Rows and columns"==t.cluster,s="Columns"==t.cluster||"Rows and columns"==t.cluster,l=function(e,t){return t&&t.length>0?new morpheus.HClusterGroupBy(e,t,n,r):new morpheus.HCluster(morpheus.HCluster.computeDistanceMatrix(e,n),r)};return a&&(i=l(t.selectedColumnsToUseForClusteringRows?new morpheus.SlicedDatasetView(e,null,t.selectedColumnsToUseForClusteringRows):e,t.group_rows_by)),s&&(o=l(new morpheus.TransposedDatasetView(t.selectedRowsToUseForClusteringColumns?new morpheus.SlicedDatasetView(e,t.selectedRowsToUseForClusteringColumns,null):e),t.group_columns_by)),{rowsHcl:i,columnsHcl:o}},morpheus.HClusterTool.prototype={toString:function(){return"Hierarchical Clustering"},init:function(e,t){t.setOptions("group_rows_by",morpheus.MetadataUtil.getMetadataNames(e.getFullDataset().getRowMetadata())),t.setOptions("group_columns_by",morpheus.MetadataUtil.getMetadataNames(e.getFullDataset().getColumnMetadata())),t.setVisible("group_rows_by",!1),t.setVisible("cluster_rows_in_space_of_selected_columns_only",!1),t.$form.find("[name=cluster]").on("change",function(e){var r=$(this).val(),n=!1,i=!1;"Columns"===r?n=!0:"Rows"===r?i=!0:(n=!0,i=!0),t.setVisible("group_columns_by",n),t.setVisible("group_rows_by",i),t.setVisible("cluster_columns_in_space_of_selected_rows_only",n),t.setVisible("cluster_rows_in_space_of_selected_columns_only",i)})},gui:function(){return[{name:"metric",options:morpheus.HClusterTool.Functions,value:morpheus.HClusterTool.Functions[4].toString(),type:"select"},{name:"linkage_method",options:["Average","Complete","Single"],value:"Average",type:"select"},{name:"cluster",options:["Columns","Rows","Rows and columns"],value:"Columns",type:"select"},{name:"group_columns_by",options:[],type:"bootstrap-select",multiple:!0},{name:"group_rows_by",options:[],type:"bootstrap-select",multiple:!0},{name:"cluster_columns_in_space_of_selected_rows_only",type:"checkbox"},{name:"cluster_rows_in_space_of_selected_columns_only",type:"checkbox"}]},execute:function(e){var t=e.project,r=e.heatMap,n=e.input.cluster_columns_in_space_of_selected_rows_only?t.getRowSelectionModel().getViewIndices().values():null;null!=n&&0===n.length&&(n=null);var i=e.input.cluster_rows_in_space_of_selected_columns_only?t.getColumnSelectionModel().getViewIndices().values():null;null!=i&&0===i.length&&(i=null);var o="Rows"==e.input.cluster||"Rows and columns"==e.input.cluster,a="Columns"==e.input.cluster||"Rows and columns"==e.input.cluster;e.input.selectedRowsToUseForClusteringColumns=n,e.input.selectedColumnsToUseForClusteringRows=i;var s,l,u=t.getSortedFilteredDataset();if(void 0===e.input.background&&(e.input.background=!0),e.input.background=e.input.background&&"undefined"!=typeof Worker,o){s=[];for(var c=0;c<u.getRowCount();c++)s[c]=t.convertViewRowIndexToModel(c)}if(a)for(l=[],c=0;c<u.getColumnCount();c++)l[c]=t.convertViewColumnIndexToModel(c);if(!1!==e.input.background){var h=new Blob(["self.onmessage = function(e) {importScripts(e.data.scripts);self.postMessage(morpheus.HClusterTool.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),p=window.URL.createObjectURL(h),d=new Worker(p);return d.postMessage({scripts:morpheus.Util.getScriptPath(),dataset:morpheus.Dataset.toJSON(u,{columnFields:e.input.group_columns_by||[],rowFields:e.input.group_rows_by||[],seriesIndices:[0]}),input:e.input}),d.onmessage=function(e){var t=e.data;if(t.rowsHcl){for(var n=[],i=0;i<t.rowsHcl.reorderedIndices.length;i++)n[i]=s[t.rowsHcl.reorderedIndices[i]];r.setDendrogram(t.rowsHcl.tree,!1,n)}if(t.columnsHcl){for(n=[],i=0;i<t.columnsHcl.reorderedIndices.length;i++)n[i]=l[t.columnsHcl.reorderedIndices[i]];r.setDendrogram(t.columnsHcl.tree,!0,n)}d.terminate(),window.URL.revokeObjectURL(p)},d}var f=morpheus.HClusterTool.execute(u,e.input);if(f.rowsHcl){var m=[];for(c=0;c<f.rowsHcl.reorderedIndices.length;c++)m[c]=s[f.rowsHcl.reorderedIndices[c]];r.setDendrogram(f.rowsHcl.tree,!1,m)}if(f.columnsHcl){for(m=[],c=0;c<f.columnsHcl.reorderedIndices.length;c++)m[c]=l[f.columnsHcl.reorderedIndices[c]];r.setDendrogram(f.columnsHcl.tree,!0,m)}}},morpheus.KMeansTool=function(){},morpheus.KMeansTool.execute=function(e,t){var r=morpheus.HClusterTool.Functions.fromString(t.metric);r===morpheus.HClusterTool.PRECOMPUTED_DIST?r=0:r===morpheus.HClusterTool.PRECOMPUTED_SIM&&(r=1);var n,i,o="Rows"==t.cluster||"Rows and columns"==t.cluster,a="Columns"==t.cluster||"Rows and columns"==t.cluster,s=function(e){for(var n=new morpheus.KMeansPlusPlusClusterer(t.number_of_clusters,t.maximum_iterations,r),i=[],o=0;o<e.getRowCount();o++)i.push(new morpheus.DatasetRowView(e).setIndex(o));var a=n.execute(i),s=[];for(o=0;o<a.length;o++)a[o].getPoints().forEach(function(e){s[e.i]=o+1});return s};return o&&(n=s(t.selectedColumnsToUseForClusteringRows?new morpheus.SlicedDatasetView(e,null,t.selectedColumnsToUseForClusteringRows):e)),a&&(i=s(new morpheus.TransposedDatasetView(t.selectedRowsToUseForClusteringColumns?new morpheus.SlicedDatasetView(e,t.selectedRowsToUseForClusteringColumns,null):e))),{rowAssignments:n,columnAssignments:i}},morpheus.KMeansTool.prototype={toString:function(){return"KMeans Clustering"},init:function(e,t){t.setVisible("cluster_rows_in_space_of_selected_columns_only",!1),t.$form.find("[name=cluster]").on("change",function(e){var r=$(this).val(),n=!1,i=!1;"Columns"===(r=$(this).val())?n=!0:"Rows"===r?i=!0:(n=!0,i=!0),t.setVisible("cluster_columns_in_space_of_selected_rows_only",n),t.setVisible("cluster_rows_in_space_of_selected_columns_only",i)})},gui:function(){return[{name:"metric",options:morpheus.HClusterTool.Functions,value:morpheus.HClusterTool.Functions[4].toString(),type:"select"},{name:"cluster",options:["Columns","Rows","Rows and columns"],value:"Columns",type:"select"},{name:"number_of_clusters",value:"2",type:"text"},{name:"cluster_columns_in_space_of_selected_rows_only",type:"checkbox"},{name:"cluster_rows_in_space_of_selected_columns_only",type:"checkbox"},{name:"maximum_iterations",value:"1000",type:"text"}]},execute:function(e){var t=e.project,r=e.heatMap;e.input.number_of_clusters=parseInt(e.input.number_of_clusters),e.input.maximum_iterations=parseInt(e.input.maximum_iterations);var n=e.input.cluster_columns_in_space_of_selected_rows_only?t.getRowSelectionModel().getViewIndices().values():null;null!=n&&0===n.length&&(n=null);var i=e.input.cluster_rows_in_space_of_selected_columns_only?t.getColumnSelectionModel().getViewIndices().values():null;null!=i&&0===i.length&&(i=null),"Rows"==e.input.cluster||e.input.cluster,"Columns"==e.input.cluster||e.input.cluster,e.input.selectedRowsToUseForClusteringColumns=n,e.input.selectedColumnsToUseForClusteringRows=i;var o=t.getSortedFilteredDataset();function a(e,t,r){for(var n=e.getColumnMetadata().add("k_means_"+r),i=0;i<t.length;i++)n.setValue(i,t[i])}if(e.input.background=e.input.background&&"undefined"!=typeof Worker,!1!==e.input.background){var s=new Blob(["self.onmessage = function(e) {importScripts(e.data.scripts);self.postMessage(morpheus.KMeansTool.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),l=window.URL.createObjectURL(s),u=new Worker(l);return u.postMessage({scripts:morpheus.Util.getScriptPath(),dataset:morpheus.Dataset.toJSON(o,{columnFields:[],rowFields:[],seriesIndices:[0]}),input:e.input}),u.onmessage=function(t){var n=t.data;n.columnAssignments&&(a(o,n.columnAssignments,e.input.number_of_clusters),r.addTrack("k_means_"+e.input.number_of_clusters,!0,{highlightMatchingValues:!0,discrete:!0,display:["color"]})),n.rowAssignments&&(a(new morpheus.TransposedDatasetView(o),n.rowAssignments,e.input.number_of_clusters),r.addTrack("k_means_"+e.input.number_of_clusters,!1,{highlightMatchingValues:!0,discrete:!0,display:["color"]})),r.revalidate(),u.terminate(),window.URL.revokeObjectURL(l)},u}var c=morpheus.KMeansTool.execute(o,e.input);c.columnAssignments&&(a(o,c.columnAssignments,e.input.number_of_clusters),r.addTrack("k_means_"+e.input.number_of_clusters,!0,{highlightMatchingValues:!0,discreteAutoDetermined:!0,display:["color"]})),c.rowAssignments&&(a(new morpheus.TransposedDatasetView(o),c.rowAssignments,e.input.number_of_clusters),r.addTrack("k_means_"+e.input.number_of_clusters,!1,{highlightMatchingValues:!0,discreteAutoDetermined:!0,display:["color"]})),r.revalidate()}},morpheus.MarkerSelection=function(){},morpheus.MarkerSelection.Functions=[morpheus.FisherExact,morpheus.FoldChange,morpheus.MeanDifference,morpheus.SignalToNoise,morpheus.createSignalToNoiseAdjust(),morpheus.TTest],morpheus.MarkerSelection.Functions.fromString=function(e){for(var t=0;t<morpheus.MarkerSelection.Functions.length;t++)if(morpheus.MarkerSelection.Functions[t].toString()===e)return morpheus.MarkerSelection.Functions[t];throw e+" not found"},morpheus.MarkerSelection.execute=function(e,t){for(var r=[],n=[],i=0;i<t.numClassA;i++)r[i]=i;for(i=t.numClassA;i<e.getColumnCount();i++)n[i]=i;var o=morpheus.MarkerSelection.Functions.fromString(t.metric),a=new morpheus.PermutationPValues(e,r,n,t.npermutations,o);return{rowSpecificPValues:a.rowSpecificPValues,k:a.k,fdr:a.fdr,scores:a.scores}},morpheus.MarkerSelection.prototype={toString:function(){return"Marker Selection"},init:function(e,t){t.$form.find("[name=field]").on("change",function(r){!function(r){var n=[];if(null!=r&&r.length>0){var i=morpheus.MetadataUtil.getVectors(e.getFullDataset().getColumnMetadata(),r);morpheus.VectorUtil.createValuesToIndicesMap(i).forEach(function(e,t){n.push(t)})}n.sort(),t.setOptions("class_a",n),t.setOptions("class_b",n)}($(this).val())}),t.$form.find("[name=metric]").on("change",function(e){var r="Fisher Exact Test"===$(this).val();t.setVisible("grouping_value",r),t.setVisible("permutations",!r),t.setVisible("number_of_markers",!r)}),t.setVisible("grouping_value",!1)},gui:function(e){var t=e.getSortedFilteredDataset(),r=morpheus.MetadataUtil.getMetadataNames(t.getColumnMetadata());return[{name:"metric",options:morpheus.MarkerSelection.Functions,value:morpheus.SignalToNoise.toString(),type:"select",help:""},{name:"grouping_value",value:"1",help:"Class values are categorized into two groups based on whether dataset values are greater than or equal to this value"},{name:"field",options:r,type:"bootstrap-select",search:!0,multiple:!0,selectAll:!0},{name:"class_a",title:"Class A",options:[],type:"bootstrap-select",search:!0,multiple:!0,selectAll:!0},{name:"class_b",title:"Class B",options:[],type:"bootstrap-select",search:!0,multiple:!0,selectAll:!0},{name:"number_of_markers",value:"100",type:"text",help:"The initial number of markers to show in each direction."},{name:"permutations",value:"0",type:"text"}]},execute:function(e){var t=e.project,r=e.input.class_a,n=e.input.class_b;if(0===r.length&&0===n.length)throw"No samples in class A and class B";if(0===r.length)throw"No samples in class A";if(0===n.length)throw"No samples in class B";for(var i=0;i<r.length;i++)(o=r[i])instanceof morpheus.Identifier||(r[i]=new morpheus.Identifier(morpheus.Util.isArray(o)?o:[o]));for(i=0;i<n.length;i++){var o;(o=n[i])instanceof morpheus.Identifier||(n[i]=new morpheus.Identifier(morpheus.Util.isArray(o)?o:[o]))}var a=parseInt(e.input.permutations),s=t.getSortedFilteredDataset(),l=e.input.field;morpheus.Util.isArray(l)||(l=[l]);var u=morpheus.MetadataUtil.getVectors(s.getColumnMetadata(),l),c=morpheus.VectorUtil.createValuesToIndicesMap(u),h=[],p=[];r.forEach(function(e){var t=c.get(e);if(void 0===t)throw new Error(e+" not found in "+c.keys());h=h.concat(t)}),n.forEach(function(e){var t=c.get(e);if(void 0===t)throw new Error(e+" not found in "+c.keys());p=p.concat(t)});var d=morpheus.MarkerSelection.Functions.fromString(e.input.metric),f={};for(i=0;i<h.length;i++)f[h[i]]=!0;for(i=0;i<p.length;i++)if(f[p[i]])throw"The sample was found in class A and class B";var m=d.toString()===morpheus.FisherExact.toString();1!==h.length&&1!==p.length||m||d.toString()===morpheus.MeanDifference.toString()||(d=morpheus.FoldChange);var g=new morpheus.DatasetRowView(new morpheus.SlicedDatasetView(s,null,h)),v=new morpheus.DatasetRowView(new morpheus.SlicedDatasetView(s,null,p));morpheus.MarkerSelection.Functions.map(function(e){return e.toString()}).concat(["odds_ratio","FDR(BH)","p_value"]).forEach(function(t){var r=morpheus.MetadataUtil.indexOf(s.getRowMetadata(),t);-1!==r&&(s.getRowMetadata().remove(r),e.heatMap.removeTrack(t,!1))});var y=s.getRowMetadata().add(d.toString()),b=(u=[y],s.getColumnMetadata().add("Comparison"));for(i=0;i<h.length;i++)b.setValue(h[i],"A");for(i=0;i<p.length;i++)b.setValue(p[i],"B");function w(r){if(r){for(var n=s.getRowMetadata().add("p_value"),i=s.getRowMetadata().add("FDR(BH)"),o=s.getRowMetadata().add("k"),a=0,l=n.size();a<l;a++)n.setValue(a,r.rowSpecificPValues[a]),i.setValue(a,r.fdr[a]),o.setValue(a,r.k[a]),y.setValue(a,r.scores[a]);o.getProperties().set(morpheus.VectorKeys.FORMATTER,{pattern:"i"}),u.push(n),u.push(i),u.push(o)}t.getRowFilter().getFilters().length>0&&t.getRowFilter().setAnd(!0,!0);var c=t.getRowFilter().getFilters();for(a=0;a<c.length;a++)c[a]instanceof morpheus.TopNFilter&&(t.getRowFilter().remove(a,!0),a--);m||t.getRowFilter().add(new morpheus.TopNFilter(parseInt(e.input.number_of_markers),morpheus.TopNFilter.TOP_BOTTOM,u[0].getName()),!0),t.setRowFilter(t.getRowFilter(),!0),t.setRowSortKeys([new morpheus.SortKey(u[0].getName(),m?morpheus.SortKey.SortOrder.ASCENDING:morpheus.SortKey.SortOrder.DESCENDING)],!0);var d=new morpheus.Set;h.forEach(function(e){d.add(e)}),p.forEach(function(e){d.add(e)}),t.getColumnSelectionModel().setViewIndices(d,!0),t.setColumnSortKeys([new morpheus.SortKey(b.getName(),morpheus.SortKey.SortOrder.ASCENDING)],!0),t.trigger("trackChanged",{vectors:u,display:u.map(function(){return"text"}),columns:!1}),t.trigger("trackChanged",{vectors:[b],display:["color"],columns:!0})}if(m){for(var x=parseFloat(e.input.grouping_value),_=s.getRowMetadata().add("odds_ratio"),S=s.getRowMetadata().add("FDR(BH)"),C=s.getRowMetadata().add("contingency_table"),M=[],T=(i=0,s.getRowCount());i<T;i++){var A=morpheus.createContingencyTable(g.setIndex(i),v.setIndex(i),x);C.setValue(i,"[["+A[0]+", "+A[1]+"], ["+A[2]+", "+A[3]+"]]");var E=A[0]*A[3]/(A[1]*A[2]);(isNaN(E)||E===Number.POSITIVE_INFINITY)&&(E=0),_.setValue(i,E),y.setValue(i,morpheus.FisherExact.fisherTest(A[0],A[1],A[2],A[3])),M.push(y.getValue(i))}var P=morpheus.FDR_BH(M);for(i=0,T=s.getRowCount();i<T;i++)S.setValue(i,P[i]);u.push(_),u.push(S),u.push(C),w()}else if(a>0){var R=new morpheus.SlicedDatasetView(s,null,h.concat(p));if(e.input.background=e.input.background&&"undefined"!=typeof Worker,e.input.numClassA=h.length,e.input.npermutations=a,e.input.background){var I=new Blob(["self.onmessage = function(e) {importScripts(e.data.scripts);self.postMessage(morpheus.MarkerSelection.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),N=window.URL.createObjectURL(I),D=new Worker(N);return D.postMessage({scripts:morpheus.Util.getScriptPath(),dataset:morpheus.Dataset.toJSON(R,{columnFields:[],rowFields:[],seriesIndices:[0]}),input:e.input}),D.onmessage=function(e){w(e.data),D.terminate(),window.URL.revokeObjectURL(N)},D}w(morpheus.MarkerSelection.execute(R,e.input))}else{for(i=0,T=s.getRowCount();i<T;i++)y.setValue(i,d(g.setIndex(i),v.setIndex(i)));if(d.toString()===morpheus.TTest.toString()&&"undefined"!=typeof jStat){var k=s.getRowMetadata().add("p_value"),O=(S=s.getRowMetadata().add("FDR(BH)"),new Float32Array(s.getRowCount()));for(i=0,T=s.getRowCount();i<T;i++){g.setIndex(i),v.setIndex(i);var F=morpheus.Mean(g),L=morpheus.Mean(v),U=morpheus.Variance(g,F),V=morpheus.Variance(v,L),B=morpheus.CountNonNaN(g),z=morpheus.CountNonNaN(v),j=morpheus.DegreesOfFreedom(U,V,B,z),H=y.getValue(i),$=2*(1-jStat.studentt.cdf(Math.abs(H),j));O[i]=$,k.setValue(i,$)}for(u.push(k),P=morpheus.FDR_BH(O),i=0,T=s.getRowCount();i<T;i++)S.setValue(i,P[i]);u.push(S)}w()}}},morpheus.NearestNeighbors=function(){},morpheus.NearestNeighbors.Functions=[morpheus.Cosine,morpheus.Euclidean,morpheus.Jaccard,morpheus.KendallsCorrelation,morpheus.Pearson,morpheus.Spearman,morpheus.WeightedMean],morpheus.NearestNeighbors.Functions.fromString=function(e){for(var t=0;t<morpheus.NearestNeighbors.Functions.length;t++)if(morpheus.NearestNeighbors.Functions[t].toString()===e)return morpheus.NearestNeighbors.Functions[t];throw new Error(e+" not found")},morpheus.NearestNeighbors.execute=function(e,t){var r=morpheus.NearestNeighbors.Functions.fromString(t.metric),n=new morpheus.PermutationPValues(e,null,null,t.npermutations,r,morpheus.Vector.fromArray("",t.listValues));return{rowSpecificPValues:n.rowSpecificPValues,k:n.k,fdr:n.fdr,scores:n.scores}},morpheus.NearestNeighbors.prototype={toString:function(){return"Nearest Neighbors"},init:function(e,t){var r=t.$form.find("[name=use_selected_only]").parent();t.$form.find("[name=compute_nearest_neighbors_of]").on("change",function(n){var i=$(this).val();if("selected rows"===i||"column annotation"===i?$(r.contents()[1]).replaceWith(document.createTextNode(" Use selected columns only")):$(r.contents()[1]).replaceWith(document.createTextNode(" Use selected rows only")),t.setVisible("annotation",!1),"column annotation"===i||"row annotation"===i){for(var o="column annotation"===i?e.getFullDataset().getColumnMetadata():e.getFullDataset().getRowMetadata(),a=[],s=0;s<o.getMetadataCount();s++){var l=o.get(s);"number"===morpheus.VectorUtil.getDataType(l)&&a.push(l.getName())}a.sort(function(e,t){return(e=e.toLowerCase())<(t=t.toLowerCase())?-1:e===t?0:1}),t.setOptions("annotation",a),t.setVisible("annotation",!0)}}),$(r.contents()[1]).replaceWith(document.createTextNode(" Use selected columns only")),t.setVisible("annotation",!1)},gui:function(){return[{name:"metric",options:morpheus.NearestNeighbors.Functions,value:morpheus.Pearson.toString(),type:"select"},{name:"compute_nearest_neighbors_of",options:["selected rows","selected columns","column annotation","row annotation"],value:"selected rows",type:"radio"},{name:"use_selected_only",type:"checkbox"},{name:"annotation",type:"bootstrap-select"},{name:"permutations",value:"0",type:"text"}]},execute:function(e){var t=e.project,r="selected columns"==e.input.compute_nearest_neighbors_of||"row annotation"==e.input.compute_nearest_neighbors_of,n="column annotation"==e.input.compute_nearest_neighbors_of||"row annotation"==e.input.compute_nearest_neighbors_of,i=(e.heatMap,morpheus.NearestNeighbors.Functions.fromString(e.input.metric)),o=t.getSortedFilteredDataset();r&&(o=new morpheus.TransposedDatasetView(o));var a=(r?t.getColumnSelectionModel():t.getRowSelectionModel()).getViewIndices().values();if(!n&&0===a.length)throw new Error("No "+(r?"columns":"rows")+" selected");var s=null;e.input.use_selected_only&&(s=(r?t.getRowSelectionModel():t.getColumnSelectionModel()).getViewIndices().values(),o=new morpheus.SlicedDatasetView(o,null,s));var l,u=new morpheus.SlicedDatasetView(o,a,null);if(n){if(!(l=o.getColumnMetadata().getByName(e.input.annotation)))throw new Error("No annotation selected.")}else{if(u.getRowCount()>1){for(var c=new morpheus.DatasetColumnView(u),h=new morpheus.Dataset({name:"",rows:1,columns:u.getColumnCount()}),p=0,d=u.getColumnCount();p<d;p++){var f=morpheus.Percentile(c.setIndex(p),50);h.setValue(0,p,f)}u=h}l=new morpheus.DatasetRowView(u)}var m=parseInt(e.input.permutations),g=o.getRowMetadata().add(i.toString());if(m>0){void 0===e.input.background&&(e.input.background=!0),e.input.background=e.input.background&&"undefined"!=typeof Worker,e.input.npermutations=m;for(var v=function(e){for(var n=o.getRowMetadata().add("p_value"),i=o.getRowMetadata().add("FDR(BH)"),a=o.getRowMetadata().add("k"),s=0,l=n.size();s<l;s++)n.setValue(s,e.rowSpecificPValues[s]),i.setValue(s,e.fdr[s]),a.setValue(s,e.k[s]),g.setValue(s,e.scores[s]);a.getProperties().set(morpheus.VectorKeys.FORMATTER,{pattern:"i"});var u=[n,i,a,g];t.trigger("trackChanged",{vectors:u,display:["text"],columns:r})},y=new Float32Array(l.size()),b=0,w=y.length;b<w;b++)y[b]=l.getValue(b);if(e.input.listValues=y,e.input.background){var x=new Blob(["self.onmessage = function(e) {importScripts(e.data.scripts);self.postMessage(morpheus.NearestNeighbors.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),_=window.URL.createObjectURL(x),S=new Worker(_);return S.postMessage({scripts:morpheus.Util.getScriptPath(),dataset:morpheus.Dataset.toJSON(o,{columnFields:[],rowFields:[],seriesIndices:[0]}),input:e.input}),S.onmessage=function(e){v(e.data),S.terminate(),window.URL.revokeObjectURL(_)},S}v(morpheus.NearestNeighbors.execute(o,e.input))}else{var C=new morpheus.DatasetRowView(o);for(b=0,w=o.getRowCount();b<w;b++)g.setValue(b,i(l,C.setIndex(b)));r?t.setColumnSortKeys([new morpheus.SortKey(i.toString(),morpheus.SortKey.SortOrder.DESCENDING)],!0):t.setRowSortKeys([new morpheus.SortKey(i.toString(),morpheus.SortKey.SortOrder.DESCENDING)],!0),t.trigger("trackChanged",{vectors:[g],display:["text"],columns:r})}}},morpheus.NewHeatMapTool=function(){},morpheus.NewHeatMapTool.prototype={toString:function(){return"New Heat Map"},execute:function(e){var t=e.project,r=e.heatMap,n=t.getSelectedDataset({selectedRows:!0,selectedColumns:!0});morpheus.DatasetUtil.shallowCopy(n),new morpheus.HeatMap({name:r.getName(),dataset:n,parent:r,symmetric:t.isSymmetric()&&n.getColumnCount()===n.getRowCount()})}},morpheus.OpenDatasetTool=function(){},morpheus.OpenDatasetTool.prototype={toString:function(){return"Open Dataset"},_read:function(e,t){var r=this,n=e.project,i=e.heatMap,o=e.input.file,a=e.input.open_file_action,s=n.getSortedFilteredDataset();t.catch(function(e){if("Cancel"!==e.message){var t=["Error opening "+morpheus.Util.getFileName(o)+"."];e.message&&(t.push("<br />Cause: "),t.push(e.message)),morpheus.FormBuilder.showInModal({title:"Error",html:t.join(""),focus:document.activeElement})}}),t.then(function(e){if(morpheus.Util.getExtension(morpheus.Util.getFileName(o)),morpheus.Util.getBaseFileName(morpheus.Util.getFileName(o)),"append"===a||"append columns"===a){var t="append"===a;_.each(i.options.rows,function(t){if(t.renameTo){var r=e.getRowMetadata().getByName(t.field);r&&r.setName(t.renameTo)}}),_.each(i.options.columns,function(t){if(t.renameTo){var r=e.getColumnMetadata().getByName(t.field);r&&r.setName(t.renameTo)}}),i.options.datasetReady&&i.options.datasetReady(e);var n=morpheus.MetadataUtil.getMetadataNames(t?s.getColumnMetadata():s.getRowMetadata()),l=morpheus.MetadataUtil.getMetadataNames(t?e.getColumnMetadata():e.getRowMetadata());n.length>1||l.length>1?r._matchAppend(l,n,i,function(r){i.getProject().setFullDataset(t?new morpheus.JoinedDataset(s,e,r.current_dataset_annotation_name,r.new_dataset_annotation_name):new morpheus.TransposedDatasetView(new morpheus.JoinedDataset(new morpheus.TransposedDatasetView(s),new morpheus.TransposedDatasetView(e),r.current_dataset_annotation_name,r.new_dataset_annotation_name)),!0),i.options.renderReady&&(i.options.renderReady(i),i.updateDataset()),t&&(i.getHeatMapElementComponent().getColorScheme().setSeparateColorSchemeForRowMetadataField("Source"),morpheus.VectorUtil.getSet(i.getProject().getFullDataset().getRowMetadata().getByName("Source")).forEach(function(e){i.autoDisplay({extension:morpheus.Util.getExtension(e),filename:e})})),i.tabManager.setTabTitle(i.tabId,i.getProject().getFullDataset().getRowCount()+" row"+morpheus.Util.s(i.getProject().getFullDataset().getRowCount())+" x "+i.getProject().getFullDataset().getColumnCount()+" column"+morpheus.Util.s(i.getProject().getFullDataset().getColumnCount())),i.addTrack("Source",!t),morpheus.FormBuilder.showInModal({title:"Append",html:"Please scroll to the "+(t?"bottom":"right")+" of the heat map to see the appended data.",focus:document.activeElement}),i.revalidate()}):(i.getProject().setFullDataset(t?new morpheus.JoinedDataset(s,e,n[0],l[0]):new morpheus.TransposedDatasetView(new morpheus.JoinedDataset(new morpheus.TransposedDatasetView(s),new morpheus.TransposedDatasetView(e),n[0],l[0])),!0),i.options.renderReady&&(i.options.renderReady(i),i.updateDataset()),t&&(i.getHeatMapElementComponent().getColorScheme().setSeparateColorSchemeForRowMetadataField("Source"),morpheus.VectorUtil.getSet(i.getProject().getFullDataset().getRowMetadata().getByName("Source")).forEach(function(e){i.autoDisplay({extension:morpheus.Util.getExtension(e),filename:e})})),i.tabManager.setTabTitle(i.tabId,i.getProject().getFullDataset().getRowCount()+" row"+morpheus.Util.s(i.getProject().getFullDataset().getRowCount())+" x "+i.getProject().getFullDataset().getColumnCount()+" column"+morpheus.Util.s(i.getProject().getFullDataset().getColumnCount())),i.addTrack("Source",!t),morpheus.FormBuilder.showInModal({title:"Append",html:"Please scroll to the "+(t?"bottom":"right")+" of the heat map to see the appended data.",focus:document.activeElement}),i.revalidate())}else"overlay"===a?r._matchOverlay(morpheus.MetadataUtil.getMetadataNames(e.getColumnMetadata()),morpheus.MetadataUtil.getMetadataNames(s.getColumnMetadata()),morpheus.MetadataUtil.getMetadataNames(e.getRowMetadata()),morpheus.MetadataUtil.getMetadataNames(s.getRowMetadata()),i,function(t){morpheus.DatasetUtil.overlay({dataset:s,newDataset:e,rowAnnotationName:t.current_dataset_row_annotation_name,newRowAnnotationName:t.new_dataset_row_annotation_name,columnAnnotationName:t.current_dataset_column_annotation_name,newColumnAnnotationName:t.new_dataset_column_annotation_name}),morpheus.FormBuilder.showInModal({title:"Overlay",html:"Select View > Options to change how the overlayed data is displayed.",focus:document.activeElement})}):"open"===a?new morpheus.HeatMap({dataset:e,parent:i,inheritFromParent:!1}):console.log("Unknown action: "+a);"open"!==a&&i.revalidate()})},execute:function(e){var t=e.input.file,r=this;return new Promise(function(n,i){morpheus.OpenDatasetTool.fileExtensionPrompt(t,function(i){i||(i={}),i.interactive=!0;var o=morpheus.DatasetUtil.read(t,i);o.finally(function(){n()}),r._read(e,o)})})},_matchAppend:function(e,t,r,n){var i={execute:function(e){return e.input},toString:function(){return"Select Fields"},gui:function(){var r=[{name:"current_dataset_annotation_name",options:t,type:"select",value:"id",required:!0}];return r.push({name:"new_dataset_annotation_name",type:"select",value:"id",options:e,required:!0}),r}};morpheus.HeatMap.showTool(i,r,n)},_matchOverlay:function(e,t,r,n,i,o){var a={execute:function(e){return e.input},toString:function(){return"Select Fields"},gui:function(){var i=[];return i.push({name:"current_dataset_column_annotation_name",options:t,type:"select",value:"id",required:!0}),i.push({name:"new_dataset_column_annotation_name",type:"select",value:"id",options:e,required:!0}),i.push({name:"current_dataset_row_annotation_name",options:n,type:"select",value:"id",required:!0}),i.push({name:"new_dataset_row_annotation_name",type:"select",value:"id",options:r,required:!0}),i}};morpheus.HeatMap.showTool(a,i,o)}},morpheus.OpenDatasetTool.fileExtensionPrompt=function(e,t){var r=morpheus.Util.getExtension(morpheus.Util.getFileName(e));"seg"===r||"segtab"===r?this._promptSegtab(function(e){t(e)}):t(null)},morpheus.OpenDatasetTool._promptMaf=function(e){var t=new morpheus.FormBuilder;t.append({name:"MAF_gene_symbols",value:"",type:"textarea",required:!0,help:"Enter one gene symbol per line to filter genes. Leave blank to show all genes."}),morpheus.FormBuilder.showInModal({title:"Gene Symbols",html:t.$form,close:"OK",onClose:function(){for(var r=t.getValue("MAF_gene_symbols"),n=morpheus.Util.splitOnNewLine(r),i=new morpheus.Map,o=0,a=n.length,s=0;o<a;o++){var l=n[o];""!==l&&i.set(l,s++)}var u=i.size()>0?{mafGeneFilter:i}:null;e(u)}})},morpheus.OpenDatasetTool._promptSegtab=function(e){var t=new morpheus.FormBuilder;t.append({name:"regions",value:"",type:"textarea",required:!0,help:"Define the regions over which you want to define the CNAs. Enter one region per line. Each line should contain region_id, chromosome, start, and end separated by a tab. Leave blank to use all unique segments in the segtab file as regions."}),morpheus.FormBuilder.showInModal({title:"Regions",html:t.$form,close:"OK",onClose:function(){for(var r=t.getValue("regions"),n=morpheus.Util.splitOnNewLine(r),i=[],o=/\t/,a=0,s=n.length;a<s;a++){var l=n[a];if(""!==l){var u=l.split(o);u.length>=4&&i.push({id:u[0],chromosome:u[1],start:parseInt(u[2]),end:parseInt(u[3])})}}var c=i.length>0?{regions:i}:null;e(c)}})},morpheus.OpenDendrogramTool=function(e){this._file=e},morpheus.OpenDendrogramTool.prototype={toString:function(){return"Open Dendrogram"},init:function(e,t){var r=function(r){var n="Rows"===r,i=morpheus.MetadataUtil.getMetadataNames(n?e.getFullDataset().getRowMetadata():e.getFullDataset().getColumnMetadata());i.unshift("Newick file does not contain node ids"),t.setOptions("match_leaf_node_ids_to",i)};t.$form.find("[name=orientation]").on("change",function(e){r($(this).val())}),r("Columns")},gui:function(){return[{name:"orientation",options:["Columns","Rows"],value:"Columns",type:"radio"},{name:"match_leaf_node_ids_to",options:[],type:"select"}]},execute:function(e){var t=this._file,r="Columns"===e.input.orientation,n=e.input.match_leaf_node_ids_to;""!=n&&"Newick file does not contain node ids"!==n||(n=null);var i=e.heatMap;morpheus.Util.getText(t).then(function(t){var o=e.project.getSortedFilteredDataset();r&&(o=new morpheus.TransposedDatasetView(o));var a=morpheus.DendrogramUtil.parseNewick(t);if(a.leafNodes.length!==o.getRowCount())throw new Error("# leaf nodes in dendrogram "+a.leafNodes.length+" != "+o.getRowCount());var s=[];if(null!=n)for(var l=o.getRowMetadata().getByName(n),u=morpheus.VectorUtil.createValueToIndexMap(l),c=0,h=a.leafNodes.length;c<h;c++){var p=a.leafNodes[c].name,d=u.get(p);if(void 0===d)throw new Error("Unable to find dendrogram id "+a.leafNodes[c].name+" in annotations");s.push(d)}else{for(c=0,h=a.leafNodes.length;c<h&&(p=a.leafNodes[c].name,p=parseInt(p),!isNaN(p));c++)s.push(p);if(s.length!==a.leafNodes.length)for(s=[],c=0,h=a.leafNodes.length;c<h;c++)s.push(c)}i.setDendrogram(a,r,s)})}},morpheus.OpenFileTool=function(e){this.options=e||{}},morpheus.OpenFileTool.OPEN_FILE_ACTION_OPTIONS=[{name:"Open session",value:"Open session"},{name:"Open dataset in new tab",value:"open"},{name:"Append rows to current dataset",value:"append"},{name:"Append columns to current dataset",value:"append columns"},{name:"Overlay onto current dataset",value:"overlay"},{divider:!0},{name:"Annotate columns",value:"Annotate Columns"},{name:"Annotate rows",value:"Annotate Rows"},{divider:!0},{name:"Open dendrogram",value:"Open dendrogram"}],morpheus.OpenFileTool.prototype={toString:function(){var e="";return null!=this.options.file&&null!=this.options.file.name?e=" - "+this.options.file.name:this.options.clipboard&&(e=" - Clipboard"),"Open"+e},gui:function(){var e=[{name:"open_file_action",value:"open",type:"bootstrap-select",options:morpheus.OpenFileTool.OPEN_FILE_ACTION_OPTIONS}];if(null==this.options.file)e.options={size:"modal-lg",cancel:!1,ok:!1};else{var t=morpheus.Util.getExtension(morpheus.Util.getFileName(this.options.file));"json"===t?e[0].options=e[0].options.filter(function(e){return null!=e.value&&("Open session"===e.value||"open"===e.value||"overlay"===e.value||-1!==e.value.indexOf("append"))}):"gct"===t&&(e[0].options=e[0].options.filter(function(e){return null!=e.value&&("open"===e.value||"overlay"===e.value||-1!==e.value.indexOf("append"))}))}return e},init:function(e,t,r){var n=this;if(null==this.options.file){t.setVisible("open_file_action",!1);var i=$("<div></div>"),o=$('<div style="display:none;padding:15px;text-align:right;"><button name="action-selected" type="button" class="btn btn-default">OK</button></div>');o.find("[name=action-selected]").on("click",function(){n.ok()}),new morpheus.FilePicker({fileCallback:function(e){i.hide(),o.show(),n.options.file=e[0];var r=morpheus.Util.getExtension(morpheus.Util.getFileName(n.options.file));"json"===r?t.setOptions("open_file_action",morpheus.OpenFileTool.OPEN_FILE_ACTION_OPTIONS.filter(function(e){return null!=e.value&&("Open session"===e.value||"open"===e.value||"overlay"===e.value||-1!==e.value.indexOf("append"))})):"gct"===r&&t.setOptions("open_file_action",morpheus.OpenFileTool.OPEN_FILE_ACTION_OPTIONS.filter(function(e){return null!=e.value&&("open"===e.value||"overlay"===e.value||-1!==e.value.indexOf("append"))})),t.setVisible("open_file_action",!0)},optionsCallback:function(e){i.hide(),o.show(),n.options.file=e.dataset,t.setVisible("open_file_action",!0),t.setOptions("open_file_action",morpheus.OpenFileTool.OPEN_FILE_ACTION_OPTIONS.filter(function(e){return null!=e.value&&("open"===e.value||"overlay"===e.value||-1!==e.value.indexOf("append"))}))}}).$el.appendTo(i),o.appendTo(t.$form),i.appendTo(t.$form)}},execute:function(e){var t=this,r=null==this.options.file,n=e.heatMap;r||(e.input.file=this.options.file,e.input.clipboard=this.options.clipboard);var i=e.project;return"Open session"===e.input.open_file_action?morpheus.Util.getText(e.input.file).then(function(e){var t=JSON.parse(e);t.tabManager=n.getTabManager(),t.focus=!0,t.inheritFromParent=!1,t.landingPage=n.options.landingPage,new morpheus.HeatMap(t)}).catch(function(e){morpheus.FormBuilder.showMessageModal({title:"Error",message:"Unable to load session",focus:document.activeElement})}):"append columns"===e.input.open_file_action||"append"===e.input.open_file_action||"open"===e.input.open_file_action||"overlay"===e.input.open_file_action?(new morpheus.OpenDatasetTool).execute(e):"Open dendrogram"!==e.input.open_file_action?new Promise(function(r,o){var a="Annotate Columns"==e.input.open_file_action,s=e.input.file,l=i.getFullDataset(),u=morpheus.Util.getFileName(s);if(morpheus.Util.endsWith(u,".cls"))(c=morpheus.Util.readLines(s)).finally(function(){r()}),c.then(function(e){t.annotateCls(n,l,u,a,e)});else if(morpheus.Util.endsWith(u,".gmt"))morpheus.ArrayBufferReader.getArrayBuffer(s,function(e,i){if(r(),e)throw new Error("Unable to read "+s);var o=(new morpheus.GmtReader).read(new morpheus.ArrayBufferReader(new Uint8Array(i)));t.promptSets(l,n,a,o,morpheus.Util.getBaseFileName(morpheus.Util.getFileName(s)))});else{var c;(c=morpheus.Util.readLines(s)).then(function(e){t.prompt(e,l,n,a)}).finally(function(){r()})}}):void morpheus.HeatMap.showTool(new morpheus.OpenDendrogramTool(e.input.file),e.heatMap)},annotateCls:function(e,t,r,n,i){n&&(t=new morpheus.TransposedDatasetView(t));var o=(new morpheus.ClsReader).read(i);if(o.length!==t.getRowCount())throw new Error("Number of samples in cls file does not match dataset.");for(var a=t.getRowMetadata().add(morpheus.Util.getBaseFileName(r)),s=0;s<o.length;s++)a.setValue(s,o[s]);e&&e.getProject().trigger("trackChanged",{vectors:[a],display:["color"],columns:n})},annotateSets:function(e,t,r,n,i){t&&(e=new morpheus.TransposedDatasetView(e));var o=e.getRowMetadata().getByName(n),a=morpheus.VectorUtil.createValueToIndicesMap(o),s=e.getRowMetadata().add(i);return r.forEach(function(e){var t=e.name;e.ids.forEach(function(e){var r=a.get(e);if(void 0!==r)for(var n=0,i=r.length;n<i;n++){var o=s.getValue(r[n]);void 0===o&&(o=[]),o.push(t),s.setValue(r[n],o)}})}),s},annotate:function(e){var t=e.lines,r=e.dataset,n=e.isColumns,i=e.sets,o=e.metadataName,a=e.fileColumnName,s=e.fileColumnNamesToInclude,l=e.transposed,u=e.separator;null==u&&(u=/\t/),n&&(r=new morpheus.TransposedDatasetView(r));var c=r.getRowMetadata().getByName(o);if(!c)throw new Error("vector "+o+" not found.");var h=null;null!=s&&(h=new morpheus.Set,s.forEach(function(e){h.add(e)}));var p=[],d=morpheus.VectorUtil.createValueToIndicesMap(c);if(t)if(l){var f,m=[];for(M=0,T=t.length;M<T;M++)if(a===(C=(A=t[M].split(u))[0]))f=A;else{if(h&&!h.has(C))continue;m.push(A),(N=r.getRowMetadata().getByName(C))||(N=r.getRowMetadata().add(C)),p.push(N)}if(null==f)throw new Error(a+" not found in header.");for(var g=1,v=f.length;g<v;g++)if(P=f[g],void 0!==(E=d.get(P)))for(R=E.length,S=0;S<m.length;S++)for(I=m[S][g],N=p[S],D=0;D<R;D++)N.setValue(E[D],I)}else{var y=t[0].split(u),b=_.indexOf(y,a);if(-1===b)throw new Error(a+" not found in header:"+y);for(var w=[],x=y.length,S=0;S<x;S++){var C=y[S];S!==b&&(h&&!h.has(C)||((N=r.getRowMetadata().getByName(C))||(N=r.getRowMetadata().add(C)),w.push(S),p.push(N)))}x=w.length;for(var M=1,T=t.length;M<T;M++){var A,E,P=(A=t[M].split(u))[b];if(void 0!==(E=d.get(P))){var R=E.length;for(S=0;S<x;S++)for(var I=A[w[S]],N=p[S],D=0;D<R;D++)N.setValue(E[D],I)}}}else _.each(i,function(e){var t=e.name,n=e.ids,i=r.getRowMetadata().add(t);p.push(i),_.each(n,function(e){var r=d.get(e);if(void 0!==r)for(var n=0,o=r.length;n<o;n++)i.setValue(r[n],t)})});for(M=0;M<p.length;M++)morpheus.VectorUtil.maybeConvertStringToNumber(p[M]);return p},promptSets:function(e,t,r,n,i){var o={},a=this;o.execute=function(o){var s=o.input.dataset_field_name,l=a.annotateSets(e,r,n,s,i);t.getProject().trigger("trackChanged",{vectors:[l],display:["text"],columns:r})},o.toString=function(){return"Select Fields To Match On"},o.gui=function(){return[{name:"dataset_field_name",options:morpheus.MetadataUtil.getMetadataNames(r?e.getColumnMetadata():e.getRowMetadata()),type:"select",value:"id",required:!0}]},morpheus.HeatMap.showTool(o,t)},prompt:function(e,t,r,n){var i={},o=this,a=/\t/;if(null!=e)for(var s=["\t",","," "],l=e[0].trim(),u=0;u<s.length;u++){var c=s[u];if(l.split(new RegExp(c)).length>1){a=c;break}}var h=null!=e?e[0].split(a):null;i.execute=function(i){for(var s=i.input.dataset_field_name,l=i.input.file_field_name,u=o.annotate({lines:e,dataset:t,isColumns:n,metadataName:s,fileColumnName:l,transposed:!1,separator:a}),c=new morpheus.Map,h=[],p=0;p<u.length;p++)h.push(n?"color":"text"),c.set(u[p].getName(),p);if(e.colors){var d=n?r.getProject().getColumnColorModel():r.getProject().getRowColorModel();e.colors.forEach(function(e){var t=c.get(e.header),r=u[t];h[t]="color",d.setMappedValue(r,e.value,e.color)})}r.getProject().trigger("trackChanged",{vectors:u,display:h,columns:n})},i.toString=function(){return"Select Fields To Match On"},i.gui=function(){var r=[{name:"dataset_field_name",options:morpheus.MetadataUtil.getMetadataNames(n?t.getColumnMetadata():t.getRowMetadata()),type:"select",required:!0}];return e&&r.push({name:"file_field_name",type:"select",options:_.map(h,function(e){return{name:e,value:e}}),required:!0}),r},morpheus.HeatMap.showTool(i,r)}},morpheus.SaveDatasetTool=function(){},morpheus.SaveDatasetTool.prototype={toString:function(){return"Save Dataset"},init:function(e,t){t.find("file_name").prop("autofocus",!0).focus();for(var r=[],n=e.getFullDataset(),i=0,o=n.getSeriesCount();i<o;i++)r.push(n.getName(i));t.setOptions("series",r.length>1?r:null),t.setVisible("series",r.length>1)},gui:function(){return[{name:"file_name",type:"text",help:'<a target="_blank" href="http://support.lincscloud.org/hc/en-us/articles/202105453-GCT-Gene-Cluster-Text-Format-">GCT 1.3</a> or <a target="_blank" href="http://www.broadinstitute.org/cancer/software/genepattern/gp_guides/file-formats/sections/gct">GCT 1.2</a> file name',required:!0},{name:"file_format",type:"radio",options:[{name:"GCT version 1.2",value:"1.2"},{name:"GCT version 1.3",value:"1.3"}],value:"1.3"},{name:"series",type:"select",options:[],required:!0},{name:"save_selection_only",type:"checkbox",required:!0}]},execute:function(e){var t=e.project,r=e.input.file_format,n=e.input.file_name;""===n&&(n="dataset");var i,o=e.input.series,a=e.heatMap,s=e.input.save_selection_only?t.getSelectedDataset():t.getSortedFilteredDataset();if("1.2"===r?i=new morpheus.GctWriter12:"1.3"===r&&(i=new morpheus.GctWriter),null!=o){var l=morpheus.DatasetUtil.getSeriesIndex(s,o);-1===l&&(l=0),s=0===l?s:new morpheus.DatasetSeriesView(s,[l])}var u=i.getExtension?i.getExtension():"";""===u||morpheus.Util.endsWith(n.toLowerCase(),"."+u)||(n+="."+u),i.setNumberFormat(a.getHeatMapElementComponent().getDrawValuesFormat());var c=[],h=[],p={push:function(e){if(h.push(e),1e4===h.length){var t=new Blob([h.join("")],{type:"text/plain;charset=charset=utf-8"});h=[],c.push(t)}},join:function(){if(h.length>0){var e=new Blob([h.join("")],{type:"text/plain;charset=charset=utf-8"});c.push(e),h=[]}e=new Blob(c,{type:"text/plain;charset=charset=utf-8"}),saveAs(e,n,!0)}};i.write(s,p)}},morpheus.SaveImageTool=function(){},morpheus.SaveImageTool.prototype={toString:function(){return"Save Image"},init:function(e,t){t.find("file_name").prop("autofocus",!0).focus()},gui:function(){return[{name:"file_name",type:"text",required:!0},{name:"format",type:"radio",options:["PDF","PNG","SVG"],value:"PNG",required:!0}]},execute:function(e){var t=e.input.file_name;""===t&&(t="image");var r=e.input.format.toLowerCase();morpheus.Util.endsWith(t.toLowerCase(),"."+r)||(t+="."+r),e.heatMap.saveImage(t,r)}},morpheus.SaveSessionTool=function(){},morpheus.SaveSessionTool.prototype={toString:function(){return"Save Session"},init:function(e,t){t.find("file_name").prop("autofocus",!0).focus()},gui:function(){return[{name:"file_name",type:"text",required:!0}]},execute:function(e){var t=e.input.file_name;""===t&&(t="session.json"),morpheus.Util.endsWith(t.toLowerCase(),".json")||(t+=".json");var r=e.heatMap,n=(e={dataset:!0},r.toJSON(e)),i=Array.from||function(e){var t=Array.prototype.slice.call(e);t.length,e.length,t.constructor,Array},o=new Blob([JSON.stringify(n,function(e,t){return morpheus.Util.isArray(t)?t instanceof Array?t:i(t):t})],{type:"application/json;charset=charset=utf-8"});saveAs(o,t,!0)}},morpheus.SimilarityMatrixTool=function(){},morpheus.SimilarityMatrixTool.Functions=[morpheus.Euclidean,morpheus.Jaccard,morpheus.Cosine,morpheus.KendallsCorrelation,morpheus.Pearson,morpheus.Spearman],morpheus.SimilarityMatrixTool.Functions.fromString=function(e){for(var t=0;t<morpheus.SimilarityMatrixTool.Functions.length;t++)if(morpheus.SimilarityMatrixTool.Functions[t].toString()===e)return morpheus.SimilarityMatrixTool.Functions[t];throw new Error(e+" not found")},morpheus.SimilarityMatrixTool.execute=function(e,t){var r="Columns"==t.compute_matrix_for,n=morpheus.SimilarityMatrixTool.Functions.fromString(t.metric);return morpheus.HCluster.computeDistanceMatrix(r?new morpheus.TransposedDatasetView(e):e,n)},morpheus.SimilarityMatrixTool.prototype={toString:function(){return"Similarity Matrix"},init:function(e,t){},gui:function(){return[{name:"metric",options:morpheus.SimilarityMatrixTool.Functions,value:morpheus.SimilarityMatrixTool.Functions[4].toString(),type:"select"},{name:"compute_matrix_for",options:["Columns","Rows"],value:"Columns",type:"radio"}]},execute:function(e){var t=e.project,r=e.heatMap,n="Columns"==e.input.compute_matrix_for,i=morpheus.SimilarityMatrixTool.Functions.fromString(e.input.metric),o=t.getSortedFilteredDataset(),a=new Blob(["self.onmessage = function(e) {importScripts(e.data.scripts);self.postMessage(morpheus.SimilarityMatrixTool.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),s=window.URL.createObjectURL(a),l=new Worker(s);return l.postMessage({scripts:morpheus.Util.getScriptPath(),dataset:morpheus.Dataset.toJSON(o,{columnFields:[],rowFields:[],seriesIndices:[0]}),input:e.input}),l.onmessage=function(t){for(var a=r.getName()+" "+e.input.metric,u=t.data,c=n?o.getColumnCount():o.getRowCount(),h=new morpheus.Dataset({name:a,rows:c,columns:c}),p=i.toString()===morpheus.Euclidean.toString()||i.toString()===morpheus.Jaccard.toString(),d=1;d<c;d++)for(var f=0;f<d;f++){var m=u[d][f];h.setValue(d,f,m),h.setValue(f,d,m)}if(!p)for(d=0;d<c;d++)h.setValue(d,d,1);var g,v=n?o.getColumnMetadata():o.getRowMetadata();h.rowMetadataModel=morpheus.MetadataUtil.shallowCopy(v),h.columnMetadataModel=morpheus.MetadataUtil.shallowCopy(v),g=p?{type:"fixed",map:[{value:0,color:"white"},{value:morpheus.DatasetUtil.max(h),color:"red"}]}:{type:"fixed",map:[{value:-1,color:"blue"},{value:0,color:"white"},{value:1,color:"red"}]},new morpheus.HeatMap({colorScheme:g,name:a,dataset:h,parent:r,inheritFromParentOptions:{rows:!n,columns:n}}),l.terminate(),window.URL.revokeObjectURL(s)},l}},morpheus.TransposeTool=function(){},morpheus.TransposeTool.prototype={toString:function(){return"Transpose"},execute:function(e){var t=e.project,r=e.heatMap,n=new morpheus.TransposedDatasetView(t.getSortedFilteredDataset()),i=morpheus.MetadataUtil.shallowCopy(n.getRowMetadata()),o=morpheus.MetadataUtil.shallowCopy(n.getColumnMetadata());n.getRowMetadata=function(){return i},n.getColumnMetadata=function(){return o};var a=e.input.name||r.getName();new morpheus.HeatMap({name:a,dataset:n,inheritFromParentOptions:{transpose:!0},parent:r})}},morpheus.TsneTool=function(){},morpheus.TsneTool.execute=function(e,t){var r=[];"Rows"==t.project||(e=new morpheus.TransposedDatasetView(e));var n=e.getRowCount(),i=morpheus.HClusterTool.Functions.fromString(t.metric);if(i===morpheus.TsneTool.PRECOMPUTED_DIST)for(var o=0;o<n;o++){r.push([]);for(var a=o+1;a<n;a++)r[o][a]=e.getValue(o,a)}else if(i===morpheus.TsneTool.PRECOMPUTED_SIM){var s=morpheus.DatasetUtil.max(e);for(o=0;o<n;o++)for(r.push([]),a=o+1;a<n;a++)r[o][a]=s-e.getValue(o,a)}else{var l=new morpheus.DatasetRowView(e),u=new morpheus.DatasetRowView(e);for(o=0;o<n;o++)for(r.push([]),l.setIndex(o),a=o+1;a<n;a++){var c=i(l,u.setIndex(a));r[o][a]=c}}var h={};h.epsilon=t.epsilon,h.perplexity=t.perplexity,h.dim=2;var p=new tsnejs.tSNE(h);p.initDataDist(r);for(var d=0;d<1e3;d++)p.step();return{solution:p.getSolution()}},morpheus.TsneTool.prototype={toString:function(){return"t-SNE"},init:function(e,t){},gui:function(){return[{name:"metric",options:morpheus.HClusterTool.Functions,value:morpheus.HClusterTool.Functions[3].toString(),type:"select"},{name:"project",options:["Columns","Rows"],value:"Columns",type:"select"},{name:"epsilon",value:"10",type:"text",help:"learning rate"},{name:"perplexity",value:"30",type:"text",help:"number of effective nearest neighbors"}]},execute:function(e){var t=e.project,r=e.heatMap,n="Rows"==e.input.project,i=t.getSortedFilteredDataset();e.input.epsilon=parseInt(e.input.epsilon),e.input.perplexity=parseInt(e.input.perplexity);var o=new Blob(["self.onmessage = function(e) {e.data.scripts.forEach(function (s) { importScripts(s); });self.postMessage(morpheus.TsneTool.execute(morpheus.Dataset.fromJSON(e.data.dataset), e.data.input));}"]),a=URL.createObjectURL(o),s=new Worker(a);return s.postMessage({scripts:[morpheus.Util.getScriptPath()],dataset:morpheus.Dataset.toJSON(i,{columnFields:[],rowFields:[],seriesIndices:[0]}),input:e.input}),s.onmessage=function(e){n&&(i=new morpheus.TransposedDatasetView(i));for(var t=e.data.solution,o=new morpheus.Dataset({name:"t-SNE",rows:i.getColumnCount(),columns:2}),l=0;l<t.length;l++)o.setValue(l,0,t[l][0]),o.setValue(l,1,t[l][1]);var u=o.getColumnMetadata().add("id");u.setValue(0,"P1"),u.setValue(1,"P2"),o.setRowMetadata(morpheus.MetadataUtil.shallowCopy(i.getColumnMetadata()));var c=morpheus.DatasetUtil.min(o),h=morpheus.DatasetUtil.max(o);new morpheus.HeatMap({inheritFromParentOptions:{transpose:!n},name:"t-SNE",dataset:o,parent:r,columns:[{field:"id",display:"text"}],colorScheme:{type:"fixed",map:[{value:c,color:colorbrewer.Greens[3][0]},{value:h,color:colorbrewer.Greens[3][2]}]}}),s.terminate(),window.URL.revokeObjectURL(a)},s}},morpheus.AbstractCanvas=function(e){this.canvas=morpheus.CanvasUtil.createCanvas(),this.lastClip=null,e&&(this.offscreenCanvas=morpheus.CanvasUtil.createCanvas()),this.offset={x:0,y:0}},morpheus.AbstractCanvas.prototype={visible:!0,invalid:!0,scrollX:0,scrollY:0,prefWidth:void 0,prefHeight:void 0,getCanvas:function(){return this.canvas},scrollTop:function(e){if(void 0===e)return this.offset.y;this.offset.y=e},appendTo:function(e){$(this.canvas).appendTo(e)},scrollLeft:function(e){if(void 0===e)return this.offset.x;this.offset.x=e},dispose:function(){$(this.canvas).remove(),this.offscreenCanvas=void 0},getPrefWidth:function(){return this.prefWidth},setInvalid:function(e){this.invalid=e},setBounds:function(e){var t=morpheus.CanvasUtil.BACKING_SCALE,r=[this.canvas];this.offscreenCanvas&&r.push(this.offscreenCanvas),null!=e.height&&_.each(r,function(r){r.height=e.height*t,r.style.height=e.height+"px"}),null!=e.width&&_.each(r,function(r){r.width=e.width*t,r.style.width=e.width+"px"}),null!=e.left&&_.each(r,function(t){t.style.left=e.left+"px"}),null!=e.top&&_.each(r,function(t){t.style.top=e.top+"px"})},paint:function(e){var t=this.canvas.getContext("2d");morpheus.CanvasUtil.resetTransform(t);var r=this.getUnscaledWidth(),n=this.getUnscaledHeight();if(t.clearRect(0,0,r,n),this.prePaint&&(morpheus.CanvasUtil.resetTransform(t),t.translate(this.offset.x,this.offset.y),this.prePaint(e,t)),morpheus.CanvasUtil.resetTransform(t),this.offscreenCanvas){if(this.invalid){var i=this.offscreenCanvas.getContext("2d");morpheus.CanvasUtil.resetTransform(i),t.translate(this.offset.x,this.offset.y),i.clearRect(0,0,r,n),this.draw(e,i)}r>0&&n>0&&t.drawImage(this.offscreenCanvas,0,0,r,n)}else this.draw(e,t);this.postPaint&&(morpheus.CanvasUtil.resetTransform(t),t.translate(this.offset.x,this.offset.y),this.postPaint(e,t)),this.lastClip=e,this.invalid=!1},repaint:function(){this.lastClip||(this.lastClip={x:0,y:0,width:this.getUnscaledWidth(),height:this.getUnscaledHeight()}),this.paint(this.lastClip)},draw:function(e,t){console.log("Not implemented")},getPrefHeight:function(){return this.prefHeight},setPrefWidth:function(e){this.prefWidth=e},setPrefHeight:function(e){this.prefHeight=e},isVisible:function(){return this.visible},setVisible:function(e){this.visible!==e&&(this.visible=e,this.canvas.style.display=e?"":"none")},getUnscaledWidth:function(){return this.canvas.width/morpheus.CanvasUtil.BACKING_SCALE},getUnscaledHeight:function(){return this.canvas.height/morpheus.CanvasUtil.BACKING_SCALE},getWidth:function(){return this.canvas.width},getHeight:function(){return this.canvas.height}},morpheus.AbstractColorSupplier=function(){this.fractions=[0,.5,1],this.colors=["#0000ff","#ffffff","#ff0000"],this.names=null,this.min=0,this.max=1,this.missingColor="#c0c0c0",this.scalingMode=morpheus.HeatMapColorScheme.ScalingMode.RELATIVE,this.stepped=!1,this.sizer=new morpheus.HeatMapSizer,this.conditions=new morpheus.HeatMapConditions,this.transformValues=0},morpheus.AbstractColorSupplier.Z_SCORE=1,morpheus.AbstractColorSupplier.ROBUST_Z_SCORE=2,morpheus.AbstractColorSupplier.toJSON=function(e){var t={fractions:e.fractions,colors:e.colors,min:e.min,max:e.max,missingColor:e.missingColor,scalingMode:e.scalingMode,stepped:e.stepped,transformValues:e.transformValues};return e.names&&(t.names=e.names),e.conditions&&e.conditions.array.length>0&&(t.conditions=e.conditions.array),e.sizer&&null!=e.sizer.seriesName&&(t.size={seriesName:e.sizer.seriesName,min:e.sizer.min,max:e.sizer.max}),t},morpheus.AbstractColorSupplier.fromJSON=function(e){var t=e.stepped?new morpheus.SteppedColorSupplier:new morpheus.GradientColorSupplier;null==e.scalingMode&&null!=e.type&&(e.scalingMode=e.type),"relative"===e.scalingMode||0===e.scalingMode?e.scalingMode=0:"fixed"===e.scalingMode||1===e.scalingMode?e.scalingMode=1:e.scalingMode=0,t.setScalingMode(e.scalingMode),null!=e.min&&t.setMin(e.min),null!=e.max&&t.setMax(e.max),null!=e.missingColor&&t.setMissingColor(e.missingColor),morpheus.HeatMapColorScheme.ScalingMode.RELATIVE!==e.scalingMode&&t.setTransformValues(e.transformValues),e.map&&(e.values=e.map.map(function(e){return e.value}),e.colors=e.map.map(function(e){return e.color}));var r=e.fractions;if(e.values){r=[];for(var n=e.values,i=Number.MAX_VALUE,o=-Number.MAX_VALUE,a=0;a<n.length;a++){var s=n[a];i=Math.min(i,s),o=Math.max(o,s)}var l=d3.scale.linear().domain([i,o]).range([0,1]).clamp(!0);for(a=0;a<n.length;a++)r.push(l(n[a]));null==e.min&&t.setMin(i),null==e.max&&t.setMax(o)}return null!=e.colors&&e.colors.length>0&&t.setFractions({colors:e.colors,fractions:r,names:e.names}),e.size&&(t.getSizer().setSeriesName(e.size.seriesName),t.getSizer().setMin(e.size.min),t.getSizer().setMax(e.size.max)),e.conditions&&_.isArray(e.conditions)&&(e.conditions.forEach(function(e){var t=function(){return!0},r=function(){return!0};null==e.seriesName&&(e.seriesName=e.series),null==e.v1||isNaN(e.v1)||(t="gt"===e.v1Op?function(t){return t>e.v1}:function(t){return t>=e.v1}),null==e.v2||isNaN(e.v2)||(r="lt"===e.v2Op?function(t){return t<e.v2}:function(t){return t<=e.v2}),e.accept=function(e){return t(e)&&r(e)}}),t.conditions.array=e.conditions),t},morpheus.AbstractColorSupplier.prototype={getTransformValues:function(){return this.transformValues},setTransformValues:function(e){this.transformValues=e},getSizer:function(){return this.sizer},getConditions:function(){return this.conditions},createInstance:function(){throw"not implemented"},copy:function(){var e=this.createInstance();return e.stepped=this.stepped,e.setFractions({fractions:this.fractions.slice(0),colors:this.colors.slice(0)}),null!=this.names&&(e.names=this.names.slice(0)),this.sizer&&(e.sizer=this.sizer.copy()),this.conditions&&(e.conditions=this.conditions.copy()),e.scalingMode=this.scalingMode,e.min=this.min,e.max=this.max,e.missingColor=this.missingColor,this.scalingMode!==morpheus.HeatMapColorScheme.ScalingMode.RELATIVE&&(e.transformValues=this.transformValues),e},setMissingColor:function(e){this.missingColor=e},getMissingColor:function(){return this.missingColor},getScalingMode:function(){return this.scalingMode},setScalingMode:function(e){e!==this.scalingMode&&(e===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE&&(this.min=0,this.max=1),this.scalingMode=e)},isStepped:function(){return!1},getColor:function(e,t,r){throw"not implemented"},getColors:function(){return this.colors},getNames:function(){return this.names},getFractions:function(){return this.fractions},getMin:function(){return this.min},getMax:function(){return this.max},setMin:function(e){this.min=e},setMax:function(e){this.max=e},setFractions:function(e){var t=morpheus.Util.indexSort(e.fractions,!0);this.fractions=morpheus.Util.reorderArray(e.fractions,t),this.colors=morpheus.Util.reorderArray(e.colors,t),this.names=e.names?morpheus.Util.reorderArray(e.names,t):null}},morpheus.AbstractComponent=function(){this.lastClip=null;var e=document.createElement("div");e.setAttribute("tabindex","0"),e.style.outline=0,e.style.overflow="hidden",e.style.position="absolute",this.el=e,this.$el=$(e)},morpheus.AbstractComponent.prototype={visible:!0,invalid:!0,prefWidth:void 0,prefHeight:void 0,appendTo:function(e){$(this.el).appendTo(e)},dispose:function(){$(this.el).remove()},getPrefWidth:function(){return this.prefWidth},setInvalid:function(e){this.invalid=e},setBounds:function(e){null!=e.left&&this.$el.css("left",e.left+"px"),null!=e.top&&this.$el.css("top",e.top+"px")},paint:function(e){this.getUnscaledWidth(),this.getUnscaledHeight(),this.draw(e),this.lastClip=e,this.invalid=!1},repaint:function(){this.lastClip||(this.lastClip={x:0,y:0,width:this.getUnscaledWidth(),height:this.getUnscaledHeight()}),this.paint(this.lastClip)},draw:function(e){},getPrefHeight:function(){return this.prefHeight},setPrefWidth:function(e){this.prefWidth=e},setPrefHeight:function(e){this.prefHeight=e},isVisible:function(){return this.visible},setVisible:function(e){this.visible!==e&&(this.visible=e,this.el.style.display=e?"":"none")},getUnscaledWidth:function(){return this.$el.width()},getUnscaledHeight:function(){return this.$el.height()},getWidth:function(){return this.$el.width()},getHeight:function(){return this.$el.height()}},morpheus.AbstractDendrogram=function(e,t,r,n,i){morpheus.AbstractCanvas.call(this,!0),this._overviewHighlightColor="#d8b365",this._searchHighlightColor="#e41a1c",this._selectedNodeColor=i===morpheus.AbstractDendrogram.Type.COLUMN?"#377eb8":"#984ea3",this.tree=t,this.type=i,this.squishEnabled=!1,this.heatMap=e,this.positions=r,this.project=n;var o=$("<span></span>");o.addClass("label label-info"),o.css("position","absolute"),this.$label=o;var a=$("<span></span>");a.addClass("label label-default"),a.css("position","absolute").css("top",18),this.$squishedLabel=a,this.$label=o,this.cutHeight=this.tree.maxHeight,this.drawLeafNodes=!0,this.lineWidth=.7,this.selectedNodeIds={},this.selectedRootNodeIdToNode={},this.nodeIdToHighlightedPathsToRoot={};var s=this;this.defaultStroke="rgb(0,0,0)",this.mouseMoveNodes=null;var l=function(e){if(!morpheus.CanvasUtil.dragging){var t=morpheus.CanvasUtil.getMousePosWithScroll(e.target,e,s.lastClip.x,s.lastClip.y);if(s.isDragHotSpot(t))s.canvas.style.cursor=s.getResizeCursor();else{var r;if(s.getNodes)r=s.getNodes(t);else{var n=s.getNode(t);n&&(r=[n])}if(s.mouseMoveNodes=r,null!=r){r.sort(function(e,t){return e.name<t.name});var o={event:e};o[i===morpheus.AbstractDendrogram.Type.COLUMN?"columnNodes":"rowNodes"]=r,s.heatMap.setToolTip(-1,-1,o),s.canvas.style.cursor="pointer"}else s.heatMap.setToolTip(-1,-1),s.canvas.style.cursor="default"}}};i!==morpheus.AbstractDendrogram.Type.RADIAL&&($(this.canvas).on("contextmenu",function(r){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();var o=morpheus.CanvasUtil.getMousePosWithScroll(r.target,r,s.lastClip.x,s.lastClip.y),a=s.getNode(o);return morpheus.Popup.showPopup([{name:"Flip",disabled:null==a},{name:"Branch Color",disabled:null==a},{separator:!0},{name:"Annotate..."},{name:"Save"},{separator:!0},{name:"Enrichment..."},{separator:!0},{name:"Squish Singleton Clusters",checked:s.squishEnabled},{separator:!0},{name:"Delete"}],{x:r.pageX,y:r.pageY},r.target,function(r,o){if("Save"===o)(x=new morpheus.FormBuilder).append({name:"file_name",type:"text",required:!0}),x.append({name:"leaf_node_id_field",type:"bootstrap-select",required:!0,options:morpheus.MetadataUtil.getMetadataNames(i===morpheus.AbstractDendrogram.Type.COLUMN?n.getFullDataset().getColumnMetadata():n.getFullDataset().getRowMetadata())}),morpheus.FormBuilder.showOkCancel({title:"Save Dendrogram",content:x.$form,focus:document.activeElement,okCallback:function(){var e=x.getValue("file_name");""===e&&(e="dendrogram.txt");var r=x.getValue("leaf_node_id_field"),o=[],a=i===morpheus.AbstractDendrogram.Type.COLUMN?n.getFullDataset().getColumnMetadata().getByName(r):n.getFullDataset().getRowMetadata().getByName(r);morpheus.DendrogramUtil.writeNewick(t.rootNode,o,function(e){return a.getValue(e.index)});var s=new Blob([o.join("")],{type:"text/plain;charset=charset=utf-8"});saveAs(s,e,!0)}});else if("Flip"===o){if(null!=a){for(var l=morpheus.AbstractDendrogram.Type.COLUMN===s.type,u=a.minIndex,c=a.maxIndex,h=t.leafNodes,p=u,d=c;p<=c;p++,d--){var f=h[p];f.index=d,f.maxIndex=d,f.minIndex=d}h.sort(function(e,t){return e.index<t.index?-1:1});var m=function(e){if(null!=e.children&&e.children.length>0){for(var t=0;t<e.children.length;t++)m(e.children[t]);var r=0;for(t=0;t<e.children.length;t++)r+=e.children[t].index;e.index=r/e.children.length;var n=-Number.MAX_VALUE,i=Number.MAX_VALUE;for(t=0;t<e.children.length;t++)n=Math.max(n,e.children[t].maxIndex),i=Math.min(i,e.children[t].minIndex);e.minIndex=i,e.maxIndex=n}};m(a);var g=[],v=l?e.getProject().getSortedFilteredDataset().getColumnCount():e.getProject().getSortedFilteredDataset().getRowCount();for(p=0;p<v;p++)g.push(l?n.convertViewColumnIndexToModel(p):n.convertViewRowIndexToModel(p));p=u;for(var y=c;p<y;p++,y--){var b=g[y];g[y]=g[p],g[p]=b}var w=new morpheus.SpecifiedModelSortOrder(g,g.length,"dendrogram",l);w.setPreservesDendrogram(!0),w.setLockOrder(2),w.setUnlockable(!1),l?e.getProject().setColumnSortKeys([w],!0):e.getProject().setRowSortKeys([w],!0),e.revalidate()}}else if("Branch Color"===o){var x;null!=a&&((x=new morpheus.FormBuilder).append({name:"color",type:"color",value:a.color,required:!0,style:"max-width:50px;"}),x.find("color").on("change",function(){var e=$(this).val();morpheus.DendrogramUtil.dfs(a,function(t){return t.color=e,!0}),s.setSelectedNode(null)}),morpheus.FormBuilder.showInModal({title:"Color",close:"Close",html:x.$form,focus:document.activeElement}))}else"Annotate..."===o?morpheus.HeatMap.showTool(new morpheus.AnnotateDendrogramTool(i===morpheus.AbstractDendrogram.Type.COLUMN),s.heatMap):"Enrichment..."===o?morpheus.HeatMap.showTool(new morpheus.DendrogramEnrichmentTool(i===morpheus.AbstractDendrogram.Type.COLUMN),s.heatMap):"Squish Singleton Clusters"===o?(s.squishEnabled=!s.squishEnabled,s.squishEnabled||s.positions.setSquishedIndices(null)):"Delete"===o&&(s.resetCutHeight(),s.heatMap.setDendrogram(null,i===morpheus.AbstractDendrogram.Type.COLUMN))}),!1}),$(this.canvas).on("mousemove",_.throttle(l,100)).on("mouseout",_.throttle(function(e){morpheus.CanvasUtil.dragging||(s.mouseMoveNodes=null,s.canvas.style.cursor="default")},100)).on("mouseenter",_.throttle(l,100)));var u=0;this.cutTreeHotSpot=!1,i!==morpheus.AbstractDendrogram.Type.RADIAL&&(this.hammer=morpheus.Util.hammer(this.canvas,["pan","tap"]).on("tap",this.tap=function(e){if(!morpheus.CanvasUtil.dragging){var t=morpheus.CanvasUtil.getMousePosWithScroll(e.target,e,s.lastClip.x,s.lastClip.y);if(s.cutTreeHotSpot=s.isDragHotSpot(t),s.cutTreeHotSpot)return;var r=s.getNode(t);null!=r&&void 0===r.parent&&(r=null);var n=morpheus.Util.IS_MAC?e.srcEvent.metaKey:e.srcEvent.ctrlKey;s.setSelectedNode(r,e.srcEvent.shiftKey||n)}}).on("panend",this.panend=function(e){morpheus.CanvasUtil.dragging=!1,s.canvas.style.cursor="default",s.cutTreeHotSpot=!0}).on("panstart",this.panstart=function(e){var t=morpheus.CanvasUtil.getMousePosWithScroll(e.target,e,s.lastClip.x,s.lastClip.y,!0);s.cutTreeHotSpot=s.isDragHotSpot(t),s.cutTreeHotSpot&&(morpheus.CanvasUtil.dragging=!0,s.canvas.style.cursor=s.getResizeCursor(),u=s.scale(s.cutHeight))}).on("panmove",this.panmove=function(e){if(s.cutTreeHotSpot){var t;if(s.type===morpheus.AbstractDendrogram.Type.COLUMN){var r=e.deltaY;t=Math.max(0,Math.min(s.tree.maxHeight,s.scale.invert(u+r)))}else if(s.type===morpheus.AbstractDendrogram.Type.ROW)r=e.deltaX,t=Math.max(0,Math.min(s.tree.maxHeight,s.scale.invert(u+r)));else{var n=morpheus.CanvasUtil.getMousePos(e.target,e);n.x=s.radius-n.x,n.y=s.radius-n.y;var i=Math.sqrt(n.x*n.x+n.y*n.y);t=i<=4?s.tree.maxHeight:Math.max(0,Math.min(s.tree.maxHeight,s.scale.invert(i)))}t>=s.tree.maxHeight?s.resetCutHeight():s.setCutHeight(t),e.preventDefault()}}))},morpheus.AbstractDendrogram.Type={COLUMN:0,ROW:1,RADIAL:2},morpheus.AbstractDendrogram.prototype={setSelectedNode:function(e,t){var r,n=this,i=this.type===morpheus.AbstractDendrogram.Type.COLUMN?this.project.getColumnSelectionModel():this.project.getRowSelectionModel();if(null==e)n.selectedNodeIds={},n.selectedRootNodeIdToNode={},r=new morpheus.Set;else if(t?r=i.getViewIndices():(r=new morpheus.Set,n.selectedNodeIds={},n.selectedRootNodeIdToNode={}),null!=e){if(void 0===e.children){var o=n.nodeIdToHighlightedPathsToRoot[e.id];t||(n.nodeIdToHighlightedPathsToRoot={}),o?delete n.nodeIdToHighlightedPathsToRoot[e.id]:n.nodeIdToHighlightedPathsToRoot[e.id]=e}else n.selectedRootNodeIdToNode[e.id]=e,morpheus.DendrogramUtil.dfs(e,function(e){return n.selectedNodeIds[e.id]=!0,!0});for(var a=e.minIndex;a<=e.maxIndex;a++)r.add(a)}n.trigger("nodeSelectionChanged",n.selectedRootNodeIdToNode),i.setViewIndices(r,!0),n.repaint()},getPathStroke:function(e){return this.selectedNodeIds[e.id]?this._selectedNodeColor:void 0!==e.color?e.color:this.defaultStroke},getNodeFill:function(e){return this.selectedRootNodeIdToNode[e.id]?this._selectedNodeColor:e.search?this._searchHighlightColor:void 0!==e.info?this._overviewHighlightColor:void 0},resetCutHeight:function(){this.positions.setSquishedIndices(null),this.type===morpheus.AbstractDendrogram.Type.COLUMN?this.project.setGroupColumns([],!0):this.project.setGroupRows([],!0),this.$label.text(""),this.$squishedLabel.text("");var e=this.project.getSortedFilteredDataset(),t=this.type===morpheus.AbstractDendrogram.Type.COLUMN?e.getColumnMetadata().getByName("dendrogram_cut"):e.getRowMetadata().getByName("dendrogram_cut");if(t)for(var r=0,n=t.size();r<n;r++)t.setValue(r,NaN)},setCutHeight:function(e){this.cutHeight=e;for(var t={},r=0,n=0,i=this.squishEnabled,o=morpheus.DendrogramUtil.cutAtHeight(this.tree.rootNode,this.cutHeight),a=this.project.getSortedFilteredDataset(),s=this.type===morpheus.AbstractDendrogram.Type.COLUMN?a.getColumnMetadata().add("dendrogram_cut"):a.getRowMetadata().add("dendrogram_cut"),l=0,u=o.length;l<u;l++){var c,h=o[l],p=morpheus.DendrogramUtil.getDeepestChild(h,!0),d=morpheus.DendrogramUtil.getDeepestChild(h,!1);i&&p.index===d.index?(t[p.index]=!0,c=-2,n++):c=++r;for(var f=p.index;f<=d.index;f++)s.setValue(f,c)}this.$label.text(r+" cluster"+morpheus.Util.s(r)),n>0?this.$squishedLabel.text(n+" squished"):this.$squishedLabel.text(""),i&&this.positions.setSquishedIndices(t),-1===this.heatMap.getTrackIndex(s.getName(),this.type===morpheus.AbstractDendrogram.Type.COLUMN)&&this.heatMap.addTrack(s.getName(),this.type===morpheus.AbstractDendrogram.Type.COLUMN,{discrete:!0,discreteAutoDetermined:!0,display:["color"]}),this.type===morpheus.AbstractDendrogram.Type.COLUMN?this.project.setGroupColumns([new morpheus.SortKey(s.getName(),morpheus.SortKey.SortOrder.UNSORTED)],!0):this.project.setGroupRows([new morpheus.SortKey(s.getName(),morpheus.SortKey.SortOrder.UNSORTED)],!0)},dispose:function(){morpheus.AbstractCanvas.prototype.dispose.call(this),this.$label.remove(),this.$squishedLabel.remove(),this.hammer.off("panend",this.panend).off("panstart",this.panstart).off("panmove",this.panmove).off("tap",this.tap),this.hammer.destroy(),this.$label=null,this.$squishedLabel=null},isCut:function(){return this.cutHeight<this.tree.maxHeight},getMinIndex:function(){return 0},getMaxIndex:function(){return this.positions.getLength()-1},getNode:function(e){if(this.lastNode){var t=this.toPix(this.lastNode);if(Math.abs(t[0]-e.x)<4&&Math.abs(t[1]-e.y)<4)return this.lastNode}return this.lastNode=this._getNode(e),this.lastNode},_getNode:function(e){var t=this,r=null;try{morpheus.DendrogramUtil.dfs(this.tree.rootNode,function(n){var i=t.toPix(n);if(Math.abs(i[0]-e.x)<4&&Math.abs(i[1]-e.y)<4)throw r=n,"break";return null===r})}catch(e){}return r},getResizeCursor:function(){return this.type===morpheus.AbstractDendrogram.Type.COLUMN?"ns-resize":this.type===morpheus.AbstractDendrogram.Type.ROW?"ew-resize":"nesw-resize"},isDragHotSpot:function(e){return!1},preDraw:function(e,t){},postDraw:function(e,t){},prePaint:function(e,t){this.scale=this.createScale();var r=this.getMinIndex(e),n=this.getMaxIndex(e);r===this.lastMinIndex&&n===this.lastMinIndex||(this.lastMinIndex=r,this.lastMaxIndex=n),this.invalid=!0},draw:function(e,t){t.translate(-e.x,-e.y),t.strokeStyle="black",t.fillStyle="black",this.scale=this.createScale();var r=this.lastMinIndex,n=this.lastMaxIndex;t.lineWidth=this.lineWidth,this.preDraw(t,e),t.strokeStyle=this.defaultStroke,t.fillStyle="rgba(166,206,227,0.5)",this.drawDFS(t,this.tree.rootNode,r,n,0),t.strokeStyle="black",t.fillStyle="black",this.postDraw(t,e)},drawCutSlider:function(){throw new Error},postPaint:function(e,t){t.strokeStyle="black",this.paintMouseOver(e,t),this.drawCutSlider(e,t)},getNodeRadius:function(e){return 4},drawNode:function(e,t){},drawDFS:function(e,t,r,n){if(this.type===morpheus.AbstractDendrogram.Type.RADIAL||!(t.maxIndex<r||t.minIndex>n)){var i=this.getNodeFill(t);void 0!==i&&(e.fillStyle=i,this.drawNode(e,t)),e.strokeStyle=this.getPathStroke(t);var o=t.children;if(void 0!==o){this.drawNodePath(e,t,r,n);for(var a=0,s=o.length;a<s;a++)this.drawDFS(e,o[a],r,n)}}}},morpheus.Util.extend(morpheus.AbstractDendrogram,morpheus.AbstractCanvas),morpheus.Util.extend(morpheus.AbstractDendrogram,morpheus.Events),morpheus.ActionManager=function(){this.actionNameToAction=new morpheus.Map,this.actions=[],this.add({ellipsis:!0,name:"Sort/Group",cb:function(e){new morpheus.SortDialog(e.heatMap.getProject())},icon:"fa fa-sort-alpha-asc"});var e,t,r=null,n=function(e){morpheus.Util.isNode()||window.open(e)};this.add({name:"Filter",ellipsis:!0,cb:function(e){if(null==r){var t=[],n=_.uniqueId("morpheus");t.push('<div class="modal" tabindex="1" role="dialog" aria-labelledby="'+n+'">'),t.push('<div class="modal-dialog" role="document">'),t.push('<div class="modal-content">'),t.push('<div class="modal-header">'),t.push('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'),t.push('<h4 class="modal-title" id="'+n+'">Filter</h4>'),t.push("</div>"),t.push('<div class="modal-body"></div>'),t.push('<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div>'),t.push("</div>"),t.push("</div>"),t.push("</div>"),(r=$(t.join(""))).on("mousewheel",function(e){e.stopPropagation()});var i=$('<div style="padding-bottom:30px;"></div>');i.appendTo(r.find(".modal-body"));var o=[];o.push('<div class="radio"><label><input type="radio" name="rowsOrColumns" value="rows" checked>Rows</label></div> '),o.push('<div class="radio"><label><input type="radio" name="rowsOrColumns" value="columns">Columns</label></div>');var a=$(o.join(""));a.appendTo(i);var s=new morpheus.FilterUI(e.heatMap.getProject(),!0),l=new morpheus.FilterUI(e.heatMap.getProject(),!1);l.$div.appendTo(i),s.$div.appendTo(i),s.$div.css("display","none");var u=a.find("[name=rowsOrColumns]");u.on("change",function(e){"columns"===u.filter(":checked").val()?(s.$div.show(),l.$div.hide()):(s.$div.hide(),l.$div.show()),e.preventDefault()}),r.appendTo(e.heatMap.$content),r.on("hidden.bs.modal",function(){e.heatMap.focus()})}r.modal("show")},icon:"fa fa-filter"}),this.add({name:"Options",ellipsis:!0,cb:function(e){e.heatMap.showOptions()},icon:"fa fa-cog"}),this.add({which:[191],commandKey:!0,global:!0,name:"Toggle Search",cb:function(e){e.heatMap.getToolbar().toggleSearch()}}),this.add({name:"Copy Image",icon:"fa fa-clipboard",cb:function(e){var t=e.heatMap.getTotalSize(),r=t.height,n=t.width,i=$("<canvas></canvas>")[0],o=morpheus.CanvasUtil.BACKING_SCALE;i.height=o*r,i.style.height=r+"px",i.width=o*n,i.style.width=n+"px";var a=i.getContext("2d");morpheus.CanvasUtil.resetTransform(a),e.heatMap.snapshot(a);var s=i.toDataURL();morpheus.Util.setClipboardData([{format:"text/html",data:'<img src="'+s+'">'}],!0)}}),this.add({name:"Close Tab",cb:function(e){e.heatMap.getTabManager().remove(e.heatMap.tabId)}}),this.add({name:"Rename Tab",ellipsis:!0,cb:function(e){e.heatMap.getTabManager().rename(e.heatMap.tabId)}}),this.add({which:[88],commandKey:!0,name:"New Heat Map",accept:function(e){return!e.isInputField||""===window.getSelection().toString()},cb:function(e){morpheus.HeatMap.showTool(new morpheus.NewHeatMapTool,e.heatMap)}}),this.add({which:[67],commandKey:!0,name:"Copy"}),this.add({which:[86],commandKey:!0,name:"Paste Dataset"}),this.add({global:!0,name:"Open",ellipsis:!0,cb:function(e){morpheus.HeatMap.showTool(new morpheus.OpenFileTool,e.heatMap)},which:[79],commandKey:!0,icon:"fa fa-folder-open-o"}),this.add({ellipsis:!0,name:"Save Image",gui:function(){return new morpheus.SaveImageTool},cb:function(e){morpheus.HeatMap.showTool(this.gui(),e.heatMap)},which:[83],commandKey:!0,global:!0,icon:"fa fa-file-image-o"}),this.add({ellipsis:!0,name:"Save Dataset",gui:function(){return new morpheus.SaveDatasetTool},cb:function(e){morpheus.HeatMap.showTool(this.gui(),e.heatMap)},icon:"fa fa-floppy-o"}),this.add({ellipsis:!0,name:"Save Session",gui:function(){return new morpheus.SaveSessionTool},cb:function(e){morpheus.HeatMap.showTool(this.gui(),e.heatMap)},icon:"fa fa-anchor"}),"undefined"!=typeof echarts&&this.add({name:"Chart",cb:function(e){new morpheus.ChartTool({project:e.heatMap.getProject(),heatmap:e.heatMap,getVisibleTrackNames:_.bind(e.heatMap.getVisibleTrackNames,e.heatMap)})},icon:"fa fa-line-chart"}),this.add({name:"Zoom In",cb:function(e){e.heatMap.zoom(!0)},which:[107,61,187]}),this.add({name:"Zoom Out",cb:function(e){e.heatMap.zoom(!1)},which:[173,189,109]}),this.add({name:"Fit To Window",cb:function(e){e.heatMap.fitToWindow({fitRows:!0,fitColumns:!0,repaint:!0})},which:[48],commandKey:!0,icon:"fa fa-compress"}),this.add({name:"Fit Columns To Window",cb:function(e){e.heatMap.fitToWindow({fitRows:!1,fitColumns:!0,repaint:!0})}}),this.add({name:"Fit Rows To Window",cb:function(e){e.heatMap.fitToWindow({fitRows:!0,fitColumns:!1,repaint:!0})}}),this.add({name:"100%",cb:function(e){e.heatMap.resetZoom()},button:"100%",which:[48],commandKey:!0,shiftKey:!0}),this.add({which:[35],name:"Go To End",cb:function(e){e.heatMap.scrollLeft(e.heatMap.heatmap.getPreferredSize().width),e.heatMap.scrollTop(e.heatMap.heatmap.getPreferredSize().height)}}),this.add({which:[36],name:"Go To Start",cb:function(e){e.heatMap.scrollLeft(0),e.heatMap.scrollTop(0)}}),this.add({which:[34],commandKey:!0,name:"Go To Bottom",cb:function(e){e.heatMap.scrollTop(e.heatMap.heatmap.getPreferredSize().height)}}),this.add({which:[34],commandKey:!1,name:"Scroll Page Down",cb:function(e){var t=e.heatMap.scrollTop();e.heatMap.scrollTop(t+e.heatMap.heatmap.getUnscaledHeight()-2)}}),this.add({which:[33],commandKey:!0,name:"Go To Top",cb:function(e){e.heatMap.scrollTop(0)}}),this.add({which:[33],commandKey:!1,name:"Scroll Page Up",cb:function(e){var t=e.heatMap.scrollTop();e.heatMap.scrollTop(t-e.heatMap.heatmap.getUnscaledHeight()+2)}}),this.add({which:[38],commandKey:!0,name:"Zoom Out Rows",cb:function(e){e.heatMap.zoom(!1,{columns:!1,rows:!0})}}),this.add({which:[38],commandKey:!1,name:"Scroll Up",cb:function(e){e.heatMap.scrollTop(e.heatMap.scrollTop()-8)}}),this.add({which:[40],commandKey:!0,name:"Zoom In Rows",cb:function(e){e.heatMap.zoom(!0,{columns:!1,rows:!0})}}),this.add({which:[40],commandKey:!1,name:"Scroll Down",cb:function(e){e.heatMap.scrollTop(e.heatMap.scrollTop()+8)}}),this.add({which:[37],commandKey:!0,name:"Zoom Out Columns",cb:function(e){e.heatMap.zoom(!1,{columns:!0,rows:!1})}}),this.add({which:[37],commandKey:!1,name:"Scroll Left",cb:function(e){e.heatMap.scrollLeft(e.heatMap.scrollLeft()-8)}}),this.add({which:[39],commandKey:!0,name:"Zoom In Columns",cb:function(e){e.heatMap.zoom(!0,{columns:!0,rows:!1})}}),this.add({which:[39],commandKey:!1,name:"Scroll Right",cb:function(e){e.heatMap.scrollLeft(e.heatMap.scrollLeft()+8)}}),this.add({name:"Tutorial",cb:function(){n("https://software.broadinstitute.org/morpheus/tutorial.html")}}),this.add({icon:"fa fa-code",name:"Source Code",cb:function(){n("https://github.com/cmap/morpheus.js")}}),this.add({which:[65],ellipsis:!0,shiftKey:!0,commandKey:!0,name:"Find Action",cb:function(r){if(null==e){var n=[],i=_.uniqueId("morpheus");n.push('<div class="modal" tabindex="1" role="dialog" aria-labelledby="'+i+'">'),n.push('<div class="modal-dialog" role="document">'),n.push('<div class="modal-content">'),n.push('<div class="modal-header">'),n.push('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'),n.push('<h4 class="modal-title" id="'+i+'">Enter action</h4>'),n.push("</div>"),n.push('<div class="modal-body ui-front"><input class="form-control input-sm"></div>'),n.push("</div>"),n.push("</div>"),n.push("</div>"),(e=$(n.join(""))).appendTo(r.heatMap.$content);var o=r.heatMap.getActionManager().getActions();(t=e.find("input")).on("keyup",function(r){if(13===r.which){var n=t.val().trim();""!==n&&c.getAction(n)&&(e.modal("hide"),c.execute(n,{event:r}))}}),morpheus.Util.autosuggest({$el:t,multi:!1,suggestWhenEmpty:!1,filter:function(e,t){for(var r=e[0].trim(),n=[],i=new RegExp("("+morpheus.Util.escapeRegex(r)+")","i"),a=0;a<o.length;a++)if(o[a].cb){var s=o[a].name;i.test(s)&&n.push({clear:!0,value:s,label:'<span style="margin-left: 10px">'+s.replace(i,"<b>$1</b>")+"</span>"})}t(n)},select:function(){setTimeout(function(){var r=t.val().trim();""!==r&&c.getAction(r)&&(e.modal("hide"),c.execute(r))},20)}}),e.on("hidden.bs.modal",function(){r.heatMap.focus()})}e.modal("show"),t.focus()}}),this.add({name:"Keyboard Shortcuts",cb:function(e){new morpheus.HeatMapKeyListener(e.heatMap).showKeyMapReference()}}),this.add({name:"Configuration",cb:function(){n("https://software.broadinstitute.org/morpheus/configuration.html")}}),this.add({name:"Contact",icon:"fa fa-envelope-o",cb:function(e){morpheus.FormBuilder.showInModal({title:"Contact",html:"Please email us at morpheus@broadinstitute.org",focus:e.heatMap.getFocusEl()})}}),this.add({which:[65],commandKey:!0,name:"Select All",accept:function(e){var t=e.heatMap.getActiveComponent();return"rowTrack"===t||"columnTrack"===t},cb:function(e){for(var t=e.heatMap.getActiveComponent(),r="rowTrack"===t?e.heatMap.getProject().getRowSelectionModel():e.heatMap.getProject().getColumnSelectionModel(),n="rowTrack"===t?e.heatMap.getProject().getSortedFilteredDataset().getRowCount():e.heatMap.getProject().getSortedFilteredDataset().getColumnCount(),i=new morpheus.Set,o=0;o<n;o++)i.add(o);r.setViewIndices(i,!0)}});var i=function(e,t){for(var r=t?e.heatMap.getProject().getColumnSelectionModel():e.heatMap.getProject().getRowSelectionModel(),n=r.getViewIndices(),i=new morpheus.Set,o=o=t?e.heatMap.getProject().getSortedFilteredDataset().getColumnCount():e.heatMap.getProject().getSortedFilteredDataset().getRowCount(),a=0;a<o;a++)n.has(a)||i.add(a);r.setViewIndices(i,!0)};this.add({name:"Invert Selected Rows",cb:function(e){i(e,!1)}}),this.add({name:"Invert Selected Columns",cb:function(e){i(e,!0)}});var o=function(e,t){(t?e.heatMap.getProject().getColumnSelectionModel():e.heatMap.getProject().getRowSelectionModel()).setViewIndices(new morpheus.Set,!0)};this.add({name:"Clear Selected Rows",cb:function(e){o(e,!1)}}),this.add({name:"Clear Selected Columns",cb:function(e){o(e,!0)}});var a=function(e,t){var r=e.heatMap.getProject(),n=(t?r.getColumnSelectionModel():r.getRowSelectionModel()).getViewIndices().values();if(0!==n.length){n.sort(function(e,t){return e===t?0:e<t?-1:1});var i=t?r.convertViewColumnIndexToModel:r.convertViewRowIndexToModel;i=_.bind(i,r);for(var o=[],a=0,s=n.length;a<s;a++)o.push(i(n[a]));var l=new morpheus.MatchesOnTopSortKey(r,o,"selection on top",t);l.setLockOrder(1),l.setUnlockable(!1),t?r.setColumnSortKeys(morpheus.SortKey.keepExistingSortKeys([l],r.getColumnSortKeys().filter(function(e){return!(e instanceof morpheus.MatchesOnTopSortKey&&e.toString()===l.toString())})),!0):r.setRowSortKeys(morpheus.SortKey.keepExistingSortKeys([l],r.getRowSortKeys().filter(function(e){return!(e instanceof morpheus.MatchesOnTopSortKey&&e.toString()===l.toString())})),!0)}};this.add({name:"Move Selected Rows To Top",cb:function(e){a(e,!1)}}),this.add({name:"Move Selected Columns To Top",cb:function(e){a(e,!0)}});var s=function(e,t){for(var r=e.heatMap.getProject(),n=t?r.getColumnSelectionModel():r.getRowSelectionModel(),i=t?r.getSortedFilteredDataset().getColumnCount():r.getSortedFilteredDataset().getRowCount(),o=new morpheus.Set,a=0;a<i;a++)o.add(a);n.setViewIndices(o,!0)};this.add({name:"Select All Rows",cb:function(e){s(e,!1)}}),this.add({name:"Select All Columns",cb:function(e){s(e,!0)}});var l=function(e,t){var r,n=e.heatMap.getProject(),i=n.getSortedFilteredDataset(),o=e.heatMap.getSelectedTrackName(t);r=null==o?t?i.getColumnMetadata().get(0):i.getRowMetadata().get(0):t?i.getColumnMetadata().getByName(o):i.getRowMetadata().getByName(o);var a=t?n.getColumnSelectionModel():n.getRowSelectionModel(),s=[],l=morpheus.VectorTrack.vectorToString(r);a.getViewIndices().forEach(function(e){s.push(l(r.getValue(e)))}),morpheus.Util.setClipboardData([{format:"text/plain",data:s.join("\n")}])};this.add({name:"Copy Selected Rows",cb:function(e){l(e,!1)}}),this.add({name:"Copy Selected Columns",cb:function(e){l(e,!0)}});var u=function(e,t){var r=e.heatMap.getProject(),n=t?r.getColumnSelectionModel():r.getRowSelectionModel();if(0!==n.count()){var i=new morpheus.FormBuilder;i.append({name:"annotation_name",type:"text",required:!0}),i.append({name:"annotation_value",type:"text",required:!0}),morpheus.FormBuilder.showOkCancel({title:"Annotate",content:i.$form,focus:e.heatMap.getFocusEl(),okCallback:function(){var e=i.getValue("annotation_value"),o=i.getValue("annotation_name"),a=r.getSortedFilteredDataset(),s=r.getFullDataset();t&&(a=new morpheus.TransposedDatasetView(a),s=new morpheus.TransposedDatasetView(s));var l=s.getRowMetadata().getByName(o),u=a.getRowMetadata().add(o);n.getViewIndices().forEach(function(t){u.setValue(t,e)}),morpheus.VectorUtil.maybeConvertStringToNumber(u),r.trigger("trackChanged",{vectors:[u],display:null!=l?[]:[morpheus.VectorTrack.RENDER.TEXT],columns:t})}})}else morpheus.FormBuilder.showMessageModal({title:"Annotate Selection",html:"No "+(t?"columns":"rows")+" selected.",focus:e.heatMap.getFocusEl()})};this.add({ellipsis:!0,name:"Annotate Selected Rows",cb:function(e){u(e,!1)}}),this.add({ellipsis:!0,name:"Annotate Selected Columns",cb:function(e){u(e,!0)}}),this.add({name:"Copy Selected Dataset",cb:function(e){var t=e.heatMap.getProject().getSelectedDataset({emptyToAll:!1}),r=t.getColumnMetadata(),n=t.getRowMetadata(),i=e.heatMap.getVisibleTrackNames(!0),o=[];_.each(i,function(e){var t=morpheus.MetadataUtil.indexOf(r,e);-1!==t&&o.push(t)}),r=new morpheus.MetadataModelColumnView(r,o),n=t.getRowMetadata();var a=e.heatMap.getVisibleTrackNames(!1),s=[];_.each(a,function(e){var t=morpheus.MetadataUtil.indexOf(n,e);-1!==t&&s.push(t)}),n=new morpheus.MetadataModelColumnView(n,s);var l=(new morpheus.GctWriter).write(t);morpheus.Util.setClipboardData([{format:"text/plain",data:l}])}});var c=this;[new morpheus.HClusterTool,new morpheus.KMeansTool,new morpheus.MarkerSelection,new morpheus.NearestNeighbors,new morpheus.AdjustDataTool,new morpheus.CollapseDatasetTool,new morpheus.CreateAnnotation,new morpheus.SimilarityMatrixTool,new morpheus.TransposeTool,new morpheus.TsneTool,new morpheus.DevAPI].forEach(function(e){c.add({ellipsis:!0,name:e.toString(),gui:function(){return e},cb:function(t){morpheus.HeatMap.showTool(e,t.heatMap)}})}),this.add({name:"Edit Fonts",ellipse:!0,cb:function(e){var t=e.heatMap.getLastSelectedTrackInfo(),r=e.heatMap.getProject(),n=t.isColumns?r.getColumnFontModel():r.getRowFontModel(),i=new morpheus.FontChooser({fontModel:n,track:e.heatMap.getTrack(t.name,t.isColumns),heatMap:e.heatMap});morpheus.FormBuilder.showInModal({title:"Edit Fonts",html:i.$div,close:"Close",focus:e.heatMap.getFocusEl()})}})},morpheus.ActionManager.prototype={getActions:function(){return this.actions},getAction:function(e){return this.actionNameToAction.get(e)},execute:function(e,t){var r=this.getAction(e);null==t&&(t={}),t.heatMap=this.heatMap,r.cb(t),morpheus.Util.trackEvent({eventCategory:"Tool",eventAction:e})},add:function(e){this.actions.push(e),this.actionNameToAction.set(e.name,e)}},morpheus.CanvasUtil=function(){},morpheus.CanvasUtil.dragging=!1,morpheus.CanvasUtil.FONT_NAME='"Helvetica Neue",Helvetica,Arial,sans-serif',morpheus.CanvasUtil.FONT_COLOR="rgb(0, 0, 0)",morpheus.CanvasUtil.getFontFamily=function(e){return"undefined"!=typeof C2S&&e instanceof C2S||"undefined"!=typeof canvas2pdf&&e instanceof canvas2pdf.PdfContext?"Helvetica":morpheus.CanvasUtil.FONT_NAME},morpheus.CanvasUtil.getPreferredSize=function(e){var t=e.getPreferredSize(),r=e.getPrefWidth(),n=e.getPrefHeight();return void 0!==r&&(t.widthSet=!0,t.width=r),void 0!==n&&(t.heightSet=!0,t.height=n),t},morpheus.CanvasUtil.BACKING_SCALE=1,"undefined"!=typeof window&&"devicePixelRatio"in window&&window.devicePixelRatio>1&&(morpheus.CanvasUtil.BACKING_SCALE=window.devicePixelRatio),morpheus.CanvasUtil.setBounds=function(e,t){var r=morpheus.CanvasUtil.BACKING_SCALE;null!=t.height&&(e.height=t.height*r,e.style.height=t.height+"px"),null!=t.width&&(e.width=t.width*r,e.style.width=t.width+"px"),null!=t.left&&(e.style.left=t.left+"px"),null!=t.top&&(e.style.top=t.top+"px")},morpheus.CanvasUtil.drawShape=function(e,t,r,n,i,o){i<0||(e.beginPath(),"circle-minus"===t?(e.arc(r,n,i,0,2*Math.PI,!1),e.moveTo(r-i,n),e.lineTo(r+i,n)):"circle"===t?e.arc(r,n,i,0,2*Math.PI,!1):"square"===t?e.rect(r-i,n-i,2*i,2*i):"plus"===t?(e.moveTo(r,n-i),e.lineTo(r,n+i),e.moveTo(r-i,n),e.lineTo(r+i,n)):"x"===t?(e.moveTo(r-i,n-i),e.lineTo(r+i,n+i),e.moveTo(r+i,n-i),e.lineTo(r-i,n+i)):"asterisk"===t?(e.moveTo(r-i,n-i),e.lineTo(r+i,n+i),e.moveTo(r+i,n-i),e.lineTo(r-i,n+i),e.moveTo(r,n-i),e.lineTo(r,n+i)):"diamond"===t?(e.moveTo(r,n-i),e.lineTo(r+i,n),e.lineTo(r,n+i),e.lineTo(r-i,n),e.lineTo(r,n-i)):"triangle-up"===t?(e.moveTo(r,n-i),e.lineTo(r+i,n+i),e.lineTo(r-i,n+i),e.lineTo(r,n-i)):"triangle-down"===t?(e.moveTo(r,n+i),e.lineTo(r-i,n-i),e.lineTo(r+i,n-i),e.lineTo(r,n+i)):"triangle-left"===t?(e.moveTo(r-i,n),e.lineTo(r+i,n-i),e.lineTo(r+i,n+i),e.lineTo(r-i,n)):"triangle-right"===t&&(e.moveTo(r+i,n),e.lineTo(r-i,n+i),e.lineTo(r-i,n-i),e.lineTo(r+i,n)),o?e.fill():e.stroke())},morpheus.CanvasUtil.drawLine=function(e,t,r,n,i){e.beginPath(),e.moveTo(t,r),e.lineTo(n,i),e.stroke()},morpheus.CanvasUtil.resetTransform=function(e){e.setTransform(1,0,0,1,0,0),1!==morpheus.CanvasUtil.BACKING_SCALE&&e.scale(morpheus.CanvasUtil.BACKING_SCALE,morpheus.CanvasUtil.BACKING_SCALE)},morpheus.CanvasUtil.bezierCurveTo=function(e,t,r){var n=(t[1]+r[1])/2;e.beginPath(),e.moveTo(t[0],t[1]),e.bezierCurveTo(t[0],n,r[0],n,r[0],r[1]),e.stroke()},morpheus.CanvasUtil.createCanvas=function(){var e=$("<canvas></canvas>");return e.attr("tabindex","0"),e.css({cursor:"default",outline:0,overflow:"hidden",position:"absolute","z-index":1}),e[0]},morpheus.CanvasUtil.getHeaderStringWidth=function(e,t){return e.font="14px "+morpheus.CanvasUtil.getFontFamily(e),e.measureText(t).width+18},morpheus.CanvasUtil.forceSubPixelRendering=function(e){e.getImageData(0,0,1,1)},morpheus.CanvasUtil.getVectorStringWidth=function(e,t,r,n){if(r.getSize()<6)return 0;var i=Math.min(morpheus.VectorTrack.MAX_FONT_SIZE,r.getSize()-2);if(i<=0)return 0;e.font=i+"px "+morpheus.CanvasUtil.getFontFamily(e);for(var o=morpheus.VectorTrack.vectorToString(t),a=0,s=n<=0?t.size():Math.min(n,t.size()),l=0;l<s;l++){var u=t.getValue(l);if(null!=u&&""!=u){u=o(u);var c=e.measureText(u).width;c>a&&(a=c)}}return 0===a?a:a+2},morpheus.CanvasUtil.clipString=function(e,t,r){if(e.measureText(t).width<=r)return t;if((r-=e.measureText("...").width)<=0)return"...";for(var n=0,i=0,o=t.length;i<o;i++)if((n+=e.measureText(t[i]).width)>r){t=t.substring(0,i);break}return t+"..."},morpheus.CanvasUtil.toSVG=function(e,t){var r={width:e.getWidth(),height:e.getHeight()},n=new C2S(r.width,r.height);n.save(),e.draw({x:0,y:0,width:r.width,height:r.height},n),n.restore();var i=n.getSerializedSvg(),o=new Blob([i],{type:"text/plain;charset=utf-8"});saveAs(o,t)},morpheus.CanvasUtil.getMousePos=function(e,t,r){return morpheus.CanvasUtil.getMousePosWithScroll(e,t,0,0,r)},morpheus.CanvasUtil.getClientXY=function(e,t){var r,n;return e.pointers?e.pointers.length>0?(r=e.pointers[0].clientX-(t?e.deltaX:0),n=e.pointers[0].clientY-(t?e.deltaY:0)):(r=e.srcEvent.clientX-(t?e.deltaX:0),n=e.srcEvent.clientY-(t?e.deltaY:0)):(r=e.clientX,n=e.clientY),{x:r,y:n}},morpheus.CanvasUtil.getMousePosWithScroll=function(e,t,r,n,i){return morpheus.CanvasUtil._getMousePosWithScroll(e,r,n,morpheus.CanvasUtil.getClientXY(t,i))},morpheus.CanvasUtil._getMousePosWithScroll=function(e,t,r,n){var i=e.getBoundingClientRect();return{x:n.x-i.left+t,y:n.y-i.top+r}},morpheus.CheckBoxList=function(e){var t=this,r=e.set||new morpheus.Set;e=$.extend(!0,{},{height:"150px",showHeader:!1,select:!1,search:!0,checkBoxSelectionOnTop:!1,rowHeader:function(e){var n=[];return n.push('<span><input name="toggle" type="checkbox" '+(r.has(t.getter(e))?" checked":"")+"/> "),n.push("</span>"),n.join("")}},e),1===(e=morpheus.Table.createOptions(e)).columns.length&&(e.maxWidth=583);for(var n=e.columns[0],i=0;i<e.columns.length;i++)if(e.columns[i].idColumn){n=e.columns[i];break}this.getter=n.getter;var o=[],a=new morpheus.Table(e);1===e.columns.length&&e.$el.find(".slick-table-header").find("[name=right]").remove(),this.table=a,(o=[]).push('<div style="display:inline;">'),o.push('<div style="display:inline;" class="dropdown">'),o.push('<button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'),o.push('<i data-name="checkbox" class="fa fa-square-o" aria-hidden="true"></i>'),o.push(' <span class="fa fa-caret-down"></span>'),o.push("</button>"),o.push('<ul style="font-size:12px;" class="dropdown-menu">'),o.push('<li><a name="selectAll" href="#">Select All</a></li>'),o.push('<li><a name="selectNone" href="#">Select None</a></li>'),o.push('<li><a name="invertSel" href="#">Invert Selection</a></li>'),o.push("</ul>"),o.push("</div>"),o.push('<span data-name="available" style="font-size:12px;padding-left:6px;"></span>'),o.push("</div>");var s=$(o.join(""));a.$header.find("[name=left]").html(s);var l=s.find("[data-name=available]"),u=s.find("[name=selectAll]"),c=s.find("[name=selectNone]"),h=s.find("[data-name=checkbox]"),p=function(){var e=[];e.push("selected "),e.push(morpheus.Util.intFormat(r.size())),e.push(" of "),e.push(morpheus.Util.intFormat(a.getAllItemCount())),a.getFilteredItemCount()!==a.getAllItemCount()&&(e.push(", "),e.push(morpheus.Util.intFormat(a.getFilteredItemCount())),e.push(1===a.getFilteredItemCount()?" match":" matches")),l.html(e.join(""))};a.grid.on("filter",function(e){p()}),h.on("click",function(e){if(h.hasClass("fa-square-o"))for(var n=a.getItems(),i=0;i<n.length;i++)r.add(t.getter(n[i]));else for(n=a.getItems(),i=0;i<n.length;i++)r.remove(t.getter(n[i]));a.trigger("checkBoxSelectionChanged",{source:t,set:r}),e.preventDefault(),e.stopPropagation()}),u.on("click",function(e){for(var n=a.getItems(),i=0,o=n.length;i<o;i++)r.add(t.getter(n[i]));t.table.trigger("checkBoxSelectionChanged",{source:t,set:r}),e.preventDefault(),t.table.redraw()}),s.find("[name=invertSel]").on("click",function(e){for(var n=a.getItems(),i=0,o=n.length;i<o;i++){var s=t.getter(n[i]);r.has(s)?r.remove(s):r.add(s)}t.table.trigger("checkBoxSelectionChanged",{source:t,set:r}),e.preventDefault(),t.table.redraw()}),c.on("click",function(e){for(var n=a.getItems(),i=0,o=n.length;i<o;i++)r.remove(t.getter(n[i]));t.table.trigger("checkBoxSelectionChanged",{source:t,set:r}),e.preventDefault(),t.table.redraw()}),this.set=r,this.table=a,p(),this.table.on("checkBoxSelectionChanged",function(){if(0===r.size())h.attr("class","fa fa-square-o");else{for(var e=a.getItems(),n=0,i=!1,o=!1,s=0;s<e.length;s++)if(r.has(t.getter(e[s]))){if(n++,i=!0,o)break}else if(o=!0,i)break;0===n?h.attr("class","fa fa-square-o"):n===e.length?h.attr("class","fa fa-check-square-o"):h.attr("class","fa fa-minus-square-o")}p(),t.table.redraw()}),a.on("click",function(n){var i=$(n.target),o=a.getItems()[n.row],s=t.getter(o);i.is(".morpheus-hover-show")?(r.clear(),r.add(s),t.table.trigger("checkBoxSelectionChanged",{source:t,set:r})):(!e.select||i.is("[type=checkbox]")&&"toggle"===i.attr("name"))&&(r.has(s)?r.remove(s):r.add(s),t.table.trigger("checkBoxSelectionChanged",{source:t,set:r}))})},morpheus.CheckBoxList.prototype={searchWithPredicates:function(e){this.table.searchWithPredicates(e)},autocomplete:function(e,t){this.table.autocomplete(e,t)},setHeight:function(e){this.table.setHeight(e)},resize:function(){this.table.resize()},setSearchVisible:function(e){this.table.setSearchVisible(e)},getSelectedRows:function(){return this.table.getSelectedRows()},getSelectedItems:function(){return this.table.getSelectedItems()},setSelectedRows:function(e){this.table.setSelectedRows(e)},getItems:function(e){return this.table.getItems()},getAllItemCount:function(){return this.table.getAllItemCount()},getFilteredItemCount:function(){return this.table.getFilteredItemCount()},setFilter:function(e){this.table.setFilter(e)},redraw:function(){this.table.redraw()},getSelection:function(){return this.set},clearSelection:function(e){this.set.clear(),this.table.redraw()},setValue:function(e){this.setSelectedValues(e)},setSelectedValues:function(e){if(this.set.clear(),morpheus.Util.isArray(e))for(var t=0;t<e.length;t++)this.set.add(e[t]);else this.set.add(e);this.table.redraw()},val:function(){return this.set.values()},on:function(e,t){return this.table.on(e,t),this},off:function(e,t){this.table.off(e,t)},setItems:function(e){for(var t=new morpheus.Set,r=this.getter,n=0;n<e.length;n++)t.add(r(e[n]));var i=this.set;i.forEach(function(e){t.has(e)||i.remove(e)}),this.table.setItems(e),this.table.trigger("checkBoxSelectionChanged",{source:this,set:i})}},morpheus.ColorSchemeChooser=function(e){this.options=e,this.init()},morpheus.ColorSchemeChooser.prototype={init:function(){var e,t=this.options.heatMap,r=this.options.isColumns,n=r?t.getProject().getColumnColorModel():t.getProject().getRowColorModel(),i=r?t.getProject().getFullDataset().getColumnMetadata():t.getProject().getFullDataset().getRowMetadata();this.setAnnotationName=function(t){e=t,l()};var o=this,a=new morpheus.FormBuilder,s=$("<div></div>");s.appendTo(a.$form),a.append({name:"discrete",type:"checkbox"});var l=function(){var t,r=i.getByName(e);if(null!=r){var l=morpheus.VectorUtil.getDataType(i.getByName(e)),u="number"===l||"[number]"===l;a.setVisible("discrete",u),a.setValue("discrete",r.getProperties().get(morpheus.VectorKeys.DISCRETE)),r.getProperties().get(morpheus.VectorKeys.DISCRETE)?(n.getMappedValue(r,r.getValue(0)),(t=new morpheus.DiscreteColorSchemeChooser({colorScheme:{scale:n.getDiscreteColorScheme(i.getByName(e))}})).on("change",function(t){n.setMappedValue(i.getByName(e),t.value,t.color),o.trigger("change")})):(n.getContinuousMappedValue(r,r.getValue(0)),(t=new morpheus.HeatMapColorSchemeChooser({showRelative:!1})).setColorScheme(n.getContinuousColorScheme(r)),t.on("change",function(e){o.trigger("change")})),s.html(t.$div)}else console.log(e+" not found.")};a.find("discrete").on("change",function(){i.getByName(e).getProperties().set(morpheus.VectorKeys.DISCRETE,$(this).prop("checked")),l(),o.trigger("change")}),this.$div=a.$form}},morpheus.Util.extend(morpheus.ColorSchemeChooser,morpheus.Events),morpheus.ColumnDendrogram=function(e,t,r,n){morpheus.AbstractDendrogram.call(this,e,t,r,n,morpheus.AbstractDendrogram.Type.COLUMN)},morpheus.ColumnDendrogram.prototype={drawNode:function(e,t){this.getNodeRadius(t);var r=this.toPix(t);e.beginPath(),e.arc(r[0],r[1],4,2*Math.PI,!1),e.fill()},isDragHotSpot:function(e){return Math.abs(this.scale(this.cutHeight)-e.y)<=2},drawCutSlider:function(e,t){t.setLineDash&&t.setLineDash([5]),t.strokeStyle="black";var r=this.scale(this.cutHeight);t.beginPath(),t.moveTo(e.x,r),t.lineTo(this.getUnscaledWidth(),r),t.stroke(),t.setLineDash&&t.setLineDash([])},createScale:function(){return d3.scale.linear().domain([this.tree.maxHeight,0]).range([0,this.getUnscaledHeight()])},paintMouseOver:function(e,t){-1!==this.project.getHoverColumnIndex()&&(morpheus.CanvasUtil.resetTransform(t),t.translate(-e.x,0),this.drawColumnBorder(t,this.positions,this.project.getHoverColumnIndex(),this.getUnscaledWidth()))},drawColumnBorder:function(e,t,r,n){var i=t.getItemSize(r),o=t.getPosition(r);e.beginPath(),e.moveTo(o+i,0),e.lineTo(o+i,n),e.stroke(),e.beginPath(),e.moveTo(o,0),e.lineTo(o,n),e.stroke()},getMaxIndex:function(e){return morpheus.Positions.getRight(e,this.positions)},getMinIndex:function(e){return morpheus.Positions.getLeft(e,this.positions)},getPreferredSize:function(e){return{width:Math.ceil(this.positions.getPosition(this.positions.getLength()-1)+this.positions.getItemSize(this.positions.getLength()-1)),height:100}},toPix:function(e){return[(this.positions.getPosition(e.minIndex)+this.positions.getItemSize(e.minIndex)/2+(this.positions.getPosition(e.maxIndex)+this.positions.getItemSize(e.maxIndex)/2))/2,this.scale(e.height)]},drawPathFromNodeToParent:function(e,t){var r=this.toPix(t),n=this.toPix(t.parent);e.beginPath(),e.moveTo(r[0],r[1]),e.lineTo(r[0],n[1]),e.lineTo(n[0],n[1]),e.stroke()},drawNodePath:function(e,t,r,n){var i,o,a=t.children,s=a[0],l=a[1],u=this.scale(t.height),c=this.toPix(l)[0],h=this.scale(l.height),p=this.toPix(s)[0],d=this.scale(s.height);if(this.drawLeafNodes)i=[c,c,p,p],o=[h,u,u,d];else{var f=void 0!==s.children,m=void 0!==l.children;f&&(d=u+4),m&&(h=u+4),i=[c,c,p,p],o=[h,u,u,d]}e.beginPath(),e.moveTo(i[0],o[0]);for(var g=1,v=i.length;g<v;g++)e.lineTo(i[g],o[g]);e.stroke()}},morpheus.Util.extend(morpheus.ColumnDendrogram,morpheus.AbstractDendrogram),morpheus.ConditionalRenderingUI=function(e){var t=this;this.heatmap=e;var r=$('<div class="container-fluid" style="min-width:180px;"></div>');r.on("click","[data-name=add]",function(r){var n=$(this).closest(".morpheus-entry"),i=n.index(),o={seriesName:null,color:"rgb(0,0,0)",shape:null,inheritColor:!0,accept:function(e){return!1}};e.heatmap.getColorScheme().getConditions().insert(i,o),n.after(t.add(o)),r.preventDefault()}),r.on("click","[data-name=delete]",function(t){var r=$(this).closest(".morpheus-entry"),n=r.index()-1;e.heatmap.getColorScheme().getConditions().remove(n),e.revalidate(),r.remove(),t.preventDefault()});var n=[];n.push('<div class="morpheus-entry">'),n.push('<div class="row">'),n.push('<div style="padding-bottom:20px;" class="col-xs-8"><a class="btn btn-default btn-xs" role="button" data-name="add" href="#">Add Condition</a></div>'),n.push("</div>"),n.push("</div>"),r.append(n.join("")),this.$div=r,e.heatmap.getColorScheme().getConditions().getConditions().forEach(function(e){t.add(e).appendTo(r)})},morpheus.ConditionalRenderingUI.prototype={add:function(e){var t=this,r=[];r.push('<div style="border-top:1px solid LightGrey;padding-bottom:6px;padding-top:6px;" class="morpheus-entry">'),r.push('<form class="form-horizontal">'),r.push('<div class="form-group">'),r.push('<label class="col-xs-2">Series</label>'),r.push('<div class="col-xs-6">'),r.push('<select class="form-control morpheus-form-control-inline" name="cond_series">'),r.push(morpheus.Util.createOptions(morpheus.DatasetUtil.getSeriesNames(this.heatmap.getProject().getFullDataset()))),r.push("</select>"),r.push("</div>"),r.push("</div>"),r.push('<div class="form-group">'),r.push('<label class="col-xs-2">Condition</label>'),r.push('<div class="col-xs-6">'),r.push('<select class="form-control morpheus-form-control-inline" name="lower"><option value="gte">&gt;=</option><option value="gt">&gt;</option></select>'),r.push('<input class="form-control morpheus-form-control-inline" name="v1" size="5" type="text">'),r.push('<span style="margin-right:1em;">and</span>'),r.push('<select class="form-control morpheus-form-control-inline" name="upper"><option value="lte">&lt;=</option><option value="lt">&lt;</option></select>'),r.push('<input class="form-control morpheus-form-control-inline" name="v2" size="5" type="text">'),r.push("</div>"),r.push("</div>"),r.push('<div class="form-group">'),r.push('<label class="col-xs-2">Shape</label>');var n=new morpheus.ShapeField({shapes:morpheus.VectorShapeModel.FILLED_SHAPES,showNone:!1});r.push('<div class="col-xs-4">'),r.push('<div style="display:inline;" data-name="shapeHolder"></div>'),r.push("</div>"),r.push("</div>"),r.push('<div class="form-group">'),r.push('<label class="col-xs-offset-2 col-xs-4"><input name="inherit_color" type="checkbox" checked> Inherit color</label>'),r.push("</div>"),r.push('<div class="form-group">'),r.push('<label class="col-xs-2">Color</label>'),r.push('<div class="col-xs-4">'),r.push('<input class="form-control" type="color" name="color" style="display:inline; width:6em;" disabled>'),r.push("</div>"),r.push("</div>"),r.push('<div class="row"><div class="col-xs-11">'),r.push('<a class="btn btn-default btn-xs" role="button" data-name="delete" href="#">Delete Condition</a>'),r.push("</div></div>"),r.push("</div>");var i=$(r.join(""));console.log(i.find("form").length),i.find("form").on("submit",function(e){e.preventDefault()}),n.$el.appendTo(i.find("[data-name=shapeHolder]"));var o=i.find("[name=color]"),a=i.find("[name=cond_series]"),s=i.find("[name=v1]"),l=i.find("[name=v2]"),u=i.find("[name=lower]"),c=i.find("[name=upper]"),h=i.find("[name=inherit_color]");function p(){var r=parseFloat($(s).val()),n=parseFloat($(l).val()),i=u.val(),o=c.val();e.v1=r,e.v2=n,e.v1Op=i,e.v2Op=o;var a=function(){return!0},h=function(){return!0};isNaN(r)||(a="gt"===i?function(e){return e>r}:function(e){return e>=r}),isNaN(n)||(h="lt"===o?function(e){return e<n}:function(e){return e<=n}),e.accept=function(e){return a(e)&&h(e)},t.heatmap.revalidate()}return o.prop("disabled",e.inheritColor),o.val(e.color),a.val(e.seriesName),n.setShapeValue(e.shape),null==e.v1||isNaN(e.v1)||s.val(e.v1),null==e.v2||isNaN(e.v2)||l.val(e.v2),u.val(e.v1Op),c.val(e.v2Op),u.on("change",function(e){p()}),c.on("change",function(e){p()}),s.on("keyup",_.debounce(function(e){p()},100)),l.on("keyup",_.debounce(function(e){p()},100)),h.on("click",function(r){e.inheritColor=$(this).prop("checked"),o.prop("disabled",e.inheritColor),t.heatmap.revalidate()}),o.on("change",function(r){e.color=$(this).val(),t.heatmap.revalidate()}),n.on("change",function(r){e.shape=r.shape,t.heatmap.revalidate()}),a.on("change",function(r){e.seriesName=$(this).val(),t.heatmap.revalidate()}),e.seriesName=a.val(),i}},morpheus.DendrogramUtil={},morpheus.DendrogramUtil.setIndices=function(e,t){t=t||0;var r=function(e,t){var n,i=e.children;if(i&&(n=i.length))for(var o=-1;++o<n;)r(i[o],t);t(e)};r(e,function(e){return void 0===e.children?(e.minIndex=t,e.maxIndex=t,e.index=t,t++):function(e){for(var t=e.children,r=t[0].maxIndex,n=t[0].minIndex,i=t[0].index,o=1,a=t.length;o<a;o++){var s=t[o];i+=s.index,n=Math.min(n,s.minIndex),r=Math.max(r,s.maxIndex)}e.minIndex=n,e.maxIndex=r,e.index=i/t.length,e.children.sort(function(e,t){return e.index===t.index?0:e.index<t.index?-1:1})}(e),!0})},morpheus.DendrogramUtil.convertEdgeLengthsToHeights=function(e){var t=0;!function e(r,n){var i=n;void 0!==r.length&&(i+=r.length),r.height=i,t=Math.max(t,r.height),null!=r.children&&r.children.forEach(function(t){e(t,i)})}(e,0);var r=0;return morpheus.DendrogramUtil.dfs(e,function(e){return e.id=r,r++,e.height=t-e.height,!0}),{maxHeight:t,n:r}},morpheus.DendrogramUtil.writeNewick=function(e,t,r){if(null!=e.children&&e.children.length>0){t.push("(");for(var n=0;n<e.children.length;n++)n>0&&t.push(","),morpheus.DendrogramUtil.writeNewick(e.children[n],t,r);t.push(")")}t.push(null!=e.index?r(e):""),t.push(":");var i=e.parent?e.parent.height:e.height;t.push(i-e.height)},morpheus.DendrogramUtil.parseNewick=function(e){var t=Newick.parse(e),r=0,n=[];return function e(t){var i=t.children;if(void 0!==i){var o=i[0],a=i[1];o.parent=t,a.parent=t,e(o),e(a)}else t.minIndex=r,t.maxIndex=r,t.index=r,n.push(t),r++}(t),morpheus.DendrogramUtil.convertEdgeLengthsToHeights(t).maxHeight,morpheus.DendrogramUtil.setNodeDepths(t),morpheus.DendrogramUtil.setIndices(t),{maxHeight:t.height,rootNode:t,leafNodes:n,nLeafNodes:n.length}},morpheus.DendrogramUtil.cutAtHeight=function(e,t){var r=[];return morpheus.DendrogramUtil.dfs(e,function(e){return!(e.height<t&&(r.push(e),1))}),r.sort(function(e,t){return e.index<t.index?-1:e.index==t.index?0:1}),r},morpheus.DendrogramUtil.getDeepestChild=function(e,t){for(;;){if(void 0===e.children)return e;var r;r=t?e.children[0].index<e.children[e.children.length-1].index?0:e.children.length-1:e.children[0].index>e.children[e.children.length-1].index?0:e.children.length-1,e=e.children[r]}},morpheus.DendrogramUtil.dfs=function(e,t,r){if(void 0===r&&(r=function(e){return e.children}),t(e)){var n,i=r(e);if(i&&(n=i.length))for(var o=-1;++o<n;)morpheus.DendrogramUtil.dfs(i[o],t,r)}},morpheus.DendrogramUtil.copyTree=function(e){var t=0,r=$.extend({},e.rootNode);return r.parent=void 0,function e(r){var n=r.children;if(void 0!==n){for(var i=[],o=0,a=n.length;o<a;o++){var s=$.extend({},n[o]);s.parent=r,i.push(s)}for(r.children=i,o=0,a=i.length;o<a;o++)e(i[o])}else r.index=t,r.minIndex=t,r.maxIndex=t,t++}(r),{nLeafNodes:e.nLeafNodes,maxDepth:e.maxDepth,rootNode:r}},morpheus.DendrogramUtil.collapseAtDepth=function(e,t){morpheus.DendrogramUtil.dfs(e,function(e){return e.collapsedChildren&&(e.children=e.collapsedChildren,e.collapsedChildren=void 0),!0}),morpheus.DendrogramUtil.dfs(e,function(e){return!(e.depth>t&&(e.collapsedChildren=e.children,e.children=void 0,1))})},morpheus.DendrogramUtil.setNodeDepths=function(e){var t=0;return function e(r,n){var i=r.children;if(r.depth=n,t=Math.max(n,t),void 0!==i)for(var o=-1,a=n+1,s=i.length;++o<s;)e(i[o],a);return r}(e,0),t},morpheus.DendrogramUtil.sortDendrogram=function(e,t,r,n){n=n||function(e){for(var t=Number.MAX_VALUE,r=0;r<e.length;r++)t=Math.min(t,e[r].weight);return t};var i=function(e){if(void 0!==e.children){for(var r=e.children,o=0;o<r.length;o++)i(r[o]);e.weight=n(r)}else e.weight=t.getValue(e.index)};i(e);var o={},a=morpheus.DendrogramUtil.getLeafNodes(e);_.each(a,function(e){o[e.id]=r.convertViewColumnIndexToModel(e.index)}),morpheus.DendrogramUtil.dfs(e,function(e){return e.children&&e.children.sort(function(e,t){return e.weight===t.weight?0:e.weight<t.weight?-1:1}),!0}),morpheus.DendrogramUtil.setIndices(e);var s=[];return _.each(a,function(e){var t=o[e.id],r=e.index;s[r]=t}),s},morpheus.DendrogramUtil.leastCommonAncestor=function(e){function t(e){for(var t=new morpheus.Map;null!=e;)t.set(e.id,e),e=e.parent;return t}for(var r=t(e[0]),n=1;n<e.length;n++){var i=t(e[n]);r.forEach(function(e,t){i.has(t)||r.remove(t)})}var o,a=-Number.MAX_VALUE;return r.forEach(function(e,t){e.depth>a&&(a=e.depth,o=e)}),o},morpheus.DendrogramUtil.search=function(e){var t,r=e.text,n=e.rootNode,i=morpheus.Util.getAutocompleteTokens(r),o=0,a=!0===e.matchAllPredicates;if(null==i||0==i.length)morpheus.DendrogramUtil.dfs(n,function(e){return e.search=!1,!0}),o=-1;else{var s=(t=morpheus.Util.createSearchPredicates({tokens:i,defaultMatchMode:e.defaultMatchMode})).length;morpheus.DendrogramUtil.dfs(n,function(e){var r=!1;if(e.info)e:if(a){for(r=!0,i=0;i<s;i++)if(null!=(u=(l=t[i]).getField())){for(c=0,h=(p=e.info[u]).length;c<h;c++)if(!l.accept(p[c])){r=!1;break e}}else for(var n in e.info)for(c=0,h=(p=e.info[n]).length;c<h;c++)if(!l.accept(p[c])){r=!1;break e}}else for(var i=0;i<s;i++){var l,u;if(null!=(u=(l=t[i]).getField())){for(var c=0,h=(p=e.info[u]).length;c<h;c++)if(l.accept(p[c])){r=!0;break e}}else for(var n in e.info){var p;for(c=0,h=(p=e.info[n]).length;c<h;c++)if(l.accept(p[c])){r=!0;break e}}}return e.search=r,r&&o++,!0})}return o},morpheus.DendrogramUtil.squishNonSearchedNodes=function(e,t){t?e.getHeatMapElementComponent().getColumnPositions().setSize(13):e.getHeatMapElementComponent().getRowPositions().setSize(13);var r={},n=t?e.columnDendrogram:e.rowDendrogram;morpheus.DendrogramUtil.dfs(n.tree.rootNode,function(e){for(var t=e.minIndex;t<=e.maxIndex;t++)e.search&&(r[t]=!0);return!0});var i=[],o=r[0],a={};o||(a[0]=!0);var s=0;i.push(s);for(var l=1,u=n.tree.leafNodes.length;l<u;l++){var c=r[l];c!==o&&(s++,o=c),c||(a[l]=!0),i.push(s)}t?(e.getHeatMapElementComponent().getColumnPositions().setSquishedIndices(a),e.getProject().setGroupColumns([new morpheus.SpecifiedGroupByKey(i)],!1)):(e.getHeatMapElementComponent().getRowPositions().setSquishedIndices(a),e.getProject().setGroupRows([new morpheus.SpecifiedGroupByKey(i)],!1))},morpheus.DendrogramUtil.getLeafNodes=function(e){var t=[];return morpheus.DendrogramUtil.dfs(e,function(e){return void 0===e.children&&t.push(e),!0}),t},morpheus.DialogUtil=function(){},morpheus.DialogUtil.DIALOGS=[],morpheus.DialogUtil.add=function(e){morpheus.DialogUtil.DIALOGS.push(e)},morpheus.DialogUtil.remove=function(e){for(var t=!1,r=0,n=morpheus.DialogUtil.DIALOGS.length;r<n;r++)if(e===morpheus.DialogUtil.DIALOGS[r]){morpheus.DialogUtil.DIALOGS.splice(r,1),t=!0;break}t||console.log("Dialog not found.")},morpheus.DialogUtil.clear=function(){morpheus.DialogUtil.DIALOGS.forEach(function(e){e.remove()}),morpheus.DialogUtil.DIALOGS=[]},morpheus.DiscreteColorSchemeChooser=function(e){var t=new morpheus.FormBuilder,r=e.colorScheme.scale;t.append({name:"selected_value",type:"bootstrap-select",options:r.keys()});var n=t.find("selected_value");t.append({style:"max-width:50px;",name:"selected_color",type:"color"});var i=n.val(),o=this,a=t.find("selected_color");a.val(r.get(i)),a.on("change",function(e){var t=$(this).val();r.set(i,t),o.trigger("change",{value:i,color:t})}),n.on("change",function(){i=n.val();var e=r.get(i);a.val(e)}),this.$div=t.$form},morpheus.DiscreteColorSchemeChooser.prototype={},morpheus.Util.extend(morpheus.DiscreteColorSchemeChooser,morpheus.Events),morpheus.DiscreteColorSupplier=function(){this.colorMap=new morpheus.Map,this.hiddenValue=0,this.hiddenValues=new morpheus.Set,morpheus.AbstractColorSupplier.call(this),this.scalingMode=morpheus.HeatMapColorScheme.ScalingMode.FIXED},morpheus.DiscreteColorSupplier.prototype={createInstance:function(){return new morpheus.DiscreteColorSupplier},setColorMap:function(e){this.colorMap=new morpheus.Map,this.colors=[],this.fractions=[],this.names=[],this.min=Number.MAX_VALUE,this.max=-Number.MAX_VALUE;for(var t=0;t<e.length;t++)this.colorMap.set(e[t].value,e[t].color),this.fractions.push(e[t].value),this.names.push(e[t].name),this.colors.push(e[t].color),this.min=Math.min(this.min,e[t].value),this.max=Math.max(this.max,e[t].value)},copy:function(){var e=this.createInstance();return e.names=this.names.slice(0),e.colorMap=new morpheus.Map,this.colorMap.forEach(function(t,r){e.colorMap.set(r,t)}),e.colors=this.colors.slice(0),e.fractions=this.fractions.slice(0),this.hiddenValues.forEach(function(t){e.hiddenValues.add(t)}),e.missingColor=this.missingColor,e},isStepped:function(){return!0},getColor:function(e,t,r){return this.hiddenValues.has(r)&&(r=this.hiddenValue),isNaN(r)?this.missingColor:this.colorMap.get(r)}},morpheus.Util.extend(morpheus.DiscreteColorSupplier,morpheus.AbstractColorSupplier),morpheus.Divider=function(e){morpheus.AbstractCanvas.call(this,!1),this.vertical=e;var t=this,r=this.canvas;r.style.cursor=e?"ew-resize":"ns-resize",e?this.setBounds({height:15,width:4}):this.setBounds({height:4,width:15}),this.hammer=morpheus.Util.hammer(r,["pan"]).on("panstart",this.panstart=function(e){t.trigger("resizeStart"),morpheus.CanvasUtil.dragging=!0}).on("panmove",this.panmove=function(e){t.vertical?t.trigger("resize",{delta:e.deltaX}):t.trigger("resize",{delta:e.deltaY})}).on("panend",this.panend=function(e){morpheus.CanvasUtil.dragging=!1,t.trigger("resizeEnd")}),this.paint()},morpheus.Divider.prototype={dispose:function(){morpheus.AbstractCanvas.prototype.dispose.call(this),this.hammer.off("panstart",this.panstart).off("panmove",this.panmove).off("panend",this.panend),this.hammer.destroy()},getPreferredSize:function(){return{width:3,height:this.getUnscaledHeight()}},draw:function(e,t){var r=this.getUnscaledWidth(),n=this.getUnscaledHeight();t.clearRect(0,0,r,n),t.strokeStyle="#ddd",this.vertical?(t.beginPath(),t.moveTo(0,0),t.lineTo(0,n),t.stroke()):(t.beginPath(),t.moveTo(0,1.5),t.lineTo(r,1.5),t.stroke())}},morpheus.Util.extend(morpheus.Divider,morpheus.AbstractCanvas),morpheus.Util.extend(morpheus.Divider,morpheus.Events),morpheus.DualList=function(e,t){var r=[];r.push('<div class="container-fluid">'),r.push('<div class="row">'),r.push('<div class="col-xs-4"><label>Available Fields</label></div>'),r.push('<div class="col-xs-2"></div>'),r.push('<div class="col-xs-4"><label>Selected Fields</label></div>'),r.push("</div>"),r.push('<div class="row">'),r.push('<div class="col-xs-4"><select class="form-control" name="left" multiple></select></div>'),r.push('<div class="col-xs-2"><div class="btn-group-vertical" role="group"><button name="add" type="button" class="btn btn-xs btn-default">Add</button><button name="remove" type="button" class="btn btn-xs btn-default">Remove</button><button name="up" type="button" class="btn btn-xs btn-default">Move Up</button><button name="down" type="button" class="btn btn-xs btn-default">Move Down</button></div></div>'),r.push('<div class="col-xs-4"><select class="form-control" name="right" multiple></select></div>'),r.push("</div>"),r.push("</div>"),this.$el=$(r.join(""));var n=this;this.$el.find("[name=add]").on("click",function(){n.addSelected()}),this.$el.find("[name=remove]").on("click",function(){n.removeSelected()}),this.$el.find("[name=up]").on("click",function(){n.moveUp()}),this.$el.find("[name=down]").on("click",function(){n.moveDown()}),this.left=this.$el.find("[name=left]")[0],this.right=this.$el.find("[name=right]")[0];for(var i=0;i<e.length;i++)this.left.options[i]=e[i];for(i=0;i<t.length;i++)this.right.options[i]=t[i]},morpheus.DualList.prototype={addSelected:function(){for(var e=this.left,t=this.right,r=0;r<e.options.length;r++)if(e.options[r].selected){var n=e.options[r];t.options[t.options.length]=new Option(n.innerHTML,n.value),e.options[r]=null,r--}},addAll:function(){for(var e=this.left,t=this.right,r=0;r<e.options.length;r++){var n=e.options[r];t.options[t.options.length]=new Option(n.innerHTML,n.value)}e.options.length=0},removeSelected:function(){for(var e=this.left,t=this.right,r=0;r<t.options.length;r++)if(t.options[r].selected){var n=t.options[r];e.options[e.options.length]=new Option(n.innerHTML,n.value),t.options[r]=null,r--}},getOptions:function(e){for(var t=e?this.left:this.right,r=[],n=0;n<t.options.length;n++)r.push(t.options[n].value);return r},removeAll:function(){for(var e=this.left,t=this.right,r=0;r<t.options.length;r++){var n=t.options[r];e.options[e.options.length]=new Option(n.innerHTML,n.value)}t.options.length=0},moveUp:function(){for(var e=this.right,t=e.selectedOptions,r=[],n=0;n<t.length;n++)r.push(t[n].index);var i=morpheus.Util.indexSort(r,!1);for(n=0;n<t.length;n++){var o=t[i[n]].index,a=e.options[o].innerHTML,s=e.options[o].value,l=e.options[o-1].innerHTML,u=e.options[o-1].value;e.options[o]=new Option(l,u),e.options[o-1]=new Option(a,s),e.options.selectedIndex=o-1}},moveDown:function(){for(var e=this.right,t=e.selectedOptions,r=[],n=0;n<t.length;n++)r.push(t[n].index);var i=morpheus.Util.indexSort(r,!1);for(n=0;n<t.length;n++){var o=t[i[n]].index,a=e.options[o].innerHTML,s=e.options[o].value,l=e.options[o+1].innerHTML,u=e.options[o+1].value;e.options[o]=new Option(l,u),e.options[o+1]=new Option(a,s),e.options.selectedIndex=o+1}}},morpheus.FilePicker=function(e){var t=[];t.push("<div>");var r=_.uniqueId("morpheus"),n=_.uniqueId("morpheus"),i=_.uniqueId("morpheus"),o=_.uniqueId("morpheus"),a=_.uniqueId("morpheus");t.push('<ul style="margin-bottom:10px;" class="nav nav-pills morpheus">'),t.push('<li role="presentation" class="active"><a href="#'+r+'" aria-controls="'+r+'" role="tab" data-toggle="tab"><i class="fa fa-desktop"></i> My Computer</a></li>'),t.push('<li role="presentation"><a href="#'+n+'" aria-controls="'+n+'" role="tab" data-toggle="tav"><i class="fa fa-link"></i> URL</a></li>'),"undefined"!=typeof gapi&&t.push('<li role="presentation"><a href="#'+i+'" aria-controls="'+i+'" role="tab" data-toggle="tab"><i class="fa fa-google"></i> Google</a></li>'),"undefined"!=typeof Dropbox&&t.push('<li role="presentation"><a href="#'+o+'" aria-controls="'+o+'" role="tab" data-toggle="tab"><i class="fa fa-dropbox"></i> Dropbox</a></li>');var s=$('<div class="morpheus-preloaded"></div>');t.push('<li role="presentation"><a href="#'+a+'" aria-controls="'+a+'" role="tab" data-toggle="tab"><i class="fa fa-database"></i> Preloaded Datasets</a></li>'),new morpheus.SampleDatasets({$el:s,show:!0,callback:function(t){e.optionsCallback(t)}}),t.push("</ul>"),t.push('<div class="tab-content" style="text-align:center;cursor:pointer;height:300px;">'),t.push('<div role="tabpanel" class="tab-pane active" id="'+r+'">'),t.push('<div data-name="drop" class="morpheus-file-drop morpheus-landing-panel">'),t.push('<button class="btn btn-default"><span class="fa-stack"><i class="fa fa-file-o fa-stack-2x"></i> <i class="fa fa-plus fa-stack-1x"></i></span> Select File</button> <div style="padding-top:10px;">or Copy and Paste Clipboard Data, <span class="morpheus-drag-text">Drag and Drop</span></div>'),t.push('<input name="hiddenFile" style="display:none;" type="file">'),t.push("</div>"),t.push("</div>"),t.push('<div role="tabpanel" class="tab-pane" id="'+n+'">'),t.push('<div class="morpheus-landing-panel">'),t.push('<input name="url" placeholder="Enter a URL" class="form-control" style="display:inline;max-width:400px; type="text"><button name="openUrl" class="btn btn-default" type="button">Go</button>'),t.push("</div>"),t.push("</div>"),"undefined"!=typeof Dropbox&&(t.push('<div role="tabpanel" class="tab-pane" id="'+o+'">'),t.push('<div class="morpheus-landing-panel">'),t.push('<button name="dropbox" class="btn btn-default">Browse Dropbox</button>'),t.push("</div>"),t.push("</div>")),"undefined"!=typeof gapi&&(t.push('<div role="tabpanel" class="tab-pane" id="'+i+'">'),t.push('<div class="morpheus-landing-panel">'),t.push('<button name="google" class="btn btn-default">Browse Google Drive</button>'),t.push("</div>"),t.push("</div>")),t.push('<div role="tabpanel" class="tab-pane" id="'+a+'">'),t.push('<div style="height:300px;overflow: auto;" class="morpheus-landing-panel">'),t.push("</div>"),t.push("</div>"),t.push("</div>"),t.push("</div>");var l=$(t.join(""));s.appendTo(l.find("#"+a+" > .morpheus-landing-panel")),this.$el=l;var u=l.find("[name=hiddenFile]"),c=l.find("[id="+r+"]");this.$el.find(".nav").on("click","li > a",function(e){e.preventDefault(),$(this).tab("show")});var h=l.find("[name=url]");h.on("keyup",function(t){if(13===t.which){var r=$.trim($(this).val());""!==r&&e.fileCallback([r])}}),l.find("[name=openUrl]").on("click",function(t){var r=$.trim(h.val());""!==r&&e.fileCallback([r])}),l.find("[name=dropbox]").on("click",function(t){Dropbox.choose({success:function(t){var r=t[0].link;e.fileCallback([r])},linkType:"direct",multiselect:!1})}),l.find("[name=google]").on("click",function(){var t,r="AIzaSyBCRqn5xgdUsJZcC6oJnIInQubaaL3aYvI",n="936482190815-85k6k06b98ihv272n0b7f7fm33v5mmfa.apps.googleusercontent.com",i=["https://www.googleapis.com/auth/drive"],o=!1;function a(e){e&&!e.error&&(t=e.access_token,s())}function s(){o&&t&&((new google.picker.PickerBuilder).addView(google.picker.ViewId.DOCS).setOAuthToken(t).setDeveloperKey(r).setCallback(l).build().setVisible(!0),$(".picker-dialog-bg").css("z-index",1052),$(".picker-dialog").css("z-index",1053))}function l(t){if(t.action==google.picker.Action.PICKED){var r=t.docs[0],n=r.name,i=gapi.auth.getToken().access_token,o=(new XMLHttpRequest,new String("https://www.googleapis.com/drive/v3/files/"+r.id+"?alt=media"));o.name=n,o.headers={Authorization:"Bearer "+i},e.fileCallback([o])}}gapi.load("auth",{callback:function(){window.gapi.auth.authorize({client_id:n,scope:i,immediate:!1},a)}}),gapi.load("picker",{callback:function(){o=!0,s()}})}),u.on("change",function(t){for(var r=t.target.files,n=0;n<r.length;n++)e.fileCallback([r[n]])}),$(window).on("paste.morpheus",this.paste=function(t){if(c.is(":visible")){var r=t.originalEvent.clipboardData.getData("text/plain");if(null!=r&&r.length>0){var n;if(t.preventDefault(),t.stopPropagation(),0===r.indexOf("http"))n=r;else{var i=new Blob([r]);(n=new String(window.URL.createObjectURL(i))).name="clipboard"}e.fileCallback([n])}}});var p=l.find("[data-name=drop]"),d=this;l.on("remove",function(){$(window).off(d.paste).off(d.dragover).off(d.dragenter).off(d.dragleave).off(d.drop)});var f=!1;p.on("click",function(e){f||(f=!0,u.click(),f=!1)}),$(window).on("dragover",this.dragover=function(e){c.is(":visible")&&(p.addClass("drag"),e.preventDefault(),e.stopPropagation())}).on("dragenter",this.dragenter=function(e){c.is(":visible")&&(p.addClass("drag"),e.preventDefault(),e.stopPropagation())}).on("dragleave",this.dragleave=function(e){c.is(":visible")&&(p.removeClass("drag"),e.preventDefault(),e.stopPropagation())}).on("drop",this.drop=function(t){if(c.is(":visible")&&(p.removeClass("drag"),t.originalEvent.dataTransfer))if(t.originalEvent.dataTransfer.files.length){t.preventDefault(),t.stopPropagation();var r=!1,n=t.originalEvent.dataTransfer.files;if(3===n.length){for(var i=null,o=null,a=null,s=0;s<n.length;s++)"genes.tsv"===n[s].name?i=n[s]:"barcodes.tsv"===n[s].name?o=n[s]:"matrix.mtx"===n[s].name&&(a=n[s]);null!=a&&null!=i&&null!=o&&(e.fileCallback([a,i,o]),r=!0)}if(!r)for(s=0;s<n.length;s++)e.fileCallback([n[s]])}else{var l=t.originalEvent.dataTransfer.getData("URL");e.fileCallback([l]),t.preventDefault(),t.stopPropagation()}})},morpheus.FilterUI=function(e,t){var r=this;this.project=e,this.isColumns=t;var n=$('<div style="min-width:180px;"></div>');this.$div=n,n.append(this.addBase());var i=n.find("[name=filterMode]");i.on("change",function(n){var o=i.prop("checked");(t?e.getColumnFilter():e.getRowFilter()).setAnd(o),t?r.project.setColumnFilter(r.project.getColumnFilter(),!0):r.project.setRowFilter(r.project.getRowFilter(),!0),n.preventDefault()}),n.on("click","[data-name=add]",function(n){var i=$(this).closest(".morpheus-entry"),o=i.index(),a=new morpheus.AlwaysTrueFilter(t);(t?e.getColumnFilter():e.getRowFilter()).insert(o,a),i.after(r.add(a)),n.preventDefault()}),n.on("click","[data-name=delete]",function(n){var i=$(this).closest(".morpheus-entry"),o=i.index()-1;(t?e.getColumnFilter():e.getRowFilter()).remove(o),i.remove(),t?r.project.setColumnFilter(r.project.getColumnFilter(),!0):r.project.setRowFilter(r.project.getRowFilter(),!0),n.preventDefault()}),n.on("submit","form",function(e){$(this),e.preventDefault()}),n.on("change","[name=by]",function(n){var i=$(this),o=i.val(),a=i.closest(".morpheus-entry"),s=a.index()-1;(t?e.getColumnFilter():e.getRowFilter()).remove(s),""==o?a.find("[data-name=ui]").empty():r.createFilter({fieldName:o,$div:i}),t?r.project.setColumnFilter(r.project.getColumnFilter(),!0):r.project.setRowFilter(r.project.getRowFilter(),!0)});for(var o=t?e.getColumnFilter():e.getRowFilter(),a=o.getFilters?o.getFilters():[],s=0;s<a.length;s++)this.createFilter({filter:a[s]});o.on&&(o.on("add",function(e){r.createFilter({filter:e.filter})}),o.on("remove",function(e){n.find(".morpheus-entry")[1+e.index].remove()}),o.on("and",function(e){i.prop("checked",e.source.isAnd())}))},morpheus.FilterUI.rangeFilter=function(e,t,r,n,i){n.empty();var o=[];o.push("<label>Range of values</label><br />"),o.push('<label>>= </label> <input style="max-width:200px;" class="form-control input-sm" name="min" type="text" />'),o.push('<label> and <= </label> <input style="max-width:200px;" class="form-control input-sm" name="max" type="text" />'),o.push('<br /><a data-name="switch" href="#">Switch to top filter</a>'),$(o.join("")).appendTo(n),n.find("[data-name=switch]").on("click",function(o){o.preventDefault();for(var a=morpheus.FilterUI.topFilter(e,t,r,n),s=-1,l=r?e.getColumnFilter().getFilters():e.getRowFilter().getFilters(),u=0;u<l.length;u++)if(l[u]===i){s=u;break}if(-1===s)throw new Error("Filter not found.");(r?e.getColumnFilter():e.getRowFilter()).set(s,a),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)});var a=n.find("[name=min]"),s=n.find("[name=max]");return i?(a.val(i.min),s.val(i.max)):i=new morpheus.RangeFilter(-Number.MAX_VALUE,Number.MAX_VALUE,t,r),a.on("keyup",_.debounce(function(t){i.setMin(parseFloat($.trim($(this).val()))),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)},500)),s.on("keyup",_.debounce(function(t){i.setMax(parseFloat($.trim($(this).val()))),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)},500)),i},morpheus.FilterUI.topFilter=function(e,t,r,n,i){n.empty();var o=[];o.push("<label>Top</label><br />"),o.push('<select style="width:auto;" class="form-control input-sm" name="direction"><option value="Top">Top</option><option value="Bottom">Bottom</option><option value="TopBottom">Top/Bottom</option></select>'),o.push(' <label>N </label> <input style="max-width:200px;" class="form-control input-sm" name="n" type="text" />'),o.push('<br /><a data-name="switch" href="#">Switch to range filter</a>'),$(o.join("")).appendTo(n);var a,s=n.find("[name=n]"),l=n.find("[name=direction]");return n.find("[data-name=switch]").on("click",function(o){o.preventDefault();for(var a=morpheus.FilterUI.rangeFilter(e,t,r,n),s=-1,l=r?e.getColumnFilter().getFilters():e.getRowFilter().getFilters(),u=0;u<l.length;u++)if(l[u]===i){s=u;break}if(-1===s)throw new Error("Filter not found.");(r?e.getColumnFilter():e.getRowFilter()).set(s,a),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)}),i?(a=i.direction===morpheus.TopNFilter.TOP?"Top":i.direction===morpheus.TopNFilter.BOTTOM?"Bottom":"TopBottom",l.val(a),s.val(i.n)):i=new morpheus.TopNFilter(NaN,morpheus.TopNFilter.TOP,t,r),l.on("change",function(){var t,n=$(this).val();t="Top"===n?morpheus.TopNFilter.TOP:"Bottom"===n?morpheus.TopNFilter.BOTTOM:morpheus.TopNFilter.TOP_BOTTOM,i.setDirection(t),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)}),s.on("keyup",_.debounce(function(t){i.setN(parseInt($.trim($(this).val()))),r?e.setColumnFilter(e.getColumnFilter(),!0):e.setRowFilter(e.getRowFilter(),!0)},500)),i},morpheus.FilterUI.prototype={createFilter:function(e){var t,r=-1,n=e.$div,i=this.isColumns,o=e.filter,a=this.project,s=o?o.name:e.fieldName;if(n){var l=n.closest(".morpheus-entry");r=l.index()-1,t=l.find("[data-name=ui]")}else{var u=$(this.add(o));u.appendTo(this.$div),t=u.find("[data-name=ui]")}t.empty();var c=(i?this.project.getFullDataset().getColumnMetadata():this.project.getFullDataset().getRowMetadata()).getByName(s);if(o instanceof morpheus.RangeFilter)morpheus.FilterUI.rangeFilter(a,s,i,t,o);else if(o instanceof morpheus.TopNFilter)morpheus.FilterUI.topFilter(a,s,i,t,o);else if(null==o&&morpheus.VectorUtil.isNumber(c)&&morpheus.VectorUtil.containsMoreThanNValues(c,9))o=morpheus.FilterUI.rangeFilter(a,s,i,t,o);else{var h=morpheus.VectorUtil.getSet(c),p=h.values();p.sort(morpheus.SortKey.ASCENDING_COMPARATOR),o?o.maxSetSize=p.length:o=new morpheus.VectorFilter(new morpheus.Set,h.size(),s,i),new morpheus.CheckBoxList({responsive:!1,$el:t,items:p,set:o.set}).on("checkBoxSelectionChanged",function(){i?a.setColumnFilter(a.getColumnFilter(),!0):a.setRowFilter(a.getRowFilter(),!0)})}return-1!==r&&(""!==s?(i?a.getColumnFilter():a.getRowFilter()).set(r,o):(i?a.getColumnFilter():a.getRowFilter()).set(r,new morpheus.AlwaysTrueFilter(i))),o},addBase:function(){var e=[];return e.push('<div style="padding-bottom:2px;border-bottom:1px solid #eee" class="morpheus-entry">'),e.push('<div class="row">'),e.push('<div class="col-xs-12"><div class="checkbox"><label><input type="checkbox" name="filterMode">Pass all filters</label></div> </div>'),e.push("</div>"),e.push('<div class="row">'),e.push('<div class="col-xs-8"><a class="btn btn-default btn-xs" role="button" data-name="add" href="#">Add</a></div>'),e.push("</div>"),e.push("</div>"),e.join("")},add:function(e){var t=this.project,r=this.isColumns,n=morpheus.MetadataUtil.getMetadataNames(r?t.getFullDataset().getColumnMetadata():t.getFullDataset().getRowMetadata()),i=[];i.push('<div class="morpheus-entry">'),i.push('<div class="form-group">'),i.push("<label>Field</label>"),i.push('<select style="max-width:160px;overflow-x:hidden;" name="by" class="form-control input-sm">'),i.push('<option value=""></option>');var o=e?e.toString():null;return _.each(n,function(e){i.push('<option value="'+e+'"'),e===o&&i.push(" selected"),i.push(">"),i.push(e),i.push("</option>")}),i.push("</select>"),i.push("</div>"),i.push('<div class="row">'),i.push('<div data-name="ui" class="col-xs-12"></div>'),i.push("</div>"),i.push('<div style="padding-bottom:6px; border-bottom:1px solid #eee" class="row">'),i.push('<div class="col-xs-11">'),i.push('<a class="btn btn-default btn-xs" role="button" data-name="delete" href="#">Remove</a>'),i.push("</div>"),i.push("</div>"),i.push("</div>"),i.join("")}},morpheus.FontChooser=function(e){var t=e.fontModel,r=e.track,n=e.heatMap;t.getMappedValue(r.getVector(r.settings.fontField),r.getVector(r.settings.fontField).getValue(0));var i=new morpheus.FormBuilder;i.append({value:null!=r.settings.fontField,type:"checkbox",name:"use_another_annotation_to_determine_font"});var o=morpheus.MetadataUtil.getMetadataNames(r.isColumns?n.getProject().getFullDataset().getColumnMetadata():n.getProject().getFullDataset().getRowMetadata());o.splice(o.indexOf(r.getName()),1),i.append({name:"annotation_name",type:"bootstrap-select",options:o,search:o.length>10,value:r.settings.fontField}),i.setVisible("annotation_name",null!=r.settings.fontField),i.append({name:"selected_value",type:"bootstrap-select",search:!0,options:t.getMap(null!=r.settings.fontField?r.settings.fontField:r.getName()).keys()});var a=i.find("selected_value");i.append({name:"selected_font",type:"bootstrap-select",options:[{name:"normal",value:400},{name:"bold",value:700},{name:"bolder",value:900}]});var s=function(){r.setInvalid(!0),r.repaint()};i.find("use_another_annotation_to_determine_font").on("change",function(){var e=$(this).prop("checked");i.setValue("annotation_name",null),i.setValue("selected_value",null),i.setVisible("annotation_name",e),e||(r.settings.fontField=null),s()}),i.find("annotation_name").on("change",function(){var e=$(this).val();t.getMappedValue(r.getVector(e),r.getVector(e).getValue(0)),r.settings.fontField=e,i.setOptions("selected_value",t.getMap(null!=r.settings.fontField?r.settings.fontField:r.getName()).keys()),i.setValue("selected_value",null),s()}),i.find("selected_font").on("change",function(e){t.setMappedValue(r.getVector(r.settings.fontField),a.val(),{weight:$(this).val()}),s()});var l=function(){var e=a.val(),n=t.getMappedValue(r.getVector(r.settings.fontField),e);i.setValue("selected_font",n.weight)};a.on("change",function(){l()}),l(),this.$div=i.$form},morpheus.Util.extend(morpheus.FontChooser,morpheus.Events),morpheus.FormBuilder=function(e){var t=this;this.prefix=_.uniqueId("form"),this.$form=$("<form></form>"),this.$form.attr("role","form").attr("id",this.prefix),this.formStyle=null==e||null==e.formStyle?"horizontal":e.formStyle,this.$form.addClass("morpheus"),"horizontal"===this.formStyle?(this.titleClass="col-xs-12 control-label",this.labelClass="col-xs-4 control-label",this.$form.addClass("form-horizontal")):"vertical"===this.formStyle?(this.labelClass="control-label",this.titleClass="control-label"):"inline"===this.formStyle&&(this.titleClass="",this.labelClass="",this.$form.addClass("form-inline")),this.$form.on("submit",function(e){e.preventDefault()}),this.$form.on("dragover",function(e){var t=$(e.originalEvent.srcElement).parent().parent().prev();t.is("select")&&t.hasClass("file-input")&&($(e.originalEvent.srcElement).parent().css("border","1px solid black"),e.preventDefault(),e.stopPropagation())}).on("dragenter",function(e){var t=$(e.originalEvent.srcElement).parent().parent().prev();t.is("select")&&t.hasClass("file-input")&&($(e.originalEvent.srcElement).parent().css("border","1px solid black"),e.preventDefault(),e.stopPropagation())}).on("dragleave",function(e){var t=$(e.originalEvent.srcElement).parent().parent().prev();t.is("select")&&t.hasClass("file-input")&&($(e.originalEvent.srcElement).parent().css("border",""),e.preventDefault(),e.stopPropagation())}).on("drop",function(e){var r=$(e.originalEvent.srcElement).parent().parent().prev();if(r.is("select")&&r.hasClass("file-input")){var n=r.data("multiple");$(e.originalEvent.srcElement).parent().css("border","");var i=r.attr("name");if(i=i.substring(0,i.length-"_picker".length),e.originalEvent.dataTransfer)if(e.originalEvent.dataTransfer.files.length){e.preventDefault(),e.stopPropagation();var o=e.originalEvent.dataTransfer.files;t.setValue(i,n?o:o[0]),t.trigger("change",{name:i,value:o[0]})}else{var a=e.originalEvent.dataTransfer.getData("URL");e.preventDefault(),e.stopPropagation(),t.setValue(i,n?[a]:a),t.trigger("change",{name:i,value:a})}}})},morpheus.FormBuilder.showProgressBar=function(e){var t=[];t.push('<div class="container-fluid">'),t.push('<div class="row">'),t.push('<div class="col-xs-8">'),t.push('<div class="progress progress-striped active"><div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div></div>'),t.push("</div>"),t.push('<div class="col-xs-2">'),t.push('<input class="btn btn-default" type="button" name="stop" value="Cancel">'),t.push("</div>"),t.push("</div>"),e.subtitle&&(t.push('<div class="row"><div class="col-xs-8">'),t.push('<p class="text-muted">'),t.push(e.subtitle),t.push("</p>"),t.push("</div></div>")),t.push("</div>");var r=$(t.join(""));return r.find("[name=stop]").on("click",function(t){e.stop(),t.preventDefault()}),morpheus.FormBuilder.showInDraggableDiv({title:e.title,$content:r})},morpheus.FormBuilder.showInDraggableDiv=function(e){var t=e.width||"300px",r=[];r.push('<div style="z-index: 1050; top: 100px; position:absolute; padding-left:10px; padding-right:10px; width:'+t+' ; background:white; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.2); border-radius: 6px;">'),null!=e.title&&r.push('<h4 style="cursor:move; border-bottom: 1px solid #e5e5e5;" name="header">'+e.title+"</h4>"),r.push('<div name="content"></div>'),r.push("</div>");var n=$(r.join("")),i=n.find("[name=content]");return n.find("[name=header]").on("dblclick",function(){"none"===i.css("display")?i.css("display",""):i.css("display","none")}),e.$content.appendTo(i),n.css("left",$(window).width()/2-i.outerWidth()/2),n.draggable({containment:"document"}),n.appendTo(null!=e.appendTo?e.appendTo:$(document.body)),n},morpheus.FormBuilder.showMessageModal=function(e){var t=morpheus.FormBuilder._showInModal({modalClass:e.modalClass,title:e.title,html:e.html,footer:'<button type="button" class="btn btn-default" data-dismiss="modal">OK</button>',backdrop:e.backdrop,size:e.size,focus:e.focus,appendTo:e.appendTo});return t.find("button").focus(),t},morpheus.FormBuilder._showInModal=function(e){var t=[];e=$.extend({},{size:"",close:!0,modalClass:""},e),t.push('<div tabindex="-1" class="modal'+(e.modalClass?" "+e.modalClass:"")+'" role="dialog" aria-hidden="false"'),e.z&&t.push(' style="z-index: '+e.z+' !important;"'),t.push(">"),t.push('<div class="modal-dialog '+e.size+'">'),t.push('<div class="modal-content">'),t.push(' <div class="modal-header">'),e.close&&t.push('  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã</span></button>'),null!=e.title&&t.push('<h4 class="modal-title">'+e.title+"</h4>"),t.push("</div>"),t.push('<div class="modal-body">'),t.push("</div>"),e.footer&&(t.push('<div class="modal-footer">'),t.push(e.footer)),t.push("</div>"),t.push("</div>"),t.push("</div>"),t.push("</div>");var r=$(t.join(""));return r.on("mousewheel",function(e){e.stopPropagation()}),r.find(".modal-body").html(e.html),r.prependTo(null!=e.appendTo?e.appendTo:$(document.body)),r.modal({keyboard:!0,backdrop:!0===e.backdrop}).on("hidden.bs.modal",function(t){r.remove(),e.onClose&&e.onClose(),e.focus&&$(e.focus).focus()}),r},morpheus.FormBuilder.showInModal=function(e){var t=morpheus.FormBuilder._showInModal({modalClass:e.modalClass,title:e.title,html:e.html,footer:e.close?'<button type="button" class="btn btn-default" data-dismiss="modal">'+e.close+"</button>":null,onClose:e.onClose,appendTo:e.appendTo,backdrop:e.backdrop,size:e.size,focus:e.focus});e.draggable&&t.draggable({handle:t.find(".modal-header")})},morpheus.FormBuilder.showOkCancel=function(e){var t=[];(e=$.extend({},{ok:!0,cancel:!0},e)).ok&&t.push('<button name="ok" type="button" class="btn btn-default">OK</button>'),e.apply&&t.push('<button name="apply" type="button" class="btn btn-default">Apply</button>'),e.cancel&&t.push('<button name="cancel" type="button" data-dismiss="modal" class="btn btn-default">Cancel</button>');var r=morpheus.FormBuilder._showInModal({title:e.title,html:e.content,footer:t.join(""),size:e.size,close:e.close,onClose:e.onClose,focus:e.focus,appendTo:e.appendTo}),n=r.find("[name=ok]");return n.on("click",function(t){e.okCallback&&e.okCallback(),r.modal("hide")}),r.find("[name=cancel]").on("click",function(t){e.cancelCallback&&e.cancelCallback(),r.modal("hide")}),e.okFocus&&n.focus(),e.draggable&&r.draggable({handle:".modal-header",containment:"document"}),r},morpheus.FormBuilder.hasChanged=function(e,t){for(var r=_.keys(t),n=0;n<r.length;n++){var i=r[n],o=e[i],a=t[i];if(o!==morpheus.FormBuilder.getValue(a))return!0}return!1},morpheus.FormBuilder.getValue=function(e){var t=e.data("morpheus.checkbox-list");return null!=t?t.val():"radio"===e.attr("type")?e.filter(":checked").val():"file"===e.data("type")?e.data("files"):"checkbox"===e.attr("type")?e.prop("checked"):e.val()},morpheus.FormBuilder.prototype={appendContent:function(e){this.$form.append(e)},addSeparator:function(){var e=[];e.push('<div class="form-group">'),"horizontal"===this.formStyle&&e.push('<div class="col-xs-12">'),e.push("<hr />"),"horizontal"===this.formStyle&&e.push("</div>"),e.push("</div>"),this.$form.append(e.join(""))},_append:function(e,t,r){var n=this,i=t.required,o=t.name,a=t.type;if("separator"==a)return"horizontal"===this.formStyle?e.push('<div class="col-xs-12">'):e.push('<div class="form-group">'),e.push("<hr />"),void e.push("</div>");var s=t.title,l=t.disabled,u=t.help,c=t.value,h=t.showLabel,p=t.style||"",d="";"horizontal"===this.formStyle&&(d=t.col||"col-xs-8"),void 0===h&&(h=(h="checkbox"!==a&&"button"!==a&&"radio"!==a)||void 0!==t.options);var f=n.prefix+"_"+o;void 0===s&&(s=(s=o.replace(/_/g," "))[0].toUpperCase()+s.substring(1));var m=!1;if(h?(e.push('<label for="'+f+'" class="'+this.labelClass+'">'),e.push(s),e.push("</label>"),r&&"inline"!==this.formStyle&&(e.push('<div class="'+d+'">'),m=!0)):r&&"horizontal"===this.formStyle&&(e.push('<div class="col-xs-offset-4 '+d+'">'),m=!0),"radio"===a)t.options?_.each(t.options,function(r){var n=_.isObject(r)&&void 0!==r.value,i=n?r.value:r,o=n?r.name:r,a=c===i;e.push('<div class="radio"><label>'),e.push('<input style="'+p+'" value="'+i+'" name="'+t.name+'" type="radio"'),a&&e.push(" checked"),e.push("> "),r.icon&&e.push('<span class="'+r.icon+'"></span> '),o=o[0].toUpperCase()+o.substring(1),e.push(o),e.push("</label></div>")}):(e.push('<div class="radio"><label>'),e.push('<input style="'+p+'" value="'+c+'" name="'+o+'" id="'+f+'" type="radio"'),t.checked&&e.push(" checked"),e.push("> "),e.push(c[0].toUpperCase()+c.substring(1)),e.push("</label></div>"));else if("checkbox"===a)e.push('<div class="checkbox"><label>'),e.push('<input style="'+p+'" name="'+o+'" id="'+f+'" type="checkbox"'),c&&e.push(" checked"),l&&e.push(" disabled"),e.push("> "),e.push(s),e.push("</label></div>");else if("checkbox-list"===a)e.push('<div name="'+o+'" class="checkbox-list"><div>');else if("select"==a||"bootstrap-select"==a)"bootstrap-select"==a?e.push('<select style="'+p+'" data-live-search="'+!!t.search+'" data-selected-text-format="count" name="'+o+'" id="'+f+'" data-actions-box="'+!!t.selectAll+'" class="selectpicker'+("inline"!==this.formStyle?" form-control":"")+'"'):e.push('<select style="'+p+'" name="'+o+'" id="'+f+'" class="form-control"'),l&&e.push(" disabled"),t.multiple&&e.push(" multiple"),e.push(">"),_.each(t.options,function(t){if(t&&t.divider)e.push('<option data-divider="true"></option>');else{e.push('<option value="');var r=_.isObject(t)&&void 0!==t.value,n=r?t.value:t,i=r?t.name:t;e.push(n),e.push('"'),(_.isObject(c)?c[n]:_.isArray(c)?-1!==c.indexOf(n):c==n)&&e.push(" selected"),e.push(">"),e.push(i),e.push("</option>")}}),e.push("</select>"),"bootstrap-select"==t.type&&t.toggle&&(e.push('<p class="help-block"><a data-name="'+o+'_all" href="#">All</a>&nbsp;|&nbsp;<a data-name="'+o+'_none" href="#">None</a></p>'),n.$form.on("click","[data-name="+o+"_all]",function(e){e.preventDefault();var t=n.$form.find("[name="+o+"]");t.selectpicker("val",$.map(t.find("option"),function(e){return $(e).val()})),t.trigger("change")}),n.$form.on("click","[data-name="+o+"_none]",function(e){e.preventDefault();var t=n.$form.find("[name="+o+"]");t.selectpicker("val",[]),t.trigger("change")}));else if("textarea"==a)e.push('<textarea style="'+p+'" id="'+f+'" class="form-control" name="'+o+'"'),i&&e.push(" required"),t.placeholder&&e.push(' placeholder="'+t.placeholder+'"'),l&&e.push(" disabled"),e.push(">"),null!=c&&e.push(c),e.push("</textarea>");else if("button"==a)e.push('<button style="'+p+'" id="'+f+'" name="'+o+'" type="button" class="btn btn-default btn-sm">'),t.icon&&e.push('<span class="'+t.icon+'"></span> '),e.push(c||s),e.push("</button>");else if("custom"===a)e.push(c);else if("file"===a){var g=null!=t.multiple&&t.multiple;e.push('<select data-multiple="'+g+'" data-type="file" title="'+(t.placeholder||(g?"Choose one or more files...":"Choose a file..."))+'" name="'+o+'_picker" data-width="35%" class="file-input selectpicker form-control">');var v=[];t.options&&(v=v.concat(t.options)),v.push("My Computer"),v.push("URL"),null!=t.text&&v.push(t.text),_.each(v,function(t,r){var n=_.isObject(t)&&void 0!==t.value,i=n?t.value:t,o=n?t.name:t;e.push('<option value="'),e.push(i),e.push('"'),n&&t.disabled&&e.push(" disabled"),"Dropbox"===i?e.push(' data-icon="fa fa-dropbox"'):"My Computer"===i?e.push(' data-icon="fa fa-desktop"'):"URL"===i&&e.push(' data-icon="fa fa-external-link"'),e.push(">"),e.push(o),e.push("</option>")}),e.push("</select>"),e.push("<div>"),e.push('<input placeholder="'+(g?"Enter one or more URLs":"Enter a URL")+'" class="form-control" style="width:50%; display:none;" type="text" name="'+o+'_url">'),t.text&&e.push('<input class="form-control" style="width:50%; display:none;" type="text" name="'+o+'_text">'),e.push("</div>"),e.push('<input style="display:none;" type="file" name="'+o+'_file"'+(g?" multiple":"")+">"),n.$form.on("change","[name="+o+"_picker]",function(e){var r=$(this).val(),i="URL"===r,a=r===t.text;if("Dropbox"===r){var s={success:function(e){var t=g?e.map(function(e){return e.link}):e[0].link;n.setValue(o,t),n.trigger("change",{name:o,value:t})},linkType:"direct",multiselect:g};Dropbox.choose(s),n.$form.find("[name="+o+"_picker]").selectpicker("val","")}else"My Computer"===r&&(n.$form.find("[name="+o+"_file]").click(),n.$form.find("[name="+o+"_picker]").selectpicker("val",""));n.$form.find("[name="+o+"_url]").css("display",i?"":"none"),n.$form.find("[name="+o+"_text]").css("display",a?"":"none")}),n.$form.on("keyup","[name="+o+"_url]",function(e){var t=$.trim($(this).val());g&&(t=t.split(",").filter(function(e){return""!==$.trim(e)})),n.setValue(o,t),13===e.which&&n.trigger("change",{name:o,value:t})}),n.$form.on("keyup","[name="+o+"_text]",function(e){var t=$.trim($(this).val());n.setValue(o,t),13===e.which&&n.trigger("change",{name:o,value:t})}),n.$form.on("change","[name="+o+"_file]",function(e){var t=e.target.files;n.setValue(o,g?t:t[0]),n.trigger("change",{name:o,value:g?t:t[0]})})}else"div"===(a=null==a?"text":a)?e.push('<div name="'+o+'" id="'+f+'"'):e.push('<input style="'+p+'" type="'+a+'" class="form-control" name="'+o+'" id="'+f+'"'),null!=c&&e.push(' value="'+c+'"'),t.placeholder&&e.push(' placeholder="'+t.placeholder+'"'),null!=t.min&&e.push(' min="'+t.min+'"'),null!=t.max&&e.push(' max="'+t.max+'"'),t.step&&e.push(' step="'+t.step+'"'),i&&e.push(" required"),l&&e.push(" disabled"),null!=t.autocomplete&&e.push(' autocomplete="'+t.autocomplete+'"'),e.push(">"),"div"===a&&e.push("</div>");return void 0!==u&&(e.push('<span data-name="'+o+'_help" class="help-block">'),e.push(u),e.push("</span>")),m},append:function(e){var t=[],r=this;morpheus.Util.isArray(e)||(e=[e]),t.push('<div class="form-group">'),_.each(e,function(e,n){r._append(t,e,0===n)}),t.push("</div>");var n=$(t.join(""));this.$form.append(n);var i=n.find(".checkbox-list");if(i.length>0){var o=0;_.each(e,function(e){if("checkbox-list"===e.type){var t=new morpheus.CheckBoxList({responsive:!1,$el:$(i[o]),items:e.options});$(i[o]).data("morpheus.checkbox-list",t),o++}})}n.find(".selectpicker").selectpicker({iconBase:"fa",tickIcon:"fa-check",style:"btn-default btn-sm"})},clear:function(){this.$form.empty()},getValue:function(e){var t=this.$form.find("[name="+e+"]");return 0===t.length&&(t=this.$form.find("[name="+e+"_picker]")),morpheus.FormBuilder.getValue(t)},setOptions:function(e,t,r){var n=this.$form.find("[name="+e+"]"),i=n.data("morpheus.checkbox-list");if(i)i.setItems(t);else{var o=[],a=n.val();_.each(t,function(e){var t=_.isObject(e)&&void 0!==e.value;if(e&&e.divider)o.push('<option data-divider="true"></option>');else{o.push('<option value="');var r=t?e.value:e,n=t?e.name:e;o.push(r),o.push('"'),o.push(">"),o.push(n),o.push("</option>")}}),n.html(o.join("")),n.val(a),r&&null==n.val()&&n[0].options.length>0&&n.val(n[0].options[0].value),n.hasClass("selectpicker")&&(n.selectpicker("refresh"),n.selectpicker("render"))}},find:function(e){return this.$form.find("[name="+e+"]")},setHelpText:function(e,t){this.$form.find("[data-name="+e+"_help]").html(t)},setValue:function(e,t){var r=this.$form.find("[name="+e+"]");if(0===r.length&&"file"===(r=this.$form.find("[name="+e+"_picker]")).data("type"))return r.val(t),r.selectpicker("render"),void r.data("files",t);var n=r.attr("type"),i=r.data("morpheus.checkbox-list");i?i.setValue(t):("radio"===n?r.filter("[value="+t+"]").prop("checked",!0):"checkbox"===n?r.prop("checked",t):r.val(t),r.hasClass("selectpicker")&&r.selectpicker("render"))},setVisible:function(e,t){var r=this.$form.find("[name="+e+"]").parents(".form-group");t?r.show():r.hide()},remove:function(e){this.$form.find("[name="+e+"]").parents(".form-group").remove()},setEnabled:function(e,t){var r=this.$form.find("[name="+e+"]");r.attr("disabled",!t),t?r.parents(".form-group").find("label").removeClass("text-muted"):r.parents(".form-group").find("label").addClass("text-muted")}},morpheus.Util.extend(morpheus.FormBuilder,morpheus.Events),morpheus.GradientColorSupplier=function(){morpheus.AbstractColorSupplier.call(this),this._updateScale()},morpheus.GradientColorSupplier.prototype={createInstance:function(){return new morpheus.GradientColorSupplier},getColor:function(e,t,r){if(isNaN(r))return this.missingColor;var n=this.min,i=this.max,o=this.colors;if(r<=n)return o[0];if(r>=i)return o[o.length-1];var a=morpheus.SteppedColorSupplier.linearScale(r,n,i,0,100)/100;return this.colorScale(a)},setFractions:function(e){morpheus.AbstractColorSupplier.prototype.setFractions.call(this,e),this._updateScale()},_updateScale:function(){this.colorScale=d3.scale.linear().domain(this.fractions).range(this.colors).clamp(!0)}},morpheus.Util.extend(morpheus.GradientColorSupplier,morpheus.AbstractColorSupplier),morpheus.Grid=function(e){this.options=e;var t,r=this;this.items=e.items,this.modelToView=null,this.viewOrder=null,this.filter=new morpheus.CombinedGridFilter;var n={getLength:function(){return null!=r.viewOrder?r.viewOrder.length:r.items.length},getItem:function(e){return r.items[null!=r.viewOrder?r.viewOrder[e]:e]}};this.$el=e.$el;var i=$.extend({},{select:!0,headerRowHeight:0,showHeaderRow:!1,multiColumnSort:!0,multiSelect:!1,topPanelHeight:0,enableColumnReorder:!1,enableTextSelectionOnCells:!0,forceFitColumns:!0,dataItemColumnValueExtractor:function(e,t){return t.getter(e)},defaultFormatter:function(e,t,r,n,i){if(_.isNumber(r))return morpheus.Util.nf(r);if(morpheus.Util.isArray(r)){for(var o=[],a=0,s=r.length;a<s;a++)a>0&&o.push(", "),r[a],o.push(r[a]);return o.join("")}return r}},e.gridOptions||{});if(t=new Slick.Grid(e.$el,n,e.columns,i),this.grid=t,t.registerPlugin(new morpheus.AutoTooltips2),t.onCellChange.subscribe(function(e,t){r.trigger("edit",t)}),i.select&&(t.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow:!0,multiSelect:i.multiSelect})),t.getSelectionModel().onSelectedRangesChanged.subscribe(function(e){var n=t.getDataLength();r.trigger("selectionChanged",{selectedRows:t.getSelectedRows().filter(function(e){return e>=0&&e<=n})})})),t.onSort.subscribe(function(e,n){r.sortCols=n.sortCols,r._updateMappings(),t.invalidate()}),e.$el.on("click",function(e){var n=t.getCellFromEvent(e);n&&r.trigger("click",{row:n.row,target:e.target})}),e.$el.on("dblclick",function(e){var n=t.getCellFromEvent(e);n&&r.trigger("dblclick",{row:n.row,target:e.target})}),e.sort){var o=[],a=t.getColumns();e.sort.forEach(function(e){for(var t=null,r=0;r<a.length;r++)if(a[r].name===e.name){t=a[r];break}null!=t?o.push({columnId:t.id,sortAsc:e.sortAsc}):console.log(e.name+" not found.")}),this.setSortColumns(o)}this.grid.invalidate()},morpheus.Grid.prototype={columnsAutosized:!1,setSortColumns:function(e){this.grid.setSortColumns(e),this.sortCols=[];for(var t=0;t<e.length;t++){var r=this.grid.getColumns()[this.grid.getColumnIndex(e[t].columnId)];if(null==r)throw"Unable to find column "+e[t];this.sortCols.push({sortCol:r,sortAsc:e[t].sortAsc})}this._updateMappings(),this.grid.invalidate()},setColumns:function(e){this.grid.setColumns(e),this.grid.resizeCanvas(),this.grid.invalidate()},getColumns:function(){return this.grid.getColumns()},getSelectedRows:function(){var e=this.grid.getDataLength();return this.grid.getSelectedRows().filter(function(t){return t>=0&&t<=e})},getSelectedItems:function(){for(var e=this.grid.getSelectedRows(),t=[],r=0,n=e.length;r<n;r++)t.push(this.items[this.convertViewIndexToModel(e[r])]);return t},getSelectedItem:function(){var e=this.grid.getSelectedRows();return 1===e.length?this.items[this.convertViewIndexToModel(e[0])]:null},getItems:function(){for(var e=[],t=0,r=this.getFilteredItemCount();t<r;t++)e.push(this.items[this.convertViewIndexToModel(t)]);return e},getAllItemCount:function(){return this.items.length},getAllItems:function(){return this.items},getFilteredItemCount:function(){return this.viewOrder?this.viewOrder.length:this.items.length},redraw:function(){this.grid.invalidate()},redrawRows:function(e){this.grid.invalidateRows(e),this.grid.render()},setItems:function(e){this.items=e,this.grid.getSelectionModel()&&this.grid.setSelectedRows([]),this.setFilter(this.filter),this.maybeAutoResizeColumns()},maybeAutoResizeColumns:function(){this.columnsAutosized||this.autosizeColumns()},convertModelIndexToView:function(e){if(null!==this.modelToView){var t=this.modelToView.get(e);return void 0!==t?t:-1}return e},convertViewIndexToModel:function(e){return null!=this.viewOrder?e<this.viewOrder.length&&e>=0?this.viewOrder[e]:-1:e},_updateMappings:function(){var e=null!=this.grid.getSelectionModel()?this.grid.getSelectedRows():null,t=[];if(e)for(var r=0,n=e.length;r<n;r++)t.push(this.convertViewIndexToModel(e[r]));if(this.viewOrder=null,null!=this.filter&&(this.filter.init(),!this.filter.isEmpty()))for(this.viewOrder=[],r=0,n=this.items.length;r<n;r++)this.filter.accept(this.items[r])&&this.viewOrder.push(r);var i=this.sortCols;if(i&&i.length>0){if(null==this.viewOrder)for(this.viewOrder=[],r=0,n=this.items.length;r<n;r++)this.viewOrder.push(r);var o=i.length,a=this.items;this.viewOrder.sort(function(e,t){for(var r=0;r<o;r++){var n=i[r].sortCol.getter,s=(i[r].sortAsc?morpheus.SortKey.ASCENDING_COMPARATOR:morpheus.SortKey.DESCENDING_COMPARATOR)(n(a[e]),n(a[t]));if(0!==s)return s}return 0})}if(null!=this.viewOrder)for(this.modelToView=new morpheus.Map,r=0,n=this.viewOrder.length;r<n;r++)this.modelToView.set(this.viewOrder[r],r);else this.modelToView=null;if(null!=this.grid.getSelectionModel()){var s=[];for(r=0,n=t.length;r<n;r++){var l=this.convertModelIndexToView(t[r]);void 0!==l&&s.push(l)}this.grid.setSelectedRows(s)}},setSelectedRows:function(e){this.grid.setSelectedRows(e)},setFilter:function(e){this.filter=e,this._updateMappings(),this.grid.invalidate(),this.trigger("filter")},getFilter:function(){return this.filter},autosizeColumns:function(){var e=this.grid.getColumns(),t=this.getItems();if(t&&0!==t.length&&e&&0!==e.length){var r=this.options.$el.width()-30;if(!(r<=0)&&(this.columnsAutosized=!0,e.length>-1)){var n=document.createElement("div");document.body.appendChild(n);var i=$(n);i.css({position:"absolute",left:-1e3,top:-1e3});var o=$('<div class="slick-table"><div class="ui-state-default slick-header-column slick-header-sortable ui-sortable-handle"></div><div class="ui-widget-content slick-row"><div class="slick-cell selected"></div></div></div>'),a=o.find(".slick-cell"),s=o.find(".slick-header-column");o.appendTo(i);for(var l=Math.min(parseInt(r/2),400),u=function(e){var r=s.html(e.name).outerWidth()+13;if(e.prototypeValue)a.html(e.prototypeValue),r=Math.max(a.outerWidth(),r);else for(var n=0,i=Math.min(t.length,10);n<i;n++){var o=e.formatter(n,null,e.getter(t[n]),e,t[n]),u=$(o);u.find(".slick-cell-wrapper").attr("class",""),a.html(u),r=Math.max(a.outerWidth(),r)}e.width=parseInt(Math.min(l,r))},c=0;c<e.length;c++)u(e[c]),e[c].width;i.remove(),this.grid.resizeCanvas()}}}},morpheus.Util.extend(morpheus.Grid,morpheus.Events),morpheus.AutoTooltips2=function(e){var t;function r(e){var r=t.getCellFromEvent(e);if(r){var n=$(t.getCellNode(r.row,r.cell));n.data("bs.tooltip")&&n.tooltip("hide")}}function n(){$(t.getCanvasNode()).find("[data-original-title]").attr("data-original-title","").tooltip("hide")}function i(e){var r=t.getCellFromEvent(e);if(r){var n=$(t.getCellNode(r.row,r.cell)),i="",o=t.getColumns()[r.cell],a=!1,s=n.find(".slick-cell-wrapper");if(o.alwaysShowTooltip||s[0].scrollWidth>s[0].offsetWidth){var l=t.getDataItem(r.row);i=o.tooltip(l,o.getter(l)),a=!0}n.attr("data-original-title",i);var u=n.data("bs.tooltip");u||n.tooltip({placement:"auto",html:!0,container:"body",trigger:"manual"}),a?n.tooltip("show"):u&&n.tooltip("hide")}}$.extend(this,{init:function(e){t=e,$(t.getCanvasNode()).on("mouseover",".slick-row",i),$(t.getCanvasNode()).on("mouseout",".slick-row",r),$(t.getCanvasNode()).on("mouseup",n)},destroy:function(){$(t.getCanvasNode()).off("mouseover",i),$(t.getCanvasNode()).off("mouseout",r),$(t.getCanvasNode()).off("mouseup",n)}})},morpheus.CombinedGridFilter=function(){this.filters=[]},morpheus.CombinedGridFilter.prototype={add:function(e){this.filters.push(e)},getFilters:function(){return this.filters},get:function(e){return this.filters[e]},set:function(e,t){this.filters[e]=t},init:function(){for(var e=0;e<this.filters.length;e++)this.filters[e].init();this.activeFilters=this.filters.filter(function(e){return!e.isEmpty()}),this.nActiveFilters=this.activeFilters.length},accept:function(e){for(var t=0;t<this.nActiveFilters;t++)if(!this.activeFilters[t].accept(e))return!1;return!0},isEmpty:function(){return 0===this.activeFilters.length}},morpheus.HeatMapColorSchemeChooser=function(e){var t=this;this.$div=$("<div></div>"),this.currentValue=null,this.legend=new morpheus.LegendWithStops,this.colorScheme=e.colorScheme||new morpheus.HeatMapColorScheme(new morpheus.Project(new morpheus.Dataset({rows:0,columns:0}))),this.legend.on("added",function(e){var r=t.colorScheme.getFractions();r.push(e.fraction);var n=t.colorScheme.getColors();n.push("black"),t.colorScheme.setFractions({fractions:r,colors:n});var i=t.getFractionIndex(e.fraction,"black");t.setSelectedIndex(i),t.fireChanged()}).on("selectedIndex",function(e){t.setSelectedIndex(e.selectedIndex)}).on("delete",function(e){t.deleteSelectedStop()}).on("moved",function(e){var r=e.fraction,n=t.colorScheme.getFractions();n[t.legend.selectedIndex]=r;var i=t.colorScheme.getColors()[t.legend.selectedIndex];t.colorScheme.setFractions({fractions:n,colors:t.colorScheme.getColors()}),t.legend.selectedIndex=t.getFractionIndex(e.fraction,i);var o=d3.scale.linear().domain([0,1]).range([t.colorScheme.getMin(),t.colorScheme.getMax()]).clamp(!0);t.formBuilder.setValue("selected_value",o(n[t.legend.selectedIndex])),t.fireChanged()});var r=$("<div></div>");r.css("height","50px").css("width","300px").css("margin-left","auto").css("margin-right","auto"),r.appendTo(this.$div),$(this.legend.canvas).appendTo(r);var n=new morpheus.FormBuilder,i=[];i=i.concat({name:"selected_color",type:"color",style:"max-width: 50px;"},{name:"selected_value",type:"text",style:"max-width: 100px;"},[{name:"delete",type:"button",value:"Delete Selected Color Stop"},{name:"add",type:"button",value:"Add Color Stop"}],{name:"minimum",type:"text",style:"max-width: 100px;"},{name:"maximum",type:"text",style:"max-width: 100px;"}),e.showRelative&&(i=(i=i.concat({name:"relative_color_scheme",type:"checkbox",help:"A relative color scheme uses the minimum and maximum values in each row to convert values to colors"})).concat({name:"transform_values",type:"select",value:0,options:[{name:"None",value:0},{name:"Subtract row mean, divide by row standard deviation",value:morpheus.AbstractColorSupplier.Z_SCORE},{name:"Subtract row median, divide by row median absolute deviation",value:morpheus.AbstractColorSupplier.ROBUST_Z_SCORE}]})),(i=i.concat({name:"missing_color",type:"color",style:"max-width: 50px;"})).push({name:"stepped_colors",type:"checkbox",value:!1,help:"Intervals include left end point and exclude right end point, except for the highest interval"}),_.each(i,function(e){n.append(e)}),this.getFractionIndex=function(e,r){for(var n=t.colorScheme.getFractions(),i=t.colorScheme.getColors(),o=0,a=n.length;o<a;o++)if(n[o]===e&&i[o]===r)return o;return-1},n.$form.appendTo(this.$div),n.$form.find("[name^=selected],[name=delete]").prop("disabled",!0),n.$form.find("[name=add]").on("click",function(e){for(var r=t.colorScheme.getFractions(),n=.5;n>=0&&-1!==_.indexOf(r,n);)n-=.1;n=Math.max(0,n),r.push(n);var i=t.colorScheme.getColors();i.push("black"),t.colorScheme.setFractions({fractions:r,colors:i});var o=t.getFractionIndex(e.fraction,"black");t.setSelectedIndex(o),t.fireChanged()}),n.$form.find("[name=delete]").on("click",function(e){t.deleteSelectedStop()}),n.$form.find("[name=transform_values]").on("change",function(e){t.colorScheme.setTransformValues(parseInt(n.getValue("transform_values"))),t.fireChanged()}),n.$form.on("keyup","[name=selected_value]",_.debounce(function(e){var r=parseFloat($(this).val());isNaN(r)||(t.setSelectedValue(r),t.fireChanged())},100)),n.$form.on("change","[name=selected_color]",function(e){var r=t.colorScheme.getColors();r[t.legend.selectedIndex]=$(this).val(),t.colorScheme.setFractions({fractions:t.colorScheme.getFractions(),colors:r}),t.fireChanged()}),n.$form.on("change","[name=missing_color]",function(e){var r=$(this).val();t.colorScheme.setMissingColor(r),t.fireChanged(!1)}),n.$form.on("change","[name=stepped_colors]",function(e){t.colorScheme.setStepped($(this).prop("checked")),t.fireChanged()}),n.$form.on("keyup","[name=minimum]",_.debounce(function(e){var r=parseFloat($(this).val());isNaN(r)||(t.colorScheme.setMin(r),t.setSelectedIndex(t.legend.selectedIndex),t.fireChanged(!1))},100)),n.$form.on("keyup","[name=maximum]",_.debounce(function(e){var r=parseFloat($(this).val());isNaN(r)||(t.colorScheme.setMax(r),t.setSelectedIndex(t.legend.selectedIndex),t.fireChanged(!1))},100)),n.$form.on("change","[name=relative_color_scheme]",_.throttle(function(e){t.legend.selectedIndex=-1;var r=$(this).prop("checked")?morpheus.HeatMapColorScheme.ScalingMode.RELATIVE:morpheus.HeatMapColorScheme.ScalingMode.FIXED;t.colorScheme.setScalingMode(r),t.setColorScheme(t.colorScheme),t.fireChanged()},100)),this.formBuilder=n},morpheus.HeatMapColorSchemeChooser.prototype={deleteSelectedStop:function(){var e=this.colorScheme.getFractions();e.splice(this.legend.selectedIndex,1);var t=this.colorScheme.getColors();t.splice(this.legend.selectedIndex,1),this.colorScheme.setFractions({fractions:e,colors:t}),this.formBuilder.$form.find("[name^=selected],[name=delete]").prop("disabled",!0),this.legend.setSelectedIndex(-1),this.fireChanged()},setSelectedValue:function(e){var t=d3.scale.linear().domain([this.colorScheme.getMin(),this.colorScheme.getMax()]).range([0,1]).clamp(!0),r=this.colorScheme.getFractions(),n=t(e);r[this.legend.selectedIndex]=n;var i=this.colorScheme.getColors()[this.legend.selectedIndex];this.colorScheme.setFractions({fractions:r,colors:this.colorScheme.getColors()}),this.legend.selectedIndex=this.getFractionIndex(n,i)},setSelectedIndex:function(e){var t=this.colorScheme.getFractions();e>=t.length&&(e=-1),this.legend.setSelectedIndex(e);var r=this.formBuilder;if(r.$form.find("[name^=selected],[name=delete]").prop("disabled",-1===this.legend.selectedIndex),-1!==this.legend.selectedIndex){var n=d3.scale.linear().domain([0,1]).range([this.colorScheme.getMin(),this.colorScheme.getMax()]).clamp(!0);r.setValue("selected_value",n(t[this.legend.selectedIndex]));var i=this.legend.canvas.getContext("2d"),o=this.colorScheme.getColors();i.fillStyle=o[this.legend.selectedIndex],r.setValue("selected_color",i.fillStyle)}else r.setValue("selected_value","");this.draw()},setMinMax:function(){this.colorScheme.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE&&(this.colorScheme.setMin(0),this.colorScheme.setMax(1))},dispose:function(){this.off("change"),this.legend.destroy(),this.formBuilder.$form.off("keyup","input"),this.formBuilder.$form.off("change","[name=relative_color_scheme]")},restoreCurrentValue:function(){this.colorScheme.setCurrentValue&&this.colorScheme.setCurrentValue(this.currentValue)},setCurrentValue:function(e){this.currentValue=e,this.colorScheme&&this.colorScheme.setCurrentValue&&this.colorScheme.setCurrentValue(this.currentValue),this.setColorScheme(this.colorScheme)},setColorScheme:function(e){this.colorScheme=e,this.setMinMax(),e.setCurrentValue&&e.setCurrentValue(this.currentValue),this.formBuilder.setValue("relative_color_scheme",e.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE),this.formBuilder.setValue("transform_values",e.getTransformValues()),this.formBuilder.setEnabled("transform_values",e.getScalingMode()!==morpheus.HeatMapColorScheme.ScalingMode.RELATIVE),this.formBuilder.$form.find("[name=minimum],[name=maximum]").prop("disabled",e.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE),this.formBuilder.setValue("minimum",this.colorScheme.getMin()),this.formBuilder.setValue("maximum",this.colorScheme.getMax()),this.formBuilder.setValue("stepped_colors",this.colorScheme.isStepped()),this.formBuilder.setValue("missing_color",this.colorScheme.getMissingColor()),this.draw()},getFractionToStopPix:function(){return d3.scale.linear().clamp(!0).domain([0,1]).range([this.legend.border,this.legend.getUnscaledWidth()-this.legend.border])},fireChanged:function(e){this.trigger("change"),!1!==e&&this.setColorScheme(this.colorScheme)},draw:function(){var e=this.colorScheme;e.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE&&(e.setMin(0),e.setMax(1));var t=e.getFractions(),r=e.getColors(),n=this.getFractionToStopPix();this.legend.draw(t,r,e.isStepped(),n)}},morpheus.Util.extend(morpheus.HeatMapColorSchemeChooser,morpheus.Events),morpheus.HeatMapColorSchemeLegend=function(e,t){var r,n=e.heatmap.getColorScheme(),i=n.getColorByValues();t.empty();var o=i.length;i.forEach(function(i){if(null!=i||1===o){if("null"!=i){var a=$('<div style="overflow:hidden;text-overflow: ellipsis;width:250px;max-width:250px;">'+i+"</div>");t.append(a),r+=a.height()}var s=new morpheus.ColorSupplierLegend(n,i);$(s.canvas).css("position",""),s.repaint(),s.on("selectionChanged",function(){e.heatmap.setInvalid(!0),e.heatmap.repaint()}),t.append($(s.canvas)),r+=s.getUnscaledHeight()}}),e.options.$key&&(t.append(e.options.$key),r+=e.options.$key.height());var a=$('<div style="padding-left:4px; display:inline;"><a data-name="options" href="#">Edit</a></div>');a.find("[data-name=options]").on("click",function(t){t.preventDefault(),e.showOptions(),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"options"})}),r+=a.height(),t.append(a),t.css({"text-overflow":"ellipsis",overflow:"hidden",width:"250px",height:r+"px"})},morpheus.HeatMapColorSchemeLegend.drawColorScheme=function(e,t,r,n,i,o){o||(o=12),e.font="11px "+morpheus.CanvasUtil.getFontFamily(e);var a=t.getNames(),s=null!=a;if(s)morpheus.HeatMapColorSchemeLegend.drawColorSchemeVertically(e,t,t.getHiddenValues(),n);else{if(morpheus.HeatMapColorSchemeLegend.draw(e,t.getFractions(),t.getColors(),r,o,t.isStepped()),e.strokeStyle="LightGrey",e.strokeRect(0,0,r,o),i)return;var l=d3.scale.linear().domain([0,1]).range([0,r]).clamp(!0),u=d3.scale.linear().domain([0,1]).range([t.getMin(),t.getMax()]).clamp(!0);if(e.textAlign="center",e.textBaseline="top",e.fillStyle="black",t.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE)e.fillText("row min",0,14),e.fillText("row max",r,o+2);else{for(var c=t.getFractions(),h=-1,p=parseInt(c.length/2),d=0;d<p;d++){var f=l(c[d]),m="";m=s?""!=a[d]?a[d]+" ("+u(c[d])+")":a[d]:morpheus.Util.nf(u(c[d]));var g=e.measureText(m).width;f>h&&e.fillText(m,f,o+2),h=f+g/2}var v=1e4;for(d=c.length-1;d>=p;d--)f=l(c[d]),m="",m=s?""!=a[d]?a[d]+" ("+u(c[d])+")":a[d]:morpheus.Util.nf(u(c[d])),f+(g=e.measureText(m).width)/2<v&&(e.fillText(m,f,o+2),v=f-g/2)}}},morpheus.HeatMapColorSchemeLegend.drawColorSchemeVertically=function(e,t,r,n){var i=d3.scale.linear().domain([0,1]).range([t.getMin(),t.getMax()]).clamp(!0);e.textAlign="left",e.textBaseline="top",e.fillStyle="black";var o=t.getFractions(),a=t.getColors(),s=t.getNames();e.strokeStyle="LightGrey";var l=0;e.font="12px "+morpheus.CanvasUtil.getFontFamily(e);for(var u=0;u<a.length;u++){var c=s[u];if(null!=c){if(e.fillStyle=a[u],e.fillRect(0,l,12,12),e.strokeRect(0,l,12,12),e.fillStyle=morpheus.CanvasUtil.FONT_COLOR,r&&!n){var h=i(o[u]);try{e.font="12px FontAwesome",r.has(h)||e.fillText("ï",-14,l)}catch(e){}e.font="12px "+morpheus.CanvasUtil.getFontFamily(e)}e.fillText(c,16,l)}l+=14}},morpheus.HeatMapColorSchemeLegend.draw=function(e,t,r,n,i,o){if(o){var a=d3.scale.linear().domain([0,1]).range([0,n]).clamp(!0);for(c=0,h=t.length;c<h;c++){e.fillStyle=r[c];var s=a(t[c]),l=c===h-1?n:a(t[c+1]);e.fillRect(Math.min(s,l),0,Math.abs(l-s),i)}}else{for(var u=e.createLinearGradient(0,0,n,i),c=0,h=t.length;c<h;c++)u.addColorStop(t[c],r[c]);e.fillStyle=u,e.fillRect(0,0,n,i)}},morpheus.ColorSupplierLegend=function(e,t){morpheus.AbstractCanvas.call(this,!1);var r=this;this.value=t,this.colorScheme=e,e.setCurrentValue(t);var n=e.getHiddenValues(),i=e.getNames(),o=null!=i,a={width:250,height:o?14*i.length:30};this.hasNames=o,this.setBounds(a),o&&n&&$(this.canvas).on("click",function(t){t.preventDefault(),t.stopPropagation();var i=Math.floor((t.clientY-r.canvas.getBoundingClientRect().top)/14),o=d3.scale.linear().domain([0,1]).range([e.getMin(),e.getMax()]).clamp(!0)(e.getFractions()[i]);n.has(o)?n.remove(o):n.add(o),r.trigger("selectionChanged"),r.repaint()})},morpheus.ColorSupplierLegend.prototype={draw:function(e,t){var r=this.colorScheme;r.setCurrentValue(this.value),t.translate(this.hasNames?14:(this.getUnscaledWidth()-200)/2,0),morpheus.HeatMapColorSchemeLegend.drawColorScheme(t,r,200)}},morpheus.Util.extend(morpheus.ColorSupplierLegend,morpheus.Events),morpheus.Util.extend(morpheus.ColorSupplierLegend,morpheus.AbstractCanvas),morpheus.HeatMapColorScheme=function(e,t){this.project=e;var r=this;this.separateColorSchemeForRowMetadataField=null,this.rowValueToColorSupplier={},this.value=null,t&&(t.valueToColorScheme?this.fromJSON(t):(this.rowValueToColorSupplier.null=this.fromJSON(t),this.currentColorSupplier=this.rowValueToColorSupplier[this.value])),e.on("rowFilterChanged columnFilterChanged rowSortOrderChanged columnSortOrderChanged datasetChanged",function(){r.projectUpdated()}),this.projectUpdated()},morpheus.HeatMapColorScheme.Predefined={},morpheus.HeatMapColorScheme.Predefined.CN=function(){return{scalingMode:"fixed",values:[-2,-.1,.1,2],colors:["#0000ff","#ffffff","#ffffff","#ff0000"]}},morpheus.HeatMapColorScheme.Predefined.BINARY=function(){return{scalingMode:"fixed",values:[0,1],colors:["#ffffff","black"]}},morpheus.HeatMapColorScheme.Predefined.RELATIVE=function(){return{scalingMode:"relative"}},morpheus.HeatMapColorScheme.Predefined.MAF=function(){return{scalingMode:"fixed",stepped:!0,values:[0,1,2,3,4,5,6,7],names:["","Synonymous","In Frame Indel","Other Non-Synonymous","Missense","Splice Site","Frame Shift","Nonsense"],colors:["#ffffff","#4daf4a","#ffff33","#a65628","#377eb8","#984ea3","#ff7f00","#e41a1c"]}},morpheus.HeatMapColorScheme.Predefined.ZS=function(){return{scalingMode:"fixed",values:[-10,-2,2,10],colors:["#0000ff","#ffffff","#ffffff","#ff0000"]}},morpheus.HeatMapColorScheme.ScalingMode={RELATIVE:0,FIXED:1},morpheus.HeatMapConditions=function(){this.array=[]},morpheus.HeatMapConditions.prototype={insert:function(e,t){this.array.splice(e,0,t)},add:function(e){this.array.push(e)},getConditions:function(){return this.array},remove:function(e){this.array.splice(e,1)},copy:function(){var e=new morpheus.HeatMapConditions;return this.array.forEach(function(t){e.array.push(_.clone(t))}),e}},morpheus.HeatMapColorScheme.prototype={getColors:function(){return this.currentColorSupplier.getColors()},setMissingColor:function(e){this.currentColorSupplier.setMissingColor(e)},getHiddenValues:function(){return this.currentColorSupplier.getHiddenValues?this.currentColorSupplier.getHiddenValues():null},getMissingColor:function(){return this.currentColorSupplier.getMissingColor()},getScalingMode:function(){return this.currentColorSupplier.getScalingMode()},getSizer:function(){return this.currentColorSupplier.getSizer()},getConditions:function(){return this.currentColorSupplier.getConditions()},setScalingMode:function(e){this.currentColorSupplier.setScalingMode(e)},getFractions:function(){return this.currentColorSupplier.getFractions()},getNames:function(){return this.currentColorSupplier.getNames()},getMin:function(){return this.currentColorSupplier.getMin()},getMax:function(){return this.currentColorSupplier.getMax()},setMin:function(e){this.currentColorSupplier.setMin(e)},setMax:function(e){this.currentColorSupplier.setMax(e)},isStepped:function(){return this.currentColorSupplier.isStepped()},setFractions:function(e){this.currentColorSupplier.setFractions(e)},setTransformValues:function(e){this.currentColorSupplier.setTransformValues(e),this.cachedRowStats.cachedRow=-1},getTransformValues:function(){return this.currentColorSupplier.getTransformValues()},setStepped:function(e){var t=this.currentColorSupplier,r=e?new morpheus.SteppedColorSupplier:new morpheus.GradientColorSupplier;r.sizer=t.getSizer(),r.array=t.getConditions(),r.setScalingMode(t.getScalingMode()),r.setMin(t.getMin()),r.setMax(t.getMax()),r.setFractions({fractions:t.getFractions(),colors:t.getColors()}),this.currentColorSupplier=r,this.rowValueToColorSupplier[this.value]=this.currentColorSupplier},toJSON:function(){var e={},t=this;return null!=this.separateColorSchemeForRowMetadataField&&(e.separateColorSchemeForRowMetadataField=this.separateColorSchemeForRowMetadataField),e.valueToColorScheme={},_.each(_.keys(this.rowValueToColorSupplier),function(r){e.valueToColorScheme[r]=morpheus.AbstractColorSupplier.toJSON(t.rowValueToColorSupplier[r])}),e},fromJSON:function(e){var t=this;e.separateColorSchemeForRowMetadataField&&(this.separateColorSchemeForRowMetadataField=e.separateColorSchemeForRowMetadataField,this.vector=this.project.getSortedFilteredDataset().getRowMetadata().getByName(this.separateColorSchemeForRowMetadataField)),this.rowValueToColorSupplier={};var r=e.valueToColorScheme||e.colorSchemes;if(null==r){var n=morpheus.AbstractColorSupplier.fromJSON(e);t.rowValueToColorSupplier.null=n}else _.each(_.keys(r),function(e){var n=morpheus.AbstractColorSupplier.fromJSON(r[e]);t.rowValueToColorSupplier[e]=n});this._ensureColorSupplierExists()},copy:function(e){var t=this,r=new morpheus.HeatMapColorScheme(e);return r.separateColorSchemeForRowMetadataField=this.separateColorSchemeForRowMetadataField,null!=r.separateColorSchemeForRowMetadataField&&(r.vector=e.getSortedFilteredDataset().getRowMetadata().getByName(r.separateColorSchemeForRowMetadataField)),null==r.vector&&(r.separateColorSchemeForRowMetadataField=null),_.each(_.keys(this.rowValueToColorSupplier),function(e){r.rowValueToColorSupplier[e]=t.rowValueToColorSupplier[e].copy()}),r.value=this.value,r.currentColorSupplier=r.rowValueToColorSupplier[r.value],r},setSeparateColorSchemeForRowMetadataField:function(e){if(e!=this.separateColorSchemeForRowMetadataField){this.separateColorSchemeForRowMetadataField=e,this.vector=this.project.getSortedFilteredDataset().getRowMetadata().getByName(e);var t=this;_.each(_.keys(this.rowValueToColorSupplier),function(e){delete t.rowValueToColorSupplier[e]})}},getProject:function(){return this.project},getSeparateColorSchemeForRowMetadataField:function(){return this.separateColorSchemeForRowMetadataField},getColorByValues:function(){return _.keys(this.rowValueToColorSupplier)},projectUpdated:function(){var e=this.project.getSortedFilteredDataset();null!=this.separateColorSchemeForRowMetadataField&&(this.vector=this.project.getSortedFilteredDataset().getRowMetadata().getByName(this.separateColorSchemeForRowMetadataField)),this.cachedRowStats=new morpheus.RowStats(e)},setColorSupplierForCurrentValue:function(e){this.rowValueToColorSupplier[this.value]=e,this.currentColorSupplier=e},setCurrentValue:function(e){this.value=e,this._ensureColorSupplierExists()},isSizeBy:function(){this.currentColorSupplier.isSizeBy()},getCurrentColorSupplier:function(){return this.currentColorSupplier},getColor:function(e,t,r){if(void 0!==this.vector){var n=this.vector.getValue(e);this.value!==n&&(this.value=n,this._ensureColorSupplierExists())}return this.currentColorSupplier.getScalingMode()===morpheus.HeatMapColorScheme.ScalingMode.RELATIVE?this.cachedRowStats.maybeUpdateRelative(e)&&(this.currentColorSupplier.setMin(this.cachedRowStats.rowCachedMin),this.currentColorSupplier.setMax(this.cachedRowStats.rowCachedMax)):this.currentColorSupplier.getTransformValues()&&this.cachedRowStats.cachedRow!==e&&(this.cachedRowStats.cacheTransformValues(e,this.currentColorSupplier.getTransformValues()),r=(r-this.cachedRowStats.rowCachedMean)/this.cachedRowStats.rowCachedStandardDeviation),this.currentColorSupplier.getColor(e,t,r)},_ensureColorSupplierExists:function(){if(this.currentColorSupplier=this.rowValueToColorSupplier[this.value],void 0===this.currentColorSupplier){var e=morpheus.AbstractColorSupplier.fromJSON({scalingMode:"relative"});this.rowValueToColorSupplier[this.value]=e,this.currentColorSupplier=e}}},morpheus.RowStats=function(e){this.datasetRowView=new morpheus.DatasetRowView(e),this.cachedRow=-1,this.rowCachedMax=0,this.rowCachedMin=0,this.rowCachedStandardDeviation=NaN,this.rowCachedMean=-1},morpheus.RowStats.prototype={cacheTransformValues:function(e,t){var r=t===morpheus.AbstractColorSupplier.Z_SCORE?morpheus.Mean:morpheus.Median,n=t===morpheus.AbstractColorSupplier.Z_SCORE?morpheus.StandardDeviation:morpheus.MAD;this.datasetRowView.setIndex(e),this.rowCachedMean=r(this.datasetRowView),this.rowCachedStandardDeviation=n(this.datasetRowView,this.rowCachedMean),0===this.rowCachedStandardDeviation&&(this.rowCachedStandardDeviation=NaN)},maybeUpdateRelative:function(e){if(this.cachedRow!==e){this.cachedRow=e,this.datasetRowView.setIndex(e),this.rowCachedMax=-Number.MAX_VALUE,this.rowCachedMin=Number.MAX_VALUE;for(var t=0,r=this.datasetRowView.size();t<r;t++){var n=this.datasetRowView.getValue(t);isNaN(n)||(this.rowCachedMax=n>this.rowCachedMax?n:this.rowCachedMax,this.rowCachedMin=n<this.rowCachedMin?n:this.rowCachedMin)}return this.rowCachedMin===this.rowCachedMax&&this.rowCachedMin--,!0}return!1}},morpheus.HeatMapSynchronizer=function(){this.controllers=[]},morpheus.HeatMapSynchronizer.prototype={firing:!1,getProject:function(){return this.controllers[0].getProject()},zoom:function(){this.controllers[0].zoom.apply(this.controllers[0],arguments)},setTrackVisible:function(){this.controllers[0].setTrackVisible.apply(this.controllers[0],arguments)},revalidate:function(){this.controllers[0].revalidate.apply(this.controllers[0],arguments)},add:function(e){var t=this;this.controllers.push(e),e.on("change",function(e){if(!t.firing){var r=e.source,n=e.name;t.firing=!0,_.each(t.controllers,function(t){t!==r&&t[n].apply(t,e.arguments)}),t.firing=!1}})}},morpheus.HeatMapElementCanvas=function(e){morpheus.AbstractCanvas.call(this,!0);var t=this;this.colorScheme=null,this.project=e,this.dataset=null,this.columnPositions=new morpheus.Positions,this.rowPositions=new morpheus.Positions,this.lastPosition={left:-1,right:-1,top:-1,bottom:-1},this.selectionBox=null,this.selectedRowElements=[],this.selectedColumnElements=[],e.getElementSelectionModel().on("selectionChanged",function(e){t.repaint()}),this.gridColor=morpheus.HeatMapElementCanvas.GRID_COLOR,this.gridThickness=.5,this.elementDrawCallback=null,this.drawCallback=null,this.drawValuesFormat=morpheus.Util.createNumberFormat(".2f"),this.shape="square"},morpheus.HeatMapElementCanvas.GRID_COLOR="#808080",morpheus.HeatMapElementCanvas.prototype={drawGrid:!0,drawValues:!1,setPropertiesFromParent:function(e){this.drawGrid=e.drawGrid,this.gridThickness=e.gridThickness,this.gridColor=e.gridColor,this.drawValues=e.drawValues,this.shape=e.shape},updateRowSelectionCache:function(e){this.selectedRowElements=morpheus.HeatMapElementCanvas.getSelectedSpans(this.project.getRowSelectionModel().getViewIndices()),e&&this.repaint()},updateColumnSelectionCache:function(e){this.selectedColumnElements=morpheus.HeatMapElementCanvas.getSelectedSpans(this.project.getColumnSelectionModel().getViewIndices()),e&&this.repaint()},getShape:function(){return this.shape},setShape:function(e){this.shape=e},setGridColor:function(e){this.gridColor=e},getGridColor:function(){return this.gridColor},setGridThickness:function(e){this.gridThickness=e},getGridThickness:function(){return this.gridThickness},getColorScheme:function(){return this.colorScheme},isDrawGrid:function(){return this.drawGrid},setDrawGrid:function(e){this.drawGrid=e},getDrawValuesFormat:function(){return this.drawValuesFormat},setDrawValuesFormat:function(e){"object"==typeof e&&(e=morpheus.Util.createNumberFormat(e.pattern)),this.drawValuesFormat=e},setDrawValues:function(e){this.drawValues=e},isDrawValues:function(){return this.drawValues},setColorScheme:function(e){this.colorScheme=e},setDataset:function(e){this.dataset=e,this.columnPositions.setLength(this.dataset.getColumnCount()),this.rowPositions.setLength(this.dataset.getRowCount()),this.updateRowSelectionCache(!1),this.updateColumnSelectionCache(!1)},getColumnPositions:function(){return this.columnPositions},getRowPositions:function(){return this.rowPositions},getPreferredSize:function(e){return{width:Math.ceil(this.columnPositions.getPosition(this.columnPositions.getLength()-1)+this.columnPositions.getItemSize(this.columnPositions.getLength()-1)),height:Math.ceil(this.rowPositions.getPosition(this.rowPositions.getLength()-1)+this.rowPositions.getItemSize(this.rowPositions.getLength()-1))}},prePaint:function(e,t){var r=this.lastPosition,n=this.columnPositions,i=this.rowPositions,o=morpheus.Positions.getLeft(e,n),a=morpheus.Positions.getRight(e,n),s=morpheus.Positions.getTop(e,i),l=morpheus.Positions.getBottom(e,i);(this.invalid||o!==r.left||a!==r.right||s!==r.top||l!==r.bottom)&&(r.right=a,r.left=o,r.top=s,r.bottom=l,this.invalid=!0)},postPaint:function(e,t){morpheus.CanvasUtil.resetTransform(t);var r=this.project;t.strokeStyle="Grey",t.lineWidth=1;var n=this.getRowPositions(),i=this.getColumnPositions();if(r.getHoverColumnIndex()>=0||r.getHoverRowIndex()>=0){var o=n.getItemSize(r.getHoverColumnIndex()),a=i.getItemSize(r.getHoverColumnIndex()),s=-1===r.getHoverRowIndex()?n.getPosition(n.getLength()-1):n.getPosition(r.getHoverRowIndex()),l=-1===r.getHoverColumnIndex()?i.getPosition(0):i.getPosition(r.getHoverColumnIndex());if(-1!==r.getHoverColumnIndex()&&t.strokeRect(l-e.x,0,a,this.getUnscaledHeight()),-1!==r.getHoverRowIndex()&&t.strokeRect(0,s-e.y,this.getUnscaledWidth(),o),-1!==r.getHoverColumnIndex()&&-1!==r.getHoverRowIndex()&&(t.strokeStyle="black",t.lineWidth=3,t.strokeRect(l-e.x+1.5,s-e.y+1.5,a-1.5,o-1.5),r.isSymmetric())){var u=n.getPosition(r.getHoverColumnIndex()),c=i.getPosition(r.getHoverRowIndex());t.strokeRect(c-e.x+1.5,u-e.y+1.5,a-1.5,o-1.5)}}var h=morpheus.Positions.getLeft(e,i),p=morpheus.Positions.getRight(e,i),d=morpheus.Positions.getTop(e,n),f=morpheus.Positions.getBottom(e,n);t.strokeStyle="rgb(0,0,0)",t.lineWidth=2,t.translate(-e.x,-e.y);var m=r.getElementSelectionModel().getViewIndices();null!=m&&m.forEach(function(e){var r=e.getArray()[0],o=e.getArray()[1];if(r>=d&&r<f&&o>=h&&o<p){var a=n.getItemSize(r),s=n.getPosition(r),l=i.getItemSize(o),u=i.getPosition(o);t.strokeRect(u+1.5,s+1.5,l-1.5,a-1.5)}}),t.strokeStyle="rgb(182,213,253)";var g=this.selectedRowElements,v=this.selectedColumnElements;0===g.length&&0===v.length||(0===g.length&&(g=[[d,f-1]]),0===v.length&&(v=[[h,p-1]]));var y=g.length,b=v.length;if(0!==y||0!==b)for(var w=0;w<y;w++)for(var x=g[w],_=n.getPosition(x[0]),S=(u=n.getPosition(x[1])+n.getItemSize(w),0);S<b;S++){var C=v[S],M=i.getPosition(C[0]);c=i.getPosition(C[1])+i.getItemSize(S),t.strokeRect(M,_,c-M,u-_)}if(this.selectionBox){if(t.strokeStyle="rgb(0,0,0)",t.lineWidth=2,t.setLineDash&&t.setLineDash([5]),M=i.getPosition(this.selectionBox.x[0]),(c=i.getPosition(this.selectionBox.x[1]))<M){var T=M;M=c,c=T+i.getItemSize(this.selectionBox.x[0])}else c+=i.getItemSize(this.selectionBox.x[1]);_=n.getPosition(this.selectionBox.y[0]),(u=n.getPosition(this.selectionBox.y[1]))<_?(T=_,_=u,u=T+n.getItemSize(this.selectionBox.y[0])):u+=n.getItemSize(this.selectionBox.y[1]),t.strokeRect(M,_,c-M,u-_),t.setLineDash&&t.setLineDash([]),t.lineWidth=1}},setElementDrawCallback:function(e){this.elementDrawCallback=e},setSelectionBox:function(e){this.selectionBox=e},setDrawCallback:function(e){this.drawCallback=e},draw:function(e,t){var r=this.columnPositions,n=this.rowPositions,i=morpheus.Positions.getLeft(e,r),o=morpheus.Positions.getRight(e,r),a=morpheus.Positions.getTop(e,n),s=morpheus.Positions.getBottom(e,n);t.translate(-e.x,-e.y),this._draw({left:i,right:o,top:a,bottom:s,context:t}),t.translate(e.x,e.y),this.drawCallback&&this.drawCallback({clip:e,context:t})},_draw:function(e){var t=e.left,r=e.right,n=e.top,i=e.bottom,o=e.context,a=morpheus.CanvasUtil.getFontFamily(o),s=this.columnPositions,l=this.rowPositions;morpheus.CanvasUtil.forceSubPixelRendering(o),o.textAlign="center",o.textBaseline="middle";var u,c=this.dataset,h=this.colorScheme,p=this.drawGrid,d=this.elementDrawCallback,f=null!=d,m=this.drawValues&&s.getSize()>7&&l.getSize()>7;if(m){u=this.drawValuesFormat;var g=s.getSize();o.font=g+"px "+a;var v=o.measureText("-99.9").width;g=(s.getSize()-1)/v*g,g=Math.min(g,17),o.font=g+"px "+morpheus.CanvasUtil.getFontFamily(o)}for(var y,b,w,x,_,S={},C=0;C<c.getSeriesCount();C++)S[c.getName(C)]=C;var M,T=d3.scale.linear().domain([0,1]).range([.2,1]);M="circle"===this.shape?function(e,t,r,n){o.beginPath(),o.arc(e+r/2,t+n/2,Math.min(r,n)/2,0,2*Math.PI,!1),o.fill()}:function(e,t,r,n){o.fillRect(e,t,r,n)};for(var A=n;A<i;A++)for(var E=l.getItemSize(A),P=l.getPosition(A),R=t;R<r;R++){var I=s.getItemSize(R),N=s.getPosition(R),D=c.getValue(A,R);if(o.fillStyle=h.getColor(A,R,D),R===t){w=null!=(b=(y=h.getSizer()).getSeriesName())?S[b]:void 0,_=[];for(var k=0,O=(x=h.getConditions().getConditions()).length;k<O;k++)_.push(S[x[k].seriesName])}var F=0,L=0,U=E,V=I;if(void 0!==w){var B=c.getValue(A,R,w);if(!isNaN(B)){var z=T(y.valueToFraction(B));F=(E-(U*=z))/2,L=(I-(V*=z))/2}}if(x.length>0){var j=null;for(k=0,O=x.length;k<O;k++){var H=x[k],$=c.getValue(A,R,_[k]);if(!isNaN($)&&H.accept($)){j=H;break}}if(null!==j)if(null!=j.shape)if(j.inheritColor){void 0===w&&(L=1,F=1,U-=2,V-=2);var G=N+L+U/2,W=P+F+V/2;morpheus.CanvasUtil.drawShape(o,j.shape,G,W,Math.min(V,U)/2,!0)}else M(N+L,P+F,V,U),G=N+L+U/2,W=P+F+V/2,o.fillStyle=j.color,morpheus.CanvasUtil.drawShape(o,j.shape,G,W,Math.min(V,U)/4,!0);else M(N+L,P+F,V,U);else M(N+L,P+F,V,U)}else M(N+L,P+F,V,U);m&&V>7&&U>7&&!isNaN(D)&&(o.fillStyle="rgb(0,0,0)",o.fillText(u(D),N+L+V/2,P+F+U/2,V)),f&&d(o,c,A,R,N,P,I,E)}if(p&&l.getSize()>10&&s.getSize()>10){for(o.strokeStyle=this.gridColor,o.lineWidth=this.gridThickness,o.beginPath(),A=n;A<i;A++)for(E=l.getItemSize(A),P=l.getPosition(A),R=t;R<r;R++)I=s.getItemSize(R),N=s.getPosition(R),I>10&&E>10&&o.rect(N,P,I,E);o.stroke()}o.lineWidth=1}},morpheus.Util.extend(morpheus.HeatMapElementCanvas,morpheus.AbstractCanvas),morpheus.HeatMapElementCanvas.getSelectedSpans=function(e){var t=[];if(e.size()>0){var r=0,n=r,i=e.values();i.sort(function(e,t){return e===t?0:e<t?-1:1});for(var o=i.length;r<o;){var a=0===r?i[0]:i[r-1];i[r]-a>1&&(t.push([i[n],i[r-1]]),n=r),r++}0==n?t.push([i[0],i[i.length-1]]):t.push([i[n],i[r-1]])}return t},morpheus.KeyboardCharMap=["","","","CANCEL","","","HELP","","BACKSPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","Escape","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","Space","Page Up","Page Down","End","Home","Left","Up","Right","Down","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","Delete","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","Equals","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","0","1","2","3","4","5","6","7","8","9","MULTIPLY","+","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","Plus","PIPE","-","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","/","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""],morpheus.HeatMapKeyListener=function(e){var t=e.getActionManager().getActions(),r=t.filter(function(e){return null!=e.cb&&null!=e.which});t.sort(function(e,t){return(e=e.name.toLowerCase())===(t=t.name.toLowerCase())?0:e<t?-1:1});var n=e.$tabPanel;n.on("keydown",function(t){var n=t.target.tagName,i=!1,o=morpheus.Util.IS_MAC?t.metaKey:t.ctrlKey,a=(t.altKey,t.shiftKey),s=t.which,l="INPUT"===n||"SELECT"===n||"TEXTAREA"===n,u={isInputField:l,heatMap:e},c=function(t){var r=t.shiftKey||!1;if(-1!==t.which.indexOf(s)&&(void 0===t.commandKey||o===t.commandKey)&&a==r&&(void 0==t.accept||t.accept(u)))return t.cb({heatMap:e}),!0};if(l){for(h=0,p=r.length;h<p;h++)if((d=r[h]).global&&c(d)){i=!0;break}}else for(var h=0,p=r.length;h<p;h++){var d;if(c(d=r[h])){i=!0;break}}if(i)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1}),n.on("dragover.morpheus dragenter.morpheus",function(e){e.preventDefault(),e.stopPropagation()}).on("drop.morpheus",function(t){if(e.options.menu.File&&-1!==e.options.menu.File.indexOf("Open")&&t.originalEvent.dataTransfer&&t.originalEvent.dataTransfer.files.length){t.preventDefault(),t.stopPropagation();for(var r=t.originalEvent.dataTransfer.files,n=0;n<r.length;n++)morpheus.HeatMap.showTool(new morpheus.OpenFileTool({file:r[n]}),e)}}),n.on("mousewheel",function(t){var r=t.deltaY*t.deltaFactor,n=t.deltaX*t.deltaFactor,i=!1;if(t.altKey)e.zoom(r>0,{rows:!0,columns:!0}),i=!0;else{if(0!==r){var o=e.scrollTop();e.scrollTop(o-r)!==o&&(i=!0)}if(0!==n){var a=e.scrollLeft();e.scrollLeft(a+n)!==a&&(i=!0)}}i&&e.options.standalone&&(t.preventDefault(),t.stopPropagation())}),this.showKeyMapReference=function(){var e=[];e.push('<table class="table table-condensed">'),t.forEach(function(t){e.push("<tr><td>"),e.push(function(e){var t=["<b>"];return e.commandKey&&t.push(morpheus.Util.COMMAND_KEY),e.shiftKey&&t.push("Shift+"),e.which&&t.push(morpheus.KeyboardCharMap[e.which[0]]),t.push("</b>"),t.join("")}(t)),e.push("</td><td>"),t.icon&&e.push('<span class="'+t.icon+'"></span> '),e.push(t.name),e.push("</td></tr>")}),e.push("</table>"),morpheus.FormBuilder.showInModal({title:"Keyboard Shortcuts",html:e.join(""),focus:document.activeElement})}},morpheus.HeatMapOptions=function(e){var t=[{name:"color_by",required:!0,help:"Use a different color scheme for distinct row annotation values",type:"select",options:["(None)"].concat(morpheus.MetadataUtil.getMetadataNames(e.getProject().getFullDataset().getRowMetadata())),value:e.heatmap.getColorScheme().getSeparateColorSchemeForRowMetadataField()},{name:"color_by_value",required:!0,type:"select",options:[]}];t.push({name:"shape",required:!0,type:"select",options:["square","circle"],value:e.heatmap.getShape()}),t.push({type:"separator"}),t.push({name:"size_by",required:!0,type:"select",options:["(None)"].concat(morpheus.DatasetUtil.getSeriesNames(e.getProject().getFullDataset()))}),t.push({name:"size_by_minimum",title:"Size by minimum",required:!0,type:"text",style:"max-width: 100px;"}),t.push({name:"size_by_maximum",title:"Size by maximum",required:!0,type:"text",style:"max-width: 100px;"}),t.push({type:"separator"}),t.push({name:"conditional_rendering",required:!0,type:"button"}),t.push({type:"separator"});var r=function(){var e=[{name:"relative",value:"relative"},{name:"binary",value:"binary"},{name:"MAF",value:"MAF"},{name:"fixed (-1.5, -0.1, 0.1, 1.5)",value:"cn"}],t=[];return"undefined"!=typeof localStorage&&null!=localStorage.getItem("morpheus-colorScheme")&&(t=_.keys(JSON.parse(localStorage.getItem("morpheus-colorScheme")))),t.length>0&&(e.push({divider:!0}),e=e.concat(t)),e.push({divider:!0}),e.push("My Computer..."),e};t.push([{name:"saved_color_scheme",required:!0,type:"bootstrap-select",options:r()},{name:"load_color_scheme",type:"button"},{name:"delete_color_scheme",type:"button"}]),t.push({name:"save_color_scheme",type:"button"});var n=[{disabled:e.getProject().getFullDataset().getColumnCount()!==e.getProject().getFullDataset().getRowCount(),name:"link_rows_and_columns",help:"For square matrices",required:!0,type:"checkbox",style:"max-width: 100px;",value:e.getProject().isSymmetric()},{name:"show_row_number",required:!0,type:"checkbox",value:e.isShowRowNumber()},{name:"show_grid",required:!0,type:"checkbox",value:e.heatmap.isDrawGrid()},{name:"grid_thickness",required:!0,type:"text",style:"max-width: 100px;",value:morpheus.Util.nf(e.heatmap.getGridThickness())},{name:"grid_color",required:!0,type:"color",style:"max-width: 50px;",value:e.heatmap.getGridColor()},{name:"row_size",required:!0,type:"text",style:"max-width: 100px;",value:morpheus.Util.nf(e.heatmap.getRowPositions().getSize())},{name:"column_size",required:!0,type:"text",style:"max-width: 100px;",value:morpheus.Util.nf(e.heatmap.getColumnPositions().getSize())},{name:"show_values",required:!0,type:"checkbox",value:e.heatmap.isDrawValues()},{name:"number_of_fraction_digits",required:!0,type:"number",min:0,step:1,style:"max-width: 100px;",value:morpheus.Util.getNumberFormatPatternFractionDigits(e.heatmap.getDrawValuesFormat().toJSON().pattern)}];e.rowDendrogram&&n.push({name:"row_dendrogram_line_thickness",required:!0,type:"text",style:"max-width: 100px;",value:morpheus.Util.nf(e.rowDendrogram?e.rowDendrogram.lineWidth:1)}),e.columnDendrogram&&n.push({name:"column_dendrogram_line_thickness",required:!0,type:"text",style:"max-width: 100px;",value:morpheus.Util.nf(e.columnDendrogram?e.columnDendrogram.lineWidth:1)}),n.push({name:"info_window",required:!0,type:"select",style:"max-width:130px;",options:[{name:"Fixed To Top",value:0},{name:"New Window",value:1}],value:e.tooltipMode}),n.push({name:"inline_tooltip",required:!0,type:"checkbox",value:e.options.inlineTooltip});var i=new morpheus.FormBuilder;_.each(t,function(e){i.append(e)});var o=new morpheus.FormBuilder;_.each(n,function(e){o.append(e)});var a=new morpheus.HeatMapColorSchemeChooser({showRelative:!0,colorScheme:e.heatmap.getColorScheme()}),s=!1;function l(){e.heatmap.getColorScheme().getSizer&&null!=e.heatmap.getColorScheme().getSizer()&&(i.setValue("size_by",e.heatmap.getColorScheme().getSizer().getSeriesName()),i.setEnabled("size_by_minimum",null!=e.heatmap.getColorScheme().getSizer().getSeriesName()),i.setEnabled("size_by_maximum",null!=e.heatmap.getColorScheme().getSizer().getSeriesName()),s||(i.setValue("size_by_minimum",e.heatmap.getColorScheme().getSizer().getMin()),i.setValue("size_by_maximum",e.heatmap.getColorScheme().getSizer().getMax())))}function u(t){var r=[],n={};return _.each(e.getVisibleTrackNames(t),function(e){n[e]=!0}),_.each(morpheus.MetadataUtil.getMetadataNames(t?e.getProject().getFullDataset().getColumnMetadata():e.getProject().getFullDataset().getRowMetadata()),function(e){r.push(e)}),{type:"bootstrap-select",search:r.length>10,name:t?"column_annotations":"row_annotations",multiple:!0,value:n,options:r,toggle:!0}}a.on("change",function(){l(),e.heatmap.setInvalid(!0),e.heatmap.repaint(),a.restoreCurrentValue()});var c=new morpheus.FormBuilder;function h(t,r){var n=[];_.each(e.getVisibleTrackNames(r),function(e){n.push(e)});var i=t.val(),o=_.difference(i,n),s=_.difference(n,i),l=[];_.each(o,function(e){l.push({name:e,isColumns:r,visible:!0})}),_.each(s,function(e){l.push({name:e,isColumns:r,visible:!1})}),e.setTrackVisibility(l),a.restoreCurrentValue()}c.append(u(!1)),c.append(u(!0));var p=c.$form.find("[name=column_annotations]");p.on("change",function(e){h($(this),!0)});var d=c.$form.find("[name=row_annotations]");d.on("change",function(e){h($(this),!1)});var f=_.uniqueId("morpheus"),m=_.uniqueId("morpheus"),g=_.uniqueId("morpheus"),v=$('<div class="tab-pane" id="'+f+'"></div>');v.append($(c.$form));var y=$('<div class="tab-pane active" id="'+m+'"></div>');y.append(a.$div),y.append($(i.$form));var b=$('<div class="tab-pane" id="'+g+'"></div>');b.append($(o.$form)),o.setEnabled("grid_thickness",e.heatmap.isDrawGrid()),o.setEnabled("grid_color",e.heatmap.isDrawGrid()),o.$form.find("[name=show_grid]").on("click",function(t){var r=$(this).prop("checked");o.setEnabled("grid_thickness",r),o.setEnabled("grid_color",r),e.heatmap.setDrawGrid(r),e.revalidate(),a.restoreCurrentValue()});var w=o.$form.find("[name=number_of_fraction_digits]");o.$form.find("[name=show_values]").on("click",function(t){var r=$(this).prop("checked");e.heatmap.setDrawValues(r),e.revalidate(),a.restoreCurrentValue()}),w.on("keyup input",_.debounce(function(){var t=parseInt($(this).val());t>=0&&(e.heatmap.setDrawValuesFormat(morpheus.Util.createNumberFormat("."+t+"f")),e.heatmap.setInvalid(!0),e.heatmap.repaint())},100)),o.$form.find("[name=inline_tooltip]").on("click",function(t){e.options.inlineTooltip=$(this).prop("checked")}),o.$form.find("[name=grid_color]").on("change",function(t){var r=$(this).val();e.heatmap.setGridColor(r),e.heatmap.setInvalid(!0),e.heatmap.repaint()}),o.$form.find("[name=grid_thickness]").on("keyup",_.debounce(function(t){var r=parseFloat($(this).val());isNaN(r)||(e.heatmap.setGridThickness(r),e.heatmap.setInvalid(!0),e.heatmap.repaint())},100)),o.$form.find("[name=row_size]").on("keyup",_.debounce(function(t){var r=parseFloat($(this).val());isNaN(r)||(e.heatmap.getRowPositions().setSize(r),e.revalidate(),a.restoreCurrentValue())},100)),o.$form.find("[name=info_window]").on("change",function(t){e.setTooltipMode(parseInt($(this).val()))}),o.find("link_rows_and_columns").on("click",function(t){$(this).prop("checked")?e.getProject().setSymmetric(e):e.getProject().setSymmetric(null)}),o.find("show_row_number").on("click",function(t){var r=$(this).prop("checked");e.setShowRowNumber(r),e.revalidate()});var x=i.$form.find("[name=color_by_value]"),S=e.heatmap.getColorScheme().getSeparateColorSchemeForRowMetadataField();if(null!=S){var C=e.project.getFullDataset().getRowMetadata().getByName(S);null!=C&&x.html(morpheus.Util.createOptions(morpheus.VectorUtil.createValueToIndexMap(C).keys()))}null!=S&&a.setCurrentValue(x.val()),e.heatmap.getColorScheme().getSizer&&null!=e.heatmap.getColorScheme().getSizer()&&e.heatmap.getColorScheme().getSizer().getSeriesName()&&i.setValue("size_by",e.heatmap.getColorScheme().getSizer().getSeriesName()),i.$form.find("[name=size_by]").on("change",function(e){var t=$(this).val();"(None)"==t&&(t=null),a.colorScheme.getSizer().setSeriesName(t),a.fireChanged()}),i.$form.find("[name=size_by_minimum]").on("keyup",_.debounce(function(e){s=!0,a.colorScheme.getSizer().setMin(parseFloat($(this).val())),a.fireChanged(!0),s=!1},100)),i.$form.find("[name=size_by_maximum]").on("keyup",_.debounce(function(e){s=!0,a.colorScheme.getSizer().setMax(parseFloat($(this).val())),a.fireChanged(!0),s=!1},100)),i.$form.find("[name=conditional_rendering]").on("click",function(t){t.preventDefault();var r=new morpheus.ConditionalRenderingUI(e);morpheus.FormBuilder.showInModal({title:"Conditional Rendering",html:r.$div,close:"Close",modalClass:"morpheus-sub-modal"})}),i.find("save_color_scheme").on("click",function(t){t.preventDefault();var n=new morpheus.FormBuilder;n.append({name:"save_to",type:"radio",value:"Browser Storage",options:["Browser Storage","File"]}),n.append({name:"color_scheme_name",type:"text"}),n.append({name:"file_name",type:"text"}),n.setVisible("file_name",!1),n.find("save_to").on("change",function(){var e="Browser Storage"===$(this).val();n.setVisible("file_name",!e),n.setVisible("color_scheme_name",e)}),morpheus.FormBuilder.showOkCancel({title:"Save Color Scheme",ok:!0,cancel:!0,draggable:!0,content:n.$form,appendTo:e.getContentEl(),align:"right",okCallback:function(){var t=JSON.stringify(e.heatmap.getColorScheme().toJSON());if("Browser Storage"===n.getValue("save_to")){""===(a=n.getValue("color_scheme_name").trim())&&(a="my color scheme");var o=localStorage.getItem("morpheus-colorScheme");(o=null==o?{}:JSON.parse(o))[a]=t,localStorage.setItem("morpheus-colorScheme",JSON.stringify(o)),i.setOptions("saved_color_scheme",r())}else{var a;""===(a=n.getValue("file_name").trim())&&(a="color_scheme.json");var s=new Blob([t],{type:"application/json"});saveAs(s,a)}},focus:e.getFocusEl()})}),i.setEnabled("delete_color_scheme",!1),i.find("delete_color_scheme").on("click",function(){var e=i.getValue("saved_color_scheme"),t=JSON.parse(localStorage.getItem("morpheus-colorScheme"));delete t[e],localStorage.setItem("morpheus-colorScheme",JSON.stringify(t)),i.setOptions("saved_color_scheme",r())}),i.find("saved_color_scheme").on("change",function(){i.setEnabled("delete_color_scheme",-1===["relative","cn","MAF","binary","My Computer..."].indexOf(i.getValue("saved_color_scheme")))}),i.find("load_color_scheme").on("click",function(t){var r=i.getValue("saved_color_scheme"),n=!0;if("relative"===r)e.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(morpheus.HeatMapColorScheme.Predefined.RELATIVE()));else if("cn"===r)e.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(morpheus.HeatMapColorScheme.Predefined.CN()));else if("MAF"===r)e.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(morpheus.HeatMapColorScheme.Predefined.MAF()));else if("binary"===r)e.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(morpheus.HeatMapColorScheme.Predefined.BINARY()));else if("My Computer..."===r){n=!1;var o=$('<input style="display:none;" type="file">');o.appendTo(e.getContentEl()),o.click(),o.on("change",function(t){t.target.files,morpheus.Util.getText(t.target.files[0]).then(function(t){var r=JSON.parse($.trim(t));e.heatmap.getColorScheme().fromJSON(r),a.setColorScheme(e.heatmap.getColorScheme()),e.heatmap.setInvalid(!0),e.heatmap.repaint()}).catch(function(){morpheus.FormBuilder.showInModal({title:"Error",html:"Unable to read color scheme."})}).finally(function(){o.remove()})})}else{var s=JSON.parse(localStorage.getItem("morpheus-colorScheme")),l=JSON.parse(s[r]);e.heatmap.getColorScheme().fromJSON(l)}n&&(a.setColorScheme(e.heatmap.getColorScheme()),e.heatmap.setInvalid(!0),e.heatmap.repaint()),a.restoreCurrentValue()}),i.$form.find("[name=color_by]").on("change",function(t){var r=$(this).val();"(None)"==r&&(r=null);var n=null;e.heatmap.getColorScheme().setSeparateColorSchemeForRowMetadataField(r),null!=r?(x.html(morpheus.Util.createOptions(morpheus.VectorUtil.createValueToIndexMap(e.project.getFullDataset().getRowMetadata().getByName(r)).keys())),n=x.val()):x.html(""),e.heatmap.getColorScheme().setCurrentValue(n),a.setCurrentValue(n),e.heatmap.setInvalid(!0),e.heatmap.repaint(),a.setColorScheme(e.heatmap.getColorScheme())}),i.$form.find("[name=shape]").on("change",function(t){e.heatmap.setShape($(this).val()),e.heatmap.setInvalid(!0),e.heatmap.repaint()}),x.on("change",function(t){null==e.heatmap.getColorScheme().getSeparateColorSchemeForRowMetadataField()?(a.setCurrentValue(null),e.heatmap.getColorScheme().setCurrentValue(null),a.setColorScheme(e.heatmap.getColorScheme())):(a.setCurrentValue(x.val()),a.setColorScheme(e.heatmap.getColorScheme()))}),o.$form.find("[name=column_size]").on("keyup",_.debounce(function(t){e.heatmap.getColumnPositions().setSize(parseFloat($(this).val())),e.revalidate(),a.restoreCurrentValue()},100)),o.$form.find("[name=row_gap_size]").on("keyup",_.debounce(function(t){e.rowGapSize=parseFloat($(this).val()),e.revalidate(),a.restoreCurrentValue()},100)),o.$form.find("[name=column_gap_size]").on("keyup",_.debounce(function(t){e.columnGapSize=parseFloat($(this).val()),e.revalidate(),a.restoreCurrentValue()},100)),o.$form.find("[name=squish_factor]").on("keyup",_.debounce(function(t){var r=parseFloat($(this).val());e.heatmap.getColumnPositions().setSquishFactor(r),e.heatmap.getRowPositions().setSquishFactor(r),e.revalidate(),a.restoreCurrentValue()},100)),o.$form.find("[name=row_dendrogram_line_thickness]").on("keyup",_.debounce(function(t){e.rowDendrogram.lineWidth=parseFloat($(this).val()),e.revalidate(),a.restoreCurrentValue()},100)),o.$form.find("[name=column_dendrogram_line_thickness]").on("keyup",_.debounce(function(t){e.columnDendrogram.lineWidth=parseFloat($(this).val()),e.revalidate(),a.restoreCurrentValue()},100));var M=$('<div class="tab-content"></div>');v.appendTo(M),y.appendTo(M),b.appendTo(M);var T=$("<div></div>"),A=$('<ul class="nav nav-tabs" role="tablist"><li><a href="#'+f+'" role="tab" data-toggle="tab">Annotations</a></li><li><a href="#'+m+'" role="tab" data-toggle="tab">Color Scheme</a></li><li><a href="#'+g+'" role="tab" data-toggle="tab">Display</a></li></ul>');A.appendTo(T),M.appendTo(T),a.setColorScheme(e.heatmap.getColorScheme()),l(),A.find("[role=tab]:eq(1)").tab("show"),morpheus.FormBuilder.showInModal({title:"Options",html:T,close:"Close",focus:e.getFocusEl(),onClose:function(){T.find("input").off("keyup"),p.off("change"),d.off("change"),T.remove(),a.dispose()}})},morpheus.HeatMapSizer=function(){this.seriesName=null,this.sizeByScale=d3.scale.linear().domain([this.min,this.max]).range([0,1]).clamp(!0)},morpheus.HeatMapSizer.prototype={min:0,max:1,copy:function(){var e=new morpheus.HeatMapSizer;return e.seriesName=this.seriesName,e.min=this.min,e.max=this.max,e.sizeByScale=this.sizeByScale.copy(),e},valueToFraction:function(e){return this.sizeByScale(e)},setMin:function(e){this.min=e,this.sizeByScale=d3.scale.linear().domain([this.min,this.max]).range([0,1]).clamp(!0)},setMax:function(e){this.max=e,this.sizeByScale=d3.scale.linear().domain([this.min,this.max]).range([0,1]).clamp(!0)},getMin:function(){return this.min},getMax:function(){return this.max},getSeriesName:function(){return this.seriesName},setSeriesName:function(e){this.seriesName=e}},morpheus.HeatMapToolBar=function(e){this.heatMap=e,this.rowSearchResultModelIndices=[],this.columnSearchResultModelIndices=[];var t=this,r=['<div class="hidden-print">'];r.push('<div data-name="toolbar"></div>'),r.push('<div data-name="tip" style="white-space:nowrap; border-top: thin solid #e7e7e7;margin-bottom:2px;height: 14px; font-size: 10px;overflow:hidden;"></div>'),r.push("</div>");var n=$(r.join("")),i=[],o=$('<form style="display:inline-block;margin-right:14px;" name="searchForm" class="form form-inline morpheus-form-compact" role="search"></form>');function a(e,t){i.push('<div style="display:inline-block;" data-name="'+e+'">'),i.push('<div class="form-group">'),i.push('<input type="text" class="form-control input-sm" autocomplete="off" name="search">'),i.push("</div>"),i.push('<div class="form-group">'),i.push('<span data-name="searchResultsWrapper" style="display:none;">'),i.push('<span style="font-size:12px;" data-name="searchResults"></span>'),t&&(i.push('<button name="previousMatch" type="button" class="btn btn-default btn-xxs" data-toggle="tooltip" title="Previous"><i class="fa fa-chevron-up"></i></button>'),i.push('<button name="nextMatch" type="button" class="btn btn-default btn-xxs" data-toggle="tooltip" title="Next"><i class="fa fa-chevron-down"></i></button>'),i.push('<button name="matchesToTop" type="button" class="btn btn-default btn-xxs" data-toggle="tooltip" title="Matches To Top"><i class="fa fa-level-up"></i></button>')),i.push("</span>"),i.push("</div>"),i.push("</div>"),i.push("</div>")}o.on("submit",function(e){e.preventDefault()}),i.push('<div title="Toggle Search ('+morpheus.Util.COMMAND_KEY+'/)" class="btn-group" data-toggle="buttons">'),i.push('<label class="btn btn-default btn-xxs">'),i.push('<input data-search="rows" type="radio" autocomplete="off" name="searchToggle" type="button"> Rows'),i.push("</label>"),i.push('<label class="btn btn-default btn-xxs">'),i.push('<input data-search="columns" type="radio" autocomplete="off" name="searchToggle"> Columns'),i.push("</label>"),i.push('<label class="btn btn-default btn-xxs">'),i.push('<input data-search="values" type="radio" autocomplete="off" name="searchToggle"> Values'),i.push("</label>"),i.push('<label class="btn btn-default btn-xxs">'),i.push('<input data-search="rowDendrogram" type="radio" autocomplete="off" name="searchToggle"> Row Dendrogram'),i.push("</label>"),i.push('<label class="btn btn-default btn-xxs">'),i.push('<input data-search="columnDendrogram" type="radio" autocomplete="off" name="searchToggle"> Column Dendrogram'),i.push("</label>"),i.push("</div>"),void 0===e.options.toolbar.indexOf&&(e.options.toolbar.indexOf=function(){return-1});var s=-1!==e.options.toolbar.indexOf("Search Rows"),l=-1!==e.options.toolbar.indexOf("Search Columns"),u=-1!==e.options.toolbar.indexOf("Search Values");(s||l||u)&&(i.push('<div style="display:inline-block;" class="dropdown">'),i.push('<button type="button" class="btn btn-default btn-xxs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <span class="fa fa-caret-down"></span></button>'),i.push('<ul data-name="searchOptions" class="dropdown-menu">'),i.push('<li><a data-group="matchMode" data-name="exact" href="#"><span data-type="toggle"></span>Exact Match</a></li>'),i.push('<li><a data-group="matchMode" data-name="contains" href="#"><span data-type="toggle" class="dropdown-checkbox fa fa-check"></span>Contains</a></li>'),i.push('<li role="separator" class="divider"></li>'),i.push('<li><a data-group="searchMode" data-name="matchAny" href="#"><span data-type="toggle" class="dropdown-checkbox fa fa-check"></span>Match Any Search Term</a></li>'),i.push('<li><a data-group="searchMode" data-name="matchAll" href="#"><span data-type="toggle"></span>Match All Search Terms</a></li>'),i.push('<li role="separator" class="divider"></li>'),i.push('<li><a data-name="searchHelp" href="#">Help</a></li>'),i.push("</ul>"),i.push("</div>")),s&&a("searchRowsGroup",!0),l&&a("searchColumnsGroup",!0),u&&a("searchValuesGroup",!1),a("searchRowDendrogramGroup",!1),a("searchColumnDendrogramGroup",!1),-1!==e.options.toolbar.indexOf("Dimensions")&&(i.push('<div class="form-group">'),i.push('<h6 style="display: inline; margin-left:10px;" data-name="dim"></h6>'),i.push('<h6 style="display: inline; margin-left:10px;" data-name="selection"></h6>'),i.push("</div>")),$(i.join("")).appendTo(o);var c=n.find("[data-name=toolbar]");morpheus.Util.isNode()||e.menu.applicationMenu.appendTo(c),o.appendTo(c);var h=['<div style="display: inline;">'];if(h.push('<div class="morpheus-button-divider"></div>'),-1!==e.options.toolbar.indexOf("Zoom")){var p=_.uniqueId("morpheus");h.push('<div style="display:inline-block;" class="dropdown">'),h.push('<a class="dropdown-toggle morpheus-black-link" type="button" id="'+p+'" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'),h.push('<button type="button" class="btn btn-default btn-xxs"><span class="fa fa-search-plus"></span>'),h.push(' <span style="font-size: .8em;" class="fa fa-caret-down"></span>'),h.push("</button>"),h.push('<ul style="width:200px;" class="dropdown-menu" aria-labelledby="'+p+'">'),h.push('<li><a class="morpheus-menu-item" href="#" data-action="Zoom In">Zoom In<span class="pull-right">+</span></a></li>'),h.push('<li><a class="morpheus-menu-item" href="#" data-action="Zoom Out">Zoom Out<span class="pull-right">-</span></a></li>'),h.push('<li role="separator" class="divider"></li>'),h.push('<li><a class="morpheus-menu-item" href="#" data-action="Fit To Window">Fit To Window<span class="fa fa-compress morpheus-menu-item-icon"></span><span class="pull-right">'+morpheus.Util.COMMAND_KEY+morpheus.KeyboardCharMap[e.getActionManager().getAction("Fit To Window").which[0]]+"</span> </a></li>"),h.push('<li><a class="morpheus-menu-item" href="#" data-action="Fit Rows To Window">Fit Rows To Window</a></li>'),h.push('<li><a class="morpheus-menu-item" href="#" data-action="Fit Columns To Window">Fit Columns To Window</a></li>'),h.push('<li role="separator" class="divider"></li>'),h.push('<li><a class="morpheus-menu-item" href="#" data-action="100%">100%<span class="fa fa-compress morpheus-menu-item-icon"></span><span class="pull-right">'+morpheus.Util.SHIFT_KEY+morpheus.Util.COMMAND_KEY+morpheus.KeyboardCharMap[e.getActionManager().getAction("100%").which[0]]+"</span> </a></li>"),h.push("</ul>"),h.push("</div>")}h.push('<div class="morpheus-button-divider"></div>'),-1!==e.options.toolbar.indexOf("Options")&&h.push('<button data-action="Options" data-toggle="tooltip" title="Options" type="button" class="btn btn-default btn-xxs"><span class="fa fa-cog"></span></button>'),h.push('<div class="morpheus-button-divider"></div>'),-1!==e.options.toolbar.indexOf("Save Image")&&h.push('<button data-action="Save Image" data-toggle="tooltip" title="Save Image ('+morpheus.Util.COMMAND_KEY+'S)" type="button" class="btn btn-default btn-xxs"><span class="fa fa-file-image-o"></span></button>'),h.push('<div class="morpheus-button-divider"></div>'),-1!==e.options.toolbar.indexOf("Filter")&&h.push('<button data-action="Filter" data-toggle="tooltip" title="Filter" type="button" class="btn btn-default btn-xxs"><span class="fa fa-filter"></span></button>'),-1!==e.options.toolbar.indexOf("Color Key")&&(h.push('<div class="morpheus-button-divider"></div>'),h.push('<div class="btn-group">'),h.push('<button type="button" class="btn btn-default btn-xxs" data-toggle="dropdown"><span title="Color Key" data-toggle="tooltip" class="fa fa-key"></span></button>'),h.push('<ul data-name="key" class="dropdown-menu" role="menu">'),h.push('<li data-name="keyContent"></li>'),h.push("</ul>"),h.push("</div>")),h.push("</div>");var d=$(h.join(""));d.find("[data-action]").on("click",function(t){t.preventDefault(),e.getActionManager().execute($(this).data("action"))}).on("blur",function(t){document.activeElement===document.body&&e.focus()}),morpheus.Util.isNode()||e.menu.applicationMenu.on("click","li > a",function(t){t.preventDefault(),e.getActionManager().execute($(this).data("action"))}).on("blur",function(t){document.activeElement===document.body&&e.focus()}),e.options.toolbar.$customButtons&&e.options.toolbar.$customButtons.appendTo(d),d.appendTo(c),n.prependTo(e.$content),this.$tip=n.find("[data-name=tip]"),n.find('[data-toggle="tooltip"]').tooltip({placement:"bottom",container:"body",trigger:"hover"}).on("click",function(){$(this).tooltip("hide")});var f=n.find("[data-name=key]"),m=n.find("[data-name=keyContent]");f.dropdown().parent().on("show.bs.dropdown",function(){new morpheus.HeatMapColorSchemeLegend(e,m),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"colorKey"})});var g=[];g.push("<h4>Symbols</h4>"),g.push('<table class="table table-bordered">'),g.push("<tr><th>Term</th><th>Description</th></tr>"),g.push('<tr><td><code><strong>*</strong></code></td><td>Quote a search term for an exact match. <br />Example: <code><strong>"root beer"</strong></code></td></tr>'),g.push("<tr><td><code><strong>-</strong></code></td><td>Exclude matches using - modifier.</td></tr>"),g.push("<tr><td><code><strong>..</strong></code></td><td>Separate numbers by two periods without spaces to see numbers that fall within a range.. <br />Example: <code><strong>1..10</strong></code></td></tr>"),g.push("<tr><td><code><strong><= < > >= =</strong></code></td><td>Perform a numeric search. <br />Example: <code><strong>>4</strong></code></td></tr>"),g.push("</table>"),g.push("<h4>Search fields</h4>"),g.push('<p>You can restrict your search to any field by typing the field name followed by a colon ":" and then the term you are looking for. For example, to search for matches containing "beer" in the beverage field, you can enter: <code><strong>beverage:beer</strong></code>'),g.push("Note that searches only include metadata fields that are displayed. You can search a hidden field by performing a field search."),g.push("<p>You can search for an exact list of values by enclosing the list of values in parentheses. For example: <code><strong>pet:(cat dog)</strong></code> searches all pets that are either cats or dogs.</p>");var v=$(g.join(""));n.find("[data-name=searchHelp]").on("click",function(t){t.preventDefault(),morpheus.FormBuilder.showInModal({title:"Search Help",html:v,appendTo:e.getContentEl(),focus:e.getFocusEl()})});var y=o.find("[data-name=searchRowsGroup]"),b=o.find("[data-name=searchColumnsGroup]"),w=o.find("[data-name=searchValuesGroup]"),x=o.find("[data-name=searchRowDendrogramGroup]"),S=o.find("[data-name=searchColumnDendrogramGroup]");this.$searchRowDendrogramGroup=x,this.$searchColumnDendrogramGroup=S,this.matchMode="contains",this.matchAllPredicates=!1;var C=o.find("[name=searchToggle]"),M={};function T(e,t,r){var n={$group:e,$search:e.find("[name=search]"),$searchResultsWrapper:e.find("[data-name=searchResultsWrapper]"),$searchResults:e.find("[data-name=searchResults]"),$previousMatch:e.find("[name=previousMatch]"),$nextMatch:e.find("[name=nextMatch]"),$matchesToTop:e.find("[name=matchesToTop]"),$toggleButton:C.filter("[data-search="+t+"]").parent()};return M[t]=n,n}var A=n.find("[data-name=searchOptions]");A.on("click","li > a",function(e){e.preventDefault();var r,n=$(this),i=n.data("group");"matchMode"===i?t.matchMode=n.data("name"):t.matchAllPredicates="matchAll"===n.data("name"),t.rowSearchObject.$search.is(":visible")?r=t.rowSearchObject.$search:t.columnSearchObject.$search.is(":visible")?r=t.rowSearchObject.$search:t.rowDendrogramSearchObject.$search.is(":visible")?r=t.rowSearchObject.$search:t.columnDendrogramSearchObject.$search.is(":visible")?r=t.rowSearchObject.$search:t.valueSearchObject.$search.is(":visible")&&(r=t.rowSearchObject.$search),r&&r.trigger($.Event("keyup",{keyCode:13,which:13}));var o=$(this).find("span");"toggle"===o.data("type")&&(A.find("[data-group="+i+"] > [data-type=toggle]").removeClass("dropdown-checkbox fa fa-check"),o.addClass("dropdown-checkbox fa fa-check")),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"searchMatchMode"})}),this.rowSearchObject=T(y,"rows"),this.columnSearchObject=T(b,"columns"),this.rowDendrogramSearchObject=T(x,"rowDendrogram"),this.columnDendrogramSearchObject=T(S,"columnDendrogram"),this.valueSearchObject=T(w,"values"),s||(this.rowSearchObject.$toggleButton.hide(),this.rowSearchObject.$group.css("display","none")),l||(this.columnSearchObject.$toggleButton.hide(),this.columnSearchObject.$group.css("display","none")),u||(this.valueSearchObject.$toggleButton.hide(),this.valueSearchObject.$group.css("display","none")),this.rowDendrogramSearchObject.$toggleButton.hide(),this.rowDendrogramSearchObject.$group.hide(),this.columnDendrogramSearchObject.$toggleButton.hide(),this.columnDendrogramSearchObject.$group.hide(),this.rowDendrogramSearchObject.$searchResultsWrapper.show(),this.columnDendrogramSearchObject.$searchResultsWrapper.show(),this.valueSearchObject.$searchResultsWrapper.show(),this.rowSearchObject.$search.css({"border-top":"3.8px solid #e6e6e6","border-bottom":"3.8px solid #e6e6e6",width:"240px"}),this.columnSearchObject.$search.css({"border-right":"3.8px solid #e6e6e6","border-left":"3.8px solid #e6e6e6",width:"240px"}),this.$valueSearchResults=w.find("[name=searchResults]"),this.$valueTextField=w.find("[name=search]"),this.$dimensionsLabel=n.find("[data-name=dim]"),this.$selectionLabel=n.find("[data-name=selection]"),C.on("change",function(e){var t=$(this).data("search");for(var r in M){var n=M[r];r===t?(n.$group.css("display","inline-block"),n.$search.focus()):n.$group.css("display","none")}}),this.toggleSearch=function(){var e=C.filter(":visible"),t=C.filter(":checked"),r=e.eq(e.index(t)+1);r.length||(r=e.first()),r.click()};for(var E=0;E<C.length;E++){var P=$(C[E]);if("block"===P.parent().css("display")){P.click();break}}e.on("dendrogramAnnotated",function(e){e.isColumns?t.rowDendrogramSearchObject.$toggleButton.show():t.columnDendrogramSearchObject.$toggleButton.show()}),e.on("dendrogramChanged",function(e){e.isColumns?(t.rowDendrogramSearchObject.$group.hide(),t.rowDendrogramSearchObject.$toggleButton.hide()):(t.columnDendrogramSearchObject.$group.hide(),t.columnDendrogramSearchObject.$toggleButton.hide())});var R=e.getProject();function u(){var e=t.$valueSearchResults,r=$.trim(t.$valueTextField.val());if(""===r)e.html(""),R.getElementSelectionModel().setViewIndices(null);else{var n=morpheus.DatasetUtil.searchValues({dataset:R.getSortedFilteredDataset(),text:r,matchAllPredicates:t.matchAllPredicates,defaultMatchMode:t.matchMode});R.getElementSelectionModel().setViewIndices(n),e.html(n.size()+" match"+(1===n.size()?"":"es"))}}morpheus.Util.autosuggest({$el:this.rowSearchObject.$search,filter:function(t,r){var n=[],i=R.getSortedFilteredDataset().getRowMetadata();e.getVisibleTrackNames(!1).forEach(function(e){var t=morpheus.MetadataUtil.indexOf(i,e);-1!==t&&n.push(t)}),i=new morpheus.MetadataModelColumnView(i,n),morpheus.MetadataUtil.autocomplete(i)(t,r)},select:function(){t.search(!0)}}),this.rowSearchObject.$search.on("keyup",_.debounce(function(e){13===e.which&&e.preventDefault(),t.search(!0),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"searchRows"})},500)),morpheus.Util.autosuggest({$el:this.columnSearchObject.$search,filter:function(t,r){var n=[],i=R.getSortedFilteredDataset().getColumnMetadata();e.getVisibleTrackNames(!0).forEach(function(e){var t=morpheus.MetadataUtil.indexOf(i,e);-1!==t&&n.push(t)}),i=new morpheus.MetadataModelColumnView(i,n),morpheus.MetadataUtil.autocomplete(i)(t,r)},select:function(){t.search(!1)}}),this.columnSearchObject.$search.on("keyup",_.debounce(function(e){13===e.which&&e.preventDefault(),t.search(!1),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"searchColumns"})},500)),morpheus.Util.autosuggest({$el:this.rowDendrogramSearchObject.$search,filter:function(t,r){var n=e.getDendrogram(!1);if(n.searchTerms){var i=null!=t&&t.length>0?t[t.selectionStartIndex]:"";""===(i=$.trim(i))?r([]):morpheus.Util.autocompleteArrayMatcher(i,r,n.searchTerms,null,10)}else r([])},select:function(){t.searchDendrogram(!1)}}),this.rowDendrogramSearchObject.$search.on("keyup",_.debounce(function(e){13===e.which&&e.preventDefault(),t.searchDendrogram(!1),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"searchRowDendrogram"})},500)),morpheus.Util.autosuggest({$el:this.columnDendrogramSearchObject.$search,filter:function(t,r){var n=e.getDendrogram(!0);if(n.searchTerms){var i=null!=t&&t.length>0?t[t.selectionStartIndex]:"";""===(i=$.trim(i))?r([]):morpheus.Util.autocompleteArrayMatcher(i,r,n.searchTerms,null,10)}else r([])},select:function(){t.searchDendrogram(!0)}}),this.columnDendrogramSearchObject.$search.on("keyup",_.debounce(function(e){13===e.which&&e.preventDefault(),t.searchDendrogram(!0),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"searchColumnDendrogram"})},500)),morpheus.Util.autosuggest({$el:this.$valueTextField,filter:function(e,t){morpheus.DatasetUtil.autocompleteValues(R.getSortedFilteredDataset())(e,t)},select:function(){u()}}),this.$valueTextField.on("keyup",_.debounce(function(e){13===e.which&&(t.$valueTextField.autocomplete("close"),e.preventDefault()),u()},500)),this.toggleControls=function(){"none"===c.css("display")?(c.css("display",""),t.rowSearchObject.$search.focus()):(c.css("display","none"),$(t.heatMap.heatmap.canvas).focus())},this.$el=n;var I=function(){e.getProject().getRowFilter().isEnabled()||e.getProject().getColumnFilter().isEnabled()?t.$el.find("[name=filterButton]").addClass("btn-primary"):t.$el.find("[name=filterButton]").removeClass("btn-primary")};I(),this.columnSearchObject.$matchesToTop.on("click",function(e){e.preventDefault();var r=$(this);r.toggleClass("btn-primary"),t.setSelectionOnTop({isColumns:!0,isOnTop:r.hasClass("btn-primary"),updateButtonStatus:!1}),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"columnMatchesToTop"})}),this.rowSearchObject.$matchesToTop.on("click",function(e){e.preventDefault();var r=$(this);r.toggleClass("btn-primary"),t.setSelectionOnTop({isColumns:!1,isOnTop:r.hasClass("btn-primary"),updateButtonStatus:!1}),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"rowMatchesToTop"})}),R.on("rowSortOrderChanged.morpheus",function(e){t.searching||(t._updateSearchIndices(!1),t.rowSearchObject.$matchesToTop.removeClass("btn-primary"))}),R.on("columnSortOrderChanged.morpheus",function(e){t.searching||(t._updateSearchIndices(!0),t.columnSearchObject.$matchesToTop.removeClass("btn-primary"))}),e.getProject().on("rowFilterChanged.morpheus",function(e){t.search(!0),I()}),e.getProject().on("columnFilterChanged.morpheus",function(e){t.search(!1),I()}),e.getProject().on("datasetChanged.morpheus",function(){t.search(!0),t.search(!1),I()}),e.getProject().getRowSelectionModel().on("selectionChanged.morpheus",function(){t.updateSelectionLabel()}),e.getProject().getColumnSelectionModel().on("selectionChanged.morpheus",function(){t.updateSelectionLabel()}),this.rowSearchResultViewIndicesSorted=null,this.currentRowSearchIndex=0,this.columnSearchResultViewIndicesSorted=null,this.currentColumnSearchIndex=-1,this.columnSearchObject.$previousMatch.on("click",function(){t.currentColumnSearchIndex--,t.currentColumnSearchIndex<0&&(t.currentColumnSearchIndex=t.columnSearchResultViewIndicesSorted.length-1),e.scrollLeft(e.getHeatMapElementComponent().getColumnPositions().getPosition(t.columnSearchResultViewIndicesSorted[t.currentColumnSearchIndex])),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"previousColumnMatch"})}),this.rowSearchObject.$previousMatch.on("click",function(){t.currentRowSearchIndex--,t.currentRowSearchIndex<0&&(t.currentRowSearchIndex=t.rowSearchResultViewIndicesSorted.length-1),e.scrollTop(e.getHeatMapElementComponent().getRowPositions().getPosition(t.rowSearchResultViewIndicesSorted[t.currentRowSearchIndex])),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"previousRowMatch"})}),this.columnSearchObject.$nextMatch.on("click",function(){t.next(!0),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"nextColumnMatch"})}),this.rowSearchObject.$nextMatch.on("click",function(){t.next(!1),morpheus.Util.trackEvent({eventCategory:"ToolBar",eventAction:"nextRowMatch"})}),this.updateDimensionsLabel(),this.updateSelectionLabel()},morpheus.HeatMapToolBar.HIGHLIGHT_SEARCH_MODE=0,morpheus.HeatMapToolBar.FILTER_SEARCH_MODE=1,morpheus.HeatMapToolBar.MATCHES_TO_TOP_SEARCH_MODE=2,morpheus.HeatMapToolBar.SELECT_MATCHES_SEARCH_MODE=3,morpheus.HeatMapToolBar.prototype={quickColumnFilter:!1,searching:!1,rowSearchMode:morpheus.HeatMapToolBar.SELECT_MATCHES_SEARCH_MODE,columnSearchMode:morpheus.HeatMapToolBar.SELECT_MATCHES_SEARCH_MODE,_updateSearchIndices:function(e){var t=this.heatMap.getProject();if(e){for(var r=[],n=0,i=(o=this.columnSearchResultModelIndices).length;n<i;n++)-1!==(a=t.convertModelColumnIndexToView(o[n]))&&r.push(a);r.sort(function(e,t){return e<t?-1:1}),this.columnSearchResultViewIndicesSorted=r,this.currentColumnSearchIndex=-1}else{var o;for(r=[],n=0,i=(o=this.rowSearchResultModelIndices).length;n<i;n++){var a;-1!==(a=t.convertModelRowIndexToView(o[n]))&&r.push(a)}r.sort(function(e,t){return e<t?-1:1}),this.rowSearchResultViewIndicesSorted=r,this.currentRowSearchIndex=-1}},next:function(e){var t=this.heatMap;e?(this.currentColumnSearchIndex++,this.currentColumnSearchIndex>=this.columnSearchResultViewIndicesSorted.length&&(this.currentColumnSearchIndex=0),t.scrollLeft(t.getHeatMapElementComponent().getColumnPositions().getPosition(this.columnSearchResultViewIndicesSorted[this.currentColumnSearchIndex]))):(this.currentRowSearchIndex++,this.currentRowSearchIndex>=this.rowSearchResultViewIndicesSorted.length&&(this.currentRowSearchIndex=0),t.scrollTop(t.getHeatMapElementComponent().getRowPositions().getPosition(this.rowSearchResultViewIndicesSorted[this.currentRowSearchIndex])))},getSearchField:function(e){return e===morpheus.HeatMapToolBar.COLUMN_SEARCH_FIELD?this.columnSearchObject.$search:e===morpheus.HeatMapToolBar.ROW_SEARCH_FIELD?this.rowSearchObject.$search:e===morpheus.HeatMapToolBar.COLUMN_DENDROGRAM_SEARCH_FIELD?this.columnDendrogramSearchObject.$search:e===morpheus.HeatMapToolBar.ROW_DENDROGRAM_SEARCH_FIELD?this.rowDendrogramSearchObject.$search:void console.log("Unknown field")},setSearchText:function(e){var t=e.isColumns?this.columnSearchObject.$search:this.rowSearchObject.$search,r=e.append?$.trim(t.val()):"";""!==r&&(r+=" "),e.onTop&&(e.isColumns?this.columnSearchObject.$matchesToTop.addClass("btn-primary"):this.rowSearchObject.$matchesToTop.addClass("btn-primary")),t.val(r+e.text),this.search(!e.isColumns),e.scrollTo&&this.next(e.isColumns)},updateDimensionsLabel:function(){var e=this.heatMap.getProject(),t=e.getFullDataset(),r=e.getSortedFilteredDataset(),n=[];r.getRowCount()!==t.getRowCount()?(n.push("<b>"),n.push(morpheus.Util.intFormat(r.getRowCount())),n.push("/"),n.push(morpheus.Util.intFormat(t.getRowCount())),n.push("</b>")):n.push(morpheus.Util.intFormat(r.getRowCount())),n.push(" rows by "),r.getColumnCount()!==t.getColumnCount()?(n.push("<b>"),n.push(morpheus.Util.intFormat(r.getColumnCount())),n.push("/"),n.push(morpheus.Util.intFormat(t.getColumnCount())),n.push("</b>")):n.push(morpheus.Util.intFormat(r.getColumnCount())),n.push(" columns"),this.$dimensionsLabel.html(n.join(""))},updateSelectionLabel:function(){var e=this.heatMap.getProject().getColumnSelectionModel().count(),t=this.heatMap.getProject().getRowSelectionModel().count(),r=[];r.push(morpheus.Util.intFormat(t)+" row"),1!==t&&r.push("s"),r.push(", "),r.push(morpheus.Util.intFormat(e)+" column"),1!==e&&r.push("s"),r.push(" selected"),this.$selectionLabel.html(r.join(""))},searchDendrogram:function(e){var t=e?this.columnDendrogramSearchObject:this.rowDendrogramSearchObject,r=$.trim(t.$search.val()),n=e?this.heatMap.columnDendrogram:this.heatMap.rowDendrogram,i=t.$searchResults,o=morpheus.DendrogramUtil.search({rootNode:n.tree.rootNode,text:r,matchAllPredicates:this.matchAllPredicates,defaultMatchMode:this.matchMode});if(-1===o?i.html(""):i.html(o+" match"+(1===o?"":"es")),o<=0){var a=e?this.heatMap.getHeatMapElementComponent().getColumnPositions():this.heatMap.getHeatMapElementComponent().getRowPositions();a.setSquishedIndices(null),e?this.heatMap.getProject().setGroupColumns([],!0):this.heatMap.getProject().setGroupRows([],!0),a.setSize(e?this.heatMap.getFitColumnSize():this.heatMap.getFitRowSize())}else morpheus.DendrogramUtil.squishNonSearchedNodes(this.heatMap,e);this.heatMap.updateDataset(),this.heatMap.revalidate()},search:function(e){this.searching=!0;var t=e?this.rowSearchObject.$matchesToTop.hasClass("btn-primary"):this.columnSearchObject.$matchesToTop.hasClass("btn-primary"),r=this.heatMap,n=r.getProject(),i=e?n.getRowSortKeys():n.getColumnSortKeys();i=i.filter(function(e){return!(e instanceof morpheus.MatchesOnTopSortKey&&"matches on top"===e.toString())});var o=n.getSortedFilteredDataset(),a=e?this.rowSearchObject.$searchResults:this.columnSearchObject.$searchResults,s=e?$.trim(this.rowSearchObject.$search.val()):$.trim(this.columnSearchObject.$search.val()),l=e?o.getRowMetadata():o.getColumnMetadata(),u=[];r.getVisibleTrackNames(!e).forEach(function(e){var t=morpheus.MetadataUtil.indexOf(l,e);-1!==t&&u.push(t)});var c=l;l=new morpheus.MetadataModelColumnView(l,u);var h=morpheus.MetadataUtil.search({model:l,fullModel:c,text:s,isColumns:!e,matchAllPredicates:this.matchAllPredicates,defaultMatchMode:this.matchMode});""===s?(a.html(""),e?this.rowSearchObject.$searchResultsWrapper.hide():this.columnSearchObject.$searchResultsWrapper.hide()):(a.html(h.length+" match"+(1===h.length?"":"es")),e?this.rowSearchObject.$searchResultsWrapper.show():this.columnSearchObject.$searchResultsWrapper.show());var p=[];if(null!=h)for(var d=0,f=h.length;d<f;d++){var m=h[d];p.push(e?n.convertViewRowIndexToModel(m):n.convertViewColumnIndexToModel(m))}if(null!==h&&t){var g=new morpheus.MatchesOnTopSortKey(n,p,"matches on top",!e);h=g.indices,i.splice(0,0,g),e?n.setRowSortKeys(i,!1):n.setColumnSortKeys(i,!1)}var v=new morpheus.Set;if(null!=h)for(d=0,f=h.length;d<f;d++)m=h[d],v.add(m);null==h&&(h=[]),e?(this.rowSearchResultModelIndices=p,this.rowSearchResultViewIndicesSorted=h.sort(function(e,t){return e<t?-1:1}),this.currentRowSearchIndex=-1):(this.columnSearchResultModelIndices=p,this.columnSearchResultViewIndicesSorted=h.sort(function(e,t){return e<t?-1:1}),this.currentColumnSearchIndex=-1),(e?n.getRowSelectionModel():n.getColumnSelectionModel()).setViewIndices(v,!0),t&&(e?n.setRowSortKeys(morpheus.SortKey.keepExistingSortKeys(i,n.getRowSortKeys()),!0):n.setColumnSortKeys(morpheus.SortKey.keepExistingSortKeys(i,n.getColumnSortKeys()),!0)),this.updateDimensionsLabel(),this.updateSelectionLabel(),this.searching=!1},isSelectionOnTop:function(e){return(e?this.columnSearchObject.$matchesToTop:this.rowSearchObject.$matchesToTop).hasClass("btn-primary")},setSelectionOnTop:function(e){if(e.updateButtonStatus){var t=e.isColumns?this.columnSearchObject.$matchesToTop:this.rowSearchObject.$matchesToTop;e.isOnTop?t.addClass("btn-primary"):t.removeClass("btn-primary")}var r=this.heatMap.getProject(),n=e.isColumns?r.getColumnSortKeys():r.getRowSortKeys();if(n=n.filter(function(e){return!(e instanceof morpheus.MatchesOnTopSortKey&&"matches on top"===e.name)}),e.isOnTop){var i=new morpheus.MatchesOnTopSortKey(r,e.isColumns?this.columnSearchResultModelIndices:this.rowSearchResultModelIndices,"matches on top");n.splice(0,0,i),e.isColumns?this.heatMap.scrollLeft(0):this.heatMap.scrollTop(0)}this.searching=!0,e.isColumns?r.setColumnSortKeys(n,!0):r.setRowSortKeys(n,!0),this._updateSearchIndices(e.isColumns),this.searching=!1}},morpheus.HeatMapToolBar.COLUMN_SEARCH_FIELD="column",morpheus.HeatMapToolBar.ROW_SEARCH_FIELD="row",morpheus.HeatMapToolBar.COLUMN_DENDROGRAM_SEARCH_FIELD="column_dendrogram",morpheus.HeatMapToolBar.ROW_DENDROGRAM_SEARCH_FIELD="row_dendrogram",morpheus.HeatMapTooltipProvider=function(e,t,r,n,i,o,a){var s=e.project.getSortedFilteredDataset();if(o||n.value&&_.each(n.value,function(e){if(a.length>0&&a.push(i),a.push(e.name),a.push(": <b>"),_.isArray(e.value))for(var t=0;t<e.value.length;t++)t>0&&a.push(", "),a.push(e.value[t]);else a.push(e.value);a.push("</b>")}),-1!==t&&-1!==r){for(var l=n.tooltipSeriesIndices?n.tooltipSeriesIndices:morpheus.Util.sequ32(s.getSeriesCount()),u=0,c=l.length;u<c;u++)morpheus.HeatMapTooltipProvider._matrixValueToString(e,s,t,r,l[u],a,i,n.showSeriesNameInTooltip||u>0),e.options.symmetric&&s.getValue(t,r,l[u])!==s.getValue(r,t,l[u])&&morpheus.HeatMapTooltipProvider._matrixValueToString(e,s,r,t,l[u],a,i,!1);if(o){var h=e.rowTracks.filter(function(e){return e.settings.inlineTooltip});morpheus.HeatMapTooltipProvider._tracksToString(h,s.getRowMetadata(),t,a,i),morpheus.HeatMapTooltipProvider._tracksToString(e.columnTracks.filter(function(e){return e.settings.inlineTooltip}),s.getColumnMetadata(),r,a,i)}}else o&&(-1!==t&&morpheus.HeatMapTooltipProvider._tracksToString(e.rowTracks.filter(function(e){return e.settings.inlineTooltip&&n.name!==e.getName()}),s.getRowMetadata(),t,a,i),-1!==r&&morpheus.HeatMapTooltipProvider._tracksToString(e.columnTracks.filter(function(e){return e.settings.inlineTooltip&&n.name!==e.getName()}),s.getColumnMetadata(),r,a,i));if(o){if(null!=n.name){var p=-1!==t?s.getRowMetadata():s.getColumnMetadata(),d=p.getByName(n.name),f=e.getTrack(n.name,-1!==r),m=null!=f?f.settings.colorByField:null,g=null!=m?p.getByName(m):null;morpheus.HeatMapTooltipProvider.vectorToString(d,-1!==t?t:r,a,i,g)}}else-1!==t&&morpheus.HeatMapTooltipProvider._metadataToString(n,e.rowTracks,s.getRowMetadata(),t,a,i),-1!==r&&morpheus.HeatMapTooltipProvider._metadataToString(n,e.columnTracks,s.getColumnMetadata(),r,a,i);var v=[],y=[],b=[],w=[];if(n.rowNodes&&(v=n.rowNodes),n.columnNodes&&(y=n.columnNodes),!o){if(e.rowDendrogram&&(b=_.values(e.rowDendrogram.selectedRootNodeIdToNode)),e.columnDendrogram&&(w=_.values(e.columnDendrogram.selectedRootNodeIdToNode)),b.length>0&&v.length>0){var x={};_.each(b,function(e){x[e.id]=!0}),v=_.filter(v,function(e){return void 0===x[e.id]})}w.length>0&&y.length>0&&(x={},_.each(w,function(e){x[e.id]=!0}),y=_.filter(y,function(e){return void 0===x[e.id]}))}morpheus.HeatMapTooltipProvider._nodesToString(a,v,null,i),morpheus.HeatMapTooltipProvider._nodesToString(a,y,null,i),o||(b.length>0&&morpheus.HeatMapTooltipProvider._nodesToString(a,b,e.rowDendrogram._selectedNodeColor,i),w.length>0&&morpheus.HeatMapTooltipProvider._nodesToString(a,w,e.columnDendrogram._selectedNodeColor,i))},morpheus.HeatMapTooltipProvider._matrixValueToString=function(e,t,r,n,i,o,a,s){var l=t.getValue(r,n,i);if(null!=l){var u=e.getHeatMapElementComponent().getDrawValuesFormat();if(l.toObject||!_.isNumber(l)){var c=l.toObject?l.toObject():l;if(morpheus.Util.isArray(c)){var h=morpheus.Util.toString(c);o.length>0&&o.push(a),s&&(o.push(t.getName(i)),o.push(": ")),o.push("<b>"),o.push(h),o.push("</b>")}else{var p=_.keys(c);if(0===p.length)h=morpheus.Util.toString(c),o.length>0&&o.push(a),s&&(o.push(t.getName(i)),o.push(": ")),o.push("<b>"),o.push(h),o.push("</b>");else{for(var d=0,f=p.length;d<f;d++){var m=p[d];if("__v"!==m){var g=c[m];h=morpheus.Util.isArray(g)?morpheus.Util.arrayToString(g,", "):morpheus.Util.toString(g),o.length>0&&o.push(a),o.push(m),o.push(": <b>"),o.push(h),o.push("</b>")}}_.isNumber(l)&&(o.push(a),o.push("Value: <b>"),o.push(u(l)),o.push("</b>"))}}}else o.length>0&&o.push(a),s&&(o.push(t.getName(i)),o.push(": ")),o.push("<b>"),o.push(u(l)),o.push("</b>")}},morpheus.HeatMapTooltipProvider.vectorToString=function(e,t,r,n,i){var o=function(e,t){if(null!=t)if(null!=e&&(r.length>0&&r.push(n),r.push(e)),t.toObject){r.push(" ");var i=t.toObject(),o=_.keys(i);_.each(o,function(e){var t=i[e];null!=t&&""!=t&&(r.length>0&&r.push(n),r.push(e),r.push(": <b>"),r.push(morpheus.Util.toString(t)),r.push("</b>"))})}else r.push(": <b>"),r.push(morpheus.Util.toString(t)),r.push("</b>")};if(null!=e){var a=e.getValue(t);if(null!=a&&""!=a){var s=e.getProperties().get(morpheus.VectorKeys.FIELDS);if(null!=s){var l=e.getProperties().get(morpheus.VectorKeys.VISIBLE_FIELDS);void 0===l&&(l=morpheus.Util.seq(s.length));var u=null!=i?i.getProperties().get(morpheus.VectorKeys.FIELDS):null,c=null!=u?i.getValue(t):null;r.length>0&&r.push(n),r.push(e.getName());for(var h=0;h<l.length;h++)o(s[l[h]],a[l[h]]);if(null!=c)for(r.length>0&&r.push(n),r.push(i.getName()),h=0;h<l.length;h++)o(u[l[h]],c[l[h]])}else if(a.summary){r.length>0&&r.push(n),r.push(e.getName()),r.push(": ");for(var p=a.summary,d=_.keys(p),f=0,m=d.length;f<m;f++){var g=d[f];if("__v"!==g){var v,y=p[g];v=morpheus.Util.isArray(y)?morpheus.Util.arrayToString(y,", "):morpheus.Util.toString(y),r.length>0&&r.push(n),r.push(g),r.push(": <b>"),r.push(v),r.push("</b>")}}}else r.length>0&&r.push(n),r.push(e.getName()),r.push(": <b>"),r.push(morpheus.Util.toString(a)),r.push("</b>")}}},morpheus.HeatMapTooltipProvider._tracksToString=function(e,t,r,n,i){for(var o=0;o<e.length;o++)morpheus.HeatMapTooltipProvider.vectorToString(t.getByName(e[o].name),r,n,i)},morpheus.HeatMapTooltipProvider._metadataToString=function(e,t,r,n,i,o){for(var a=[],s=0,l=t.length;s<l;s++){var u=t[s];u.isVisible()&&u.isShowTooltip()&&(t[s].name===e.name?a.splice(0,0,u):a.push(u))}morpheus.HeatMapTooltipProvider._tracksToString(a,r,n,i,o)},morpheus.HeatMapTooltipProvider._nodesToString=function(e,t,r,n){var i=function(t,i){if(null!=i){if(e.length>0&&e.push(n),r&&e.push('<span style="color:'+r+'">'),e.push(t),e.push(": <b>"),_.isArray(i))for(var o=0;o<i.length;o++)o>0&&e.push(", "),e.push(morpheus.Util.toString(i[o]));else e.push(morpheus.Util.toString(i));e.push("</b>"),r&&e.push("</span>")}};_.each(t,function(e){if(e.info)for(var t in e.info){var r=e.info[t];i(t,r)}i("height",e.height),i("depth",e.depth);var n=1+Math.abs(e.maxIndex-e.minIndex);n>0&&i("# of leaf nodes",n)})},morpheus.HeatMapTrackColorLegend=function(e,t){morpheus.AbstractCanvas.call(this,!1),this.tracks=e,this.colorModel=t,this.canvas.style.position=""},morpheus.HeatMapTrackColorLegend.prototype={getPreferredSize:function(){var e=this.tracks,t=this.colorModel,r=0,n=0,i=0,o=this.canvas.getContext("2d");o.font="12px "+morpheus.CanvasUtil.getFontFamily(o);for(var a=0;a<e.length;a++){n=0;var s=0,l=e[a].getVector(e[a].settings.colorByField);l.getProperties().get(morpheus.VectorKeys.DISCRETE)?t.getDiscreteColorScheme(l).forEach(function(e,t){var r=o.measureText(t).width;isNaN(r)||(s=Math.max(s,r)),n+=14}):(s=220,n+=40),r+=(s=Math.max(s,o.measureText(l.getName()).width))+10+14,i=Math.max(i,n)}return{width:r,height:i>0?i+12:0}},draw:function(e,t){for(var r=this.tracks,n=this.colorModel,i=0,o=0;o<r.length;o++){var a=0,s=r[o].getVector(r[o].settings.colorByField);t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,t.font="12px "+morpheus.CanvasUtil.getFontFamily(t),t.textAlign="left",t.textBaseline="top",t.fillText(s.getName(),i,a),t.strokeStyle="LightGrey";var l=0,u=t.measureText(s.getName()).width;if(isNaN(u)||(l=Math.max(0,u)),a+=14,s.getProperties().get(morpheus.VectorKeys.DISCRETE)){var c=morpheus.VectorTrack.vectorToString(s);n.getDiscreteColorScheme(s).keys().sort(morpheus.SortKey.ASCENDING_COMPARATOR).forEach(function(e){if(null!=e){e=c(e);var u=n.getMappedValue(s,e),h=t.measureText(e).width;isNaN(h)||(l=Math.max(l,h)),t.fillStyle=u;var p=0;r[o].isRenderAs(morpheus.VectorTrack.RENDER.COLOR)&&(t.fillRect(i,a,12,12),t.strokeRect(i,a,12,12),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,p=16),t.fillText(e,i+p,a),a+=14}})}else{var h=n.getContinuousColorScheme(s);t.save(),t.translate(i,a),morpheus.HeatMapColorSchemeLegend.drawColorScheme(t,h,200),t.restore(),l=Math.max(l,220),a+=40}i+=l+10+14}}},morpheus.Util.extend(morpheus.HeatMapTrackColorLegend,morpheus.AbstractCanvas),morpheus.HeatMapTrackFontLegend=function(e,t){morpheus.AbstractCanvas.call(this,!1),this.tracks=e,this.model=t,this.canvas.style.position=""},morpheus.HeatMapTrackFontLegend.prototype={getPreferredSize:function(){var e=this.tracks,t=this.model,r=this.canvas.getContext("2d");r.font="900 12px "+morpheus.CanvasUtil.getFontFamily(r);for(var n=0,i=0,o=0,a=0;a<e.length;a++){i=0;var s=0,l=e[a].getVector(e[a].settings.fontField);t.getMap(l.getName()).forEach(function(e,t){if(null!=e&&"400"!=e.weight){var n=r.measureText(t).width;isNaN(n)||(s=Math.max(s,n)),i+=14}}),n+=s+6,o=Math.max(o,i)}return{width:n,height:o>0?o+30:0}},draw:function(e,t){var r=this.tracks,n=this.model,i=0,o=0;t.textAlign="left",t.textBaseline="top",t.font="12px "+morpheus.CanvasUtil.getFontFamily(t),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,t.strokeStyle="black";for(var a=t.font,s=0;s<r.length;s++){o=0;var l=0,u=r[s].getVector(),c=r[s].getVector(r[s].settings.fontField);t.font=a,t.fillText(u.getName(),i,o),l=Math.max(l,t.measureText(u.getName()).width),o+=14,n.getMap(c.getName()).keys().sort(morpheus.SortKey.ASCENDING_COMPARATOR).forEach(function(e){var r=n.getMappedValue(c,e);if(null!=r&&"400"!=r.weight){t.font=r.weight+" "+a;var s=t.measureText(e).width;isNaN(s)||(l=Math.max(l,s)),t.fillText(e,i,o),o+=14}}),i+=l+6}}},morpheus.Util.extend(morpheus.HeatMapTrackFontLegend,morpheus.AbstractCanvas),morpheus.HeatMapTrackShapeLegend=function(e,t){morpheus.AbstractCanvas.call(this,!1),this.tracks=e,this.shapeModel=t,this.canvas.style.position=""},morpheus.HeatMapTrackShapeLegend.prototype={getPreferredSize:function(){for(var e=this.tracks,t=this.shapeModel,r=this.canvas.getContext("2d"),n=0,i=0,o=0,a=0;a<e.length;a++){i=0;var s=0,l=e[a].getVector();t.getMap(l.getName()).forEach(function(e,t){var n=r.measureText(t).width;isNaN(n)||(s=Math.max(s,n)),i+=14}),n+=s+24,o=Math.max(o,i)}return{width:n,height:o>0?o+30:0}},draw:function(e,t){var r=this.tracks,n=this.shapeModel,i=0,o=0;t.textAlign="left",t.textBaseline="top",t.font="12px "+morpheus.CanvasUtil.getFontFamily(t),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,t.strokeStyle="black";for(var a=0;a<r.length;a++){o=0;var s=0,l=r[a].getVector();t.fillText(l.getName(),i,o),s=Math.max(s,t.measureText(l.getName()).width),o+=14,n.getMap(l.getName()).keys().sort(morpheus.SortKey.ASCENDING_COMPARATOR).forEach(function(e){var r=n.getMappedValue(l,e),a=t.measureText(e).width;isNaN(a)||(s=Math.max(s,a)),morpheus.CanvasUtil.drawShape(t,r,i+8,o+6,6),t.fillText(e,i+16,o),o+=14}),i+=s+24}}},morpheus.Util.extend(morpheus.HeatMapTrackShapeLegend,morpheus.AbstractCanvas),morpheus.HeatMap=function(e){morpheus.Util.loadTrackingCode();for(var t,r=this,n=["parent","columnDendrogram","rowDendrogram"],i=[],o=0;o<n.length;o++){var a=n[o];i[o]=e[a],e[a]=null}for(e=$.extend(!0,{},{el:null,dataset:void 0,rowAnnotations:void 0,columnAnnotations:void 0,columnGroupBy:void 0,rowGroupBy:void 0,colorScheme:void 0,rowSortBy:void 0,columnSortBy:void 0,rowDendrogram:void 0,columnDendrogram:void 0,columnDendrogramField:null,rowDendrogramField:null,rows:[],columns:[],tools:void 0,rowFilter:void 0,columnFilter:void 0,autohideTabBar:!1,closeable:!0,rename:!0,rowSize:14,columnSize:14,rowGapSize:10,columnGapSize:10,drawGrid:!0,gridColor:"#808080",showRowNumber:!1,gridThickness:.1,rowDendrogramLineWidth:.7,columnDendrogramLineWidth:.7,height:"window",width:void 0,focus:!0,tooltipMode:0,inheritFromParent:!0,inheritFromParentOptions:{transpose:!1},tooltip:void 0,structureUrlProvider:void 0,promises:void 0,renderReady:void 0,datasetReady:void 0,tabOpened:void 0,loadedCallback:void 0,name:void 0,rowsSortable:!0,columnsSortable:!0,popupEnabled:!0,symmetric:!1,keyboard:!0,inlineTooltip:!0,standalone:!1,$loadingImage:morpheus.Util.createLoadingEl()},e),this.promise=new Promise(function(e,r){t=e}),o=0;o<n.length;o++)e[a=n[o]]=i[o];if(null==e.menu&&(e.menu={File:["Open",null,"Save Image","Save Dataset","Save Session",null,"Close Tab",null,"Rename Tab"],Tools:["New Heat Map",null,"Hierarchical Clustering","KMeans Clustering",null,"Marker Selection","Nearest Neighbors","Create Calculated Annotation",null,"Adjust","Collapse","Similarity Matrix","Transpose",null,"Chart",null,"Sort/Group","Filter",null,"API"],View:["Zoom In","Zoom Out",null,"Fit To Window","Fit Rows To Window","Fit Columns To Window",null,"100%",null,"Options"],Edit:["Copy Image","Copy Selected Dataset",null,"Move Selected Rows To Top","Annotate Selected Rows","Copy Selected Rows","Invert Selected Rows","Select All Rows","Clear Selected Rows",null,"Move Selected Columns To Top","Annotate Selected Columns","Copy Selected Columns","Invert Selected Columns","Select All Columns","Clear Selected Columns"],Help:["Find Action",null,"Contact","Configuration","Tutorial","Source Code",null,"Keyboard Shortcuts"]}),null==e.toolbar&&(e.toolbar=["Search Rows","Search Columns","Dimensions","Zoom","Options","Save Image","Filter","Sort/Group","Color Key"]),this.options=e,this.tooltipProvider=morpheus.HeatMapTooltipProvider,e.el?this.$el=$(e.el):this.$el=$("<div></div>"),this.rowGapSize=e.rowGapSize,this.columnGapSize=e.columnGapSize,this.actionManager=new morpheus.ActionManager,this.actionManager.heatMap=this,this.$el.addClass("morpheus"),null==this.options.dataset){var s=new morpheus.FormBuilder;s.append({name:"file",type:"file"}),this.options.dataset=new Promise(function(e,t){morpheus.FormBuilder.showOkCancel({title:"Dataset",appendTo:r.getContentEl(),focus:r.getFocusEl(),content:s.$form,okCallback:function(){var r=s.getValue("file");morpheus.DatasetUtil.read(r).then(function(t){e(t)}).catch(function(e){t(e)})},cancelCallback:function(){t("Session cancelled.")}})})}if(null==this.options.name&&(this.options.name=morpheus.Util.getBaseFileName(morpheus.Util.getFileName(this.options.dataset.file?this.options.dataset.file:this.options.dataset))),this.options.parent,null==this.options.parent?morpheus.Util.isHeadless()||(null==this.options.tabManager?this.tabManager=new morpheus.TabManager({landingPage:function(){return null==r.options.landingPage&&(r.options.landingPage=new morpheus.LandingPage({tabManager:r.tabManager}),r.options.landingPage.$el.prependTo(r.$el)),r.options.landingPage},autohideTabBar:this.options.autohideTabBar}):this.tabManager=this.options.tabManager,null==this.options.tabManager&&this.tabManager.appendTo(this.$el)):(this.options.inheritFromParent&&(this.popupItems=this.options.parent.popupItems,this.options.tabOpened||(this.options.tabOpened=this.options.parent.options.tabOpened),this.options.drawCallback=this.options.parent.options.drawCallback),this.tabManager=this.options.parent.tabManager),this.$content=$("<div></div>"),this.$content.css({width:"100%","user-select":"none","-webkit-user-select":"none","-webkit-user-drag":"none","-webkit-tap-highlight-color":"rgba(0, 0, 0, 0)","-moz-user-select":"none","-moz-user-drag":"none","-moz-tap-highlight-color":"rgba(0, 0, 0, 0)","-ms-user-select":"none","-ms-user-drag":"none","-ms-tap-highlight-color":"rgba(0, 0, 0, 0)","-o-user-select":"none","-o-user-drag":"none","-o-tap-highlight-color":"rgba(0, 0, 0, 0)","overflow-x":"visible","overflow-y":"visible"}),this.$content.on("remove.morpheus",function(){r.$content.off("remove.morpheus"),r.dispose()}),!morpheus.Util.isHeadless()){this.menu=new morpheus.HeatMapMenu(this);var l=this.tabManager.add({$el:this.$content,closeable:this.options.closeable,rename:this.options.rename,title:this.options.name,object:this,focus:this.options.focus});this.tabId=l.id,this.$tabPanel=l.$panel}e.$loadingImage&&e.$loadingImage.appendTo(this.$content),this.options.dataSource=e.dataset?e.dataset.file?e.dataset.file:e.dataset:"",this._togglingInfoWindow=!1;var u=[];if(e.promises)for(o=0;o<e.promises.length;o++)u.push(e.promises[o]);if(this.whenLoaded=[],e.rowAnnotations){var c=morpheus.DatasetUtil.annotate({annotations:e.rowAnnotations,isColumns:!1});c.then(function(e){r.whenLoaded=r.whenLoaded.concat(e)}),u.push(c)}if(e.columnAnnotations){var h=morpheus.DatasetUtil.annotate({annotations:e.columnAnnotations,isColumns:!0});h.then(function(e){r.whenLoaded=r.whenLoaded.concat(e)}),u.push(h)}if(null!=e.rowDendrogram&&_.isString(e.rowDendrogram))if("("===e.rowDendrogram[0])r.options.rowDendrogram=morpheus.DendrogramUtil.parseNewick(e.rowDendrogram);else{var p=morpheus.Util.getText(e.rowDendrogram);p.then(function(e){r.options.rowDendrogram=morpheus.DendrogramUtil.parseNewick(e)}),u.push(p)}if(null!=e.columnDendrogram&&_.isString(e.columnDendrogram))if("("===e.columnDendrogram[0])r.options.columnDendrogram=morpheus.DendrogramUtil.parseNewick(e.columnDendrogram);else{var d=morpheus.Util.getText(e.columnDendrogram);d.then(function(e){r.options.columnDendrogram=morpheus.DendrogramUtil.parseNewick(e)}),u.push(d)}var f=function(){"undefined"!=typeof window&&$(window).on("orientationchange.morpheus resize.morpheus",r.resizeListener=function(){r.revalidate()}),r.revalidate(),e.loadedCallback&&e.loadedCallback(r),t(),r.tabManager&&(r.options.focus?(r.tabManager.setActiveTab(l.id),r.focus()):1===r.tabManager.getTabCount()&&r.tabManager.setActiveTab(l.id)),r.$el.trigger("heatMapLoaded",r)};if(morpheus.Util.isArray(e.dataset))(g=morpheus.DatasetUtil.readDatasetArray(e.dataset)).catch(function(e){r.options.$loadingImage&&r.options.$loadingImage.remove(),r.options.error&&r.options.error(e),morpheus.FormBuilder.showInModal({title:"Error",html:e,appendTo:r.getContentEl(),focus:r.getFocusEl()})}).then(function(t){r.options.$loadingImage&&r.options.$loadingImage.remove(),r.options.dataset=t,r._init(),null==t.getRowMetadata().getByName("Source")||r.options.colorScheme||r.heatmap.getColorScheme().setSeparateColorSchemeForRowMetadataField("Source"),_.each(e.dataset,function(e){if(e.colorScheme)r.heatmap.getColorScheme().setCurrentValue(morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e.dataset))),r.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(e.colorScheme));else try{r.autoDisplay({extension:morpheus.Util.getExtension(morpheus.Util.getFileName(e.dataset)),filename:morpheus.Util.getBaseFileName(morpheus.Util.getFileName(e.dataset))})}catch(e){console.log("Autodisplay errror")}}),f()});else{var m=e.dataset.file?morpheus.DatasetUtil.read(e.dataset.file,e.dataset.options):morpheus.DatasetUtil.read(e.dataset);m.then(function(e){r.options.dataset=e}).catch(function(t){r.options.$loadingImage.remove();var n=["Error opening "+(e.dataset.file?morpheus.Util.getFileName(e.dataset.file):morpheus.Util.getFileName(e.dataset))+"."];t.message&&(n.push("<br />Cause: "),n.push(t.message)),r.options.error&&r.options.error(n),morpheus.FormBuilder.showInModal({title:"Error",html:n.join(""),appendTo:r.getContentEl(),focus:r.getFocusEl()})}),u.push(m);var g,v=null;e.datasetOverlay&&((g=e.datasetOverlay.file?morpheus.DatasetUtil.read(e.datasetOverlay.file,e.datasetOverlay.options):morpheus.DatasetUtil.read(e.datasetOverlay)).then(function(e){v=e}),u.push(g)),Promise.all(u).then(function(){if(r.options.$loadingImage&&r.options.$loadingImage.remove(),null==r.options.dataset)return r.tabManager.remove(r.tabId);r._init(),v&&morpheus.DatasetUtil.overlay({dataset:r.options.dataset,newDataset:v,rowAnnotationName:"id",newRowAnnotationName:"id",columnAnnotationName:"id",newColumnAnnotationName:"id"}),f()})}},morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS=6,morpheus.HeatMap.showTool=function(e,t,r){if(e.gui){var n=e.gui(t.getProject()),i=new morpheus.FormBuilder;_.each(n,function(e){i.append(e)}),t.getTabManager().getActiveTabId(),e.init&&e.init(t.getProject(),i,{heatMap:t}),t.trigger("beforeToolShown",{tool:e,formBuilder:i});var o,a=function(){var o=$("<div><span>"+e.toString()+'...</span><div><progress></progress></div><button class="btn btn-xs btn-default" style="margin-left:6px;display: none;">Cancel</button></div>'),a=null,s=morpheus.FormBuilder.showInDraggableDiv({$content:o,appendTo:t.getContentEl(),width:"auto"});morpheus.DialogUtil.add(s);var l={};_.each(n,function(e){l[e.name]=i.getValue(e.name)}),setTimeout(function(){if((a=e.execute({heatMap:t,project:t.getProject(),input:l}))instanceof Worker){morpheus.DialogUtil.remove(s),o.find("button").css("display","").on("click",function(){a.terminate()}),a.onerror=function(e){a.terminate(),morpheus.FormBuilder.showInModal({title:"Error",html:e,close:"Close",focus:t.getFocusEl(),appendTo:t.getContentEl()}),e.stack&&console.log(e.stack)};var n=_.bind(a.terminate,a);a.terminate=function(){n(),s.remove(),r&&r(l)}}else null!=a&&"function"==typeof a.then?a.finally(function(){r&&r(l),s.remove(),morpheus.DialogUtil.remove(s)}):(r&&r(l),s.remove(),morpheus.DialogUtil.remove(s))},20)};e.ok=function(){o.modal("hide"),a()};var s=$.extend({},{ok:!0},n.options);o=morpheus.FormBuilder.showOkCancel({title:e.toString(),apply:e.apply,ok:s.ok,cancel:s.cancel,size:s.size,draggable:!0,content:i.$form,appendTo:t.getContentEl(),align:"right",okCallback:a,focus:t.getFocusEl()})}else e.execute({heatMap:t,project:t.getProject(),input:{}}),r&&r({})},morpheus.HeatMap.getSpaces=function(e,t,r){for(var n=[],i=e.length,o=0;o<i;o++){var a=e[o];n.push(a.getValue(0))}var s=[],l=0;s.push(l);for(var u=1;u<t;u++){var c=!0;for(o=0;o<i;o++)if(0!==(a=e[o]).getComparator()(a.getValue(u),n[o])){c=!1;for(var h=0;h<i;h++)n[h]=e[h].getValue(u);break}c||(l+=r),s.push(l)}return s},morpheus.HeatMap.createGroupBySpaces=function(e,t,r,n){if(t.length>0){for(var i=t.length,o=0;o<i;o++)t[o].init(t[o].isColumns()?new morpheus.TransposedDatasetView(e):e);return morpheus.HeatMap.getSpaces(t,n?e.getColumnCount():e.getRowCount(),r)}},morpheus.HeatMap.isDendrogramVisible=function(e,t){var r=t?e.getColumnSortKeys():e.getRowSortKeys();if(0===r.length)return!0;for(var n=t?e.getSortedFilteredDataset().getColumnCount():e.getSortedFilteredDataset().getRowCount(),i=0;i<r.length;i++)if(!r[i].isPreservesDendrogram()||r[i].nvisible!==n)return!1;return!0},morpheus.HeatMap.prototype={updatingScroll:!1,getWhitespaceEl:function(){return this.$whitespace},getActionManager:function(){return this.actionManager},autoDisplay:function(e){var t;if(null==e.filename&&(e.filename=""),"segtab"===e.extension||"seg"===e.extension)t={scalingMode:"fixed",values:morpheus.HeatMapColorScheme.Predefined.CN().values.map(function(e){return Math.pow(2,1+e)}),colors:morpheus.HeatMapColorScheme.Predefined.CN().colors};else if("maf"===e.extension){t=morpheus.HeatMapColorScheme.Predefined.MAF();var r=this.project.getFullDataset().getRowMetadata().getByName("mutation_summary"),n=r.getProperties().get(morpheus.VectorKeys.FIELDS);null==n&&(n=morpheus.MafFileReader.FIELD_NAMES,r.getProperties().set(morpheus.VectorKeys.FIELDS,n));var i=!0;if(n.length!==morpheus.MafFileReader.FIELD_NAMES.length)i=!1;else for(var o=0;o<n.length;o++)if(n[o]!==morpheus.MafFileReader.FIELD_NAMES[o]){i=!1;break}if(!i)for(t={scalingMode:"fixed",stepped:!0,values:[0],colors:["rgb(255,255,255)"]},o=0;o<n.length;o++)t.values.push(o+1),t.colors.push(morpheus.VectorColorModel.TWENTY_COLORS[o%morpheus.VectorColorModel.TWENTY_COLORS.length]),t.names.push(n[o]);var a=[],s=["mutation_summary","mutation_summary_selection"];for(o=0;o<s.length;o++){var l=s[o];this.project.getFullDataset().getColumnMetadata().getByName(l)&&(a.push(this.project.getFullDataset().getColumnMetadata().getByName(l)),(u=this.getTrack(l,!0))&&(u.settingFromConfig("stacked_bar"),"mutation_summary_selection"===l&&(u.settings.autoscaleAlways=!0)))}var u=this.getTrack("mutation_summary",!1);for(u&&u.settingFromConfig("stacked_bar"),o=1;o<t.colors.length;o++){r&&this.getProject().getRowColorModel().setMappedValue(r,o-1,t.colors[o]);for(var c=0;c<a.length;c++)this.getProject().getColumnColorModel().setMappedValue(a[c],o-1,t.colors[o])}}else"gmt"===e.extension?t=morpheus.HeatMapColorScheme.Predefined.BINARY():"all_lesions.conf_99"===e.filename||"all_data_by_genes.txt"===e.filename||-1!==e.filename.toLowerCase().indexOf("gistic")?t={scalingMode:"fixed",values:[-.5,0,.5],colors:["blue","white","red"]}:-1!==e.filename.toLowerCase().indexOf("copynumber")||-1!==e.filename.toLowerCase().indexOf("copy number")?t={scalingMode:"fixed",values:[-1.5,0,1.5],colors:["blue","white","red"]}:-1!==e.filename.toLowerCase().indexOf("achilles")&&(t={scalingMode:"fixed",values:[-3,-1,1,3],colors:["blue","white","white","red"]});return t&&e.filename&&this.heatmap.getColorScheme()&&(this.heatmap.getColorScheme().setCurrentValue(e.filename),this.heatmap.getColorScheme().setColorSupplierForCurrentValue(morpheus.AbstractColorSupplier.fromJSON(t))),t},sortBasedOnSelection:function(e,t,r){var n=this.project,i=(t?n.getColumnSelectionModel():n.getRowSelectionModel()).toModelIndices();if(0!==i.length){var o,a=-1;if(null==e)for(var s=t?n.getRowSortKeys():n.getColumnSortKeys(),l=0,u=s.length;l<u;l++){var c=s[l];if(c instanceof morpheus.SortByValuesKey&&morpheus.Util.arrayEquals(c.modelIndices,i)){a=l,c.getSortOrder()===morpheus.SortKey.SortOrder.UNSORTED?e=morpheus.SortKey.SortOrder.DESCENDING:c.getSortOrder()===morpheus.SortKey.SortOrder.DESCENDING?e=morpheus.SortKey.SortOrder.ASCENDING:c.getSortOrder()===morpheus.SortKey.SortOrder.ASCENDING?e=morpheus.SortKey.SortOrder.TOP_N:c.getSortOrder()===morpheus.SortKey.SortOrder.TOP_N&&(e=morpheus.SortKey.SortOrder.UNSORTED);break}}if(null==e&&(e=morpheus.SortKey.SortOrder.DESCENDING),r)o=t?n.getRowSortKeys():n.getColumnSortKeys(),-1!==a?e===morpheus.SortKey.SortOrder.UNSORTED?o.splice(a,1):o[a].setSortOrder(e):e!==morpheus.SortKey.SortOrder.UNSORTED&&o.push(new morpheus.SortByValuesKey(i,e,!t)),o=morpheus.SortKey.keepExistingSortKeys(o,t?n.getRowSortKeys():n.getColumnSortKeys());else{var h=e===morpheus.SortKey.SortOrder.UNSORTED?[]:[new morpheus.SortByValuesKey(i,e,!t)];o=morpheus.SortKey.keepExistingSortKeys(h,t?n.getRowSortKeys():n.getColumnSortKeys())}t?(n.setRowSortKeys(o,!0),this.scrollTop(0)):(n.setColumnSortKeys(o,!0),this.scrollLeft(0)),morpheus.Util.trackEvent({eventCategory:"Tool",eventAction:t?"sortRowsBasedOnSelection":"sortColumnsBasedOnSelection"})}},getToolbarElement:function(){return this.toolbar.$el},getToolbar:function(){return this.toolbar},setName:function(e){this.options.name=e},getName:function(){return this.options.name},showOptions:function(){new morpheus.HeatMapOptions(this)},getProject:function(){return this.project},getDendrogram:function(e){return e?this.columnDendrogram:this.rowDendrogram},toJSON:function(e){var t=this,r={};if(r.colorScheme=this.heatmap.getColorScheme().toJSON(),r.name=this.options.name,r.showRowNumber=this.isShowRowNumber(),r.rowShapeModel=this.getProject().getRowShapeModel().toJSON(this.getVisibleTracks(!1)),r.columnShapeModel=this.getProject().getColumnShapeModel().toJSON(this.getVisibleTracks(!0)),r.rowFontModel=this.getProject().getRowFontModel().toJSON(this.getVisibleTracks(!1)),r.columnFontModel=this.getProject().getColumnFontModel().toJSON(this.getVisibleTracks(!0)),r.rowColorModel=this.getProject().getRowColorModel().toJSON(this.getVisibleTracks(!1)),r.columnColorModel=this.getProject().getColumnColorModel().toJSON(this.getVisibleTracks(!0)),r.rows=this.getVisibleTracks(!1).map(function(e){var r=morpheus.CanvasUtil.getPreferredSize(t.getTrackHeaderByIndex(t.getTrackIndex(e.getName(),!1),!1)),n=e.settings;return n.field=e.getName(),n.size={width:r.widthSet?r.width:void 0},n}),r.columns=this.getVisibleTracks(!0).map(function(e){var r=morpheus.CanvasUtil.getPreferredSize(t.getTrackHeaderByIndex(t.getTrackIndex(e.getName(),!0),!0)),n=e.settings;return n.field=e.getName(),n.size={width:r.widthSet?r.width:void 0,height:r.heightSet?r.height:void 0},n}),r.rowSortBy=morpheus.SortKey.toJSON(this.getProject().getRowSortKeys()),r.columnSortBy=morpheus.SortKey.toJSON(this.getProject().getColumnSortKeys()),r.rowGroupBy=morpheus.SortKey.toJSON(this.getProject().getGroupRows()),r.columnGroupBy=morpheus.SortKey.toJSON(this.getProject().getGroupColumns()),r.rowFilter=morpheus.CombinedFilter.toJSON(this.getProject().getRowFilter()),r.columnFilter=morpheus.CombinedFilter.toJSON(this.getProject().getColumnFilter()),r.symmetric=this.options.symmetric,r.rowSize=this.heatmap.getRowPositions().getSize(),r.columnSize=this.heatmap.getColumnPositions().getSize(),r.rowGapSize=this.heatmap.rowGapSize,r.columnGapSize=this.heatmap.columnGapSize,r.drawGrid=this.heatmap.isDrawGrid(),r.gridColor=this.heatmap.getGridColor(),r.gridThickness=this.heatmap.getGridThickness(),r.drawValues=this.heatmap.isDrawValues(),r.shape=this.heatmap.getShape(),r.rowSelection=this.getProject().getRowSelectionModel().toModelIndices(),r.columnSelection=this.getProject().getColumnSelectionModel().toModelIndices(),r.rowSearchTerm=this.toolbar.getSearchField(morpheus.HeatMapToolBar.ROW_SEARCH_FIELD).val(),r.columnSearchTerm=this.toolbar.getSearchField(morpheus.HeatMapToolBar.COLUMN_SEARCH_FIELD).val(),null!=this.rowDendrogram){var n=[];morpheus.DendrogramUtil.writeNewick(this.rowDendrogram.tree.rootNode,n,function(e){return e.index}),r.rowDendrogram=n.join(""),r.rowDendrogramField=null,r.rowDendrogramLineWidth=this.rowDendrogram.lineWidth}return null!=this.columnDendrogram&&(n=[],morpheus.DendrogramUtil.writeNewick(this.columnDendrogram.tree.rootNode,n,function(e){return e.index}),r.columnDendrogram=n.join(""),r.columnDendrogramField=null,r.columnDendrogramLineWidth=this.columnDendrogram.lineWidth),e.dataset&&(r.dataset=morpheus.Dataset.toJSON(this.getProject().getFullDataset())),r},setDendrogram:function(e,t,r){var n=t?this.columnDendrogram:this.rowDendrogram;if(n&&(n.dispose(),n=null),null!=e){var i;t?this.project.getFullDataset().getColumnCount():this.project.getFullDataset().getRowCount(),t?((n=new morpheus.ColumnDendrogram(this,e,this.heatmap.getColumnPositions(),this.project)).filter=this.project.getColumnFilter().shallowClone(),this.columnDendrogram=n,(i=new morpheus.SpecifiedModelSortOrder(r,r.length,"dendrogram",!0)).setPreservesDendrogram(!0),i.setLockOrder(2),i.setUnlockable(!1),this.project.setColumnSortKeys([i],!0)):((n=new morpheus.RowDendrogram(this,e,this.heatmap.getRowPositions(),this.project)).filter=this.project.getRowFilter().shallowClone(),this.rowDendrogram=n,(i=new morpheus.SpecifiedModelSortOrder(r,r.length,"dendrogram",!1)).setPreservesDendrogram(!0),i.setLockOrder(2),i.setUnlockable(!1),this.project.setRowSortKeys([i],!0)),n.appendTo(this.$parent),n.$label.appendTo(this.$parent),n.$squishedLabel.appendTo(this.$parent)}else{for(var o=t?this.project.getColumnSortKeys():this.project.getRowSortKeys(),a=0;a<o.length;a++)o[a].isPreservesDendrogram()&&(o.splice(a,1),a--);t?(this.heatmap.getColumnPositions().setSquishedIndices(null),delete this.columnDendrogram,this.project.setColumnSortKeys(o,!0)):(delete this.rowDendrogram,this.project.setRowSortKeys(o,!0),this.heatmap.getRowPositions().setSquishedIndices(null))}this.trigger("dendrogramChanged",{isColumns:t})},getTabManager:function(){return this.tabManager},getSelectedElementsText:function(){var e=this.project,t=e.getElementSelectionModel().getViewIndices();if(t.size()>0){var r=[],n=e.getSortedFilteredDataset(),i=this.rowTracks.filter(function(e){return e.settings.inlineTooltip}),o=this.columnTracks.filter(function(e){return e.settings.inlineTooltip});return t.forEach(function(e){var t=e.getArray()[0],a=e.getArray()[1];r.push(morpheus.Util.nf(n.getValue(t,a))),i.forEach(function(e){r.push("\t"),r.push(morpheus.Util.toString(n.getRowMetadata().getByName(e.name).getValue(t)))}),o.forEach(function(e){r.push("\t"),r.push(morpheus.Util.toString(n.getColumnMetadata().getByName(e.name).getValue(a)))}),r.push("\n")}),r.join("")}},_init:function(){var e=this;morpheus.MetadataUtil.renameFields(this.options.dataset,this.options);var t=this.options.dataset,r=this.options.rowDendrogram,n=this.options.columnDendrogram;if(_.each(this.whenLoaded,function(t){t(e.options.dataset)}),this.options.datasetReady){var i=this.options.datasetReady(t);i&&(t=i)}this.project=new morpheus.Project(t),this.tabManager&&this.tabManager.setTabTitle(this.tabId,this.project.getFullDataset().getRowCount()+" row"+morpheus.Util.s(this.project.getFullDataset().getRowCount())+" x "+this.project.getFullDataset().getColumnCount()+" column"+morpheus.Util.s(this.project.getFullDataset().getColumnCount())),this.options.inheritFromParent&&null!=this.options.parent&&morpheus.HeatMap.copyFromParent(this.project,this.options),this.options.rowFilter&&(morpheus.CombinedFilter.fromJSON(e.project.getRowFilter(),this.options.rowFilter),e.project.setRowFilter(e.project.getRowFilter(),!0)),this.options.columnFilter&&(this.options.columnFilter.filters.forEach(function(e){e.isColumns=!0}),morpheus.CombinedFilter.fromJSON(e.project.getColumnFilter(),this.options.columnFilter),e.project.setColumnFilter(e.project.getColumnFilter(),!0)),this.whenLoaded=null,this.$parent=$("<div></div>").css("position","relative"),this.$parent.appendTo(this.$content),morpheus.Util.isHeadless()||(this.toolbar=new morpheus.HeatMapToolBar(this)),this.vscroll=new morpheus.ScrollBar(!0),this.vscroll.appendTo(this.$parent),this.vscroll.on("scroll",function(){e.updatingScroll||e.paintAll({paintRows:!0,paintColumns:!1,invalidateRows:!0,invalidateColumns:!1})}),this.beforeColumnTrackDivider=new morpheus.Divider(!1),this.beforeColumnTrackDivider.appendTo(this.$parent);var o=0;this.beforeColumnTrackDivider.on("resizeStart",function(t){o=e.columnDendrogram.getUnscaledHeight()}).on("resize",function(t){var r=Math.max(8,o+t.delta);e.columnDendrogram.setPrefHeight(r),e.revalidate()}).on("resizeEnd",function(){o=0}),this.afterRowDendrogramDivider=new morpheus.Divider(!0),this.afterRowDendrogramDivider.appendTo(this.$parent);var a=0;this.afterRowDendrogramDivider.on("resizeStart",function(t){a=e.rowDendrogram.getUnscaledWidth()}).on("resize",function(t){var r=Math.max(8,a+t.delta);e.rowDendrogram.setPrefWidth(r),e.revalidate()}).on("resizeEnd",function(){a=0}),this.afterVerticalScrollBarDivider=new morpheus.Divider(!0),this.afterVerticalScrollBarDivider.appendTo(this.$parent);var s=0;this.afterVerticalScrollBarDivider.on("resizeStart",function(t){s=e.heatmap.getUnscaledWidth()}).on("resize",function(t){e.heatmap.prefWidth=s+t.delta,e.revalidate()}),this.hscroll=new morpheus.ScrollBar(!1),this.hscroll.appendTo(this.$parent),this.hscroll.on("scroll",function(){e.updatingScroll||e.paintAll({paintRows:!1,paintColumns:!0,invalidateRows:!1,invalidateColumns:!0})}),this.$whitespace=$('<div style="position: absolute;"></div>'),this.$whitespace.appendTo(this.$parent);var l=new morpheus.HeatMapElementCanvas(this.project);this.options.drawCallback&&l.setDrawCallback(this.options.drawCallback),$(l.canvas).on("contextmenu",function(t){morpheus.Popup.showPopup([{name:"Copy Image",class:"copy"},{name:"Save Image ("+morpheus.Util.COMMAND_KEY+"S)"},{separator:!0},{name:"Show Inline Tooltip",checked:e.options.inlineTooltip}],{x:t.pageX,y:t.pageY},t.target,function(t,r){if("Show Inline Tooltip"===r)e.options.inlineTooltip=!e.options.inlineTooltip;else if(r==="Save Image ("+morpheus.Util.COMMAND_KEY+"S)")e.getActionManager().execute("Save Image");else if("Copy Selection"===r){var n=e.getSelectedElementsText();""!==n&&t.clipboardData.setData("text/plain",n)}else"Copy Image"===r?e.getActionManager().execute("Copy Image",{event:t}):console.log(r+" unknown.")}),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()}),l.appendTo(this.$parent),this.heatmap=l;var u=null;if(null!=r)if((b=r).leafNodes.length!==this.project.getSortedFilteredDataset().getRowCount())console.log("# leaf nodes in row dendrogram "+b.leafNodes.length+" != "+this.project.getSortedFilteredDataset().getRowCount());else{var c=null;if(null!=this.options.rowDendrogramField){if(null==(S=t.getRowMetadata().getByName(this.options.rowDendrogramField)))throw console.log(this.options.rowDendrogramField+" not found in "+morpheus.MetadataUtil.getMetadataNames(t.getRowMetadata())),new Error(this.options.rowDendrogramField+" not found");c=[];for(var h=new morpheus.Map,p=/[,:]/g,d="string"===morpheus.VectorUtil.getDataType(S),f=0,m=S.size();f<m;f++){var g=S.getValue(f);d&&(g=g.replace(p,"")),h.set(g,f)}for(var v=0,y=b.leafNodes.length;v<y;v++){if(void 0===(C=h.get(b.leafNodes[v].name)))throw console.log("Unable to find row dendrogram id "+b.leafNodes[v].name+" in row annotations"),new Error("Unable to find row dendrogram id "+b.leafNodes[v].name+" in row annotations");c.push(C)}}this.rowDendrogram=new morpheus.RowDendrogram(this,b,l.getRowPositions(),this.project,!0),this.rowDendrogram.lineWidth=this.options.rowDendrogramLineWidth,this.rowDendrogram.appendTo(this.$parent),this.rowDendrogram.$label.appendTo(this.$parent),this.rowDendrogram.$squishedLabel.appendTo(this.$parent),null!=c&&((u=new morpheus.SpecifiedModelSortOrder(c,c.length,"dendrogram")).setLockOrder(2),u.setUnlockable(!1),u.setPreservesDendrogram(!0))}var b,w=null;if(null!=n)if((b=n).leafNodes.length!==this.project.getSortedFilteredDataset().getColumnCount())console.log("# leaf nodes "+b.leafNodes.length+" != "+this.project.getSortedFilteredDataset().getColumnCount());else{var x=null;if(null!=this.options.columnDendrogramField){var S;if(x=[],null==(S=t.getColumnMetadata().getByName(this.options.columnDendrogramField)))throw console.log(this.options.columnDendrogramField+" not found in "+morpheus.MetadataUtil.getMetadataNames(t.getRowMetadata())),new Error(this.options.columnDendrogramField+" not found");for(h=new morpheus.Map,p=/[,:]/g,d="string"===morpheus.VectorUtil.getDataType(S),f=0,m=S.size();f<m;f++)g=S.getValue(f),d&&(g=g.replace(p,"")),h.set(g,f);for(v=0,y=b.leafNodes.length;v<y;v++){var C;if(void 0===(C=h.get(b.leafNodes[v].name)))throw"Unable to find column dendrogram id "+b.leafNodes[v].name+" in column annotations";x.push(C)}}this.columnDendrogram=new morpheus.ColumnDendrogram(this,b,l.getColumnPositions(),this.project,!0),this.columnDendrogram.lineWidth=this.options.columnDendrogramLineWidth,this.columnDendrogram.appendTo(this.$parent),this.columnDendrogram.$label.appendTo(this.$parent),this.columnDendrogram.$squishedLabel.appendTo(this.$parent),null!=x&&((w=new morpheus.SpecifiedModelSortOrder(x,x.length,"dendrogram")).setLockOrder(2),w.setUnlockable(!1),w.setPreservesDendrogram(!0))}if(null!=this.options.drawGrid&&this.heatmap.setDrawGrid(this.options.drawGrid),null!=this.options.gridColor&&this.heatmap.setGridColor(this.options.gridColor),null!=this.options.gridThickness&&this.heatmap.setGridThickness(this.options.gridThickness),null!=this.options.drawValues&&this.heatmap.setDrawValues(this.options.drawValues),null!=this.options.shape&&this.heatmap.setShape(this.options.shape),null!=u&&this.project.setRowSortKeys([u]),null!=w&&this.project.setColumnSortKeys([w]),this.options.rowSortBy&&this.options.rowSortBy.length>0&&this.project.setRowSortKeys(morpheus.SortKey.fromJSON(this.project,this.options.rowSortBy),!1),this.options.columnSortBy&&this.options.columnSortBy.length>0&&this.project.setColumnSortKeys(morpheus.SortKey.fromJSON(this.project,this.options.columnSortBy),!1),null!=this.options.rowGroupBy&&this.options.rowGroupBy.length>0){var M=morpheus.SortKey.fromJSON(this.project,this.options.rowGroupBy);for(v=0;v<M.length;v++)this.project.groupRows.push(M[v])}if(null!=this.options.columnGroupBy&&this.options.columnGroupBy.length>0)for(M=morpheus.SortKey.fromJSON(this.project,this.options.columnGroupBy),v=0;v<M.length;v++)this.project.groupColumns.push(M[v]);if(null!=this.options.rowSelection&&this.options.rowSelection.length>0){var T=new morpheus.Set;for(v=0,y=this.options.rowSelection.length;v<y;v++)T.add(this.project.convertModelRowIndexToView(this.options.rowSelection[v]));this.project.getRowSelectionModel().setViewIndices(T,!1)}if(null!=this.options.columnSelection&&this.options.columnSelection.length>0){for(T=new morpheus.Set,v=0,y=this.options.columnSelection.length;v<y;v++)T.add(this.project.convertModelColumnIndexToView(this.options.columnSelection[v]));this.project.getColumnSelectionModel().setViewIndices(T,!1)}null!=this.options.rowSearchTerm&&""!==this.options.rowSearchTerm&&this.toolbar.getSearchField(morpheus.HeatMapToolBar.ROW_SEARCH_FIELD).val(this.options.rowSearchTerm),null!=this.options.columnSearchTerm&&""!==this.options.columnSearchTerm&&this.toolbar.getSearchField(morpheus.HeatMapToolBar.COLUMN_SEARCH_FIELD).val(this.options.columnSearchTerm),this.vSortByValuesIndicator=new morpheus.SortByValuesIndicator(this.project,!0,l.getRowPositions()),this.vSortByValuesIndicator.appendTo(this.$parent),this.hSortByValuesIndicator=new morpheus.SortByValuesIndicator(this.project,!1,l.getColumnPositions()),this.hSortByValuesIndicator.appendTo(this.$parent),this.verticalSearchBar=new morpheus.ScentedSearch(this.project.getRowSelectionModel(),l.getRowPositions(),!0,this.vscroll,this),this.horizontalSearchBar=new morpheus.ScentedSearch(this.project.getColumnSelectionModel(),l.getColumnPositions(),!1,this.hscroll,this),this.rowTracks=[],this.rowTrackHeaders=[],this.columnTracks=[],this.columnTrackHeaders=[],null!=this.options.rowSize&&"fit"!==this.options.rowSize&&this.heatmap.getRowPositions().setSize(this.options.rowSize),null!=this.options.columnSize&&"fit"!==this.options.columnSize&&this.heatmap.getColumnPositions().setSize(this.options.columnSize);var A=function(r,n){var i=new morpheus.Map,o=null!=e.options.parent&&e.options.inheritFromParent;if(null!=n&&n.length>0){o=!0;for(var a=0;a<n.length;a++)i.set(null!=n[a].renameTo?n[a].renameTo:n[a].field,n[a])}var s=r?t.getColumnMetadata():t.getRowMetadata();if(!o){var l=new morpheus.Set;["id","name","description"].forEach(function(e){l.add(e)}),a=0;for(var u=s.getMetadataCount();a<u;a++){var c=s.get(a);l.has(c.getName())&&!i.has(c.getName())&&(i.set(c.getName(),{display:["text"]}),o=!0)}}var h=!0;for(a=0,u=s.getMetadataCount();a<u;a++){var p=(c=s.get(a)).getName(),d=i.get(p);if(!o||null!=d){var f=r?t.getColumnCount():t.getRowCount();if(null!=d||o||!(f>1)||morpheus.VectorUtil.containsMoreThanOneValue(c)){null==d&&(d={}),d.title&&c.getProperties().set(morpheus.VectorKeys.TITLE,d.title),null==d.display&&("name"===p||"id"===p||h?(d.inlineTooltip=!0,d.display=["text"]):d.display=r?"color,highlight":"text"),h=!1;var m=e.addTrack(p,r,d);if(d.size)if(r||null==d.size.width){if(r&&(null!=d.size.width||null!=d.size.height)){var g=e.getTrackHeaderByIndex(e.getTrackIndex(p,r),r);d.size.height&&(m.setPrefHeight(d.size.height),g.setPrefHeight(d.size.height)),d.size.width&&(m.setPrefWidth(d.size.width),g.setPrefWidth(d.size.width))}}else{g=e.getTrackHeaderByIndex(e.getTrackIndex(p,r),r);m.setPrefWidth(d.size.width),g.setPrefWidth(d.size.width)}if(d.header&&d.header.font&&((g=e.getTrackHeaderByIndex(e.getTrackIndex(p,r),r)).font=d.header.font),d.formatter&&c.getProperties().set(morpheus.VectorKeys.FORMATTER,morpheus.Util.createNumberFormat(d.formatter)),m.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)&&d.color){var v=r?e.project.getColumnColorModel():e.project.getRowColorModel();if(m.getFullVector().getProperties.get(morpheus.VectorKeys.DISCRETE))_.each(n.color,function(e){v.setMappedValue(c,e.value,e.color)});else{var y=v.createContinuousColorMap(c),b=Number.MAX_VALUE,w=-Number.MAX_VALUE;_.each(n.color,function(e){b=Math.min(b,e.value),w=Math.max(w,e.value)}),y.setMin(b),y.setMax(w);var x=d3.scale.linear().domain([y.getMin(),y.getMax()]).range([0,1]).clamp(!0),S=[],C=[];_.each(n.color,function(e){S.push(x(e.value)),C.push(e.color)}),y.setFractions({fractions:S,colors:C})}m.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)&&d.shape&&(v=r?e.project.getColumnShapeModel():e.project.getRowShapeModel(),_.each(n.shape,function(e){v.setMappedValue(c,e.value,e.shape)}))}}}}};function E(t,r){if(!(null==t||t.length<=1)){var n=[],i=!1;t.forEach(function(e,t){var r=e.renameTo||e.field,o=t;null!=e.order&&(o=e.order,i=!0),n.push({name:r,order:o})}),i||t.forEach(function(e,t){var r=e.renameTo||e.field;n.push({name:r,order:t})}),n.sort(function(e,t){return e.order===t.order?0:e.order<t.order?-1:1});for(var o=0,a=0;o<n.length;o++){var s=e.getTrackIndex(n[o].name,r);-1!==s&&(e.moveTrack(s,a,r),a++)}}}A(!1,this.options.rows),A(!0,this.options.columns),E(this.options.rows,!1),E(this.options.columns,!0),this.options.showRowNumber&&this.setShowRowNumber(!0);var P,R,I,N=null!=this.options.colorScheme;if(null==this.options.colorScheme){var D="";this.options.dataSource&&(D=morpheus.Util.getExtension(morpheus.Util.getFileName(this.options.dataSource)));var k=this.autoDisplay({filename:morpheus.Util.getBaseFileName(morpheus.Util.getFileName(this.options.dataset)),extension:D});if(null==k&&(k={type:"relative"}),this.options.colorScheme=k,this.project.getFullDataset().getName(),"maf"===D&&!this.options.rowSortBy){var O=[];this.project.getFullDataset().getRowMetadata().getByName("order")&&O.push(new morpheus.SortKey("order",morpheus.SortKey.SortOrder.ASCENDING)),O.push(new morpheus.SortKey("id",morpheus.SortKey.SortOrder.ASCENDING)),this.project.setRowSortKeys(O,!1)}-1!==morpheus.DatasetUtil.getSeriesIndex(this.project.getFullDataset(),"allelic_fraction")&&(this.options.sizeBy={seriesName:"allelic_fraction",min:0,max:1})}if(this.options.parent&&this.options.inheritFromParent&&this.heatmap.setPropertiesFromParent(this.options.parent.heatmap),this.options.parent&&this.options.inheritFromParent&&!N)l.setColorScheme(this.options.parent.heatmap.getColorScheme().copy(this.project));else if(l.setColorScheme(new morpheus.HeatMapColorScheme(this.project,this.options.colorScheme)),null!=this.options.dataset.getRowMetadata().getByName("Source")){var F=morpheus.VectorUtil.getSet(this.options.dataset.getRowMetadata().getByName("Source"));this.heatmap.getColorScheme().setSeparateColorSchemeForRowMetadataField("Source"),F.forEach(function(t){e.autoDisplay({extension:morpheus.Util.getExtension(t),filename:""+t})})}this.options.sizeBy&&(l.getColorScheme().getSizer().setSeriesName(this.options.sizeBy.seriesName),l.getColorScheme().getSizer().setMin(this.options.sizeBy.min),l.getColorScheme().getSizer().setMax(this.options.sizeBy.max)),this.updateDataset(),this.options.tabOpened&&(this.options.tabOpened(this),this.updateDataset()),this.options.renderReady&&(this.options.renderReady(this),this.updateDataset()),"fit"===this.options.rowSize&&(this.heatmap.getRowPositions().setSize(this.getFitRowSize()),this.revalidate({paint:!1})),"fit"===this.options.columnSize&&(this.heatmap.getColumnPositions().setSize(this.getFitColumnSize()),this.revalidate({paint:!1})),this.options.rowColorModel&&this.getProject().getRowColorModel().fromJSON(this.options.rowColorModel),this.options.columnColorModel&&this.getProject().getColumnColorModel().fromJSON(this.options.columnColorModel),this.options.rowShapeModel&&this.getProject().getRowShapeModel().fromJSON(this.options.rowShapeModel),this.options.columnShapeModel&&this.getProject().getColumnShapeModel().fromJSON(this.options.columnShapeModel),this.options.rowFontModel&&this.getProject().getRowFontModel().fromJSON(this.options.rowFontModel),this.options.columnFontModel&&this.getProject().getColumnFontModel().fromJSON(this.options.columnFontModel),"fit"!==this.options.rowSize&&"fit"!==this.options.columnSize||("fit"===this.options.columnSize&&(this.heatmap.getColumnPositions().setSize(this.getFitColumnSize()),this.revalidate({paint:!1})),"fit"===this.options.rowSize&&(this.heatmap.getRowPositions().setSize(this.getFitRowSize()),this.revalidate({paint:!1})),this.paintAll({paintRows:!0,paintColumns:!0,invalidateRows:!0,invalidateColumns:!0})),this.options.parent=null,this.$tipFollow=$('<div style="display:none;" class="morpheus-tip-inline"></div>'),this.$tipFollow.appendTo(this.$parent),this.$tipInfoWindow=$('<div class="morpheus-tip-dialog"></div>'),this.$tipInfoWindow.appendTo(this.$parent),morpheus.Util.isHeadless()||(this.$tipInfoWindow.dialog({close:function(t,r){e._togglingInfoWindow||e.toggleInfoWindow()},autoOpen:!1,width:220,height:280,minHeight:38,minWidth:10,collision:"fit",position:{my:"right-30 bottom",at:"right top",of:this.$parent},title:"Info"}),this.setTooltipMode(this.options.tooltipMode)),this.getProject().on("rowFilterChanged columnFilterChanged rowGroupByChanged columnGroupByChanged rowSortOrderChanged columnSortOrderChanged datasetChanged",function(t){if("datasetChanged"===t.type){for(var r=e.getProject().getFullDataset(),n=0;n<e.rowTracks.length;n++){var i=e.rowTracks[n];r.getRowMetadata().getByName(i.getName())||(e.removeTrack(i.getName(),!1),n--)}for(n=0;n<e.columnTracks.length;n++)i=e.columnTracks[n],r.getColumnMetadata().getByName(i.getName())||(e.removeTrack(i.getName(),!0),n--)}e.updateDataset(),e.revalidate()}),this.getProject().on("trackChanged",function(t){var r=t.columns;_.each(t.vectors,function(n,i){var o=e.getTrackIndex(n.getName(),r);if(-1===o)e.addTrack(n.getName(),r,t.display[i]);else{var a=e.getTrackByIndex(o,r),s=t.display[i];s&&a.settingFromConfig(s),a.setInvalid(!0)}}),e.revalidate()}),this.getProject().on("rowTrackRemoved",function(t){e.removeTrack(t.vector.getName(),!1),e.revalidate()}),this.getProject().on("columnTrackRemoved",function(t){e.removeTrack(t.vector.getName(),!0),e.revalidate()}),this.getProject().getRowSelectionModel().on("selectionChanged",function(){for(var t=0;t<e.columnTracks.length;t++){var r=e.columnTracks[t];if(r.getFullVector().getProperties().get(morpheus.VectorKeys.RECOMPUTE_FUNCTION_SELECTION)){var n=e.getProject().getSelectedDataset({selectedRows:!0,selectedColumns:!1,emptyToAll:!1}),i=n.getColumnMetadata().getByName(r.getName()),o=morpheus.VectorUtil.jsonToFunction(i,morpheus.VectorKeys.FUNCTION);if("function"==typeof o){for(var a=new morpheus.DatasetColumnView(n),s=0,l=i.size();s<l;s++)a.setIndex(s),i.setValue(s,o(a,n,s));r.setInvalid(!0),r.repaint()}}}e.verticalSearchBar.update(),e.heatmap.updateRowSelectionCache(),e.paintAll({paintRows:!0,paintColumns:!1,invalidateRows:!1,invalidateColumns:!1})}),this.getProject().getColumnSelectionModel().on("selectionChanged",function(){e.horizontalSearchBar.update(),e.heatmap.updateColumnSelectionCache(),e.paintAll({paintRows:!1,paintColumns:!0,invalidateRows:!1,invalidateColumns:!1})}),this.pasteListener=function(t){if(e.isActiveComponent()){var r=t.originalEvent.clipboardData.getData("text/plain");if(null!=r&&r.length>0){var n;if(t.preventDefault(),t.stopPropagation(),0===r.indexOf("http"))n=r;else{var i=new Blob([r],{type:"text/plain"});n=URL.createObjectURL(i)}morpheus.HeatMap.showTool(new morpheus.OpenFileTool({clipboard:!0,file:n}),e)}}},this.beforeCopyListener=function(t){e.isActiveComponent()&&t.preventDefault()},this.copyListener=function(t){if(e.isActiveComponent()){var r=e.getActiveComponent(),n=e.project;if("heatMap"===r||t.shiftKey){var i=e.getTotalSize(),o=i.height,a=i.width,s=$("<canvas></canvas>")[0];s.height=o,s.width=a;var l=s.getContext("2d");e.snapshot(l);var u=s.toDataURL();return t.originalEvent.clipboardData.setData("text/html",'<img src="'+u+'">'),t.preventDefault(),void t.stopImmediatePropagation()}var c=n.getSelectedDataset({emptyToAll:!1}),h=c.getRowCount()>0,p=c.getColumnCount()>0,d=c.getColumnMetadata(),f=c.getRowMetadata(),m=e.getVisibleTrackNames(!0),g=[];_.each(m,function(e){var t=morpheus.MetadataUtil.indexOf(d,e);-1!==t&&g.push(t)}),d=new morpheus.MetadataModelColumnView(d,g),f=c.getRowMetadata();var v=e.getVisibleTrackNames(!1),y=[];_.each(v,function(e){var t=morpheus.MetadataUtil.indexOf(f,e);-1!==t&&y.push(t)}),f=new morpheus.MetadataModelColumnView(f,y);var b=[];if(h&&p)b=(new morpheus.GctWriter).write(c);else{b=[];for(var w=h?f:d,x=0,S=w.getItemCount();x<S;x++){for(var C=0,M=w.getMetadataCount();C<M;C++){var T=w.get(C);C>0&&b.push("\t"),b.push(morpheus.Util.toString(T.getValue(x)))}b.push("\n")}b=b.join("")}t.originalEvent.clipboardData.setData("text/plain",b),t.preventDefault(),t.stopImmediatePropagation()}},"undefined"!=typeof window&&$(window).on("paste.morpheus",this.pasteListener).on("beforecopy.morpheus",this.beforeCopyListener).on("copy.morpheus",this.copyListener),this.options.keyboard&&!morpheus.Util.isHeadless()&&new morpheus.HeatMapKeyListener(this),this.options.symmetric&&this.getProject().setSymmetric(this),this.hammer=morpheus.Util.hammer(e.heatmap.canvas,["pan","pinch","tap","swipe"]).on("swipe",this.swipe=function(e){e.preventDefault()}).on("panend",this.panend=function(t){e.panning=!1,I&&(I=null,e.heatmap.setSelectionBox(null),e.heatmap.repaint()),t.preventDefault()}).on("panmove",this.panmove=function(t){if(I){var r=morpheus.CanvasUtil.getMousePosWithScroll(t.target,t,e.scrollLeft(),e.scrollTop()),n=e.heatmap.getRowPositions().getIndex(r.y,!1),i=e.heatmap.getColumnPositions().getIndex(r.x,!1);e.updatingScroll=!1,e.heatmap.setSelectionBox({y:[I.rowIndex,n],x:[I.columnIndex,i]});for(var o=new morpheus.Set,a=Math.min(I.rowIndex,n),s=Math.max(I.rowIndex,n);a<=s;a++)o.add(a);var l=new morpheus.Set;for(a=Math.min(I.columnIndex,i),s=Math.max(I.columnIndex,i);a<=s;a++)l.add(a);e.project.getRowSelectionModel().setViewIndices(o,!0),e.project.getColumnSelectionModel().setViewIndices(l,!0)}else{e.updatingScroll=!0;var u=!1,c=!1;0!==t.deltaY&&(r=P+t.deltaY,e.scrollTop(r),u=!0),0!==t.deltaX&&(r=R+t.deltaX,e.scrollLeft(r),c=!0),e.updatingScroll=!1,(u||c)&&e.paintAll({paintRows:u,paintColumns:u,invalidateRows:u,invalidateColumns:c})}t.preventDefault()}).on("panstart",this.panstart=function(t){if(e.panning=!0,e.project.setHoverRowIndex(-1),e.project.setHoverColumnIndex(-1),t.srcEvent.shiftKey){var r=morpheus.CanvasUtil.getMousePosWithScroll(t.target,t,e.scrollLeft(),e.scrollTop());I={rowIndex:e.heatmap.getRowPositions().getIndex(r.y,!1),columnIndex:e.heatmap.getColumnPositions().getIndex(r.x,!1)}}else I=null,P=e.scrollTop(),R=e.scrollLeft();t.preventDefault()}).on("tap",this.tap=function(t){morpheus.Util.IS_MAC&&t.srcEvent.ctrlKey||(e.project.getRowSelectionModel().setViewIndices(new morpheus.Set,!0),e.project.getColumnSelectionModel().setViewIndices(new morpheus.Set,!0))}).on("pinch",this.pinch=function(t){var r=t.scale;e.heatmap.getRowPositions().setSize(14*r),e.heatmap.getColumnPositions().setSize(14*r);var n={};-1!==e.project.getHoverRowIndex()&&(n.scrollTop=this.heatmap.getRowPositions().getPosition(this.project.getHoverRowIndex())),-1!==e.project.getHoverColumnIndex()&&(n.scrollLeft=this.heatmap.getColumnPositions().getPosition(this.project.getHoverColumnIndex())),e.revalidate(n),t.preventDefault()});var L=function(t){var r,n;if("mouseout"===t.type)r=-1,n=-1;else{var i=morpheus.CanvasUtil.getMousePosWithScroll(t.target,t,e.scrollLeft(),e.scrollTop());r=e.heatmap.getRowPositions().getIndex(i.y,!1),n=e.heatmap.getColumnPositions().getIndex(i.x,!1)}e.setMousePosition(r,n,{event:t})};$(e.heatmap.canvas).on("mouseout",L).on("mousemove",L),_.each(this.options.tools,function(t){var r=e.getActionManager().getAction(t.name);if(null==r)console.log(t.name+" not found.");else{var n=r.gui(),i=n.gui(e.getProject()),o=new morpheus.FormBuilder;_.each(i,function(e){o.append(e)});var a={};if(_.each(i,function(e){a[e.name]=o.getValue(e.name)}),t.params)for(var s in t.params)a[s]=t.params[s];n.execute({heatMap:e,project:e.getProject(),input:a})}})},setMousePosition:function(e,t,r){this.mousePositionOptions=r;var n=this.project.getHoverColumnIndex()!==t,i=this.project.getHoverRowIndex()!==e;n||i?(this.panning||(this.project.setHoverRowIndex(e),this.project.setHoverColumnIndex(t)),this.setToolTip(e,t,r),this.paintAll({paintRows:i,paintColumns:n,invalidateRows:!1,invalidateColumns:!1})):this._updateTipFollowPosition(r),this.trigger("change",{name:"setMousePosition",source:this,arguments:arguments})},getContentEl:function(){return this.$content},focus:function(){var e=document.body.scrollTop;this.$tabPanel.focus(),document.body.scrollTop=e},getFocusEl:function(){return this.$tabPanel},setTooltipMode:function(e){this._togglingInfoWindow=!0,this.options.tooltipMode=e,this.$tipInfoWindow.html(""),this.toolbar.$tip.html(""),this.$tipFollow.html("").css({display:"none"}),this.toolbar.$tip.css("display",0===e?"":"none"),this.setToolTip(-1,-1),1===this.options.tooltipMode?this.$tipInfoWindow.dialog("open"):this.$tipInfoWindow.dialog("close"),this._togglingInfoWindow=!1},toggleInfoWindow:function(){this.setTooltipMode(1==this.options.tooltipMode?0:1)},_setTipText:function(e,t,r){0===this.options.tooltipMode?this.toolbar.$tip.html(e.join("")):1===this.options.tooltipMode&&this.$tipInfoWindow.html(e.join("")),null!=t?(this.tipFollowHidden=!1,this.$tipFollow.html(t),this._updateTipFollowPosition(r)):(this.tipFollowHidden=!0,this.$tipFollow.empty().css({display:"none"})),this.trigger("change",{name:"setToolTip",source:this,arguments:arguments})},setToolTip:function(e,t,r){if(r=r||{},this.options.showSeriesNameInTooltip&&(r.showSeriesNameInTooltip=!0),this.options.tooltipSeriesIndices&&(r.tooltipSeriesIndices=this.options.tooltipSeriesIndices),r.heatMapLens){var n=$("<div></div>"),i=0,o=0,a=[],s=[];if(null!=e&&e.length>0){for(var l=0;l<e.length;l++)(u=e[l])>=0&&(u>=this.heatmap.lastPosition.bottom||u<this.heatmap.lastPosition.top)?s.push(u):a.push(u);if(s.length<20)for(l=0;l<s.length;l++){for(var u=s[l],c=this.heatmap.getUnscaledWidth(),h=u,p=u+1,d=(C=this.heatmap.rowPositions.getPosition(h))+this.heatmap.rowPositions.getItemSize(h)-C,f=morpheus.CanvasUtil.createCanvas(),m=0,g=0,v=this.rowTracks.length;g<v;g++)(R=this.rowTracks[g]).isVisible()&&(m+=R.getUnscaledWidth());var y=m+c+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS;f.width=y*morpheus.CanvasUtil.BACKING_SCALE,f.style.width=y+"px",f.height=d*morpheus.CanvasUtil.BACKING_SCALE,f.style.height=d+"px";var b=f.getContext("2d");for(morpheus.CanvasUtil.resetTransform(b),b.save(),b.translate(-this.heatmap.lastClip.x,-C),b.rect(this.heatmap.lastClip.x,C,this.heatmap.lastClip.width,this.heatmap.lastClip.height),b.clip(),this.heatmap._draw({left:this.heatmap.lastPosition.left,right:this.heatmap.lastPosition.right,top:h,bottom:p,context:b}),b.restore(),b.translate(c+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS,-C),m=0,g=0,v=this.rowTracks.length;g<v;g++)(R=this.rowTracks[g]).isVisible()&&(b.save(),b.translate(m,0),b.rect(0,C,R.getUnscaledWidth(),R.lastClip.height),b.clip(),R._draw({start:h,end:p,vector:R.getVector(),context:b,availableSpace:R.getUnscaledWidth()}),b.restore(),m+=R.getUnscaledWidth());$(f).appendTo(n),f.style.top=i+"px",i+=parseFloat(f.style.height),o=parseFloat(f.style.width)}if(s.length>0){if(s.length<20){n.css({height:i,width:o});var w=this.$parent[0].getBoundingClientRect();this.$tipFollow.html(n).css({display:"",left:Math.round(parseFloat(this.heatmap.canvas.style.left)-1)+"px",top:r.event.clientY-w.top-i/2+"px"})}else this.$tipFollow.html("");return}var x=[],_=[];if(a.length<20)for(l=0;l<a.length;l++)this.tooltipProvider(this,a[l],-1,r,0===this.options.tooltipMode?"&nbsp;&nbsp;&nbsp;":"<br />",!1,x),this.options.inlineTooltip&&this.tooltipProvider(this,a[l],-1,r,"<br />",!0,_);var S=_.join("");this._setTipText(x,0===S.length?null:'<span style="max-width:400px;">'+S+"</span>",r)}if(null!=t&&t.length>0){for(l=0;l<t.length;l++)(M=t[l])>=0&&(M>=this.heatmap.lastPosition.right||M<this.heatmap.lastPosition.left)?s.push(M):a.push(M);if(s.length<20)for(l=0;l<s.length;l++){var C,M=s[l],T=(d=this.heatmap.getUnscaledHeight(),M),A=M+1,E=(c=(C=this.heatmap.columnPositions.getPosition(T))+this.heatmap.columnPositions.getItemSize(T)-C,f=morpheus.CanvasUtil.createCanvas(),0);for(g=0,v=this.columnTracks.length;g<v;g++)(R=this.columnTracks[g]).isVisible()&&(E+=R.getUnscaledHeight());var P=E+d+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS;for(f.width=c*morpheus.CanvasUtil.BACKING_SCALE,f.style.width=c+"px",f.height=P*morpheus.CanvasUtil.BACKING_SCALE,f.style.height=P+"px",b=f.getContext("2d"),morpheus.CanvasUtil.resetTransform(b),b.translate(-C,0),b.save(),b.rect(C,E+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS,this.heatmap.lastClip.width,this.heatmap.lastClip.height+E+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS),b.clip(),b.translate(0,E+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS-this.heatmap.lastClip.y),this.heatmap._draw({top:this.heatmap.lastPosition.top,bottom:this.heatmap.lastPosition.bottom,left:T,right:A,context:b}),b.restore(),E=0,g=0,v=this.columnTracks.length;g<v;g++){var R;(R=this.columnTracks[g]).isVisible()&&(b.save(),b.translate(0,E),b.rect(C,0,R.lastClip.width,R.getUnscaledHeight()),b.clip(),R._draw({start:T,end:A,vector:R.getVector(),context:b,availableSpace:R.getUnscaledHeight(),clip:{x:R.lastClip.x,y:R.lastClip.y}}),b.restore(),E+=R.getUnscaledHeight())}f.style.left=o+"px",o+=parseFloat(f.style.width),i=parseFloat(f.style.height),$(f).appendTo(n)}if(s.length>0)return void(s.length<20?(n.css({height:i,width:o}),w=this.$parent[0].getBoundingClientRect(),this.$tipFollow.html(n).css({top:parseFloat(this.heatmap.canvas.style.top)-E-morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS-1,left:r.event.clientX-w.left-o/2,display:""})):this.$tipFollow.html(""));if(x=[],_=[],a.length<20)for(l=0;l<a.length;l++)this.tooltipProvider(this,-1,a[l],r,0===this.options.tooltipMode?"&nbsp;&nbsp;&nbsp;":"<br />",!1,x),this.options.inlineTooltip&&this.tooltipProvider(this,-1,a[l],r,"<br />",!0,_);S=_.join(""),this._setTipText(x,""===S?null:'<span style="max-width:400px;">'+S+"</span>",r)}}x=[],this.tooltipProvider(this,e,t,r,0===this.options.tooltipMode?"&nbsp;&nbsp;&nbsp;":"<br />",!1,x),S=[];var I,N=!1;this.panning||(_=[],this.options.inlineTooltip&&(this.tooltipProvider(this,e,t,r,"<br />",!0,_),this.options.tooltip&&-1!==e&&-1!==t&&_.push('<div data-name="tip"></div>')),S=_.join(""),I=$('<span style="max-width:400px;">'+S+"</span>"),this.options.tooltip&&-1!==e&&-1!==t&&(this.options.tooltip(this,e,t,I.find("[data-name=tip]")),N=!0)),this._setTipText(x,S.length>0||N?I:null,r)},_updateTipFollowPosition:function(e){if(!this.tipFollowHidden){var t=this.$parent[0].getBoundingClientRect(),r=this.$tipFollow[0].getBoundingClientRect(),n=r.width,i=r.height,o=e.event.clientX-t.left+10,a=e.event.clientY-t.top+10;o+n>=t.right-t.left-18&&(o=e.event.clientX-t.left-10-n),a+i>=t.bottom-t.top-18&&(a=e.event.clientY-t.top-10-i),this.$tipFollow.css({left:o+"px",top:a+"px",display:""})}},setTrackVisibility:function(e){var t=this;_.each(e,function(e){var r=t.getTrack(e.name,e.isColumns);e.visible&&null!=r&&0===_.keys(r.settings).length&&r.settingFromConfig("Text"),t.setTrackVisible(e.name,e.visible,e.isColumns)}),this.revalidate(),this.trigger("change",{name:"setTrackVisibility",source:this,arguments:arguments})},setTrackVisible:function(e,t,r){var n=this.getTrackIndex(e,r);if(-1===n){if(!t)return;this.addTrack(e,r)}else{var i=r?this.columnTracks[n]:this.rowTracks[n],o=r?this.columnTrackHeaders[n]:this.rowTrackHeaders[n];if(i.isVisible()===t)return;i.setVisible(t),o.setVisible(t)}this.trigger("change",{name:"setTrackVisible",source:this,arguments:arguments})},addTrack:function(e,t,r,n){if(void 0===e)throw"Name not specified";var i=t?this.columnTracks:this.rowTracks,o=t?this.columnTrackHeaders:this.rowTrackHeaders,a=this.getTrackIndex(e,t);if(-1!==a)return i[a];if(null==r){var s=t?this.project.getFullDataset().getColumnMetadata():this.project.getFullDataset().getRowMetadata();r="[number]"===morpheus.VectorUtil.getDataType(s.getByName(e))?{display:["bar"]}:{display:["text"]}}var l=t?this.heatmap.getColumnPositions():this.heatmap.getRowPositions(),u=new morpheus.VectorTrack(this.project,e,l,t,this);u.settingFromConfig(r),u.appendTo(this.$parent);var c=new morpheus.VectorTrackHeader(this.project,e,t,this);return c.appendTo(this.$parent),u._selection=new morpheus.TrackSelection(u,l,t?this.project.getColumnSelectionModel():this.project.getRowSelectionModel(),t,this),null!=n&&n>=0?(i.splice(n,0,u),o.splice(n,0,c)):(i.push(u),o.push(c)),u},addPopup:function(e){this.popupItems||(this.popupItems=[]),this.popupItems.push(e)},getPopupItems:function(){return this.popupItems||[]},removeTrack:function(e,t){var r=this.getTrackIndex(e,t),n=t?this.columnTracks:this.rowTracks;if(isNaN(r)||r<0||r>=n.length)console.log("removeTrack: "+e+" not found.");else{var i=t?this.columnTrackHeaders:this.rowTrackHeaders,o=n[r],a=i[r];o.dispose(),a.dispose(),n.splice(r,1),i.splice(r,1),this.trigger("change",{name:"removeTrack",source:this,arguments:arguments})}},updateDataset:function(){var e=this.project.getSortedFilteredDataset();this.verticalSearchBar.update(),this.horizontalSearchBar.update(),this.heatmap.setDataset(e),this.heatmap.getRowPositions().setSpaces(morpheus.HeatMap.createGroupBySpaces(e,this.project.getGroupRows(),this.rowGapSize,!1)),this.heatmap.getColumnPositions().setSpaces(morpheus.HeatMap.createGroupBySpaces(e,this.project.getGroupColumns(),this.columnGapSize,!0)),this.trigger("change",{name:"updateDataset",source:this,arguments:arguments})},zoom:function(e,t){t=$.extend({},{rows:!0,columns:!0},t),e?(t.rows&&this.heatmap.getRowPositions().setSize(1.5*this.heatmap.getRowPositions().getSize()),t.columns&&this.heatmap.getColumnPositions().setSize(1.5*this.heatmap.getColumnPositions().getSize())):(t.rows&&this.heatmap.getRowPositions().setSize(this.heatmap.getRowPositions().getSize()/1.5),t.columns&&this.heatmap.getColumnPositions().setSize(this.heatmap.getColumnPositions().getSize()/1.5));var r={};t.rows&&-1!==this.project.getHoverRowIndex()&&(r.scrollTop=this.heatmap.getRowPositions().getPosition(this.project.getHoverRowIndex())),t.columns&&-1!==this.project.getHoverColumnIndex()&&(r.scrollLeft=this.heatmap.getColumnPositions().getPosition(this.project.getHoverColumnIndex())),this.revalidate(r),this.trigger("change",{name:"zoom",source:this,arguments:arguments})},getTrackIndex:function(e,t){for(var r=t?this.columnTracks:this.rowTracks,n=0,i=r.length;n<i;n++)if(void 0!==r[n].name&&r[n].name===e)return n;return-1},getNumTracks:function(e){return e?this.columnTracks.length:this.rowTracks.length},moveTrack:function(e,t,r){var n=r?this.columnTracks:this.rowTracks,i=r?this.columnTrackHeaders:this.rowTrackHeaders,o=n[e];n.splice(e,1);var a=i[e];i.splice(e,1),n.splice(t,0,o),i.splice(t,0,a),this.trigger("change",{name:"moveTrack",source:this,arguments:arguments})},getTrackByIndex:function(e,t){return t?this.columnTracks[e]:this.rowTracks[e]},getTrackHeaderByIndex:function(e,t){return t?this.columnTrackHeaders[e]:this.rowTrackHeaders[e]},getTrack:function(e,t){var r=this.getTrackIndex(e,t);if(-1!==r)return t?this.columnTracks[r]:this.rowTracks[r]},isActiveComponent:function(){var e=document.activeElement,t=e.tagName;return"INPUT"!=t&&"SELECT"!=t&&"TEXTAREA"!=t&&this.$tabPanel[0].contains(e)},getActiveComponent:function(){var e=document.activeElement;if("CANVAS"===e.tagName){for(var t=0,r=this.columnTracks.length;t<r;t++)if(this.columnTracks[t].canvas===e)return"columnTrack";for(t=0,r=this.rowTracks.length;t<r;t++)if(this.rowTracks[t].canvas===e)return"rowTrack";if(this.heatmap.canvas===e)return"heatMap"}return""},dispose:function(){null!=this.project&&(this.project.off(),this.$tipInfoWindow.dialog("destroy"),this.rowTrackHeaders.forEach(function(e){e.dispose()}),this.columnTrackHeaders.forEach(function(e){e.dispose()}),this.rowTracks.forEach(function(e){e.dispose()}),this.columnTracks.forEach(function(e){e.dispose()}),null!=this.rowDendrogram&&this.rowDendrogram.dispose(),null!=this.columnDendrogram&&this.columnDendrogram.dispose(),this.beforeColumnTrackDivider.dispose(),this.afterRowDendrogramDivider.dispose(),this.afterVerticalScrollBarDivider.dispose(),this.hscroll.dispose(),this.vscroll.dispose(),this.hammer.off("swipe",this.swipe).off("panmove",this.panmove).off("panstart",this.panstart).off("tap",this.tap).off("pinch",this.pinch).off("panend",this.panend),this.hammer.destroy(),"undefined"!=typeof window&&$(window).off("paste.morpheus",this.pasteListener).off("beforecopy.morpheus",this.beforeCopyListener).off("copy.morpheus",this.copyListener).off("orientationchange.morpheus resize.morpheus",this.resizeListener))},getVisibleTrackNames:function(e){return this.getVisibleTracks(e).map(function(e){return e.name})},getVisibleTracks:function(e){var t=e?this.columnTracks:this.rowTracks;return null==t&&(t=[]),t.filter(function(e){return e.isVisible()&&!e.getFullVector().getProperties().has(morpheus.VectorKeys.IS_INDEX)})},isShowRowNumber:function(){return this.options.showRowNumber},setShowRowNumber:function(e){if(this.options.showRowNumber=e,e){var t=this.addTrack("#",!1,{popupEnabled:!1,display:["text"]},0);t.getVector=function(e){var t=new morpheus.AbstractVector("#",this.project.getSortedFilteredDataset().getRowCount());return t.getProperties().set(morpheus.VectorKeys.FORMATTER,{pattern:"i"}),t.getValue=function(e){return e+1},t},t.getFullVector=function(){var e=new morpheus.AbstractVector("#",this.project.getFullDataset().getRowCount());return e.getProperties().set(morpheus.VectorKeys.FORMATTER,{pattern:"i"}),e.getValue=function(e){return e+1},e},t.showPopup=function(e,t){e.preventDefault&&e.preventDefault()}}else this.removeTrack("#",!1)},resizeTrack:function(e,t,r,n){var i=this.getTrackIndex(e,n);if(-1===i)throw e+" not found in resize track";if(n){if(a=this.columnTracks[i],s=this.columnTrackHeaders[i],r&&(a.setPrefHeight(r),s.setPrefHeight(r)),t)for(var o=0;o<this.columnTracks.length;o++)this.columnTracks[o].setPrefWidth(t),this.columnTrackHeaders[o].setPrefWidth(t)}else{var a=this.rowTracks[i],s=this.rowTrackHeaders[i];a.setPrefWidth(t),s.setPrefWidth(t)}this.revalidate(),this.trigger("change",{name:"resizeTrack",source:this,arguments:arguments})},isDendrogramVisible:function(e){if(void 0!==(e?this.columnDendrogram:this.rowDendrogram))return morpheus.HeatMap.isDendrogramVisible(this.project,e)},paintAll:function(e){var t=this.heatmap.getUnscaledHeight(),r=this.heatmap.getUnscaledWidth(),n=this.scrollTop(),i=this.scrollLeft();this.hscroll.paint(),this.vscroll.paint();var o=e.paintRows,a=e.paintColumns,s=e.invalidateRows,l=e.invalidateColumns;if(this.hSortByValuesIndicator.setInvalid(s||l),this.hSortByValuesIndicator.paint({x:i,y:0,width:r,height:this.hSortByValuesIndicator.getUnscaledHeight()}),this.vSortByValuesIndicator.setInvalid(s||l),this.vSortByValuesIndicator.paint({x:0,y:n,width:this.vSortByValuesIndicator.getUnscaledWidth(),height:t}),o){for(var u=0,c=this.rowTracks.length;u<c;u++)(h=this.rowTracks[u]).setInvalid(s),h.isVisible()&&(h.paint({x:0,y:n,height:t,width:r}),this.rowTrackHeaders[u].paint());null!=this.rowDendrogram&&(this.rowDendrogram.setInvalid(s),this.isDendrogramVisible(!1)?(this.rowDendrogram.setVisible(!0),this.rowDendrogram.paint({x:0,y:n,height:t,width:this.rowDendrogram.getUnscaledWidth()})):this.rowDendrogram.setVisible(!1))}if(a){for(u=0,c=this.columnTracks.length;u<c;u++){var h;(h=this.columnTracks[u]).setInvalid(l),h.paint({x:i,y:0,width:r,height:h.getUnscaledHeight()}),this.columnTrackHeaders[u].paint()}null!=this.columnDendrogram&&(this.columnDendrogram.setInvalid(l),this.isDendrogramVisible(!0)?(this.columnDendrogram.setVisible(!0),this.columnDendrogram.paint({x:i,y:0,width:r,height:this.columnDendrogram.getUnscaledHeight()})):this.columnDendrogram.setVisible(!1))}(s||l)&&this.heatmap.setInvalid(!0),this.heatmap.paint({x:i,y:n,width:r,height:t}),this.trigger("change",{name:"paintAll",source:this,arguments:arguments})},scrollTop:function(e){return void 0===e?this.vscroll.getValue():(isNaN(e)&&(e=0),this.vscroll.getVisibleExtent()===this.vscroll.getTotalExtent()&&(e=0),e=Math.max(e,0),(e=Math.min(this.vscroll.getMaxValue(),e))!==this.vscroll.getValue()&&(this.vscroll.setValue(e,!0),this.trigger("change",{name:"scrollTop",source:this,arguments:arguments})),e)},scrollLeft:function(e){return void 0===e?this.hscroll.getValue():(isNaN(e)&&(e=0),this.hscroll.getVisibleExtent()===this.hscroll.getTotalExtent()&&(e=0),e=Math.max(e,0),(e=Math.min(this.hscroll.getMaxValue(),e))!==this.hscroll.getValue()&&(this.trigger("change",{name:"scrollLeft",source:this,arguments:arguments}),this.hscroll.setValue(e,!0)),e)},getSelectedTrackName:function(e){return e?this.selectedColumnTrackName:this.selectedRowTrackName},getLastSelectedTrackInfo:function(){return this.selectedTrackInfo},setSelectedTrack:function(e,t){var r,n=t?this.selectedColumnTrackName:this.selectedRowTrackName;e!==n&&(-1!==(r=this.getTrackIndex(n,t))&&this.getTrackHeaderByIndex(r,t).setSelected(!1),t?(this.selectedColumnTrackName=e,this.selectedTrackInfo={name:e,isColumns:!0}):(this.selectedRowTrackName=e,this.selectedTrackInfo={name:e,isColumns:!1}),-1!==(r=this.getTrackIndex(e,t))&&this.getTrackHeaderByIndex(r,t).setSelected(!0),this.trigger("change",{name:"setSelected",source:this,arguments:arguments}))},saveImage:function(e,t){var r=this,n=this.getTotalSize();if("pdf"===t){var i=new canvas2pdf.PdfContext(blobStream(),{size:[n.width,n.height]});this.snapshot(i),i.stream.on("finish",function(){var t=i.stream.toBlob("application/pdf");saveAs(t,e,!0)}),i.end()}else if("svg"===t){i=new C2S(n.width,n.height),this.snapshot(i);var o=i.getSerializedSvg(),a=[];a.push('<?xml version="1.0" encoding="utf-8"?>\n'),a.push('<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'),o=a.join("")+o;var s=new Blob([o],{type:"text/plain;charset=utf-8"});saveAs(s,e,!0)}else{var l=$("<canvas></canvas>")[0],u=n.height,c=n.width,h=morpheus.CanvasUtil.BACKING_SCALE;l.height=h*u,l.style.height=u+"px",l.width=h*c,l.style.width=c+"px",i=l.getContext("2d"),morpheus.CanvasUtil.resetTransform(i),this.snapshot(i),l[l.toBlobHD?["toBlobHD"]:"toBlob"](function(t){null!=t&&0!==t.size?saveAs(t,e,!0):morpheus.FormBuilder.showInModal({title:"Save Image",html:"Image is too large to save.",appendTo:r.getContentEl(),focus:r.getFocusEl()})})}},getTotalSize:function(e){e=$.extend({},{legend:!0},e);var t=this.heatmap.getPreferredSize(),r={width:t.width,height:t.height};this.isDendrogramVisible(!1)&&(r.width+=this.rowDendrogram.getUnscaledWidth()+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS),this.isDendrogramVisible(!0)&&(r.height+=this.columnDendrogram.getUnscaledHeight()+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS);for(var n=0,i=0,o=this.rowTracks.length;i<o;i++)if(this.rowTracks[i].isVisible()){var a=this.rowTrackHeaders[i].getPrintSize();r.width+=a.width,n=Math.max(n,a.height)}var s=0,l=0;for(i=0,o=this.columnTracks.length;i<o;i++)if(this.columnTracks[i].isVisible()){var u=this.columnTrackHeaders[i].getPrintSize();l+=u.height,s=Math.max(s,u.width)}if(r.height+=Math.max(l,n)+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS,r.width+=s+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS,e.legend){var c=15,h=0,p=this.heatmap.getColorScheme().getColorByValues(),d=p.length;for(i=0;i<d;i++){var f=p[i];if(null!=f||1===d){this.heatmap.getColorScheme().setCurrentValue(f);var m=this.heatmap.getColorScheme().getNames();h=Math.max(h,null!=m?14*m.length:30),c+=250}}h+=10,r.height=r.height+h,r.width=Math.max(r.width,c)}var g=new morpheus.HeatMapTrackColorLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&(e.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR))}),this.getProject().getColumnColorModel()).getPreferredSize();return r.height+=g.height,r.width=Math.max(r.width,g.width),g=new morpheus.HeatMapTrackColorLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&(e.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR))}),this.getProject().getRowColorModel()).getPreferredSize(),r.height+=g.height,r.width=Math.max(r.width,g.width),g=new morpheus.HeatMapTrackShapeLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)}),this.getProject().getColumnShapeModel()).getPreferredSize(),r.height+=g.height,r.width=Math.max(r.width,g.width),g=new morpheus.HeatMapTrackShapeLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)}),this.getProject().getRowShapeModel()).getPreferredSize(),r.height+=g.height,r.width=Math.max(r.width,g.width),g=new morpheus.HeatMapTrackShapeLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)}),this.getProject().getColumnFontModel()).getPreferredSize(),r.height+=g.height,r.width=Math.max(r.width,g.width),g=new morpheus.HeatMapTrackShapeLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)}),this.getProject().getRowFontModel()).getPreferredSize(),r.height+=g.height,r.width=Math.max(r.width,g.width),r},getHeatMapElementComponent:function(){return this.heatmap},snapshot:function(e,t){t=$.extend({},{legend:!0},t);var r=this.heatmap.getPreferredSize(),n=(this.getTotalSize(t),0);if(t.legend){var i=this.heatmap.getColorScheme().getColorByValues();e.save(),e.translate(15,0);var o=i.length,a=0;for(o=i.length;a<o;a++){var s=i[a];if(null!=s||1===o){(u=new morpheus.ColorSupplierLegend(this.heatmap.getColorScheme(),s)).draw({},e),n=Math.max(n,u.getUnscaledHeight());var l=u.getUnscaledWidth();e.translate(l,0)}}n+=10,e.restore()}var u,c=15,h=0;e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackColorLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&(e.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR))}),this.getProject().getColumnColorModel())).draw({},e);var p=u.getPreferredSize();c+=p.width,h=Math.max(h,p.height),e.restore(),e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackShapeLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)}),this.getProject().getColumnShapeModel())).draw({},e),c+=(p=u.getPreferredSize()).width,h=Math.max(h,p.height),e.restore(),e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackFontLegend(_.filter(this.columnTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)}),this.getProject().getColumnFontModel())).draw({},e),c+=(p=u.getPreferredSize()).width,h=Math.max(h,p.height),e.restore(),e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackColorLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&(e.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR))}),this.getProject().getRowColorModel())).draw({},e),c+=(p=u.getPreferredSize()).width,h=Math.max(h,p.height),e.restore(),e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackShapeLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)}),this.getProject().getRowShapeModel())).draw({},e),c+=(p=u.getPreferredSize()).width,h=Math.max(h,p.height),e.restore(),e.save(),e.translate(c,n),(u=new morpheus.HeatMapTrackFontLegend(_.filter(this.rowTracks,function(e){return e.isVisible()&&e.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)}),this.getProject().getRowFontModel())).draw({},e),c+=(p=u.getPreferredSize()).width,h=Math.max(h,p.height),e.restore(),n+=h;for(var d=this.isDendrogramVisible(!0)?this.columnDendrogram.getUnscaledHeight()+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS:0,f=d+=n,m=this.isDendrogramVisible(!1)?this.rowDendrogram.getUnscaledWidth()+morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS:0,g=!1,v=(a=0,this.columnTracks.length);a<v;a++)if((A=this.columnTracks[a]).isVisible()){var y=(b=this.columnTrackHeaders[a]).getPrintSize();m=Math.max(m,y.width),d+=y.height,g=!0}for(g&&(d+=morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS),a=0,v=this.rowTracks.length;a<v;a++)if((A=this.rowTracks[a]).isVisible()){var b=this.rowTrackHeaders[a];d=Math.max(d,b.getPrintSize().height)}if(this.isDendrogramVisible(!0)){var w={x:0,y:0,height:this.columnDendrogram.getUnscaledHeight(),width:r.width};e.save(),e.translate(m,n),this.columnDendrogram.prePaint(w,e),this.columnDendrogram.draw(w,e),e.restore()}if(this.isDendrogramVisible(!1)){var x={x:0,y:0,width:this.rowDendrogram.getUnscaledWidth(),height:r.height};e.save(),e.translate(0,d),this.rowDendrogram.prePaint(x,e),this.rowDendrogram.draw(x,e),e.restore()}for(a=0,v=this.columnTracks.length;a<v;a++)if((A=this.columnTracks[a]).isVisible()){e.save();var S=(b=this.columnTrackHeaders[a]).getPrintSize();e.translate(m,f);var C={x:0,y:0,width:r.width,height:S.height};A.print(C,e),e.restore(),e.save();var M={x:0,y:0,width:S.width,height:C.height};e.translate(m-2,f+C.height),b.print(M,e),e.restore(),f+=Math.max(M.height,C.height)}e.save(),e.translate(m,d),this.heatmap.draw({x:0,y:0,width:r.width,height:r.height},e),e.restore();var T=0;for(a=0,v=this.rowTracks.length;a<v;a++){var A;if((A=this.rowTracks[a]).isVisible()){e.save();var E=morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS+m+r.width+T,P=d;C={x:0,y:0,width:(S=(b=this.rowTrackHeaders[a]).getPrintSize()).width,height:r.height},e.translate(E,P),e.strokeStyle="white",e.rect(0,0,C.width,C.height),e.stroke(),e.clip(),A.print(C,e),e.restore(),e.save(),M={x:0,y:0,width:S.width,height:S.height},e.translate(E,P-4),b.print(M,e),e.restore(),T+=Math.max(S.width,C.width)}}},resetZoom:function(){var e=this.heatmap,t=e.getRowPositions(),r=e.getColumnPositions();t.setSize(14),r.setSize(14);var n={};-1!==this.project.getHoverRowIndex()&&(n.scrollTop=this.heatmap.getRowPositions().getPosition(this.project.getHoverRowIndex())),-1!==this.project.getHoverColumnIndex()&&(n.scrollLeft=this.heatmap.getColumnPositions().getPosition(this.project.getHoverColumnIndex())),this.revalidate(n)},getFitColumnSize:function(){var e=this.heatmap,t=this.getAvailableWidth();if(-1===t)return 14;this.rowDendrogram&&(t-=this.rowDendrogram.getUnscaledWidth());for(var r=12,n=0,i=this.rowTracks.length;n<i;n++)(o=this.rowTracks[n]).isVisible()&&(r+=o.getUnscaledWidth());for(n=0,i=this.columnTracks.length;n<i;n++){var o;if((o=this.columnTracks[n]).isVisible()){r+=this.columnTrackHeaders[n].getUnscaledWidth();break}}t-=r;var a=e.getColumnPositions(),s=a.getItemSize(a.getLength()-1)+a.getPosition(a.getLength()-1),l=a.getSize();return l*=t/s,Math.min(14,l)},getFitRowSize:function(){var e=this.heatmap,t=this.getAvailableHeight();if(-1===t)return 14;this.columnDendrogram&&(t-=this.columnDendrogram.getUnscaledHeight());for(var r=12,n=0,i=this.columnTracks.length;n<i;n++){var o=this.columnTracks[n];o.isVisible()&&(r+=o.getUnscaledHeight())}t-=r;var a=e.getRowPositions(),s=a.getItemSize(a.getLength()-1)+a.getPosition(a.getLength()-1),l=a.getSize();return l*=t/s,Math.min(14,l)},fitToWindow:function(e){if(e.fitRows&&this.heatmap.getRowPositions().setSize(this.getFitRowSize()),e.fitColumns&&this.heatmap.getColumnPositions().setSize(this.getFitColumnSize()),e.repaint){var t={};e.fitRows&&-1!==this.project.getHoverRowIndex()&&(t.scrollTop=this.heatmap.getRowPositions().getPosition(this.project.getHoverRowIndex())),e.fitColumns&&-1!==this.project.getHoverColumnIndex()&&(t.scrollLeft=this.heatmap.getColumnPositions().getPosition(this.project.getHoverColumnIndex())),this.revalidate(t)}},getAvailableHeight:function(){if(_.isNumber(this.options.height))return this.options.height;var e=$(window).height()-this.$parent.offset().top-24;return"window"===this.options.height?e:Math.max(Math.round(.7*screen.height),e)},getAvailableWidth:function(){return this.options.width?this.options.width:this.tabManager.getWidth()-30},revalidate:function(e){if(morpheus.Util.isHeadless()){for(var t=0,r=this.rowTracks.length;t<r;t++)(x=this.rowTracks[t]).setInvalid(!0),x.isVisible()&&x.paint({x:0,y:0,height:10,width:10});for(t=0,r=this.columnTracks.length;t<r;t++)(x=this.columnTracks[t]).setInvalid(!0),x.isVisible()&&x.paint({x:0,y:0,height:10,width:10})}else{e=$.extend({},{paint:!0},e),this.updatingScroll=!0;var n=this.getAvailableHeight(),i=this.getAvailableWidth(),o=this.heatmap.getPreferredSize(),a=0,s=0;this.columnDendrogram&&(a=morpheus.CanvasUtil.getPreferredSize(this.columnDendrogram).height),this.rowDendrogram&&(s=morpheus.CanvasUtil.getPreferredSize(this.rowDendrogram).width);var l=0;for(t=0,r=this.rowTracks.length;t<r;t++)this.rowTracks[t].isVisible()&&(void 0!==this.rowTracks[t].getPrefWidth()&&this.rowTrackHeaders[t].setPrefWidth(this.rowTracks[t].getPrefWidth()),l+=Math.max(morpheus.CanvasUtil.getPreferredSize(this.rowTrackHeaders[t]).width,morpheus.CanvasUtil.getPreferredSize(this.rowTracks[t]).width));if(-1!==i&&l+s+o.width>i)for(l=0,t=0,r=this.rowTracks.length;t<r;t++)if(this.rowTracks[t].isVisible()){var u=morpheus.CanvasUtil.getPreferredSize(this.rowTrackHeaders[t]),c=Math.max(u.width,morpheus.CanvasUtil.getPreferredSize(this.rowTracks[t]).width);u.widthSet||(c=Math.min(400,c),this.rowTracks[t].setPrefWidth(c),this.rowTrackHeaders[t].setPrefWidth(c)),l+=c}var h=a,p=0;for(t=0,r=this.columnTracks.length;t<r;t++)this.columnTracks[t].isVisible()&&(void 0!==this.columnTracks[t].getPrefHeight()&&this.columnTrackHeaders[t].setPrefHeight(this.columnTracks[t].getPrefHeight()),c=morpheus.CanvasUtil.getPreferredSize(this.columnTrackHeaders[t]).width,p=Math.max(p,c));var d=Math.max(s,p),f=o.width,m=Math.max(50,-1===i?Number.MAX_VALUE:i-l-d-morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS);for(m>0&&f>m&&(f=m,f=Math.min(f,o.width)),void 0!==this.heatmap.prefWidth&&(f=Math.min(o.width,this.heatmap.prefWidth)),void 0!==this.columnDendrogram?(this.columnDendrogram.setBounds({width:f,height:a,left:d,top:0}),this.columnDendrogram.$label.css("left",d+this.columnDendrogram.getUnscaledWidth()+10).css("top",2),this.columnDendrogram.$squishedLabel.css("left",d+this.columnDendrogram.getUnscaledWidth()+10).css("top",18),this.beforeColumnTrackDivider.setVisible(!0),this.beforeColumnTrackDivider.setBounds({left:d-p,top:h,width:p}),h++):this.beforeColumnTrackDivider.setVisible(!1),t=0,r=this.columnTracks.length;t<r;t++)if((x=this.columnTracks[t]).isVisible()){var g=morpheus.CanvasUtil.getPreferredSize(x),v=morpheus.CanvasUtil.getPreferredSize(this.columnTrackHeaders[t]);g.height=Math.max(g.height,v.height),x.setBounds({width:f,height:g.height,left:d,top:h}),this.columnTrackHeaders[t].setBounds({width:p,height:g.height,left:d-p,top:h}),h+=g.height}this.$whitespace[0].style.left=Math.ceil(d+f+10)+"px",this.$whitespace[0].style.top="0px",h+=morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS;var y=o.height;-1!==n&&y>n-h&&(y=Math.max(100,Math.min(o.height,n-h))),h<0&&(h=0),this.rowDendrogram?(this.rowDendrogram.setBounds({width:Math.max(s,p),height:y,left:0,top:h}),this.rowDendrogram.$label.css("left",0).css("top",2),this.afterRowDendrogramDivider.setVisible(!0),this.afterRowDendrogramDivider.setBounds({height:y,left:this.rowDendrogram.getUnscaledWidth(),top:h}),d++):this.afterRowDendrogramDivider.setVisible(!1),this.heatmap.setBounds({width:f,height:y,left:d,top:h}),this.hSortByValuesIndicator.setBounds({height:4,width:f,left:d,top:h-4}),this.hscroll.setVisible(f<o.width),this.hscroll.setExtent(f,o.width,void 0!==e.scrollLeft?e.scrollLeft:o.width===this.hscroll.getTotalExtent()?this.hscroll.getValue():o.width*this.hscroll.getValue()/this.hscroll.getMaxValue()),this.hscroll.setBounds({left:d,top:h+y+2}),d+=f;var b=0;for(t=0,r=this.rowTracks.length;t<r;t++)if((x=this.rowTracks[t]).isVisible()){b++;break}this.vSortByValuesIndicator.setBounds({width:4,height:y,left:d,top:h}),b>0&&(d+=morpheus.HeatMap.SPACE_BETWEEN_HEAT_MAP_AND_ANNOTATIONS);var w=d;for(t=0,r=this.rowTracks.length;t<r;t++){var x;(x=this.rowTracks[t]).isVisible()&&(g=morpheus.CanvasUtil.getPreferredSize(x),v=morpheus.CanvasUtil.getPreferredSize(this.rowTrackHeaders[t]),g.width=Math.max(v.width,g.width),g.height=y,x.setBounds({width:g.width,height:g.height,left:d,top:h}),this.rowTrackHeaders[t].setBounds({width:g.width,left:d,top:h-v.height-5,height:v.height}),d+=g.width)}this.afterVerticalScrollBarDivider.setVisible(b>0),this.afterVerticalScrollBarDivider.setBounds({left:w-2,top:h-18}),this.vscroll.setVisible(y<o.height),this.vscroll.setExtent(y,o.height,void 0!==e.scrollTop?e.scrollTop:o.height===this.vscroll.getTotalExtent()?this.vscroll.getValue():o.height*this.vscroll.getValue()/this.vscroll.getMaxValue()),d+=2,this.vscroll.setBounds({left:d,top:h}),d+=this.vscroll.getUnscaledWidth(),this.hscroll.isVisible()&&(h+=this.hscroll.getUnscaledHeight()+2);var _=2+h+y;e.paint&&this.paintAll({paintRows:!0,paintColumns:!0,invalidateRows:!0,invalidateColumns:!0}),this.$parent.css({height:Math.ceil(_)+"px",width:-1===i?Math.ceil(d+2)+"px":""}),this.updatingScroll=!1,this.trigger("change",{name:"revalidate",source:this,arguments:arguments})}}},morpheus.HeatMap.copyFromParent=function(e,t){e.rowColorModel=t.parent.getProject().getRowColorModel().copy(),e.columnColorModel=t.parent.getProject().getColumnColorModel().copy(),e.rowShapeModel=t.parent.getProject().getRowShapeModel().copy(),e.columnShapeModel=t.parent.getProject().getColumnShapeModel().copy(),e.rowFontModel=t.parent.getProject().getRowFontModel().copy(),e.columnFontModel=t.parent.getProject().getColumnFontModel().copy();var r=t.parent.rowTracks||[],n=t.parent.columnTracks||[];if(t.inheritFromParentOptions.rows&&(e.columnShapeModel=e.rowShapeModel,e.columnColorModel=e.rowColorModel,e.columnFontModel=e.rowFontModel,n=r.slice().reverse()),t.inheritFromParentOptions.columns&&(e.rowShapeModel=e.columnShapeModel,e.rowColorModel=e.columnColorModel,e.rowFontModel=e.columnFontModel,r=n.slice().reverse()),t.inheritFromParentOptions.transpose){var i=e.rowShapeModel;e.rowShapeModel=e.columnShapeModel,e.columnShapeModel=i,i=e.rowColorModel,e.rowColorModel=e.columnColorModel,e.columnColorModel=i,i=e.rowFontModel,e.rowFontModel=e.columnFontModel,e.columnFontModel=i,i=r.slice().reverse(),r=n.slice().reverse(),n=i}t.rows=t.rows||[];for(var o=0;o<r.length;o++)(a=r[o]).isVisible()&&t.rows.push({order:t.rows.length,field:a.getName(),display:$.extend(!0,{},a.settings),force:!0});for(t.columns=t.columns||[],o=0;o<n.length;o++){var a;(a=n[o]).isVisible()&&t.columns.push({order:t.columns.length,field:a.getName(),display:$.extend(!0,{},a.settings),force:!0})}},morpheus.Util.extend(morpheus.HeatMap,morpheus.Events),morpheus.HelpMenu=function(){var e=[];e.push('<ul class="morpheus-footer-links">'),e.push('<li><a data-name="contact" href="#">Contact</a></li>'),e.push('<li><a target="_blank" href="documentation.html">Documentation</a></li>'),e.push('<li><a target="_blank" href="tutorial.html">Tutorial</a></li>'),e.push('<li><a href="configuration.html">Configuration</a></li>'),e.push('<li><a target="_blank" href="https://github.com/cmap/morpheus.R">R Interface</a></li>'),e.push('<li><a target="_blank" href="https://github.com/cmap/morpheus-export">Command Line</a></li>'),e.push('<li><a target="_blank" href="https://github.com/cmap/morpheus.js">Source Code</a></li>'),e.push("</ul>"),this.$el=$(e.join("")),this.$el.find("[data-name=contact]").on("click",function(e){morpheus.FormBuilder.showInModal({title:"Contact",html:"Please email us at morpheus@broadinstitute.org",focus:document.activeElement}),e.preventDefault()})},morpheus.HistogramLegend=function(e,t,r){morpheus.AbstractCanvas.call(this,!0),this.colorScheme=t,this.metadataValue=r,this.dataset=e,this.binNumberToOccurences=null,this.setBounds({width:250,height:70}),this.name=null,this.canvas.style.position="",this.canvas.style.border="1px solid LightGrey"},morpheus.HistogramLegend.prototype={binSize:0,maxCount:0,total:0,setName:function(e){this.name=e},setBinSize:function(e){this.binSize=e},buildHistogram:function(){var e=this.binSize,t=this.dataset,r=this.metadataValue,n=this.colorScheme,i=n.getMin(),o=n.getMax();i===o&&(i-=.5,o+=.5);var a=t.getRowMetadata().getByName(n.getSeparateColorSchemeForRowMetadataField()),s=Math.ceil((o-i)/e),l=new Uint32Array(s);this.binNumberToOccurences=l;for(var u=0,c=t.getRowCount();u<c;u++)if(null==a||a.getValue(u)===r)for(var h=0,p=t.getColumnCount();h<p;h++){var d=t.getValue(u,h);if(!isNaN(d)){var f=Math.floor((d-i)/e);f<0?f=0:f>=s&&(f=s-1),l[f]++}}var m=0,g=0;for(u=0;u<s;u++){var v=l[u];m=v>=m?v:m,g+=v}this.maxCount=m,this.total=g},draw:function(e,t){this.buildHistogram();var r=this.colorScheme,n=this.getUnscaledWidth()-50,i=d3.scale.linear().domain([r.getMin(),r.getMax()]).range([0,n]).clamp(!0),o=d3.scale.linear().domain([0,this.maxCount/this.total]).range([30,0]).clamp(!0),a=this.binNumberToOccurences,s=r.getMin(),l=this.binSize,u=o(0);null!=this.name&&(t.font="11px "+morpheus.CanvasUtil.getFontFamily(t),t.fillStyle="black",t.lineWidth=1,t.fillText(this.name,.5,12),t.translate(0,14)),t.lineWidth=.2,t.strokeStyle="#D3D2C2",t.fillStyle="#D3D2C2",t.translate(25,0),t.beginPath(),t.moveTo(0,u),t.lineTo(n,u),t.stroke(),t.lineWidth=1,t.strokeStyle="white";for(var c=0,h=a.length;c<h;c++){var p=a[c];if(p>0){p/=this.total;var d=s+c*l,f=d+l,m=i(d),g=i(f)-m,v=o(p);t.rect(m,u,g,v-u),t.fill(),t.stroke()}}t.translate(0,31),t.fillStyle="black",morpheus.HeatMapColorSchemeLegend.drawColorScheme(t,this.colorScheme,n,!1,!1,6)}},morpheus.Util.extend(morpheus.HistogramLegend,morpheus.AbstractCanvas),morpheus.LegendWithStops=function(){var e=this;morpheus.AbstractCanvas.call(this,!1),this.setBounds({width:300,height:40}),$(this.canvas).on("mousedown",function(t){var r=morpheus.CanvasUtil.getMousePos(t.target,t);e.selectedIndex=e.findIndexForPosition(r),e.trigger("selectedIndex",{selectedIndex:e.selectedIndex})}),this.hammer=morpheus.Util.hammer(this.canvas,["pan"]).on("panmove",this.panmove=function(t){if(-1!==e.selectedIndex){var r=morpheus.CanvasUtil.getMousePos(t.target,t),n=e.fractionToStopPix.invert(r.x);n=Math.max(0,n),n=Math.min(1,n),e.trigger("moved",{fraction:n})}}).on("panstart",this.panstart=function(e){}).on("panend",this.panend=function(t){e.selectedIndex=-1}),$(this.canvas).on("keydown",function(t){8!=t.which&&46!=t.which||-1===e.selectedIndex||(e.trigger("delete"),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation())})},morpheus.LegendWithStops.prototype={border:7,stopHalfSize:5,selectedIndex:-1,destroy:function(){$(this.canvas).off("keyup").off("mousedown"),this.hammer.off("panstart",this.panstart).off("panmove",this.panmove),this.hammer.destroy()},setSelectedIndex:function(e){this.selectedIndex=e},findIndexForPosition:function(e){if(e.y>=22)for(var t=0,r=this.fractions.length;t<r;t++){var n=this.fractionToStopPix(this.fractions[t]),i=n-this.stopHalfSize,o=n+this.stopHalfSize;if(e.x>=i&&e.x<=o)return t}return-1},draw:function(e,t,r,n){this.fractions=e,this.colors=t,this.stepped=r,this.fractionToStopPix=n;var i=this.canvas.getContext("2d");morpheus.CanvasUtil.resetTransform(i),i.clearRect(0,0,this.getUnscaledWidth(),this.getUnscaledHeight()),i.translate(this.border,0),morpheus.HeatMapColorSchemeLegend.draw(i,e,t,this.getUnscaledWidth()-2*this.border,this.getUnscaledHeight()-20,r),i.translate(-this.border,0),i.lineWidth=1,i.strokeStyle="Grey",i.strokeRect(this.border,0,this.getUnscaledWidth()-2*this.border,this.getUnscaledHeight()-20);for(var o=0;o<e.length;o++)if(!(o>0&&e[o]===e[o-1])){i.fillStyle=t[o];var a=n(e[o]);i.fillRect(a-this.stopHalfSize,22,2*this.stopHalfSize,2*this.stopHalfSize),this.selectedIndex===o?(i.lineWidth=2,i.strokeStyle="black"):(i.lineWidth=1,i.strokeStyle="Grey"),i.strokeRect(a-this.stopHalfSize,22,2*this.stopHalfSize,2*this.stopHalfSize)}}},morpheus.Util.extend(morpheus.LegendWithStops,morpheus.AbstractCanvas),morpheus.Util.extend(morpheus.LegendWithStops,morpheus.Events),morpheus.HeatMapMenu=function(e){var t,r=morpheus.Util.isNode(),n=$('<div style="display: inline-block;margin-right:14px;"></div>');function i(i,o,a){if(r){var s=[];o.forEach(function(t){if(null==t)s.push({type:"separator"});else{var r=e.getActionManager().getAction(t);if(null!=r){t=r.name,r.ellipsis&&(t+="...");var n=null;if(r.which){n="",r.commandKey&&(n+="CmdOrCtrl"),r.shiftKey&&(n.length>0&&(n+="+"),n+="Shift"),n.length>0&&(n+="+");var i=morpheus.KeyboardCharMap[r.which[0]];"+"===i&&(i="Plus"),n+=i}s.push({accelerator:n,label:t,click:function(e,t,r){}})}}}),t.push({label:i,submenu:s})}else{a||(a="0px");var l=[],u=_.uniqueId("morpheus");l.push('<div class="dropdown morpheus-menu">'),l.push('<a class="dropdown-toggle morpheus-black-link morpheus-black-link-background" type="button" id="'+u+'" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'),l.push(i),l.push("</a>"),l.push('<ul style="min-width:'+a+';" class="dropdown-menu" aria-labelledby="'+u+'">'),o.forEach(function(t){if(null==t)l.push('<li role="separator" class="divider"></li>');else{var r=e.getActionManager().getAction(t);null!=r&&(l.push("<li>"),l.push('<a class="morpheus-menu-item" data-action="'+r.name+'" href="#">'),l.push(r.name),r.ellipsis&&l.push("..."),r.icon&&l.push('<span class="'+r.icon+' morpheus-menu-item-icon"></span> '),r.which&&(l.push('<span class="pull-right">'),r.commandKey&&l.push(morpheus.Util.COMMAND_KEY),r.shiftKey&&l.push("Shift+"),l.push(morpheus.KeyboardCharMap[r.which[0]]),l.push("</span>")),l.push("</a>"),l.push("</li>"))}}),l.push("</ul>"),l.push("</div>"),$(l.join("")).appendTo(n)}}e.options.menu&&(e.options.menu.File&&i("File",e.options.menu.File,"240px"),e.options.menu.View&&i("Edit",e.options.menu.Edit),e.options.menu.View&&i("View",e.options.menu.View,"170px"),e.options.menu.Tools&&i("Tools",e.options.menu.Tools),e.options.menu.Help&&i("Help",e.options.menu.Help,"220px")),r?("darwin"===global.process.platform&&t.unshift({label:"Morpheus",submenu:[{role:"about"},{type:"separator"},{role:"services",submenu:[]},{type:"separator"},{role:"hide"},{role:"hideothers"},{role:"unhide"},{type:"separator"},{role:"quit"}]}),this.applicationMenu=Menu.buildFromTemplate(t),morpheus.HeatMapMenu.TAB_MANAGER_LISTENER_ADDED||(morpheus.HeatMapMenu.TAB_MANAGER_LISTENER_ADDED=!0,e.tabManager.on("add change remove",function(t){var r=e.tabManager.getTabObject(e.tabManager.getActiveTabId());if(null==r){var n=[];"darwin"===process.platform&&n.unshift({label:"Morpheus",submenu:[{role:"about"},{role:"quit"}]}),Menu.setApplicationMenu(Menu.buildFromTemplate(n))}else null!=r.menu?Menu.setApplicationMenu(r.menu.applicationMenu):(n=[],"darwin"===process.platform&&n.unshift({label:"Morpheus",submenu:[{role:"about"},{role:"quit"}]}),Menu.setApplicationMenu(Menu.buildFromTemplate(n)))}))):this.applicationMenu=n},morpheus.HeatMapMenu.TAB_MANAGER_LISTENER_ADDED=!1,morpheus.Popup={},morpheus.Popup.initted=!1,morpheus.Popup.init=function(){morpheus.Popup.initted||(morpheus.Popup.initted=!0,morpheus.Popup.$popupDiv=$(document.createElement("div")),morpheus.Popup.$popupDiv.css("position","absolute").css("zIndex",1050).css("overflow","auto").addClass("dropdown clearfix"),morpheus.Popup.$contextMenu=$(document.createElement("ul")),morpheus.Popup.$contextMenu.addClass("dropdown-menu").css("display","block").css("position","static").css("margin-bottom","5px"),morpheus.Popup.$contextMenu.appendTo(morpheus.Popup.$popupDiv),morpheus.Popup.$contextMenu.on("click","a",function(e){e.preventDefault();var t=$(this);morpheus.Popup.popupCallback(e,t.data("name")),morpheus.Popup.hide()}))},morpheus.Popup.popupInDom=!1,morpheus.Popup.hidePopupMenu=function(e){morpheus.Popup.component==e.target&&(e.preventDefault(),e.stopPropagation()),morpheus.Popup.hide()},morpheus.Popup.hide=function(){morpheus.Popup.$popupDiv.hide(),$(document.body).off("mousedown",morpheus.Popup.hidePopupMenu),morpheus.Popup.popupCallback=null,morpheus.Popup.component=null},morpheus.Popup.showPopup=function(e,t,r,n){if(morpheus.Popup.init(),morpheus.Popup.component!=r){morpheus.Popup.popupCallback=n,morpheus.Popup.component=r;for(var i=[],o=0,a=e.length;o<a;o++){var s=e[o];s.header?i.push('<li role="presentation" class="dropdown-header">'+s.name+"</li>"):s.separator?i.push('<li class="divider"></li>'):(i.push('<li role="presentation"'),s.disabled&&i.push('class="disabled"'),i.push('><a data-name="'+s.name+'" data-type="popup-item" tabindex="-1" href="#"'),s.class&&i.push(' class="'+s.class+'"'),i.push(">"),s.checked&&i.push('<span class="dropdown-checkbox fa fa-check"></span>'),i.push(s.name),s.icon&&i.push('<span class="pull-right '+s.icon+'"></span>'),i.push("</a>"),i.push("</li>"))}morpheus.Popup.$contextMenu.html(i.join("")),morpheus.Popup.popupInDom||(morpheus.Popup.popupInDom=!0,morpheus.Popup.$popupDiv.appendTo($(document.body)));var l=$(document.body),u=$(window),c=u.width(),h=u.height(),p=morpheus.Popup.$popupDiv.width(),d=morpheus.Popup.$popupDiv.height(),f=t.x,m=t.y;f+p>=c&&(f-=p,f=Math.max(4,f)),m+d>=h&&(m-=d,m=Math.max(4,m)),morpheus.Popup.$popupDiv.css({display:"block",left:f,top:m}),morpheus.Popup.$popupDiv.show(),l.off("mousedown",morpheus.Popup.hidePopupMenu),window.setTimeout(function(){l.on("mousedown",function(e){var t=$(e.target);t[0]!==morpheus.Popup.$popupDiv[0]&&"popup-item"!==t.data("type")&&morpheus.Popup.hidePopupMenu(e)})},1)}else morpheus.Popup.hide()},morpheus.RowDendrogram=function(e,t,r,n){morpheus.AbstractDendrogram.call(this,e,t,r,n,morpheus.AbstractDendrogram.Type.ROW)},morpheus.RowDendrogram.prototype={drawNode:function(e,t){var r=this.getNodeRadius(t),n=this.toPix(t);e.beginPath(),e.arc(n[0],n[1],r,2*Math.PI,!1),e.fill()},isDragHotSpot:function(e){return Math.abs(this.scale(this.cutHeight)-e.x)<=2},drawCutSlider:function(e,t){t.setLineDash&&t.setLineDash([5]),t.strokeStyle="black";var r=this.scale(this.cutHeight);t.beginPath(),t.moveTo(r,e.y),t.lineTo(r,this.getUnscaledHeight()),t.stroke(),t.setLineDash&&t.setLineDash([])},getPreferredSize:function(){return{width:100,height:Math.ceil(this.positions.getPosition(this.positions.getLength()-1)+this.positions.getItemSize(this.positions.getLength()-1))}},paintMouseOver:function(e,t){-1!==this.project.getHoverRowIndex()&&(morpheus.CanvasUtil.resetTransform(t),t.translate(0,-e.y),this.drawRowBorder(t,this.positions,this.project.getHoverRowIndex(),this.getUnscaledWidth()))},drawRowBorder:function(e,t,r,n){var i=t.getItemSize(r),o=t.getPosition(r);e.beginPath(),e.moveTo(0,o+i),e.lineTo(n,o+i),e.stroke(),e.beginPath(),e.moveTo(0,o),e.lineTo(n,o),e.stroke()},createScale:function(){return d3.scale.linear().domain([0,this.tree.maxHeight]).range([this.getUnscaledWidth(),0])},getMaxIndex:function(e){return morpheus.Positions.getBottom(e,this.positions)},getMinIndex:function(e){return morpheus.Positions.getTop(e,this.positions)},toPix:function(e){var t=this.positions.getPosition(e.minIndex)+this.positions.getItemSize(e.minIndex)/2,r=this.positions.getPosition(e.maxIndex)+this.positions.getItemSize(e.maxIndex)/2;return[this.scale(e.height),(t+r)/2]},drawPathFromNodeToParent:function(e,t){var r=this.toPix(t),n=this.toPix(t.parent);e.beginPath(),e.moveTo(r[0],r[1]),e.lineTo(n[0],r[1]),e.lineTo(n[0],n[1]),e.stroke()},drawNodePath:function(e,t,r,n){var i,o,a=t.children,s=a[0],l=a[1],u=this.toPix(l)[1],c=this.scale(l.height),h=this.toPix(s)[1],p=this.scale(s.height),d=this.scale(t.height);if(this.drawLeafNodes)i=[c,d,d,p],o=[u,u,h,h];else{var f=void 0!==s.children,m=void 0!==l.children;f&&(p=d+4),m&&(c=d+4),i=[c,d,d,p],o=[u,u,h,h]}e.beginPath(),e.moveTo(i[0],o[0]);for(var g=1,v=i.length;g<v;g++)e.lineTo(i[g],o[g]);e.stroke()}},morpheus.Util.extend(morpheus.RowDendrogram,morpheus.AbstractDendrogram),morpheus.ScentedSearch=function(e,t,r,n,i){morpheus.AbstractCanvas.call(this,!1),this.model=e,this.positions=t,this.isVertical=r,this.scrollbar=n,this.heatMap=i,this.searchIndices=[],n.decorator=this;var o=this;$(n.canvas).on("mousemove.morpheus",function(e){var t=o.getSearchIndices(e);document.body.style.cursor=0===t.length?"default":"pointer",n.canvas.style.cursor=0===t.length?"default":"pointer";var a={event:e,heatMapLens:t.length>=0};r?i.setToolTip(t.length>=0?t:null,-1,a):i.setToolTip(-1,t.length>=0?t:null,a)}).on("mouseout.morpheus",function(e){document.body.style.cursor="default",n.canvas.style.cursor="default",i.setToolTip(-1,-1,{event:e})})},morpheus.ScentedSearch.LINE_HEIGHT=3.5,morpheus.ScentedSearch.prototype={mouseMovedIndex:-1,getIndex:function(e){var t=morpheus.CanvasUtil.getMousePos(e.target,e)[this.isVertical?"y":"x"];return this.getIndexForPix(t)},getSearchIndices:function(e){var t=morpheus.CanvasUtil.getMousePos(e.target,e)[this.isVertical?"y":"x"];return this.getSearchIndicesForPix(t)},getSearchIndicesForPix:function(e){var t=this.searchIndices;if(null==t)return[];for(var r=this.scale,n=morpheus.ScentedSearch.LINE_HEIGHT,i=[],o=0,a=t.length;o<a;o++){var s=this.positions.getPosition(t[o])*r;Math.abs(s-e)<=n&&i.push(t[o])}return i},getIndexForPix:function(e){var t=this.searchIndices;if(null==t)return-1;var r=morpheus.ScentedSearch.LINE_HEIGHT;if(this.mouseMovedIndex>0){var n=this.positions.getPosition(t[this.mouseMovedIndex])*o;if(Math.abs(n-e)<=r)return this.mouseMovedIndex}for(var i=0,o=this.scale,a=t.length-1;i<=a;){var s=i+a>>1,l=(n=this.positions.getPosition(t[s])*o,0);if(Math.abs(n-e)<=r?l=0:n<e?l=-1:n>e&&(l=1),l<0)i=s+1;else{if(!(l>0))return s;a=s-1}}return-1},tap:function(e){var t=e[this.isVertical?"y":"x"],r=this.getIndexForPix(t);return this.scrollbar.canvas.style.cursor=r<0?"default":"pointer",r>=0&&(this.isVertical?this.heatMap.scrollTop(this.positions.getPosition(this.searchIndices[r])):this.heatMap.scrollLeft(this.positions.getPosition(this.searchIndices[r])),!0)},update:function(){this.searchIndices=this.model.getViewIndices().values().sort(function(e,t){return e<t?-1:1})},draw:function(e,t){var r=this.scrollbar.getUnscaledWidth(),n=this.scrollbar.getUnscaledHeight(),i=(this.isVertical?n:r)-morpheus.ScentedSearch.LINE_HEIGHT;this.scale=i/(this.positions.getPosition(this.positions.getLength()-1)+this.positions.getItemSize(this.positions.getLength()-1)),t.fillStyle=morpheus.ScentedSearch.TICK_COLOR,t.lineWidth=1,this.drawIndices(t,this.searchIndices),this.drawHoverMatchingValues(t)},drawHoverMatchingValues:function(e){var t=this.heatMap;if(e.fillStyle=morpheus.ScentedSearch.MATCHING_VALUES_TICK_COLOR,t.mousePositionOptions&&null!=t.mousePositionOptions.name){var r=!this.isVertical,n=t.getTrack(t.mousePositionOptions.name,r);if(null==n)return;if(n.settings.highlightMatchingValues){var i=r?t.getProject().getHoverColumnIndex():t.getProject().getHoverRowIndex();if(-1===i)return;var o=n.getVector().getValue(i),a=n.getFullVector().getProperties().get(morpheus.VectorKeys.VALUE_TO_INDICES);if(!a){var s=n.getFullVector();a=morpheus.VectorUtil.createValueToIndicesMap(s),s.getProperties().set(morpheus.VectorKeys.VALUE_TO_INDICES,a)}var l=a.get(o);if(null==l)return void console.log("valueToModelIndices error");for(var u=this.scale,c=this.isVertical?this.scrollbar.getUnscaledWidth():this.scrollbar.getUnscaledHeight(),h=this.isVertical,p=this.positions,d=t.getProject(),f=0,m=l.length;f<m;f++){var g=l[f],v=h?d.convertModelRowIndexToView(g):d.convertModelColumnIndexToView(g);if(-1!==v){var y=p.getPosition(v)*u;h?e.fillRect(0,y,c,morpheus.ScentedSearch.LINE_HEIGHT):e.fillRect(y,0,morpheus.ScentedSearch.LINE_HEIGHT,c)}}}}},drawIndices:function(e,t){for(var r=this.scale,n=this.isVertical?this.scrollbar.getUnscaledWidth():this.scrollbar.getUnscaledHeight(),i=this.isVertical,o=this.positions,a=0,s=t.length;a<s;a++){var l=t[a],u=o.getPosition(l)*r;i?(e.beginPath(),e.rect(0,u,n,morpheus.ScentedSearch.LINE_HEIGHT),e.fill()):(e.beginPath(),e.rect(u,0,morpheus.ScentedSearch.LINE_HEIGHT,n),e.fill())}}},morpheus.Util.extend(morpheus.ScentedSearch,morpheus.AbstractCanvas),morpheus.ScentedSearch.MATCHING_VALUES_TICK_COLOR="black",morpheus.ScentedSearch.TICK_COLOR="#3182bd",morpheus.ScrollBar=function(e){morpheus.AbstractCanvas.call(this),this.isVertical=e,$(this.canvas).css("border","1px solid #d8d8d8"),e?this.setBounds({width:12}):this.setBounds({height:12}),this.field=this.isVertical?"y":"x";var t=this,r=function(e){if(!morpheus.CanvasUtil.dragging){var r=morpheus.CanvasUtil.getMousePos(e.target,e,!0),n=r[t.field]>=t.thumbPos&&r[t.field]<=t.thumbPos+t.thumbExtent;t.thumbMouseOver!==n&&(t.thumbMouseOver=n,t.repaint())}};$(this.canvas).on("mousemove",r).on("mouseout",function(e){!morpheus.CanvasUtil.dragging&&t.thumbMouseOver&&(t.thumbMouseOver=!1,t.repaint())}).on("mouseenter",r),this.hammer=morpheus.Util.hammer(this.canvas,[this.isVertical?"panv":"panh","tap"]).on("panstart",this.panstart=function(e){var r=morpheus.CanvasUtil.getMousePos(e.target,e,!0);r[t.field]>=t.thumbPos&&r[t.field]<=t.thumbPos+t.thumbExtent?(t.draggingThumb=!0,t.dragStartThumbPos=t.thumbPos):t.draggingThumb=!1}).on("panend",this.panend=function(e){t.draggingThumb=!1}).on("panmove",this.panmove=function(e){if(t.draggingThumb){morpheus.CanvasUtil.getMousePos(e.target,e);var r=(t.dragStartThumbPos+(t.isVertical?e.deltaY:e.deltaX))/(t.visibleExtent-t.thumbExtent)*t.maxValue;t.setValue(r,!0),e.preventDefault(),e.srcEvent.stopPropagation(),e.srcEvent.stopImmediatePropagation()}}).on("tap doubletap",this.tap=function(e){if(!t.draggingThumb){var r=morpheus.CanvasUtil.getMousePos(e.target,e);if(!t.decorator.tap(r)){var n=t.thumbExtent/t.totalExtent*t.totalExtent;t.scrollToTop=r[t.field]<t.thumbPos,t.setValue(t.scrollToTop?t.value-n:t.value+n,!0)}}})},morpheus.ScrollBar.prototype={thumbPos:0,thumbExtent:0,extent:0,value:0,maxValue:0,totalExtent:0,visibleExtent:0,dragStartThumbPos:0,draggingThumb:!1,thumbMouseOver:!1,dispose:function(){morpheus.AbstractCanvas.prototype.dispose.call(this),this.hammer.off("panend",this.panend).off("panstart",this.panstart).off("panmove",this.panmove).off("tap",this.tap).off("doubletap",this.tap),this.hammer.destroy()},draw:function(e,t){var r=this.getUnscaledWidth(),n=this.getUnscaledHeight();this.visibleExtent===this.totalExtent?t.clearRect(0,0,r,n):(t.fillStyle="rgb(241,241,241)",t.fillRect(0,0,r,n),t.fillStyle=this.thumbMouseOver?"rgb(100,100,100)":"rgb(137,137,137)",this.isVertical?t.fillRect(0,this.thumbPos,r,this.thumbExtent):t.fillRect(this.thumbPos,0,this.thumbExtent,n)),this.decorator.draw(e,t)},setThumbPosFromValue:function(){var e=0==this.maxValue?0:this.value/this.maxValue;this.thumbPos=e*(this.visibleExtent-this.thumbExtent),this.thumbPos=Math.max(0,this.thumbPos)},getValue:function(){return this.value},getMaxValue:function(){return this.maxValue},setValue:function(e,t){return isNaN(e)&&(e=0),this.visibleExtent===this.totalExtent&&(e=0),e=Math.max(e,0),e=Math.min(this.maxValue,e),this.value=e,this.setThumbPosFromValue(),t&&(this.trigger("scroll",{value:this.value}),this.repaint()),this.value},setTotalExtent:function(e){this.totalExtent=e,this._setRange()},getTotalExtent:function(){return this.totalExtent},getVisibleExtent:function(){return this.visibleExtent},_setRange:function(){this.thumbExtent=Math.max(10,this.visibleExtent*(this.visibleExtent/this.totalExtent)),this.maxValue=this.totalExtent-this.visibleExtent,this.maxValue=Math.max(0,this.maxValue),this.isVertical?this.setBounds({height:this.visibleExtent}):this.setBounds({width:this.visibleExtent})},setExtent:function(e,t,r){this.visibleExtent=e,this.totalExtent=t,this._setRange(),this.setValue(r,!1)}},morpheus.Util.extend(morpheus.ScrollBar,morpheus.AbstractCanvas),morpheus.Util.extend(morpheus.ScrollBar,morpheus.Events),morpheus.ShapeChooser=function(e){var t=new morpheus.FormBuilder,r=e.map,n=['<select name="valuePicker" class="selectpicker" data-live-search="true">'];r.forEach(function(e,t){n.push("<option"),n.push(' value="'),n.push(t),n.push('">'),n.push(t),n.push("</option>")}),n.push("</select>"),t.append({name:"selected_value",type:"custom",value:n.join("")});var i=new morpheus.ShapeField({showNone:!0});t.append({style:"max-width:50px;",name:"selected_shape",type:"custom",value:'<div data-name="shape"></div>'}),i.$el.appendTo(t.$form.find("[data-name=shape]"));var o=t.$form.find("[name=valuePicker]"),a=o.val(),s=this;i.setShapeValue(r.get(a)),i.on("change",function(e){r.set(a,e.shape),s.trigger("change",{value:a,shape:e.shape})}),o.selectpicker().change(function(){a=o.val(),i.setShapeValue(r.get(a))}),this.$div=t.$form},morpheus.ShapeChooser.prototype={},morpheus.Util.extend(morpheus.ShapeChooser,morpheus.Events),morpheus.ShapeField=function(e){var t=e.shapes||morpheus.VectorShapeModel.SHAPES,r=this,n=[];n.push('<div style="margin-bottom:1em;" class="btn-group">'),n.push('<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span data-name="selection"></span> <span class="fa fa-caret-down"></span></button>'),n.push('<ul class="dropdown-menu" role="menu">'),e.showNone&&n.push('<li><a data-name="none" href="#">(None)</a></li>');for(var i=0;i<t.length;i++){var o=new C2S(16,16);o.translate(4,4),morpheus.CanvasUtil.drawShape(o,t[i],4,4,8);var a=o.getSerializedSvg();n.push('<li><a data-name="'+t[i]+'" href="#">'+a+"</a></li>")}n.push("</ul></div>");var s=$(n.join("")),l=s.find("[data-name=selection]");s.on("click","li > a",function(e){e.preventDefault();var t=$(this).data("name");u(t),r.trigger("change",{shape:t})});var u=function(e){if("none"===e)l.html("(None)");else{var t=new C2S(16,16);t.translate(4,4),morpheus.CanvasUtil.drawShape(t,e,4,4,8),l.html(t.getSerializedSvg())}};this.setShapeValue=u,this.$el=s},morpheus.ShapeField.prototype={},morpheus.Util.extend(morpheus.ShapeField,morpheus.Events),morpheus.SortByValuesIndicator=function(e,t,r){morpheus.AbstractCanvas.call(this,!0),this.project=e,this.isVertical=t,this.positions=r,this.lastPosition={start:-1,end:-1}},morpheus.SortByValuesIndicator.prototype={prePaint:function(e,t){var r=this.positions,n=0,i=r.getLength();this.isVertical?(n=morpheus.Positions.getTop(e,r),i=morpheus.Positions.getBottom(e,r)):(n=morpheus.Positions.getLeft(e,r),i=morpheus.Positions.getRight(e,r)),(this.invalid||n!==this.lastPosition.start||i!==this.lastPosition.end)&&(this.lastPosition.start=n,this.lastPosition.end=i,this.invalid=!0)},draw:function(e,t){var r=this.project,n=this.isVertical,i=this.positions,o=n?r.getColumnSortKeys():r.getRowSortKeys();t.translate(-e.x,-e.y),t.fillStyle="black",t.textBaseline="top",t.textAlign="left",t.font="8px "+morpheus.CanvasUtil.getFontFamily(t);var a=0,s=i.getLength();n?(a=morpheus.Positions.getTop(e,i),s=morpheus.Positions.getBottom(e,i)):(a=morpheus.Positions.getLeft(e,i),s=morpheus.Positions.getRight(e,i));for(var l=0;l<o.length;l++){var u=o[l];if(u instanceof morpheus.SortByValuesKey)for(var c=u.modelIndices,h=0;h<c.length;h++){var p=c[h],d=n?r.convertModelRowIndexToView(p):r.convertModelColumnIndexToView(p);if(-1!==d&&d>=a&&d<s){t.save();var f=i.getPosition(d),m=i.getItemSize(d);n?t.translate(2,f+m/2):t.translate(f+m/2,0),t.beginPath(),u.getSortOrder()===morpheus.SortKey.SortOrder.ASCENDING?(t.moveTo(0,0),t.lineTo(3,4),t.lineTo(-3,4)):u.getSortOrder()===morpheus.SortKey.SortOrder.DESCENDING?(t.moveTo(0,4),t.lineTo(3,0),t.lineTo(-3,0)):(t.moveTo(0,0),t.lineTo(3,2),t.lineTo(0,4),t.lineTo(-3,2)),t.fill(),t.restore()}}}}},morpheus.Util.extend(morpheus.SortByValuesIndicator,morpheus.AbstractCanvas),morpheus.SortDialog=function(e){var t=this,r=$('<div class="container-fluid"></div>'),n=$('<div class="container-fluid"></div>'),i=[];function o(r){t.isColumns=r;var i=t.build(e,r);n.empty().html(i),n.on("click","[data-name=delete]",function(e){var t=$(this);e.preventDefault(),t.closest("div.row").remove()}),n.on("click","[data-name=add]",function(e){var r=[],n=$(this).closest("div.row");t.createLevel(r,new morpheus.SortKey("",morpheus.SortKey.SortOrder.ASCENDING),t.fields),n.after($(r.join(""))),e.preventDefault()})}i.push('<div style="border-bottom:1px solid LightGrey;margin-bottom:20px;" class="row">'),i.push('<form class="form-horizontal" role="form">'),i.push('<div class="col-xs-2"><label class="control-label">Sort</label></div>'),i.push('<div class="col-xs-5">'),i.push('<div class="radio"><label><input type="radio" name="rowsOrColumns" value="rows" checked>Rows</label></div>'),i.push('<div class="radio"><label><input type="radio" name="rowsOrColumns" value="columns">Columns</label></div>'),i.push("</div>"),i.push("</form>"),i.push("</div>"),r.html(i.join("")),r.on("change","[name=rowsOrColumns]",function(e){o("columns"===$(this).val())}),o(!1);var a=$("<div></div>");r.appendTo(a),n.appendTo(a),morpheus.FormBuilder.showOkCancel({title:"Sort",content:a,okCallback:function(){for(var r=n.find("form"),i=r.find("[name=sortBy]").map(function(){return $(this).val()}),o=r.find("[name=lockOrder]").map(function(){return $(this).prop("checked")}),a=r.find("[name=sortOrder]:checked").map(function(){return $(this).val()}),s=n.find("[name=groupBy]").val(),l=[],u=t.isColumns?e.getRowSelectionModel().toModelIndices():e.getColumnSelectionModel().toModelIndices(),c=t.isColumns?e.getColumnSortKeys():e.getRowSortKeys(),h=0;h<c.length;h++)c[h].isUnlockable()&&(c.splice(h,1),h--);var p=new morpheus.Set;for(h=0;h<i.length;h++)if(!p.has(i[h])){p.add(i[h]);var d=null;"selection"===i[h]?d=new morpheus.SortByValuesKey(u,a[h],t.isColumns):""!==i[h]&&(d=new morpheus.SortKey(i[h],a[h])),null!=d&&(l.push(d),o[h]&&d.setLockOrder(1))}var f=[];if(null!=s)for(h=0;h<s.length;h++)f.push(new morpheus.SortKey(s[h],morpheus.SortKey.SortOrder.UNSORTED));t.isColumns?(e.setGroupColumns(f,!0),e.setColumnSortKeys(morpheus.SortKey.keepExistingSortKeys(l,c),!0)):(e.setGroupRows(f,!0),e.setRowSortKeys(morpheus.SortKey.keepExistingSortKeys(l,c),!0))}})},morpheus.SortDialog.prototype={isColumns:!1,build:function(e,t){var r=morpheus.MetadataUtil.getMetadataNames(t?e.getFullDataset().getColumnMetadata():e.getFullDataset().getRowMetadata());this.fields=r;var n=[],i=t?e.getColumnSortKeys():e.getRowSortKeys();this.createLevel0(n);for(var o=0;o<i.length;o++)i[o].isUnlockable()&&this.createLevel(n,i[o],r);n.push('<div class="row">'),n.push('<form class="form-horizontal" role="form">'),n.push('<div class="col-xs-2"><label>Group by</label></div>'),n.push('<div class="col-xs-4">');var a=(t?e.getGroupColumns():e.getGroupRows()).map(function(e){return e.field});n.push('<select multiple name="groupBy" class="selectpicker form-control">'),_.each(r,function(e){n.push('<option value="'+e+'"'),-1!==_.indexOf(a,e)&&n.push(" selected"),n.push(">"),n.push(e),n.push("</option>")}),n.push("</select>"),n.push("</div>"),n.push("</div>");var s=$(n.join(""));return s.find(".selectpicker").selectpicker({iconBase:"fa",tickIcon:"fa-check",style:"btn-default btn-sm"}),s},createLevel0:function(e){e.push('<div style="border-bottom:1px solid LightGrey;margin-bottom:20px;" class="row">'),e.push('<form class="form-horizontal" role="form">'),e.push('<div class="col-xs-8">'),e.push('<a data-name="add" href="#">Add sort level</a>'),e.push("</div>"),e.push("</form>"),e.push("</div>")},createLevel:function(e,t,r){e.push('<div style="border-bottom:1px solid LightGrey;margin-bottom:20px;" class="row">'),e.push('<form class="form-horizontal" role="form">'),e.push('<div class="col-xs-2"><label class="control-label">Sort by</label></div>'),e.push('<div class="col-xs-4">'),e.push('<select name="sortBy" class="form-control">'),e.push('<option value=""></option>'),e.push('<option value="selection"'+(t instanceof morpheus.SortByValuesKey?" selected":"")+">selection</option>"),_.each(r,function(r){e.push('<option value="'+r+'"'),r==t.toString()&&e.push(" selected"),e.push(">"),e.push(r),e.push("</option>")}),e.push("</select>"),e.push("</div>"),e.push('<div class="col-xs-5">'),e.push('<div class="radio"><label><input type="radio" name="sortOrder" value="ascending"'+(morpheus.SortKey.SortOrder.ASCENDING==t.getSortOrder()?" checked":"")+">Ascending</label></div>"),e.push('<div class="radio"><label><input type="radio" name="sortOrder" value="descending"'+(morpheus.SortKey.SortOrder.DESCENDING==t.getSortOrder()?" checked":"")+">Descending</label></div>"),e.push("</div>"),e.push('<div class="col-xs-1">'),e.push('<a data-name="delete">Delete</a>'),e.push("</div>"),e.push('<div class="col-xs-12">'),e.push('<div class="checkbox"><label><input name="lockOrder" type="checkbox"'+(0!==t.getLockOrder()?" checked":"")+"> Lock sort level</label></div>"),e.push("</div>"),e.push('<div class="col-xs-12">'),e.push("<br />"),e.push('<a data-name="add" href="#">Add sort level</a>'),e.push("</div>"),e.push("</form>"),e.push("</div>")}},morpheus.SteppedColorSupplier=function(){morpheus.AbstractColorSupplier.call(this),this.hiddenValue=0,this.hiddenValues=new morpheus.Set,this.stepped=!0},morpheus.SteppedColorSupplier.linearScale=function(e,t,r,n,i){return(e-t)/(r-t)*(i-n)+n},morpheus.SteppedColorSupplier.prototype={createInstance:function(){return new morpheus.SteppedColorSupplier},isStepped:function(){return!0},getHiddenValues:function(){return this.hiddenValues},getIndexForFraction:function(e){var t=this.fractions;if(e<=t[0])return 0;if(e>=t[t.length-1])return t.length-1;for(var r=0;r<t.length-1;r++){var n=t[r],i=t[r+1];if(e>=n&&e<i)return r}return t.length-1},getColor:function(e,t,r){if(this.hiddenValues.has(r)&&(r=this.hiddenValue),isNaN(r))return this.missingColor;var n=this.min,i=this.max,o=this.colors;if(r<=n)return o[0];if(r>=i)return o[o.length-1];var a=morpheus.SteppedColorSupplier.linearScale(r,n,i,0,100)/100;return o[this.getIndexForFraction(a)]}},morpheus.Util.extend(morpheus.SteppedColorSupplier,morpheus.AbstractColorSupplier),morpheus.TabManager=function(e){this.options=$.extend({},{autohideTabBar:!1,rename:!0},e);var t=this;if(this.activeTabObject=null,this.activeTabId=null,this.idToTabObject=new morpheus.Map,this.$nav=$('<ul class="nav nav-tabs compact morpheus-nav"></ul>'),this.$nav.sortable({containment:"parent",axis:"x",helper:"clone",cancel:"li:not(.morpheus-sortable)",items:"li.morpheus-sortable"}),this.$nav.sortable("disable"),this.$nav.on("click","li > a",function(e){var r=$(this).data("link");null!=r&&(e.preventDefault(),t.activeTabId!==r&&$(this).tab("show"))}),this.options.autohideTabBar&&this.$nav.css("display","none"),e.dropTab){var r=[];r.push('<li class="morpheus-tab-addon dropdown pull-right tabdrop">'),r.push('<div class="btn-group">'),r.push('<button type="button" class="morpheus-drop-tab-toggle btn btn-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'),r.push(' <span class="fa fa-angle-double-down"></span>'),r.push("</button>"),r.push('<ul class="dropdown-menu dropdown-menu-right" role="menu">'),r.push("</ul>"),r.push("</div>"),r.push("</li>");var n=$(r.join("")),i=n.find(".dropdown-menu");n.appendTo(this.$nav);var o=function(){var e=t.$nav.width()-17,r=0,o=[];t.$nav.find("> li").each(function(){var t=$(this),n=t.find("a");if(!t.hasClass("morpheus-tab-addon")){var i=n.contents().first().text(),a=t.hasClass("active"),s=n.attr("href");o.push('<li class="'+(a?"active":"")+'"><a data-link="'+s.substring(1)+'" data-toggle="tab" href="'+s+'">'+i+"</a></li>"),(r+=t.outerWidth())>=e?t.css("display","none"):t.css("display","")}}),n.css("display",o.length>0?"":"none"),i.html(o.join(""))};n.css("display","none"),this.$nav.on("sortstop",function(e,t){o()}),$(window).on("resize",o),this.$nav.on("remove",function(){$(window).off("resize",o)}),this.on("add remove rename reorder change",function(){o()})}this.$nav.on("dblclick","li > a",function(e){e.preventDefault();var r=$(this);r.parent("li").hasClass("morpheus-tab-addon")||t.rename(r.data("link"))}),this.$nav.on("contextmenu.morpheus","li > a",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();var r=$(this),n=r.parent("li");if(!n.hasClass("morpheus-tab-addon")){var i=[];return r.data("morpheus-rename")&&t.options.rename&&i.push({name:"Rename"}),r.data("morpheus-pin")?i.push({name:"Unpin tab"}):i.push({name:"Pin tab"}),i.length>0&&morpheus.Popup.showPopup(i,{x:e.pageX,y:e.pageY},e.target,function(e,i){"Rename"===i?t.rename(r.data("link")):"Pin tab"===i?(r.data("morpheus-pin",!0),n.removeClass("morpheus-sortable"),n.detach(),t.$nav.prepend(n),r.find(".close").hide(),t.$nav.sortable("option","items","li.morpheus-sortable"),t.$nav.sortable("refresh")):"Unpin tab"===i&&(r.data("morpheus-pin",!1),n.addClass("morpheus-sortable"),r.find(".close").show(),t.$nav.sortable("option","items","li.morpheus-sortable"),t.$nav.sortable("refresh"))}),!1}}),this.$nav.on("click","button",function(e){e.preventDefault();var r=$(this).attr("data-target");null!=r&&(r=r.substring(1),t.remove(r))}),this.$tabContent=$('<div class="tab-content"></div>'),this.$nav.on("shown.bs.tab",'a[data-toggle="tab"]',function(e){var r=t.activeTabId;t.activeTabId=$(e.target).data("link"),t.activeTabObject=t.idToTabObject.get(t.activeTabId),t.$nav.find("li").removeClass("active"),t.$nav.find("[data-link="+t.activeTabId+"]").each(function(){$(this).parent().addClass("active")});var n=document.body.scrollTop;$("#"+t.activeTabId).focus(),document.body.scrollTop=n,t.adding||t.trigger("change",{tab:t.activeTabId,previous:r})})},morpheus.TabManager.prototype={getTabText:function(e){return this.$nav.find("> li > a").filter("a[data-link="+e+"]").contents().first().text().trim()},getTabItems:function(){var e=[];return this.$nav.find("> li > a").each(function(){var t=$(this),r=t.contents().first().text().trim(),n=t.data("link"),i=t.attr("title");e.push({id:n,text:r,title:i})}),e},getTabCount:function(){return this.idToTabObject.size()},setTabText:function(e,t){this.$nav.find("> li > a").filter("[data-link="+e+"]").contents().first().replaceWith(t+"&nbsp;"),this.idToTabObject.get(e).setName(name)},addTask:function(e){},removeTask:function(e){},getWidth:function(){return this.$tabContent.outerWidth()||$(window).width()},getActiveTab:function(){return this.activeTabObject},getActiveTabId:function(){return this.activeTabId},add:function(e){this.adding=!0;var t=_.uniqueId("morpheus-tab");this.idToTabObject.set(t,e.object);var r=[];r.push('<li class="morpheus-sortable" role="presentation">'),r.push('<a data-morpheus-rename="'+e.rename+'" data-toggle="tab" data-link="'+t+'" href="#'+t+'">'),r.push(e.title),r.push('&nbsp;<i style="color:black;"></i>'),e.closeable&&r.push('&nbsp<button style="font-size: 18px;" type="button" class="close" aria-label="Close" data-target="#'+t+'"><span aria-hidden="true">Ã</span></button>'),r.push("</a></li>");var n=$(r.join(""));n.appendTo(this.$nav);var i=$('<div tabIndex="0" style="outline:0;cursor:default;" role="tabpanel" class="tab-pane" id="'+t+'"></div>');return e.$el.appendTo(i),i.appendTo(this.$tabContent),!1===e.enabled&&(n.addClass("disabled"),n.find("a").addClass("btn disabled")),e.focus&&(this.$nav.find('> li > a[data-toggle="tab"]:last').tab("show"),this.activeTabId=t,this.activeTabObject=e.object,i.focus()),this.options.autohideTabBar&&this.$nav.css("display",this.idToTabObject.size()>1?"":"none"),this.getTabCount()<=1?this.$nav.sortable("disable"):this.$nav.sortable("enable"),this.adding=!1,this.trigger("add"),{$panel:i,id:t}},appendTo:function(e){this.$nav.appendTo(e),this.$tabContent.appendTo(e)},remove:function(e){void 0===e&&(e=this.activeTabId);var t=this.idToTabObject.remove(e);$("#"+e).remove(),this.activeTabObject=null,this._getA(e).parent().remove(),this.$tabContent.find(e).remove();var r=this.$nav.find('> li > a[data-toggle="tab"]:last');0===r.length&&this.options.landingPage&&("function"==typeof this.options.landingPage?this.options.landingPage().show():this.options.landingPage.show()),r.tab("show"),this.options.autohideTabBar&&this.$nav.css("display",this.idToTabObject.size()>1?"":"none"),this.getTabCount()<=1?this.$nav.sortable("disable"):this.$nav.sortable("enable"),this.idToTabObject.size()>0&&$(r.attr("href")).focus(),null!=t&&t.onRemove&&t.onRemove(),this.trigger("remove",{tab:e})},setOptions:function(e){this.options=e,this.options.autohideTabBar&&this.$nav.css("display",this.idToTabObject.size()>1?"":"none")},getOptions:function(){return this.options},setActiveTab:function(e){if(e!==this.activeTabId){var t=this._getA(e);t.parent().removeClass("disabled"),t.removeClass("btn disabled"),t.tab("show");var r=this.activeTabId;this.activeTabId=e,this.activeTabObject=this.idToTabObject.get(this.activeTabId),this.trigger("change",{tab:this.activeTabId,previous:r})}},setTabTitle:function(e,t){this._getA(e).attr("title",t)},_getA:function(e){return"#"===e[0]&&(e=e.substring(1)),this.$nav.find("> li > a[data-link="+e+"]:first")},setTabEnabled:function(e,t){var r=this._getA(e);t?(r.parent().removeClass("disabled"),r.removeClass("btn disabled")):(r.parent().addClass("disabled"),r.addClass("btn disabled"))},getIdToTabObject:function(){return this.idToTabObject},getTabObject:function(e){return this.idToTabObject.get(e)},rename:function(e){var t=this._getA(e);if(!t.parent().hasClass("morpheus-tab-addon")&&t.data("morpheus-rename")&&this.options.rename){var r=this,n=new morpheus.FormBuilder;n.append({name:"name",type:"text",value:$.trim(t.contents().first().text())}),morpheus.FormBuilder.showOkCancel({title:"Rename Tab",content:n.$form,focus:document.activeElement,okCallback:function(){var e=$.trim(n.getValue("name"));""!==e&&(null!=r.activeTabObject&&r.activeTabObject.setName&&r.activeTabObject.setName(e),t.contents().first().replaceWith(e+"&nbsp;"),r.trigger("rename"))}})}}},morpheus.Util.extend(morpheus.TabManager,morpheus.Events),morpheus.Table=function(e){e=morpheus.Table.createOptions(e),this.options=e,e.width||(e.width=e.$el.attr("class"));var t=this,r=e.height,n=$('<div class="slick-table'+(e.tableClass?" "+e.tableClass:"")+'" style="width:'+e.fixedWidth+";height:"+r+'"></div>');this.$gridDiv=n,n.appendTo(e.$el);var i=e.columns;this.columns=i;var o=i.filter(function(e){return e.visible}),a=new morpheus.Grid({gridOptions:{select:e.select,rowHeight:e.rowHeight,autoEdit:!1,editable:!1,autoHeight:"auto"===e.height,enableTextSelectionOnCells:!0},$el:n,items:e.items,columns:o});this.grid=a,this.searchFunction=null;var s={isEmpty:function(){return null==t.searchFunction},init:function(){},accept:function(e){return t.searchFunction(e)}};this.grid.getFilter().add(s);var l=$('<div class="slick-table-header"><div name="top"></div><div style="display: inline-block;" name="left" class="pad-bottom-8 pad-top-8"></div><div name="right" class="pull-right pad-bottom-8 pad-top-8"></div></div>');this.$header=l;var u=l.find(".pull-right");if(e.search){var c=new morpheus.TableSearchUI({$el:l.find("[name=top]"),$right:u});c.setTable(this),this.tableSearch=c}if(e.columnPicker&&o.length!==this.columns.length){var h=[];h.push('<select data-width="90px" data-selected-text-format="static" title="Columns..." multiple class="pad-left-4 selectpicker show-tick">');var p=this.columns.slice().sort(function(e,t){return(e=e.name.toLowerCase())===(t=t.name.toLowerCase())?0:e<t?-1:1});p.forEach(function(e,t){h.push('<option value="'+t+'"'),e.visible&&h.push(" selected"),h.push(">"),h.push(e.name),h.push("</option>")}),h.push("</select>");var d=$(h.join(""));d.appendTo(u),d.selectpicker({iconBase:"fa",tickIcon:"fa-check",style:"btn-default btn-xs"}),d.on("change",function(){var e=a.getColumns().map(function(e){return e.id}),r=d.val();o=[];for(var n=0;n<r.length;n++)o.push(p[parseInt(r[n])]);var i=o.map(function(e){return e.id});if(a.setColumns(o),i.length>e.length){var s=new morpheus.Set;for(n=0;n<i.length;n++)s.add(i[n]);for(n=0;n<e.length;n++)s.remove(e[n]);var l=s.values();a.setSortColumns([{columnId:l[0],sortAsc:!0}])}t.resize(),t.redraw()})}l.prependTo(e.$el);var f=!1,m=-1,g=function(){if(t.options.responsive){var r=e.$el.width();r!==m&&(m=r,n.css("width",r+"px"),!f&&r<e.collapseBreakpoint&&o.length>1?(f=!0,n.addClass("slick-stacked"),t.grid.grid.getOptions().rowHeight=(e.collapsedRowHeight?e.collapsedRowHeight:e.rowHeight)*o.length,t.grid.grid.setColumns([{id:0,tooltip:function(e,t){for(var r=[],n=0;n<o.length;n++){var i=o[n].tooltip(e,o[n].getter(e));null!=i&&""!==i&&r.push(i)}return r.join("<br />")},collapsed:!0,getter:function(e){return e},formatter:function(t,r,n,i,a){var s=[];s.push('<div class="slick-table-wrapper"><div class="slick-cell-wrapper">'),e.rowHeader&&(s.push(e.rowHeader(a)),s.push('<div style="height:4px;"></div>'));for(var l=0;l<o.length;l++){l>0&&s.push('<div style="height:4px;"></div>');var u=o[l];s.push(u.name),s.push(":");var c=u.renderer(a,u.getter(a));s.push(c)}return s.push("</div></div>"),s.join("")},sortable:!1,name:""}]),n.find(".slick-header").hide(),t.grid.grid.resizeCanvas(),t.grid.grid.invalidate()):f&&r>=e.collapseBreakpoint?(n.removeClass("slick-stacked"),f=!1,e.showHeader&&n.find(".slick-header").show(),t.grid.grid.getOptions().rowHeight=e.rowHeight,t.grid.grid.setColumns(o),t.grid.grid.resizeCanvas(),e.select&&t.grid.grid.setSelectedRows(t.grid.grid.getSelectedRows()),t.grid.grid.invalidate()):(t.grid.grid.resizeCanvas(),t.grid.grid.invalidate()),t.grid.maybeAutoResizeColumns())}};if(e.showHeader||n.find(".slick-header").hide(),e.responsive&&($(window).on("resize orientationchange",g),n.on("remove",function(){$(window).off("resize",g)}),g()),this.resize=g,o.length>1&&null!=e.items&&e.items.length>0&&this.setItems(e.items),!n.is(":visible")){for(var v=n,y=new MutationObserver(function(e){"none"!==window.getComputedStyle(v[0]).display&&(y.disconnect(),g())});v.length>0&&"none"!==window.getComputedStyle(v[0]).display;)v=v.parent();v.length>0&&y.observe(v[0],{attributes:!0,childList:!1,characterData:!1})}},morpheus.Table.defaultRenderer=function(e,t){if(null==t)return"";if(_.isNumber(t))return morpheus.Util.nf(t);if(morpheus.Util.isArray(t)){for(var r=[],n=0,i=t.length;n<i;n++)n>0&&r.push(", "),t[n],r.push(t[n]);return r.join("")}return""+t},morpheus.Table.prototype={toText:function(){for(var e=[],t=this.getItems(),r=this.columns.filter(function(e){return e.visible}),n=0;n<r.length;n++)n>0&&e.push("\t"),e.push(r[n].name);e.push("\n");for(var i=0;i<t.length;i++){var o=t[i];for(n=0;n<r.length;n++){n>0&&e.push("\t");var a=r[n].getter(o);e.push(morpheus.Util.toString(a))}e.push("\n")}return e.join("")},setHeight:function(e){this.options.height=e,"auto"===e?(this.$gridDiv.css("height",""),this.grid.grid.getOptions().autoHeight=!0,this.grid.grid.setOptions(this.grid.grid.getOptions())):this.$gridDiv.css("height",e),this.grid.grid.resizeCanvas(),"auto"===e&&(e=this.getItems().length*this.options.rowHeight+this.options.rowHeight,this.$gridDiv.find(".slick-viewport").css("height",e+"px")),this.grid.grid.invalidate()},setSearchVisible:function(e){this.$header.find("[name=search]").css("display",e?"":"none")},autocomplete:function(e,t){var r=[],n=null!=e&&e.length>0?e[e.selectionStartIndex]:"";n=$.trim(n);var i=this.columns.filter(function(e){return e.searchable&&e.visible||e.alwaysSearch}),o=i.length,a=o>1;if(""===n){if(o<=1)return t(r);for(var s=0;s<o;s++){var l=i[s].name;r.push({value:l+":",label:'<span style="font-weight:300;">'+l+":</span>",show:!0})}return r.sort(function(e,t){return e.value===t.value?0:e.value<t.value?-1:1}),t(r)}l=null;var u=n.indexOf(":"),c=new RegExp("^"+morpheus.Util.escapeRegex(n),"i");if(u>0){if(92!==n.charCodeAt(u-1)){var h=$.trim(n.substring(0,u));h.length>0&&'"'===h[0]&&'"'===h[n.length-1]&&(h=h.substring(1,h.length-1));var p=new morpheus.Map,d=i.map(function(e){return e.name});for(s=0;s<d.length;s++)p.set(d[s],i[s]);var f=p.get(h);void 0!==f&&(n=$.trim(n.substring(u+1)),i=[f],o=1)}}else if(o>1){c=new RegExp("^"+morpheus.Util.escapeRegex(n),"i");for(var m=0;m<o;m++)l=i[m].name,c.test(l)&&r.push({value:l+":",label:'<span style="font-weight:300;">'+l+":</span>",show:!0})}var g=new morpheus.Set,v=(c=new RegExp("^"+morpheus.Util.escapeRegex(n),"i"),this.getItems()),y=[],b=[];i.forEach(function(e){for(var t=null,r=0,n=v.length;r<n;r++){var i=e.getter(v[r]);if(null!=i){t=morpheus.Util.getDataType(i);break}}"string"!==t&&"[string]"!==t||(y.push(t),b.push(e))}),o=(i=b).length;for(var w=r.length+10,x=(s=0,v.length);s<x;s++){var _=v[s];for(m=0;m<o;m++){l=i[m].name;var S=i[m].getter(_);if("[string]"===y[m])for(var C=null==S?0:S.length,M=0;M<C;M++){var T=S[M];if(c.test(T)&&!g.has(T)&&(g.add(T),r.push({value:a?l+":"+T:T,label:a?'<span style="font-weight:300;">'+l+':</span><span style="font-weight:900;">'+T+"</span>":'<span style="font-weight:900;">'+T+"</span>"})),r.length===w)return t(r)}else if(c.test(S)&&!g.has(S)&&(g.add(S),r.push({value:a?l+":"+S:S,label:a?'<span style="font-weight:300;">'+l+':</span><span style="font-weight:900;">'+S+"</span>":'<span style="font-weight:900;">'+S+"</span>"}),r.length===w))return t(r)}}return t(r)},searchWithPredicates:function(e){if(null==e||0===e.length)return this.searchFunction=null,void this.grid.setFilter(this.grid.getFilter());for(var t=this.columns.filter(function(e){return e.searchable&&e.visible||e.alwaysSearch}),r=new morpheus.Map,n=t.map(function(e){return e.name}),i=0;i<n.length;i++)r.set(n[i],t[i]);var o=[],a=e.length;for(i=0;i<a;i++){var s=e[i],l=s.getField();if(null!=l){var u=r.get(l);u&&(s.column=u,o.push(s))}else o.push(s)}a=(e=o).length,this.searchFunction=function(r){for(var n=0;n<a;n++)for(var i,o=0,s=(i=(l=e[n]).column?[l.column]:t).length;o<s;o++){var l,u=i[o].getter(r);if(morpheus.Util.isArray(u)){for(var c=u.length,h=0;h<c;h++)if(l.accept(u[h]))return!0}else if((l=e[n]).accept(u))return!0}return!1},this.grid.setFilter(this.grid.getFilter())},search:function(e){if(""===e)this.searchFunction=null,this.grid.setFilter(this.grid.getFilter());else{var t=morpheus.Util.getAutocompleteTokens(e),r=this.columns.filter(function(e){return e.searchable&&e.visible||e.alwaysSearch}).map(function(e){return e.name}),n=morpheus.Util.createSearchPredicates({tokens:t,fields:r});this.searchWithPredicates(n)}},getSelectedRows:function(){return this.grid.getSelectedRows()},getSelectedItems:function(){return this.grid.getSelectedItems()},getSelectedItem:function(){return this.grid.getSelectedItem()},setSelectedRows:function(e){this.grid.setSelectedRows(e)},getItems:function(e){return this.grid.getItems()},getAllItemCount:function(){return this.grid.getAllItemCount()},getFilteredItemCount:function(){return this.grid.getFilteredItemCount()},setFilter:function(e){this.grid.setFilter(e)},getFilter:function(){return this.grid.getFilter()},setItems:function(e){this.grid.setItems(e),this.grid.redraw()},redraw:function(){this.grid.redraw()},on:function(e,t){return this.grid.on(e,t),this},off:function(e,t){return this.grid.off(e,t),this},trigger:function(e){this.grid.trigger(e)}},morpheus.Table.createOptions=function(e){(e=$.extend(!0,{},{items:[],height:"564px",collapseBreakpoint:400,showHeader:!0,select:!0,rowHeader:null,responsive:!0,fixedWidth:"320px",columnPicker:!0},e)).columns||(e.columns=[{name:""}]);var t=[];return e.columns.forEach(function(r,n){var i=$.extend(!0,{},{id:n,tooltip:function(e,t){return morpheus.Table.defaultRenderer(e,t)},formatter:function(t,r,n,o,a){var s=[];return s.push('<div class="slick-table-wrapper"><div class="slick-cell-wrapper">'),e.rowHeader&&0===r&&s.push(e.rowHeader(a)),s.push(i.renderer(a,n)),s.push("</div></div>"),s.join("")},comparator:function(e,t){var r=null==e||_.isNumber(e)&&isNaN(e),n=null==t||_.isNumber(t)&&isNaN(t);return r&&n?0:r?1:n?-1:(e.toLowerCase&&(e=e.toLowerCase()),t.toLowerCase&&(t=t.toLowerCase()),e===t?0:e<t?-1:1)},sortable:!0,searchable:!0,width:null,name:r.name,renderer:morpheus.Table.defaultRenderer},r);void 0===i.visible&&(i.visible=!0),i.getter||(i.getter=null==i.field?function(e){return e}:function(e){return e[r.field]}),t.push(i)}),e.columns=t,1===e.columns.length?e.tableClass="slick-table-compact":e.tableClass="slick-bordered-table",e.rowHeight||(e.rowHeight=22),e},morpheus.TableSearchUI=function(e){var t=this,r=$('<input name="search" type="text" class="form-control input-sm" placeholder="Search" autocomplete="off">');r.appendTo(e.$el),this.$search=r,this.$searchResults=$('<span class="pad-top-2 tableview-rowcount" name="search"></span>'),this.$showAll=$('<div style="display:inline-block;min-width:60px;" name="search" class="pad-left-8 text-button-copy tableview-rowcount">Show all</div>'),this.$searchResults.appendTo(e.$right),this.$showAll.appendTo(e.$right),this.$showAll.on("click",function(e){e.preventDefault(),r.val(""),t.table.search(""),t.table.trigger("showAll",{table:t.table})}),r.on("keyup",_.debounce(function(){t.table.search($.trim($(this).val()))},100)),morpheus.Util.autosuggest({$el:r,suggestWhenEmpty:!0,filter:function(e,r){t.table.autocomplete(e,r)},select:function(){t.table.search($.trim(r.val()))}})},morpheus.TableSearchUI.prototype={updateSearchLabel:function(){var e="Showing: "+morpheus.Util.intFormat(this.table.getFilteredItemCount())+" / "+morpheus.Util.intFormat(this.table.getAllItemCount());this.$searchResults.html(e)},setTable:function(e){this.table=e;var t=this;e.on("filter",function(){t.updateSearchLabel()})}},morpheus.TrackSelection=function(e,t,r,n,i){var o=e.canvas,a=-1,s=n?"x":"y";function l(r,o){if(e.settings.squished){var a=(t.getPosition(t.getLength()-1)+t.getItemSize(t.getLength()-1))/(n?e.getUnscaledWidth():e.getUnscaledHeight()),l=(morpheus.CanvasUtil.getClientXY(r,o),morpheus.CanvasUtil.getMousePosWithScroll(r.target,r,0,0,o));return l[s]*=a,l}return morpheus.CanvasUtil.getMousePosWithScroll(r.target,r,i.scrollLeft(),i.scrollTop(),o)}var u,c=(new Date).getTime(),h=this,p=50;function d(e){var t=function(){(new Date).getTime();var r=o.getBoundingClientRect(),i=!1;n?(e.clientX>r.right||e.clientX<r.left)&&(i=!0):(e.clientY>r.bottom||e.clientY<r.top)&&(i=!0),i&&(h.panmove(e),u=setTimeout(t,p))};u=setTimeout(t,p),$(o).one("mouseover",f)}function f(){clearTimeout(u),$(o).one("mouseleave",d)}this.hammer=morpheus.Util.hammer(o,["pan","tap","longpress"]).on("longpress",this.longpress=function(t){t.preventDefault(),t.srcEvent.stopImmediatePropagation(),t.srcEvent.stopPropagation(),i.setSelectedTrack(e.name,n),e.showPopup(t.srcEvent)}).on("panend",this.panend=function(e){clearInterval(u),$(o).off("mouseover mouseleave")}).on("panmove",this.panmove=function(e){if(!((new Date).getTime()-c<p)){var o=l(e),u=t.getIndex(o[s],!1),h=null!=e.srcEvent&&(morpheus.Util.IS_MAC?e.srcEvent.metaKey:e.srcEvent.ctrlKey)?r.getViewIndices():new morpheus.Set,d=a;if(a>u){var f=u;u=d,d=f}for(var m=d;m<=u;m++)h.add(m);if(r.setViewIndices(h,!0),n){var g=i.scrollLeft(),v=i.heatmap.getUnscaledWidth(),y=g+v;o.x>y?i.scrollLeft(o.x+8-v):o.x<g&&i.scrollLeft(o.x-8)}else{var b=i.scrollTop(),w=i.heatmap.getUnscaledHeight(),x=b+w;o.y>x?i.scrollTop(o.y+8-w):o.y<b&&i.scrollTop(o.y-8)}e.preventDefault(),null!=e.srcEvent&&(e.srcEvent.stopPropagation(),e.srcEvent.stopImmediatePropagation()),c=(new Date).getTime()}}).on("panstart",this.panstart=function(r){i.setSelectedTrack(e.name,n);var u=l(r,!0);a=t.getIndex(u[s],!1),$(o).one("mouseleave.morpheus",d)}).on("tap doubletap",this.tap=function(o){var a=l(o),u=t.getIndex(a[s],!1);if(o.tapCount>1){if(n&&!i.options.columnsSortable||!n&&!i.options.rowsSortable)return;i.sortBasedOnSelection(null,n,o.srcEvent.shiftKey)}else{i.setSelectedTrack(e.name,n);var c,h=morpheus.Util.IS_MAC?o.srcEvent.metaKey:o.srcEvent.ctrlKey;if(morpheus.Util.IS_MAC&&o.srcEvent.ctrlKey)return;if(h)(c=r.getViewIndices()).has(u)?c.remove(u):c.add(u);else if(o.srcEvent.shiftKey){c=r.getViewIndices();var p=Number.MAX_VALUE,d=-Number.MAX_VALUE;if(c.forEach(function(e){p=Math.min(e,p),d=Math.max(e,d)}),u>=d)for(var f=d;f<=u;f++)c.add(f);else for(f=Math.min(u,p),d=Math.max(u,p);f<=d;f++)c.add(f)}else(c=new morpheus.Set).add(u);r.setViewIndices(c,!0)}})},morpheus.TrackSelection.prototype={dispose:function(){this.hammer.off("longpress",this.longpress).off("panstart",this.panstart).off("panmove",this.panmove).off("panend",this.panend).off("tap",this.tap).off("doubletap",this.tap),this.hammer.destroy()}},morpheus.VectorTrackHeader=function(e,t,r,n){morpheus.AbstractCanvas.call(this),this.font={weight:"400"},this.project=e,this.name=t,this.isColumns=r;var i=this.canvas;this.heatMap=n,this.selectedBackgroundColor="#c8c8c8",this.backgroundColor="rgb(255,255,255)";var o=(r?e.getFullDataset().getColumnMetadata():e.getFullDataset().getRowMetadata()).getByName(t);o&&o.getProperties().has(morpheus.VectorKeys.TITLE)&&(this.canvas.setAttribute("title",o.getProperties().get(morpheus.VectorKeys.TITLE)),$(this.canvas).tooltip());var a=this;function s(e){if(r){if(e.y<3)return{cursor:"ns-resize",isPrevious:!0};if(e.y>=a.getUnscaledHeight()-3)return{cursor:"ns-resize",isPrevious:!1};if(e.x>=a.getUnscaledWidth()-3)return{isPrevious:!1,cursor:"ew-resize"}}else{if(e.x<3&&n.getTrackIndex(t,r)>0)return{cursor:"ew-resize",isPrevious:!0};if(e.x>=a.getUnscaledWidth()-3)return{cursor:"ew-resize",isPrevious:!1}}}this.setBounds({height:this.defaultFontHeight+morpheus.VectorTrackHeader.FONT_OFFSET});var l,u=function(e){if(!morpheus.CanvasUtil.dragging){var t=s(morpheus.CanvasUtil.getMousePos(e.target,e));i.style.cursor=null==t?"default":t.cursor,a.isMouseOver=!0,a.repaint()}};$(this.canvas).css({"background-color":this.backgroundColor}).on("mousemove.morpheus",u).on("mouseout.morpheus",function(e){morpheus.CanvasUtil.dragging||(i.style.cursor="default"),a.isMouseOver=!1,a.repaint()}).on("mouseenter.morpheus",u).on("contextmenu.morpheus",function(e){n.setSelectedTrack(a.name,r);var t=n.getTrack(a.name,r);if(!t)throw a.name+" track not found";return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),t.showPopup(e,!0),!1}).addClass("morpheus-track-header "+(r?"morpheus-columns":"morpheus-rows"));var c,h,p=0,d=0,f=!1;this.hammer=morpheus.Util.hammer(i,["pan","tap","longpress"]).on("longpress",this.longpress=function(e){e.preventDefault(),n.setSelectedTrack(a.name,r),n.getTrack(a.name,r).showPopup(e.srcEvent,!0)}).on("panend",this.panend=function(e){a.isMouseOver=!1,morpheus.CanvasUtil.dragging=!1,i.style.cursor="default";var t=n.getTrackIndex(a.name,r),o=n.getTrackHeaderByIndex(t,r),s=n.getTrackByIndex(t,r);$(s.canvas).css("z-index","0"),$(o.canvas).css("z-index","0"),n.revalidate()}).on("panstart",this.panstart=function(e){if(a.isMouseOver=!1,!morpheus.CanvasUtil.dragging)if(null!=l){if(morpheus.CanvasUtil.dragging=!0,i.style.cursor=l.cursor,l.isPrevious){var t=n.getTrackIndex(a.name,r);-1==--t&&(t=0);var o=n.getTrackHeaderByIndex(t,r);p=o.getUnscaledWidth(),d=o.getUnscaledHeight(),h=o.name}else h=null,p=a.getUnscaledWidth(),d=a.getUnscaledHeight();e.preventDefault(),f=!1}else{if(-1==(t=n.getTrackIndex(a.name,r)))throw a.name+" not found";o=n.getTrackHeaderByIndex(t,r);var s=n.getTrackByIndex(t,r);n.setSelectedTrack(a.name,r);var u=$(s.canvas);c=u.position(),u.css("z-index","100"),$(o.canvas).css("z-index","100"),morpheus.CanvasUtil.dragging=!0,l=void 0,f=!0}}).on("panmove",this.panmove=function(e){if(a.isMouseOver=!1,null!=l){var t,i;if("ew-resize"===l.cursor){var o=e.deltaX;t=Math.max(8,p+o)}if("ns-resize"===l.cursor){var s=e.deltaY;i=Math.max(8,d+s)}n.resizeTrack(null==h?a.name:h,t,i,r)}else if(f){var u=n.getTrackIndex(a.name,r),m=n.getTrackHeaderByIndex(u,r),g=n.getTrackByIndex(u,r),v=n.getNumTracks(r),y=r?e.deltaY:e.deltaX,b=u+(y>0?1:-1);b=Math.min(Math.max(0,b),v-1);var w=r?"top":"left",x=r?"getUnscaledHeight":"getUnscaledWidth",_={};_[w]=c[w]+y,g.setBounds(_),m.setBounds(_);var S=n.getTrackByIndex(b,r),C=S[x](),M=$(S.canvas).position()[w],T=c[w]+y,A=T+g[x]();if((y>0&&A>=M+C/2||y<0&&T<=M+C/2)&&u!==b){n.moveTrack(u,b,r);var E=n.getTrackHeaderByIndex(u,r),P=n.getTrackByIndex(u,r),R=$(P.canvas).position()[w];y<0?R+=g[x]():R-=g[x]();var I={};I[w]=R,P.setBounds(I),E.setBounds(I)}}}).on("tap",this.tap=function(i){if(!morpheus.Util.IS_MAC||!i.srcEvent.ctrlKey){a.isMouseOver=!1,n.setSelectedTrack(a.name,r);var o=(r?e.getFullDataset().getColumnMetadata():e.getFullDataset().getRowMetadata()).getByName(t);if((!r||n.options.columnsSortable)&&null!=o&&(r||n.options.rowsSortable)&&null!=o){var s,l,u=i.srcEvent.shiftKey,c=a.getSortKeyIndexForColumnName(a.getSortKeys(),a.name),h=morpheus.VectorUtil.getDataType(o);null!=c?s=(l=a.getSortKeys()[c.index]).getSortOrder()===morpheus.SortKey.SortOrder.UNSORTED?morpheus.SortKey.SortOrder.ASCENDING:l.getSortOrder()===morpheus.SortKey.SortOrder.ASCENDING?morpheus.SortKey.SortOrder.DESCENDING:l.getSortOrder()===morpheus.SortKey.SortOrder.TOP_N?morpheus.SortKey.SortOrder.UNSORTED:"number"===h||"[number]"===h?morpheus.SortKey.SortOrder.TOP_N:morpheus.SortKey.SortOrder.UNSORTED:(l=new morpheus.SortKey(a.name,morpheus.SortKey.SortOrder.ASCENDING),s=morpheus.SortKey.SortOrder.ASCENDING),null!=l&&(l.setSortOrder(s),a.setSortingStatus(a.getSortKeys(),l,u,!1))}}}),$(this.canvas).on("mousedown",function(e){l=s(morpheus.CanvasUtil.getMousePos(e.target,e,!0))})},morpheus.VectorTrackHeader.FONT_OFFSET=2,morpheus.VectorTrackHeader.prototype={selected:!1,isMouseOver:!1,defaultFontHeight:11,dispose:function(){morpheus.AbstractCanvas.prototype.dispose.call(this),this.hammer.off("longpress",this.longpress).off("panend",this.panend).off("panstart",this.panstart).off("panmove",this.panmove).off("tap",this.tap),this.hammer.destroy()},getPreferredSize:function(){var e=this.canvas.getContext("2d");e.font=this.fontWeight+" "+this.defaultFontHeight+"px "+morpheus.CanvasUtil.getFontFamily(e);var t={width:e.measureText(this.name).width,height:this.defaultFontHeight+morpheus.VectorTrackHeader.FONT_OFFSET};return t.width+=24,this.isColumns||(t.height=this.defaultFontHeight+morpheus.VectorTrackHeader.FONT_OFFSET),t},getPrintSize:function(){var e=this.canvas.getContext("2d");e.font=this.fontWeight+" "+this.defaultFontHeight+"px "+morpheus.CanvasUtil.getFontFamily(e);var t=this.heatMap.getTrack(this.name,this.isColumns),r=t.getPrintSize(),n={width:e.measureText(this.name).width+4,height:this.defaultFontHeight+morpheus.VectorTrackHeader.FONT_OFFSET},i=0;return t.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)&&1===t.settings.display.length&&(i=6),this.isColumns?(n.height=Math.max(n.height,r.height),n.height+=i):(n.width=Math.max(n.width,r.width),n.width+=i),n},getSortKeys:function(){return this.isColumns?this.project.getColumnSortKeys():this.project.getRowSortKeys()},setOrder:function(e){this.isColumns?this.project.setColumnSortKeys(morpheus.SortKey.keepExistingSortKeys(e,this.project.getColumnSortKeys()),!1):this.project.setRowSortKeys(morpheus.SortKey.keepExistingSortKeys(e,this.project.getRowSortKeys()),!1)},setGroupBy:function(e){for(var t=this.isColumns?this.project.groupColumns:this.project.groupRows,r=-1,n=0,i=t.length;n<i;n++)if(t[n].toString()===e.toString()){r=n;break}var o=[e];-1!==r&&(o=t).splice(r,1),this.isColumns?this.project.setGroupColumns(o,!0):this.project.setGroupRows(o,!0)},setSelected:function(e){e!=this.selected&&(this.selected=e,$(this.canvas).css({"background-color":this.selected?this.selectedBackgroundColor:this.backgroundColor}))},setSortingStatus:function(e,t,r,n){if(!n)if(t.getSortOrder()!=morpheus.SortKey.SortOrder.UNSORTED||r){if(r&&0==e.length&&(r=!1),r){var i=this.getSortKeyIndexForColumnName(e,t.toString());null===i?e.push(t):e[i.index]=t}else e=[t];this.setOrder(e)}else this.setOrder([]);n?this.setGroupBy(t):this.isColumns?this.project.trigger("columnSortOrderChanged"):this.project.trigger("rowSortOrderChanged")},getSortKeyIndexForColumnName:function(e,t){if(null!=e)for(var r=0,n=0,i=e.length;n<i;n++)if(e[n].isUnlockable()&&r++,e[n]instanceof morpheus.SortKey&&t===e[n].toString())return{index:n,number:r};return null},print:function(e,t){e.height<=6||(t.textBaseline="bottom",this.isColumns?(t.textAlign="right",t.font=this.font.weight+" "+Math.min(this.defaultFontHeight,e.height-morpheus.VectorTrackHeader.FONT_OFFSET)+"px "+morpheus.CanvasUtil.getFontFamily(t)):(t.textAlign="left",t.font=e.height-morpheus.VectorTrackHeader.FONT_OFFSET+"px "+morpheus.CanvasUtil.getFontFamily(t)),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,t.fillText(this.name,0,0))},draw:function(e,t){var r=this.getSortKeys(),n=this.name,i=this.getSortKeyIndexForColumnName(r,n),o=r.filter(function(e){return e.isUnlockable()});if(morpheus.CanvasUtil.resetTransform(t),t.clearRect(0,0,this.getUnscaledWidth(),this.getUnscaledHeight()),!(this.getUnscaledHeight()<5)){t.strokeStyle="#ddd",this.isColumns?(t.beginPath(),t.moveTo(0,this.getUnscaledHeight()),t.lineTo(this.getUnscaledWidth(),this.getUnscaledHeight()),t.stroke(),t.textAlign="right"):(t.beginPath(),t.moveTo(this.getUnscaledWidth(),0),t.lineTo(this.getUnscaledWidth(),this.getUnscaledHeight()),t.stroke(),t.textAlign="left");var a=t.measureText(n).width,s=this.isColumns,l=this.isColumns?this.getUnscaledWidth()-2:10;s&&(null!=i&&(l-=6,0!==r[i.index].getLockOrder()&&(l-=10)),r.length>1&&(l-=6)),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR;var u=this.isColumns?this.getUnscaledHeight()/2:this.getUnscaledHeight()-(this.defaultFontHeight+morpheus.VectorTrackHeader.FONT_OFFSET)/2;if(t.textBaseline="middle",this.isMouseOver)for(var c=l-(s?a+4:4),h=u-3,p=0;p<2;p++)for(var d=0;d<3;d++)t.fillRect(c-3*p,h+3*d,1.5,1.5);var f=Math.min(this.defaultFontHeight,this.getUnscaledHeight()-morpheus.VectorTrackHeader.FONT_OFFSET);if(f=Math.min(f,morpheus.VectorTrack.MAX_FONT_SIZE),t.font=this.font.weight+" "+f+"px "+morpheus.CanvasUtil.getFontFamily(t),t.fillText(n,l,u),t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,null!==i){t.beginPath();var m=this.isColumns?l+4:l+a+6,g=Math.min(8,this.getUnscaledHeight()/2-1);if(r[i.index].getSortOrder()===morpheus.SortKey.SortOrder.ASCENDING?(t.translate(m,u-g),t.moveTo(0,0),t.lineTo(3,g),t.lineTo(-3,g)):r[i.index].getSortOrder()===morpheus.SortKey.SortOrder.DESCENDING?(t.translate(m,u),t.moveTo(0,g),t.lineTo(3,0),t.lineTo(-3,0)):(t.translate(m,u-g/2),t.moveTo(0,0),t.lineTo(3,g/2),t.lineTo(0,g),t.lineTo(-3,g/2)),t.fill(),morpheus.CanvasUtil.resetTransform(t),t.textAlign="left",o.length>1){t.font="8px "+morpheus.CanvasUtil.getFontFamily(t);var v=""+i.number;t.fillText(v,m+4,u-2),m+=t.measureText(v).width}0!==r[i.index].getLockOrder()&&(t.font=f+"px FontAwesome",t.fillText("ï£",m+3+2,u))}}}},morpheus.Util.extend(morpheus.VectorTrackHeader,morpheus.AbstractCanvas),morpheus.VectorTrack=function(e,t,r,n,i){morpheus.AbstractCanvas.call(this,!0),this.preferredSize={width:0,height:0},this.project=e,this.positions=r,this.isColumns=n,this.name=t,this.visible=!0,this.heatmap=i,this.id=_.uniqueId();var o=this;this.updateSpanMapFunction=function(){o.spanMap=morpheus.VectorUtil.createSpanMap(o.getVector())},this.lastPosition={start:-1,end:-1},this.events="rowSortOrderChanged rowFilterChanged datasetChanged",$(this.canvas).on("contextmenu.morpheus",function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),i.setSelectedTrack(o.name,n),o.showPopup(e),!1}),this.settings={maxTextWidth:void 0,squished:!1,inlineTooltip:!1,tooltip:!0,highlightMatchingValues:!1,colorBarSize:12,stackedBar:!1,display:[],selectionColor:"rgb(182,213,253)",colorByField:null,fontField:null,barColor:"#bdbdbd",barSize:40,min:void 0,mid:void 0,max:void 0,autoscaleAlways:!1,minMaxReversed:!1},$(this.canvas).on("mousemove.morpheus mouseout.morpheus",function(e){var t=-1;if("mouseout"!==e.type){var a=morpheus.CanvasUtil.getMousePosWithScroll(e.target,e,i.scrollLeft(),i.scrollTop());if(o.settings.squished){var s=(r.getPosition(r.getLength()-1)+r.getItemSize(r.getLength()-1))/(n?o.getUnscaledWidth():o.getUnscaledHeight());a[n?"x":"y"]*=s}t=n?o.positions.getIndex(a.x,!1):o.positions.getIndex(a.y,!1)}n?i.setMousePosition(-1,t,{name:o.name,event:e}):i.setMousePosition(t,-1,{name:o.name,event:e})})},morpheus.VectorTrack.RENDER={TEXT:"text",COLOR:"color",BAR:"bar",MOLECULE:"molecule",TEXT_AND_COLOR:"text_and_color",TEXT_AND_FONT:"text_and_font",SHAPE:"shape",ARC:"arc",BOX_PLOT:"box_plot",HEAT_MAP:"heat_map"},morpheus.VectorTrack.vectorToString=function(e){var t=morpheus.VectorUtil.getDataType(e),r=e.getProperties().get(morpheus.VectorKeys.FORMATTER);if(null!=r){if("object"==typeof r){if(r=morpheus.Util.createNumberFormat(r.pattern),"[number]"===t){var n=r;r=function(e){var t=[];if(null!=e)for(var r=0,i=e.length;r<i;r++)t.push(n(e[r]));return t.join(", ")}}e.getProperties().set(morpheus.VectorKeys.FORMATTER,r)}}else r="number"===t?morpheus.Util.nf:"[number]"===t?function(e){var t=[];if(null!=e)for(var r=0,n=e.length;r<n;r++)t.push(morpheus.Util.nf(e[r]));return t.join(", ")}:"[string]"===t?function(e){var t=[];if(null!=e)for(var r=0,n=e.length;r<n;r++)t.push(e[r]);return t.join(", ")}:function(e){return""+e};return r},morpheus.VectorTrack.prototype={settingFromConfig:function(e){var t=this,r=this.settings,n=function(e){r.display=[];for(var n=e.split(","),i=0,o=n.length;i<o;i++){var a=$.trim(n[i]);a=a.toUpperCase();var s=morpheus.VectorTrack.RENDER[a];void 0!==s?r.display.push(s):"DISCRETE"===a?t.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE,!0):"CONTINUOUS"===a?t.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!1):"HIGHLIGHT"===a?r.highlightMatchingValues=!0:"STACKED_BAR"===a?(r.stackedBar=!0,r.display.push(morpheus.VectorTrack.RENDER.BAR)):"TOOLTIP"===a?r.inlineTooltip=!0:console.log(a+" not found.")}};if(null!=e){if(_.isString(e))n(e);else if(_.isArray(e))!function(e){r.display=[];for(var t=0;t<e.length;t++){var n=e[t].toUpperCase(),i=morpheus.VectorTrack.RENDER[n];void 0!==i?r.display.push(i):console.log(n+" not found.")}}(e);else{var i=e;!_.isArray(e.display)&&_.isObject(e.display)&&(i=e.display),(r=$.extend({},r,i)).maxTextWidth=void 0,null!=i.discrete&&t.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE,i.discrete),_.isArray(i.display)?r.display=i.display:_.isString(i.display)&&n(i.display),!_.isArray(r.render)&&_.isObject(r.render)&&(function(e){for(var t in r.display=[],e)if(e[t]){var n=t.toUpperCase(),i=morpheus.VectorTrack.RENDER[n];void 0!==i&&r.display.push(i)}}(r.render),delete r.render)}this.settings=r}this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)||!this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)&&!this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)||r.display.push(morpheus.VectorTrack.RENDER.TEXT),this._update()},setShowTooltip:function(e){this.settings.tooltip=e},isShowTooltip:function(){return this.settings.tooltip},isRenderAs:function(e){return-1!==this.settings.display.indexOf(e)},dispose:function(){morpheus.AbstractCanvas.prototype.dispose.call(this),$(this.canvas).off(),this._selection.dispose(),this.project.off(this.events,this.updateSpanMapFunction)},getName:function(){return this.name},getVector:function(e){return e=null==e?this.name:e,(this.isColumns?this.project.getSortedFilteredDataset().getColumnMetadata().getByName(e):this.project.getSortedFilteredDataset().getRowMetadata().getByName(e))||new morpheus.Vector(e,0)},getFullVector:function(){return(this.isColumns?this.project.getFullDataset().getColumnMetadata().getByName(this.name):this.project.getFullDataset().getRowMetadata().getByName(this.name))||new morpheus.Vector(this.name,0)},_updatePreferredSize:function(){var e=this._computePreferredSize();this.preferredSize.width=e.width,this.preferredSize.height=e.height},_computePreferredSize:function(e){var t=0;if(this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT))if(this.positions.getSize()>=6){var r=this.canvas.getContext("2d"),n=morpheus.CanvasUtil.getVectorStringWidth(r,this.getVector(),this.positions,e?-1:this.isColumns?120:100);e||(this.settings.maxTextWidth=n),t+=n}else e||(this.settings.maxTextWidth=0);this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)&&(t+=this.settings.barSize),this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)&&(t+=this.settings.colorBarSize),this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)&&(t+=this.settings.colorBarSize),this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)&&(t+=300),this.isRenderAs(morpheus.VectorTrack.RENDER.ARC)&&(t+=this.settings.arcSize),this.isRenderAs(morpheus.VectorTrack.RENDER.BOX_PLOT)&&(t+=100),this.isRenderAs(morpheus.VectorTrack.RENDER.HEAT_MAP)&&(t+=100);var i=this.settings.display.length;return i>0&&(t+=2*(i-1)),t=Math.max(0,t),this.isColumns?{width:0,height:t}:{width:t,height:0}},getPreferredSize:function(){return this.preferredSize},getPrintSize:function(){return this._computePreferredSize(!0)},_setChartMinMax:function(){if((this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)||this.isRenderAs(morpheus.VectorTrack.RENDER.BOX_PLOT))&&(this.settings.autoscaleAlways||null==this.settings.min||null==this.settings.max||null==this.settings.mid)){var e=this.getFullVector(),t=morpheus.VectorUtil.getMinMax(e),r=t.min,n=t.max;if(this.settings.minMaxReversed){var i=n;n=r,r=i}(this.settings.autoscaleAlways||null==this.settings.min)&&(this.settings.min=Math.min(0,r)),(this.settings.autoscaleAlways||null==this.settings.max)&&(this.settings.max=Math.max(0,n)),(this.settings.autoscaleAlways||null==this.settings.mid)&&(this.settings.mid=this.settings.min<0?0:this.settings.min)}},_update:function(){if(null==this.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)&&(this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.BAR))&&(null!=(this.isColumns?this.project.getColumnColorModel():this.project.getRowColorModel()).getContinuousColorScheme(this.getFullVector())?(this.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!1),this.settings.highlightMatchingValues=!1):null!=(this.isColumns?this.project.getColumnColorModel():this.project.getRowColorModel()).getDiscreteColorScheme(this.getFullVector())?(this.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!0),this.settings.highlightMatchingValues=!0):(this.getFullVector().getProperties().has(morpheus.VectorKeys.FIELDS)||"number"===morpheus.VectorUtil.getDataType(this.getFullVector())||"[number]"===morpheus.VectorUtil.getDataType(this.getFullVector()))&&(this.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!1),this.settings.highlightMatchingValues=!1)),null==this.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)&&this.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!0),this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)&&this.project.off(this.events,this.updateSpanMapFunction),this._setChartMinMax(),this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)&&(this.project.on(this.events,this.updateSpanMapFunction),!this.moleculeCache)){this.moleculeCache={};var e=this,t=this.getFullVector().getProperties().get(morpheus.VectorKeys.VALUE_TO_INDICES);if(!t){var r=this.getFullVector();t=morpheus.VectorUtil.createValueToIndicesMap(r),r.getProperties().set(morpheus.VectorKeys.VALUE_TO_INDICES,t)}if(void 0!==e.heatmap.options.structureUrlProvider)t.forEach(function(t,r){var n=e.heatmap.options.structureUrlProvider(r),i=new Image;i.src=n,e.moleculeCache[r]=i}),setTimeout(function(){e.setInvalid(!0),e.repaint()},2e3);else for(var n=t.keys(),i=function(t){$.ajax({contentType:"text/plain",context:{smile:t},data:{string:t,representation:"sdf"},url:"http://cactus.nci.nih.gov/chemical/structure"}).then(function(t){e.moleculeCache[this.smile]=t,n.length>0&&i(n.pop()),e.invalid=!0,e.repaint()})},o=0;o<6;o++)i(n.pop());this.updateSpanMapFunction()}this._updatePreferredSize()},postPaint:function(e,t){t.lineWidth=1,t.strokeStyle="Grey";var r=this.project,n=this._setup(t,e),i=n.vector,o=n.start,a=n.end;this.isColumns?-1!==r.getHoverColumnIndex()&&this.drawColumnBorder(t,this.positions,r.getHoverColumnIndex(),this.getUnscaledHeight()):-1!==r.getHoverRowIndex()&&this.drawRowBorder(t,this.positions,r.getHoverRowIndex(),this.getUnscaledWidth()),this._highlightMatchingValues(t,i,o,a)},_highlightMatchingValues:function(e,t,r,n){var i=this.project,o=this.positions;e.strokeStyle="black",e.lineWidth=3;var a=this.isColumns?i.getHoverColumnIndex():i.getHoverRowIndex(),s=t.getValue(a);if(this.settings.highlightMatchingValues&&-1!==a&&this.heatmap.mousePositionOptions&&this.heatmap.mousePositionOptions.name===t.getName()){var l=this.getFullVector().getProperties().get(morpheus.VectorKeys.VALUE_TO_INDICES);if(!l){var u=this.getFullVector();l=morpheus.VectorUtil.createValueToIndicesMap(u),u.getProperties().set(morpheus.VectorKeys.VALUE_TO_INDICES,l)}if(null==(m=l.get(s)))return void console.log("valueToModelIndices error");if(m.length<=1)return;if(this.isColumns){if(-1!==i.getHoverColumnIndex()){var c=this.getUnscaledHeight();e.beginPath();for(var h=0,p=m.length;h<p;h++)if((v=i.convertModelColumnIndexToView(m[h]))>=r&&v<n){var d=o.getItemSize(v),f=o.getPosition(v);e.rect(f,0,d,c)}e.stroke()}}else{e.beginPath();var m,g=this.getUnscaledWidth();for(h=0,p=(m=l.get(s)).length;h<p;h++){var v;(v=i.convertModelRowIndexToView(m[h]))>=r&&v<n&&(d=o.getItemSize(v),f=o.getPosition(v),e.rect(0,f,g,d))}e.stroke()}}},drawSelection:function(e){var t=this.project,r=this.positions,n=e.context,i=e.start,o=e.end;if(n.lineWidth=1,n.fillStyle=this.settings.selectionColor,this.isColumns){var a=this.getUnscaledHeight();t.getColumnSelectionModel().getViewIndices().forEach(function(e){if(e>=i&&e<=o){var t=r.getItemSize(e),s=r.getPosition(e);n.fillRect(s,0,t,a)}})}else{var s=this.getUnscaledWidth();this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)||t.getRowSelectionModel().getViewIndices().forEach(function(e){if(e>=i&&e<=o){var t=r.getItemSize(e),a=r.getPosition(e);n.fillRect(0,a,s,t)}})}},prePaint:function(e,t){this.project,this.positions;var r=this._setup(t,e),n=r.start,i=r.end;this.drawSelection({context:t,start:n,end:i}),(this.invalid||n!==this.lastPosition.start||i!==this.lastPosition.end)&&(this.lastPosition.start=n,this.lastPosition.end=i,this.invalid=!0)},drawRowBorder:function(e,t,r,n){var i=t.getItemSize(r),o=t.getPosition(r);e.beginPath(),e.moveTo(0,o+i),e.lineTo(n,o+i),e.stroke(),e.beginPath(),e.moveTo(0,o),e.lineTo(n,o),e.stroke()},drawColumnBorder:function(e,t,r,n){var i=t.getItemSize(r),o=t.getPosition(r);e.beginPath(),e.moveTo(o+i,0),e.lineTo(o+i,n),e.stroke(),e.beginPath(),e.moveTo(o,0),e.lineTo(o,n),e.stroke()},isSquished:function(){return this.settings.squished},_setup:function(e,t){var r=0,n=this.getVector(),i=n.size(),o=this.settings,a=this.positions,s=t.width,l=t.height;if(o.squished||(this.isColumns?(r=morpheus.Positions.getLeft(t,a),i=morpheus.Positions.getRight(t,a)):(r=morpheus.Positions.getTop(t,a),i=morpheus.Positions.getBottom(t,a))),o.squished){var u=a.getPosition(a.getLength()-1)+a.getItemSize(a.getLength()-1);if(this.isColumns)c=s/u,e.scale(c,1);else{var c=l/u;e.scale(1,c)}}else e.translate(-t.x,-t.y);return{start:r,end:i,vector:n}},draw:function(e,t){var r=this._setup(t,e);this._draw({start:r.start,end:r.end,vector:r.vector,context:t,availableSpace:this.isColumns?this.getUnscaledHeight():this.getUnscaledWidth(),clip:e})},print:function(e,t){var r=this.getVector();this._draw({start:0,end:r.size(),vector:r,context:t,availableSpace:this.isColumns?e.height:e.width,clip:e})},_draw:function(e){var t=e.context,r=e.vector,n=e.availableSpace,i=e.availableSpace,o=e.start,a=e.end,s=e.clip,l=this.positions;this.settings.autoscaleAlways&&this._setChartMinMax(),t.textAlign="left",t.fillStyle=morpheus.CanvasUtil.FONT_COLOR;var u=Math.min(morpheus.VectorTrack.MAX_FONT_SIZE,l.getSize()-2),c=0;if(t.font=u+"px "+morpheus.CanvasUtil.getFontFamily(t),t.strokeStyle=morpheus.HeatMapElementCanvas.GRID_COLOR,t.lineWidth=.1,this.heatmap.heatmap.isDrawGrid()&&!this.settings.squished)if(this.isColumns){var h=n;t.beginPath();for(var p=o;p<a;p++){c=l.getItemSize(p);var d=l.getPosition(p);c>7&&(t.moveTo(d+c,0),t.lineTo(d+c,h))}t.stroke()}else if(!this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)){for(h=n,t.beginPath(),p=o;p<a;p++)c=l.getItemSize(p),d=l.getPosition(p),c>7&&(t.moveTo(0,d+c),t.lineTo(h,d+c));t.stroke()}t.lineWidth=1;var f=1;if(this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)&&(this.renderColor(t,r,o,a,s,this.isColumns?n:0,!this.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)),n-=f+=this.settings.colorBarSize+2),!this.settings.squished&&this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)&&(this.renderShape(t,r,o,a,s,this.isColumns?n-f:f),n-=f+=this.settings.colorBarSize+2),this.isRenderAs(morpheus.VectorTrack.RENDER.ARC)&&(this.renderArc(t,r,o,a,s,this.settings.arcSize),n-=f+=this.settings.arcSize+2),!this.settings.squished&&this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)&&this.renderMolecule(t,r,o,a,s,f,n),this.isRenderAs(morpheus.VectorTrack.RENDER.BOX_PLOT)){var m=this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)?this.settings.barSize:n-2;f++,this.renderBoxPlot(t,r,o,a,s,f,m),n-=f+=m+2}if(this.isRenderAs(morpheus.VectorTrack.RENDER.HEAT_MAP)&&(m=this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)?this.settings.barSize:n-2,f++,this.renderHeatMap(t,r,o,a,s,m),n-=f+=m+2),this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)){if(m=this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)?this.settings.barSize:n-1,this.settings.stackedBar)this.renderStackedBar(t,r,o,a,s,f,m);else{var g=r.getProperties().get(morpheus.VectorKeys.FIELDS),v=r.getProperties().get(morpheus.VectorKeys.VISIBLE_FIELDS);null!=g&&null==v&&(v=morpheus.Util.seq(g.length)),null!=g?this.renderUnstackedBar(t,r,o,a,s,f,m,v):this.renderBar(t,r,o,a,s,this.isColumns?i-f-m:f,m)}n-=f+=m+2}!this.settings.squished&&this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)&&(this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT))&&(t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,this.renderText(t,r,this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR),this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT),o,a,s,this.isColumns?i-f:f),n-=f+=this.settings.maxTextWidth+2),this.settings.squished||!this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)||(t.fillStyle=morpheus.CanvasUtil.FONT_COLOR,"url"===morpheus.VectorUtil.getDataType(r)&&(t.fillStyle="blue",this.canvas.style.cursor="pointer"),this.renderText(t,r,!1,!1,o,a,s,this.isColumns?i-f:f))},showPopup:function(e,t){var r=this,n=this.project,i=this.isColumns,o=i?n.getColumnSelectionModel().count()>0:n.getRowSelectionModel().count()>0,a="Sort Heat Map Ascending â",s="Sort Heat Map Descending â",l=(this.positions,this.heatmap),u={Sort:[],Selection:[],Display:[]},c=this.heatmap.getPopupItems();c&&c.length>0&&c.forEach(function(e){e.columns===i&&u[e.section].push(e)}),u.Selection.length>0&&u.Selection.push({separator:!0}),u.Selection.push({name:"Move To Top"}),this.heatmap.options.menu.Edit&&-1!==this.heatmap.options.menu.Edit.indexOf("Annotate Selected Rows")&&u.Selection.push({name:"Annotate Selection"}),u.Selection.push({name:"Copy",class:"copy"}),u.Selection.push({name:"Invert Selection"}),u.Selection.push({name:"Select All"}),u.Selection.push({name:"Clear Selection"}),-1!==(i?n.getColumnFilter():n.getRowFilter()).indexOf("Show Selection Only")&&u.Selection.push({name:"Show All"}),t||(u.Sort.push({name:a,disabled:!o}),u.Sort.push({name:s,disabled:!o}),u.Sort.push({name:"Sort Heat Map Descending/Ascending",disabled:!o}));var h=morpheus.VectorUtil.getDataType(this.getFullVector()),p=this.getFullVector().getProperties().get(morpheus.VectorKeys.FIELDS),d=void 0!==p,f="number"===h||"[number]"===h;(f||d)&&(u.Display.push({name:"Format"}),u.Display.push({separator:!0}),u.Display.push({name:"Show Bar Chart",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)})),d&&(u.Display.push({name:"Show Stacked Bar Chart",checked:this.settings.stackedBar}),u.Display.push({name:"Show Box Plot",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.BOX_PLOT)}),u.Display.push({name:"Choose Fields..."})),"url"!==h&&(u.Display.push({name:"Show Text",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT)}),u.Display.push({name:"Encode Text Using Color",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)}),this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)&&u.Display.push({name:"Text Color Annotation",checked:null!=this.settings.colorByField}),u.Display.push({name:"Encode Text Using Font",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)}),u.Display.push({separator:!0}),u.Display.push({name:"Show Color",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)}),this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)&&u.Display.push({name:"Color Bar Size..."})),d||"url"===h||u.Display.push({name:"Show Shape",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)}),d||f||this.isColumns||-1===name.toLowerCase().indexOf("smile")||u.Display.push({name:"Show Chemical Structure",checked:this.isRenderAs(morpheus.VectorTrack.RENDER.MOLECULE)}),u.Display.push({name:"Show In Tooltip",checked:this.settings.inlineTooltip}),d||"url"===h||u.Display.push({name:"Highlight Matching Values",checked:this.settings.highlightMatchingValues}),(this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)||this.isRenderAs(morpheus.VectorTrack.RENDER.BOX_PLOT))&&(u.Display.push({separator:!0}),this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)&&u.Display.push({name:"Edit Bar Color..."}),u.Display.push({name:"Auto Range"}),u.Display.push({name:"Custom Range..."})),(this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)||this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)||this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE))&&(u.Display.push({separator:!0}),f&&u.Display.push({name:"Continuous",checked:!this.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)}),(this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)&&d)&&u.Display.push({name:"Edit Colors..."}),this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)&&null!=this.settings.colorByField&&u.Display.push({name:"Edit Text Colors..."}),this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)&&u.Display.push({name:"Edit Shapes..."}),this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)&&u.Display.push({name:"Edit Fonts..."}),(this.isRenderAs(morpheus.VectorTrack.RENDER.COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_COLOR)||this.isRenderAs(morpheus.VectorTrack.RENDER.BAR)&&d)&&u.Display.push({name:"Color Key",icon:"fa fa-key"})),this.isRenderAs(morpheus.VectorTrack.RENDER.SHAPE)&&u.Display.push({name:"Shape Key",icon:"fa fa-key"}),this.isRenderAs(morpheus.VectorTrack.RENDER.TEXT_AND_FONT)&&u.Display.push({name:"Font Key",icon:"fa fa-key"}),u.Display.push({separator:!0}),u.Display.push({name:"Hide"}),u.Display.push({name:"Hide Others",disabled:l.getVisibleTrackNames(this.isColumns).length<=1}),u.Display.push({separator:!0}),u.Display.push({name:"Delete..."});var m=[];function g(e){m.length>0&&m.push({separator:!0}),m=m.concat(u[e])}g("Sort"),_.each(u.Selection,function(e){"Show All"!==e.name&&"Select All"!==e.name&&(e.disabled=!o)}),t?-1!==this.heatmap.options.toolbar.indexOf("Options")&&g("Display"):g("Selection"),e.preventDefault&&e.preventDefault(),0!==m.length&&morpheus.Popup.showPopup(m,{x:e.pageX,y:e.pageY},e.target,function(t,o){var u;if("Format"===o){var h=r.getFullVector(),d=h.getProperties().get(morpheus.VectorKeys.FORMATTER);null!=d&&"object"==typeof d&&(d=morpheus.Util.createNumberFormat(d.pattern),h.getProperties().set(morpheus.VectorKeys.FORMATTER,d));var f=null!=d?d.toJSON().pattern:".2f";(S=new morpheus.FormBuilder).append({name:"number_of_fraction_digits",type:"number",value:morpheus.Util.getNumberFormatPatternFractionDigits(f),required:!0,style:"max-width:60px;"}),S.find("number_of_fraction_digits").on("keyup input",_.debounce(function(){var e=parseInt($(this).val());e>=0&&(h.getProperties().set(morpheus.VectorKeys.FORMATTER,{pattern:"."+e+"f"}),r.setInvalid(!0),r.repaint())},100)),morpheus.FormBuilder.showInModal({title:"Format",close:"Close",html:S.$form,focus:l.getFocusEl()})}else if("Copy"===o)l.getActionManager().execute(i?"Copy Selected Columns":"Copy Selected Rows");else if("Choose Fields..."===o){var m,g=r.getFullVector().getProperties().get(morpheus.VectorKeys.VISIBLE_FIELDS);if(null==g)m=p.slice(0);else{m=[];for(var v=0;v<g.length;v++)m.push(p[g[v]])}var y=[];for(v=0;v<p.length;v++)-1===m.indexOf(p[v])&&y.push(p[v]);var b=[],w=[];for(v=0;v<y.length;v++)b.push(new Option(y[v],y[v]));for(v=0;v<m.length;v++)w.push(new Option(m[v],m[v]));var x=new morpheus.DualList(b,w);morpheus.FormBuilder.showOkCancel({title:"Fields",okCallback:function(){for(var e=x.getOptions(!1),t=[],n=0;n<e.length;n++)t.push(p.indexOf(e[n]));var i=r.getFullVector();i.getProperties().set(morpheus.VectorKeys.VISIBLE_FIELDS,t);var o=i.getProperties().get(morpheus.VectorKeys.ARRAY_SUMMARY_FUNCTION);o&&(o.indices=t);var a=r.isColumns?r.project.getFullDataset().getColumnMetadata().add(r.name):r.project.getFullDataset().getRowMetadata().add(r.name);for(n=0;n<a.size();n++){var s=i.getValue(n);null!=s&&(s.summary=void 0)}r.setInvalid(!0),r.repaint()},content:x.$el})}else if("Text Color Annotation"===o){var S=new morpheus.FormBuilder,C=morpheus.MetadataUtil.getMetadataNames(i?r.project.getFullDataset().getColumnMetadata():r.project.getFullDataset().getRowMetadata());C.splice(C.indexOf(r.name),1),C=["(None)"].concat(C),S.append({name:"annotation",type:"bootstrap-select",help:"Use another annotation to determine text color",search:!0,options:C,value:null==r.settings.colorByField?"(None)":r.settings.colorByField}),S.find("annotation").on("change",function(){r.settings.colorByField=$(this).val(),"(None)"===r.settings.colorByField&&(r.settings.colorByField=null),r.setInvalid(!0),r.repaint()}),morpheus.FormBuilder.showInModal({title:"Text Color Annotation",close:"Close",html:S.$form,focus:l.getFocusEl()})}else if("Edit Bar Color..."===o)(S=new morpheus.FormBuilder).append({name:"bar_color",type:"color",value:r.settings.barColor,required:!0,style:"max-width:50px;"}),S.find("bar_color").on("change",function(){r.settings.barColor=$(this).val(),r.setInvalid(!0),r.repaint()}),morpheus.FormBuilder.showInModal({title:"Bar Color",close:"Close",html:S.$form,focus:l.getFocusEl()});else if("Color Bar Size..."===o)(S=new morpheus.FormBuilder).append({name:"size",type:"text",value:r.settings.colorBarSize,required:!0,style:"max-width:50px;"}),S.find("size").on("change",function(){var e=parseFloat($(this).val());e>0&&(r.settings.colorBarSize=e,r.setInvalid(!0),r.repaint())}),morpheus.FormBuilder.showInModal({title:"Color Bar Size",close:"Close",html:S.$form,focus:l.getFocusEl()});else if("Annotate Selection"===o)l.getActionManager().execute(i?"Annotate Selected Columns":"Annotate Selected Rows");else if("Delete..."===o)morpheus.FormBuilder.showOkCancel({title:"Delete",content:"Are you sure you want to delete "+r.name+"?",okCallback:function(){var e=i?n.getFullDataset().getColumnMetadata():n.getFullDataset().getRowMetadata();e.remove(morpheus.MetadataUtil.indexOf(e,r.name));var t=i?n.getColumnSortKeys():n.getRowSortKeys(),o=_.indexOf(t.map(function(e){return e.field}),r.name);-1!==o&&(t.splice(o,1),i?n.setColumnSortKeys(t,!0):n.setRowSortKeys(t,!0));var a=i?n.getGroupColumns():n.getGroupRows(),s=_.indexOf(a.map(function(e){return e.field}),r.name);-1!==s&&(a.splice(s,1),i?n.setGroupColumns(a,!0):n.setGroupRows(a,!0)),i?n.trigger("columnTrackRemoved",{vector:r.getFullVector()}):n.trigger("rowTrackRemoved",{vector:r.getFullVector()})}});else if("Clear Selection"===o)l.getActionManager().execute(i?"Clear Selected Columns":"Clear Selected Rows");else if("Invert Selection"===o)l.getActionManager().execute(i?"Invert Selected Columns":"Invert Selected Rows");else if("Move To Top"===o)l.getActionManager().execute(i?"Move Selected Columns To Top":"Move Selected Rows To Top");else if("Sort Ascending"===o||"Sort Descending"===o){var M=new morpheus.SortKey(r.name,"Sort Ascending"===o?morpheus.SortKey.SortOrder.ASCENDING:morpheus.SortKey.SortOrder.DESCENDING);r.isColumns?r.project.setColumnSortKeys(morpheus.SortKey.keepExistingSortKeys([M],n.getColumnSortKeys()),!0):r.project.setRowSortKeys(morpheus.SortKey.keepExistingSortKeys([M],n.getRowSortKeys()),!0)}else if(o==a||o==s||"Sort Heat Map Descending/Ascending"===o){var T;T=o===a?morpheus.SortKey.SortOrder.ASCENDING:o===s?morpheus.SortKey.SortOrder.DESCENDING:morpheus.SortKey.SortOrder.TOP_N,l.sortBasedOnSelection(T,i,e&&e.shiftKey)}else if("Select All"===o)l.getActionManager().execute(i?"Select All Columns":"Select All Rows");else if("Auto Range"===o)delete r.settings.min,delete r.settings.max,delete r.settings.mid,r._update(),l.revalidate();else if("Custom Range..."===o){S=new morpheus.FormBuilder;var A=[{name:"min",required:!0,type:"number",value:r.settings.min},{name:"mid",required:!0,type:"number",value:r.settings.mid},{name:"max",required:!0,type:"number",value:r.settings.max}];_.each(A,function(e){S.append(e)}),morpheus.FormBuilder.showOkCancel({title:"Range",content:S.$form,okCallback:function(){r.settings.min=parseFloat(S.getValue("min")),r.settings.mid=parseFloat(S.getValue("mid")),r.settings.max=parseFloat(S.getValue("max")),r._update(),l.revalidate()}})}else if("Squished"===o)r.settings.squished=!r.settings.squished,l.revalidate();else if("Color Key"===o){var E=(P=new morpheus.HeatMapTrackColorLegend([r],i?r.project.getColumnColorModel():r.project.getRowColorModel())).getPreferredSize();P.setBounds(E),P.repaint(),morpheus.FormBuilder.showInModal({title:"Color Key",html:P.canvas,focus:l.getFocusEl()})}else if("Shape Key"===o)E=(P=new morpheus.HeatMapTrackShapeLegend([r],i?r.project.getColumnShapeModel():r.project.getRowShapeModel())).getPreferredSize(),P.setBounds(E),P.repaint(),morpheus.FormBuilder.showInModal({title:"Shape Key",html:P.canvas,focus:l.getFocusEl()});else if("Font Key"===o){var P;E=(P=new morpheus.HeatMapTrackFontLegend([r],i?r.project.getColumnFontModel():r.project.getRowFontModel())).getPreferredSize(),P.setBounds(E),P.repaint(),morpheus.FormBuilder.showInModal({title:"Font Key",html:P.canvas,focus:l.getFocusEl()})}else if("Edit Fonts..."===o)l.getActionManager().execute("Edit Fonts");else if("Edit Shapes..."===o){new morpheus.FormBuilder;var R=i?r.project.getColumnShapeModel():r.project.getRowShapeModel(),I=new morpheus.ShapeChooser({map:R.getMap(r.name)});I.on("change",function(e){R.setMappedValue(r.getFullVector(),e.value,e.shape),r.setInvalid(!0),r.repaint()}),morpheus.FormBuilder.showInModal({title:"Edit Shapes",html:I.$div,close:"Close",focus:l.getFocusEl()})}else if("Edit Text Colors..."===o||"Edit Colors..."===o){var N=i?r.project.getColumnColorModel():r.project.getRowColorModel(),D=new morpheus.ColorSchemeChooser({isColumns:r.isColumns,heatMap:r.heatmap,colorModel:N});D.setAnnotationName("Edit Text Colors..."===o?r.settings.colorByField:r.getName()),D.on("change",function(){r.setInvalid(!0),r.repaint()}),morpheus.FormBuilder.showInModal({title:"Edit Colors",html:D.$div,close:"Close",focus:l.getFocusEl(),onClose:function(){D.off("change")}})}else if("Show In Tooltip"===o)r.settings.inlineTooltip=!r.settings.inlineTooltip;else if("Highlight Matching Values"===o)r.settings.highlightMatchingValues=!r.settings.highlightMatchingValues;else if(u=_.find(c,function(e){return e.name===o&&e.columns===i}))if(u.task){var k={tabId:r.heatmap.getTabManager().getActiveTabId()};r.heatmap.getTabManager().addTask(k),setTimeout(function(){u.callback(l),r.heatmap.getTabManager().removeTask(k)},1)}else u.callback(l);else if("Continuous"===o){var O=r.getFullVector().getProperties().get(morpheus.VectorKeys.DISCRETE)||!1;r.getFullVector().getProperties().set(morpheus.VectorKeys.DISCRETE,!O),r._setChartMinMax(),r.setInvalid(!0),r.repaint()}else if("Hide"===o)l.setTrackVisible(r.name,!1,r.isColumns),l.revalidate();else if("Hide Others"===o){var F=l.getVisibleTrackNames(r.isColumns);for(v=0;v<F.length;v++)F[v]!==r.name&&l.setTrackVisible(F[v],!1,r.isColumns);l.revalidate()}else if("Show Stacked Bar Chart"===o)r.settings.stackedBar=!r.settings.stackedBar,r._update(),l.revalidate();else{"Show Bar Chart"===o?o=morpheus.VectorTrack.RENDER.BAR:"Show Color"===o?o=morpheus.VectorTrack.RENDER.COLOR:"Show Text"===o?o=morpheus.VectorTrack.RENDER.TEXT:"Encode Text Using Color"===o?o=morpheus.VectorTrack.RENDER.TEXT_AND_COLOR:"Encode Text Using Font"===o?o=morpheus.VectorTrack.RENDER.TEXT_AND_FONT:"Show Chemical Structure"===o?o=morpheus.VectorTrack.RENDER.MOLECULE:"Show Shape"===o?o=morpheus.VectorTrack.RENDER.SHAPE:"Show Arc"===o?o=morpheus.VectorTrack.RENDER.ARC:"Show Box Plot"===o?o=morpheus.VectorTrack.RENDER.BOX_PLOT:console.log("Unknown item "+o);var L,U=!r.isRenderAs(o);U?r.settings.display.push(o):(r.settings.display.splice(r.settings.display.indexOf(o),1),o===morpheus.VectorTrack.RENDER.TEXT&&(L=[morpheus.VectorTrack.RENDER.TEXT_AND_FONT,morpheus.VectorTrack.RENDER.TEXT_AND_COLOR])),L&&L.forEach(function(e){var t=r.settings.display.indexOf(e);-1!==t&&r.settings.display.splice(t,1)}),r._update(),l.revalidate(),U&&o===morpheus.VectorTrack.RENDER.TEXT_AND_FONT&&l.getActionManager().execute("Edit Fonts")}})},renderColor:function(e,t,r,n,i,o,a){var s,l=this.isColumns,u=this.positions,c=l?this.project.getColumnColorModel():this.project.getRowColorModel(),h=this.settings,p=l?this.getUnscaledHeight():this.getUnscaledWidth(),d=h.colorBarSize;if(d>p&&(d=p>=5?p-1:p),s=a?_.bind(c.getContinuousMappedValue,c):_.bind(c.getMappedValue,c),null!=t.getProperties().get(morpheus.VectorKeys.FIELDS)){var f=t.getProperties().get(morpheus.VectorKeys.VISIBLE_FIELDS);null==f&&(f=morpheus.Util.seq(t.getProperties().get(morpheus.VectorKeys.FIELDS).length)),d/=f.length;for(var m=f.length,g=r;g<n;g++){var v=t.getValue(g),y=u.getPosition(g),b=u.getItemSize(g),w=o;if(null!=v)for(var x=0;x<m;x++){var S=s(t,C=v[f[x]]);e.fillStyle=S,l?(e.beginPath(),e.rect(y,w-d,b,d),e.fill()):(e.beginPath(),e.rect(w,y,d,b),e.fill()),w+=d}}}else for(g=r;g<n;g++){var C=t.getValue(g);y=u.getPosition(g),b=u.getItemSize(g),S=s(t,C),e.fillStyle=S,l?(e.beginPath(),e.rect(y,o-d,b,h.colorBarSize),e.fill()):(e.beginPath(),e.rect(o,y,d,b),e.fill())}},renderShape:function(e,t,r,n,i,o){var a=this.isColumns,s=this.positions,l=a?this.project.getColumnShapeModel():this.project.getRowShapeModel(),u=this.settings,c=a?this.getUnscaledHeight():this.getUnscaledWidth(),h=u.colorBarSize;h>c&&(h=c>=5?c-1:c),e.fillStyle="black",e.strokeStyle="black";var p=e.lineWidth;e.lineWidth=1;for(var d=r;d<n;d++){var f=t.getValue(d),m=s.getPosition(d),g=s.getItemSize(d),v=Math.min(h,g)/2,y=l.getMappedValue(t,f),b=a?m+g/2:o+v,w=a?o-v:m+g/2;v-=.5,morpheus.CanvasUtil.drawShape(e,y,b,w,v)}e.lineWidth=p},renderHeatMap:function(e,t,r,n,i,o){this.isColumns;var a=this.positions;this.project,e.save(),e.lineWidth=1,i.width,i.height;for(var s=this.heatmap.getHeatMapElementComponent().getColorScheme(),l=this.heatmap.getHeatMapElementComponent().isDrawGrid(),u=this.heatmap.getHeatMapElementComponent().getGridColor(),c=this.heatmap.getHeatMapElementComponent().getGridThickness(),h=r;h<n;h++){var p=t.getValue(h);if(null!=p){for(var d=a.getPosition(h),f=a.getItemSize(h),m=p.length,g=o/m,v=0;v<m;v++){var y=p[v];e.fillStyle=s.getColor(h,-1,y),e.fillRect(v*g,d,g,f)}if(l&&f>10){for(e.strokeStyle=u,e.lineWidth=c,e.beginPath(),v=0;v<m;v++)y=p[v],e.rect(v*g,d,g,f);e.stroke()}}}e.restore()},renderArc:function(e,t,r,n,i,o){var a=this.isColumns,s=this.positions;this.project,e.save(),e.lineWidth=1,s.getPosition(s.getLength()-1),s.getItemSize(s.getLength()-1),e.translate(i.x,i.y),i.width,i.height;for(var l=r;l<n;l++){var u=t.getValue(l);if(null!=u)for(var c=s.getPosition(l)+s.getItemSize(l)/2,h=0,p=u.length;h<p;h++){var d=u[h],f=s.getPosition(d)+s.getItemSize(d)/2,m=(f+c)/2,g=(Math.abs(l-d),o);a?(e.beginPath(),e.moveTo(c,g),e.quadraticCurveTo(m,1,f,g)):(console.log(l,d,c,f),e.beginPath(),e.moveTo(1,c),e.quadraticCurveTo(g,m,1,f)),e.stroke()}}e.restore()},sdfToSvg:function(e,t,r){this.jsme||"undefined"==typeof JSApplet||(this.jsmeId=_.uniqueId("m"),this.$jsmeDiv=$('<div id="'+this.jsmeId+'" style="position:absolute;left:-10000px;top:-10000px;"></div>').appendTo($(document.body)),this.jsme=new JSApplet.JSME(this.jsmeId,"380px","340px",{})),this.jsme.readMolFile(e);var n=$("#"+this.jsmeId+" > div > div > div:nth-child(2) > svg"),i=n.width.baseVal.value,o=n.height.baseVal.value;return'<svg><g transform="scale('+Math.min(t/i,r/o)+')">'+n.innerHTML+"</g></svg>"},renderMolecule:function(e,t,r,n,i,o){this.isColumns;var a=this.positions;e.fillStyle=morpheus.CanvasUtil.FONT_COLOR,e.strokeStyle="black";for(var s=this.getUnscaledWidth(),l=void 0!==this.heatmap.options.structureUrlProvider,u={childNodes:[],getContext:function(){return e}},c=r;c<n;c++){var h=this.spanMap.get(c);if(void 0!==h){var p=a.getPosition(c),d=a.getPosition(h-1)+a.getSize()-p,f=t.getValue(c),m=this.moleculeCache[f];if(m)if(l){if(m.complete){var g=Math.min(d/m.height,s/m.width),v=m.width*g,y=m.height*g;p+=(m.height-y)/2;try{e.drawImage(m,o,p,v,y)}catch(e){}}}else{var b=this.sdfToSvg(m,s,d);canvg(u,b,{ignoreMouse:!0,ignoreAnimation:!0,offsetY:p,ignoreClear:!0,ignoreDimensions:!0})}}}},createChartScale:function(e){var t,r;return this.settings.mid!==this.settings.min&&this.settings.mid!==this.settings.max?(t=[this.settings.min,this.settings.mid,this.settings.max],r=this.isColumns?[e,e/2,0]:[0,e/2,e]):(t=[this.settings.min,this.settings.max],r=this.isColumns?[e,0]:[0,e]),d3.scale.linear().domain(t).range(r).clamp(!0)},renderBar:function(e,t,r,n,i,o,a){var s=this.isColumns,l=this.positions;e.fillStyle=this.settings.barColor;for(var u=this.createChartScale(a),c=u(this.settings.mid),h=(this.settings,t.getProperties().get(morpheus.VectorKeys.DISCRETE)&&null!=this.discreteValueMap),p=null!=this.settings.colorByField?this.getVector(this.settings.colorByField):null,d=s?this.project.getColumnColorModel():this.project.getRowColorModel(),f=r;f<n;f++){var m=t.getValue(f);h&&(m=this.discreteValueMap.get(m));var g=l.getPosition(f),v=l.getItemSize(f),y=u(m);null!==p&&(e.fillStyle=d.getMappedValue(p,p.getValue(f))),s?(e.beginPath(),e.rect(g,Math.min(c,y)+o,v,Math.abs(c-y)),e.fill()):(e.beginPath(),e.rect(o+Math.min(c,y),g,Math.abs(c-y),v),e.fill())}},renderBoxPlot:function(e,t,r,n,i,o,a){var s=this.isColumns,l=this.positions;e.strokeStyle="black",e.save(),e.translate(o,0);for(var u=this.createChartScale(a),c=t.getProperties().get(morpheus.VectorKeys.VISIBLE_FIELDS),h=(null!=this.settings.colorByField&&this.getVector(this.settings.colorByField),s?this.project.getColumnColorModel():this.project.getRowColorModel(),r);h<n;h++){var p=t.getValue(h);if(null!=p){var d=l.getItemSize(h);if(d<=3)continue;var f=l.getPosition(h),m=((r=f+1)+(n=f+d-1))/2,g=d-2,v=Math.max(2,g-8),y=p.summary;if(null==y){var b=morpheus.VectorUtil.arrayAsVector(p);y=morpheus.BoxPlotItem(null!=c?new morpheus.SlicedVector(b,c):b),p.summary=y}e.fillStyle="#bdbdbd",s||(e.fillRect(Math.min(u(y.q1),u(y.q3)),r,Math.abs(u(y.q1)-u(y.q3)),g),e.fillRect(Math.min(u(y.q1),u(y.lowerAdjacentValue)),m-v/2,Math.abs(u(y.q1)-u(y.lowerAdjacentValue)),v),e.fillRect(Math.min(u(y.q3),u(y.upperAdjacentValue)),m-v/2,Math.abs(u(y.q3)-u(y.upperAdjacentValue)),v),e.fillStyle="#31a354",e.fillRect(u(y.median)-3,r,3,n-r),e.fillStyle="#636363")}}e.restore()},renderStackedBar:function(e,t,r,n,i,o,a){var s=this.isColumns,l=this.positions,u=this.createChartScale(a),c=u(this.settings.mid),h=(this.settings,s?this.project.getColumnColorModel():this.project.getRowColorModel());e.strokeStyle="black",e.lineWidth=2;for(var p=r;p<n;p++){var d=t.getValue(p);if(null!=d){for(var f=l.getPosition(p),m=l.getItemSize(p),g=[],v=[],y=0,b=d.length;y<b;y++)(x=d[y])>=this.settings.mid?g.push({value:x,index:y}):x<0&&v.push({value:x,index:y});var w=morpheus.Util.indexSortPairs(g,!1);for(y=0,b=w.length;y<b;y++){var x=d[T=w[y]],_=h.getMappedValue(t,T);e.fillStyle=_;var S=u(x),C=y===b-1?c:u(d[w[y+1]]);s?(e.beginPath(),e.rect(f,Math.min(C,S),m,Math.abs(C-S)),e.fill()):(e.beginPath(),e.rect(o+Math.min(C,S),f,Math.abs(C-S),m),e.fill())}var M=morpheus.Util.indexSortPairs(v,!0);for(y=0,b=M.length;y<b;y++){var T;x=d[T=M[y]],_=h.getMappedValue(t,T),e.fillStyle=_,S=u(x),C=y===b-1?c:u(d[M[y+1]]),s?(e.beginPath(),e.rect(f,Math.min(C,S),m,Math.abs(C-S)),e.fill()):(e.beginPath(),e.rect(o+Math.min(C,S),f,Math.abs(C-S),m),e.fill())}}}e.lineWidth=1},renderUnstackedBar:function(e,t,r,n,i,o,a,s){var l=this.isColumns,u=this.positions,c=s.length,h=(this.settings,l?this.project.getColumnColorModel():this.project.getRowColorModel());e.fillStyle=this.settings.barColor;var p=(a-0*(c-1))/c,d=null!=this.settings.colorByField?this.getVector(this.settings.colorByField):null;e.strokeStyle="white";for(var f=r;f<n;f++){var m=t.getValue(f);if(null!=m)for(var g=u.getPosition(f),v=u.getItemSize(f),y=this.createChartScale(v-1),b=y(this.settings.mid),w=0,x=0;x<c;x++){var _=m[s[x]];if(null!=d){var S=d.getValue(f),C=h.getMappedValue(d,null!=S?S[s[x]]:null);e.fillStyle=C}var M=y(_);if(l)e.beginPath(),e.rect(Math.min(b,M),o+w,Math.abs(b-M),p),e.fill();else{e.beginPath();var T=Math.abs(b-M),A=g+v-Math.max(b,M);e.rect(o+w,A,p,T),e.fill()}w+=p+0}}},renderText:function(e,t,r,n,i,o,a,s,l){e.textBaseline="middle","undefined"!=typeof C2S&&e instanceof C2S&&e.translate(this.isColumns?2:0,this.isColumns?0:2);var u=this.positions,c=this.isColumns,h=c?this.project.getColumnColorModel():this.project.getRowColorModel(),p=c?this.project.getColumnFontModel():this.project.getRowFontModel();c&&e.translate(a.x,a.y);var d,f=null!=this.settings.colorByField?this.getVector(this.settings.colorByField):t;d=f.getProperties().get(morpheus.VectorKeys.DISCRETE)?_.bind(h.getMappedValue,h):_.bind(h.getContinuousMappedValue,h);for(var m=null!=this.settings.fontField?this.getVector(this.settings.fontField):t,g=morpheus.VectorTrack.vectorToString(t),v=e.font,y=i;y<o;y++){var b=this.positions.getItemSize(y);if(!(b<6)){var w=t.getValue(y);if(null!=w){var x=g(w),S=u.getPosition(y);r&&(e.fillStyle=d(f,f.getValue(y))),n&&(e.font=p.getMappedValue(m,m.getValue(y)).weight+" "+v),c?(e.save(),e.translate(S+b/2-a.x,s-a.y),e.rotate(-Math.PI/2),e.fillText(x,0,0),e.restore()):e.fillText(x,s,S+b/2)}}}e.font=v}},morpheus.Util.extend(morpheus.VectorTrack,morpheus.AbstractCanvas),morpheus.VectorTrack.MAX_FONT_SIZE=18,morpheus.AverageLinkage=function(e,t){var r,n,i,o,a;i=[],o=[],a=[];for(var s=0;s<e-1;s++)a[s]={left:0,right:0,distance:0};for(r=0;r<e;r++)o[r]=1,i[r]=r;var l={};for(n=e;n>1;n--){morpheus.HCluster.findClosestPair(n,t,l),a[e-n]={},a[e-n].distance=l.distance;var u=l.ip,c=l.jp;a[e-n].left=i[u],a[e-n].right=i[c];var h=o[u]+o[c];for(r=0;r<c;r++)t[c][r]=t[u][r]*o[u]+t[c][r]*o[c],t[c][r]/=h;for(r=c+1;r<u;r++)t[r][c]=t[u][r]*o[u]+t[r][c]*o[c],t[r][c]/=h;for(r=u+1;r<n;r++)t[r][c]=t[r][u]*o[u]+t[r][c]*o[c],t[r][c]/=h;for(r=0;r<u;r++)t[u][r]=t[n-1][r];for(r=u+1;r<n-1;r++)t[r][u]=t[n-1][r];o[c]=h,o[u]=o[n-1],i[c]=n-e-1,i[u]=i[n-1]}return a},morpheus.CollapseDataset=function(e,t,r,n,i){for(var o=[],a=0;a<t.length;a++){var s=e.getRowMetadata().getByName(t[a]);if(!s)throw t[a]+" not found. Available fields are "+morpheus.MetadataUtil.getMetadataNames(e.getRowMetadata());o.push(s)}var l,u=morpheus.VectorUtil.createValuesToIndicesMap(o),c=new morpheus.Dataset({name:e.getName(),rows:u.size(),columns:e.getColumnCount(),dataType:"Float32"});null!=i&&(l=c.addSeries({name:"percent"})),n?c.setColumnMetadata(e.getColumnMetadata()):morpheus.MetadataUtil.copy(e.getColumnMetadata(),c.getColumnMetadata());var h=t.length,p=[];for(a=0;a<h;a++)p.push(c.getRowMetadata().add(t[a]));var d=0;if(u.forEach(function(t,n){for(var a=new morpheus.SlicedDatasetView(e,t,null),s=new morpheus.DatasetColumnView(a),u=0,f=e.getColumnCount();u<f;u++){if(s.setIndex(u),null!=i){for(var m=0,g=0,v=s.size();g<v;g++)i(s.getValue(g))&&m++;c.setValue(d,u,m/s.size()*100,l)}c.setValue(d,u,r(s))}for(g=0;g<h;g++){var y=p[g],b=o[g];y.setValue(d,b.getValue(t[0]))}d++}),1===h){var f=p[0];o[0].getProperties().forEach(function(e,t){morpheus.VectorKeys.COPY_IGNORE.has(t)||f.properties.set(t,e)})}return c},morpheus.CompleteLinkage=function(e,t){for(var r,n,i=[],o=[],a=0;a<e-1;a++)o[a]={left:0,right:0,distance:0};for(r=0;r<e;r++)i[r]=r;var s={};for(n=e;n>1;n--){morpheus.HCluster.findClosestPair(n,t,s),o[e-n].distance=s.distance;var l=s.ip,u=s.jp;for(r=0;r<u;r++)t[u][r]=Math.max(t[l][r],t[u][r]);for(r=u+1;r<l;r++)t[r][u]=Math.max(t[l][r],t[r][u]);for(r=l+1;r<n;r++)t[r][u]=Math.max(t[r][l],t[r][u]);for(r=0;r<l;r++)t[l][r]=t[n-1][r];for(r=l+1;r<n-1;r++)t[r][l]=t[n-1][r];o[e-n].left=i[l],o[e-n].right=i[u],i[u]=n-e-1,i[l]=i[n-1]}return o},morpheus.HClusterGroupBy=function(e,t,r,n){e.getRowMetadata();var i=morpheus.MetadataUtil.getVectors(e.getRowMetadata(),t),o=morpheus.VectorUtil.createValuesToIndicesMap(i),a=[],s=0,l={id:-1,children:[],height:0},u={maxHeight:0,rootNode:l,leafNodes:[],nLeafNodes:0};o.forEach(function(t,i){for(var c,h=o.get(i),p=new morpheus.SlicedDatasetView(e,h,null),d=morpheus.HCluster.computeDistanceMatrix(p,r),f=(c=new morpheus.HCluster(d,n)).reorderedIndices,m=0,g=p.getRowCount();m<g;m++){var v=h[f[m]];a.push(v)}morpheus.DendrogramUtil.dfs(c.tree.rootNode,function(e){return e.index+=s,e.minIndex+=s,e.maxIndex+=s,e.id+=s,!0}),0===c.tree.leafNodes.length?u.leafNodes=u.leafNodes.concat([c.tree.rootNode]):u.leafNodes=u.leafNodes.concat(c.tree.leafNodes),l.children.push(c.tree.rootNode),isNaN(c.tree.maxHeight)||(u.maxHeight=Math.max(u.maxHeight,c.tree.maxHeight)),s+=p.getRowCount()}),u.nLeafNodes=u.leafNodes.length,u.rootNode.height=u.maxHeight,this.tree=u,this.reorderedIndices=a},morpheus.HCluster=function(e,t){var r=e.length,n=r-1;if(-1===n)return this.tree={maxHeight:0,rootNode:{id:0,height:0,index:0,minIndex:0,maxIndex:0,depth:0},leafNodes:[],nLeafNodes:0},void(this.reorderedIndices=[0]);for(var i=t(r,e),o=[],a=[],s=[],l=[],u=0;u<r;u++)s[u]=u;var c=[],h=[];for(u=0;u<n;u++){var p,d,f,m,g,v,y=i[u].left,b=i[u].right;if(l[u]=n+(u+2),y<0){var w=-y-1;p=o[w],f=a[w],g=l[w],i[u].distance=Math.max(i[u].distance,i[w].distance)}else p=s[y],f=1,g=y;if(b<0){var x=-b-1;d=o[x],m=a[x],v=l[x],i[u].distance=Math.max(i[u].distance,i[x].distance)}else d=s[b],m=1,v=b;c[u]=g,h[u]=v,a[u]=f+m,o[u]=(f*p+m*d)/(f+m)}for(var _=morpheus.HCluster.treeSort(n,s,o,a,i),S={},C=(u=0,_.length);u<C;u++)S[R=_[u]]=u;var M,T={};for(u=0,C=l.length;u<C;u++){var A=l[u],E=c[u],P=T[E];if(void 0===P){P={id:E};var R=S[E];P.index=R,P.minIndex=R,P.maxIndex=R,T[P.id]=P}var I=h[u],N=T[I];void 0===N&&(N={id:I},R=S[I],N.index=R,N.minIndex=R,N.maxIndex=R,T[N.id]=N),(M={id:A,children:P.index<N.index?[P,N]:[N,P],height:i[u].distance,index:(N.index+P.index)/2}).minIndex=Math.min(N.minIndex,P.minIndex),M.maxIndex=Math.max(N.maxIndex,P.maxIndex),P.parent=M,N.parent=M,T[M.id]=M}this.reorderedIndices=_;var D=[];for(u=0,C=_.length;u<C;u++){var k=T[_[u]];k.height=0,D.push(k)}morpheus.DendrogramUtil.setNodeDepths(M),this.tree={maxHeight:M.height,rootNode:M,leafNodes:D,nLeafNodes:D.length}},morpheus.HCluster.findClosestPair=function(e,t,r){var n,i,o,a=t[1][0],s=1,l=0;for(n=1;n<e;n++)for(i=0;i<n;i++)(o=t[n][i])<a&&(a=o,s=n,l=i);r.distance=a,r.ip=s,r.jp=l},morpheus.HCluster.computeDistanceMatrix=function(e,t){for(var r=[],n=e.getRowCount(),i=1;i<n;i++)r[i]=new Float32Array(i);if(0===t)for(i=1;i<n;i++)for(var o=0;o<i;o++)r[i][o]=e.getValue(i,o);else if(1===t){var a=-Number.MAX_VALUE;for(i=1;i<n;i++)for(o=0;o<i;o++){var s=e.getValue(i,o);isNaN(s)||(a=Math.max(s,a))}for(i=1;i<n;i++)for(o=0;o<i;o++)r[i][o]=a-e.getValue(i,o)}else{var l=new morpheus.DatasetRowView(e),u=new morpheus.DatasetRowView(e);for(i=1;i<n;i++)for(l.setIndex(i),o=0;o<i;o++)r[i][o]=t(l,u.setIndex(o))}return r},morpheus.HCluster.treeSort=function(e,t,r,n,i){var o,a=e+1,s=[],l=[];for(o=0;o<a;o++)l[o]=o,s[o]=0;for(o=0;o<e;o++){var u=i[o].left,c=i[o].right,h=u<0?r[-u-1]:t[u],p=c<0?r[-c-1]:t[c],d=u<0?n[-u-1]:1,f=c<0?n[-c-1]:1;if(u<c){var m=h<p?d:f;for(g=0;g<a;g++)(v=l[g])==u&&h>=p&&(s[g]+=m),v==c&&h<p&&(s[g]+=m),v!=u&&v!=c||(l[g]=-o-1)}else{var g;for(m=h<=p?d:f,g=0;g<a;g++){var v;(v=l[g])==u&&h>p&&(s[g]+=m),v==c&&h<=p&&(s[g]+=m),v!=u&&v!=c||(l[g]=-o-1)}}}return morpheus.Util.indexSort(s,!0)},morpheus.KMeansPlusPlusClusterer=function(e,t,r){var n=function(e,t){return r(e.getPoint(),t.getPoint())};function i(e){return 0|Math.floor(Math.random()*e)}function o(e){this.getPoint=function(){return e}}function a(e){var t=[];this.addPoint=function(e){t.push(e)},this.getPoints=function(){return t},this.getCenter=function(){return e}}function s(r){if(r.length<e)throw"Too many clusters";var o=function(t){for(var r=t,o=r.length,s=new Array(o),l=0;l<s.length;l++)s[l]=!1;var u=[],c=i(o),h=r[c];u.push(new a(h)),s[c]=!0;var p=new Float32Array(o);for(l=0;l<o;l++)if(l!==c){var d=n(h,r[l]);p[l]=d*d}for(;u.length<e;){var f=0;for(l=0;l<o;l++)s[l]||(f+=p[l]);var m=Math.random()*f,g=-1,v=0;for(l=0;l<o;l++)if(!s[l]&&(v+=p[l])>=m){g=l;break}if(-1===g)for(l=o-1;l>=0;l--)if(!s[l]){g=l;break}if(!(g>=0))break;var y=r[g];if(u.push(new a(y)),s[g]=!0,u.length<e)for(var b=0;b<o;b++)if(!s[b]){var w=(d=n(y,r[b]))*d;w<p[b]&&(p[b]=w)}}return u}(r),s=new Int32Array(r.length);l(o,r,s);for(var c=t<0?Number.MAX_VALUE:t,p=0;p<c;p++){for(var d=!1,f=[],m=0;m<o.length;m++){var g,v=o[m];0===v.getPoints().length?(g=u(o),d=!0):g=h(v.getPoints(),v.getCenter().getPoint().size()),f.push(new a(g))}if(o=f,0===l(f,r,s)&&!d)return o}return o}function l(e,t,r){for(var n=0,i=0,o=0;o<t.length;o++){var a=t[o],s=c(e,a);s!=r[i]&&n++,e[s].addPoint(a),r[i++]=s}return n}function u(e){for(var t=-Number.MAX_VALUE,r=null,o=0;o<e.length;o++){var a=e[o];if(a.getPoints().length>0){for(var s=a.getCenter(),l=a.getPoints(),u=new Float32Array(l.length),c=0;c<l.length;c++)u[c]=n(l[c],s);var h=morpheus.Variance(morpheus.VectorUtil.arrayAsVector(u));h>t&&(t=h,r=a)}}if(null==r)throw"All clusters are empty";var p=r.getPoints();return p.splice(i(p.length),1)}function c(e,t){for(var r=Number.MAX_VALUE,i=0,o=0,a=0;a<e.length;a++){var s=e[a],l=n(t,s.getCenter());l<r&&(r=l,o=i),i++}return o}function h(e,t){for(var r=new Float32Array(t),n=0;n<r.length;n++){for(var i=0,a=0,s=0;s<e.length;s++){var l=e[s].getPoint().getValue(n);isNaN(l)||(i+=l,a++)}r[n]=i/a}return new o(morpheus.VectorUtil.arrayAsVector(r))}this.execute=function(e){for(var t=[],r=e.length,n=0;n<r;n++){var i=new o(e[n]);i.i=n,t.push(i)}return s(t)},this.cluster=s},morpheus.PermutationPValues=function(e,t,r,n,i,o){var a,s,l=e.getRowCount(),u=new Float32Array(l);if(null!=t){var c=new morpheus.DatasetRowView(new morpheus.SlicedDatasetView(e,null,t)),h=new morpheus.DatasetRowView(new morpheus.SlicedDatasetView(e,null,r));e=new morpheus.SlicedDatasetView(e,null,t.concat(r)),a=new morpheus.UnbalancedPermuter(t.length,r.length),(s=new morpheus.TwoClassPermutationScore).init(e,i);for(var p=0;p<l;p++)u[p]=i(c.setIndex(p),h.setIndex(p))}else{a=new morpheus.UnbalancedContinuousPermuter(o.size()),(s=new morpheus.ContinuousPermutationScore(o)).init(e,i);var d=new morpheus.DatasetRowView(e);for(p=0;p<l;p++)u[p]=i(o,d.setIndex(p))}for(var f=new Float32Array(l),m=0;m<n;m++)for(s.setPermutation(a.next()),p=0;p<l;p++)s.getScore(p)>=u[p]&&f[p]++;var g=n,v=new Uint32Array(l);for(p=0;p<l;p++){var y,b=f[p];v[p]=b;var w=1-(y=(b+1)/(g+2));if(w<y&&(y=w),0==(y*=2)){for(var x=e.getValue(p,0),_=!0,S=1,C=e.getColumnCount();S<C&&_;S++)e.getValue(p,S)!=x&&(_=!1);_&&(y=1)}f[p]=y}this.rowSpecificPValues=f,this.k=v,this.fdr=morpheus.FDR_BH(f),this.scores=u},morpheus.PermutationPValues.prototype={getBonferroni:function(e){return Math.min(this.rowSpecificPValues[e]*this.numRows,1)}},morpheus.UnbalancedContinuousPermuter=function(e){for(var t=new Uint32Array(e),r=0;r<t.length;r++)t[r]=r;var n=t.length;this.next=function(){for(var e=n-1;e>=1;e--){var r=(0,o=e,Math.floor(Math.random()*(o-0+1))+0),i=t[r];t[r]=t[e],t[e]=i}var o;return t}},morpheus.UnbalancedPermuter=function(e,t){for(var r=new Uint32Array(e+t),n=new Uint32Array(e+t),i=0;i<n.length;i++)n[i]=i;var o=n.length;this.next=function(){for(var e=o-1;e>=1;e--){var i=(0,s=e,Math.floor(Math.random()*(s-0+1))+0),a=n[i];n[i]=n[e],n[e]=a}var s;for(e=0;e<o;e++)r[e]=0;for(e=0;e<t;e++)r[n[e]]=1;return r}},morpheus.TwoClassPermutationScore=function(){this.classZeroView=null,this.classOneView=null},morpheus.TwoClassPermutationScore.prototype={getScore:function(e){return this.classZeroView.setIndex(e),this.classOneView.setIndex(e),this.f(this.classZeroView,this.classOneView)},init:function(e,t){this.dataset=e,this.classZeroView=new morpheus.DatasetRowView(e),this.classOneView=new morpheus.DatasetRowView(e),this.f=t},setPermutation:function(e){for(var t=[],r=[],n=0,i=e.length;n<i;n++)0===e[n]?t.push(n):r.push(n);this.classZeroView.setDataset(new morpheus.SlicedDatasetView(this.dataset,null,t)),this.classOneView.setDataset(new morpheus.SlicedDatasetView(this.dataset,null,r))}},morpheus.ContinuousPermutationScore=function(e){this.referenceList=e},morpheus.ContinuousPermutationScore.prototype={getScore:function(e){return this.datasetRowView.setIndex(e),this.f(this.referenceListView,this.datasetRowView)},init:function(e,t){this.dataset=e,this.referenceListView=null,this.datasetRowView=new morpheus.DatasetRowView(e),this.f=t},setPermutation:function(e){this.referenceListView=new morpheus.SlicedVector(this.referenceList,e)}},morpheus.Ranking=function(e){for(var t=[],r=0,n=e.length;r<n;r++)t.push({value:e[r],position:r});if(0===t.length)return[];t.sort(function(e,t){return e.value<t.value?-1:e.value===t.value?0:1});var i=[],o=1;i[t[0].position]=o;var a=[];for(a.push(t[0].position),r=1;r<t.length;r++)t[r].value>t[r-1].value?(o=r+1,a.length>1&&morpheus.Ranking.fillAverage(i,a),(a=[]).push(t[r].position)):a.push(t[r].position),i[t[r].position]=o;return a.length>1&&morpheus.Ranking.fillAverage(i,a),i},morpheus.Ranking.fill=function(e,t,r){for(var n=0,i=t.length;n<i;n++)e[t[n]]=r},morpheus.Ranking.fillAverage=function(e,t){var r=e[t[0]],n=t.length;morpheus.Ranking.fill(e,t,(2*r+n-1)/2)},morpheus.SingleLinkage=function(e,t){var r,n,i,o=e-1,a=[],s=[],l=[],u=[];for(r=0;r<e;r++)u[r]={left:0,right:0,distance:0};for(r=0;r<o;r++)l[r]=r;for(r=0;r<e;r++){for(u[r].distance=Number.MAX_VALUE,n=0;n<r;n++)a[n]=t[r][n];for(n=0;n<r;n++)i=l[n],u[n].distance>=a[n]?(u[n].distance<a[i]&&(a[i]=u[n].distance),u[n].distance=a[n],l[n]=r):a[n]<a[i]&&(a[i]=a[n]);for(n=0;n<r;n++)u[n].distance>=u[l[n]].distance&&(l[n]=r)}for(r=0;r<o;r++)u[r].left=r;for(u.sort(function(e,t){var r=e.distance,n=t.distance;return r<n?-1:r>n?1:0}),r=0;r<e;r++)s[r]=r;for(r=0;r<o;r++)i=l[n=u[r].left],u[r].left=s[n],u[r].right=s[i],s[i]=-r-1;var c=[];for(r=0;r<e-1;r++)c[r]=u[r];return c},morpheus}(),__webpack_exports__.default=morpheus}.call(this,__webpack_require__("./node_modules/webpack/buildin/harmony-module.js")(module),__webpack_require__("./node_modules/webpack/buildin/global.js"),__webpack_require__("./node_modules/node-libs-browser/node_modules/process/browser.js"))},"./node_modules/ngl/dist/ngl.esm.js":function(e,t,r){"use strict";r.r(t),function(e,n){r.d(t,"Version",function(){return yC}),r.d(t,"StaticDatasource",function(){return hC}),r.d(t,"MdsrvDatasource",function(){return pC}),r.d(t,"Colormaker",function(){return Ts}),r.d(t,"Selection",function(){return el}),r.d(t,"PdbWriter",function(){return Wl}),r.d(t,"SdfWriter",function(){return ql}),r.d(t,"StlWriter",function(){return Yl}),r.d(t,"Stage",function(){return Xg}),r.d(t,"Collection",function(){return yg}),r.d(t,"ComponentCollection",function(){return $g}),r.d(t,"RepresentationCollection",function(){return wg}),r.d(t,"Assembly",function(){return Lf}),r.d(t,"TrajectoryPlayer",function(){return Ag}),r.d(t,"Superposition",function(){return Mg}),r.d(t,"Queue",function(){return Nc}),r.d(t,"Counter",function(){return Zl}),r.d(t,"BufferRepresentation",function(){return Fm}),r.d(t,"ArrowBuffer",function(){return fb}),r.d(t,"BoxBuffer",function(){return wb}),r.d(t,"ConeBuffer",function(){return hb}),r.d(t,"CylinderBuffer",function(){return cy}),r.d(t,"EllipsoidBuffer",function(){return Tb}),r.d(t,"OctahedronBuffer",function(){return Ib}),r.d(t,"SphereBuffer",function(){return Xm}),r.d(t,"TetrahedronBuffer",function(){return Fb}),r.d(t,"TextBuffer",function(){return $v}),r.d(t,"TorusBuffer",function(){return jb}),r.d(t,"Shape",function(){return km}),r.d(t,"Structure",function(){return Pm}),r.d(t,"Kdtree",function(){return Nf}),r.d(t,"SpatialHash",function(){return vh}),r.d(t,"MolecularSurface",function(){return $y}),r.d(t,"Volume",function(){return Pd}),r.d(t,"MouseActions",function(){return Wd}),r.d(t,"KeyActions",function(){return Yd}),r.d(t,"Debug",function(){return vl}),r.d(t,"setDebug",function(){return yl}),r.d(t,"ScriptExtensions",function(){return xl}),r.d(t,"ColormakerRegistry",function(){return Sl}),r.d(t,"DatasourceRegistry",function(){return Cl}),r.d(t,"DecompressorRegistry",function(){return El}),r.d(t,"ParserRegistry",function(){return Tl}),r.d(t,"RepresentationRegistry",function(){return Ml}),r.d(t,"setListingDatasource",function(){return Nl}),r.d(t,"setTrajectoryDatasource",function(){return Dl}),r.d(t,"ListingDatasource",function(){return bl}),r.d(t,"TrajectoryDatasource",function(){return wl}),r.d(t,"autoLoad",function(){return Hl}),r.d(t,"getDataInfo",function(){return jl}),r.d(t,"getFileInfo",function(){return zl}),r.d(t,"superpose",function(){return Vg}),r.d(t,"guessElement",function(){return em}),r.d(t,"flatten",function(){return Wa}),r.d(t,"throttle",function(){return Za}),r.d(t,"download",function(){return Ya}),r.d(t,"getQuery",function(){return ja}),r.d(t,"uniqueArray",function(){return ts}),r.d(t,"LeftMouseButton",function(){return $u}),r.d(t,"MiddleMouseButton",function(){return Gu}),r.d(t,"RightMouseButton",function(){return Wu}),r.d(t,"Signal",function(){return As}),r.d(t,"Matrix3",function(){return mt}),r.d(t,"Matrix4",function(){return pt}),r.d(t,"Vector2",function(){return ht}),r.d(t,"Vector3",function(){return ft}),r.d(t,"Box3",function(){return _r}),r.d(t,"Quaternion",function(){return dt}),r.d(t,"Euler",function(){return Er}),r.d(t,"Plane",function(){return Cr}),r.d(t,"Color",function(){return ur}),r.d(t,"UIStageParameters",function(){return vC}),"undefined"!=typeof window&&function(){window.console=window.console||{};for(var e,t,r=window.console,n={},i=function(){},o="memory".split(","),a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profiles,profileEnd,show,table,time,timeEnd,timeline,timelineEnd,timeStamp,trace,warn".split(",");e=o.pop();)r[e]||(r[e]=n);for(;t=a.pop();)r[t]||(r[t]=i)}(),void 0===window.HTMLCanvasElement||window.HTMLCanvasElement.prototype.toBlob||Object.defineProperty(window.HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,r){for(var n=window.atob(this.toDataURL(t,r).split(",")[1]),i=n.length,o=i>>2,a=new Uint8Array(i),s=new Uint32Array(a.buffer,0,o),l=0,u=0;l<o;l++)s[l]=n.charCodeAt(u++)|n.charCodeAt(u++)<<8|n.charCodeAt(u++)<<16|n.charCodeAt(u++)<<24;for(var c=3&i;c--;)a[u]=n.charCodeAt(u++);e(new window.Blob([a],{type:t||"image/png"}))}}),Math.cbrt=Math.cbrt||function(e){var t=Math.pow(Math.abs(e),1/3);return e<0?-t:t},Math.sign||(Math.sign=function(e){return 0===(e=+e)||isNaN(e)?Number(e):e>0?1:-1}),Number.isInteger||(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&e<9007199254740992&&Math.floor(e)===e}),Number.isNaN||(Number.isNaN=function(e){return e!=e}),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=arguments;if(void 0===e||null===e)throw new TypeError("Cannot convert first argument to object");for(var r,n=Object(e),i=!1,o=1;o<arguments.length;o++){var a=t[o];if(void 0!==a&&null!==a){for(var s=Object.keys(Object(a)),l=0,u=s.length;l<u;l++){var c=s[l];try{var h=Object.getOwnPropertyDescriptor(a,c);void 0!==h&&h.enumerable&&(n[c]=a[c])}catch(e){i||(i=!0,r=e)}}if(i)throw r}}return n}}),String.prototype.startsWith||
/*! https://mths.be/startswith v0.2.0 by @mathias */
function(){var e=function(){var e;try{var t={},r=Object.defineProperty;e=r(t,t,t)&&r}catch(e){}return e}(),t={}.toString,r=function(e){if(null===this)throw TypeError();var r=String(this);if(e&&"[object RegExp]"===t.call(e))throw TypeError();var n=r.length,i=String(e),o=i.length,a=arguments.length>1?arguments[1]:void 0,s=a?Number(a):0;Number.isNaN(s)&&(s=0);var l=Math.min(Math.max(s,0),n);if(o+l>n)return!1;for(var u=-1;++u<o;)if(r.charCodeAt(l+u)!==i.charCodeAt(u))return!1;return!0};e?e(String.prototype,"startsWith",{value:r,configurable:!0,writable:!0}):String.prototype.startsWith=r}(),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var r=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>r.length)&&(t=r.length),t-=e.length;var n=r.indexOf(e,t);return-1!==n&&n===t}),String.prototype.repeat||(String.prototype.repeat=function(e){if(null===this)throw new TypeError("can't convert "+this+" to object");var t=""+this;if(e=+e,Number.isNaN(e)&&(e=0),e<0)throw new RangeError("repeat count must be non-negative");if(e===1/0)throw new RangeError("repeat count must be less than infinity");if(e=Math.floor(e),0===t.length||0===e)return"";if(t.length*e>=1<<28)throw new RangeError("repeat count must not overflow maximum string size");for(var r="";1==(1&e)&&(r+=t),0!==(e>>>=1);)t+=t;return r}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),Array.prototype.includes||(Array.prototype.includes=function(e){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");var t=Object(this),r=parseInt(t.length,10)||0;if(0===r)return!1;var n,i,o=parseInt(arguments[1],10)||0;for(o>=0?n=o:(n=r+o)<0&&(n=0);n<r;){if(e===(i=t[n])||Number.isNaN(e)&&Number.isNaN(i))return!0;n++}return!1}),Array.from||(Array.from=function(){var e=Object.prototype.toString,t=function(t){return"function"==typeof t||"[object Function]"===e.call(t)},r=Math.pow(2,53)-1,n=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),r)};return function(e){var r=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var i,o=arguments.length>1?arguments[1]:void 0;if(void 0!==o){if(!t(o))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(i=arguments[2])}for(var a,s=n(r.length),l=t(this)?Object(new this(s)):new Array(s),u=0;u<s;)a=r[u],l[u]=o?void 0===i?o(a,u):o.call(i,a,u):a,u+=1;return l.length=s,l}}()),"undefined"!=typeof window&&function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var r=(new Date).getTime(),n=Math.max(0,16-(r-e)),i=window.setTimeout(function(){t(r+n)},n);return e=r+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),"undefined"!=typeof window&&(void 0===window.performance&&(self.performance={}),void 0===window.performance.now&&function(){var e=Date.now();window.performance.now=function(){return Date.now()-e}}());var i="undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function o(e,t){return e(t={exports:{}},t.exports),t.exports}var a=o(function(e){!function(t){var r=setTimeout;function i(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function a(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn(function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var n;try{n=r(e._value)}catch(e){return void l(t.promise,e)}s(t.promise,n)}else(1===e._state?s:l)(t.promise,e._value)})):e._deferreds.push(t)}function s(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof o)return e._state=3,e._value=t,void u(e);if("function"==typeof r)return void c(function(e,t){return function(){e.apply(t,arguments)}}(r,t),e)}e._state=1,e._value=t,u(e)}catch(t){l(e,t)}}function l(e,t){e._state=2,e._value=t,u(e)}function u(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,r=e._deferreds.length;t<r;t++)a(e,e._deferreds[t]);e._deferreds=null}function c(e,t){var r=!1;try{e(function(e){r||(r=!0,s(t,e))},function(e){r||(r=!0,l(t,e))})}catch(e){if(r)return;r=!0,l(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var r=new this.constructor(i);return a(this,new function(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}(e,t,r)),r},o.all=function(e){return new o(function(t,r){if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var n=Array.prototype.slice.call(e);if(0===n.length)return t([]);var i=n.length;function o(e,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(t){o(e,t)},r)}n[e]=a,0==--i&&t(n)}catch(e){r(e)}}for(var a=0;a<n.length;a++)o(a,n[a])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(e){return new o(function(t,r){r(e)})},o.race=function(e){return new o(function(t,r){for(var n=0,i=e.length;n<i;n++)e[n].then(t,r)})},o._immediateFn="function"==typeof n&&function(e){n(e)}||function(e){r(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},o._setImmediateFn=function(e){o._immediateFn=e},o._setUnhandledRejectionFn=function(e){o._unhandledRejectionFn=e},e.exports?e.exports=o:t.Promise||(t.Promise=o)}(i)});function s(){}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){var t=arguments;if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),n=1;n<arguments.length;n++){var i=t[n];if(void 0!==i&&null!==i)for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(r[o]=i[o])}return r}),Object.assign(s.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners[e];if(void 0!==r){var n=r.indexOf(t);-1!==n&&r.splice(n,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var r=t.slice(0),n=0,i=r.length;n<i;n++)r[n].call(this,e)}}}});var l="88",u=0,c=1,h=2,p=0,d=1,f=2,m=0,g=1,v=2,y=0,b=1,w=2,x=0,_=1,S=2,C=3,M=4,T=5,A=100,E=101,P=102,R=103,I=104,N=200,D=201,k=202,O=203,F=204,L=205,U=206,V=207,B=208,z=209,j=210,H=0,$=1,G=2,W=3,q=4,X=5,K=6,Y=7,Z=0,J=1,Q=2,ee=0,te=1,re=2,ne=3,ie=4,oe=301,ae=302,se=303,le=304,ue=305,ce=306,he=307,pe=1e3,de=1001,fe=1002,ge=1003,ve=1004,ye=1005,be=1006,we=1007,xe=1008,_e=1009,Se=1010,Ce=1011,Me=1012,Te=1013,Ae=1014,Ee=1015,Pe=1016,Re=1017,Ie=1018,Ne=1019,De=1020,ke=1021,Oe=1022,Fe=1023,Le=1024,Ue=1025,Ve=1026,Be=1027,ze=2001,je=2002,He=2003,$e=2004,Ge=2100,We=2101,qe=2102,Xe=2103,Ke=2151,Ye=2201,Ze=2400,Je=0,Qe=1,et=2,tt=3e3,rt=3001,nt=3007,it=3002,ot=3004,at=3005,st=3006,lt=3200,ut=3201,ct={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=0;return function(){for(var n="",i=0;i<36;i++)8===i||13===i||18===i||23===i?n+="-":14===i?n+="4":(r<=2&&(r=33554432+16777216*Math.random()|0),e=15&r,r>>=4,n+=t[19===i?3&e|8:e]);return n}}(),clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,n,i){return n+(e-t)*(i-n)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*ct.DEG2RAD},radToDeg:function(e){return e*ct.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}};function ht(e,t){this.x=e||0,this.y=t||0}function pt(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function dt(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==n?n:1}function ft(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}function mt(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}Object.defineProperties(ht.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(ht.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},applyMatrix3:function(e){var t=this.x,r=this.y,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6],this.y=n[1]*t+n[4]*r+n[7],this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e=new ht,t=new ht;return function(r,n){return e.set(r,r),t.set(n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var r=Math.cos(t),n=Math.sin(t),i=this.x-e.x,o=this.y-e.y;return this.x=i*r-o*n+e.x,this.y=i*n+o*r+e.y,this}}),Object.assign(pt.prototype,{isMatrix4:!0,set:function(e,t,r,n,i,o,a,s,l,u,c,h,p,d,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=n,g[1]=i,g[5]=o,g[9]=a,g[13]=s,g[2]=l,g[6]=u,g[10]=c,g[14]=h,g[3]=p,g[7]=d,g[11]=f,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new pt).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractBasis:function(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this},extractRotation:function(){var e=new ft;return function(t){var r=this.elements,n=t.elements,i=1/e.setFromMatrixColumn(t,0).length(),o=1/e.setFromMatrixColumn(t,1).length(),a=1/e.setFromMatrixColumn(t,2).length();return r[0]=n[0]*i,r[1]=n[1]*i,r[2]=n[2]*i,r[4]=n[4]*o,r[5]=n[5]*o,r[6]=n[6]*o,r[8]=n[8]*a,r[9]=n[9]*a,r[10]=n[10]*a,this}}(),makeRotationFromEuler:function(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,n=e.y,i=e.z,o=Math.cos(r),a=Math.sin(r),s=Math.cos(n),l=Math.sin(n),u=Math.cos(i),c=Math.sin(i);if("XYZ"===e.order){var h=o*u,p=o*c,d=a*u,f=a*c;t[0]=s*u,t[4]=-s*c,t[8]=l,t[1]=p+d*l,t[5]=h-f*l,t[9]=-a*s,t[2]=f-h*l,t[6]=d+p*l,t[10]=o*s}else if("YXZ"===e.order){var m=s*u,g=s*c,v=l*u,y=l*c;t[0]=m+y*a,t[4]=v*a-g,t[8]=o*l,t[1]=o*c,t[5]=o*u,t[9]=-a,t[2]=g*a-v,t[6]=y+m*a,t[10]=o*s}else if("ZXY"===e.order){m=s*u,g=s*c,v=l*u,y=l*c;t[0]=m-y*a,t[4]=-o*c,t[8]=v+g*a,t[1]=g+v*a,t[5]=o*u,t[9]=y-m*a,t[2]=-o*l,t[6]=a,t[10]=o*s}else if("ZYX"===e.order){h=o*u,p=o*c,d=a*u,f=a*c;t[0]=s*u,t[4]=d*l-p,t[8]=h*l+f,t[1]=s*c,t[5]=f*l+h,t[9]=p*l-d,t[2]=-l,t[6]=a*s,t[10]=o*s}else if("YZX"===e.order){var b=o*s,w=o*l,x=a*s,_=a*l;t[0]=s*u,t[4]=_-b*c,t[8]=x*c+w,t[1]=c,t[5]=o*u,t[9]=-a*u,t[2]=-l*u,t[6]=w*c+x,t[10]=b-_*c}else if("XZY"===e.order){b=o*s,w=o*l,x=a*s,_=a*l;t[0]=s*u,t[4]=-c,t[8]=l*u,t[1]=b*c+_,t[5]=o*u,t[9]=w*c-x,t[2]=x*c-w,t[6]=a*u,t[10]=_*c+b}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,r=e._x,n=e._y,i=e._z,o=e._w,a=r+r,s=n+n,l=i+i,u=r*a,c=r*s,h=r*l,p=n*s,d=n*l,f=i*l,m=o*a,g=o*s,v=o*l;return t[0]=1-(p+f),t[4]=c-v,t[8]=h+g,t[1]=c+v,t[5]=1-(u+f),t[9]=d-m,t[2]=h-g,t[6]=d+m,t[10]=1-(u+p),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e=new ft,t=new ft,r=new ft;return function(n,i,o){var a=this.elements;return r.subVectors(n,i),0===r.lengthSq()&&(r.z=1),r.normalize(),e.crossVectors(o,r),0===e.lengthSq()&&(1===Math.abs(o.z)?r.x+=1e-4:r.z+=1e-4,r.normalize(),e.crossVectors(o,r)),e.normalize(),t.crossVectors(r,e),a[0]=e.x,a[4]=t.x,a[8]=r.x,a[1]=e.y,a[5]=t.y,a[9]=r.y,a[2]=e.z,a[6]=t.z,a[10]=r.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,n=t.elements,i=this.elements,o=r[0],a=r[4],s=r[8],l=r[12],u=r[1],c=r[5],h=r[9],p=r[13],d=r[2],f=r[6],m=r[10],g=r[14],v=r[3],y=r[7],b=r[11],w=r[15],x=n[0],_=n[4],S=n[8],C=n[12],M=n[1],T=n[5],A=n[9],E=n[13],P=n[2],R=n[6],I=n[10],N=n[14],D=n[3],k=n[7],O=n[11],F=n[15];return i[0]=o*x+a*M+s*P+l*D,i[4]=o*_+a*T+s*R+l*k,i[8]=o*S+a*A+s*I+l*O,i[12]=o*C+a*E+s*N+l*F,i[1]=u*x+c*M+h*P+p*D,i[5]=u*_+c*T+h*R+p*k,i[9]=u*S+c*A+h*I+p*O,i[13]=u*C+c*E+h*N+p*F,i[2]=d*x+f*M+m*P+g*D,i[6]=d*_+f*T+m*R+g*k,i[10]=d*S+f*A+m*I+g*O,i[14]=d*C+f*E+m*N+g*F,i[3]=v*x+y*M+b*P+w*D,i[7]=v*_+y*T+b*R+w*k,i[11]=v*S+y*A+b*I+w*O,i[15]=v*C+y*E+b*N+w*F,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:function(){var e=new ft;return function(t){for(var r=0,n=t.count;r<n;r++)e.x=t.getX(r),e.y=t.getY(r),e.z=t.getZ(r),e.applyMatrix4(this),t.setXYZ(r,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],r=e[4],n=e[8],i=e[12],o=e[1],a=e[5],s=e[9],l=e[13],u=e[2],c=e[6],h=e[10],p=e[14];return e[3]*(+i*s*c-n*l*c-i*a*h+r*l*h+n*a*p-r*s*p)+e[7]*(+t*s*p-t*l*h+i*o*h-n*o*p+n*l*u-i*s*u)+e[11]*(+t*l*c-t*a*p-i*o*c+r*o*p+i*a*u-r*l*u)+e[15]*(-n*a*u-t*s*c+t*a*h+n*o*c-r*o*h+r*s*u)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,n=e.elements,i=n[0],o=n[1],a=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],p=n[8],d=n[9],f=n[10],m=n[11],g=n[12],v=n[13],y=n[14],b=n[15],w=d*y*h-v*f*h+v*c*m-u*y*m-d*c*b+u*f*b,x=g*f*h-p*y*h-g*c*m+l*y*m+p*c*b-l*f*b,_=p*v*h-g*d*h+g*u*m-l*v*m-p*u*b+l*d*b,S=g*d*c-p*v*c-g*u*f+l*v*f+p*u*y-l*d*y,C=i*w+o*x+a*_+s*S;if(0===C){var M="THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(M);return console.warn(M),this.identity()}var T=1/C;return r[0]=w*T,r[1]=(v*f*s-d*y*s-v*a*m+o*y*m+d*a*b-o*f*b)*T,r[2]=(u*y*s-v*c*s+v*a*h-o*y*h-u*a*b+o*c*b)*T,r[3]=(d*c*s-u*f*s-d*a*h+o*f*h+u*a*m-o*c*m)*T,r[4]=x*T,r[5]=(p*y*s-g*f*s+g*a*m-i*y*m-p*a*b+i*f*b)*T,r[6]=(g*c*s-l*y*s-g*a*h+i*y*h+l*a*b-i*c*b)*T,r[7]=(l*f*s-p*c*s+p*a*h-i*f*h-l*a*m+i*c*m)*T,r[8]=_*T,r[9]=(g*d*s-p*v*s-g*o*m+i*v*m+p*o*b-i*d*b)*T,r[10]=(l*v*s-g*u*s+g*o*h-i*v*h-l*o*b+i*u*b)*T,r[11]=(p*u*s-l*d*s-p*o*h+i*d*h+l*o*m-i*u*m)*T,r[12]=S*T,r[13]=(p*v*a-g*d*a+g*o*f-i*v*f-p*o*y+i*d*y)*T,r[14]=(g*u*a-l*v*a-g*o*c+i*v*c+l*o*y-i*u*y)*T,r[15]=(l*d*a-p*u*a+p*o*c-i*d*c-l*o*f+i*u*f)*T,this},scale:function(e){var t=this.elements,r=e.x,n=e.y,i=e.z;return t[0]*=r,t[4]*=n,t[8]*=i,t[1]*=r,t[5]*=n,t[9]*=i,t[2]*=r,t[6]*=n,t[10]*=i,t[3]*=r,t[7]*=n,t[11]*=i,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),n=Math.sin(t),i=1-r,o=e.x,a=e.y,s=e.z,l=i*o,u=i*a;return this.set(l*o+r,l*a-n*s,l*s+n*a,0,l*a+n*s,u*a+r,u*s-n*o,0,l*s-n*a,u*s+n*o,i*s*s+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},makeShear:function(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,r){return this.makeRotationFromQuaternion(t),this.scale(r),this.setPosition(e),this},decompose:function(){var e=new ft,t=new pt;return function(r,n,i){var o=this.elements,a=e.set(o[0],o[1],o[2]).length(),s=e.set(o[4],o[5],o[6]).length(),l=e.set(o[8],o[9],o[10]).length();this.determinant()<0&&(a=-a),r.x=o[12],r.y=o[13],r.z=o[14],t.copy(this);var u=1/a,c=1/s,h=1/l;return t.elements[0]*=u,t.elements[1]*=u,t.elements[2]*=u,t.elements[4]*=c,t.elements[5]*=c,t.elements[6]*=c,t.elements[8]*=h,t.elements[9]*=h,t.elements[10]*=h,n.setFromRotationMatrix(t),i.x=a,i.y=s,i.z=l,this}}(),makePerspective:function(e,t,r,n,i,o){void 0===o&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements,s=2*i/(t-e),l=2*i/(r-n),u=(t+e)/(t-e),c=(r+n)/(r-n),h=-(o+i)/(o-i),p=-2*o*i/(o-i);return a[0]=s,a[4]=0,a[8]=u,a[12]=0,a[1]=0,a[5]=l,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=h,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(e,t,r,n,i,o){var a=this.elements,s=1/(t-e),l=1/(r-n),u=1/(o-i),c=(t+e)*s,h=(r+n)*l,p=(o+i)*u;return a[0]=2*s,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-h,a[2]=0,a[6]=0,a[10]=-2*u,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(e){for(var t=this.elements,r=e.elements,n=0;n<16;n++)if(t[n]!==r[n])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}),Object.assign(dt,{slerp:function(e,t,r,n){return r.copy(e).slerp(t,n)},slerpFlat:function(e,t,r,n,i,o,a){var s=r[n+0],l=r[n+1],u=r[n+2],c=r[n+3],h=i[o+0],p=i[o+1],d=i[o+2],f=i[o+3];if(c!==f||s!==h||l!==p||u!==d){var m=1-a,g=s*h+l*p+u*d+c*f,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var b=Math.sqrt(y),w=Math.atan2(b,g*v);m=Math.sin(m*w)/b,a=Math.sin(a*w)/b}var x=a*v;if(s=s*m+h*x,l=l*m+p*x,u=u*m+d*x,c=c*m+f*x,m===1-a){var _=1/Math.sqrt(s*s+l*l+u*u+c*c);s*=_,l*=_,u*=_,c*=_}}e[t]=s,e[t+1]=l,e[t+2]=u,e[t+3]=c}}),Object.defineProperties(dt.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(dt.prototype,{set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,n=e._y,i=e._z,o=e.order,a=Math.cos,s=Math.sin,l=a(r/2),u=a(n/2),c=a(i/2),h=s(r/2),p=s(n/2),d=s(i/2);return"XYZ"===o?(this._x=h*u*c+l*p*d,this._y=l*p*c-h*u*d,this._z=l*u*d+h*p*c,this._w=l*u*c-h*p*d):"YXZ"===o?(this._x=h*u*c+l*p*d,this._y=l*p*c-h*u*d,this._z=l*u*d-h*p*c,this._w=l*u*c+h*p*d):"ZXY"===o?(this._x=h*u*c-l*p*d,this._y=l*p*c+h*u*d,this._z=l*u*d+h*p*c,this._w=l*u*c-h*p*d):"ZYX"===o?(this._x=h*u*c-l*p*d,this._y=l*p*c+h*u*d,this._z=l*u*d-h*p*c,this._w=l*u*c+h*p*d):"YZX"===o?(this._x=h*u*c+l*p*d,this._y=l*p*c+h*u*d,this._z=l*u*d-h*p*c,this._w=l*u*c-h*p*d):"XZY"===o&&(this._x=h*u*c-l*p*d,this._y=l*p*c-h*u*d,this._z=l*u*d+h*p*c,this._w=l*u*c+h*p*d),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var r=t/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,r=e.elements,n=r[0],i=r[4],o=r[8],a=r[1],s=r[5],l=r[9],u=r[2],c=r[6],h=r[10],p=n+s+h;return p>0?(t=.5/Math.sqrt(p+1),this._w=.25/t,this._x=(c-l)*t,this._y=(o-u)*t,this._z=(a-i)*t):n>s&&n>h?(t=2*Math.sqrt(1+n-s-h),this._w=(c-l)/t,this._x=.25*t,this._y=(i+a)/t,this._z=(o+u)/t):s>h?(t=2*Math.sqrt(1+s-n-h),this._w=(o-u)/t,this._x=(i+a)/t,this._y=.25*t,this._z=(l+c)/t):(t=2*Math.sqrt(1+h-n-s),this._w=(a-i)/t,this._x=(o+u)/t,this._y=(l+c)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new ft;return function(r,n){return void 0===t&&(t=new ft),(e=r.dot(n)+1)<1e-6?(e=0,Math.abs(r.x)>Math.abs(r.z)?t.set(-r.y,r.x,0):t.set(0,-r.z,r.y)):t.crossVectors(r,n),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var r=e._x,n=e._y,i=e._z,o=e._w,a=t._x,s=t._y,l=t._z,u=t._w;return this._x=r*u+o*a+n*l-i*s,this._y=n*u+o*s+i*a-r*l,this._z=i*u+o*l+r*s-n*a,this._w=o*u-r*a-n*s-i*l,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,n=this._y,i=this._z,o=this._w,a=o*e._w+r*e._x+n*e._y+i*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=r,this._y=n,this._z=i,this;var s=Math.sqrt(1-a*a);if(Math.abs(s)<.001)return this._w=.5*(o+this._w),this._x=.5*(r+this._x),this._y=.5*(n+this._y),this._z=.5*(i+this._z),this;var l=Math.atan2(s,a),u=Math.sin((1-t)*l)/s,c=Math.sin(t*l)/s;return this._w=o*u+this._w*c,this._x=r*u+this._x*c,this._y=n*u+this._y*c,this._z=i*u+this._z*c,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(ft.prototype,{isVector3:!0,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e=new dt;return function(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(e.setFromEuler(t))}}(),applyAxisAngle:function(){var e=new dt;return function(t,r){return this.applyQuaternion(e.setFromAxisAngle(t,r))}}(),applyMatrix3:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements,o=1/(i[3]*t+i[7]*r+i[11]*n+i[15]);return this.x=(i[0]*t+i[4]*r+i[8]*n+i[12])*o,this.y=(i[1]*t+i[5]*r+i[9]*n+i[13])*o,this.z=(i[2]*t+i[6]*r+i[10]*n+i[14])*o,this},applyQuaternion:function(e){var t=this.x,r=this.y,n=this.z,i=e.x,o=e.y,a=e.z,s=e.w,l=s*t+o*n-a*r,u=s*r+a*t-i*n,c=s*n+i*r-o*t,h=-i*t-o*r-a*n;return this.x=l*s+h*-i+u*-a-c*-o,this.y=u*s+h*-o+c*-i-l*-a,this.z=c*s+h*-a+l*-o-u*-i,this},project:function(){var e=new pt;return function(t){return e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyMatrix4(e)}}(),unproject:function(){var e=new pt;return function(t){return e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyMatrix4(e)}}(),transformDirection:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*n,this.y=i[1]*t+i[5]*r+i[9]*n,this.z=i[2]*t+i[6]*r+i[10]*n,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e=new ft,t=new ft;return function(r,n){return e.set(r,r,r),t.set(n,n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},cross:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)},crossVectors:function(e,t){var r=e.x,n=e.y,i=e.z,o=t.x,a=t.y,s=t.z;return this.x=n*s-i*a,this.y=i*o-r*s,this.z=r*a-n*o,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e=new ft;return function(t){return e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e=new ft;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(ct.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return t*t+r*r+n*n},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=n,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(mt.prototype,{isMatrix3:!0,set:function(e,t,r,n,i,o,a,s,l){var u=this.elements;return u[0]=e,u[1]=n,u[2]=a,u[3]=t,u[4]=i,u[5]=s,u[6]=r,u[7]=o,u[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new ft;return function(t){for(var r=0,n=t.count;r<n;r++)e.x=t.getX(r),e.y=t.getY(r),e.z=t.getZ(r),e.applyMatrix3(this),t.setXYZ(r,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,n=t.elements,i=this.elements,o=r[0],a=r[3],s=r[6],l=r[1],u=r[4],c=r[7],h=r[2],p=r[5],d=r[8],f=n[0],m=n[3],g=n[6],v=n[1],y=n[4],b=n[7],w=n[2],x=n[5],_=n[8];return i[0]=o*f+a*v+s*w,i[3]=o*m+a*y+s*x,i[6]=o*g+a*b+s*_,i[1]=l*f+u*v+c*w,i[4]=l*m+u*y+c*x,i[7]=l*g+u*b+c*_,i[2]=h*f+p*v+d*w,i[5]=h*m+p*y+d*x,i[8]=h*g+p*b+d*_,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],s=e[6],l=e[7],u=e[8];return t*o*u-t*a*l-r*i*u+r*a*s+n*i*l-n*o*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var r=e.elements,n=this.elements,i=r[0],o=r[1],a=r[2],s=r[3],l=r[4],u=r[5],c=r[6],h=r[7],p=r[8],d=p*l-u*h,f=u*c-p*s,m=h*s-l*c,g=i*d+o*f+a*m;if(0===g){var v="THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return n[0]=d*y,n[1]=(a*h-p*o)*y,n[2]=(u*o-a*l)*y,n[3]=f*y,n[4]=(p*i-a*c)*y,n[5]=(a*s-u*i)*y,n[6]=m*y,n[7]=(o*c-h*i)*y,n[8]=(l*i-o*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},setUvTransform:function(e,t,r,n,i,o,a){var s=Math.cos(i),l=Math.sin(i);this.set(r*s,r*l,-r*(s*o+l*a)+o+e,-n*l,n*s,-n*(-l*o+s*a)+a+t,0,0,1)},scale:function(e,t){var r=this.elements;return r[0]*=e,r[3]*=e,r[6]*=e,r[1]*=t,r[4]*=t,r[7]*=t,this},rotate:function(e){var t=Math.cos(e),r=Math.sin(e),n=this.elements,i=n[0],o=n[3],a=n[6],s=n[1],l=n[4],u=n[7];return n[0]=t*i+r*s,n[3]=t*o+r*l,n[6]=t*a+r*u,n[1]=-r*i+t*s,n[4]=-r*o+t*l,n[7]=-r*a+t*u,this},translate:function(e,t){var r=this.elements;return r[0]+=e*r[2],r[3]+=e*r[5],r[6]+=e*r[8],r[1]+=t*r[2],r[4]+=t*r[5],r[7]+=t*r[8],this},equals:function(e){for(var t=this.elements,r=e.elements,n=0;n<9;n++)if(t[n]!==r[n])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<9;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}});var gt=0;function vt(e,t,r,n,i,o,a,s,l,u){Object.defineProperty(this,"id",{value:gt++}),this.uuid=ct.generateUUID(),this.name="",this.image=void 0!==e?e:vt.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:vt.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:de,this.wrapT=void 0!==n?n:de,this.magFilter=void 0!==i?i:be,this.minFilter=void 0!==o?o:xe,this.anisotropy=void 0!==l?l:1,this.format=void 0!==a?a:Fe,this.type=void 0!==s?s:_e,this.offset=new ht(0,0),this.repeat=new ht(1,1),this.center=new ht(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new mt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==u?u:tt,this.version=0,this.onUpdate=null}function yt(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==n?n:1}function bt(e,t,r){this.uuid=ct.generateUUID(),this.width=e,this.height=t,this.scissor=new yt(0,0,e,t),this.scissorTest=!1,this.viewport=new yt(0,0,e,t),void 0===(r=r||{}).minFilter&&(r.minFilter=be),this.texture=new vt(void 0,void 0,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.encoding),this.depthBuffer=void 0===r.depthBuffer||r.depthBuffer,this.stencilBuffer=void 0===r.stencilBuffer||r.stencilBuffer,this.depthTexture=void 0!==r.depthTexture?r.depthTexture:null}function wt(e,t,r){bt.call(this,e,t,r),this.activeCubeFace=0,this.activeMipMapLevel=0}function xt(e,t,r,n,i,o,a,s,l,u,c,h){vt.call(this,null,o,a,s,l,u,n,i,c,h),this.image={data:e,width:t,height:r},this.magFilter=void 0!==l?l:ge,this.minFilter=void 0!==u?u:ge,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function _t(e,t,r,n,i,o,a,s,l,u){e=void 0!==e?e:[],t=void 0!==t?t:oe,vt.call(this,e,t,r,n,i,o,a,s,l,u),this.flipY=!1}vt.DEFAULT_IMAGE=void 0,vt.DEFAULT_MAPPING=300,Object.defineProperty(vt.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(vt.prototype,s.prototype,{constructor:vt,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){var t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];var r={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var n=this.image;void 0===n.uuid&&(n.uuid=ct.generateUUID()),t||void 0!==e.images[n.uuid]||(e.images[n.uuid]={uuid:n.uuid,url:function(e){var t;if(e instanceof HTMLCanvasElement)t=e;else{(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).width=e.width,t.height=e.height;var r=t.getContext("2d");e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height)}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(n)}),r.image=n.uuid}return t||(e.textures[this.uuid]=r),r},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case pe:e.x=e.x-Math.floor(e.x);break;case de:e.x=e.x<0?0:1;break;case fe:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case pe:e.y=e.y-Math.floor(e.y);break;case de:e.y=e.y<0?0:1;break;case fe:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}}),Object.assign(yt.prototype,{isVector4:!0,set:function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=this.w,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*n+o[12]*i,this.y=o[1]*t+o[5]*r+o[9]*n+o[13]*i,this.z=o[2]*t+o[6]*r+o[10]*n+o[14]*i,this.w=o[3]*t+o[7]*r+o[11]*n+o[15]*i,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,r,n,i,o=e.elements,a=o[0],s=o[4],l=o[8],u=o[1],c=o[5],h=o[9],p=o[2],d=o[6],f=o[10];if(Math.abs(s-u)<.01&&Math.abs(l-p)<.01&&Math.abs(h-d)<.01){if(Math.abs(s+u)<.1&&Math.abs(l+p)<.1&&Math.abs(h+d)<.1&&Math.abs(a+c+f-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(a+1)/2,g=(c+1)/2,v=(f+1)/2,y=(s+u)/4,b=(l+p)/4,w=(h+d)/4;return m>g&&m>v?m<.01?(r=0,n=.707106781,i=.707106781):(n=y/(r=Math.sqrt(m)),i=b/r):g>v?g<.01?(r=.707106781,n=0,i=.707106781):(r=y/(n=Math.sqrt(g)),i=w/n):v<.01?(r=.707106781,n=.707106781,i=0):(r=b/(i=Math.sqrt(v)),n=w/i),this.set(r,n,i,t),this}var x=Math.sqrt((d-h)*(d-h)+(l-p)*(l-p)+(u-s)*(u-s));return Math.abs(x)<.001&&(x=1),this.x=(d-h)/x,this.y=(l-p)/x,this.z=(u-s)/x,this.w=Math.acos((a+c+f-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e,t;return function(r,n){return void 0===e&&(e=new yt,t=new yt),e.set(r,r,r,r),t.set(n,n,n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(bt.prototype,s.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),wt.prototype=Object.create(bt.prototype),wt.prototype.constructor=wt,wt.prototype.isWebGLRenderTargetCube=!0,xt.prototype=Object.create(vt.prototype),xt.prototype.constructor=xt,xt.prototype.isDataTexture=!0,_t.prototype=Object.create(vt.prototype),_t.prototype.constructor=_t,_t.prototype.isCubeTexture=!0,Object.defineProperty(_t.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var St=new vt,Ct=new _t;function Mt(){this.seq=[],this.map={}}var Tt=[],At=[],Et=new Float32Array(16),Pt=new Float32Array(9);function Rt(e,t,r){var n=e[0];if(n<=0||n>0)return e;var i=t*r,o=Tt[i];if(void 0===o&&(o=new Float32Array(i),Tt[i]=o),0!==t){n.toArray(o,0);for(var a=1,s=0;a!==t;++a)s+=r,e[a].toArray(o,s)}return o}function It(e,t){var r=At[t];void 0===r&&(r=new Int32Array(t),At[t]=r);for(var n=0;n!==t;++n)r[n]=e.allocTextureUnit();return r}function Nt(e,t){e.uniform1f(this.addr,t)}function Dt(e,t){e.uniform1i(this.addr,t)}function kt(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function Ot(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function Ft(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function Lt(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function Ut(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(Pt.set(t.elements),e.uniformMatrix3fv(this.addr,!1,Pt))}function Vt(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(Et.set(t.elements),e.uniformMatrix4fv(this.addr,!1,Et))}function Bt(e,t,r){var n=r.allocTextureUnit();e.uniform1i(this.addr,n),r.setTexture2D(t||St,n)}function zt(e,t,r){var n=r.allocTextureUnit();e.uniform1i(this.addr,n),r.setTextureCube(t||Ct,n)}function jt(e,t){e.uniform2iv(this.addr,t)}function Ht(e,t){e.uniform3iv(this.addr,t)}function $t(e,t){e.uniform4iv(this.addr,t)}function Gt(e,t){e.uniform1fv(this.addr,t)}function Wt(e,t){e.uniform1iv(this.addr,t)}function qt(e,t){e.uniform2fv(this.addr,Rt(t,this.size,2))}function Xt(e,t){e.uniform3fv(this.addr,Rt(t,this.size,3))}function Kt(e,t){e.uniform4fv(this.addr,Rt(t,this.size,4))}function Yt(e,t){e.uniformMatrix2fv(this.addr,!1,Rt(t,this.size,4))}function Zt(e,t){e.uniformMatrix3fv(this.addr,!1,Rt(t,this.size,9))}function Jt(e,t){e.uniformMatrix4fv(this.addr,!1,Rt(t,this.size,16))}function Qt(e,t,r){var n=t.length,i=It(r,n);e.uniform1iv(this.addr,i);for(var o=0;o!==n;++o)r.setTexture2D(t[o]||St,i[o])}function er(e,t,r){var n=t.length,i=It(r,n);e.uniform1iv(this.addr,i);for(var o=0;o!==n;++o)r.setTextureCube(t[o]||Ct,i[o])}function tr(e,t,r){this.id=e,this.addr=r,this.setValue=function(e){switch(e){case 5126:return Nt;case 35664:return kt;case 35665:return Ot;case 35666:return Ft;case 35674:return Lt;case 35675:return Ut;case 35676:return Vt;case 35678:case 36198:return Bt;case 35680:return zt;case 5124:case 35670:return Dt;case 35667:case 35671:return jt;case 35668:case 35672:return Ht;case 35669:case 35673:return $t}}(t.type)}function rr(e,t,r){this.id=e,this.addr=r,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Gt;case 35664:return qt;case 35665:return Xt;case 35666:return Kt;case 35674:return Yt;case 35675:return Zt;case 35676:return Jt;case 35678:return Qt;case 35680:return er;case 5124:case 35670:return Wt;case 35667:case 35671:return jt;case 35668:case 35672:return Ht;case 35669:case 35673:return $t}}(t.type)}function nr(e){this.id=e,Mt.call(this)}nr.prototype.setValue=function(e,t){for(var r=this.seq,n=0,i=r.length;n!==i;++n){var o=r[n];o.setValue(e,t[o.id])}};var ir=/([\w\d_]+)(\])?(\[|\.)?/g;function or(e,t){e.seq.push(t),e.map[t.id]=t}function ar(e,t,r){var n=e.name,i=n.length;for(ir.lastIndex=0;;){var o=ir.exec(n),a=ir.lastIndex,s=o[1],l="]"===o[2],u=o[3];if(l&&(s|=0),void 0===u||"["===u&&a+2===i){or(r,void 0===u?new tr(s,e,t):new rr(s,e,t));break}var c=r.map[s];void 0===c&&or(r,c=new nr(s)),r=c}}function sr(e,t,r){Mt.call(this),this.renderer=r;for(var n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var o=e.getActiveUniform(t,i),a=o.name;ar(o,e.getUniformLocation(t,a),this)}}sr.prototype.setValue=function(e,t,r){var n=this.map[t];void 0!==n&&n.setValue(e,r,this.renderer)},sr.prototype.setOptional=function(e,t,r){var n=t[r];void 0!==n&&this.setValue(e,r,n)},sr.upload=function(e,t,r,n){for(var i=0,o=t.length;i!==o;++i){var a=t[i],s=r[a.id];!1!==s.needsUpdate&&a.setValue(e,s.value,n)}},sr.seqWithValue=function(e,t){for(var r=[],n=0,i=e.length;n!==i;++n){var o=e[n];o.id in t&&r.push(o)}return r};var lr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function ur(e,t,r){return void 0===t&&void 0===r?this.set(e):this.setRGB(e,t,r)}Object.assign(ur.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(){function e(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}return function(t,r,n){if(t=ct.euclideanModulo(t,1),r=ct.clamp(r,0,1),n=ct.clamp(n,0,1),0===r)this.r=this.g=this.b=n;else{var i=n<=.5?n*(1+r):n+r-n*r,o=2*n-i;this.r=e(o,i,t+1/3),this.g=e(o,i,t),this.b=e(o,i,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var r;if(r=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var n,i=r[1],o=r[2];switch(i){case"rgb":case"rgba":if(n=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(255,parseInt(n[1],10))/255,this.g=Math.min(255,parseInt(n[2],10))/255,this.b=Math.min(255,parseInt(n[3],10))/255,t(n[5]),this;if(n=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(100,parseInt(n[1],10))/100,this.g=Math.min(100,parseInt(n[2],10))/100,this.b=Math.min(100,parseInt(n[3],10))/100,t(n[5]),this;break;case"hsl":case"hsla":if(n=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o)){var a=parseFloat(n[1])/360,s=parseInt(n[2],10)/100,l=parseInt(n[3],10)/100;return t(n[5]),this.setHSL(a,s,l)}}}else if(r=/^\#([A-Fa-f0-9]+)$/.exec(e)){var u,c=(u=r[1]).length;if(3===c)return this.r=parseInt(u.charAt(0)+u.charAt(0),16)/255,this.g=parseInt(u.charAt(1)+u.charAt(1),16)/255,this.b=parseInt(u.charAt(2)+u.charAt(2),16)/255,this;if(6===c)return this.r=parseInt(u.charAt(0)+u.charAt(1),16)/255,this.g=parseInt(u.charAt(2)+u.charAt(3),16)/255,this.b=parseInt(u.charAt(4)+u.charAt(5),16)/255,this}e&&e.length>0&&(void 0!==(u=lr[e])?this.setHex(u):console.warn("THREE.Color: Unknown color "+e));return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var r=t>0?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,r,n=e||{h:0,s:0,l:0},i=this.r,o=this.g,a=this.b,s=Math.max(i,o,a),l=Math.min(i,o,a),u=(l+s)/2;if(l===s)t=0,r=0;else{var c=s-l;switch(r=u<=.5?c/(s+l):c/(2-s-l),s){case i:t=(o-a)/c+(o<a?6:0);break;case o:t=(a-i)/c+2;break;case a:t=(i-o)/c+4}t/=6}return n.h=t,n.s=r,n.l=u,n},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,r){var n=this.getHSL();return n.h+=e,n.s+=t,n.l+=r,this.setHSL(n.h,n.s,n.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var cr={common:{diffuse:{value:new ur(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new mt},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new ht(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ur(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new ur(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},uvTransform:{value:new mt}}},hr={merge:function(e){for(var t={},r=0;r<e.length;r++){var n=this.clone(e[r]);for(var i in n)t[i]=n[i]}return t},clone:function(e){var t={};for(var r in e)for(var n in t[r]={},e[r]){var i=e[r][n];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture)?t[r][n]=i.clone():Array.isArray(i)?t[r][n]=i.slice():t[r][n]=i}return t}},pr={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"vec3 transformedNormal = normalMatrix * objectNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\treflectVec = normalize( reflectVec );\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\treflectVec = normalize( reflectVec );\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\tgl_Position.z *= gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#ifndef saturate\n\t#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}\n",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <fog_fragment>\n}\n",shadow_vert:"#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n"},dr={basic:{uniforms:hr.merge([cr.common,cr.specularmap,cr.envmap,cr.aomap,cr.lightmap,cr.fog]),vertexShader:pr.meshbasic_vert,fragmentShader:pr.meshbasic_frag},lambert:{uniforms:hr.merge([cr.common,cr.specularmap,cr.envmap,cr.aomap,cr.lightmap,cr.emissivemap,cr.fog,cr.lights,{emissive:{value:new ur(0)}}]),vertexShader:pr.meshlambert_vert,fragmentShader:pr.meshlambert_frag},phong:{uniforms:hr.merge([cr.common,cr.specularmap,cr.envmap,cr.aomap,cr.lightmap,cr.emissivemap,cr.bumpmap,cr.normalmap,cr.displacementmap,cr.gradientmap,cr.fog,cr.lights,{emissive:{value:new ur(0)},specular:{value:new ur(1118481)},shininess:{value:30}}]),vertexShader:pr.meshphong_vert,fragmentShader:pr.meshphong_frag},standard:{uniforms:hr.merge([cr.common,cr.envmap,cr.aomap,cr.lightmap,cr.emissivemap,cr.bumpmap,cr.normalmap,cr.displacementmap,cr.roughnessmap,cr.metalnessmap,cr.fog,cr.lights,{emissive:{value:new ur(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:pr.meshphysical_vert,fragmentShader:pr.meshphysical_frag},points:{uniforms:hr.merge([cr.points,cr.fog]),vertexShader:pr.points_vert,fragmentShader:pr.points_frag},dashed:{uniforms:hr.merge([cr.common,cr.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:pr.linedashed_vert,fragmentShader:pr.linedashed_frag},depth:{uniforms:hr.merge([cr.common,cr.displacementmap]),vertexShader:pr.depth_vert,fragmentShader:pr.depth_frag},normal:{uniforms:hr.merge([cr.common,cr.bumpmap,cr.normalmap,cr.displacementmap,{opacity:{value:1}}]),vertexShader:pr.normal_vert,fragmentShader:pr.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:pr.cube_vert,fragmentShader:pr.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:pr.equirect_vert,fragmentShader:pr.equirect_frag},distanceRGBA:{uniforms:hr.merge([cr.common,cr.displacementmap,{referencePosition:{value:new ft},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:pr.distanceRGBA_vert,fragmentShader:pr.distanceRGBA_frag},shadow:{uniforms:hr.merge([cr.lights,cr.fog,{color:{value:new ur(0)},opacity:{value:1}}]),vertexShader:pr.shadow_vert,fragmentShader:pr.shadow_frag}};function fr(e,t){this.min=void 0!==e?e:new ht(1/0,1/0),this.max=void 0!==t?t:new ht(-1/0,-1/0)}function mr(e,t,r,n,i){var o,a,s,l,u,c,h,p;function d(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),n=new Uint16Array([0,1,2,0,2,3]);o=t.createBuffer(),a=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW),h=t.createTexture(),p=t.createTexture(),r.bindTexture(t.TEXTURE_2D,h),t.texImage2D(t.TEXTURE_2D,0,t.RGB,16,16,0,t.RGB,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),r.bindTexture(t.TEXTURE_2D,p),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,16,16,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),s={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvUV = uv;","\tvec2 pos = position;","\tif ( renderType == 2 ) {","\t\tvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","\t\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","\t\tvVisibility =        visibility.r / 9.0;","\t\tvVisibility *= 1.0 - visibility.g / 9.0;","\t\tvVisibility *=       visibility.b / 9.0;","\t\tvVisibility *= 1.0 - visibility.a / 9.0;","\t\tpos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","\t\tpos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","\t}","\tgl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tif ( renderType == 0 ) {","\t\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","\t} else if ( renderType == 1 ) {","\t\tgl_FragColor = texture2D( map, vUV );","\t} else {","\t\tvec4 texture = texture2D( map, vUV );","\t\ttexture.a *= opacity * vVisibility;","\t\tgl_FragColor = texture;","\t\tgl_FragColor.rgb *= color;","\t}","}"].join("\n")},l=function(e){var r=t.createProgram(),n=t.createShader(t.FRAGMENT_SHADER),o=t.createShader(t.VERTEX_SHADER),a="precision "+i.precision+" float;\n";return t.shaderSource(n,a+e.fragmentShader),t.shaderSource(o,a+e.vertexShader),t.compileShader(n),t.compileShader(o),t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r),r}(s),u={vertex:t.getAttribLocation(l,"position"),uv:t.getAttribLocation(l,"uv")},c={renderType:t.getUniformLocation(l,"renderType"),map:t.getUniformLocation(l,"map"),occlusionMap:t.getUniformLocation(l,"occlusionMap"),opacity:t.getUniformLocation(l,"opacity"),color:t.getUniformLocation(l,"color"),scale:t.getUniformLocation(l,"scale"),rotation:t.getUniformLocation(l,"rotation"),screenPosition:t.getUniformLocation(l,"screenPosition")}}this.render=function(e,i,s,f){if(0!==e.length){var m=new ft,g=f.w/f.z,v=.5*f.z,y=.5*f.w,b=16/f.w,w=new ht(b*g,b),x=new ft(1,1,0),_=new ht(1,1),S=new fr;S.min.set(f.x,f.y),S.max.set(f.x+(f.z-16),f.y+(f.w-16)),void 0===l&&d(),r.useProgram(l),r.initAttributes(),r.enableAttribute(u.vertex),r.enableAttribute(u.uv),r.disableUnusedAttributes(),t.uniform1i(c.occlusionMap,0),t.uniform1i(c.map,1),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(u.vertex,2,t.FLOAT,!1,16,0),t.vertexAttribPointer(u.uv,2,t.FLOAT,!1,16,8),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),r.disable(t.CULL_FACE),r.buffers.depth.setMask(!1);for(var C=0,M=e.length;C<M;C++){b=16/f.w,w.set(b*g,b);var T=e[C];if(m.set(T.matrixWorld.elements[12],T.matrixWorld.elements[13],T.matrixWorld.elements[14]),m.applyMatrix4(s.matrixWorldInverse),m.applyMatrix4(s.projectionMatrix),x.copy(m),_.x=f.x+x.x*v+v-8,_.y=f.y+x.y*y+y-8,!0===S.containsPoint(_)){r.activeTexture(t.TEXTURE0),r.bindTexture(t.TEXTURE_2D,null),r.activeTexture(t.TEXTURE1),r.bindTexture(t.TEXTURE_2D,h),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGB,_.x,_.y,16,16,0),t.uniform1i(c.renderType,0),t.uniform2f(c.scale,w.x,w.y),t.uniform3f(c.screenPosition,x.x,x.y,x.z),r.disable(t.BLEND),r.enable(t.DEPTH_TEST),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),r.activeTexture(t.TEXTURE0),r.bindTexture(t.TEXTURE_2D,p),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,_.x,_.y,16,16,0),t.uniform1i(c.renderType,1),r.disable(t.DEPTH_TEST),r.activeTexture(t.TEXTURE1),r.bindTexture(t.TEXTURE_2D,h),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),T.positionScreen.copy(x),T.customUpdateCallback?T.customUpdateCallback(T):T.updateLensFlares(),t.uniform1i(c.renderType,2),r.enable(t.BLEND);for(var A=0,E=T.lensFlares.length;A<E;A++){var P=T.lensFlares[A];P.opacity>.001&&P.scale>.001&&(x.x=P.x,x.y=P.y,x.z=P.z,b=P.size*P.scale/f.w,w.x=b*g,w.y=b,t.uniform3f(c.screenPosition,x.x,x.y,x.z),t.uniform2f(c.scale,w.x,w.y),t.uniform1f(c.rotation,P.rotation),t.uniform1f(c.opacity,P.opacity),t.uniform3f(c.color,P.color.r,P.color.g,P.color.b),r.setBlending(P.blending,P.blendEquation,P.blendSrc,P.blendDst),n.setTexture2D(P.texture,1),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0))}}}r.enable(t.CULL_FACE),r.enable(t.DEPTH_TEST),r.buffers.depth.setMask(!0),r.reset()}}}function gr(e,t,r,n,i,o,a,s,l){vt.call(this,e,t,r,n,i,o,a,s,l),this.needsUpdate=!0}function vr(e,t,r,n,i){var o,a,s,l,u,c,h=new ft,p=new dt,d=new ft;function f(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),r=new Uint16Array([0,1,2,0,2,3]);o=t.createBuffer(),a=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t.STATIC_DRAW),s=function(){var e=t.createProgram(),r=t.createShader(t.VERTEX_SHADER),n=t.createShader(t.FRAGMENT_SHADER);return t.shaderSource(r,["precision "+i.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvUV = uvOffset + uv * uvScale;","\tvec2 alignedPosition = position * scale;","\tvec2 rotatedPosition;","\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","\tvec4 mvPosition;","\tmvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","\tmvPosition.xy += rotatedPosition;","\tgl_Position = projectionMatrix * mvPosition;","\tfogDepth = - mvPosition.z;","}"].join("\n")),t.shaderSource(n,["precision "+i.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvec4 texture = texture2D( map, vUV );","\tgl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","\tif ( gl_FragColor.a < alphaTest ) discard;","\tif ( fogType > 0 ) {","\t\tfloat fogFactor = 0.0;","\t\tif ( fogType == 1 ) {","\t\t\tfogFactor = smoothstep( fogNear, fogFar, fogDepth );","\t\t} else {","\t\t\tconst float LOG2 = 1.442695;","\t\t\tfogFactor = exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 );","\t\t\tfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","\t\t}","\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","\t}","}"].join("\n")),t.compileShader(r),t.compileShader(n),t.attachShader(e,r),t.attachShader(e,n),t.linkProgram(e),e}(),l={position:t.getAttribLocation(s,"position"),uv:t.getAttribLocation(s,"uv")},u={uvOffset:t.getUniformLocation(s,"uvOffset"),uvScale:t.getUniformLocation(s,"uvScale"),rotation:t.getUniformLocation(s,"rotation"),scale:t.getUniformLocation(s,"scale"),color:t.getUniformLocation(s,"color"),map:t.getUniformLocation(s,"map"),opacity:t.getUniformLocation(s,"opacity"),modelViewMatrix:t.getUniformLocation(s,"modelViewMatrix"),projectionMatrix:t.getUniformLocation(s,"projectionMatrix"),fogType:t.getUniformLocation(s,"fogType"),fogDensity:t.getUniformLocation(s,"fogDensity"),fogNear:t.getUniformLocation(s,"fogNear"),fogFar:t.getUniformLocation(s,"fogFar"),fogColor:t.getUniformLocation(s,"fogColor"),fogDepth:t.getUniformLocation(s,"fogDepth"),alphaTest:t.getUniformLocation(s,"alphaTest")};var n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");n.width=8,n.height=8;var h=n.getContext("2d");h.fillStyle="white",h.fillRect(0,0,8,8),c=new gr(n)}function m(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}this.render=function(i,g,v){if(0!==i.length){void 0===s&&f(),r.useProgram(s),r.initAttributes(),r.enableAttribute(l.position),r.enableAttribute(l.uv),r.disableUnusedAttributes(),r.disable(t.CULL_FACE),r.enable(t.BLEND),t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribPointer(l.position,2,t.FLOAT,!1,16,0),t.vertexAttribPointer(l.uv,2,t.FLOAT,!1,16,8),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.uniformMatrix4fv(u.projectionMatrix,!1,v.projectionMatrix.elements),r.activeTexture(t.TEXTURE0),t.uniform1i(u.map,0);var y=0,b=0,w=g.fog;w?(t.uniform3f(u.fogColor,w.color.r,w.color.g,w.color.b),w.isFog?(t.uniform1f(u.fogNear,w.near),t.uniform1f(u.fogFar,w.far),t.uniform1i(u.fogType,1),y=1,b=1):w.isFogExp2&&(t.uniform1f(u.fogDensity,w.density),t.uniform1i(u.fogType,2),y=2,b=2)):(t.uniform1i(u.fogType,0),y=0,b=0);for(var x=0,_=i.length;x<_;x++){(C=i[x]).modelViewMatrix.multiplyMatrices(v.matrixWorldInverse,C.matrixWorld),C.z=-C.modelViewMatrix.elements[14]}i.sort(m);var S=[];for(x=0,_=i.length;x<_;x++){var C,M=(C=i[x]).material;if(!1!==M.visible){C.onBeforeRender(e,g,v,void 0,M,void 0),t.uniform1f(u.alphaTest,M.alphaTest),t.uniformMatrix4fv(u.modelViewMatrix,!1,C.modelViewMatrix.elements),C.matrixWorld.decompose(h,p,d),S[0]=d.x,S[1]=d.y;var T=0;g.fog&&M.fog&&(T=b),y!==T&&(t.uniform1i(u.fogType,T),y=T),null!==M.map?(t.uniform2f(u.uvOffset,M.map.offset.x,M.map.offset.y),t.uniform2f(u.uvScale,M.map.repeat.x,M.map.repeat.y)):(t.uniform2f(u.uvOffset,0,0),t.uniform2f(u.uvScale,1,1)),t.uniform1f(u.opacity,M.opacity),t.uniform3f(u.color,M.color.r,M.color.g,M.color.b),t.uniform1f(u.rotation,M.rotation),t.uniform2fv(u.scale,S),r.setBlending(M.blending,M.blendEquation,M.blendSrc,M.blendDst,M.blendEquationAlpha,M.blendSrcAlpha,M.blendDstAlpha,M.premultipliedAlpha),r.buffers.depth.setTest(M.depthTest),r.buffers.depth.setMask(M.depthWrite),r.buffers.color.setMask(M.colorWrite),n.setTexture2D(M.map||c,0),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),C.onAfterRender(e,g,v,void 0,M,void 0)}}r.enable(t.CULL_FACE),r.reset()}}}dr.physical={uniforms:hr.merge([dr.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:pr.meshphysical_vert,fragmentShader:pr.meshphysical_frag},Object.assign(fr.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new ht;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new ht;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new ht;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new ht).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new ht).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new ht;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),gr.prototype=Object.create(vt.prototype),gr.prototype.constructor=gr;var yr=0;function br(){Object.defineProperty(this,"id",{value:yr++}),this.uuid=ct.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=_,this.side=m,this.flatShading=!1,this.vertexColors=y,this.opacity=1,this.transparent=!1,this.blendSrc=F,this.blendDst=L,this.blendEquation=A,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=W,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.userData={},this.needsUpdate=!0}function wr(e){br.call(this),this.type="MeshDepthMaterial",this.depthPacking=lt,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function xr(e){br.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new ft,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.lights=!1,this.setValues(e)}function _r(e,t){this.min=void 0!==e?e:new ft(1/0,1/0,1/0),this.max=void 0!==t?t:new ft(-1/0,-1/0,-1/0)}function Sr(e,t){this.center=void 0!==e?e:new ft,this.radius=void 0!==t?t:0}function Cr(e,t){this.normal=void 0!==e?e:new ft(1,0,0),this.constant=void 0!==t?t:0}function Mr(e,t,r,n,i,o){this.planes=[void 0!==e?e:new Cr,void 0!==t?t:new Cr,void 0!==r?r:new Cr,void 0!==n?n:new Cr,void 0!==i?i:new Cr,void 0!==o?o:new Cr]}function Tr(e,t,r){for(var n=new Mr,i=new pt,o=new ht,a=new ht(r,r),s=new ft,l=new ft,u=1,c=2,h=1+(u|c),p=new Array(h),f=new Array(h),y={},b=[new ft(1,0,0),new ft(-1,0,0),new ft(0,0,1),new ft(0,0,-1),new ft(0,1,0),new ft(0,-1,0)],w=[new ft(0,1,0),new ft(0,1,0),new ft(0,1,0),new ft(0,1,0),new ft(0,0,1),new ft(0,0,-1)],x=[new yt,new yt,new yt,new yt,new yt,new yt],_=0;_!==h;++_){var S=0!=(_&u),C=0!=(_&c),M=new wr({depthPacking:ut,morphTargets:S,skinning:C});p[_]=M;var T=new xr({morphTargets:S,skinning:C});f[_]=T}var A=this;function E(t,r,n,i,o,a){var s=t.geometry,l=null,h=p,d=t.customDepthMaterial;if(n&&(h=f,d=t.customDistanceMaterial),d)l=d;else{var b=!1;r.morphTargets&&(s&&s.isBufferGeometry?b=s.morphAttributes&&s.morphAttributes.position&&s.morphAttributes.position.length>0:s&&s.isGeometry&&(b=s.morphTargets&&s.morphTargets.length>0)),t.isSkinnedMesh&&!1===r.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t);var w=t.isSkinnedMesh&&r.skinning,x=0;b&&(x|=u),w&&(x|=c),l=h[x]}if(e.localClippingEnabled&&!0===r.clipShadows&&0!==r.clippingPlanes.length){var _=l.uuid,S=r.uuid,C=y[_];void 0===C&&(C={},y[_]=C);var M=C[S];void 0===M&&(M=l.clone(),C[S]=M),l=M}l.visible=r.visible,l.wireframe=r.wireframe;var T=r.side;return A.renderSingleSided&&T==v&&(T=m),A.renderReverseSided&&(T===m?T=g:T===g&&(T=m)),l.side=T,l.clipShadows=r.clipShadows,l.clippingPlanes=r.clippingPlanes,l.clipIntersection=r.clipIntersection,l.wireframeLinewidth=r.wireframeLinewidth,l.linewidth=r.linewidth,n&&l.isMeshDistanceMaterial&&(l.referencePosition.copy(i),l.nearDistance=o,l.farDistance=a),l}function P(r,i,o,a){if(!1!==r.visible){if(r.layers.test(i.layers)&&(r.isMesh||r.isLine||r.isPoints)&&r.castShadow&&(!r.frustumCulled||n.intersectsObject(r))){r.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,r.matrixWorld);var s=t.update(r),u=r.material;if(Array.isArray(u))for(var c=s.groups,h=0,p=c.length;h<p;h++){var d=c[h],f=u[d.materialIndex];if(f&&f.visible){var m=E(r,f,a,l,o.near,o.far);e.renderBufferDirect(o,null,s,m,r,d)}}else if(u.visible){m=E(r,u,a,l,o.near,o.far);e.renderBufferDirect(o,null,s,m,r,null)}}for(var g=r.children,v=0,y=g.length;v<y;v++)P(g[v],i,o,a)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=d,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,r,u){if(!1!==A.enabled&&(!1!==A.autoUpdate||!1!==A.needsUpdate)&&0!==t.length){var c,h=e.context,p=e.state;p.disable(h.BLEND),p.buffers.color.setClear(1,1,1,1),p.buffers.depth.setTest(!0),p.setScissorTest(!1);for(var d=0,f=t.length;d<f;d++){var m=t[d],g=m.shadow,v=m&&m.isPointLight;if(void 0!==g){var y=g.camera;if(o.copy(g.mapSize),o.min(a),v){var _=o.x,S=o.y;x[0].set(2*_,S,_,S),x[1].set(0,S,_,S),x[2].set(3*_,S,_,S),x[3].set(_,S,_,S),x[4].set(3*_,0,_,S),x[5].set(_,0,_,S),o.x*=4,o.y*=2}if(null===g.map){var C={minFilter:ge,magFilter:ge,format:Fe};g.map=new bt(o.x,o.y,C),g.map.texture.name=m.name+".shadowMap",y.updateProjectionMatrix()}g.isSpotLightShadow&&g.update(m);var M=g.map,T=g.matrix;l.setFromMatrixPosition(m.matrixWorld),y.position.copy(l),v?(c=6,T.makeTranslation(-l.x,-l.y,-l.z)):(c=1,s.setFromMatrixPosition(m.target.matrixWorld),y.lookAt(s),y.updateMatrixWorld(),T.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),T.multiply(y.projectionMatrix),T.multiply(y.matrixWorldInverse)),e.setRenderTarget(M),e.clear();for(var E=0;E<c;E++){if(v){s.copy(y.position),s.add(b[E]),y.up.copy(w[E]),y.lookAt(s),y.updateMatrixWorld();var R=x[E];p.viewport(R)}i.multiplyMatrices(y.projectionMatrix,y.matrixWorldInverse),n.setFromMatrix(i),P(r,u,y,v)}}else console.warn("THREE.WebGLShadowMap:",m,"has no shadow.")}A.needsUpdate=!1}}}function Ar(e){var t={};return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t[e.uuid]},remove:function(r){r.isInterleavedBufferAttribute&&(r=r.data);var n=t[r.uuid];n&&(e.deleteBuffer(n.buffer),delete t[r.uuid])},update:function(r,n){r.isInterleavedBufferAttribute&&(r=r.data);var i=t[r.uuid];void 0===i?t[r.uuid]=function(t,r){var n=t.array,i=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,o=e.createBuffer();e.bindBuffer(r,o),e.bufferData(r,n,i),t.onUploadCallback();var a=e.FLOAT;return n instanceof Float32Array?a=e.FLOAT:n instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):n instanceof Uint16Array?a=e.UNSIGNED_SHORT:n instanceof Int16Array?a=e.SHORT:n instanceof Uint32Array?a=e.UNSIGNED_INT:n instanceof Int32Array?a=e.INT:n instanceof Int8Array?a=e.BYTE:n instanceof Uint8Array&&(a=e.UNSIGNED_BYTE),{buffer:o,type:a,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version}}(r,n):i.version<r.version&&(function(t,r,n){var i=r.array,o=r.updateRange;e.bindBuffer(n,t),!1===r.dynamic?e.bufferData(n,i,e.STATIC_DRAW):-1===o.count?e.bufferSubData(n,0,i):0===o.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(n,o.offset*i.BYTES_PER_ELEMENT,i.subarray(o.offset,o.offset+o.count)),o.count=-1)}(i.buffer,r,n),i.version=r.version)}}}function Er(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._order=n||Er.DefaultOrder}function Pr(){this.mask=1}Object.assign(br.prototype,s.prototype,{isMaterial:!0,onBeforeCompile:function(){},setValues:function(e){if(void 0!==e)for(var t in e){var r=e[t];if(void 0!==r)if("shading"!==t){var n=this[t];void 0!==n?n&&n.isColor?n.set(r):n&&n.isVector3&&r&&r.isVector3?n.copy(r):this[t]="overdraw"===t?Number(r):r:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===r;else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){var t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});var r={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(e){var t=[];for(var r in e){var n=e[r];delete n.metadata,t.push(n)}return t}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearCoat&&(r.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(r.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,r.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(r.size=this.size),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==_&&(r.blending=this.blending),!0===this.flatShading&&(r.flatShading=this.flatShading),this.side!==m&&(r.side=this.side),this.vertexColors!==y&&(r.vertexColors=this.vertexColors),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=this.transparent),r.depthFunc=this.depthFunc,r.depthTest=this.depthTest,r.depthWrite=this.depthWrite,0!==this.rotation&&(r.rotation=this.rotation),1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(r.wireframe=this.wireframe),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(r.morphTargets=!0),!0===this.skinning&&(r.skinning=!0),!1===this.visible&&(r.visible=!1),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),t){var i=n(e.textures),o=n(e.images);i.length>0&&(r.textures=i),o.length>0&&(r.images=o)}return r},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.flatShading=e.flatShading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.userData=JSON.parse(JSON.stringify(e.userData)),this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,r=null;if(null!==t){var n=t.length;r=new Array(n);for(var i=0;i!==n;++i)r[i]=t[i].clone()}return this.clippingPlanes=r,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),wr.prototype=Object.create(br.prototype),wr.prototype.constructor=wr,wr.prototype.isMeshDepthMaterial=!0,wr.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},xr.prototype=Object.create(br.prototype),xr.prototype.constructor=xr,xr.prototype.isMeshDistanceMaterial=!0,xr.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this},Object.assign(_r.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,r=1/0,n=1/0,i=-1/0,o=-1/0,a=-1/0,s=0,l=e.length;s<l;s+=3){var u=e[s],c=e[s+1],h=e[s+2];u<t&&(t=u),c<r&&(r=c),h<n&&(n=h),u>i&&(i=u),c>o&&(o=c),h>a&&(a=h)}return this.min.set(t,r,n),this.max.set(i,o,a),this},setFromBufferAttribute:function(e){for(var t=1/0,r=1/0,n=1/0,i=-1/0,o=-1/0,a=-1/0,s=0,l=e.count;s<l;s++){var u=e.getX(s),c=e.getY(s),h=e.getZ(s);u<t&&(t=u),c<r&&(r=c),h<n&&(n=h),u>i&&(i=u),c>o&&(o=c),h>a&&(a=h)}return this.min.set(t,r,n),this.max.set(i,o,a),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new ft;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new ft;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new ft;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e,t,r,n=new ft;function i(i){var o=i.geometry;if(void 0!==o)if(o.isGeometry){var a=o.vertices;for(t=0,r=a.length;t<r;t++)n.copy(a[t]),n.applyMatrix4(i.matrixWorld),e.expandByPoint(n)}else if(o.isBufferGeometry){var s=o.attributes.position;if(void 0!==s)for(t=0,r=s.count;t<r;t++)n.fromBufferAttribute(s,t).applyMatrix4(i.matrixWorld),e.expandByPoint(n)}}return function(t){return e=this,t.updateMatrixWorld(!0),t.traverse(i),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new ft).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(){var e=new ft;return function(t){return this.clampPoint(t.center,e),e.distanceToSquared(t.center)<=t.radius*t.radius}}(),intersectsPlane:function(e){var t,r;return e.normal.x>0?(t=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=e.constant&&r>=e.constant},clampPoint:function(e,t){return(t||new ft).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new ft;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new ft;return function(t){var r=t||new Sr;return this.getCenter(r.center),r.radius=.5*this.getSize(e).length(),r}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new ft,new ft,new ft,new ft,new ft,new ft,new ft,new ft];return function(t){return this.isEmpty()?this:(e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(e),this)}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(Sr.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new _r;return function(t,r){var n=this.center;void 0!==r?n.copy(r):e.setFromPoints(t).getCenter(n);for(var i=0,o=0,a=t.length;o<a;o++)i=Math.max(i,n.distanceToSquared(t[o]));return this.radius=Math.sqrt(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius},clampPoint:function(e,t){var r=this.center.distanceToSquared(e),n=t||new ft;return n.copy(e),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(e){var t=e||new _r;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(Cr.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,n){return this.normal.set(e,t,r),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new ft,t=new ft;return function(r,n,i){var o=e.subVectors(i,n).cross(t.subVectors(r,n)).normalize();return this.setFromNormalAndCoplanarPoint(o,r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return(t||new ft).copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)},intersectLine:function(){var e=new ft;return function(t,r){var n=r||new ft,i=t.delta(e),o=this.normal.dot(i);if(0===o)return 0===this.distanceToPoint(t.start)?n.copy(t.start):void 0;var a=-(t.start.dot(this.normal)+this.constant)/o;return a<0||a>1?void 0:n.copy(i).multiplyScalar(a).add(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return t<0&&r>0||r<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new ft).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new ft,t=new mt;return function(r,n){var i=n||t.getNormalMatrix(r),o=this.coplanarPoint(e).applyMatrix4(r),a=this.normal.applyMatrix3(i).normalize();return this.constant=-o.dot(a),this}}(),translate:function(e){return this.constant-=e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(Mr.prototype,{set:function(e,t,r,n,i,o){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(r),a[3].copy(n),a[4].copy(i),a[5].copy(o),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,r=0;r<6;r++)t[r].copy(e.planes[r]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],l=r[5],u=r[6],c=r[7],h=r[8],p=r[9],d=r[10],f=r[11],m=r[12],g=r[13],v=r[14],y=r[15];return t[0].setComponents(a-n,c-s,f-h,y-m).normalize(),t[1].setComponents(a+n,c+s,f+h,y+m).normalize(),t[2].setComponents(a+i,c+l,f+p,y+g).normalize(),t[3].setComponents(a-i,c-l,f-p,y-g).normalize(),t[4].setComponents(a-o,c-u,f-d,y-v).normalize(),t[5].setComponents(a+o,c+u,f+d,y+v).normalize(),this},intersectsObject:function(){var e=new Sr;return function(t){var r=t.geometry;return null===r.boundingSphere&&r.computeBoundingSphere(),e.copy(r.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new Sr;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,r=e.center,n=-e.radius,i=0;i<6;i++){if(t[i].distanceToPoint(r)<n)return!1}return!0},intersectsBox:function(){var e=new ft,t=new ft;return function(r){for(var n=this.planes,i=0;i<6;i++){var o=n[i];e.x=o.normal.x>0?r.min.x:r.max.x,t.x=o.normal.x>0?r.max.x:r.min.x,e.y=o.normal.y>0?r.min.y:r.max.y,t.y=o.normal.y>0?r.max.y:r.min.y,e.z=o.normal.z>0?r.min.z:r.max.z,t.z=o.normal.z>0?r.max.z:r.min.z;var a=o.distanceToPoint(e),s=o.distanceToPoint(t);if(a<0&&s<0)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,r=0;r<6;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}}),Er.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Er.DefaultOrder="XYZ",Object.defineProperties(Er.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(Er.prototype,{isEuler:!0,set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._order=n||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){var n=ct.clamp,i=e.elements,o=i[0],a=i[4],s=i[8],l=i[1],u=i[5],c=i[9],h=i[2],p=i[6],d=i[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(n(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(p,u),this._z=0)):"YXZ"===t?(this._x=Math.asin(-n(c,-1,1)),Math.abs(c)<.99999?(this._y=Math.atan2(s,d),this._z=Math.atan2(l,u)):(this._y=Math.atan2(-h,o),this._z=0)):"ZXY"===t?(this._x=Math.asin(n(p,-1,1)),Math.abs(p)<.99999?(this._y=Math.atan2(-h,d),this._z=Math.atan2(-a,u)):(this._y=0,this._z=Math.atan2(l,o))):"ZYX"===t?(this._y=Math.asin(-n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(p,d),this._z=Math.atan2(l,o)):(this._x=0,this._z=Math.atan2(-a,u))):"YZX"===t?(this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(-c,u),this._y=Math.atan2(-h,o)):(this._x=0,this._y=Math.atan2(s,d))):"XZY"===t?(this._z=Math.asin(-n(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(p,u),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-c,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==r&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new pt;return function(t,r,n){return e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,r,n)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new dt;return function(t){return e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new ft(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Pr.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}});var Rr=0;function Ir(){Object.defineProperty(this,"id",{value:Rr++}),this.uuid=ct.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Ir.DefaultUp.clone();var e=new ft,t=new Er,r=new dt,n=new ft(1,1,1);t.onChange(function(){r.setFromEuler(t,!1)}),r.onChange(function(){t.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{enumerable:!0,value:e},rotation:{enumerable:!0,value:t},quaternion:{enumerable:!0,value:r},scale:{enumerable:!0,value:n},modelViewMatrix:{value:new pt},normalMatrix:{value:new mt}}),this.matrix=new pt,this.matrixWorld=new pt,this.matrixAutoUpdate=Ir.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Pr,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function Nr(){Ir.call(this),this.type="Camera",this.matrixWorldInverse=new pt,this.projectionMatrix=new pt}function Dr(e,t,r,n,i,o){Nr.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=n,this.near=void 0!==i?i:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()}function kr(e,t,r,n,i,o){this.a=e,this.b=t,this.c=r,this.normal=n&&n.isVector3?n:new ft,this.vertexNormals=Array.isArray(n)?n:[],this.color=i&&i.isColor?i:new ur,this.vertexColors=Array.isArray(i)?i:[],this.materialIndex=void 0!==o?o:0}Ir.DefaultUp=new ft(0,1,0),Ir.DefaultMatrixAutoUpdate=!0,Object.assign(Ir.prototype,s.prototype,{isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(e){return this.quaternion.premultiply(e),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new dt;return function(t,r){return e.setFromAxisAngle(t,r),this.quaternion.multiply(e),this}}(),rotateOnWorldAxis:function(){var e=new dt;return function(t,r){return e.setFromAxisAngle(t,r),this.quaternion.premultiply(e),this}}(),rotateX:function(){var e=new ft(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new ft(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new ft(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new ft;return function(t,r){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(r)),this}}(),translateX:function(){var e=new ft(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new ft(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new ft(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new pt;return function(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new pt,t=new ft;return function(r,n,i){r.isVector3?t.copy(r):t.set(r,n,i),this.isCamera?e.lookAt(this.position,t,this.up):e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){var t=arguments;if(arguments.length>1){for(var r=0;r<arguments.length;r++)this.add(t[r]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){var t=arguments;if(arguments.length>1){for(var r=0;r<arguments.length;r++)this.remove(t[r]);return this}var n=this.children.indexOf(e);return-1!==n&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(n,1)),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var r=0,n=this.children.length;r<n;r++){var i=this.children[r].getObjectByProperty(e,t);if(void 0!==i)return i}},getWorldPosition:function(e){var t=e||new ft;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new ft,t=new ft;return function(r){var n=r||new dt;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,n,t),n}}(),getWorldRotation:function(){var e=new dt;return function(t){var r=t||new Er;return this.getWorldQuaternion(e),r.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new ft,t=new dt;return function(r){var n=r||new ft;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,n),n}}(),getWorldDirection:function(){var e=new dt;return function(t){var r=t||new ft;return this.getWorldQuaternion(e),r.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,r=0,n=t.length;r<n;r++)t[r].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,r=0,n=t.length;r<n;r++)t[r].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,r=0,n=t.length;r<n;r++)t[r].updateMatrixWorld(e)},toJSON:function(e){var t=void 0===e||"string"==typeof e,r={};t&&(e={geometries:{},materials:{},textures:{},images:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};function i(t,r){return void 0===t[r.uuid]&&(t[r.uuid]=r.toJSON(e)),r.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.matrix=this.matrix.toArray(),void 0!==this.geometry&&(n.geometry=i(e.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var o=[],a=0,s=this.material.length;a<s;a++)o.push(i(e.materials,this.material[a]));n.material=o}else n.material=i(e.materials,this.material);if(this.children.length>0){n.children=[];for(a=0;a<this.children.length;a++)n.children.push(this.children[a].toJSON(e).object)}if(t){var l=p(e.geometries),u=p(e.materials),c=p(e.textures),h=p(e.images);l.length>0&&(r.geometries=l),u.length>0&&(r.materials=u),c.length>0&&(r.textures=c),h.length>0&&(r.images=h)}return r.object=n,r;function p(e){var t=[];for(var r in e){var n=e[r];delete n.metadata,t.push(n)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var r=0;r<e.children.length;r++){var n=e.children[r];this.add(n.clone())}return this}}),Nr.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Nr,isCamera:!0,copy:function(e,t){return Ir.prototype.copy.call(this,e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:function(){var e=new dt;return function(t){var r=t||new ft;return this.getWorldQuaternion(e),r.set(0,0,-1).applyQuaternion(e)}}(),updateMatrixWorld:function(e){Ir.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),Dr.prototype=Object.assign(Object.create(Nr.prototype),{constructor:Dr,isOrthographicCamera:!0,copy:function(e,t){return Nr.prototype.copy.call(this,e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,r,n,i,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=i,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2,i=r-e,o=r+e,a=n+t,s=n-t;if(null!==this.view&&this.view.enabled){var l=this.zoom/(this.view.width/this.view.fullWidth),u=this.zoom/(this.view.height/this.view.fullHeight),c=(this.right-this.left)/this.view.width,h=(this.top-this.bottom)/this.view.height;o=(i+=c*(this.view.offsetX/l))+c*(this.view.width/l),s=(a-=h*(this.view.offsetY/u))-h*(this.view.height/u)}this.projectionMatrix.makeOrthographic(i,o,a,s,this.near,this.far)},toJSON:function(e){var t=Ir.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}),Object.assign(kr.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,r=e.vertexNormals.length;t<r;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(t=0,r=e.vertexColors.length;t<r;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}});var Or=0;function Fr(){Object.defineProperty(this,"id",{value:Or+=2}),this.uuid=ct.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function Lr(e,t,r){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=ct.generateUUID(),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function Ur(e,t,r){Lr.call(this,new Int8Array(e),t,r)}function Vr(e,t,r){Lr.call(this,new Uint8Array(e),t,r)}function Br(e,t,r){Lr.call(this,new Uint8ClampedArray(e),t,r)}function zr(e,t,r){Lr.call(this,new Int16Array(e),t,r)}function jr(e,t,r){Lr.call(this,new Uint16Array(e),t,r)}function Hr(e,t,r){Lr.call(this,new Int32Array(e),t,r)}function $r(e,t,r){Lr.call(this,new Uint32Array(e),t,r)}function Gr(e,t,r){Lr.call(this,new Float32Array(e),t,r)}function Wr(e,t,r){Lr.call(this,new Float64Array(e),t,r)}function qr(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function Xr(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,n=e.length;r<n;++r)e[r]>t&&(t=e[r]);return t}Object.assign(Fr.prototype,s.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new mt).getNormalMatrix(e),r=0,n=this.vertices.length;r<n;r++){this.vertices[r].applyMatrix4(e)}for(r=0,n=this.faces.length;r<n;r++){var i=this.faces[r];i.normal.applyMatrix3(t).normalize();for(var o=0,a=i.vertexNormals.length;o<a;o++)i.vertexNormals[o].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new pt;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new pt;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new pt;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new pt;return function(t,r,n){return e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e=new pt;return function(t,r,n){return e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Ir;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){var t=this,r=null!==e.index?e.index.array:void 0,n=e.attributes,i=n.position.array,o=void 0!==n.normal?n.normal.array:void 0,a=void 0!==n.color?n.color.array:void 0,s=void 0!==n.uv?n.uv.array:void 0,l=void 0!==n.uv2?n.uv2.array:void 0;void 0!==l&&(this.faceVertexUvs[1]=[]);for(var u=[],c=[],h=[],p=0,d=0;p<i.length;p+=3,d+=2)t.vertices.push(new ft(i[p],i[p+1],i[p+2])),void 0!==o&&u.push(new ft(o[p],o[p+1],o[p+2])),void 0!==a&&t.colors.push(new ur(a[p],a[p+1],a[p+2])),void 0!==s&&c.push(new ht(s[d],s[d+1])),void 0!==l&&h.push(new ht(l[d],l[d+1]));function f(e,r,n,i){var p=new kr(e,r,n,void 0!==o?[u[e].clone(),u[r].clone(),u[n].clone()]:[],void 0!==a?[t.colors[e].clone(),t.colors[r].clone(),t.colors[n].clone()]:[],i);t.faces.push(p),void 0!==s&&t.faceVertexUvs[0].push([c[e].clone(),c[r].clone(),c[n].clone()]),void 0!==l&&t.faceVertexUvs[1].push([h[e].clone(),h[r].clone(),h[n].clone()])}var m=e.groups;if(m.length>0)for(p=0;p<m.length;p++)for(var g=m[p],v=g.start,y=(d=v,v+g.count);d<y;d+=3)void 0!==r?f(r[d],r[d+1],r[d+2],g.materialIndex):f(d,d+1,d+2,g.materialIndex);else if(void 0!==r)for(p=0;p<r.length;p+=3)f(r[p],r[p+1],r[p+2]);else for(p=0;p<i.length/3;p+=3)f(p,p+1,p+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,n=new pt;return n.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix(n),this},computeFaceNormals:function(){for(var e=new ft,t=new ft,r=0,n=this.faces.length;r<n;r++){var i=this.faces[r],o=this.vertices[i.a],a=this.vertices[i.b],s=this.vertices[i.c];e.subVectors(s,a),t.subVectors(o,a),e.cross(t),e.normalize(),i.normal.copy(e)}},computeVertexNormals:function(e){var t,r,n,i,o,a;for(void 0===e&&(e=!0),a=new Array(this.vertices.length),t=0,r=this.vertices.length;t<r;t++)a[t]=new ft;if(e){var s,l,u,c=new ft,h=new ft;for(n=0,i=this.faces.length;n<i;n++)o=this.faces[n],s=this.vertices[o.a],l=this.vertices[o.b],u=this.vertices[o.c],c.subVectors(u,l),h.subVectors(s,l),c.cross(h),a[o.a].add(c),a[o.b].add(c),a[o.c].add(c)}else for(this.computeFaceNormals(),n=0,i=this.faces.length;n<i;n++)a[(o=this.faces[n]).a].add(o.normal),a[o.b].add(o.normal),a[o.c].add(o.normal);for(t=0,r=this.vertices.length;t<r;t++)a[t].normalize();for(n=0,i=this.faces.length;n<i;n++){var p=(o=this.faces[n]).vertexNormals;3===p.length?(p[0].copy(a[o.a]),p[1].copy(a[o.b]),p[2].copy(a[o.c])):(p[0]=a[o.a].clone(),p[1]=a[o.b].clone(),p[2]=a[o.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,r;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){var n=(r=this.faces[e]).vertexNormals;3===n.length?(n[0].copy(r.normal),n[1].copy(r.normal),n[2].copy(r.normal)):(n[0]=r.normal.clone(),n[1]=r.normal.clone(),n[2]=r.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,r,n,i;for(r=0,n=this.faces.length;r<n;r++)for((i=this.faces[r]).__originalFaceNormal?i.__originalFaceNormal.copy(i.normal):i.__originalFaceNormal=i.normal.clone(),i.__originalVertexNormals||(i.__originalVertexNormals=[]),e=0,t=i.vertexNormals.length;e<t;e++)i.__originalVertexNormals[e]?i.__originalVertexNormals[e].copy(i.vertexNormals[e]):i.__originalVertexNormals[e]=i.vertexNormals[e].clone();var o=new Fr;for(o.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var a=this.morphNormals[e].faceNormals,s=this.morphNormals[e].vertexNormals;for(r=0,n=this.faces.length;r<n;r++)l=new ft,u={a:new ft,b:new ft,c:new ft},a.push(l),s.push(u)}var l,u,c=this.morphNormals[e];for(o.vertices=this.morphTargets[e].vertices,o.computeFaceNormals(),o.computeVertexNormals(),r=0,n=this.faces.length;r<n;r++)i=this.faces[r],l=c.faceNormals[r],u=c.vertexNormals[r],l.copy(i.normal),u.a.copy(i.vertexNormals[0]),u.b.copy(i.vertexNormals[1]),u.c.copy(i.vertexNormals[2])}for(r=0,n=this.faces.length;r<n;r++)(i=this.faces[r]).normal=i.__originalFaceNormal,i.vertexNormals=i.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,r=0,n=t.length;r<n;r++)r>0&&(e+=t[r].distanceTo(t[r-1])),this.lineDistances[r]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new _r),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sr),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,r){if(e&&e.isGeometry){var n,i=this.vertices.length,o=this.vertices,a=e.vertices,s=this.faces,l=e.faces,u=this.faceVertexUvs[0],c=e.faceVertexUvs[0],h=this.colors,p=e.colors;void 0===r&&(r=0),void 0!==t&&(n=(new mt).getNormalMatrix(t));for(var d=0,f=a.length;d<f;d++){var m=a[d].clone();void 0!==t&&m.applyMatrix4(t),o.push(m)}for(d=0,f=p.length;d<f;d++)h.push(p[d].clone());for(d=0,f=l.length;d<f;d++){var g,v,y,b=l[d],w=b.vertexNormals,x=b.vertexColors;(g=new kr(b.a+i,b.b+i,b.c+i)).normal.copy(b.normal),void 0!==n&&g.normal.applyMatrix3(n).normalize();for(var _=0,S=w.length;_<S;_++)v=w[_].clone(),void 0!==n&&v.applyMatrix3(n).normalize(),g.vertexNormals.push(v);g.color.copy(b.color);for(_=0,S=x.length;_<S;_++)y=x[_],g.vertexColors.push(y.clone());g.materialIndex=b.materialIndex+r,s.push(g)}for(d=0,f=c.length;d<f;d++){var C=c[d],M=[];if(void 0!==C){for(_=0,S=C.length;_<S;_++)M.push(C[_].clone());u.push(M)}}}else console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e)},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(){var e,t,r,n,i,o,a,s,l={},u=[],c=[],h=Math.pow(10,4);for(r=0,n=this.vertices.length;r<n;r++)e=this.vertices[r],void 0===l[t=Math.round(e.x*h)+"_"+Math.round(e.y*h)+"_"+Math.round(e.z*h)]?(l[t]=r,u.push(this.vertices[r]),c[r]=u.length-1):c[r]=c[l[t]];var p=[];for(r=0,n=this.faces.length;r<n;r++){(i=this.faces[r]).a=c[i.a],i.b=c[i.b],i.c=c[i.c],o=[i.a,i.b,i.c];for(var d=0;d<3;d++)if(o[d]===o[(d+1)%3]){p.push(r);break}}for(r=p.length-1;r>=0;r--){var f=p[r];for(this.faces.splice(f,1),a=0,s=this.faceVertexUvs.length;a<s;a++)this.faceVertexUvs[a].splice(f,1)}var m=this.vertices.length-u.length;return this.vertices=u,m},setFromPoints:function(e){this.vertices=[];for(var t=0,r=e.length;t<r;t++){var n=e[t];this.vertices.push(new ft(n.x,n.y,n.z||0))}return this},sortFacesByMaterialIndex:function(){for(var e=this.faces,t=e.length,r=0;r<t;r++)e[r]._id=r;e.sort(function(e,t){return e.materialIndex-t.materialIndex});var n,i,o=this.faceVertexUvs[0],a=this.faceVertexUvs[1];o&&o.length===t&&(n=[]),a&&a.length===t&&(i=[]);for(r=0;r<t;r++){var s=e[r]._id;n&&n.push(o[s]),i&&i.push(a[s])}n&&(this.faceVertexUvs[0]=n),i&&(this.faceVertexUvs[1]=i)},toJSON:function(){var e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}for(var n=[],i=0;i<this.vertices.length;i++){var o=this.vertices[i];n.push(o.x,o.y,o.z)}var a=[],s=[],l={},u=[],c={},h=[],p={};for(i=0;i<this.faces.length;i++){var d=this.faces[i],f=void 0!==this.faceVertexUvs[0][i],m=d.normal.length()>0,g=d.vertexNormals.length>0,v=1!==d.color.r||1!==d.color.g||1!==d.color.b,y=d.vertexColors.length>0,b=0;if(b=S(b=S(b=S(b=S(b=S(b=S(b=S(b=S(b,0,0),1,!0),2,!1),3,f),4,m),5,g),6,v),7,y),a.push(b),a.push(d.a,d.b,d.c),a.push(d.materialIndex),f){var w=this.faceVertexUvs[0][i];a.push(T(w[0]),T(w[1]),T(w[2]))}if(m&&a.push(C(d.normal)),g){var x=d.vertexNormals;a.push(C(x[0]),C(x[1]),C(x[2]))}if(v&&a.push(M(d.color)),y){var _=d.vertexColors;a.push(M(_[0]),M(_[1]),M(_[2]))}}function S(e,t,r){return r?e|1<<t:e&~(1<<t)}function C(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==l[t]?l[t]:(l[t]=s.length/3,s.push(e.x,e.y,e.z),l[t])}function M(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==c[t]?c[t]:(c[t]=u.length,u.push(e.getHex()),c[t])}function T(e){var t=e.x.toString()+e.y.toString();return void 0!==p[t]?p[t]:(p[t]=h.length/2,h.push(e.x,e.y),p[t])}return e.data={},e.data.vertices=n,e.data.normals=s,u.length>0&&(e.data.colors=u),h.length>0&&(e.data.uvs=[h]),e.data.faces=a,e},clone:function(){return(new Fr).copy(this)},copy:function(e){var t,r,n,i,o,a;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,r=s.length;t<r;t++)this.vertices.push(s[t].clone());var l=e.colors;for(t=0,r=l.length;t<r;t++)this.colors.push(l[t].clone());var u=e.faces;for(t=0,r=u.length;t<r;t++)this.faces.push(u[t].clone());for(t=0,r=e.faceVertexUvs.length;t<r;t++){var c=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),n=0,i=c.length;n<i;n++){var h=c[n],p=[];for(o=0,a=h.length;o<a;o++){var d=h[o];p.push(d.clone())}this.faceVertexUvs[t].push(p)}}var f=e.morphTargets;for(t=0,r=f.length;t<r;t++){var m={};if(m.name=f[t].name,void 0!==f[t].vertices)for(m.vertices=[],n=0,i=f[t].vertices.length;n<i;n++)m.vertices.push(f[t].vertices[n].clone());if(void 0!==f[t].normals)for(m.normals=[],n=0,i=f[t].normals.length;n<i;n++)m.normals.push(f[t].normals[n].clone());this.morphTargets.push(m)}var g=e.morphNormals;for(t=0,r=g.length;t<r;t++){var v={};if(void 0!==g[t].vertexNormals)for(v.vertexNormals=[],n=0,i=g[t].vertexNormals.length;n<i;n++){var y=g[t].vertexNormals[n],b={};b.a=y.a.clone(),b.b=y.b.clone(),b.c=y.c.clone(),v.vertexNormals.push(b)}if(void 0!==g[t].faceNormals)for(v.faceNormals=[],n=0,i=g[t].faceNormals.length;n<i;n++)v.faceNormals.push(g[t].faceNormals[n].clone());this.morphNormals.push(v)}var w=e.skinWeights;for(t=0,r=w.length;t<r;t++)this.skinWeights.push(w[t].clone());var x=e.skinIndices;for(t=0,r=x.length;t<r;t++)this.skinIndices.push(x[t].clone());var _=e.lineDistances;for(t=0,r=_.length;t<r;t++)this.lineDistances.push(_[t]);var S=e.boundingBox;null!==S&&(this.boundingBox=S.clone());var C=e.boundingSphere;return null!==C&&(this.boundingSphere=C.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(Lr.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Lr.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(var n=0,i=this.itemSize;n<i;n++)this.array[e+n]=t.array[r+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;n<i;n++){var o=e[n];void 0===o&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),o=new ur),t[r++]=o.r,t[r++]=o.g,t[r++]=o.b}return this},copyIndicesArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;n<i;n++){var o=e[n];t[r++]=o.a,t[r++]=o.b,t[r++]=o.c}return this},copyVector2sArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;n<i;n++){var o=e[n];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),o=new ht),t[r++]=o.x,t[r++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;n<i;n++){var o=e[n];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),o=new ft),t[r++]=o.x,t[r++]=o.y,t[r++]=o.z}return this},copyVector4sArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;n<i;n++){var o=e[n];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),o=new yt),t[r++]=o.x,t[r++]=o.y,t[r++]=o.z,t[r++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=i,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),Ur.prototype=Object.create(Lr.prototype),Ur.prototype.constructor=Ur,Vr.prototype=Object.create(Lr.prototype),Vr.prototype.constructor=Vr,Br.prototype=Object.create(Lr.prototype),Br.prototype.constructor=Br,zr.prototype=Object.create(Lr.prototype),zr.prototype.constructor=zr,jr.prototype=Object.create(Lr.prototype),jr.prototype.constructor=jr,Hr.prototype=Object.create(Lr.prototype),Hr.prototype.constructor=Hr,$r.prototype=Object.create(Lr.prototype),$r.prototype.constructor=$r,Gr.prototype=Object.create(Lr.prototype),Gr.prototype.constructor=Gr,Wr.prototype=Object.create(Lr.prototype),Wr.prototype.constructor=Wr,Object.assign(qr.prototype,{computeGroups:function(e){for(var t,r=[],n=void 0,i=e.faces,o=0;o<i.length;o++){var a=i[o];a.materialIndex!==n&&(n=a.materialIndex,void 0!==t&&(t.count=3*o-t.start,r.push(t)),t={start:3*o,materialIndex:n})}void 0!==t&&(t.count=3*o-t.start,r.push(t)),this.groups=r},fromGeometry:function(e){var t,r=e.faces,n=e.vertices,i=e.faceVertexUvs,o=i[0]&&i[0].length>0,a=i[1]&&i[1].length>0,s=e.morphTargets,l=s.length;if(l>0){t=[];for(var u=0;u<l;u++)t[u]=[];this.morphTargets.position=t}var c,h=e.morphNormals,p=h.length;if(p>0){c=[];for(u=0;u<p;u++)c[u]=[];this.morphTargets.normal=c}var d=e.skinIndices,f=e.skinWeights,m=d.length===n.length,g=f.length===n.length;for(u=0;u<r.length;u++){var v=r[u];this.vertices.push(n[v.a],n[v.b],n[v.c]);var y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var b=v.normal;this.normals.push(b,b,b)}var w,x=v.vertexColors;if(3===x.length)this.colors.push(x[0],x[1],x[2]);else{var _=v.color;this.colors.push(_,_,_)}if(!0===o)void 0!==(w=i[0][u])?this.uvs.push(w[0],w[1],w[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",u),this.uvs.push(new ht,new ht,new ht));if(!0===a)void 0!==(w=i[1][u])?this.uvs2.push(w[0],w[1],w[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",u),this.uvs2.push(new ht,new ht,new ht));for(var S=0;S<l;S++){var C=s[S].vertices;t[S].push(C[v.a],C[v.b],C[v.c])}for(S=0;S<p;S++){var M=h[S].vertexNormals[u];c[S].push(M.a,M.b,M.c)}m&&this.skinIndices.push(d[v.a],d[v.b],d[v.c]),g&&this.skinWeights.push(f[v.a],f[v.b],f[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var Kr=1;function Yr(){Object.defineProperty(this,"id",{value:Kr+=2}),this.uuid=ct.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Zr(e,t,r,n,i,o){Fr.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:i,depthSegments:o},this.fromBufferGeometry(new Jr(e,t,r,n,i,o)),this.mergeVertices()}function Jr(e,t,r,n,i,o){Yr.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:i,depthSegments:o};var a=this;e=e||1,t=t||1,r=r||1,n=Math.floor(n)||1,i=Math.floor(i)||1;var s=[],l=[],u=[],c=[],h=0,p=0;function d(e,t,r,n,i,o,d,f,m,g,v){var y,b,w=o/m,x=d/g,_=o/2,S=d/2,C=f/2,M=m+1,T=g+1,A=0,E=0,P=new ft;for(b=0;b<T;b++){var R=b*x-S;for(y=0;y<M;y++){var I=y*w-_;P[e]=I*n,P[t]=R*i,P[r]=C,l.push(P.x,P.y,P.z),P[e]=0,P[t]=0,P[r]=f>0?1:-1,u.push(P.x,P.y,P.z),c.push(y/m),c.push(1-b/g),A+=1}}for(b=0;b<g;b++)for(y=0;y<m;y++){var N=h+y+M*b,D=h+y+M*(b+1),k=h+(y+1)+M*(b+1),O=h+(y+1)+M*b;s.push(N,D,O),s.push(D,k,O),E+=6}a.addGroup(p,E,v),p+=E,h+=A}d("z","y","x",-1,-1,r,t,e,o=Math.floor(o)||1,i,0),d("z","y","x",1,-1,r,t,-e,o,i,1),d("x","z","y",1,1,e,r,t,n,o,2),d("x","z","y",1,-1,e,r,-t,n,o,3),d("x","y","z",1,-1,e,t,r,n,i,4),d("x","y","z",-1,-1,e,t,-r,n,i,5),this.setIndex(s),this.addAttribute("position",new Gr(l,3)),this.addAttribute("normal",new Gr(u,3)),this.addAttribute("uv",new Gr(c,2))}function Qr(e,t,r,n){Fr.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n},this.fromBufferGeometry(new en(e,t,r,n)),this.mergeVertices()}function en(e,t,r,n){Yr.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n};var i,o,a=(e=e||1)/2,s=(t=t||1)/2,l=Math.floor(r)||1,u=Math.floor(n)||1,c=l+1,h=u+1,p=e/l,d=t/u,f=[],m=[],g=[],v=[];for(o=0;o<h;o++){var y=o*d-s;for(i=0;i<c;i++){var b=i*p-a;m.push(b,-y,0),g.push(0,0,1),v.push(i/l),v.push(1-o/u)}}for(o=0;o<u;o++)for(i=0;i<l;i++){var w=i+c*o,x=i+c*(o+1),_=i+1+c*(o+1),S=i+1+c*o;f.push(w,x,S),f.push(x,_,S)}this.setIndex(f),this.addAttribute("position",new Gr(m,3)),this.addAttribute("normal",new Gr(g,3)),this.addAttribute("uv",new Gr(v,2))}function tn(e){br.call(this),this.type="MeshBasicMaterial",this.color=new ur(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function rn(e){br.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function nn(e,t){this.origin=void 0!==e?e:new ft,this.direction=void 0!==t?t:new ft}function on(e,t){this.start=void 0!==e?e:new ft,this.end=void 0!==t?t:new ft}function an(e,t,r){this.a=void 0!==e?e:new ft,this.b=void 0!==t?t:new ft,this.c=void 0!==r?r:new ft}function sn(e,t){Ir.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new Yr,this.material=void 0!==t?t:new tn({color:16777215*Math.random()}),this.drawMode=Je,this.updateMorphTargets()}function ln(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function un(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function cn(){var e={};return{get:function(t,r){var n=t.id+","+r.id,i=e[n];return void 0===i&&(i=new function(){var e=[],t=0,r=[],n=[];return{opaque:r,transparent:n,init:function(){t=0,r.length=0,n.length=0},push:function(i,o,a,s,l){var u=e[t];void 0===u?(u={id:i.id,object:i,geometry:o,material:a,program:a.program,renderOrder:i.renderOrder,z:s,group:l},e[t]=u):(u.id=i.id,u.object=i,u.geometry=o,u.material=a,u.program=a.program,u.renderOrder=i.renderOrder,u.z=s,u.group=l),(!0===a.transparent?n:r).push(u),t++},sort:function(){r.length>1&&r.sort(ln),n.length>1&&n.sort(un)}}},e[n]=i),i},dispose:function(){e={}}}}function hn(e,t){return Math.abs(t[1])-Math.abs(e[1])}function pn(){var e=new function(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var r;switch(t.type){case"DirectionalLight":r={direction:new ft,color:new ur,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ht};break;case"SpotLight":r={position:new ft,direction:new ft,color:new ur,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ht};break;case"PointLight":r={position:new ft,color:new ur,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new ht,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":r={direction:new ft,skyColor:new ur,groundColor:new ur};break;case"RectAreaLight":r={color:new ur,position:new ft,halfWidth:new ft,halfHeight:new ft}}return e[t.id]=r,r}}},t={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},r=new ft,n=new pt,i=new pt;return{setup:function(o,a,s){for(var l=0,u=0,c=0,h=0,p=0,d=0,f=0,m=0,g=s.matrixWorldInverse,v=0,y=o.length;v<y;v++){var b=o[v],w=b.color,x=b.intensity,_=b.distance,S=b.shadow&&b.shadow.map?b.shadow.map.texture:null;if(b.isAmbientLight)l+=w.r*x,u+=w.g*x,c+=w.b*x;else if(b.isDirectionalLight){if((M=e.get(b)).color.copy(b.color).multiplyScalar(b.intensity),M.direction.setFromMatrixPosition(b.matrixWorld),r.setFromMatrixPosition(b.target.matrixWorld),M.direction.sub(r),M.direction.transformDirection(g),M.shadow=b.castShadow,b.castShadow){var C=b.shadow;M.shadowBias=C.bias,M.shadowRadius=C.radius,M.shadowMapSize=C.mapSize}t.directionalShadowMap[h]=S,t.directionalShadowMatrix[h]=b.shadow.matrix,t.directional[h]=M,h++}else if(b.isSpotLight)(M=e.get(b)).position.setFromMatrixPosition(b.matrixWorld),M.position.applyMatrix4(g),M.color.copy(w).multiplyScalar(x),M.distance=_,M.direction.setFromMatrixPosition(b.matrixWorld),r.setFromMatrixPosition(b.target.matrixWorld),M.direction.sub(r),M.direction.transformDirection(g),M.coneCos=Math.cos(b.angle),M.penumbraCos=Math.cos(b.angle*(1-b.penumbra)),M.decay=0===b.distance?0:b.decay,M.shadow=b.castShadow,b.castShadow&&(C=b.shadow,M.shadowBias=C.bias,M.shadowRadius=C.radius,M.shadowMapSize=C.mapSize),t.spotShadowMap[d]=S,t.spotShadowMatrix[d]=b.shadow.matrix,t.spot[d]=M,d++;else if(b.isRectAreaLight)(M=e.get(b)).color.copy(w).multiplyScalar(x/(b.width*b.height)),M.position.setFromMatrixPosition(b.matrixWorld),M.position.applyMatrix4(g),i.identity(),n.copy(b.matrixWorld),n.premultiply(g),i.extractRotation(n),M.halfWidth.set(.5*b.width,0,0),M.halfHeight.set(0,.5*b.height,0),M.halfWidth.applyMatrix4(i),M.halfHeight.applyMatrix4(i),t.rectArea[f]=M,f++;else if(b.isPointLight)(M=e.get(b)).position.setFromMatrixPosition(b.matrixWorld),M.position.applyMatrix4(g),M.color.copy(b.color).multiplyScalar(b.intensity),M.distance=b.distance,M.decay=0===b.distance?0:b.decay,M.shadow=b.castShadow,b.castShadow&&(C=b.shadow,M.shadowBias=C.bias,M.shadowRadius=C.radius,M.shadowMapSize=C.mapSize,M.shadowCameraNear=C.camera.near,M.shadowCameraFar=C.camera.far),t.pointShadowMap[p]=S,t.pointShadowMatrix[p]=b.shadow.matrix,t.point[p]=M,p++;else if(b.isHemisphereLight){var M;(M=e.get(b)).direction.setFromMatrixPosition(b.matrixWorld),M.direction.transformDirection(g),M.direction.normalize(),M.skyColor.copy(b.color).multiplyScalar(x),M.groundColor.copy(b.groundColor).multiplyScalar(x),t.hemi[m]=M,m++}}t.ambient[0]=l,t.ambient[1]=u,t.ambient[2]=c,t.directional.length=h,t.spot.length=d,t.rectArea.length=f,t.point.length=p,t.hemi.length=m,t.hash=h+","+p+","+d+","+f+","+m+","+a.length},state:t}}function dn(e,t,r){var n=e.createShader(t);return e.shaderSource(n,r),e.compileShader(n),!1===e.getShaderParameter(n,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(n)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(n),function(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")}(r)),n}Object.assign(Yr.prototype,s.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(Xr(e)>65535?$r:jr)(e,1):this.index=e},addAttribute:function(e,t){return t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new Lr(arguments[1],arguments[2])))},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var r=this.attributes.normal;void 0!==r&&((new mt).getNormalMatrix(e).applyToBufferAttribute(r),r.needsUpdate=!0);return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new pt;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new pt;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new pt;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new pt;return function(t,r,n){return e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e=new pt;return function(t,r,n){return e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Ir;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var r=new Gr(3*t.vertices.length,3),n=new Gr(3*t.colors.length,3);if(this.addAttribute("position",r.copyVector3sArray(t.vertices)),this.addAttribute("color",n.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var i=new Gr(t.lineDistances.length,1);this.addAttribute("lineDistance",i.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},setFromPoints:function(e){for(var t=[],r=0,n=e.length;r<n;r++){var i=e[r];t.push(i.x,i.y,i.z||0)}return this.addAttribute("position",new Gr(t,3)),this},updateFromObject:function(e){var t,r=e.geometry;if(e.isMesh){var n=r.__directGeometry;if(!0===r.elementsNeedUpdate&&(n=void 0,r.elementsNeedUpdate=!1),void 0===n)return this.fromGeometry(r);n.verticesNeedUpdate=r.verticesNeedUpdate,n.normalsNeedUpdate=r.normalsNeedUpdate,n.colorsNeedUpdate=r.colorsNeedUpdate,n.uvsNeedUpdate=r.uvsNeedUpdate,n.groupsNeedUpdate=r.groupsNeedUpdate,r.verticesNeedUpdate=!1,r.normalsNeedUpdate=!1,r.colorsNeedUpdate=!1,r.uvsNeedUpdate=!1,r.groupsNeedUpdate=!1,r=n}return!0===r.verticesNeedUpdate&&(void 0!==(t=this.attributes.position)&&(t.copyVector3sArray(r.vertices),t.needsUpdate=!0),r.verticesNeedUpdate=!1),!0===r.normalsNeedUpdate&&(void 0!==(t=this.attributes.normal)&&(t.copyVector3sArray(r.normals),t.needsUpdate=!0),r.normalsNeedUpdate=!1),!0===r.colorsNeedUpdate&&(void 0!==(t=this.attributes.color)&&(t.copyColorsArray(r.colors),t.needsUpdate=!0),r.colorsNeedUpdate=!1),r.uvsNeedUpdate&&(void 0!==(t=this.attributes.uv)&&(t.copyVector2sArray(r.uvs),t.needsUpdate=!0),r.uvsNeedUpdate=!1),r.lineDistancesNeedUpdate&&(void 0!==(t=this.attributes.lineDistance)&&(t.copyArray(r.lineDistances),t.needsUpdate=!0),r.lineDistancesNeedUpdate=!1),r.groupsNeedUpdate&&(r.computeGroups(e.geometry),this.groups=r.groups,r.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new qr).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new Lr(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var r=new Float32Array(3*e.normals.length);this.addAttribute("normal",new Lr(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var n=new Float32Array(3*e.colors.length);this.addAttribute("color",new Lr(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var i=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new Lr(i,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var o=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new Lr(o,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var a=new(Xr(e.indices)>65535?Uint32Array:Uint16Array)(3*e.indices.length);this.setIndex(new Lr(a,1).copyIndicesArray(e.indices))}for(var s in this.groups=e.groups,e.morphTargets){for(var l=[],u=e.morphTargets[s],c=0,h=u.length;c<h;c++){var p=u[c],d=new Gr(3*p.length,3);l.push(d.copyVector3sArray(p))}this.morphAttributes[s]=l}if(e.skinIndices.length>0){var f=new Gr(4*e.skinIndices.length,4);this.addAttribute("skinIndex",f.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var m=new Gr(4*e.skinWeights.length,4);this.addAttribute("skinWeight",m.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new _r);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new _r,t=new ft;return function(){null===this.boundingSphere&&(this.boundingSphere=new Sr);var r=this.attributes.position;if(r){var n=this.boundingSphere.center;e.setFromBufferAttribute(r),e.getCenter(n);for(var i=0,o=0,a=r.count;o<a;o++)t.x=r.getX(o),t.y=r.getY(o),t.z=r.getZ(o),i=Math.max(i,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,r=this.groups;if(t.position){var n=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new Lr(new Float32Array(n.length),3));else for(var i=t.normal.array,o=0,a=i.length;o<a;o++)i[o]=0;var s,l,u,c=t.normal.array,h=new ft,p=new ft,d=new ft,f=new ft,m=new ft;if(e){var g=e.array;0===r.length&&this.addGroup(0,g.length);for(var v=0,y=r.length;v<y;++v){var b=r[v],w=b.start;for(o=w,a=w+b.count;o<a;o+=3)s=3*g[o+0],l=3*g[o+1],u=3*g[o+2],h.fromArray(n,s),p.fromArray(n,l),d.fromArray(n,u),f.subVectors(d,p),m.subVectors(h,p),f.cross(m),c[s]+=f.x,c[s+1]+=f.y,c[s+2]+=f.z,c[l]+=f.x,c[l+1]+=f.y,c[l+2]+=f.z,c[u]+=f.x,c[u+1]+=f.y,c[u+2]+=f.z}}else for(o=0,a=n.length;o<a;o+=9)h.fromArray(n,o),p.fromArray(n,o+3),d.fromArray(n,o+6),f.subVectors(d,p),m.subVectors(h,p),f.cross(m),c[o]=f.x,c[o+1]=f.y,c[o+2]=f.z,c[o+3]=f.x,c[o+4]=f.y,c[o+5]=f.z,c[o+6]=f.x,c[o+7]=f.y,c[o+8]=f.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(e&&e.isBufferGeometry){void 0===t&&(t=0);var r=this.attributes;for(var n in r)if(void 0!==e.attributes[n])for(var i=r[n].array,o=e.attributes[n],a=o.array,s=0,l=o.itemSize*t;s<a.length;s++,l++)i[l]=a[s];return this}console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e)},normalizeNormals:function(){var e=new ft;return function(){for(var t=this.attributes.normal,r=0,n=t.count;r<n;r++)e.x=t.getX(r),e.y=t.getY(r),e.z=t.getZ(r),e.normalize(),t.setXYZ(r,e.x,e.y,e.z)}}(),toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new Yr,t=this.index.array,r=this.attributes;for(var n in r){for(var i=r[n],o=i.array,a=i.itemSize,s=new o.constructor(t.length*a),l=0,u=0,c=0,h=t.length;c<h;c++){l=t[c]*a;for(var p=0;p<a;p++)s[u++]=o[l++]}e.addAttribute(n,new Lr(s,a))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}e.data={attributes:{}};var n=this.index;if(null!==n){var i=Array.prototype.slice.call(n.array);e.data.index={type:n.array.constructor.name,array:i}}var o=this.attributes;for(var r in o){var a=o[r];i=Array.prototype.slice.call(a.array);e.data.attributes[r]={itemSize:a.itemSize,type:a.array.constructor.name,array:i,normalized:a.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var l=this.boundingSphere;return null!==l&&(e.data.boundingSphere={center:l.center.toArray(),radius:l.radius}),e},clone:function(){return(new Yr).copy(this)},copy:function(e){var t,r,n;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var i=e.index;null!==i&&this.setIndex(i.clone());var o=e.attributes;for(t in o){var a=o[t];this.addAttribute(t,a.clone())}var s=e.morphAttributes;for(t in s){var l=[],u=s[t];for(r=0,n=u.length;r<n;r++)l.push(u[r].clone());this.morphAttributes[t]=l}var c=e.groups;for(r=0,n=c.length;r<n;r++){var h=c[r];this.addGroup(h.start,h.count,h.materialIndex)}var p=e.boundingBox;null!==p&&(this.boundingBox=p.clone());var d=e.boundingSphere;return null!==d&&(this.boundingSphere=d.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Zr.prototype=Object.create(Fr.prototype),Zr.prototype.constructor=Zr,Jr.prototype=Object.create(Yr.prototype),Jr.prototype.constructor=Jr,Qr.prototype=Object.create(Fr.prototype),Qr.prototype.constructor=Qr,en.prototype=Object.create(Yr.prototype),en.prototype.constructor=en,tn.prototype=Object.create(br.prototype),tn.prototype.constructor=tn,tn.prototype.isMeshBasicMaterial=!0,tn.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},rn.prototype=Object.create(br.prototype),rn.prototype.constructor=rn,rn.prototype.isShaderMaterial=!0,rn.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=hr.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},rn.prototype.toJSON=function(e){var t=br.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},Object.assign(nn.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new ft).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new ft;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var r=t||new ft;r.subVectors(e,this.origin);var n=r.dot(this.direction);return n<0?r.copy(this.origin):r.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new ft;return function(t){var r=e.subVectors(t,this.origin).dot(this.direction);return r<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(r).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new ft,t=new ft,r=new ft;return function(n,i,o,a){e.copy(n).add(i).multiplyScalar(.5),t.copy(i).sub(n).normalize(),r.copy(this.origin).sub(e);var s,l,u,c,h=.5*n.distanceTo(i),p=-this.direction.dot(t),d=r.dot(this.direction),f=-r.dot(t),m=r.lengthSq(),g=Math.abs(1-p*p);if(g>0)if(l=p*d-f,c=h*g,(s=p*f-d)>=0)if(l>=-c)if(l<=c){var v=1/g;u=(s*=v)*(s+p*(l*=v)+2*d)+l*(p*s+l+2*f)+m}else l=h,u=-(s=Math.max(0,-(p*l+d)))*s+l*(l+2*f)+m;else l=-h,u=-(s=Math.max(0,-(p*l+d)))*s+l*(l+2*f)+m;else l<=-c?u=-(s=Math.max(0,-(-p*h+d)))*s+(l=s>0?-h:Math.min(Math.max(-h,-f),h))*(l+2*f)+m:l<=c?(s=0,u=(l=Math.min(Math.max(-h,-f),h))*(l+2*f)+m):u=-(s=Math.max(0,-(p*h+d)))*s+(l=s>0?h:Math.min(Math.max(-h,-f),h))*(l+2*f)+m;else l=p>0?-h:h,u=-(s=Math.max(0,-(p*l+d)))*s+l*(l+2*f)+m;return o&&o.copy(this.direction).multiplyScalar(s).add(this.origin),a&&a.copy(t).multiplyScalar(l).add(e),u}}(),intersectSphere:function(){var e=new ft;return function(t,r){e.subVectors(t.center,this.origin);var n=e.dot(this.direction),i=e.dot(e)-n*n,o=t.radius*t.radius;if(i>o)return null;var a=Math.sqrt(o-i),s=n-a,l=n+a;return s<0&&l<0?null:s<0?this.at(l,r):this.at(s,r)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var r,n,i,o,a,s,l=1/this.direction.x,u=1/this.direction.y,c=1/this.direction.z,h=this.origin;return l>=0?(r=(e.min.x-h.x)*l,n=(e.max.x-h.x)*l):(r=(e.max.x-h.x)*l,n=(e.min.x-h.x)*l),u>=0?(i=(e.min.y-h.y)*u,o=(e.max.y-h.y)*u):(i=(e.max.y-h.y)*u,o=(e.min.y-h.y)*u),r>o||i>n?null:((i>r||r!=r)&&(r=i),(o<n||n!=n)&&(n=o),c>=0?(a=(e.min.z-h.z)*c,s=(e.max.z-h.z)*c):(a=(e.max.z-h.z)*c,s=(e.min.z-h.z)*c),r>s||a>n?null:((a>r||r!=r)&&(r=a),(s<n||n!=n)&&(n=s),n<0?null:this.at(r>=0?r:n,t)))},intersectsBox:function(){var e=new ft;return function(t){return null!==this.intersectBox(t,e)}}(),intersectTriangle:function(){var e=new ft,t=new ft,r=new ft,n=new ft;return function(i,o,a,s,l){t.subVectors(o,i),r.subVectors(a,i),n.crossVectors(t,r);var u,c=this.direction.dot(n);if(c>0){if(s)return null;u=1}else{if(!(c<0))return null;u=-1,c=-c}e.subVectors(this.origin,i);var h=u*this.direction.dot(r.crossVectors(e,r));if(h<0)return null;var p=u*this.direction.dot(t.cross(e));if(p<0)return null;if(h+p>c)return null;var d=-u*e.dot(n);return d<0?null:this.at(d/c,l)}}(),applyMatrix4:function(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),Object.assign(on.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new ft).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new ft).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var r=t||new ft;return this.delta(r).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new ft,t=new ft;return function(r,n){e.subVectors(r,this.start),t.subVectors(this.end,this.start);var i=t.dot(t),o=t.dot(e)/i;return n&&(o=ct.clamp(o,0,1)),o}}(),closestPointToPoint:function(e,t,r){var n=this.closestPointToPointParameter(e,t),i=r||new ft;return this.delta(i).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(an,{normal:function(){var e=new ft;return function(t,r,n,i){var o=i||new ft;o.subVectors(n,r),e.subVectors(t,r),o.cross(e);var a=o.lengthSq();return a>0?o.multiplyScalar(1/Math.sqrt(a)):o.set(0,0,0)}}(),barycoordFromPoint:function(){var e=new ft,t=new ft,r=new ft;return function(n,i,o,a,s){e.subVectors(a,i),t.subVectors(o,i),r.subVectors(n,i);var l=e.dot(e),u=e.dot(t),c=e.dot(r),h=t.dot(t),p=t.dot(r),d=l*h-u*u,f=s||new ft;if(0===d)return f.set(-2,-1,-1);var m=1/d,g=(h*c-u*p)*m,v=(l*p-u*c)*m;return f.set(1-g-v,v,g)}}(),containsPoint:function(){var e=new ft;return function(t,r,n,i){var o=an.barycoordFromPoint(t,r,n,i,e);return o.x>=0&&o.y>=0&&o.x+o.y<=1}}()}),Object.assign(an.prototype,{set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,n){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new ft,t=new ft;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){return(e||new ft).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return an.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new Cr).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return an.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return an.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e=new Cr,t=[new on,new on,new on],r=new ft,n=new ft;return function(i,o){var a=o||new ft,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(i,r),!0===this.containsPoint(r))a.copy(r);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var l=0;l<t.length;l++){t[l].closestPointToPoint(r,!0,n);var u=r.distanceToSquared(n);u<s&&(s=u,a.copy(n))}}return a}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),sn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:sn,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return Ir.prototype.copy.call(this,e),this.drawMode=e.drawMode,void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this},updateMorphTargets:function(){var e,t,r,n=this.geometry;if(n.isBufferGeometry){var i=n.morphAttributes,o=Object.keys(i);if(o.length>0){var a=i[o[0]];if(void 0!==a)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=a.length;e<t;e++)r=a[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=e}}else{var s=n.morphTargets;if(void 0!==s&&s.length>0)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=s.length;e<t;e++)r=s[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=e}},raycast:function(){var e=new pt,t=new nn,r=new Sr,n=new ft,i=new ft,o=new ft,a=new ft,s=new ft,l=new ft,u=new ht,c=new ht,h=new ht,p=new ft,d=new ft,f=new ft;function m(e,t,r,n,i,o,a){return an.barycoordFromPoint(e,t,r,n,p),i.multiplyScalar(p.x),o.multiplyScalar(p.y),a.multiplyScalar(p.z),i.add(o).add(a),i.clone()}function y(e,t,r,n,i,o,a,s){if(null===(t.side===g?n.intersectTriangle(a,o,i,!0,s):n.intersectTriangle(i,o,a,t.side!==v,s)))return null;f.copy(s),f.applyMatrix4(e.matrixWorld);var l=r.ray.origin.distanceTo(f);return l<r.near||l>r.far?null:{distance:l,point:f.clone(),object:e}}function b(e,t,r,a,s,l,p,f){n.fromBufferAttribute(a,l),i.fromBufferAttribute(a,p),o.fromBufferAttribute(a,f);var g=y(e,e.material,t,r,n,i,o,d);return g&&(s&&(u.fromBufferAttribute(s,l),c.fromBufferAttribute(s,p),h.fromBufferAttribute(s,f),g.uv=m(d,n,i,o,u,c,h)),g.face=new kr(l,p,f,an.normal(n,i,o)),g.faceIndex=l),g}return function(p,f){var g,v=this.geometry,w=this.material,x=this.matrixWorld;if(void 0!==w&&(null===v.boundingSphere&&v.computeBoundingSphere(),r.copy(v.boundingSphere),r.applyMatrix4(x),!1!==p.ray.intersectsSphere(r)&&(e.getInverse(x),t.copy(p.ray).applyMatrix4(e),null===v.boundingBox||!1!==t.intersectsBox(v.boundingBox))))if(v.isBufferGeometry){var _,S,C,M,T,A=v.index,E=v.attributes.position,P=v.attributes.uv;if(null!==A)for(M=0,T=A.count;M<T;M+=3)_=A.getX(M),S=A.getX(M+1),C=A.getX(M+2),(g=b(this,p,t,E,P,_,S,C))&&(g.faceIndex=Math.floor(M/3),f.push(g));else if(void 0!==E)for(M=0,T=E.count;M<T;M+=3)(g=b(this,p,t,E,P,_=M,S=M+1,C=M+2))&&(g.index=_,f.push(g))}else if(v.isGeometry){var R,I,N,D,k=Array.isArray(w),O=v.vertices,F=v.faces,L=v.faceVertexUvs[0];L.length>0&&(D=L);for(var U=0,V=F.length;U<V;U++){var B=F[U],z=k?w[B.materialIndex]:w;if(void 0!==z){if(R=O[B.a],I=O[B.b],N=O[B.c],!0===z.morphTargets){var j=v.morphTargets,H=this.morphTargetInfluences;n.set(0,0,0),i.set(0,0,0),o.set(0,0,0);for(var $=0,G=j.length;$<G;$++){var W=H[$];if(0!==W){var q=j[$].vertices;n.addScaledVector(a.subVectors(q[B.a],R),W),i.addScaledVector(s.subVectors(q[B.b],I),W),o.addScaledVector(l.subVectors(q[B.c],N),W)}}n.add(R),i.add(I),o.add(N),R=n,I=i,N=o}if(g=y(this,z,p,t,R,I,N,d)){if(D&&D[U]){var X=D[U];u.copy(X[0]),c.copy(X[1]),h.copy(X[2]),g.uv=m(d,R,I,N,u,c,h)}g.face=B,g.faceIndex=U,f.push(g)}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}});var fn=0;function mn(e){switch(e){case tt:return["Linear","( value )"];case rt:return["sRGB","( value )"];case it:return["RGBE","( value )"];case ot:return["RGBM","( value, 7.0 )"];case at:return["RGBM","( value, 16.0 )"];case st:return["RGBD","( value, 256.0 )"];case nt:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function gn(e,t){var r=mn(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function vn(e){return""!==e}function yn(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function bn(e){return e.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,function(e,t){var r=pr[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return bn(r)})}function wn(e){return e.replace(/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function(e,t,r,n){for(var i="",o=parseInt(t);o<parseInt(r);o++)i+=n.replace(/\[ i \]/g,"[ "+o+" ]");return i})}function xn(e,t,r,n,i,o){var a=e.context,s=n.defines,l=i.vertexShader,u=i.fragmentShader,c="SHADOWMAP_TYPE_BASIC";o.shadowMapType===d?c="SHADOWMAP_TYPE_PCF":o.shadowMapType===f&&(c="SHADOWMAP_TYPE_PCF_SOFT");var h="ENVMAP_TYPE_CUBE",p="ENVMAP_MODE_REFLECTION",m="ENVMAP_BLENDING_MULTIPLY";if(o.envMap){switch(n.envMap.mapping){case oe:case ae:h="ENVMAP_TYPE_CUBE";break;case ce:case he:h="ENVMAP_TYPE_CUBE_UV";break;case se:case le:h="ENVMAP_TYPE_EQUIREC";break;case ue:h="ENVMAP_TYPE_SPHERE"}switch(n.envMap.mapping){case ae:case le:p="ENVMAP_MODE_REFRACTION"}switch(n.combine){case Z:m="ENVMAP_BLENDING_MULTIPLY";break;case J:m="ENVMAP_BLENDING_MIX";break;case Q:m="ENVMAP_BLENDING_ADD"}}var g,v,y=e.gammaFactor>0?e.gammaFactor:1,b=function(e,t,r){return[(e=e||{}).derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&r.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&r.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&r.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(vn).join("\n")}(n.extensions,o,t),w=function(e){var t=[];for(var r in e){var n=e[r];!1!==n&&t.push("#define "+r+" "+n)}return t.join("\n")}(s),x=a.createProgram();n.isRawShaderMaterial?((g=[w].filter(vn).join("\n")).length>0&&(g+="\n"),(v=[b,w].filter(vn).join("\n")).length>0&&(v+="\n")):(g=["precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+i.name,w,o.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+y,"#define MAX_BONES "+o.maxBones,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+p:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.displacementMap&&o.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.flatShading?"#define FLAT_SHADED":"",o.skinning?"#define USE_SKINNING":"",o.useVertexTexture?"#define BONE_TEXTURE":"",o.morphTargets?"#define USE_MORPHTARGETS":"",o.morphNormals&&!1===o.flatShading?"#define USE_MORPHNORMALS":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+o.numClippingPlanes,o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+c:"",o.sizeAttenuation?"#define USE_SIZEATTENUATION":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(vn).join("\n"),v=[b,"precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+i.name,w,o.alphaTest?"#define ALPHATEST "+o.alphaTest:"","#define GAMMA_FACTOR "+y,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+h:"",o.envMap?"#define "+p:"",o.envMap?"#define "+m:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.gradientMap?"#define USE_GRADIENTMAP":"",o.flatShading?"#define FLAT_SHADED":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+o.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(o.numClippingPlanes-o.numClipIntersection),o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+c:"",o.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",o.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&t.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",o.envMap&&t.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",o.toneMapping!==ee?"#define TONE_MAPPING":"",o.toneMapping!==ee?pr.tonemapping_pars_fragment:"",o.toneMapping!==ee?function(e,t){var r;switch(t){case te:r="Linear";break;case re:r="Reinhard";break;case ne:r="Uncharted2";break;case ie:r="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}("toneMapping",o.toneMapping):"",o.dithering?"#define DITHERING":"",o.outputEncoding||o.mapEncoding||o.envMapEncoding||o.emissiveMapEncoding?pr.encodings_pars_fragment:"",o.mapEncoding?gn("mapTexelToLinear",o.mapEncoding):"",o.envMapEncoding?gn("envMapTexelToLinear",o.envMapEncoding):"",o.emissiveMapEncoding?gn("emissiveMapTexelToLinear",o.emissiveMapEncoding):"",o.outputEncoding?function(e,t){var r=mn(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}("linearToOutputTexel",o.outputEncoding):"",o.depthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(vn).join("\n")),l=yn(l=bn(l),o),u=yn(u=bn(u),o),n.isShaderMaterial||(l=wn(l),u=wn(u));var _=g+l,S=v+u,C=dn(a,a.VERTEX_SHADER,_),M=dn(a,a.FRAGMENT_SHADER,S);a.attachShader(x,C),a.attachShader(x,M),void 0!==n.index0AttributeName?a.bindAttribLocation(x,0,n.index0AttributeName):!0===o.morphTargets&&a.bindAttribLocation(x,0,"position"),a.linkProgram(x);var T,A,E=a.getProgramInfoLog(x),P=a.getShaderInfoLog(C),R=a.getShaderInfoLog(M),I=!0,N=!0;return!1===a.getProgramParameter(x,a.LINK_STATUS)?(I=!1,console.error("THREE.WebGLProgram: shader error: ",a.getError(),"gl.VALIDATE_STATUS",a.getProgramParameter(x,a.VALIDATE_STATUS),"gl.getProgramInfoLog",E,P,R)):""!==E?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",E):""!==P&&""!==R||(N=!1),N&&(this.diagnostics={runnable:I,material:n,programLog:E,vertexShader:{log:P,prefix:g},fragmentShader:{log:R,prefix:v}}),a.deleteShader(C),a.deleteShader(M),this.getUniforms=function(){return void 0===T&&(T=new sr(a,x,e)),T},this.getAttributes=function(){return void 0===A&&(A=function(e,t){for(var r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;i++){var o=e.getActiveAttrib(t,i).name;r[o]=e.getAttribLocation(t,o)}return r}(a,x)),A},this.destroy=function(){a.deleteProgram(x),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=fn++,this.code=r,this.usedTimes=1,this.program=x,this.vertexShader=C,this.fragmentShader=M,this}function _n(e,t,r){var n=[],i={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow"},o=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];function a(e,t){var r;return e?e.isTexture?r=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),r=e.texture.encoding):r=tt,r===tt&&t&&(r=nt),r}this.getParameters=function(t,n,o,s,l,u,c){var h=i[t.type],p=c.isSkinnedMesh?function(e){var t=e.skeleton.bones;if(r.floatVertexTextures)return 1024;var n=r.maxVertexUniforms,i=Math.floor((n-20)/4),o=Math.min(i,t.length);return o<t.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+t.length+" bones. This GPU supports "+o+"."),0):o}(c):0,d=r.precision;null!==t.precision&&(d=r.getMaxPrecision(t.precision))!==t.precision&&console.warn("THREE.WebGLProgram.getParameters:",t.precision,"not supported, using",d,"instead.");var f=e.getRenderTarget();return{shaderID:h,precision:d,supportsVertexTextures:r.vertexTextures,outputEncoding:a(f?f.texture:null,e.gammaOutput),map:!!t.map,mapEncoding:a(t.map,e.gammaInput),envMap:!!t.envMap,envMapMode:t.envMap&&t.envMap.mapping,envMapEncoding:a(t.envMap,e.gammaInput),envMapCubeUV:!!t.envMap&&(t.envMap.mapping===ce||t.envMap.mapping===he),lightMap:!!t.lightMap,aoMap:!!t.aoMap,emissiveMap:!!t.emissiveMap,emissiveMapEncoding:a(t.emissiveMap,e.gammaInput),bumpMap:!!t.bumpMap,normalMap:!!t.normalMap,displacementMap:!!t.displacementMap,roughnessMap:!!t.roughnessMap,metalnessMap:!!t.metalnessMap,specularMap:!!t.specularMap,alphaMap:!!t.alphaMap,gradientMap:!!t.gradientMap,combine:t.combine,vertexColors:t.vertexColors,fog:!!s,useFog:t.fog,fogExp:s&&s.isFogExp2,flatShading:t.flatShading,sizeAttenuation:t.sizeAttenuation,logarithmicDepthBuffer:r.logarithmicDepthBuffer,skinning:t.skinning&&p>0,maxBones:p,useVertexTexture:r.floatVertexTextures,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:n.directional.length,numPointLights:n.point.length,numSpotLights:n.spot.length,numRectAreaLights:n.rectArea.length,numHemiLights:n.hemi.length,numClippingPlanes:l,numClipIntersection:u,dithering:t.dithering,shadowMapEnabled:e.shadowMap.enabled&&c.receiveShadow&&o.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:t.premultipliedAlpha,alphaTest:t.alphaTest,doubleSided:t.side===v,flipSided:t.side===g,depthPacking:void 0!==t.depthPacking&&t.depthPacking}},this.getProgramCode=function(t,r){var n=[];if(r.shaderID?n.push(r.shaderID):(n.push(t.fragmentShader),n.push(t.vertexShader)),void 0!==t.defines)for(var i in t.defines)n.push(i),n.push(t.defines[i]);for(var a=0;a<o.length;a++)n.push(r[o[a]]);return n.push(t.onBeforeCompile.toString()),n.push(e.gammaOutput),n.join()},this.acquireProgram=function(r,i,o,a){for(var s,l=0,u=n.length;l<u;l++){var c=n[l];if(c.code===a){++(s=c).usedTimes;break}}return void 0===s&&(s=new xn(e,t,a,r,i,o),n.push(s)),s},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=n.indexOf(e);n[t]=n[n.length-1],n.pop(),e.destroy()}},this.programs=n}function Sn(e,t,r,n,i,o,a){var s="undefined"!=typeof WebGL2RenderingContext&&e instanceof window.WebGL2RenderingContext;function l(e,t){if(e.width>t||e.height>t){var r=t/Math.max(e.width,e.height),n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return n.width=Math.floor(e.width*r),n.height=Math.floor(e.height*r),n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+n.width+"x"+n.height,e),n}return e}function u(e){return ct.isPowerOfTwo(e.width)&&ct.isPowerOfTwo(e.height)}function c(e,t){return e.generateMipmaps&&t&&e.minFilter!==ge&&e.minFilter!==be}function h(t){return t===ge||t===ve||t===ye?e.NEAREST:e.LINEAR}function p(t){var r=t.target;r.removeEventListener("dispose",p),function(t){var r=n.get(t);if(t.image&&r.__image__webglTextureCube)e.deleteTexture(r.__image__webglTextureCube);else{if(void 0===r.__webglInit)return;e.deleteTexture(r.__webglTexture)}n.remove(t)}(r),a.textures--}function d(t){var r=t.target;r.removeEventListener("dispose",d),function(t){var r=n.get(t),i=n.get(t.texture);if(!t)return;void 0!==i.__webglTexture&&e.deleteTexture(i.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLRenderTargetCube)for(var o=0;o<6;o++)e.deleteFramebuffer(r.__webglFramebuffer[o]),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[o]);else e.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer);n.remove(t.texture),n.remove(t)}(r),a.textures--}function f(t,h){var d=n.get(t);if(t.version>0&&d.__version!==t.version){var f=t.image;if(void 0===f)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==f.complete)return void function(t,n,h){void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",p),t.__webglTexture=e.createTexture(),a.textures++);r.activeTexture(e.TEXTURE0+h),r.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment);var d=l(n.image,i.maxTextureSize);(function(e){return e.wrapS!==de||e.wrapT!==de||e.minFilter!==ge&&e.minFilter!==be})(n)&&!1===u(d)&&(d=function(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageBitmap){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.width=ct.floorPowerOfTwo(e.width),t.height=ct.floorPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}(d));var f=u(d),g=o.convert(n.format),v=o.convert(n.type);m(e.TEXTURE_2D,n,f);var y,b=n.mipmaps;if(n.isDepthTexture){var w=e.DEPTH_COMPONENT;if(n.type===Ee){if(!s)throw new Error("Float Depth Texture only supported in WebGL2.0");w=e.DEPTH_COMPONENT32F}else s&&(w=e.DEPTH_COMPONENT16);n.format===Ve&&w===e.DEPTH_COMPONENT&&n.type!==Me&&n.type!==Ae&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=Me,v=o.convert(n.type)),n.format===Be&&(w=e.DEPTH_STENCIL,n.type!==De&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=De,v=o.convert(n.type))),r.texImage2D(e.TEXTURE_2D,0,w,d.width,d.height,0,g,v,null)}else if(n.isDataTexture)if(b.length>0&&f){for(var x=0,_=b.length;x<_;x++)y=b[x],r.texImage2D(e.TEXTURE_2D,x,g,y.width,y.height,0,g,v,y.data);n.generateMipmaps=!1}else r.texImage2D(e.TEXTURE_2D,0,g,d.width,d.height,0,g,v,d.data);else if(n.isCompressedTexture)for(var x=0,_=b.length;x<_;x++)y=b[x],n.format!==Fe&&n.format!==Oe?r.getCompressedTextureFormats().indexOf(g)>-1?r.compressedTexImage2D(e.TEXTURE_2D,x,g,y.width,y.height,0,y.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):r.texImage2D(e.TEXTURE_2D,x,g,y.width,y.height,0,g,v,y.data);else if(b.length>0&&f){for(var x=0,_=b.length;x<_;x++)y=b[x],r.texImage2D(e.TEXTURE_2D,x,g,g,v,y);n.generateMipmaps=!1}else r.texImage2D(e.TEXTURE_2D,0,g,g,v,d);c(n,f)&&e.generateMipmap(e.TEXTURE_2D);t.__version=n.version,n.onUpdate&&n.onUpdate(n)}(d,t,h);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}r.activeTexture(e.TEXTURE0+h),r.bindTexture(e.TEXTURE_2D,d.__webglTexture)}function m(r,a,s){var l;if(s?(e.texParameteri(r,e.TEXTURE_WRAP_S,o.convert(a.wrapS)),e.texParameteri(r,e.TEXTURE_WRAP_T,o.convert(a.wrapT)),e.texParameteri(r,e.TEXTURE_MAG_FILTER,o.convert(a.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,o.convert(a.minFilter))):(e.texParameteri(r,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(r,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.wrapS===de&&a.wrapT===de||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",a),e.texParameteri(r,e.TEXTURE_MAG_FILTER,h(a.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,h(a.minFilter)),a.minFilter!==ge&&a.minFilter!==be&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",a)),l=t.get("EXT_texture_filter_anisotropic")){if(a.type===Ee&&null===t.get("OES_texture_float_linear"))return;if(a.type===Pe&&null===t.get("OES_texture_half_float_linear"))return;(a.anisotropy>1||n.get(a).__currentAnisotropy)&&(e.texParameterf(r,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,i.getMaxAnisotropy())),n.get(a).__currentAnisotropy=a.anisotropy)}}function g(t,i,a,s){var l=o.convert(i.texture.format),u=o.convert(i.texture.type);r.texImage2D(s,0,l,i.width,i.height,0,l,u,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,a,s,n.get(i.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function v(t,r){e.bindRenderbuffer(e.RENDERBUFFER,t),r.depthBuffer&&!r.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):r.depthBuffer&&r.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,r.width,r.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function y(t){var r=n.get(t),i=!0===t.isWebGLRenderTargetCube;if(t.depthTexture){if(i)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),f(r.depthTexture,0);var i=n.get(r.depthTexture).__webglTexture;if(r.depthTexture.format===Ve)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0);else{if(r.depthTexture.format!==Be)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,i,0)}}(r.__webglFramebuffer,t)}else if(i){r.__webglDepthbuffer=[];for(var o=0;o<6;o++)e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[o]),r.__webglDepthbuffer[o]=e.createRenderbuffer(),v(r.__webglDepthbuffer[o],t)}else e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),v(r.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}this.setTexture2D=f,this.setTextureCube=function(t,s){var h=n.get(t);if(6===t.image.length)if(t.version>0&&h.__version!==t.version){h.__image__webglTextureCube||(t.addEventListener("dispose",p),h.__image__webglTextureCube=e.createTexture(),a.textures++),r.activeTexture(e.TEXTURE0+s),r.bindTexture(e.TEXTURE_CUBE_MAP,h.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var d=t&&t.isCompressedTexture,f=t.image[0]&&t.image[0].isDataTexture,g=[],v=0;v<6;v++)g[v]=d||f?f?t.image[v].image:t.image[v]:l(t.image[v],i.maxCubemapSize);var y=u(g[0]),b=o.convert(t.format),w=o.convert(t.type);for(m(e.TEXTURE_CUBE_MAP,t,y),v=0;v<6;v++)if(d)for(var x,_=g[v].mipmaps,S=0,C=_.length;S<C;S++)x=_[S],t.format!==Fe&&t.format!==Oe?r.getCompressedTextureFormats().indexOf(b)>-1?r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,S,b,x.width,x.height,0,x.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,S,b,x.width,x.height,0,b,w,x.data);else f?r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,b,g[v].width,g[v].height,0,b,w,g[v].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,b,b,w,g[v]);c(t,y)&&e.generateMipmap(e.TEXTURE_CUBE_MAP),h.__version=t.version,t.onUpdate&&t.onUpdate(t)}else r.activeTexture(e.TEXTURE0+s),r.bindTexture(e.TEXTURE_CUBE_MAP,h.__image__webglTextureCube)},this.setTextureCubeDynamic=function(t,i){r.activeTexture(e.TEXTURE0+i),r.bindTexture(e.TEXTURE_CUBE_MAP,n.get(t).__webglTexture)},this.setupRenderTarget=function(t){var i=n.get(t),o=n.get(t.texture);t.addEventListener("dispose",d),o.__webglTexture=e.createTexture(),a.textures++;var s=!0===t.isWebGLRenderTargetCube,l=u(t);if(s){i.__webglFramebuffer=[];for(var h=0;h<6;h++)i.__webglFramebuffer[h]=e.createFramebuffer()}else i.__webglFramebuffer=e.createFramebuffer();if(s){for(r.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture),m(e.TEXTURE_CUBE_MAP,t.texture,l),h=0;h<6;h++)g(i.__webglFramebuffer[h],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+h);c(t.texture,l)&&e.generateMipmap(e.TEXTURE_CUBE_MAP),r.bindTexture(e.TEXTURE_CUBE_MAP,null)}else r.bindTexture(e.TEXTURE_2D,o.__webglTexture),m(e.TEXTURE_2D,t.texture,l),g(i.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),c(t.texture,l)&&e.generateMipmap(e.TEXTURE_2D),r.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&y(t)},this.updateRenderTargetMipmap=function(t){var i=t.texture;if(c(i,u(t))){var o=t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,a=n.get(i).__webglTexture;r.bindTexture(o,a),e.generateMipmap(o),r.bindTexture(o,null)}}}function Cn(e,t,r,n){Nr.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==r?r:.1,this.far=void 0!==n?n:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function Mn(e){Cn.call(this),this.cameras=e||[]}function Tn(e){console.log("THREE.WebGLRenderer",l);var t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),r=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,i=void 0===e.depth||e.depth,o=void 0===e.stencil||e.stencil,a=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,d=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,f=[],m=[],b=null,w=[],Z=[];this.domElement=t,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=te,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var J,Q,ee,re,ne,ie,oe,ae,se,le,ue,ce,he,me,Ye,Ze,tt,rt,nt,it=this,ot=!1,at=null,st=null,lt=-1,ut="",ht=null,dt=null,gt=new yt,vt=new yt,bt=null,wt=0,_t=t.width,St=t.height,Ct=1,Mt=new yt(0,0,_t,St),Tt=new yt(0,0,_t,St),At=!1,Et=new Mr,Pt=new function(){var e=this,t=null,r=0,n=!1,i=!1,o=new Cr,a=new mt,s={value:null,needsUpdate:!1};function l(){s.value!==t&&(s.value=t,s.needsUpdate=r>0),e.numPlanes=r,e.numIntersection=0}function u(t,r,n,i){var l=null!==t?t.length:0,u=null;if(0!==l){if(u=s.value,!0!==i||null===u){var c=n+4*l,h=r.matrixWorldInverse;a.getNormalMatrix(h),(null===u||u.length<c)&&(u=new Float32Array(c));for(var p=0,d=n;p!==l;++p,d+=4)o.copy(t[p]).applyMatrix4(h,a),o.normal.toArray(u,d),u[d+3]=o.constant}s.value=u,s.needsUpdate=!0}return e.numPlanes=l,u}this.uniform=s,this.numPlanes=0,this.numIntersection=0,this.init=function(e,i,o){var a=0!==e.length||i||0!==r||n;return n=i,t=u(e,o,0),r=e.length,a},this.beginShadows=function(){i=!0,u(null)},this.endShadows=function(){i=!1,l()},this.setState=function(e,o,a,c,h,p){if(!n||null===e||0===e.length||i&&!a)i?u(null):l();else{var d=i?0:r,f=4*d,m=h.clippingState||null;s.value=m,m=u(e,c,f,p);for(var g=0;g!==f;++g)m[g]=t[g];h.clippingState=m,this.numIntersection=o?this.numPlanes:0,this.numPlanes+=d}}},Rt=!1,It=!1,Nt=new pt,Dt=new ft,kt={geometries:0,textures:0},Ot={frame:0,calls:0,vertices:0,faces:0,points:0};function Ft(){return null===at?Ct:1}this.info={render:Ot,memory:kt,programs:null};try{var Lt={alpha:n,depth:i,stencil:o,antialias:a,premultipliedAlpha:s,preserveDrawingBuffer:d};if(null===(J=r||t.getContext("webgl",Lt)||t.getContext("experimental-webgl",Lt)))throw null!==t.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===J.getShaderPrecisionFormat&&(J.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),t.addEventListener("webglcontextlost",zt,!1),t.addEventListener("webglcontextrestored",jt,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}function Ut(){(Q=new function(e){var t={};return{get:function(r){if(void 0!==t[r])return t[r];var n;switch(r){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":n=e.getExtension("WEBGL_compressed_texture_etc1");break;default:n=e.getExtension(r)}return null===n&&console.warn("THREE.WebGLRenderer: "+r+" extension not supported."),t[r]=n,n}}}(J)).get("WEBGL_depth_texture"),Q.get("OES_texture_float"),Q.get("OES_texture_float_linear"),Q.get("OES_texture_half_float"),Q.get("OES_texture_half_float_linear"),Q.get("OES_standard_derivatives"),Q.get("OES_element_index_uint"),Q.get("ANGLE_instanced_arrays"),nt=new function(e,t){return{convert:function(r){var n;if(r===pe)return e.REPEAT;if(r===de)return e.CLAMP_TO_EDGE;if(r===fe)return e.MIRRORED_REPEAT;if(r===ge)return e.NEAREST;if(r===ve)return e.NEAREST_MIPMAP_NEAREST;if(r===ye)return e.NEAREST_MIPMAP_LINEAR;if(r===be)return e.LINEAR;if(r===we)return e.LINEAR_MIPMAP_NEAREST;if(r===xe)return e.LINEAR_MIPMAP_LINEAR;if(r===_e)return e.UNSIGNED_BYTE;if(r===Re)return e.UNSIGNED_SHORT_4_4_4_4;if(r===Ie)return e.UNSIGNED_SHORT_5_5_5_1;if(r===Ne)return e.UNSIGNED_SHORT_5_6_5;if(r===Se)return e.BYTE;if(r===Ce)return e.SHORT;if(r===Me)return e.UNSIGNED_SHORT;if(r===Te)return e.INT;if(r===Ae)return e.UNSIGNED_INT;if(r===Ee)return e.FLOAT;if(r===Pe&&null!==(n=t.get("OES_texture_half_float")))return n.HALF_FLOAT_OES;if(r===ke)return e.ALPHA;if(r===Oe)return e.RGB;if(r===Fe)return e.RGBA;if(r===Le)return e.LUMINANCE;if(r===Ue)return e.LUMINANCE_ALPHA;if(r===Ve)return e.DEPTH_COMPONENT;if(r===Be)return e.DEPTH_STENCIL;if(r===A)return e.FUNC_ADD;if(r===E)return e.FUNC_SUBTRACT;if(r===P)return e.FUNC_REVERSE_SUBTRACT;if(r===N)return e.ZERO;if(r===D)return e.ONE;if(r===k)return e.SRC_COLOR;if(r===O)return e.ONE_MINUS_SRC_COLOR;if(r===F)return e.SRC_ALPHA;if(r===L)return e.ONE_MINUS_SRC_ALPHA;if(r===U)return e.DST_ALPHA;if(r===V)return e.ONE_MINUS_DST_ALPHA;if(r===B)return e.DST_COLOR;if(r===z)return e.ONE_MINUS_DST_COLOR;if(r===j)return e.SRC_ALPHA_SATURATE;if((r===ze||r===je||r===He||r===$e)&&null!==(n=t.get("WEBGL_compressed_texture_s3tc"))){if(r===ze)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(r===je)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(r===He)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(r===$e)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((r===Ge||r===We||r===qe||r===Xe)&&null!==(n=t.get("WEBGL_compressed_texture_pvrtc"))){if(r===Ge)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(r===We)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(r===qe)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(r===Xe)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(r===Ke&&null!==(n=t.get("WEBGL_compressed_texture_etc1")))return n.COMPRESSED_RGB_ETC1_WEBGL;if((r===R||r===I)&&null!==(n=t.get("EXT_blend_minmax"))){if(r===R)return n.MIN_EXT;if(r===I)return n.MAX_EXT}return r===De&&null!==(n=t.get("WEBGL_depth_texture"))?n.UNSIGNED_INT_24_8_WEBGL:0}}}(J,Q),ee=new function(e,t,r){var n;function i(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var o=void 0!==r.precision?r.precision:"highp",a=i(o);a!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",a,"instead."),o=a);var s=!0===r.logarithmicDepthBuffer,l=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),c=e.getParameter(e.MAX_TEXTURE_SIZE),h=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),p=e.getParameter(e.MAX_VERTEX_ATTRIBS),d=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),f=e.getParameter(e.MAX_VARYING_VECTORS),m=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),g=u>0,v=!!t.get("OES_texture_float");return{getMaxAnisotropy:function(){if(void 0!==n)return n;var r=t.get("EXT_texture_filter_anisotropic");return n=null!==r?e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:i,precision:o,logarithmicDepthBuffer:s,maxTextures:l,maxVertexTextures:u,maxTextureSize:c,maxCubemapSize:h,maxAttributes:p,maxVertexUniforms:d,maxVaryings:f,maxFragmentUniforms:m,vertexTextures:g,floatFragmentTextures:v,floatVertexTextures:g&&v}}(J,Q,e),(re=new function(e,t,r){var n=new function(){var t=!1,r=new yt,n=null,i=new yt(0,0,0,0);return{setMask:function(r){n===r||t||(e.colorMask(r,r,r,r),n=r)},setLocked:function(e){t=e},setClear:function(t,n,o,a,s){!0===s&&(t*=a,n*=a,o*=a),r.set(t,n,o,a),!1===i.equals(r)&&(e.clearColor(t,n,o,a),i.copy(r))},reset:function(){t=!1,n=null,i.set(-1,0,0,0)}}},i=new function(){var t=!1,r=null,n=null,i=null;return{setTest:function(t){t?ee(e.DEPTH_TEST):te(e.DEPTH_TEST)},setMask:function(n){r===n||t||(e.depthMask(n),r=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case H:e.depthFunc(e.NEVER);break;case $:e.depthFunc(e.ALWAYS);break;case G:e.depthFunc(e.LESS);break;case W:e.depthFunc(e.LEQUAL);break;case q:e.depthFunc(e.EQUAL);break;case X:e.depthFunc(e.GEQUAL);break;case K:e.depthFunc(e.GREATER);break;case Y:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);n=t}},setLocked:function(e){t=e},setClear:function(t){i!==t&&(e.clearDepth(t),i=t)},reset:function(){t=!1,r=null,n=null,i=null}}},o=new function(){var t=!1,r=null,n=null,i=null,o=null,a=null,s=null,l=null,u=null;return{setTest:function(t){t?ee(e.STENCIL_TEST):te(e.STENCIL_TEST)},setMask:function(n){r===n||t||(e.stencilMask(n),r=n)},setFunc:function(t,r,a){n===t&&i===r&&o===a||(e.stencilFunc(t,r,a),n=t,i=r,o=a)},setOp:function(t,r,n){a===t&&s===r&&l===n||(e.stencilOp(t,r,n),a=t,s=r,l=n)},setLocked:function(e){t=e},setClear:function(t){u!==t&&(e.clearStencil(t),u=t)},reset:function(){t=!1,r=null,n=null,i=null,o=null,a=null,s=null,l=null,u=null}}},a=e.getParameter(e.MAX_VERTEX_ATTRIBS),s=new Uint8Array(a),l=new Uint8Array(a),p=new Uint8Array(a),d={},f=null,m=null,y=null,b=null,w=null,A=null,E=null,P=null,R=null,I=!1,N=null,D=null,k=null,O=null,F=null,L=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),U=parseFloat(/^WebGL\ ([0-9])/.exec(e.getParameter(e.VERSION))[1]),V=parseFloat(U)>=1,B=null,z={},j=new yt,Z=new yt;function J(t,r,n){var i=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var a=0;a<n;a++)e.texImage2D(r+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,i);return o}var Q={};function ee(t){!0!==d[t]&&(e.enable(t),d[t]=!0)}function te(t){!1!==d[t]&&(e.disable(t),d[t]=!1)}function re(t,n,i,o,a,s,l,u){if(t!==x?ee(e.BLEND):te(e.BLEND),t!==T){if(t!==y||u!==I)switch(t){case S:u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE));break;case C:u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR));break;case M:u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR));break;default:u?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA))}b=null,w=null,A=null,E=null,P=null,R=null}else a=a||n,s=s||i,l=l||o,n===b&&a===E||(e.blendEquationSeparate(r.convert(n),r.convert(a)),b=n,E=a),i===w&&o===A&&s===P&&l===R||(e.blendFuncSeparate(r.convert(i),r.convert(o),r.convert(s),r.convert(l)),w=i,A=o,P=s,R=l);y=t,I=u}function ne(t){N!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),N=t)}function ie(t){t!==u?(ee(e.CULL_FACE),t!==D&&(t===c?e.cullFace(e.BACK):t===h?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):te(e.CULL_FACE),D=t}function oe(t,r,n){t?(ee(e.POLYGON_OFFSET_FILL),O===r&&F===n||(e.polygonOffset(r,n),O=r,F=n)):te(e.POLYGON_OFFSET_FILL)}function ae(t){void 0===t&&(t=e.TEXTURE0+L-1),B!==t&&(e.activeTexture(t),B=t)}return Q[e.TEXTURE_2D]=J(e.TEXTURE_2D,e.TEXTURE_2D,1),Q[e.TEXTURE_CUBE_MAP]=J(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),n.setClear(0,0,0,1),i.setClear(1),o.setClear(0),ee(e.DEPTH_TEST),i.setFunc(W),ne(!1),ie(c),ee(e.CULL_FACE),ee(e.BLEND),re(_),{buffers:{color:n,depth:i,stencil:o},initAttributes:function(){for(var e=0,t=s.length;e<t;e++)s[e]=0},enableAttribute:function(r){s[r]=1,0===l[r]&&(e.enableVertexAttribArray(r),l[r]=1),0!==p[r]&&(t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(r,0),p[r]=0)},enableAttributeAndDivisor:function(r,n){s[r]=1,0===l[r]&&(e.enableVertexAttribArray(r),l[r]=1),p[r]!==n&&(t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(r,n),p[r]=n)},disableUnusedAttributes:function(){for(var t=0,r=l.length;t!==r;++t)l[t]!==s[t]&&(e.disableVertexAttribArray(t),l[t]=0)},enable:ee,disable:te,getCompressedTextureFormats:function(){if(null===f&&(f=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var r=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),n=0;n<r.length;n++)f.push(r[n]);return f},useProgram:function(t){return m!==t&&(e.useProgram(t),m=t,!0)},setBlending:re,setMaterial:function(t){t.side===v?te(e.CULL_FACE):ee(e.CULL_FACE),ne(t.side===g),!0===t.transparent?re(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha):re(x),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),n.setMask(t.colorWrite),oe(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:ne,setCullFace:ie,setLineWidth:function(t){t!==k&&(V&&e.lineWidth(t),k=t)},setPolygonOffset:oe,setScissorTest:function(t){t?ee(e.SCISSOR_TEST):te(e.SCISSOR_TEST)},activeTexture:ae,bindTexture:function(t,r){null===B&&ae();var n=z[B];void 0===n&&(n={type:void 0,texture:void 0},z[B]=n),n.type===t&&n.texture===r||(e.bindTexture(t,r||Q[t]),n.type=t,n.texture=r)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===j.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),j.copy(t))},viewport:function(t){!1===Z.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),Z.copy(t))},reset:function(){for(var t=0;t<l.length;t++)1===l[t]&&(e.disableVertexAttribArray(t),l[t]=0);d={},f=null,B=null,z={},m=null,y=null,N=null,D=null,n.reset(),i.reset(),o.reset()}}}(J,Q,nt)).scissor(vt.copy(Tt).multiplyScalar(Ct)),re.viewport(gt.copy(Mt).multiplyScalar(Ct)),ne=new function(){var e={};return{get:function(t){var r=t.uuid,n=e[r];return void 0===n&&(n={},e[r]=n),n},remove:function(t){delete e[t.uuid]},clear:function(){e={}}}},ie=new Sn(J,Q,re,ne,ee,nt,kt),oe=new Ar(J),ae=new function(e,t,r){var n={},i={};function o(e){var a=e.target,s=n[a.id];for(var l in null!==s.index&&t.remove(s.index),s.attributes)t.remove(s.attributes[l]);a.removeEventListener("dispose",o),delete n[a.id];var u=i[a.id];u&&(t.remove(u),delete i[a.id]),(u=i[s.id])&&(t.remove(u),delete i[s.id]),r.geometries--}return{get:function(e,t){var i=n[t.id];return i||(t.addEventListener("dispose",o),t.isBufferGeometry?i=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Yr).setFromObject(e)),i=t._bufferGeometry),n[t.id]=i,r.geometries++,i)},update:function(r){var n=r.index,i=r.attributes;for(var o in null!==n&&t.update(n,e.ELEMENT_ARRAY_BUFFER),i)t.update(i[o],e.ARRAY_BUFFER);var a=r.morphAttributes;for(var o in a)for(var s=a[o],l=0,u=s.length;l<u;l++)t.update(s[l],e.ARRAY_BUFFER)},getWireframeAttribute:function(r){var n=i[r.id];if(n)return n;var o,a=[],s=r.index,l=r.attributes;if(null!==s)for(var u=0,c=(o=s.array).length;u<c;u+=3){var h=o[u+0],p=o[u+1],d=o[u+2];a.push(h,p,p,d,d,h)}else for(u=0,c=(o=l.position.array).length/3-1;u<c;u+=3)h=u+0,p=u+1,d=u+2,a.push(h,p,p,d,d,h);return n=new(Xr(a)>65535?$r:jr)(a,1),t.update(n,e.ELEMENT_ARRAY_BUFFER),i[r.id]=n,n}}}(J,oe,kt),se=new function(e,t){var r={};return{update:function(n){var i=t.frame,o=n.geometry,a=e.get(n,o);return r[a.id]!==i&&(o.isGeometry&&a.updateFromObject(n),e.update(a),r[a.id]=i),a},clear:function(){r={}}}}(ae,Ot),me=new function(e){var t={},r=new Float32Array(8);return{update:function(n,i,o,a){var s=n.morphTargetInfluences,l=s.length,u=t[i.id];if(void 0===u){u=[];for(var c=0;c<l;c++)u[c]=[c,0];t[i.id]=u}var h=o.morphTargets&&i.morphAttributes.position,p=o.morphNormals&&i.morphAttributes.normal;for(c=0;c<l;c++)0!==(d=u[c])[1]&&(h&&i.removeAttribute("morphTarget"+c),p&&i.removeAttribute("morphNormal"+c));for(c=0;c<l;c++)(d=u[c])[0]=c,d[1]=s[c];for(u.sort(hn),c=0;c<8;c++){var d;if(d=u[c]){var f=d[0],m=d[1];if(m){h&&i.addAttribute("morphTarget"+c,h[f]),p&&i.addAttribute("morphNormal"+c,p[f]),r[c]=m;continue}}r[c]=0}a.getUniforms().setValue(e,"morphTargetInfluences",r)}}}(J),ue=new _n(it,Q,ee),le=new pn,ce=new cn,he=new function(e,t,r,n){var i,o,a,s=new ur(0),l=0;function u(e,r){t.buffers.color.setClear(e.r,e.g,e.b,r,n)}return{getClearColor:function(){return s},setClearColor:function(e,t){s.set(e),u(s,l=void 0!==t?t:1)},getClearAlpha:function(){return l},setClearAlpha:function(e){u(s,l=e)},render:function(t,n,c,h){var p=n.background;null===p?u(s,l):p&&p.isColor&&(u(p,1),h=!0),(e.autoClear||h)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),p&&p.isCubeTexture?(void 0===a&&((a=new sn(new Jr(1,1,1),new rn({uniforms:dr.cube.uniforms,vertexShader:dr.cube.vertexShader,fragmentShader:dr.cube.fragmentShader,side:g,depthTest:!0,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),a.geometry.removeAttribute("uv"),a.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},r.update(a.geometry)),a.material.uniforms.tCube.value=p,t.push(a,a.geometry,a.material,0,null)):p&&p.isTexture&&(void 0===i&&(i=new Dr(-1,1,1,-1,0,1),o=new sn(new en(2,2),new tn({depthTest:!1,depthWrite:!1,fog:!1})),r.update(o.geometry)),o.material.map=p,e.renderBufferDirect(i,null,o.geometry,o.material,o,null))}}}(it,re,ae,s),Ye=new function(e,t,r){var n;this.setMode=function(e){n=e},this.render=function(t,i){e.drawArrays(n,t,i),r.calls++,r.vertices+=i,n===e.TRIANGLES?r.faces+=i/3:n===e.POINTS&&(r.points+=i)},this.renderInstances=function(i,o,a){var s=t.get("ANGLE_instanced_arrays");if(null!==s){var l=i.attributes.position;l.isInterleavedBufferAttribute?(a=l.data.count,s.drawArraysInstancedANGLE(n,0,a,i.maxInstancedCount)):s.drawArraysInstancedANGLE(n,o,a,i.maxInstancedCount),r.calls++,r.vertices+=a*i.maxInstancedCount,n===e.TRIANGLES?r.faces+=i.maxInstancedCount*a/3:n===e.POINTS&&(r.points+=i.maxInstancedCount*a)}else console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}(J,Q,Ot),Ze=new function(e,t,r){var n,i,o;this.setMode=function(e){n=e},this.setIndex=function(e){i=e.type,o=e.bytesPerElement},this.render=function(t,a){e.drawElements(n,a,i,t*o),r.calls++,r.vertices+=a,n===e.TRIANGLES?r.faces+=a/3:n===e.POINTS&&(r.points+=a)},this.renderInstances=function(a,s,l){var u=t.get("ANGLE_instanced_arrays");null!==u?(u.drawElementsInstancedANGLE(n,l,i,s*o,a.maxInstancedCount),r.calls++,r.vertices+=l*a.maxInstancedCount,n===e.TRIANGLES?r.faces+=a.maxInstancedCount*l/3:n===e.POINTS&&(r.points+=a.maxInstancedCount*l)):console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}(J,Q,Ot),tt=new mr(it,J,re,ie,ee),rt=new vr(it,J,re,ie,ee),it.info.programs=ue.programs,it.context=J,it.capabilities=ee,it.extensions=Q,it.properties=ne,it.renderLists=ce,it.state=re}Ut();var Vt=new function(e){var t=this,r=null,n=null;"undefined"!=typeof window&&"VRFrameData"in window&&(n=new window.VRFrameData);var i=new pt,o=new pt,a=new pt,s=new Cn;s.bounds=new yt(0,0,.5,1),s.layers.enable(1);var l=new Cn;l.bounds=new yt(.5,0,.5,1),l.layers.enable(2);var u,c,h=new Mn([s,l]);function p(){if(null!==r&&r.isPresenting){var n=r.getEyeParameters("left"),i=n.renderWidth,o=n.renderHeight;c=e.getPixelRatio(),u=e.getSize(),e.setDrawingBufferSize(2*i,o,1)}else t.enabled&&e.setDrawingBufferSize(u.width,u.height,c)}h.layers.enable(1),h.layers.enable(2),"undefined"!=typeof window&&window.addEventListener("vrdisplaypresentchange",p,!1),this.enabled=!1,this.standing=!1,this.getDevice=function(){return r},this.setDevice=function(e){void 0!==e&&(r=e)},this.getCamera=function(e){if(null===r)return e;r.depthNear=e.near,r.depthFar=e.far,r.getFrameData(n);var t=n.pose;null!==t.position?e.position.fromArray(t.position):e.position.set(0,0,0),null!==t.orientation&&e.quaternion.fromArray(t.orientation),e.updateMatrixWorld();var u=r.stageParameters;if(this.standing&&u&&(o.fromArray(u.sittingToStandingTransform),a.getInverse(o),e.matrixWorld.multiply(o),e.matrixWorldInverse.multiply(a)),!1===r.isPresenting)return e;s.near=e.near,l.near=e.near,s.far=e.far,l.far=e.far,h.matrixWorld.copy(e.matrixWorld),h.matrixWorldInverse.copy(e.matrixWorldInverse),s.matrixWorldInverse.fromArray(n.leftViewMatrix),l.matrixWorldInverse.fromArray(n.rightViewMatrix),this.standing&&u&&(s.matrixWorldInverse.multiply(a),l.matrixWorldInverse.multiply(a));var c=e.parent;null!==c&&(i.getInverse(c.matrixWorld),s.matrixWorldInverse.multiply(i),l.matrixWorldInverse.multiply(i)),s.matrixWorld.getInverse(s.matrixWorldInverse),l.matrixWorld.getInverse(l.matrixWorldInverse),s.projectionMatrix.fromArray(n.leftProjectionMatrix),l.projectionMatrix.fromArray(n.rightProjectionMatrix),h.projectionMatrix.copy(s.projectionMatrix);var p=r.getLayers();if(p.length){var d=p[0];null!==d.leftBounds&&4===d.leftBounds.length&&s.bounds.fromArray(d.leftBounds),null!==d.rightBounds&&4===d.rightBounds.length&&l.bounds.fromArray(d.rightBounds)}return h},this.getStandingMatrix=function(){return o},this.submitFrame=function(){r&&r.isPresenting&&r.submitFrame()},this.dispose=function(){"undefined"!=typeof window&&window.removeEventListener("vrdisplaypresentchange",p)}}(it);this.vr=Vt;var Bt=new Tr(it,se,ee.maxTextureSize);function zt(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),ot=!0}function jt(){console.log("THREE.WebGLRenderer: Context Restored."),ot=!1,Ut()}function Ht(e){var t=e.target;t.removeEventListener("dispose",Ht),function(e){$t(e),ne.remove(e)}(t)}function $t(e){var t=ne.get(e).program;e.program=void 0,void 0!==t&&ue.releaseProgram(t)}this.shadowMap=Bt,this.getContext=function(){return J},this.getContextAttributes=function(){return J.getContextAttributes()},this.forceContextLoss=function(){var e=Q.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=Q.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return Ct},this.setPixelRatio=function(e){void 0!==e&&(Ct=e,this.setSize(_t,St,!1))},this.getSize=function(){return{width:_t,height:St}},this.setSize=function(e,r,n){var i=Vt.getDevice();i&&i.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(_t=e,St=r,t.width=e*Ct,t.height=r*Ct,!1!==n&&(t.style.width=e+"px",t.style.height=r+"px"),this.setViewport(0,0,e,r))},this.getDrawingBufferSize=function(){return{width:_t*Ct,height:St*Ct}},this.setDrawingBufferSize=function(e,r,n){_t=e,St=r,Ct=n,t.width=e*n,t.height=r*n,this.setViewport(0,0,e,r)},this.setViewport=function(e,t,r,n){Mt.set(e,St-t-n,r,n),re.viewport(gt.copy(Mt).multiplyScalar(Ct))},this.setScissor=function(e,t,r,n){Tt.set(e,St-t-n,r,n),re.scissor(vt.copy(Tt).multiplyScalar(Ct))},this.setScissorTest=function(e){re.setScissorTest(At=e)},this.getClearColor=function(){return he.getClearColor()},this.setClearColor=function(){he.setClearColor.apply(he,arguments)},this.getClearAlpha=function(){return he.getClearAlpha()},this.setClearAlpha=function(){he.setClearAlpha.apply(he,arguments)},this.clear=function(e,t,r){var n=0;(void 0===e||e)&&(n|=J.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=J.DEPTH_BUFFER_BIT),(void 0===r||r)&&(n|=J.STENCIL_BUFFER_BIT),J.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,r,n){this.setRenderTarget(e),this.clear(t,r,n)},this.dispose=function(){t.removeEventListener("webglcontextlost",zt,!1),t.removeEventListener("webglcontextrestored",jt,!1),ce.dispose(),Vt.dispose()},this.renderBufferImmediate=function(e,t,r){re.initAttributes();var n=ne.get(e);e.hasPositions&&!n.position&&(n.position=J.createBuffer()),e.hasNormals&&!n.normal&&(n.normal=J.createBuffer()),e.hasUvs&&!n.uv&&(n.uv=J.createBuffer()),e.hasColors&&!n.color&&(n.color=J.createBuffer());var i=t.getAttributes();if(e.hasPositions&&(J.bindBuffer(J.ARRAY_BUFFER,n.position),J.bufferData(J.ARRAY_BUFFER,e.positionArray,J.DYNAMIC_DRAW),re.enableAttribute(i.position),J.vertexAttribPointer(i.position,3,J.FLOAT,!1,0,0)),e.hasNormals){if(J.bindBuffer(J.ARRAY_BUFFER,n.normal),!r.isMeshPhongMaterial&&!r.isMeshStandardMaterial&&!r.isMeshNormalMaterial&&!0===r.flatShading)for(var o=0,a=3*e.count;o<a;o+=9){var s=e.normalArray,l=(s[o+0]+s[o+3]+s[o+6])/3,u=(s[o+1]+s[o+4]+s[o+7])/3,c=(s[o+2]+s[o+5]+s[o+8])/3;s[o+0]=l,s[o+1]=u,s[o+2]=c,s[o+3]=l,s[o+4]=u,s[o+5]=c,s[o+6]=l,s[o+7]=u,s[o+8]=c}J.bufferData(J.ARRAY_BUFFER,e.normalArray,J.DYNAMIC_DRAW),re.enableAttribute(i.normal),J.vertexAttribPointer(i.normal,3,J.FLOAT,!1,0,0)}e.hasUvs&&r.map&&(J.bindBuffer(J.ARRAY_BUFFER,n.uv),J.bufferData(J.ARRAY_BUFFER,e.uvArray,J.DYNAMIC_DRAW),re.enableAttribute(i.uv),J.vertexAttribPointer(i.uv,2,J.FLOAT,!1,0,0)),e.hasColors&&r.vertexColors!==y&&(J.bindBuffer(J.ARRAY_BUFFER,n.color),J.bufferData(J.ARRAY_BUFFER,e.colorArray,J.DYNAMIC_DRAW),re.enableAttribute(i.color),J.vertexAttribPointer(i.color,3,J.FLOAT,!1,0,0)),re.disableUnusedAttributes(),J.drawArrays(J.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,r,n,i,o){re.setMaterial(n);var a=Zt(e,t,n,i),s=r.id+"_"+a.id+"_"+(!0===n.wireframe),l=!1;s!==ut&&(ut=s,l=!0),i.morphTargetInfluences&&(me.update(i,r,n,a),l=!0);var u,c=r.index,h=r.attributes.position,p=1;!0===n.wireframe&&(c=ae.getWireframeAttribute(r),p=2);var d=Ye;null!==c&&(u=oe.get(c),(d=Ze).setIndex(u)),l&&(!function(e,t,r,n){if(r&&r.isInstancedBufferGeometry&&null===Q.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===n&&(n=0);re.initAttributes();var i=r.attributes,o=t.getAttributes(),a=e.defaultAttributeValues;for(var s in o){var l=o[s];if(l>=0){var u=i[s];if(void 0!==u){var c=u.normalized,h=u.itemSize,p=oe.get(u);if(void 0===p)continue;var d=p.buffer,f=p.type,m=p.bytesPerElement;if(u.isInterleavedBufferAttribute){var g=u.data,v=g.stride,y=u.offset;g&&g.isInstancedInterleavedBuffer?(re.enableAttributeAndDivisor(l,g.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=g.meshPerAttribute*g.count)):re.enableAttribute(l),J.bindBuffer(J.ARRAY_BUFFER,d),J.vertexAttribPointer(l,h,f,c,v*m,(n*v+y)*m)}else u.isInstancedBufferAttribute?(re.enableAttributeAndDivisor(l,u.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=u.meshPerAttribute*u.count)):re.enableAttribute(l),J.bindBuffer(J.ARRAY_BUFFER,d),J.vertexAttribPointer(l,h,f,c,0,n*h*m)}else if(void 0!==a){var b=a[s];if(void 0!==b)switch(b.length){case 2:J.vertexAttrib2fv(l,b);break;case 3:J.vertexAttrib3fv(l,b);break;case 4:J.vertexAttrib4fv(l,b);break;default:J.vertexAttrib1fv(l,b)}}}}re.disableUnusedAttributes()}(n,a,r),null!==c&&J.bindBuffer(J.ELEMENT_ARRAY_BUFFER,u.buffer));var f=0;null!==c?f=c.count:void 0!==h&&(f=h.count);var m=r.drawRange.start*p,g=r.drawRange.count*p,v=null!==o?o.start*p:0,y=null!==o?o.count*p:1/0,b=Math.max(m,v),w=Math.min(f,m+g,v+y)-1,x=Math.max(0,w-b+1);if(0!==x){if(i.isMesh)if(!0===n.wireframe)re.setLineWidth(n.wireframeLinewidth*Ft()),d.setMode(J.LINES);else switch(i.drawMode){case Je:d.setMode(J.TRIANGLES);break;case Qe:d.setMode(J.TRIANGLE_STRIP);break;case et:d.setMode(J.TRIANGLE_FAN)}else if(i.isLine){var _=n.linewidth;void 0===_&&(_=1),re.setLineWidth(_*Ft()),i.isLineSegments?d.setMode(J.LINES):i.isLineLoop?d.setMode(J.LINE_LOOP):d.setMode(J.LINE_STRIP)}else i.isPoints&&d.setMode(J.POINTS);r&&r.isInstancedBufferGeometry?r.maxInstancedCount>0&&d.renderInstances(r,b,x):d.render(b,x)}},this.compile=function(e,t){f.length=0,m.length=0,e.traverse(function(e){e.isLight&&(f.push(e),e.castShadow&&m.push(e))}),le.setup(f,m,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var r=0;r<t.material.length;r++)Yt(t.material[r],e.fog,t);else Yt(t.material,e.fog,t)})};var Gt=!1,Wt=null;function qt(e){null!==Wt&&Wt(e);var t=Vt.getDevice();t&&t.isPresenting?t.requestAnimationFrame(qt):window.requestAnimationFrame(qt)}function Xt(e,t,r,n){for(var i=0,o=e.length;i<o;i++){var a=e[i],s=a.object,l=a.geometry,u=void 0===n?a.material:n,c=a.group;if(r.isArrayCamera){dt=r;for(var h=r.cameras,p=0,d=h.length;p<d;p++){var f=h[p];if(s.layers.test(f.layers)){var m=f.bounds,g=m.x*_t,v=m.y*St,y=m.z*_t,b=m.w*St;re.viewport(gt.set(g,v,y,b).multiplyScalar(Ct)),Kt(s,t,f,l,u,c)}}}else dt=null,Kt(s,t,r,l,u,c)}}function Kt(e,t,r,n,i,o){if(e.onBeforeRender(it,t,r,n,i,o),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){re.setMaterial(i);var a=Zt(r,t.fog,i,e);ut="",function(e,t,r){e.render(function(e){it.renderBufferImmediate(e,t,r)})}(e,a,i)}else it.renderBufferDirect(r,t.fog,n,i,e,o);e.onAfterRender(it,t,r,n,i,o)}function Yt(e,t,r){var n=ne.get(e),i=ue.getParameters(e,le.state,m,t,Pt.numPlanes,Pt.numIntersection,r),o=ue.getProgramCode(e,i),a=n.program,s=!0;if(void 0===a)e.addEventListener("dispose",Ht);else if(a.code!==o)$t(e);else{if(void 0!==i.shaderID)return;s=!1}if(s){if(i.shaderID){var l=dr[i.shaderID];n.shader={name:e.type,uniforms:hr.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader}}else n.shader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.onBeforeCompile(n.shader),a=ue.acquireProgram(e,n.shader,i,o),n.program=a,e.program=a}var u=a.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var c=0;c<it.maxMorphTargets;c++)u["morphTarget"+c]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(c=0;c<it.maxMorphNormals;c++)u["morphNormal"+c]>=0&&e.numSupportedMorphNormals++}var h=n.shader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=Pt.numPlanes,n.numIntersection=Pt.numIntersection,h.clippingPlanes=Pt.uniform),n.fog=t,n.lightsHash=le.state.hash,e.lights&&(h.ambientLightColor.value=le.state.ambient,h.directionalLights.value=le.state.directional,h.spotLights.value=le.state.spot,h.rectAreaLights.value=le.state.rectArea,h.pointLights.value=le.state.point,h.hemisphereLights.value=le.state.hemi,h.directionalShadowMap.value=le.state.directionalShadowMap,h.directionalShadowMatrix.value=le.state.directionalShadowMatrix,h.spotShadowMap.value=le.state.spotShadowMap,h.spotShadowMatrix.value=le.state.spotShadowMatrix,h.pointShadowMap.value=le.state.pointShadowMap,h.pointShadowMatrix.value=le.state.pointShadowMatrix);var p=n.program.getUniforms(),d=sr.seqWithValue(p.seq,h);n.uniformsList=d}function Zt(e,t,r,n){wt=0;var i=ne.get(r);if(Rt&&(It||e!==ht)){var o=e===ht&&r.id===lt;Pt.setState(r.clippingPlanes,r.clipIntersection,r.clipShadows,e,i,o)}!1===r.needsUpdate&&(void 0===i.program?r.needsUpdate=!0:r.fog&&i.fog!==t?r.needsUpdate=!0:r.lights&&i.lightsHash!==le.state.hash?r.needsUpdate=!0:void 0===i.numClippingPlanes||i.numClippingPlanes===Pt.numPlanes&&i.numIntersection===Pt.numIntersection||(r.needsUpdate=!0)),r.needsUpdate&&(Yt(r,t,n),r.needsUpdate=!1);var a=!1,s=!1,l=!1,u=i.program,c=u.getUniforms(),h=i.shader.uniforms;if(re.useProgram(u.program)&&(a=!0,s=!0,l=!0),r.id!==lt&&(lt=r.id,s=!0),a||e!==ht){if(c.setValue(J,"projectionMatrix",e.projectionMatrix),ee.logarithmicDepthBuffer&&c.setValue(J,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),ht!==(dt||e)&&(ht=dt||e,s=!0,l=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.envMap){var p=c.map.cameraPosition;void 0!==p&&p.setValue(J,Dt.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.skinning)&&c.setValue(J,"viewMatrix",e.matrixWorldInverse)}if(r.skinning){c.setOptional(J,n,"bindMatrix"),c.setOptional(J,n,"bindMatrixInverse");var d=n.skeleton;if(d){var f=d.bones;if(ee.floatVertexTextures){if(void 0===d.boneTexture){var m=Math.sqrt(4*f.length);m=ct.ceilPowerOfTwo(m),m=Math.max(m,4);var g=new Float32Array(m*m*4);g.set(d.boneMatrices);var v=new xt(g,m,m,Fe,Ee);d.boneMatrices=g,d.boneTexture=v,d.boneTextureSize=m}c.setValue(J,"boneTexture",d.boneTexture),c.setValue(J,"boneTextureSize",d.boneTextureSize)}else c.setOptional(J,d,"boneMatrices")}}return s&&(c.setValue(J,"toneMappingExposure",it.toneMappingExposure),c.setValue(J,"toneMappingWhitePoint",it.toneMappingWhitePoint),r.lights&&function(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}(h,l),t&&r.fog&&function(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}(h,t),r.isMeshBasicMaterial?Jt(h,r):r.isMeshLambertMaterial?(Jt(h,r),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(h,r)):r.isMeshPhongMaterial?(Jt(h,r),r.isMeshToonMaterial?function(e,t){Qt(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(h,r):Qt(h,r)):r.isMeshStandardMaterial?(Jt(h,r),r.isMeshPhysicalMaterial?function(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,er(e,t)}(h,r):er(h,r)):r.isMeshDepthMaterial?(Jt(h,r),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(h,r)):r.isMeshDistanceMaterial?(Jt(h,r),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(h,r)):r.isMeshNormalMaterial?(Jt(h,r),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale);t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale));t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(h,r)):r.isLineBasicMaterial?(function(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}(h,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(h,r)):r.isPointsMaterial?function(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*Ct,e.scale.value=.5*St,e.map.value=t.map,null!==t.map){if(!0===t.map.matrixAutoUpdate){var r=t.map.offset,n=t.map.repeat,i=t.map.rotation,o=t.map.center;t.map.matrix.setUvTransform(r.x,r.y,n.x,n.y,i,o.x,o.y)}e.uvTransform.value.copy(t.map.matrix)}}(h,r):r.isShadowMaterial&&(h.color.value=r.color,h.opacity.value=r.opacity),void 0!==h.ltcMat&&(h.ltcMat.value=cr.LTC_MAT_TEXTURE),void 0!==h.ltcMag&&(h.ltcMag.value=cr.LTC_MAG_TEXTURE),sr.upload(J,i.uniformsList,h,it)),c.setValue(J,"modelViewMatrix",n.modelViewMatrix),c.setValue(J,"normalMatrix",n.normalMatrix),c.setValue(J,"modelMatrix",n.matrixWorld),u}function Jt(e,t){var r;if(e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity),t.map?r=t.map:t.specularMap?r=t.specularMap:t.displacementMap?r=t.displacementMap:t.normalMap?r=t.normalMap:t.bumpMap?r=t.bumpMap:t.roughnessMap?r=t.roughnessMap:t.metalnessMap?r=t.metalnessMap:t.alphaMap?r=t.alphaMap:t.emissiveMap&&(r=t.emissiveMap),void 0!==r){if(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate){var n=r.offset,i=r.repeat,o=r.rotation,a=r.center;r.matrix.setUvTransform(n.x,n.y,i.x,i.y,o,a.x,a.y)}e.uvTransform.value.copy(r.matrix)}}function Qt(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function er(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}this.animate=function(e){Wt=e,function(){if(!Gt){var e=Vt.getDevice();e&&e.isPresenting?e.requestAnimationFrame(qt):window.requestAnimationFrame(qt),Gt=!0}}()},this.render=function(e,t,r,n){if(t&&t.isCamera){if(!ot){ut="",lt=-1,ht=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),Vt.enabled&&(t=Vt.getCamera(t)),Nt.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),Et.setFromMatrix(Nt),f.length=0,m.length=0,w.length=0,Z.length=0,It=this.localClippingEnabled,Rt=Pt.init(this.clippingPlanes,It,t),(b=ce.get(e,t)).init(),function e(t,r,n){if(!1===t.visible)return;var i=t.layers.test(r.layers);if(i)if(t.isLight)f.push(t),t.castShadow&&m.push(t);else if(t.isSprite)t.frustumCulled&&!Et.intersectsSprite(t)||w.push(t);else if(t.isLensFlare)Z.push(t);else if(t.isImmediateRenderObject)n&&Dt.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Nt),b.push(t,null,t.material,Dt.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.update(),!t.frustumCulled||Et.intersectsObject(t))){n&&Dt.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Nt);var o=se.update(t),a=t.material;if(Array.isArray(a))for(var s=o.groups,l=0,u=s.length;l<u;l++){var c=s[l],h=a[c.materialIndex];h&&h.visible&&b.push(t,o,h,Dt.z,c)}else a.visible&&b.push(t,o,a,Dt.z,null)}var p=t.children;for(var l=0,u=p.length;l<u;l++)e(p[l],r,n)}(e,t,it.sortObjects),!0===it.sortObjects&&b.sort(),Rt&&Pt.beginShadows(),Bt.render(m,e,t),le.setup(f,m,t),Rt&&Pt.endShadows(),Ot.frame++,Ot.calls=0,Ot.vertices=0,Ot.faces=0,Ot.points=0,void 0===r&&(r=null),this.setRenderTarget(r),he.render(b,e,t,n);var i=b.opaque,o=b.transparent;if(e.overrideMaterial){var a=e.overrideMaterial;i.length&&Xt(i,e,t,a),o.length&&Xt(o,e,t,a)}else i.length&&Xt(i,e,t),o.length&&Xt(o,e,t);rt.render(w,e,t),tt.render(Z,e,t,gt),r&&ie.updateRenderTargetMipmap(r),re.buffers.depth.setTest(!0),re.buffers.depth.setMask(!0),re.buffers.color.setMask(!0),re.setPolygonOffset(!1),Vt.enabled&&Vt.submitFrame()}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFaceCulling=function(e,t){re.setCullFace(e),re.setFlipSided(t===p)},this.allocTextureUnit=function(){var e=wt;return e>=ee.maxTextures&&console.warn("THREE.WebGLRenderer: Trying to use "+e+" texture units while this GPU supports only "+ee.maxTextures),wt+=1,e},this.setTexture2D=function(){var e=!1;return function(t,r){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),ie.setTexture2D(t,r)}}(),this.setTexture=function(){var e=!1;return function(t,r){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),ie.setTexture2D(t,r)}}(),this.setTextureCube=function(){var e=!1;return function(t,r){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?ie.setTextureCube(t,r):ie.setTextureCubeDynamic(t,r)}}(),this.getRenderTarget=function(){return at},this.setRenderTarget=function(e){at=e,e&&void 0===ne.get(e).__webglFramebuffer&&ie.setupRenderTarget(e);var t=null,r=!1;if(e){var n=ne.get(e).__webglFramebuffer;e.isWebGLRenderTargetCube?(t=n[e.activeCubeFace],r=!0):t=n,gt.copy(e.viewport),vt.copy(e.scissor),bt=e.scissorTest}else gt.copy(Mt).multiplyScalar(Ct),vt.copy(Tt).multiplyScalar(Ct),bt=At;if(st!==t&&(J.bindFramebuffer(J.FRAMEBUFFER,t),st=t),re.viewport(gt),re.scissor(vt),re.setScissorTest(bt),r){var i=ne.get(e.texture);J.framebufferTexture2D(J.FRAMEBUFFER,J.COLOR_ATTACHMENT0,J.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,i.__webglTexture,e.activeMipMapLevel)}},this.readRenderTargetPixels=function(e,t,r,n,i,o){if(e&&e.isWebGLRenderTarget){var a=ne.get(e).__webglFramebuffer;if(a){var s=!1;a!==st&&(J.bindFramebuffer(J.FRAMEBUFFER,a),s=!0);try{var l=e.texture,u=l.format,c=l.type;if(u!==Fe&&nt.convert(u)!==J.getParameter(J.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(c===_e||nt.convert(c)===J.getParameter(J.IMPLEMENTATION_COLOR_READ_TYPE)||c===Ee&&(Q.get("OES_texture_float")||Q.get("WEBGL_color_buffer_float"))||c===Pe&&Q.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");J.checkFramebufferStatus(J.FRAMEBUFFER)===J.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-n&&r>=0&&r<=e.height-i&&J.readPixels(t,r,n,i,nt.convert(u),nt.convert(c),o):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&J.bindFramebuffer(J.FRAMEBUFFER,st)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}}function An(e,t){this.name="",this.color=new ur(e),this.density=void 0!==t?t:25e-5}function En(e,t,r){this.name="",this.color=new ur(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3}function Pn(){Ir.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function Rn(e,t,r,n,i){Ir.call(this),this.lensFlares=[],this.positionScreen=new ft,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,r,n,i)}function In(e){br.call(this),this.type="SpriteMaterial",this.color=new ur(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Nn(e){Ir.call(this),this.type="Sprite",this.material=void 0!==e?e:new In}function Dn(){Ir.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function kn(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var r=0,n=this.bones.length;r<n;r++)this.boneInverses.push(new pt)}}function On(){Ir.call(this),this.type="Bone"}function Fn(e,t){sn.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new pt,this.bindMatrixInverse=new pt;var r=new kn(this.initBones());this.bind(r,this.matrixWorld),this.normalizeSkinWeights()}function Ln(e){br.call(this),this.type="LineBasicMaterial",this.color=new ur(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function Un(e,t,r){if(1===r)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new Vn(e,t);Ir.call(this),this.type="Line",this.geometry=void 0!==e?e:new Yr,this.material=void 0!==t?t:new Ln({color:16777215*Math.random()})}function Vn(e,t){Un.call(this,e,t),this.type="LineSegments"}function Bn(e,t){Un.call(this,e,t),this.type="LineLoop"}function zn(e){br.call(this),this.type="PointsMaterial",this.color=new ur(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=!1,this.setValues(e)}function jn(e,t){Ir.call(this),this.type="Points",this.geometry=void 0!==e?e:new Yr,this.material=void 0!==t?t:new zn({color:16777215*Math.random()})}function Hn(){Ir.call(this),this.type="Group"}function $n(e,t,r,n,i,o,a,s,l){vt.call(this,e,t,r,n,i,o,a,s,l),this.generateMipmaps=!1;var u=this;requestAnimationFrame(function e(){var t=u.image;t.readyState>=t.HAVE_CURRENT_DATA&&(u.needsUpdate=!0),requestAnimationFrame(e)})}function Gn(e,t,r,n,i,o,a,s,l,u,c,h){vt.call(this,null,o,a,s,l,u,n,i,c,h),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function Wn(e,t,r,n,i,o,a,s,l,u){if((u=void 0!==u?u:Ve)!==Ve&&u!==Be)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===r&&u===Ve&&(r=Me),void 0===r&&u===Be&&(r=De),vt.call(this,null,n,i,o,a,s,u,r,l),this.image={width:e,height:t},this.magFilter=void 0!==a?a:ge,this.minFilter=void 0!==s?s:ge,this.flipY=!1,this.generateMipmaps=!1}function qn(e){Yr.call(this),this.type="WireframeGeometry";var t,r,n,i,o,a,s,l,u,c,h=[],p=[0,0],d={},f=["a","b","c"];if(e&&e.isGeometry){var m=e.faces;for(t=0,n=m.length;t<n;t++){var g=m[t];for(r=0;r<3;r++)s=g[f[r]],l=g[f[(r+1)%3]],p[0]=Math.min(s,l),p[1]=Math.max(s,l),void 0===d[u=p[0]+","+p[1]]&&(d[u]={index1:p[0],index2:p[1]})}for(u in d)a=d[u],c=e.vertices[a.index1],h.push(c.x,c.y,c.z),c=e.vertices[a.index2],h.push(c.x,c.y,c.z)}else if(e&&e.isBufferGeometry){var v,y,b,w,x,_,S;if(c=new ft,null!==e.index){for(v=e.attributes.position,y=e.index,0===(b=e.groups).length&&(b=[{start:0,count:y.count,materialIndex:0}]),i=0,o=b.length;i<o;++i)for(t=x=(w=b[i]).start,n=x+w.count;t<n;t+=3)for(r=0;r<3;r++)s=y.getX(t+r),l=y.getX(t+(r+1)%3),p[0]=Math.min(s,l),p[1]=Math.max(s,l),void 0===d[u=p[0]+","+p[1]]&&(d[u]={index1:p[0],index2:p[1]});for(u in d)a=d[u],c.fromBufferAttribute(v,a.index1),h.push(c.x,c.y,c.z),c.fromBufferAttribute(v,a.index2),h.push(c.x,c.y,c.z)}else for(t=0,n=(v=e.attributes.position).count/3;t<n;t++)for(r=0;r<3;r++)_=3*t+r,c.fromBufferAttribute(v,_),h.push(c.x,c.y,c.z),S=3*t+(r+1)%3,c.fromBufferAttribute(v,S),h.push(c.x,c.y,c.z)}this.addAttribute("position",new Gr(h,3))}function Xn(e,t,r){Fr.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r},this.fromBufferGeometry(new Kn(e,t,r)),this.mergeVertices()}function Kn(e,t,r){Yr.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:r};var n,i,o=[],a=[],s=[],l=[],u=new ft,c=new ft,h=new ft,p=new ft,d=new ft,f=t+1;for(n=0;n<=r;n++){var m=n/r;for(i=0;i<=t;i++){var g=i/t;c=e(g,m,c),a.push(c.x,c.y,c.z),g-1e-5>=0?(h=e(g-1e-5,m,h),p.subVectors(c,h)):(h=e(g+1e-5,m,h),p.subVectors(h,c)),m-1e-5>=0?(h=e(g,m-1e-5,h),d.subVectors(c,h)):(h=e(g,m+1e-5,h),d.subVectors(h,c)),u.crossVectors(p,d).normalize(),s.push(u.x,u.y,u.z),l.push(g,m)}}for(n=0;n<r;n++)for(i=0;i<t;i++){var v=n*f+i,y=n*f+i+1,b=(n+1)*f+i+1,w=(n+1)*f+i;o.push(v,y,w),o.push(y,b,w)}this.setIndex(o),this.addAttribute("position",new Gr(a,3)),this.addAttribute("normal",new Gr(s,3)),this.addAttribute("uv",new Gr(l,2))}function Yn(e,t,r,n){Fr.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n},this.fromBufferGeometry(new Zn(e,t,r,n)),this.mergeVertices()}function Zn(e,t,r,n){Yr.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n},r=r||1;var i=[],o=[];function a(e,t,r,n){var i,o,a=Math.pow(2,n),l=[];for(i=0;i<=a;i++){l[i]=[];var u=e.clone().lerp(r,i/a),c=t.clone().lerp(r,i/a),h=a-i;for(o=0;o<=h;o++)l[i][o]=0===o&&i===a?u:u.clone().lerp(c,o/h)}for(i=0;i<a;i++)for(o=0;o<2*(a-i)-1;o++){var p=Math.floor(o/2);o%2==0?(s(l[i][p+1]),s(l[i+1][p]),s(l[i][p])):(s(l[i][p+1]),s(l[i+1][p+1]),s(l[i+1][p]))}}function s(e){i.push(e.x,e.y,e.z)}function l(t,r){var n=3*t;r.x=e[n+0],r.y=e[n+1],r.z=e[n+2]}function u(e,t,r,n){n<0&&1===e.x&&(o[t]=e.x-1),0===r.x&&0===r.z&&(o[t]=n/2/Math.PI+.5)}function c(e){return Math.atan2(e.z,-e.x)}function h(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){for(var r=new ft,n=new ft,i=new ft,o=0;o<t.length;o+=3)l(t[o+0],r),l(t[o+1],n),l(t[o+2],i),a(r,n,i,e)}(n=n||0),function(e){for(var t=new ft,r=0;r<i.length;r+=3)t.x=i[r+0],t.y=i[r+1],t.z=i[r+2],t.normalize().multiplyScalar(e),i[r+0]=t.x,i[r+1]=t.y,i[r+2]=t.z}(r),function(){for(var e=new ft,t=0;t<i.length;t+=3){e.x=i[t+0],e.y=i[t+1],e.z=i[t+2];var r=c(e)/2/Math.PI+.5,n=h(e)/Math.PI+.5;o.push(r,1-n)}(function(){for(var e=new ft,t=new ft,r=new ft,n=new ft,a=new ht,s=new ht,l=new ht,h=0,p=0;h<i.length;h+=9,p+=6){e.set(i[h+0],i[h+1],i[h+2]),t.set(i[h+3],i[h+4],i[h+5]),r.set(i[h+6],i[h+7],i[h+8]),a.set(o[p+0],o[p+1]),s.set(o[p+2],o[p+3]),l.set(o[p+4],o[p+5]),n.copy(e).add(t).add(r).divideScalar(3);var d=c(n);u(a,p+0,e,d),u(s,p+2,t,d),u(l,p+4,r,d)}})(),function(){for(var e=0;e<o.length;e+=6){var t=o[e+0],r=o[e+2],n=o[e+4],i=Math.max(t,r,n),a=Math.min(t,r,n);i>.9&&a<.1&&(t<.2&&(o[e+0]+=1),r<.2&&(o[e+2]+=1),n<.2&&(o[e+4]+=1))}}()}(),this.addAttribute("position",new Gr(i,3)),this.addAttribute("normal",new Gr(i.slice(),3)),this.addAttribute("uv",new Gr(o,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}function Jn(e,t){Fr.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Qn(e,t)),this.mergeVertices()}function Qn(e,t){Zn.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ei(e,t){Fr.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new ti(e,t)),this.mergeVertices()}function ti(e,t){Zn.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ri(e,t){Fr.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new ni(e,t)),this.mergeVertices()}function ni(e,t){var r=(1+Math.sqrt(5))/2,n=[-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1];Zn.call(this,n,[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ii(e,t){Fr.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new oi(e,t)),this.mergeVertices()}function oi(e,t){var r=(1+Math.sqrt(5))/2,n=1/r,i=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-r,0,-n,r,0,n,-r,0,n,r,-n,-r,0,-n,r,0,n,-r,0,n,r,0,-r,0,-n,r,0,-n,-r,0,n,r,0,n];Zn.call(this,i,[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ai(e,t,r,n,i,o){Fr.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:n,closed:i},void 0!==o&&console.warn("THREE.TubeGeometry: taper has been removed.");var a=new si(e,t,r,n,i);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals,this.fromBufferGeometry(a),this.mergeVertices()}function si(e,t,r,n,i){Yr.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:n,closed:i},t=t||64,r=r||1,n=n||8,i=i||!1;var o=e.computeFrenetFrames(t,i);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;var a,s,l=new ft,u=new ft,c=new ht,h=new ft,p=[],d=[],f=[],m=[];function g(i){h=e.getPointAt(i/t,h);var a=o.normals[i],c=o.binormals[i];for(s=0;s<=n;s++){var f=s/n*Math.PI*2,m=Math.sin(f),g=-Math.cos(f);u.x=g*a.x+m*c.x,u.y=g*a.y+m*c.y,u.z=g*a.z+m*c.z,u.normalize(),d.push(u.x,u.y,u.z),l.x=h.x+r*u.x,l.y=h.y+r*u.y,l.z=h.z+r*u.z,p.push(l.x,l.y,l.z)}}!function(){for(a=0;a<t;a++)g(a);g(!1===i?t:0),function(){for(a=0;a<=t;a++)for(s=0;s<=n;s++)c.x=a/t,c.y=s/n,f.push(c.x,c.y)}(),function(){for(s=1;s<=t;s++)for(a=1;a<=n;a++){var e=(n+1)*(s-1)+(a-1),r=(n+1)*s+(a-1),i=(n+1)*s+a,o=(n+1)*(s-1)+a;m.push(e,r,o),m.push(r,i,o)}}()}(),this.setIndex(m),this.addAttribute("position",new Gr(p,3)),this.addAttribute("normal",new Gr(d,3)),this.addAttribute("uv",new Gr(f,2))}function li(e,t,r,n,i,o,a){Fr.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:i,q:o},void 0!==a&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new ui(e,t,r,n,i,o)),this.mergeVertices()}function ui(e,t,r,n,i,o){Yr.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:i,q:o},e=e||1,t=t||.4,r=Math.floor(r)||64,n=Math.floor(n)||8,i=i||2,o=o||3;var a,s,l=[],u=[],c=[],h=[],p=new ft,d=new ft,f=new ft,m=new ft,g=new ft,v=new ft,y=new ft;for(a=0;a<=r;++a){var b=a/r*i*Math.PI*2;for(A(b,i,o,e,f),A(b+.01,i,o,e,m),v.subVectors(m,f),y.addVectors(m,f),g.crossVectors(v,y),y.crossVectors(g,v),g.normalize(),y.normalize(),s=0;s<=n;++s){var w=s/n*Math.PI*2,x=-t*Math.cos(w),_=t*Math.sin(w);p.x=f.x+(x*y.x+_*g.x),p.y=f.y+(x*y.y+_*g.y),p.z=f.z+(x*y.z+_*g.z),u.push(p.x,p.y,p.z),d.subVectors(p,f).normalize(),c.push(d.x,d.y,d.z),h.push(a/r),h.push(s/n)}}for(s=1;s<=r;s++)for(a=1;a<=n;a++){var S=(n+1)*(s-1)+(a-1),C=(n+1)*s+(a-1),M=(n+1)*s+a,T=(n+1)*(s-1)+a;l.push(S,C,T),l.push(C,M,T)}function A(e,t,r,n,i){var o=Math.cos(e),a=Math.sin(e),s=r/t*e,l=Math.cos(s);i.x=n*(2+l)*.5*o,i.y=n*(2+l)*a*.5,i.z=n*Math.sin(s)*.5}this.setIndex(l),this.addAttribute("position",new Gr(u,3)),this.addAttribute("normal",new Gr(c,3)),this.addAttribute("uv",new Gr(h,2))}function ci(e,t,r,n,i){Fr.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:i},this.fromBufferGeometry(new hi(e,t,r,n,i)),this.mergeVertices()}function hi(e,t,r,n,i){Yr.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:i},e=e||1,t=t||.4,r=Math.floor(r)||8,n=Math.floor(n)||6,i=i||2*Math.PI;var o,a,s=[],l=[],u=[],c=[],h=new ft,p=new ft,d=new ft;for(o=0;o<=r;o++)for(a=0;a<=n;a++){var f=a/n*i,m=o/r*Math.PI*2;p.x=(e+t*Math.cos(m))*Math.cos(f),p.y=(e+t*Math.cos(m))*Math.sin(f),p.z=t*Math.sin(m),l.push(p.x,p.y,p.z),h.x=e*Math.cos(f),h.y=e*Math.sin(f),d.subVectors(p,h).normalize(),u.push(d.x,d.y,d.z),c.push(a/n),c.push(o/r)}for(o=1;o<=r;o++)for(a=1;a<=n;a++){var g=(n+1)*o+a-1,v=(n+1)*(o-1)+a-1,y=(n+1)*(o-1)+a,b=(n+1)*o+a;s.push(g,v,b),s.push(v,y,b)}this.setIndex(s),this.addAttribute("position",new Gr(l,3)),this.addAttribute("normal",new Gr(u,3)),this.addAttribute("uv",new Gr(c,2))}Cn.prototype=Object.assign(Object.create(Nr.prototype),{constructor:Cn,isPerspectiveCamera:!0,copy:function(e,t){return Nr.prototype.copy.call(this,e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*ct.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*ct.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*ct.RAD2DEG*Math.atan(Math.tan(.5*ct.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,r,n,i,o){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=i,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*ct.DEG2RAD*this.fov)/this.zoom,r=2*t,n=this.aspect*r,i=-.5*n,o=this.view;if(null!==this.view&&this.view.enabled){var a=o.fullWidth,s=o.fullHeight;i+=o.offsetX*n/a,t-=o.offsetY*r/s,n*=o.width/a,r*=o.height/s}var l=this.filmOffset;0!==l&&(i+=e*l/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+n,t,t-r,e,this.far)},toJSON:function(e){var t=Ir.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),Mn.prototype=Object.assign(Object.create(Cn.prototype),{constructor:Mn,isArrayCamera:!0}),An.prototype.isFogExp2=!0,An.prototype.clone=function(){return new An(this.color.getHex(),this.density)},An.prototype.toJSON=function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},En.prototype.isFog=!0,En.prototype.clone=function(){return new En(this.color.getHex(),this.near,this.far)},En.prototype.toJSON=function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},Pn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Pn,copy:function(e,t){return Ir.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=Ir.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),Rn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Rn,isLensFlare:!0,copy:function(e){Ir.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,r=e.lensFlares.length;t<r;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,r,n,i,o){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===o&&(o=1),void 0===i&&(i=new ur(16777215)),void 0===n&&(n=_),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:0,opacity:o,color:i,blending:n})},updateLensFlares:function(){var e,t,r=this.lensFlares.length,n=2*-this.positionScreen.x,i=2*-this.positionScreen.y;for(e=0;e<r;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+n*t.distance,t.y=this.positionScreen.y+i*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),In.prototype=Object.create(br.prototype),In.prototype.constructor=In,In.prototype.isSpriteMaterial=!0,In.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Nn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Nn,isSprite:!0,raycast:function(){var e=new ft,t=new ft,r=new ft;return function(n,i){t.setFromMatrixPosition(this.matrixWorld),n.ray.closestPointToPoint(t,e),r.setFromMatrixScale(this.matrixWorld);var o=r.x*r.y/4;if(!(t.distanceToSquared(e)>o)){var a=n.ray.origin.distanceTo(e);a<n.near||a>n.far||i.push({distance:a,point:e.clone(),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)}}),Dn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Dn,copy:function(e){Ir.prototype.copy.call(this,e,!1);for(var t=e.levels,r=0,n=t.length;r<n;r++){var i=t[r];this.addLevel(i.object.clone(),i.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var r=this.levels,n=0;n<r.length&&!(t<r[n].distance);n++);r.splice(n,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,r=1,n=t.length;r<n&&!(e<t[r].distance);r++);return t[r-1].object},raycast:function(){var e=new ft;return function(t,r){e.setFromMatrixPosition(this.matrixWorld);var n=t.ray.origin.distanceTo(e);this.getObjectForDistance(n).raycast(t,r)}}(),update:function(){var e=new ft,t=new ft;return function(r){var n=this.levels;if(n.length>1){e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var i=e.distanceTo(t);n[0].object.visible=!0;for(var o=1,a=n.length;o<a&&i>=n[o].distance;o++)n[o-1].object.visible=!1,n[o].object.visible=!0;for(;o<a;o++)n[o].object.visible=!1}}}(),toJSON:function(e){var t=Ir.prototype.toJSON.call(this,e);t.object.levels=[];for(var r=this.levels,n=0,i=r.length;n<i;n++){var o=r[n];t.object.levels.push({object:o.object.uuid,distance:o.distance})}return t}}),Object.assign(kn.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var r=new pt;this.bones[e]&&r.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(r)}},pose:function(){var e,t,r;for(t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:function(){var e=new pt,t=new pt;return function(){for(var r=this.bones,n=this.boneInverses,i=this.boneMatrices,o=this.boneTexture,a=0,s=r.length;a<s;a++){var l=r[a]?r[a].matrixWorld:t;e.multiplyMatrices(l,n[a]),e.toArray(i,16*a)}void 0!==o&&(o.needsUpdate=!0)}}(),clone:function(){return new kn(this.bones,this.boneInverses)}}),On.prototype=Object.assign(Object.create(Ir.prototype),{constructor:On,isBone:!0}),Fn.prototype=Object.assign(Object.create(sn.prototype),{constructor:Fn,isSkinnedMesh:!0,initBones:function(){var e,t,r,n,i=[];if(this.geometry&&void 0!==this.geometry.bones){for(r=0,n=this.geometry.bones.length;r<n;r++)t=this.geometry.bones[r],e=new On,i.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(r=0,n=this.geometry.bones.length;r<n;r++)-1!==(t=this.geometry.bones[r]).parent&&null!==t.parent&&void 0!==i[t.parent]?i[t.parent].add(i[r]):this.add(i[r])}return this.updateMatrixWorld(!0),i},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var r=this.geometry.skinWeights[t];(e=1/r.manhattanLength())!==1/0?r.multiplyScalar(e):r.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var n=new yt,i=this.geometry.attributes.skinWeight;for(t=0;t<i.count;t++)n.x=i.getX(t),n.y=i.getY(t),n.z=i.getZ(t),n.w=i.getW(t),(e=1/n.manhattanLength())!==1/0?n.multiplyScalar(e):n.set(1,0,0,0),i.setXYZW(t,n.x,n.y,n.z,n.w)}},updateMatrixWorld:function(e){sn.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Ln.prototype=Object.create(br.prototype),Ln.prototype.constructor=Ln,Ln.prototype.isLineBasicMaterial=!0,Ln.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},Un.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Un,isLine:!0,raycast:function(){var e=new pt,t=new nn,r=new Sr;return function(n,i){var o=n.linePrecision,a=o*o,s=this.geometry,l=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),r.copy(s.boundingSphere),r.applyMatrix4(l),!1!==n.ray.intersectsSphere(r)){e.getInverse(l),t.copy(n.ray).applyMatrix4(e);var u=new ft,c=new ft,h=new ft,p=new ft,d=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var f=s.index,m=s.attributes.position.array;if(null!==f)for(var g=f.array,v=0,y=g.length-1;v<y;v+=d){var b=g[v],w=g[v+1];if(u.fromArray(m,3*b),c.fromArray(m,3*w),!(t.distanceSqToSegment(u,c,p,h)>a))p.applyMatrix4(this.matrixWorld),(S=n.ray.origin.distanceTo(p))<n.near||S>n.far||i.push({distance:S,point:h.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}else for(v=0,y=m.length/3-1;v<y;v+=d){if(u.fromArray(m,3*v),c.fromArray(m,3*v+3),!(t.distanceSqToSegment(u,c,p,h)>a))p.applyMatrix4(this.matrixWorld),(S=n.ray.origin.distanceTo(p))<n.near||S>n.far||i.push({distance:S,point:h.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}else if(s.isGeometry){var x=s.vertices,_=x.length;for(v=0;v<_-1;v+=d){var S;if(!(t.distanceSqToSegment(x[v],x[v+1],p,h)>a))p.applyMatrix4(this.matrixWorld),(S=n.ray.origin.distanceTo(p))<n.near||S>n.far||i.push({distance:S,point:h.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Vn.prototype=Object.assign(Object.create(Un.prototype),{constructor:Vn,isLineSegments:!0}),Bn.prototype=Object.assign(Object.create(Un.prototype),{constructor:Bn,isLineLoop:!0}),zn.prototype=Object.create(br.prototype),zn.prototype.constructor=zn,zn.prototype.isPointsMaterial=!0,zn.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},jn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:jn,isPoints:!0,raycast:function(){var e=new pt,t=new nn,r=new Sr;return function(n,i){var o=this,a=this.geometry,s=this.matrixWorld,l=n.params.Points.threshold;if(null===a.boundingSphere&&a.computeBoundingSphere(),r.copy(a.boundingSphere),r.applyMatrix4(s),r.radius+=l,!1!==n.ray.intersectsSphere(r)){e.getInverse(s),t.copy(n.ray).applyMatrix4(e);var u=l/((this.scale.x+this.scale.y+this.scale.z)/3),c=u*u,h=new ft;if(a.isBufferGeometry){var p=a.index,d=a.attributes.position.array;if(null!==p)for(var f=p.array,m=0,g=f.length;m<g;m++){var v=f[m];h.fromArray(d,3*v),w(h,v)}else{m=0;for(var y=d.length/3;m<y;m++)h.fromArray(d,3*m),w(h,m)}}else{var b=a.vertices;for(m=0,y=b.length;m<y;m++)w(b[m],m)}}function w(e,r){var a=t.distanceSqToPoint(e);if(a<c){var l=t.closestPointToPoint(e);l.applyMatrix4(s);var u=n.ray.origin.distanceTo(l);if(u<n.near||u>n.far)return;i.push({distance:u,distanceToRay:Math.sqrt(a),point:l.clone(),index:r,face:null,object:o})}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Hn.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Hn}),$n.prototype=Object.create(vt.prototype),$n.prototype.constructor=$n,Gn.prototype=Object.create(vt.prototype),Gn.prototype.constructor=Gn,Gn.prototype.isCompressedTexture=!0,Wn.prototype=Object.create(vt.prototype),Wn.prototype.constructor=Wn,Wn.prototype.isDepthTexture=!0,qn.prototype=Object.create(Yr.prototype),qn.prototype.constructor=qn,Xn.prototype=Object.create(Fr.prototype),Xn.prototype.constructor=Xn,Kn.prototype=Object.create(Yr.prototype),Kn.prototype.constructor=Kn,Yn.prototype=Object.create(Fr.prototype),Yn.prototype.constructor=Yn,Zn.prototype=Object.create(Yr.prototype),Zn.prototype.constructor=Zn,Jn.prototype=Object.create(Fr.prototype),Jn.prototype.constructor=Jn,Qn.prototype=Object.create(Zn.prototype),Qn.prototype.constructor=Qn,ei.prototype=Object.create(Fr.prototype),ei.prototype.constructor=ei,ti.prototype=Object.create(Zn.prototype),ti.prototype.constructor=ti,ri.prototype=Object.create(Fr.prototype),ri.prototype.constructor=ri,ni.prototype=Object.create(Zn.prototype),ni.prototype.constructor=ni,ii.prototype=Object.create(Fr.prototype),ii.prototype.constructor=ii,oi.prototype=Object.create(Zn.prototype),oi.prototype.constructor=oi,ai.prototype=Object.create(Fr.prototype),ai.prototype.constructor=ai,si.prototype=Object.create(Yr.prototype),si.prototype.constructor=si,li.prototype=Object.create(Fr.prototype),li.prototype.constructor=li,ui.prototype=Object.create(Yr.prototype),ui.prototype.constructor=ui,ci.prototype=Object.create(Fr.prototype),ci.prototype.constructor=ci,hi.prototype=Object.create(Yr.prototype),hi.prototype.constructor=hi;var pi={area:function(e){for(var t=e.length,r=0,n=t-1,i=0;i<t;n=i++)r+=e[n].x*e[i].y-e[i].x*e[n].y;return.5*r},triangulate:function(){function e(e,t,r,n,i,o){var a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_;if(s=e[o[t]].x,l=e[o[t]].y,u=e[o[r]].x,c=e[o[r]].y,h=e[o[n]].x,(u-s)*((p=e[o[n]].y)-l)-(c-l)*(h-s)<=0)return!1;for(m=h-u,g=p-c,v=s-h,y=l-p,b=u-s,w=c-l,a=0;a<i;a++)if(d=e[o[a]].x,f=e[o[a]].y,!(d===s&&f===l||d===u&&f===c||d===h&&f===p)&&(x=b*(f-l)-w*(d-s),_=v*(f-p)-y*(d-h),m*(f-c)-g*(d-u)>=-Number.EPSILON&&_>=-Number.EPSILON&&x>=-Number.EPSILON))return!1;return!0}return function(t,r){var n=t.length;if(n<3)return null;var i,o,a,s=[],l=[],u=[];if(pi.area(t)>0)for(o=0;o<n;o++)l[o]=o;else for(o=0;o<n;o++)l[o]=n-1-o;var c=n,h=2*c;for(o=c-1;c>2;){if(h--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),r?u:s;if(c<=(i=o)&&(i=0),c<=(o=i+1)&&(o=0),c<=(a=o+1)&&(a=0),e(t,i,o,a,c,l)){var p,d,f,m,g;for(p=l[i],d=l[o],f=l[a],s.push([t[p],t[d],t[f]]),u.push([l[i],l[o],l[a]]),m=o,g=o+1;g<c;m++,g++)l[m]=l[g];h=2*--c}}return r?u:s}}(),triangulateShape:function(e,t){function r(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function n(e,t,r){return e.x!==t.x?e.x<t.x?e.x<=r.x&&r.x<=t.x:t.x<=r.x&&r.x<=e.x:e.y<t.y?e.y<=r.y&&r.y<=t.y:t.y<=r.y&&r.y<=e.y}function i(e,t,r,i,o){var a=t.x-e.x,s=t.y-e.y,l=i.x-r.x,u=i.y-r.y,c=e.x-r.x,h=e.y-r.y,p=s*l-a*u,d=s*c-a*h;if(Math.abs(p)>Number.EPSILON){var f;if(p>0){if(d<0||d>p)return[];if((f=u*c-l*h)<0||f>p)return[]}else{if(d>0||d<p)return[];if((f=u*c-l*h)>0||f<p)return[]}if(0===f)return!o||0!==d&&d!==p?[e]:[];if(f===p)return!o||0!==d&&d!==p?[t]:[];if(0===d)return[r];if(d===p)return[i];var m=f/p;return[{x:e.x+m*a,y:e.y+m*s}]}if(0!==d||u*c!=l*h)return[];var g,v,y,b,w,x,_,S,C=0===a&&0===s,M=0===l&&0===u;return C&&M?e.x!==r.x||e.y!==r.y?[]:[e]:C?n(r,i,e)?[e]:[]:M?n(e,t,r)?[r]:[]:(0!==a?(e.x<t.x?(g=e,y=e.x,v=t,b=t.x):(g=t,y=t.x,v=e,b=e.x),r.x<i.x?(w=r,_=r.x,x=i,S=i.x):(w=i,_=i.x,x=r,S=r.x)):(e.y<t.y?(g=e,y=e.y,v=t,b=t.y):(g=t,y=t.y,v=e,b=e.y),r.y<i.y?(w=r,_=r.y,x=i,S=i.y):(w=i,_=i.y,x=r,S=r.y)),y<=_?b<_?[]:b===_?o?[]:[w]:b<=S?[w,v]:[w,x]:y>S?[]:y===S?o?[]:[g]:b<=S?[g,v]:[g,x])}function o(e,t,r,n){var i=t.x-e.x,o=t.y-e.y,a=r.x-e.x,s=r.y-e.y,l=n.x-e.x,u=n.y-e.y,c=i*s-o*a,h=i*u-o*l;if(Math.abs(c)>Number.EPSILON){var p=l*s-u*a;return c>0?h>=0&&p>=0:h>=0||p>=0}return h>0}r(e),t.forEach(r);for(var a,s,l,u,c,h,p={},d=e.concat(),f=0,m=t.length;f<m;f++)Array.prototype.push.apply(d,t[f]);for(a=0,s=d.length;a<s;a++)void 0!==p[c=d[a].x+":"+d[a].y]&&console.warn("THREE.ShapeUtils: Duplicate point",c,a),p[c]=a;var g=function(e,t){var r,n=e.concat();function a(e,t){var i=n.length-1,a=e-1;a<0&&(a=i);var s=e+1;s>i&&(s=0);var l=o(n[e],n[a],n[s],r[t]);if(!l)return!1;var u=r.length-1,c=t-1;c<0&&(c=u);var h=t+1;return h>u&&(h=0),!!(l=o(r[t],r[c],r[h],n[e]))}function s(e,t){var r,o;for(r=0;r<n.length;r++)if(o=r+1,o%=n.length,i(e,t,n[r],n[o],!0).length>0)return!0;return!1}var l=[];function u(e,r){var n,o,a,s;for(n=0;n<l.length;n++)for(o=t[l[n]],a=0;a<o.length;a++)if(s=a+1,s%=o.length,i(e,r,o[a],o[s],!0).length>0)return!0;return!1}for(var c,h,p,d,f,m,g,v,y,b,w=[],x=0,_=t.length;x<_;x++)l.push(x);for(var S=0,C=2*l.length;l.length>0;){if(--C<0){console.log('THREE.ShapeUtils: Infinite Loop! Holes left:" + indepHoles.length + ", Probably Hole outside Shape!');break}for(h=S;h<n.length;h++){for(p=n[h],c=-1,x=0;x<l.length;x++)if(f=l[x],void 0===w[m=p.x+":"+p.y+":"+f]){r=t[f];for(var M=0;M<r.length;M++)if(d=r[M],a(h,M)&&!s(p,d)&&!u(p,d)){c=M,l.splice(x,1),g=n.slice(0,h+1),v=n.slice(h),y=r.slice(c),b=r.slice(0,c+1),n=g.concat(y).concat(b).concat(v),S=h;break}if(c>=0)break;w[m]=!0}if(c>=0)break}}return n}(e,t),v=pi.triangulate(g,!1);for(a=0,s=v.length;a<s;a++)for(u=v[a],l=0;l<3;l++)void 0!==(h=p[c=u[l].x+":"+u[l].y])&&(u[l]=h);return v.concat()},isClockWise:function(e){return pi.area(e)<0}};function di(e,t){Fr.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new fi(e,t)),this.mergeVertices()}function fi(e,t){void 0!==e&&(Yr.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeVertexNormals())}function mi(e,t){Fr.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new gi(e,t)),this.mergeVertices()}function gi(e,t){var r=(t=t||{}).font;if(!r||!r.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Fr;var n=r.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),fi.call(this,n,t),this.type="TextBufferGeometry"}function vi(e,t,r,n,i,o,a){Fr.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:i,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new yi(e,t,r,n,i,o,a)),this.mergeVertices()}function yi(e,t,r,n,i,o,a){Yr.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:i,thetaStart:o,thetaLength:a},e=e||1,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),n=void 0!==n?n:0,i=void 0!==i?i:2*Math.PI;var s,l,u=(o=void 0!==o?o:0)+(a=void 0!==a?a:Math.PI),c=0,h=[],p=new ft,d=new ft,f=[],m=[],g=[],v=[];for(l=0;l<=r;l++){var y=[],b=l/r;for(s=0;s<=t;s++){var w=s/t;p.x=-e*Math.cos(n+w*i)*Math.sin(o+b*a),p.y=e*Math.cos(o+b*a),p.z=e*Math.sin(n+w*i)*Math.sin(o+b*a),m.push(p.x,p.y,p.z),d.set(p.x,p.y,p.z).normalize(),g.push(d.x,d.y,d.z),v.push(w,1-b),y.push(c++)}h.push(y)}for(l=0;l<r;l++)for(s=0;s<t;s++){var x=h[l][s+1],_=h[l][s],S=h[l+1][s],C=h[l+1][s+1];(0!==l||o>0)&&f.push(x,_,C),(l!==r-1||u<Math.PI)&&f.push(_,S,C)}this.setIndex(f),this.addAttribute("position",new Gr(m,3)),this.addAttribute("normal",new Gr(g,3)),this.addAttribute("uv",new Gr(v,2))}function bi(e,t,r,n,i,o){Fr.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:i,thetaLength:o},this.fromBufferGeometry(new wi(e,t,r,n,i,o)),this.mergeVertices()}function wi(e,t,r,n,i,o){Yr.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:i,thetaLength:o},e=e||.5,t=t||1,i=void 0!==i?i:0,o=void 0!==o?o:2*Math.PI,r=void 0!==r?Math.max(3,r):8;var a,s,l,u=[],c=[],h=[],p=[],d=e,f=(t-e)/(n=void 0!==n?Math.max(1,n):1),m=new ft,g=new ht;for(s=0;s<=n;s++){for(l=0;l<=r;l++)a=i+l/r*o,m.x=d*Math.cos(a),m.y=d*Math.sin(a),c.push(m.x,m.y,m.z),h.push(0,0,1),g.x=(m.x/t+1)/2,g.y=(m.y/t+1)/2,p.push(g.x,g.y);d+=f}for(s=0;s<n;s++){var v=s*(r+1);for(l=0;l<r;l++){var y=a=l+v,b=a+r+1,w=a+r+2,x=a+1;u.push(y,b,x),u.push(b,w,x)}}this.setIndex(u),this.addAttribute("position",new Gr(c,3)),this.addAttribute("normal",new Gr(h,3)),this.addAttribute("uv",new Gr(p,2))}function xi(e,t,r,n){Fr.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},this.fromBufferGeometry(new _i(e,t,r,n)),this.mergeVertices()}function _i(e,t,r,n){Yr.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},t=Math.floor(t)||12,r=r||0,n=n||2*Math.PI,n=ct.clamp(n,0,2*Math.PI);var i,o,a,s=[],l=[],u=[],c=1/t,h=new ft,p=new ht;for(o=0;o<=t;o++){var d=r+o*c*n,f=Math.sin(d),m=Math.cos(d);for(a=0;a<=e.length-1;a++)h.x=e[a].x*f,h.y=e[a].y,h.z=e[a].x*m,l.push(h.x,h.y,h.z),p.x=o/t,p.y=a/(e.length-1),u.push(p.x,p.y)}for(o=0;o<t;o++)for(a=0;a<e.length-1;a++){var g=i=a+o*e.length,v=i+e.length,y=i+e.length+1,b=i+1;s.push(g,v,b),s.push(v,y,b)}if(this.setIndex(s),this.addAttribute("position",new Gr(l,3)),this.addAttribute("uv",new Gr(u,2)),this.computeVertexNormals(),n===2*Math.PI){var w=this.attributes.normal.array,x=new ft,_=new ft,S=new ft;for(i=t*e.length*3,o=0,a=0;o<e.length;o++,a+=3)x.x=w[a+0],x.y=w[a+1],x.z=w[a+2],_.x=w[i+a+0],_.y=w[i+a+1],_.z=w[i+a+2],S.addVectors(x,_).normalize(),w[a+0]=w[i+a+0]=S.x,w[a+1]=w[i+a+1]=S.y,w[a+2]=w[i+a+2]=S.z}}function Si(e,t){Fr.call(this),this.type="ShapeGeometry","object"==typeof t&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new Ci(e,t)),this.mergeVertices()}function Ci(e,t){Yr.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var r=[],n=[],i=[],o=[],a=0,s=0;if(!1===Array.isArray(e))u(e);else for(var l=0;l<e.length;l++)u(e[l]),this.addGroup(a,s,l),a+=s,s=0;function u(e){var a,l,u,c=n.length/3,h=e.extractPoints(t),p=h.shape,d=h.holes;if(!1===pi.isClockWise(p))for(p=p.reverse(),a=0,l=d.length;a<l;a++)u=d[a],!0===pi.isClockWise(u)&&(d[a]=u.reverse());var f=pi.triangulateShape(p,d);for(a=0,l=d.length;a<l;a++)u=d[a],p=p.concat(u);for(a=0,l=p.length;a<l;a++){var m=p[a];n.push(m.x,m.y,0),i.push(0,0,1),o.push(m.x,m.y)}for(a=0,l=f.length;a<l;a++){var g=f[a],v=g[0]+c,y=g[1]+c,b=g[2]+c;r.push(v,y,b),s+=3}}this.setIndex(r),this.addAttribute("position",new Gr(n,3)),this.addAttribute("normal",new Gr(i,3)),this.addAttribute("uv",new Gr(o,2))}function Mi(e,t){Yr.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var r,n,i,o,a=[],s=Math.cos(ct.DEG2RAD*t),l=[0,0],u={},c=["a","b","c"];e.isBufferGeometry?(o=new Fr).fromBufferGeometry(e):o=e.clone(),o.mergeVertices(),o.computeFaceNormals();for(var h=o.vertices,p=o.faces,d=0,f=p.length;d<f;d++)for(var m=p[d],g=0;g<3;g++)r=m[c[g]],n=m[c[(g+1)%3]],l[0]=Math.min(r,n),l[1]=Math.max(r,n),void 0===u[i=l[0]+","+l[1]]?u[i]={index1:l[0],index2:l[1],face1:d,face2:void 0}:u[i].face2=d;for(i in u){var v=u[i];if(void 0===v.face2||p[v.face1].normal.dot(p[v.face2].normal)<=s){var y=h[v.index1];a.push(y.x,y.y,y.z),y=h[v.index2],a.push(y.x,y.y,y.z)}}this.addAttribute("position",new Gr(a,3))}function Ti(e,t,r,n,i,o,a,s){Fr.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:i,openEnded:o,thetaStart:a,thetaLength:s},this.fromBufferGeometry(new Ai(e,t,r,n,i,o,a,s)),this.mergeVertices()}function Ai(e,t,r,n,i,o,a,s){Yr.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:i,openEnded:o,thetaStart:a,thetaLength:s};var l=this;e=void 0!==e?e:1,t=void 0!==t?t:1,r=r||1,n=Math.floor(n)||8,i=Math.floor(i)||1,o=void 0!==o&&o,a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI;var u=[],c=[],h=[],p=[],d=0,f=[],m=r/2,g=0;function v(r){var i,o,f,v=new ht,y=new ft,b=0,w=!0===r?e:t,x=!0===r?1:-1;for(o=d,i=1;i<=n;i++)c.push(0,m*x,0),h.push(0,x,0),p.push(.5,.5),d++;for(f=d,i=0;i<=n;i++){var _=i/n*s+a,S=Math.cos(_),C=Math.sin(_);y.x=w*C,y.y=m*x,y.z=w*S,c.push(y.x,y.y,y.z),h.push(0,x,0),v.x=.5*S+.5,v.y=.5*C*x+.5,p.push(v.x,v.y),d++}for(i=0;i<n;i++){var M=o+i,T=f+i;!0===r?u.push(T,T+1,M):u.push(T+1,T,M),b+=3}l.addGroup(g,b,!0===r?1:2),g+=b}!function(){var o,v,y=new ft,b=new ft,w=0,x=(t-e)/r;for(v=0;v<=i;v++){var _=[],S=v/i,C=S*(t-e)+e;for(o=0;o<=n;o++){var M=o/n,T=M*s+a,A=Math.sin(T),E=Math.cos(T);b.x=C*A,b.y=-S*r+m,b.z=C*E,c.push(b.x,b.y,b.z),y.set(A,x,E).normalize(),h.push(y.x,y.y,y.z),p.push(M,1-S),_.push(d++)}f.push(_)}for(o=0;o<n;o++)for(v=0;v<i;v++){var P=f[v][o],R=f[v+1][o],I=f[v+1][o+1],N=f[v][o+1];u.push(P,R,N),u.push(R,I,N),w+=6}l.addGroup(g,w,0),g+=w}(),!1===o&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(u),this.addAttribute("position",new Gr(c,3)),this.addAttribute("normal",new Gr(h,3)),this.addAttribute("uv",new Gr(p,2))}function Ei(e,t,r,n,i,o,a){Ti.call(this,0,e,t,r,n,i,o,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:n,openEnded:i,thetaStart:o,thetaLength:a}}function Pi(e,t,r,n,i,o,a){Ai.call(this,0,e,t,r,n,i,o,a),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:n,openEnded:i,thetaStart:o,thetaLength:a}}function Ri(e,t,r,n){Fr.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},this.fromBufferGeometry(new Ii(e,t,r,n)),this.mergeVertices()}function Ii(e,t,r,n){Yr.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},e=e||1,t=void 0!==t?Math.max(3,t):8,r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI;var i,o,a=[],s=[],l=[],u=[],c=new ft,h=new ht;for(s.push(0,0,0),l.push(0,0,1),u.push(.5,.5),o=0,i=3;o<=t;o++,i+=3){var p=r+o/t*n;c.x=e*Math.cos(p),c.y=e*Math.sin(p),s.push(c.x,c.y,c.z),l.push(0,0,1),h.x=(s[i]/e+1)/2,h.y=(s[i+1]/e+1)/2,u.push(h.x,h.y)}for(i=1;i<=t;i++)a.push(i,i+1,0);this.setIndex(a),this.addAttribute("position",new Gr(s,3)),this.addAttribute("normal",new Gr(l,3)),this.addAttribute("uv",new Gr(u,2))}di.prototype=Object.create(Fr.prototype),di.prototype.constructor=di,fi.prototype=Object.create(Yr.prototype),fi.prototype.constructor=fi,fi.prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],r=this.getAttribute("uv"),n=r?Array.prototype.slice.call(r.array):[],i=this.index;return{position:t,uv:n,index:i?Array.prototype.slice.call(i.array):[]}},fi.prototype.addShapeList=function(e,t){var r=e.length;t.arrays=this.getArrays();for(var n=0;n<r;n++){var i=e[n];this.addShape(i,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new Gr(t.arrays.position,3)),this.addAttribute("uv",new Gr(t.arrays.uv,2))},fi.prototype.addShape=function(e,t){var r,n,i,o,a,s,l,u,c=t.arrays?t.arrays:this.getArrays(),h=c.position,p=c.index,d=c.uv,f=[],m=void 0!==t.amount?t.amount:100,g=void 0!==t.bevelThickness?t.bevelThickness:6,v=void 0!==t.bevelSize?t.bevelSize:g-2,y=void 0!==t.bevelSegments?t.bevelSegments:3,b=void 0===t.bevelEnabled||t.bevelEnabled,w=void 0!==t.curveSegments?t.curveSegments:12,x=void 0!==t.steps?t.steps:1,_=t.extrudePath,S=!1,C=void 0!==t.UVGenerator?t.UVGenerator:di.WorldUVGenerator;_&&(r=_.getSpacedPoints(x),S=!0,b=!1,n=void 0!==t.frames?t.frames:_.computeFrenetFrames(x,!1),i=new ft,o=new ft,a=new ft),b||(y=0,g=0,v=0);var M=this,T=e.extractPoints(w),A=T.shape,E=T.holes;if(!pi.isClockWise(A))for(A=A.reverse(),l=0,u=E.length;l<u;l++)s=E[l],pi.isClockWise(s)&&(E[l]=s.reverse());var P=pi.triangulateShape(A,E),R=A;for(l=0,u=E.length;l<u;l++)s=E[l],A=A.concat(s);function I(e,t,r){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}var N,D,k,O,F,L,U=A.length,V=P.length;function B(e,t,r){var n,i,o,a=e.x-t.x,s=e.y-t.y,l=r.x-e.x,u=r.y-e.y,c=a*a+s*s,h=a*u-s*l;if(Math.abs(h)>Number.EPSILON){var p=Math.sqrt(c),d=Math.sqrt(l*l+u*u),f=t.x-s/p,m=t.y+a/p,g=((r.x-u/d-f)*u-(r.y+l/d-m)*l)/(a*u-s*l),v=(n=f+a*g-e.x)*n+(i=m+s*g-e.y)*i;if(v<=2)return new ht(n,i);o=Math.sqrt(v/2)}else{var y=!1;a>Number.EPSILON?l>Number.EPSILON&&(y=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(y=!0):Math.sign(s)===Math.sign(u)&&(y=!0),y?(n=-s,i=a,o=Math.sqrt(c)):(n=a,i=s,o=Math.sqrt(c/2))}return new ht(n/o,i/o)}for(var z=[],j=0,H=R.length,$=H-1,G=j+1;j<H;j++,$++,G++)$===H&&($=0),G===H&&(G=0),z[j]=B(R[j],R[$],R[G]);var W,q,X=[],K=z.concat();for(l=0,u=E.length;l<u;l++){for(s=E[l],W=[],j=0,$=(H=s.length)-1,G=j+1;j<H;j++,$++,G++)$===H&&($=0),G===H&&(G=0),W[j]=B(s[j],s[$],s[G]);X.push(W),K=K.concat(W)}for(N=0;N<y;N++){for(k=N/y,O=g*Math.cos(k*Math.PI/2),D=v*Math.sin(k*Math.PI/2),j=0,H=R.length;j<H;j++)Z((F=I(R[j],z[j],D)).x,F.y,-O);for(l=0,u=E.length;l<u;l++)for(s=E[l],W=X[l],j=0,H=s.length;j<H;j++)Z((F=I(s[j],W[j],D)).x,F.y,-O)}for(D=v,j=0;j<U;j++)F=b?I(A[j],K[j],D):A[j],S?(o.copy(n.normals[0]).multiplyScalar(F.x),i.copy(n.binormals[0]).multiplyScalar(F.y),a.copy(r[0]).add(o).add(i),Z(a.x,a.y,a.z)):Z(F.x,F.y,0);for(q=1;q<=x;q++)for(j=0;j<U;j++)F=b?I(A[j],K[j],D):A[j],S?(o.copy(n.normals[q]).multiplyScalar(F.x),i.copy(n.binormals[q]).multiplyScalar(F.y),a.copy(r[q]).add(o).add(i),Z(a.x,a.y,a.z)):Z(F.x,F.y,m/x*q);for(N=y-1;N>=0;N--){for(k=N/y,O=g*Math.cos(k*Math.PI/2),D=v*Math.sin(k*Math.PI/2),j=0,H=R.length;j<H;j++)Z((F=I(R[j],z[j],D)).x,F.y,m+O);for(l=0,u=E.length;l<u;l++)for(s=E[l],W=X[l],j=0,H=s.length;j<H;j++)F=I(s[j],W[j],D),S?Z(F.x,F.y+r[x-1].y,r[x-1].x+O):Z(F.x,F.y,m+O)}function Y(e,t){var r,n;for(j=e.length;--j>=0;){r=j,(n=j-1)<0&&(n=e.length-1);var i=0,o=x+2*y;for(i=0;i<o;i++){var a=U*i,s=U*(i+1);Q(t+r+a,t+n+a,t+n+s,t+r+s)}}}function Z(e,t,r){f.push(e),f.push(t),f.push(r)}function J(e,t,r){ee(e),ee(t),ee(r);var n=h.length/3,i=C.generateTopUV(M,h,n-3,n-2,n-1);te(i[0]),te(i[1]),te(i[2])}function Q(e,t,r,n){ee(e),ee(t),ee(n),ee(t),ee(r),ee(n);var i=h.length/3,o=C.generateSideWallUV(M,h,i-6,i-3,i-2,i-1);te(o[0]),te(o[1]),te(o[3]),te(o[1]),te(o[2]),te(o[3])}function ee(e){p.push(h.length/3),h.push(f[3*e+0]),h.push(f[3*e+1]),h.push(f[3*e+2])}function te(e){d.push(e.x),d.push(e.y)}!function(){var e=h.length/3;if(b){var r=0,n=U*r;for(j=0;j<V;j++)J((L=P[j])[2]+n,L[1]+n,L[0]+n);for(n=U*(r=x+2*y),j=0;j<V;j++)J((L=P[j])[0]+n,L[1]+n,L[2]+n)}else{for(j=0;j<V;j++)J((L=P[j])[2],L[1],L[0]);for(j=0;j<V;j++)J((L=P[j])[0]+U*x,L[1]+U*x,L[2]+U*x)}M.addGroup(e,h.length/3-e,void 0!==t.material?t.material:0)}(),function(){var e=h.length/3,r=0;for(Y(R,r),r+=R.length,l=0,u=E.length;l<u;l++)Y(s=E[l],r),r+=s.length;M.addGroup(e,h.length/3-e,void 0!==t.extrudeMaterial?t.extrudeMaterial:1)}(),t.arrays||(this.setIndex(p),this.addAttribute("position",new Gr(h,3)),this.addAttribute("uv",new Gr(t.arrays.uv,2)))},di.WorldUVGenerator={generateTopUV:function(e,t,r,n,i){var o=t[3*r],a=t[3*r+1],s=t[3*n],l=t[3*n+1],u=t[3*i],c=t[3*i+1];return[new ht(o,a),new ht(s,l),new ht(u,c)]},generateSideWallUV:function(e,t,r,n,i,o){var a=t[3*r],s=t[3*r+1],l=t[3*r+2],u=t[3*n],c=t[3*n+1],h=t[3*n+2],p=t[3*i],d=t[3*i+1],f=t[3*i+2],m=t[3*o],g=t[3*o+1],v=t[3*o+2];return Math.abs(s-c)<.01?[new ht(a,1-l),new ht(u,1-h),new ht(p,1-f),new ht(m,1-v)]:[new ht(s,1-l),new ht(c,1-h),new ht(d,1-f),new ht(g,1-v)]}},mi.prototype=Object.create(Fr.prototype),mi.prototype.constructor=mi,gi.prototype=Object.create(fi.prototype),gi.prototype.constructor=gi,vi.prototype=Object.create(Fr.prototype),vi.prototype.constructor=vi,yi.prototype=Object.create(Yr.prototype),yi.prototype.constructor=yi,bi.prototype=Object.create(Fr.prototype),bi.prototype.constructor=bi,wi.prototype=Object.create(Yr.prototype),wi.prototype.constructor=wi,xi.prototype=Object.create(Fr.prototype),xi.prototype.constructor=xi,_i.prototype=Object.create(Yr.prototype),_i.prototype.constructor=_i,Si.prototype=Object.create(Fr.prototype),Si.prototype.constructor=Si,Ci.prototype=Object.create(Yr.prototype),Ci.prototype.constructor=Ci,Mi.prototype=Object.create(Yr.prototype),Mi.prototype.constructor=Mi,Ti.prototype=Object.create(Fr.prototype),Ti.prototype.constructor=Ti,Ai.prototype=Object.create(Yr.prototype),Ai.prototype.constructor=Ai,Ei.prototype=Object.create(Ti.prototype),Ei.prototype.constructor=Ei,Pi.prototype=Object.create(Ai.prototype),Pi.prototype.constructor=Pi,Ri.prototype=Object.create(Fr.prototype),Ri.prototype.constructor=Ri,Ii.prototype=Object.create(Yr.prototype),Ii.prototype.constructor=Ii;var Ni=Object.freeze({WireframeGeometry:qn,ParametricGeometry:Xn,ParametricBufferGeometry:Kn,TetrahedronGeometry:Jn,TetrahedronBufferGeometry:Qn,OctahedronGeometry:ei,OctahedronBufferGeometry:ti,IcosahedronGeometry:ri,IcosahedronBufferGeometry:ni,DodecahedronGeometry:ii,DodecahedronBufferGeometry:oi,PolyhedronGeometry:Yn,PolyhedronBufferGeometry:Zn,TubeGeometry:ai,TubeBufferGeometry:si,TorusKnotGeometry:li,TorusKnotBufferGeometry:ui,TorusGeometry:ci,TorusBufferGeometry:hi,TextGeometry:mi,TextBufferGeometry:gi,SphereGeometry:vi,SphereBufferGeometry:yi,RingGeometry:bi,RingBufferGeometry:wi,PlaneGeometry:Qr,PlaneBufferGeometry:en,LatheGeometry:xi,LatheBufferGeometry:_i,ShapeGeometry:Si,ShapeBufferGeometry:Ci,ExtrudeGeometry:di,ExtrudeBufferGeometry:fi,EdgesGeometry:Mi,ConeGeometry:Ei,ConeBufferGeometry:Pi,CylinderGeometry:Ti,CylinderBufferGeometry:Ai,CircleGeometry:Ri,CircleBufferGeometry:Ii,BoxGeometry:Zr,BoxBufferGeometry:Jr});function Di(e){br.call(this),this.type="ShadowMaterial",this.color=new ur(0),this.opacity=1,this.lights=!0,this.transparent=!0,this.setValues(e)}function ki(e){rn.call(this,e),this.type="RawShaderMaterial"}function Oi(e){br.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new ur(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ur(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ht(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Fi(e){Oi.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function Li(e){br.call(this),this.type="MeshPhongMaterial",this.color=new ur(16777215),this.specular=new ur(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ur(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ht(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Ui(e){Li.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function Vi(e){br.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new ht(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Bi(e){br.call(this),this.type="MeshLambertMaterial",this.color=new ur(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ur(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function zi(e){Ln.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}Di.prototype=Object.create(br.prototype),Di.prototype.constructor=Di,Di.prototype.isShadowMaterial=!0,ki.prototype=Object.create(rn.prototype),ki.prototype.constructor=ki,ki.prototype.isRawShaderMaterial=!0,Oi.prototype=Object.create(br.prototype),Oi.prototype.constructor=Oi,Oi.prototype.isMeshStandardMaterial=!0,Oi.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Fi.prototype=Object.create(Oi.prototype),Fi.prototype.constructor=Fi,Fi.prototype.isMeshPhysicalMaterial=!0,Fi.prototype.copy=function(e){return Oi.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},Li.prototype=Object.create(br.prototype),Li.prototype.constructor=Li,Li.prototype.isMeshPhongMaterial=!0,Li.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Ui.prototype=Object.create(Li.prototype),Ui.prototype.constructor=Ui,Ui.prototype.isMeshToonMaterial=!0,Ui.prototype.copy=function(e){return Li.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},Vi.prototype=Object.create(br.prototype),Vi.prototype.constructor=Vi,Vi.prototype.isMeshNormalMaterial=!0,Vi.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Bi.prototype=Object.create(br.prototype),Bi.prototype.constructor=Bi,Bi.prototype.isMeshLambertMaterial=!0,Bi.prototype.copy=function(e){return br.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},zi.prototype=Object.create(Ln.prototype),zi.prototype.constructor=zi,zi.prototype.isLineDashedMaterial=!0,zi.prototype.copy=function(e){return Ln.prototype.copy.call(this,e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var ji=Object.freeze({ShadowMaterial:Di,SpriteMaterial:In,RawShaderMaterial:ki,ShaderMaterial:rn,PointsMaterial:zn,MeshPhysicalMaterial:Fi,MeshStandardMaterial:Oi,MeshPhongMaterial:Li,MeshToonMaterial:Ui,MeshNormalMaterial:Vi,MeshLambertMaterial:Bi,MeshDepthMaterial:wr,MeshDistanceMaterial:xr,MeshBasicMaterial:tn,LineDashedMaterial:zi,LineBasicMaterial:Ln,Material:br}),Hi={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};function $i(e,t,r){var n=this,i=!1,o=0,a=0,s=void 0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){a++,!1===i&&void 0!==n.onStart&&n.onStart(e,o,a),i=!0},this.itemEnd=function(e){o++,void 0!==n.onProgress&&n.onProgress(e,o,a),o===a&&(i=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return s?s(e):e},this.setURLModifier=function(e){s=e}}var Gi=new $i,Wi={};function qi(e){this.manager=void 0!==e?e:Gi}function Xi(e){this.manager=void 0!==e?e:Gi}function Ki(e){this.manager=void 0!==e?e:Gi}function Yi(e,t){Ir.call(this),this.type="Light",this.color=new ur(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function Zi(e,t,r){Yi.call(this,e,r),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Ir.DefaultUp),this.updateMatrix(),this.groundColor=new ur(t)}function Ji(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new ht(512,512),this.map=null,this.matrix=new pt}function Qi(){Ji.call(this,new Cn(50,1,.5,500))}function eo(e,t,r,n,i,o){Yi.call(this,e,t),this.type="SpotLight",this.position.copy(Ir.DefaultUp),this.updateMatrix(),this.target=new Ir,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==r?r:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==i?i:0,this.decay=void 0!==o?o:1,this.shadow=new Qi}function to(e,t,r,n){Yi.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==r?r:0,this.decay=void 0!==n?n:1,this.shadow=new Ji(new Cn(90,1,.5,500))}function ro(){Ji.call(this,new Dr(-5,5,5,-5,.5,500))}function no(e,t){Yi.call(this,e,t),this.type="DirectionalLight",this.position.copy(Ir.DefaultUp),this.updateMatrix(),this.target=new Ir,this.shadow=new ro}function io(e,t){Yi.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function oo(e,t,r,n){Yi.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==r?r:10,this.height=void 0!==n?n:10}Object.assign(qi.prototype,{load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var i=this,o=Hi.get(e);if(void 0!==o)return i.manager.itemStart(e),setTimeout(function(){t&&t(o),i.manager.itemEnd(e)},0),o;if(void 0===Wi[e]){var a=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(a){var s=a[1],l=!!a[2],u=a[3];u=window.decodeURIComponent(u),l&&(u=window.atob(u));try{var c,h=(this.responseType||"").toLowerCase();switch(h){case"arraybuffer":case"blob":for(var p=new Uint8Array(u.length),d=0;d<u.length;d++)p[d]=u.charCodeAt(d);c="blob"===h?new Blob([p.buffer],{type:s}):p.buffer;break;case"document":var f=new DOMParser;c=f.parseFromString(u,s);break;case"json":c=JSON.parse(u);break;default:c=u}window.setTimeout(function(){t&&t(c),i.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){n&&n(t),i.manager.itemEnd(e),i.manager.itemError(e)},0)}}else{Wi[e]=[],Wi[e].push({onLoad:t,onProgress:r,onError:n});var m=new XMLHttpRequest;for(var g in m.open("GET",e,!0),m.addEventListener("load",function(t){var r=t.target.response;Hi.add(e,r);var n=Wi[e];if(delete Wi[e],200===this.status){for(var o=0,a=n.length;o<a;o++){(s=n[o]).onLoad&&s.onLoad(r)}i.manager.itemEnd(e)}else if(0===this.status){console.warn("THREE.FileLoader: HTTP Status 0 received.");for(o=0,a=n.length;o<a;o++){(s=n[o]).onLoad&&s.onLoad(r)}i.manager.itemEnd(e)}else{for(o=0,a=n.length;o<a;o++){var s;(s=n[o]).onError&&s.onError(t)}i.manager.itemEnd(e),i.manager.itemError(e)}},!1),m.addEventListener("progress",function(t){for(var r=Wi[e],n=0,i=r.length;n<i;n++){var o=r[n];o.onProgress&&o.onProgress(t)}},!1),m.addEventListener("error",function(t){var r=Wi[e];delete Wi[e];for(var n=0,o=r.length;n<o;n++){var a=r[n];a.onError&&a.onError(t)}i.manager.itemEnd(e),i.manager.itemError(e)},!1),void 0!==this.responseType&&(m.responseType=this.responseType),void 0!==this.withCredentials&&(m.withCredentials=this.withCredentials),m.overrideMimeType&&m.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)m.setRequestHeader(g,this.requestHeader[g]);m.send(null)}return i.manager.itemStart(e),m}Wi[e].push({onLoad:t,onProgress:r,onError:n})},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(function(e){this.manager=void 0!==e?e:Gi,this._parser=null}.prototype,{load:function(e,t,r,n){var i=this,o=[],a=new Gn;a.image=o;var s=new qi(this.manager);function l(l){s.load(e[l],function(e){var r=i._parser(e,!0);o[l]={width:r.width,height:r.height,format:r.format,mipmaps:r.mipmaps},6===(u+=1)&&(1===r.mipmapCount&&(a.minFilter=be),a.format=r.format,a.needsUpdate=!0,t&&t(a))},r,n)}if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(e))for(var u=0,c=0,h=e.length;c<h;++c)l(c);else s.load(e,function(e){var r=i._parser(e,!0);if(r.isCubemap)for(var n=r.mipmaps.length/r.mipmapCount,s=0;s<n;s++){o[s]={mipmaps:[]};for(var l=0;l<r.mipmapCount;l++)o[s].mipmaps.push(r.mipmaps[s*r.mipmapCount+l]),o[s].format=r.format,o[s].width=r.width,o[s].height=r.height}else a.image.width=r.width,a.image.height=r.height,a.mipmaps=r.mipmaps;1===r.mipmapCount&&(a.minFilter=be),a.format=r.format,a.needsUpdate=!0,t&&t(a)},r,n);return a},setPath:function(e){return this.path=e,this}}),Object.assign(function(e){this.manager=void 0!==e?e:Gi,this._parser=null}.prototype,{load:function(e,t,r,n){var i=this,o=new xt,a=new qi(this.manager);return a.setResponseType("arraybuffer"),a.load(e,function(e){var r=i._parser(e);r&&(void 0!==r.image?o.image=r.image:void 0!==r.data&&(o.image.width=r.width,o.image.height=r.height,o.image.data=r.data),o.wrapS=void 0!==r.wrapS?r.wrapS:de,o.wrapT=void 0!==r.wrapT?r.wrapT:de,o.magFilter=void 0!==r.magFilter?r.magFilter:be,o.minFilter=void 0!==r.minFilter?r.minFilter:xe,o.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,void 0!==r.format&&(o.format=r.format),void 0!==r.type&&(o.type=r.type),void 0!==r.mipmaps&&(o.mipmaps=r.mipmaps),1===r.mipmapCount&&(o.minFilter=be),o.needsUpdate=!0,t&&t(o,r))},r,n),o}}),Object.assign(Xi.prototype,{crossOrigin:"Anonymous",load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var i=this,o=Hi.get(e);if(void 0!==o)return i.manager.itemStart(e),setTimeout(function(){t&&t(o),i.manager.itemEnd(e)},0),o;var a=document.createElementNS("http://www.w3.org/1999/xhtml","img");return a.addEventListener("load",function(){Hi.add(e,this),t&&t(this),i.manager.itemEnd(e)},!1),a.addEventListener("error",function(t){n&&n(t),i.manager.itemEnd(e),i.manager.itemError(e)},!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),i.manager.itemStart(e),a.src=e,a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(function(e){this.manager=void 0!==e?e:Gi}.prototype,{crossOrigin:"Anonymous",load:function(e,t,r,n){var i=new _t,o=new Xi(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);var a=0;function s(r){o.load(e[r],function(e){i.images[r]=e,6===++a&&(i.needsUpdate=!0,t&&t(i))},void 0,n)}for(var l=0;l<e.length;++l)s(l);return i},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Ki.prototype,{crossOrigin:"Anonymous",load:function(e,t,r,n){var i=new Xi(this.manager);i.setCrossOrigin(this.crossOrigin),i.setPath(this.path);var o=new vt;return o.image=i.load(e,function(){var r=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);o.format=r?Oe:Fe,o.needsUpdate=!0,void 0!==t&&t(o)},r,n),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Yi.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Yi,isLight:!0,copy:function(e){return Ir.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=Ir.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),Zi.prototype=Object.assign(Object.create(Yi.prototype),{constructor:Zi,isHemisphereLight:!0,copy:function(e){return Yi.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(Ji.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),Qi.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Qi,isSpotLightShadow:!0,update:function(e){var t=this.camera,r=2*ct.RAD2DEG*e.angle,n=this.mapSize.width/this.mapSize.height,i=e.distance||t.far;r===t.fov&&n===t.aspect&&i===t.far||(t.fov=r,t.aspect=n,t.far=i,t.updateProjectionMatrix())}}),eo.prototype=Object.assign(Object.create(Yi.prototype),{constructor:eo,isSpotLight:!0,copy:function(e){return Yi.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),to.prototype=Object.assign(Object.create(Yi.prototype),{constructor:to,isPointLight:!0,copy:function(e){return Yi.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),ro.prototype=Object.assign(Object.create(Ji.prototype),{constructor:ro}),no.prototype=Object.assign(Object.create(Yi.prototype),{constructor:no,isDirectionalLight:!0,copy:function(e){return Yi.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),io.prototype=Object.assign(Object.create(Yi.prototype),{constructor:io,isAmbientLight:!0}),oo.prototype=Object.assign(Object.create(Yi.prototype),{constructor:oo,isRectAreaLight:!0,copy:function(e){return Yi.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Yi.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var ao,so={arraySlice:function(e,t,r){return so.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==r?r:e.length)):e.slice(t,r)},convertArray:function(e,t,r){return!e||!r&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){for(var t=e.length,r=new Array(t),n=0;n!==t;++n)r[n]=n;return r.sort(function(t,r){return e[t]-e[r]}),r},sortedArray:function(e,t,r){for(var n=e.length,i=new e.constructor(n),o=0,a=0;a!==n;++o)for(var s=r[o]*t,l=0;l!==t;++l)i[a++]=e[s+l];return i},flattenJSON:function(e,t,r,n){for(var i=1,o=e[0];void 0!==o&&void 0===o[n];)o=e[i++];if(void 0!==o){var a=o[n];if(void 0!==a)if(Array.isArray(a))do{void 0!==(a=o[n])&&(t.push(o.time),r.push.apply(r,a)),o=e[i++]}while(void 0!==o);else if(void 0!==a.toArray)do{void 0!==(a=o[n])&&(t.push(o.time),a.toArray(r,r.length)),o=e[i++]}while(void 0!==o);else do{void 0!==(a=o[n])&&(t.push(o.time),r.push(a)),o=e[i++]}while(void 0!==o)}}};function lo(e,t,r,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(r),this.sampleValues=t,this.valueSize=r}function uo(e,t,r,n){lo.call(this,e,t,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function co(e,t,r,n){lo.call(this,e,t,r,n)}function ho(e,t,r,n){lo.call(this,e,t,r,n)}function po(e,t,r,n){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=so.convertArray(t,this.TimeBufferType),this.values=so.convertArray(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation),this.validate(),this.optimize()}function fo(e,t,r,n){po.call(this,e,t,r,n)}function mo(e,t,r,n){lo.call(this,e,t,r,n)}function go(e,t,r,n){po.call(this,e,t,r,n)}function vo(e,t,r,n){po.call(this,e,t,r,n)}function yo(e,t,r,n){po.call(this,e,t,r,n)}function bo(e,t,r){po.call(this,e,t,r)}function wo(e,t,r,n){po.call(this,e,t,r,n)}function xo(e,t,r,n){po.apply(this,e,t,r,n)}function _o(e,t,r){this.name=e,this.tracks=r,this.duration=void 0!==t?t:-1,this.uuid=ct.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function So(e){this.manager=void 0!==e?e:Gi,this.textures={}}function Co(e){this.manager=void 0!==e?e:Gi}Object.assign(lo.prototype,{evaluate:function(e){var t=this.parameterPositions,r=this._cachedIndex,n=t[r],i=t[r-1];e:{t:{var o;r:{n:if(!(e<n)){for(var a=r+2;;){if(void 0===n){if(e<i)break n;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,i)}if(r===a)break;if(i=n,e<(n=t[++r]))break t}o=t.length;break r}if(e>=i)break e;var s=t[1];e<s&&(r=2,i=s);for(a=r-2;;){if(void 0===i)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(r===a)break;if(n=i,e>=(i=t[--r-1]))break t}o=r,r=0}for(;r<o;){var l=r+o>>>1;e<t[l]?o=l:r=l+1}if(n=t[r],void 0===(i=t[r-1]))return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,i,e)}this._cachedIndex=r,this.intervalChanged_(r,i,n)}return this.interpolate_(r,i,e,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n,o=0;o!==n;++o)t[o]=r[i+o];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),
//!\ DECLARE ALIAS AFTER assign prototype !
Object.assign(lo.prototype,{beforeStart_:lo.prototype.copySampleValue_,afterEnd_:lo.prototype.copySampleValue_}),uo.prototype=Object.assign(Object.create(lo.prototype),{constructor:uo,DefaultSettings_:{endingStart:Ze,endingEnd:Ze},intervalChanged_:function(e,t,r){var n=this.parameterPositions,i=e-2,o=e+1,a=n[i],s=n[o];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:i=e,a=2*t-r;break;case 2402:a=t+n[i=n.length-2]-n[i+1];break;default:i=e,a=r}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:o=e,s=2*r-t;break;case 2402:o=1,s=r+n[1]-n[0];break;default:o=e-1,s=t}var l=.5*(r-t),u=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(s-r),this._offsetPrev=i*u,this._offsetNext=o*u},interpolate_:function(e,t,r,n){for(var i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=s-a,u=this._offsetPrev,c=this._offsetNext,h=this._weightPrev,p=this._weightNext,d=(r-t)/(n-t),f=d*d,m=f*d,g=-h*m+2*h*f-h*d,v=(1+h)*m+(-1.5-2*h)*f+(-.5+h)*d+1,y=(-1-p)*m+(1.5+p)*f+.5*d,b=p*m-p*f,w=0;w!==a;++w)i[w]=g*o[u+w]+v*o[l+w]+y*o[s+w]+b*o[c+w];return i}}),co.prototype=Object.assign(Object.create(lo.prototype),{constructor:co,interpolate_:function(e,t,r,n){for(var i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=s-a,u=(r-t)/(n-t),c=1-u,h=0;h!==a;++h)i[h]=o[l+h]*c+o[s+h]*u;return i}}),ho.prototype=Object.assign(Object.create(lo.prototype),{constructor:ho,interpolate_:function(e){return this.copySampleValue_(e-1)}}),ao={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(e){return new ho(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new co(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new uo(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0!==t)this.createInterpolant=t;else{var r="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(r);this.setInterpolation(this.DefaultInterpolation)}console.warn("THREE.KeyframeTrackPrototype:",r)}},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,r=0,n=t.length;r!==n;++r)t[r]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,r=0,n=t.length;r!==n;++r)t[r]*=e;return this},trim:function(e,t){for(var r=this.times,n=r.length,i=0,o=n-1;i!==n&&r[i]<e;)++i;for(;-1!==o&&r[o]>t;)--o;if(++o,0!==i||o!==n){i>=o&&(i=(o=Math.max(o,1))-1);var a=this.getValueSize();this.times=so.arraySlice(r,i,o),this.values=so.arraySlice(this.values,i*a,o*a)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrackPrototype: Invalid value size in track.",this),e=!1);var r=this.times,n=this.values,i=r.length;0===i&&(console.error("THREE.KeyframeTrackPrototype: Track is empty.",this),e=!1);for(var o=null,a=0;a!==i;a++){var s=r[a];if("number"==typeof s&&isNaN(s)){console.error("THREE.KeyframeTrackPrototype: Time is not a valid number.",this,a,s),e=!1;break}if(null!==o&&o>s){console.error("THREE.KeyframeTrackPrototype: Out of order keys.",this,a,s,o),e=!1;break}o=s}if(void 0!==n&&so.isTypedArray(n)){a=0;for(var l=n.length;a!==l;++a){var u=n[a];if(isNaN(u)){console.error("THREE.KeyframeTrackPrototype: Value is not a valid number.",this,a,u),e=!1;break}}}return e},optimize:function(){for(var e=this.times,t=this.values,r=this.getValueSize(),n=2302===this.getInterpolation(),i=1,o=e.length-1,a=1;a<o;++a){var s=!1,l=e[a];if(l!==e[a+1]&&(1!==a||l!==l[0]))if(n)s=!0;else for(var u=a*r,c=u-r,h=u+r,p=0;p!==r;++p){var d=t[u+p];if(d!==t[c+p]||d!==t[h+p]){s=!0;break}}if(s){if(a!==i){e[i]=e[a];var f=a*r,m=i*r;for(p=0;p!==r;++p)t[m+p]=t[f+p]}++i}}if(o>0){e[i]=e[o];for(f=o*r,m=i*r,p=0;p!==r;++p)t[m+p]=t[f+p];++i}return i!==e.length&&(this.times=so.arraySlice(e,0,i),this.values=so.arraySlice(t,0,i*r)),this}},fo.prototype=Object.assign(Object.create(ao),{constructor:fo,ValueTypeName:"vector"}),mo.prototype=Object.assign(Object.create(lo.prototype),{constructor:mo,interpolate_:function(e,t,r,n){for(var i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=e*a,l=(r-t)/(n-t),u=s+a;s!==u;s+=4)dt.slerpFlat(i,0,o,s-a,o,s,l);return i}}),go.prototype=Object.assign(Object.create(ao),{constructor:go,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(e){return new mo(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),vo.prototype=Object.assign(Object.create(ao),{constructor:vo,ValueTypeName:"number"}),yo.prototype=Object.assign(Object.create(ao),{constructor:yo,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),bo.prototype=Object.assign(Object.create(ao),{constructor:bo,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),wo.prototype=Object.assign(Object.create(ao),{constructor:wo,ValueTypeName:"color"}),xo.prototype=ao,ao.constructor=xo,Object.assign(xo,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=xo._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var r=[],n=[];so.flattenJSON(e.keys,r,n,"value"),e.times=r,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,r=e.constructor;if(void 0!==r.toJSON)t=r.toJSON(e);else{t={name:e.name,times:so.convertArray(e.times,Array),values:so.convertArray(e.values,Array)};var n=e.getInterpolation();n!==e.DefaultInterpolation&&(t.interpolation=n)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return vo;case"vector":case"vector2":case"vector3":case"vector4":return fo;case"color":return wo;case"quaternion":return go;case"bool":case"boolean":return bo;case"string":return yo}throw new Error("Unsupported typeName: "+e)}}),Object.assign(_o,{parse:function(e){for(var t=[],r=e.tracks,n=1/(e.fps||1),i=0,o=r.length;i!==o;++i)t.push(xo.parse(r[i]).scale(n));return new _o(e.name,e.duration,t)},toJSON:function(e){for(var t=[],r=e.tracks,n={name:e.name,duration:e.duration,tracks:t},i=0,o=r.length;i!==o;++i)t.push(xo.toJSON(r[i]));return n},CreateFromMorphTargetSequence:function(e,t,r,n){for(var i=t.length,o=[],a=0;a<i;a++){var s=[],l=[];s.push((a+i-1)%i,a,(a+1)%i),l.push(0,1,0);var u=so.getKeyframeOrder(s);s=so.sortedArray(s,1,u),l=so.sortedArray(l,1,u),n||0!==s[0]||(s.push(i),l.push(l[0])),o.push(new vo(".morphTargetInfluences["+t[a].name+"]",s,l).scale(1/r))}return new _o(e,-1,o)},findByName:function(e,t){var r=e;if(!Array.isArray(e)){var n=e;r=n.geometry&&n.geometry.animations||n.animations}for(var i=0;i<r.length;i++)if(r[i].name===t)return r[i];return null},CreateClipsFromMorphTargetSequences:function(e,t,r){for(var n={},i=/^([\w-]*?)([\d]+)$/,o=0,a=e.length;o<a;o++){var s=e[o],l=s.name.match(i);if(l&&l.length>1){var u=n[h=l[1]];u||(n[h]=u=[]),u.push(s)}}var c=[];for(var h in n)c.push(_o.CreateFromMorphTargetSequence(h,n[h],t,r));return c},parseAnimation:function(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;for(var r=function(e,t,r,n,i){if(0!==r.length){var o=[],a=[];so.flattenJSON(r,o,a,n),0!==o.length&&i.push(new e(t,o,a))}},n=[],i=e.name||"default",o=e.length||-1,a=e.fps||30,s=e.hierarchy||[],l=0;l<s.length;l++){var u=s[l].keys;if(u&&0!==u.length)if(u[0].morphTargets){for(var c={},h=0;h<u.length;h++)if(u[h].morphTargets)for(var p=0;p<u[h].morphTargets.length;p++)c[u[h].morphTargets[p]]=-1;for(var d in c){var f=[],m=[];for(p=0;p!==u[h].morphTargets.length;++p){var g=u[h];f.push(g.time),m.push(g.morphTarget===d?1:0)}n.push(new vo(".morphTargetInfluence["+d+"]",f,m))}o=c.length*(a||1)}else{var v=".bones["+t[l].name+"]";r(fo,v+".position",u,"pos",n),r(go,v+".quaternion",u,"rot",n),r(fo,v+".scale",u,"scl",n)}}return 0===n.length?null:new _o(i,o,n)}}),Object.assign(_o.prototype,{resetDuration:function(){for(var e=0,t=0,r=this.tracks.length;t!==r;++t){var n=this.tracks[t];e=Math.max(e,n.times[n.times.length-1])}this.duration=e},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(So.prototype,{load:function(e,t,r,n){var i=this;new qi(i.manager).load(e,function(e){t(i.parse(JSON.parse(e)))},r,n)},setTextures:function(e){this.textures=e},parse:function(e){var t=this.textures;function r(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}var n=new ji[e.type];if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&n.specular.setHex(e.specular),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearCoat&&(n.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(n.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(n.uniforms=e.uniforms),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(n.vertexColors=e.vertexColors),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.side&&(n.side=e.side),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),1!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.skinning&&(n.skinning=e.skinning),void 0!==e.morphTargets&&(n.morphTargets=e.morphTargets),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.shading&&(n.flatShading=1===e.shading),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(n.map=r(e.map)),void 0!==e.alphaMap&&(n.alphaMap=r(e.alphaMap),n.transparent=!0),void 0!==e.bumpMap&&(n.bumpMap=r(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=r(e.normalMap)),void 0!==e.normalScale){var i=e.normalScale;!1===Array.isArray(i)&&(i=[i,i]),n.normalScale=(new ht).fromArray(i)}return void 0!==e.displacementMap&&(n.displacementMap=r(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=r(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=r(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=r(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=r(e.specularMap)),void 0!==e.envMap&&(n.envMap=r(e.envMap)),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.lightMap&&(n.lightMap=r(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=r(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=r(e.gradientMap)),n}}),Object.assign(Co.prototype,{load:function(e,t,r,n){var i=this;new qi(i.manager).load(e,function(e){t(i.parse(JSON.parse(e)))},r,n)},parse:function(e){var t=new Yr,r=e.data.index;if(void 0!==r){var n=new Mo[r.type](r.array);t.setIndex(new Lr(n,1))}var i=e.data.attributes;for(var o in i){var a=i[o];n=new Mo[a.type](a.array);t.addAttribute(o,new Lr(n,a.itemSize,a.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var l=0,u=s.length;l!==u;++l){var c=s[l];t.addGroup(c.start,c.count,c.materialIndex)}var h=e.data.boundingSphere;if(void 0!==h){var p=new ft;void 0!==h.center&&p.fromArray(h.center),t.boundingSphere=new Sr(p,h.radius)}return t}});var Mo={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function To(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function Ao(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:Gi,this.withCredentials=!1}To.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,r=0,n=t.length;r<n;r+=2){var i=t[r],o=t[r+1];if(i.test(e))return o}return null}},Object.assign(To.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,r){for(var n=[],i=0;i<e.length;++i)n[i]=this.createMaterial(e[i],t,r);return n},createMaterial:function(){var e={NoBlending:x,NormalBlending:_,AdditiveBlending:S,SubtractiveBlending:C,MultiplyBlending:M,CustomBlending:T},t=new ur,r=new Ki,n=new So;return function(i,o,a){var s={};function l(e,t,n,i,l){var u,c=o+e,h=To.Handlers.get(c);null!==h?u=h.load(c):(r.setCrossOrigin(a),u=r.load(c)),void 0!==t&&(u.repeat.fromArray(t),1!==t[0]&&(u.wrapS=pe),1!==t[1]&&(u.wrapT=pe)),void 0!==n&&u.offset.fromArray(n),void 0!==i&&("repeat"===i[0]&&(u.wrapS=pe),"mirror"===i[0]&&(u.wrapS=fe),"repeat"===i[1]&&(u.wrapT=pe),"mirror"===i[1]&&(u.wrapT=fe)),void 0!==l&&(u.anisotropy=l);var p=ct.generateUUID();return s[p]=u,p}var u={uuid:ct.generateUUID(),type:"MeshLambertMaterial"};for(var c in i){var h=i[c];switch(c){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":u.name=h;break;case"blending":u.blending=e[h];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",c,"is no longer supported.");break;case"colorDiffuse":u.color=t.fromArray(h).getHex();break;case"colorSpecular":u.specular=t.fromArray(h).getHex();break;case"colorEmissive":u.emissive=t.fromArray(h).getHex();break;case"specularCoef":u.shininess=h;break;case"shading":"basic"===h.toLowerCase()&&(u.type="MeshBasicMaterial"),"phong"===h.toLowerCase()&&(u.type="MeshPhongMaterial"),"standard"===h.toLowerCase()&&(u.type="MeshStandardMaterial");break;case"mapDiffuse":u.map=l(h,i.mapDiffuseRepeat,i.mapDiffuseOffset,i.mapDiffuseWrap,i.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":u.emissiveMap=l(h,i.mapEmissiveRepeat,i.mapEmissiveOffset,i.mapEmissiveWrap,i.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":u.lightMap=l(h,i.mapLightRepeat,i.mapLightOffset,i.mapLightWrap,i.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":u.aoMap=l(h,i.mapAORepeat,i.mapAOOffset,i.mapAOWrap,i.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":u.bumpMap=l(h,i.mapBumpRepeat,i.mapBumpOffset,i.mapBumpWrap,i.mapBumpAnisotropy);break;case"mapBumpScale":u.bumpScale=h;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":u.normalMap=l(h,i.mapNormalRepeat,i.mapNormalOffset,i.mapNormalWrap,i.mapNormalAnisotropy);break;case"mapNormalFactor":u.normalScale=[h,h];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":u.specularMap=l(h,i.mapSpecularRepeat,i.mapSpecularOffset,i.mapSpecularWrap,i.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":u.metalnessMap=l(h,i.mapMetalnessRepeat,i.mapMetalnessOffset,i.mapMetalnessWrap,i.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":u.roughnessMap=l(h,i.mapRoughnessRepeat,i.mapRoughnessOffset,i.mapRoughnessWrap,i.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":u.alphaMap=l(h,i.mapAlphaRepeat,i.mapAlphaOffset,i.mapAlphaWrap,i.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":u.side=g;break;case"doubleSided":u.side=v;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),u.opacity=h;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":u[c]=h;break;case"vertexColors":!0===h&&(u.vertexColors=w),"face"===h&&(u.vertexColors=b);break;default:console.error("THREE.Loader.createMaterial: Unsupported",c,h)}}return"MeshBasicMaterial"===u.type&&delete u.emissive,"MeshPhongMaterial"!==u.type&&delete u.specular,u.opacity<1&&(u.transparent=!0),n.setTextures(s),n.parse(u)}}()}),Object.assign(Ao.prototype,{load:function(e,t,r,n){var i=this,o=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:To.prototype.extractUrlBase(e),a=new qi(this.manager);a.setWithCredentials(this.withCredentials),a.load(e,function(r){var n=JSON.parse(r),a=n.metadata;if(void 0!==a){var s=a.type;if(void 0!==s){if("object"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var l=i.parse(n,o);t(l.geometry,l.materials)},r,n)},setTexturePath:function(e){this.texturePath=e},parse:function(){return function(e,t){void 0!==e.data&&(e=e.data),void 0!==e.scale?e.scale=1/e.scale:e.scale=1;var r=new Fr;return function(e,t){function r(e,t){return e&1<<t}var n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T,A,E=e.faces,P=e.vertices,R=e.normals,I=e.colors,N=e.scale,D=0;if(void 0!==e.uvs){for(n=0;n<e.uvs.length;n++)e.uvs[n].length&&D++;for(n=0;n<D;n++)t.faceVertexUvs[n]=[]}for(a=0,s=P.length;a<s;)(w=new ft).x=P[a++]*N,w.y=P[a++]*N,w.z=P[a++]*N,t.vertices.push(w);for(a=0,s=E.length;a<s;)if(d=r(p=E[a++],0),f=r(p,1),m=r(p,3),g=r(p,4),v=r(p,5),y=r(p,6),b=r(p,7),d){if((_=new kr).a=E[a],_.b=E[a+1],_.c=E[a+3],(S=new kr).a=E[a+1],S.b=E[a+2],S.c=E[a+3],a+=4,f&&(h=E[a++],_.materialIndex=h,S.materialIndex=h),o=t.faces.length,m)for(n=0;n<D;n++)for(T=e.uvs[n],t.faceVertexUvs[n][o]=[],t.faceVertexUvs[n][o+1]=[],i=0;i<4;i++)A=new ht(T[2*(c=E[a++])],T[2*c+1]),2!==i&&t.faceVertexUvs[n][o].push(A),0!==i&&t.faceVertexUvs[n][o+1].push(A);if(g&&(u=3*E[a++],_.normal.set(R[u++],R[u++],R[u]),S.normal.copy(_.normal)),v)for(n=0;n<4;n++)u=3*E[a++],M=new ft(R[u++],R[u++],R[u]),2!==n&&_.vertexNormals.push(M),0!==n&&S.vertexNormals.push(M);if(y&&(C=I[l=E[a++]],_.color.setHex(C),S.color.setHex(C)),b)for(n=0;n<4;n++)C=I[l=E[a++]],2!==n&&_.vertexColors.push(new ur(C)),0!==n&&S.vertexColors.push(new ur(C));t.faces.push(_),t.faces.push(S)}else{if((x=new kr).a=E[a++],x.b=E[a++],x.c=E[a++],f&&(h=E[a++],x.materialIndex=h),o=t.faces.length,m)for(n=0;n<D;n++)for(T=e.uvs[n],t.faceVertexUvs[n][o]=[],i=0;i<3;i++)A=new ht(T[2*(c=E[a++])],T[2*c+1]),t.faceVertexUvs[n][o].push(A);if(g&&(u=3*E[a++],x.normal.set(R[u++],R[u++],R[u])),v)for(n=0;n<3;n++)u=3*E[a++],M=new ft(R[u++],R[u++],R[u]),x.vertexNormals.push(M);if(y&&(l=E[a++],x.color.setHex(I[l])),b)for(n=0;n<3;n++)l=E[a++],x.vertexColors.push(new ur(I[l]));t.faces.push(x)}}(e,r),function(e,t){var r=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var n=0,i=e.skinWeights.length;n<i;n+=r){var o=e.skinWeights[n],a=r>1?e.skinWeights[n+1]:0,s=r>2?e.skinWeights[n+2]:0,l=r>3?e.skinWeights[n+3]:0;t.skinWeights.push(new yt(o,a,s,l))}if(e.skinIndices)for(n=0,i=e.skinIndices.length;n<i;n+=r){var u=e.skinIndices[n],c=r>1?e.skinIndices[n+1]:0,h=r>2?e.skinIndices[n+2]:0,p=r>3?e.skinIndices[n+3]:0;t.skinIndices.push(new yt(u,c,h,p))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}(e,r),function(e,t){var r=e.scale;if(void 0!==e.morphTargets)for(var n=0,i=e.morphTargets.length;n<i;n++){t.morphTargets[n]={},t.morphTargets[n].name=e.morphTargets[n].name,t.morphTargets[n].vertices=[];for(var o=t.morphTargets[n].vertices,a=e.morphTargets[n].vertices,s=0,l=a.length;s<l;s+=3){var u=new ft;u.x=a[s]*r,u.y=a[s+1]*r,u.z=a[s+2]*r,o.push(u)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');var c=t.faces,h=e.morphColors[0].colors;for(n=0,i=c.length;n<i;n++)c[n].color.fromArray(h,3*n)}}(e,r),function(e,t){var r=[],n=[];void 0!==e.animation&&n.push(e.animation),void 0!==e.animations&&(e.animations.length?n=n.concat(e.animations):n.push(e.animations));for(var i=0;i<n.length;i++){var o=_o.parseAnimation(n[i],t.bones);o&&r.push(o)}if(t.morphTargets){var a=_o.CreateClipsFromMorphTargetSequences(t.morphTargets,10);r=r.concat(a)}r.length>0&&(t.animations=r)}(e,r),r.computeFaceNormals(),r.computeBoundingSphere(),void 0===e.materials||0===e.materials.length?{geometry:r}:{geometry:r,materials:To.prototype.initMaterials(e.materials,t,this.crossOrigin)}}}()}),Object.assign(function(e){this.manager=void 0!==e?e:Gi,this.texturePath=""}.prototype,{load:function(e,t,r,n){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var i=this;new qi(i.manager).load(e,function(r){var o=null;try{o=JSON.parse(r)}catch(t){return void 0!==n&&n(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var a=o.metadata;void 0!==a&&void 0!==a.type&&"geometry"!==a.type.toLowerCase()?i.parse(o,t):console.error("THREE.ObjectLoader: Can't load "+e+". Use THREE.JSONLoader instead.")},r,n)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var r=this.parseGeometries(e.geometries),n=this.parseImages(e.images,function(){void 0!==t&&t(a)}),i=this.parseTextures(e.textures,n),o=this.parseMaterials(e.materials,i),a=this.parseObject(e.object,r,o);return e.animations&&(a.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(a),a},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new Ao,n=new Co,i=0,o=e.length;i<o;i++){var a,s=e[i];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new Ni[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":a=new Ni[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":a=new Ni[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":a=new Ni[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":a=new Ni[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":a=new Ni[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":a=new Ni[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":a=new Ni[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":a=new Ni[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":a=new Ni[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":a=new Ni[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":a=new Ni[s.type](s.vertices,s.indices,s.radius,s.details);break;case"BufferGeometry":a=n.parse(s);break;case"Geometry":a=r.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),t[s.uuid]=a}return t},parseMaterials:function(e,t){var r={};if(void 0!==e){var n=new So;n.setTextures(t);for(var i=0,o=e.length;i<o;i++){var a=e[i];if("MultiMaterial"===a.type){for(var s=[],l=0;l<a.materials.length;l++)s.push(n.parse(a.materials[l]));r[a.uuid]=s}else r[a.uuid]=n.parse(a)}}return r},parseAnimations:function(e){for(var t=[],r=0;r<e.length;r++){var n=_o.parse(e[r]);t.push(n)}return t},parseImages:function(e,t){var r=this,n={};function i(e){return r.manager.itemStart(e),o.load(e,function(){r.manager.itemEnd(e)},void 0,function(){r.manager.itemEnd(e),r.manager.itemError(e)})}if(void 0!==e&&e.length>0){var o=new Xi(new $i(t));o.setCrossOrigin(this.crossOrigin);for(var a=0,s=e.length;a<s;a++){var l=e[a],u=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(l.url)?l.url:r.texturePath+l.url;n[l.uuid]=i(u)}}return n},parseTextures:function(e,t){function r(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var n={};if(void 0!==e)for(var i=0,o=e.length;i<o;i++){var a=e[i];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var s=new vt(t[a.image]);s.needsUpdate=!0,s.uuid=a.uuid,void 0!==a.name&&(s.name=a.name),void 0!==a.mapping&&(s.mapping=r(a.mapping,Eo)),void 0!==a.offset&&s.offset.fromArray(a.offset),void 0!==a.repeat&&s.repeat.fromArray(a.repeat),void 0!==a.center&&s.center.fromArray(a.center),void 0!==a.rotation&&(s.rotation=a.rotation),void 0!==a.wrap&&(s.wrapS=r(a.wrap[0],Po),s.wrapT=r(a.wrap[1],Po)),void 0!==a.minFilter&&(s.minFilter=r(a.minFilter,Ro)),void 0!==a.magFilter&&(s.magFilter=r(a.magFilter,Ro)),void 0!==a.anisotropy&&(s.anisotropy=a.anisotropy),void 0!==a.flipY&&(s.flipY=a.flipY),n[a.uuid]=s}return n},parseObject:function(){var e=new pt;return function(t,r,n){var i;function o(e){return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),r[e]}function a(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],r=0,i=e.length;r<i;r++){var o=e[r];void 0===n[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(n[o])}return t}return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),n[e]}}switch(t.type){case"Scene":i=new Pn,void 0!==t.background&&Number.isInteger(t.background)&&(i.background=new ur(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?i.fog=new En(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(i.fog=new An(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":i=new Cn(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(i.focus=t.focus),void 0!==t.zoom&&(i.zoom=t.zoom),void 0!==t.filmGauge&&(i.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(i.filmOffset=t.filmOffset),void 0!==t.view&&(i.view=Object.assign({},t.view));break;case"OrthographicCamera":i=new Dr(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":i=new io(t.color,t.intensity);break;case"DirectionalLight":i=new no(t.color,t.intensity);break;case"PointLight":i=new to(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":i=new oo(t.color,t.intensity,t.width,t.height);break;case"SpotLight":i=new eo(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":i=new Zi(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var s=o(t.geometry),l=a(t.material);i=s.bones&&s.bones.length>0?new Fn(s,l):new sn(s,l);break;case"LOD":i=new Dn;break;case"Line":i=new Un(o(t.geometry),a(t.material),t.mode);break;case"LineLoop":i=new Bn(o(t.geometry),a(t.material));break;case"LineSegments":i=new Vn(o(t.geometry),a(t.material));break;case"PointCloud":case"Points":i=new jn(o(t.geometry),a(t.material));break;case"Sprite":i=new Nn(a(t.material));break;case"Group":i=new Hn;break;default:i=new Ir}if(i.uuid=t.uuid,void 0!==t.name&&(i.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(i.position,i.quaternion,i.scale)):(void 0!==t.position&&i.position.fromArray(t.position),void 0!==t.rotation&&i.rotation.fromArray(t.rotation),void 0!==t.quaternion&&i.quaternion.fromArray(t.quaternion),void 0!==t.scale&&i.scale.fromArray(t.scale)),void 0!==t.castShadow&&(i.castShadow=t.castShadow),void 0!==t.receiveShadow&&(i.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(i.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(i.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&i.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(i.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(i.visible=t.visible),void 0!==t.userData&&(i.userData=t.userData),void 0!==t.children)for(var u=t.children,c=0;c<u.length;c++)i.add(this.parseObject(u[c],r,n));if("LOD"===t.type)for(var h=t.levels,p=0;p<h.length;p++){var d=h[p],f=i.getObjectByProperty("uuid",d.object);void 0!==f&&i.addLevel(f,d.distance)}return i}}()});var Eo={UVMapping:300,CubeReflectionMapping:oe,CubeRefractionMapping:ae,EquirectangularReflectionMapping:se,EquirectangularRefractionMapping:le,SphericalReflectionMapping:ue,CubeUVReflectionMapping:ce,CubeUVRefractionMapping:he},Po={RepeatWrapping:pe,ClampToEdgeWrapping:de,MirroredRepeatWrapping:fe},Ro={NearestFilter:ge,NearestMipMapNearestFilter:ve,NearestMipMapLinearFilter:ye,LinearFilter:be,LinearMipMapNearestFilter:we,LinearMipMapLinearFilter:xe};function Io(e,t,r,n,i){var o=.5*(n-t),a=.5*(i-r),s=e*e;return(2*r-2*n+o+a)*(e*s)+(-3*r+3*n-2*o-a)*s+o*e+r}function No(e,t,r,n){return function(e,t){var r=1-e;return r*r*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,r)+function(e,t){return e*e*t}(e,n)}function Do(e,t,r,n,i){return function(e,t){var r=1-e;return r*r*r*t}(e,t)+function(e,t){var r=1-e;return 3*r*r*e*t}(e,r)+function(e,t){return 3*(1-e)*e*e*t}(e,n)+function(e,t){return e*e*e*t}(e,i)}function ko(){this.type="Curve",this.arcLengthDivisions=200}function Oo(e,t){ko.call(this),this.type="LineCurve",this.v1=e||new ht,this.v2=t||new ht}function Fo(){ko.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function Lo(e,t,r,n,i,o,a,s){ko.call(this),this.type="EllipseCurve",this.aX=e||0,this.aY=t||0,this.xRadius=r||1,this.yRadius=n||1,this.aStartAngle=i||0,this.aEndAngle=o||2*Math.PI,this.aClockwise=a||!1,this.aRotation=s||0}function Uo(e){ko.call(this),this.type="SplineCurve",this.points=e||[]}function Vo(e,t,r,n){ko.call(this),this.type="CubicBezierCurve",this.v0=e||new ht,this.v1=t||new ht,this.v2=r||new ht,this.v3=n||new ht}function Bo(e,t,r){ko.call(this),this.type="QuadraticBezierCurve",this.v0=e||new ht,this.v1=t||new ht,this.v2=r||new ht}Object.assign(ko.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e,t){var r=this.getUtoTmapping(e);return this.getPoint(r,t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,r,n=[],i=this.getPoint(0),o=0;for(n.push(0),r=1;r<=e;r++)o+=(t=this.getPoint(r/e)).distanceTo(i),n.push(o),i=t;return this.cacheArcLengths=n,n},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var r,n=this.getLengths(),i=0,o=n.length;r=t||e*n[o-1];for(var a,s=0,l=o-1;s<=l;)if((a=n[i=Math.floor(s+(l-s)/2)]-r)<0)s=i+1;else{if(!(a>0)){l=i;break}l=i-1}if(n[i=l]===r)return i/(o-1);var u=n[i];return(i+(r-u)/(n[i+1]-u))/(o-1)},getTangent:function(e){var t=e-1e-4,r=e+1e-4;t<0&&(t=0),r>1&&(r=1);var n=this.getPoint(t);return this.getPoint(r).clone().sub(n).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var r,n,i,o=new ft,a=[],s=[],l=[],u=new ft,c=new pt;for(r=0;r<=e;r++)n=r/e,a[r]=this.getTangentAt(n),a[r].normalize();s[0]=new ft,l[0]=new ft;var h=Number.MAX_VALUE,p=Math.abs(a[0].x),d=Math.abs(a[0].y),f=Math.abs(a[0].z);for(p<=h&&(h=p,o.set(1,0,0)),d<=h&&(h=d,o.set(0,1,0)),f<=h&&o.set(0,0,1),u.crossVectors(a[0],o).normalize(),s[0].crossVectors(a[0],u),l[0].crossVectors(a[0],s[0]),r=1;r<=e;r++)s[r]=s[r-1].clone(),l[r]=l[r-1].clone(),u.crossVectors(a[r-1],a[r]),u.length()>Number.EPSILON&&(u.normalize(),i=Math.acos(ct.clamp(a[r-1].dot(a[r]),-1,1)),s[r].applyMatrix4(c.makeRotationAxis(u,i))),l[r].crossVectors(a[r],s[r]);if(!0===t)for(i=Math.acos(ct.clamp(s[0].dot(s[e]),-1,1)),i/=e,a[0].dot(u.crossVectors(s[0],s[e]))>0&&(i=-i),r=1;r<=e;r++)s[r].applyMatrix4(c.makeRotationAxis(a[r],i*r)),l[r].crossVectors(a[r],s[r]);return{tangents:a,normals:s,binormals:l}},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}),Oo.prototype=Object.create(ko.prototype),Oo.prototype.constructor=Oo,Oo.prototype.isLineCurve=!0,Oo.prototype.getPoint=function(e,t){var r=t||new ht;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},Oo.prototype.getPointAt=function(e,t){return this.getPoint(e,t)},Oo.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},Oo.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v1.copy(e.v1),this.v2.copy(e.v2),this},Fo.prototype=Object.assign(Object.create(ko.prototype),{constructor:Fo,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Oo(t,e))},getPoint:function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=t){var i=r[n]-t,o=this.curves[n],a=o.getLength(),s=0===a?0:1-i/a;return o.getPointAt(s)}n++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,r=0,n=this.curves.length;r<n;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,r=[],n=0,i=this.curves;n<i.length;n++)for(var o=i[n],a=o&&o.isEllipseCurve?2*e:o&&o.isLineCurve?1:o&&o.isSplineCurve?e*o.points.length:e,s=o.getPoints(a),l=0;l<s.length;l++){var u=s[l];t&&t.equals(u)||(r.push(u),t=u)}return this.autoClose&&r.length>1&&!r[r.length-1].equals(r[0])&&r.push(r[0]),r},copy:function(e){ko.prototype.copy.call(this,e),this.curves=[];for(var t=0,r=e.curves.length;t<r;t++){var n=e.curves[t];this.curves.push(n.clone())}return this.autoClose=e.autoClose,this}}),Lo.prototype=Object.create(ko.prototype),Lo.prototype.constructor=Lo,Lo.prototype.isEllipseCurve=!0,Lo.prototype.getPoint=function(e,t){for(var r=t||new ht,n=2*Math.PI,i=this.aEndAngle-this.aStartAngle,o=Math.abs(i)<Number.EPSILON;i<0;)i+=n;for(;i>n;)i-=n;i<Number.EPSILON&&(i=o?0:n),!0!==this.aClockwise||o||(i===n?i=-n:i-=n);var a=this.aStartAngle+e*i,s=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){var u=Math.cos(this.aRotation),c=Math.sin(this.aRotation),h=s-this.aX,p=l-this.aY;s=h*u-p*c+this.aX,l=h*c+p*u+this.aY}return r.set(s,l)},Lo.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this},Uo.prototype=Object.create(ko.prototype),Uo.prototype.constructor=Uo,Uo.prototype.isSplineCurve=!0,Uo.prototype.getPoint=function(e,t){var r=t||new ht,n=this.points,i=(n.length-1)*e,o=Math.floor(i),a=i-o,s=n[0===o?o:o-1],l=n[o],u=n[o>n.length-2?n.length-1:o+1],c=n[o>n.length-3?n.length-1:o+2];return r.set(Io(a,s.x,l.x,u.x,c.x),Io(a,s.y,l.y,u.y,c.y)),r},Uo.prototype.copy=function(e){ko.prototype.copy.call(this,e),this.points=[];for(var t=0,r=e.points.length;t<r;t++){var n=e.points[t];this.points.push(n.clone())}return this},Vo.prototype=Object.create(ko.prototype),Vo.prototype.constructor=Vo,Vo.prototype.isCubicBezierCurve=!0,Vo.prototype.getPoint=function(e,t){var r=t||new ht,n=this.v0,i=this.v1,o=this.v2,a=this.v3;return r.set(Do(e,n.x,i.x,o.x,a.x),Do(e,n.y,i.y,o.y,a.y)),r},Vo.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this},Bo.prototype=Object.create(ko.prototype),Bo.prototype.constructor=Bo,Bo.prototype.isQuadraticBezierCurve=!0,Bo.prototype.getPoint=function(e,t){var r=t||new ht,n=this.v0,i=this.v1,o=this.v2;return r.set(No(e,n.x,i.x,o.x),No(e,n.y,i.y,o.y)),r},Bo.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this};var zo,jo=Object.assign(Object.create(Fo.prototype),{setFromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;t<r;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var r=new Oo(this.currentPoint.clone(),new ht(e,t));this.curves.push(r),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,r,n){var i=new Bo(this.currentPoint.clone(),new ht(e,t),new ht(r,n));this.curves.push(i),this.currentPoint.set(r,n)},bezierCurveTo:function(e,t,r,n,i,o){var a=new Vo(this.currentPoint.clone(),new ht(e,t),new ht(r,n),new ht(i,o));this.curves.push(a),this.currentPoint.set(i,o)},splineThru:function(e){var t=new Uo([this.currentPoint.clone()].concat(e));this.curves.push(t),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,r,n,i,o){var a=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+a,t+s,r,n,i,o)},absarc:function(e,t,r,n,i,o){this.absellipse(e,t,r,r,n,i,o)},ellipse:function(e,t,r,n,i,o,a,s){var l=this.currentPoint.x,u=this.currentPoint.y;this.absellipse(e+l,t+u,r,n,i,o,a,s)},absellipse:function(e,t,r,n,i,o,a,s){var l=new Lo(e,t,r,n,i,o,a,s);if(this.curves.length>0){var u=l.getPoint(0);u.equals(this.currentPoint)||this.lineTo(u.x,u.y)}this.curves.push(l);var c=l.getPoint(1);this.currentPoint.copy(c)},copy:function(e){return Fo.prototype.copy.call(this,e),this.currentPoint.copy(e.currentPoint),this}});function Ho(e){Fo.call(this),this.type="Path",this.currentPoint=new ht,e&&this.setFromPoints(e)}function $o(e){Ho.call(this,e),this.type="Shape",this.holes=[]}function Go(){this.type="ShapePath",this.subPaths=[],this.currentPath=null}function Wo(e){this.type="Font",this.data=e}Ho.prototype=jo,jo.constructor=Ho,$o.prototype=Object.assign(Object.create(jo),{constructor:$o,getPointsHoles:function(e){for(var t=[],r=0,n=this.holes.length;r<n;r++)t[r]=this.holes[r].getPoints(e);return t},extractPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},copy:function(e){Ho.prototype.copy.call(this,e),this.holes=[];for(var t=0,r=e.holes.length;t<r;t++){var n=e.holes[t];this.holes.push(n.clone())}return this}}),Object.assign(Go.prototype,{moveTo:function(e,t){this.currentPath=new Ho,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,r,n){this.currentPath.quadraticCurveTo(e,t,r,n)},bezierCurveTo:function(e,t,r,n,i,o){this.currentPath.bezierCurveTo(e,t,r,n,i,o)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function r(e){for(var t=[],r=0,n=e.length;r<n;r++){var i=e[r],o=new $o;o.curves=i.curves,t.push(o)}return t}function n(e,t){for(var r=t.length,n=!1,i=r-1,o=0;o<r;i=o++){var a=t[i],s=t[o],l=s.x-a.x,u=s.y-a.y;if(Math.abs(u)>Number.EPSILON){if(u<0&&(a=t[o],l=-l,s=t[i],u=-u),e.y<a.y||e.y>s.y)continue;if(e.y===a.y){if(e.x===a.x)return!0}else{var c=u*(e.x-a.x)-l*(e.y-a.y);if(0===c)return!0;if(c<0)continue;n=!n}}else{if(e.y!==a.y)continue;if(s.x<=e.x&&e.x<=a.x||a.x<=e.x&&e.x<=s.x)return!0}}return n}var i=pi.isClockWise,o=this.subPaths;if(0===o.length)return[];if(!0===t)return r(o);var a,s,l,u=[];if(1===o.length)return s=o[0],(l=new $o).curves=s.curves,u.push(l),u;var c=!i(o[0].getPoints());c=e?!c:c;var h,p,d=[],f=[],m=[],g=0;f[g]=void 0,m[g]=[];for(var v=0,y=o.length;v<y;v++)a=i(h=(s=o[v]).getPoints()),(a=e?!a:a)?(!c&&f[g]&&g++,f[g]={s:new $o,p:h},f[g].s.curves=s.curves,c&&g++,m[g]=[]):m[g].push({h:s,p:h[0]});if(!f[0])return r(o);if(f.length>1){for(var b=!1,w=[],x=0,_=f.length;x<_;x++)d[x]=[];for(x=0,_=f.length;x<_;x++)for(var S=m[x],C=0;C<S.length;C++){for(var M=S[C],T=!0,A=0;A<f.length;A++)n(M.p,f[A].p)&&(x!==A&&w.push({froms:x,tos:A,hole:C}),T?(T=!1,d[A].push(M)):b=!0);T&&d[x].push(M)}w.length>0&&(b||(m=d))}v=0;for(var E=f.length;v<E;v++){l=f[v].s,u.push(l);for(var P=0,R=(p=m[v]).length;P<R;P++)l.holes.push(p[P].h)}return u}}),Object.assign(Wo.prototype,{isFont:!0,generateShapes:function(e,t,r){function n(e,t,r,n){var o=i.glyphs[e]||i.glyphs["?"];if(o){var a,s,l,u,c,h,p,d,f,m=new Go,g=[];if(o.o)for(var v=o._cachedOutline||(o._cachedOutline=o.o.split(" ")),y=0,b=v.length;y<b;){switch(v[y++]){case"m":a=v[y++]*t+r,s=v[y++]*t+n,m.moveTo(a,s);break;case"l":a=v[y++]*t+r,s=v[y++]*t+n,m.lineTo(a,s);break;case"q":l=v[y++]*t+r,u=v[y++]*t+n,c=v[y++]*t+r,h=v[y++]*t+n,m.quadraticCurveTo(c,h,l,u),(f=g[g.length-1])&&(f.x,f.y);break;case"b":l=v[y++]*t+r,u=v[y++]*t+n,c=v[y++]*t+r,h=v[y++]*t+n,p=v[y++]*t+r,d=v[y++]*t+n,m.bezierCurveTo(c,h,p,d,l,u),(f=g[g.length-1])&&(f.x,f.y)}}return{offsetX:o.ha*t,path:m}}}void 0===t&&(t=100),void 0===r&&(r=4);for(var i=this.data,o=function(e){for(var r=String(e).split(""),o=t/i.resolution,a=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*o,s=0,l=0,u=[],c=0;c<r.length;c++){var h=r[c];if("\n"===h)s=0,l-=a;else{var p=n(h,o,s,l);s+=p.offsetX,u.push(p.path)}}return u}(e),a=[],s=0,l=o.length;s<l;s++)Array.prototype.push.apply(a,o[s].toShapes());return a}}),Object.assign(function(e){this.manager=void 0!==e?e:Gi}.prototype,{load:function(e,t,r,n){var i=this,o=new qi(this.manager);o.setPath(this.path),o.load(e,function(e){var r;try{r=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),r=JSON.parse(e.substring(65,e.length-2))}var n=i.parse(r);t&&t(n)},r,n)},parse:function(e){return new Wo(e)},setPath:function(e){return this.path=e,this}});var qo,Xo,Ko={getContext:function(){return void 0===zo&&(zo=new(window.AudioContext||window.webkitAudioContext)),zo},setContext:function(e){zo=e}};function Yo(e){this.manager=void 0!==e?e:Gi}function Zo(e,t,r){Ir.call(this),this.type="CubeCamera";var n=new Cn(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new ft(1,0,0)),this.add(n);var i=new Cn(90,1,e,t);i.up.set(0,-1,0),i.lookAt(new ft(-1,0,0)),this.add(i);var o=new Cn(90,1,e,t);o.up.set(0,0,1),o.lookAt(new ft(0,1,0)),this.add(o);var a=new Cn(90,1,e,t);a.up.set(0,0,-1),a.lookAt(new ft(0,-1,0)),this.add(a);var s=new Cn(90,1,e,t);s.up.set(0,-1,0),s.lookAt(new ft(0,0,1)),this.add(s);var l=new Cn(90,1,e,t);l.up.set(0,-1,0),l.lookAt(new ft(0,0,-1)),this.add(l);var u={format:Oe,magFilter:be,minFilter:be};this.renderTarget=new wt(r,r,u),this.renderTarget.texture.name="CubeCamera",this.update=function(e,t){null===this.parent&&this.updateMatrixWorld();var r=this.renderTarget,u=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,r.activeCubeFace=0,e.render(t,n,r),r.activeCubeFace=1,e.render(t,i,r),r.activeCubeFace=2,e.render(t,o,r),r.activeCubeFace=3,e.render(t,a,r),r.activeCubeFace=4,e.render(t,s,r),r.texture.generateMipmaps=u,r.activeCubeFace=5,e.render(t,l,r),e.setRenderTarget(null)},this.clear=function(e,t,r,n){for(var i=this.renderTarget,o=0;o<6;o++)i.activeCubeFace=o,e.setRenderTarget(i),e.clear(t,r,n);e.setRenderTarget(null)}}function Jo(){Ir.call(this),this.type="AudioListener",this.context=Ko.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Qo(e){Ir.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.offset=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function ea(e){Qo.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function ta(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function ra(e,t,r){this.binding=e,this.valueSize=r;var n,i=Float64Array;switch(t){case"quaternion":n=this._slerp;break;case"string":case"bool":i=Array,n=this._select;break;default:n=this._lerp}this.buffer=new i(4*r),this._mixBufferRegion=n,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function na(e,t,r){var n=r||ia.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}function ia(e,t,r){this.path=t,this.parsedPath=r||ia.parseTrackName(t),this.node=ia.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function oa(e,t,r){this._mixer=e,this._clip=t,this._localRoot=r||null;for(var n=t.tracks,i=n.length,o=new Array(i),a={endingStart:Ze,endingEnd:Ze},s=0;s!==i;++s){var l=n[s].createInterpolant(null);o[s]=l,l.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(i),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Ye,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function aa(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function sa(){Yr.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function la(e,t,r,n){this.uuid=ct.generateUUID(),this.data=e,this.itemSize=t,this.offset=r,this.normalized=!0===n}function ua(e,t){this.uuid=ct.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function ca(e,t,r){ua.call(this,e,t),this.meshPerAttribute=r||1}function ha(e,t,r){Lr.call(this,e,t),this.meshPerAttribute=r||1}function pa(e,t){return e.distance-t.distance}function da(e,t,r,n){if(!1!==e.visible&&(e.raycast(t,r),!0===n))for(var i=e.children,o=0,a=i.length;o<a;o++)da(i[o],t,r,!0)}function fa(e){Ir.call(this),this.material=e,this.render=function(){}}function ma(e,t,r,n){this.object=e,this.size=void 0!==t?t:1;var i=void 0!==r?r:16711680,o=void 0!==n?n:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=3*s.faces.length:s&&s.isBufferGeometry&&(a=s.attributes.normal.count);var l=new Yr,u=new Gr(2*a*3,3);l.addAttribute("position",u),Vn.call(this,l,new Ln({color:i,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function ga(e,t){Ir.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;for(var r=new Yr,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],i=0,o=1;i<32;i++,o++){var a=i/32*Math.PI*2,s=o/32*Math.PI*2;n.push(Math.cos(a),Math.sin(a),1,Math.cos(s),Math.sin(s),1)}r.addAttribute("position",new Gr(n,3));var l=new Ln({fog:!1});this.cone=new Vn(r,l),this.add(this.cone),this.update()}function va(e){for(var t=function e(t){var r=[];t&&t.isBone&&r.push(t);for(var n=0;n<t.children.length;n++)r.push.apply(r,e(t.children[n]));return r}(e),r=new Yr,n=[],i=[],o=new ur(0,0,1),a=new ur(0,1,0),s=0;s<t.length;s++){var l=t[s];l.parent&&l.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),i.push(o.r,o.g,o.b),i.push(a.r,a.g,a.b))}r.addAttribute("position",new Gr(n,3)),r.addAttribute("color",new Gr(i,3));var u=new Ln({vertexColors:w,depthTest:!1,depthWrite:!1,transparent:!0});Vn.call(this,r,u),this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}function ya(e,t,r){this.light=e,this.light.updateMatrixWorld(),this.color=r;var n=new yi(t,4,2),i=new tn({wireframe:!0,fog:!1});sn.call(this,n,i),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function ba(e,t){Ir.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;var r=new Ln({fog:!1}),n=new Yr;n.addAttribute("position",new Lr(new Float32Array(15),3)),this.line=new Un(n,r),this.add(this.line),this.update()}function wa(e,t,r){Ir.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r;var n=new ti(t);n.rotateY(.5*Math.PI),this.material=new tn({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=w);var i=n.getAttribute("position"),o=new Float32Array(3*i.count);n.addAttribute("color",new Lr(o,3)),this.add(new sn(n,this.material)),this.update()}function xa(e,t,r,n){e=e||10,t=t||10,r=new ur(void 0!==r?r:4473924),n=new ur(void 0!==n?n:8947848);for(var i=t/2,o=e/t,a=e/2,s=[],l=[],u=0,c=0,h=-a;u<=t;u++,h+=o){s.push(-a,0,h,a,0,h),s.push(h,0,-a,h,0,a);var p=u===i?r:n;p.toArray(l,c),c+=3,p.toArray(l,c),c+=3,p.toArray(l,c),c+=3,p.toArray(l,c),c+=3}var d=new Yr;d.addAttribute("position",new Gr(s,3)),d.addAttribute("color",new Gr(l,3));var f=new Ln({vertexColors:w});Vn.call(this,d,f)}function _a(e,t,r,n,i,o){e=e||10,t=t||16,r=r||8,n=n||64,i=new ur(void 0!==i?i:4473924),o=new ur(void 0!==o?o:8947848);var a,s,l,u,c,h,p,d=[],f=[];for(u=0;u<=t;u++)l=u/t*(2*Math.PI),a=Math.sin(l)*e,s=Math.cos(l)*e,d.push(0,0,0),d.push(a,0,s),p=1&u?i:o,f.push(p.r,p.g,p.b),f.push(p.r,p.g,p.b);for(u=0;u<=r;u++)for(p=1&u?i:o,h=e-e/r*u,c=0;c<n;c++)l=c/n*(2*Math.PI),a=Math.sin(l)*h,s=Math.cos(l)*h,d.push(a,0,s),f.push(p.r,p.g,p.b),l=(c+1)/n*(2*Math.PI),a=Math.sin(l)*h,s=Math.cos(l)*h,d.push(a,0,s),f.push(p.r,p.g,p.b);var m=new Yr;m.addAttribute("position",new Gr(d,3)),m.addAttribute("color",new Gr(f,3));var g=new Ln({vertexColors:w});Vn.call(this,m,g)}function Sa(e,t,r,n){this.object=e,this.size=void 0!==t?t:1;var i=void 0!==r?r:16776960,o=void 0!==n?n:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var l=new Yr,u=new Gr(2*a*3,3);l.addAttribute("position",u),Vn.call(this,l,new Ln({color:i,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function Ca(e,t,r){Ir.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r,void 0===t&&(t=1);var n=new Yr;n.addAttribute("position",new Gr([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var i=new Ln({fog:!1});this.lightPlane=new Un(n,i),this.add(this.lightPlane),(n=new Yr).addAttribute("position",new Gr([0,0,0,0,0,1],3)),this.targetLine=new Un(n,i),this.add(this.targetLine),this.update()}function Ma(e){var t=new Yr,r=new Ln({color:16777215,vertexColors:b}),n=[],i=[],o={},a=new ur(16755200),s=new ur(16711680),l=new ur(43775),u=new ur(16777215),c=new ur(3355443);function h(e,t,r){p(e,r),p(t,r)}function p(e,t){n.push(0,0,0),i.push(t.r,t.g,t.b),void 0===o[e]&&(o[e]=[]),o[e].push(n.length/3-1)}h("n1","n2",a),h("n2","n4",a),h("n4","n3",a),h("n3","n1",a),h("f1","f2",a),h("f2","f4",a),h("f4","f3",a),h("f3","f1",a),h("n1","f1",a),h("n2","f2",a),h("n3","f3",a),h("n4","f4",a),h("p","n1",s),h("p","n2",s),h("p","n3",s),h("p","n4",s),h("u1","u2",l),h("u2","u3",l),h("u3","u1",l),h("c","t",u),h("p","c",c),h("cn1","cn2",c),h("cn3","cn4",c),h("cf1","cf2",c),h("cf3","cf4",c),t.addAttribute("position",new Gr(n,3)),t.addAttribute("color",new Gr(i,3)),Vn.call(this,t,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}function Ta(e,t){this.object=e,void 0===t&&(t=16776960);var r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),i=new Yr;i.setIndex(new Lr(r,1)),i.addAttribute("position",new Lr(n,3)),Vn.call(this,i,new Ln({color:t})),this.matrixAutoUpdate=!1,this.update()}function Aa(e,t){this.type="Box3Helper",this.box=e;var r=void 0!==t?t:16776960,n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Yr;i.setIndex(new Lr(n,1)),i.addAttribute("position",new Gr([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),Vn.call(this,i,new Ln({color:r})),this.geometry.computeBoundingSphere()}function Ea(e,t,r){this.type="PlaneHelper",this.plane=e,this.size=void 0===t?1:t;var n=void 0!==r?r:16776960,i=new Yr;i.addAttribute("position",new Gr([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),i.computeBoundingSphere(),Un.call(this,i,new Ln({color:n}));var o=new Yr;o.addAttribute("position",new Gr([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),o.computeBoundingSphere(),this.add(new sn(o,new tn({color:n,opacity:.2,transparent:!0,depthWrite:!1})))}function Pa(e,t,r,n,i,o){Ir.call(this),void 0===n&&(n=16776960),void 0===r&&(r=1),void 0===i&&(i=.2*r),void 0===o&&(o=.2*i),void 0===qo&&((qo=new Yr).addAttribute("position",new Gr([0,0,0,0,1,0],3)),(Xo=new Ai(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(t),this.line=new Un(qo,new Ln({color:n})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new sn(Xo,new tn({color:n})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,i,o)}function Ra(e){var t=[0,0,0,e=e||1,0,0,0,0,0,0,e,0,0,0,0,0,0,e],r=new Yr;r.addAttribute("position",new Gr(t,3)),r.addAttribute("color",new Gr([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));var n=new Ln({vertexColors:w});Vn.call(this,r,n)}function Ia(){var e=0,t=0,r=0,n=0;function i(i,o,a,s){e=i,t=a,r=-3*i+3*o-2*a-s,n=2*i-2*o+a+s}return{initCatmullRom:function(e,t,r,n,o){i(t,r,o*(r-e),o*(n-t))},initNonuniformCatmullRom:function(e,t,r,n,o,a,s){var l=(t-e)/o-(r-e)/(o+a)+(r-t)/a,u=(r-t)/a-(n-t)/(a+s)+(n-r)/s;i(t,r,l*=a,u*=a)},calc:function(i){var o=i*i;return e+t*i+r*o+n*(o*i)}}}Object.assign(Yo.prototype,{load:function(e,t,r,n){var i=new qi(this.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){Ko.getContext().decodeAudioData(e,function(e){t(e)})},r,n)}}),Object.assign(function(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Cn,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Cn,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}.prototype,{update:function(){var e,t,r,n,i,o,a,s,l=new pt,u=new pt;return function(c){if(e!==this||t!==c.focus||r!==c.fov||n!==c.aspect*this.aspect||i!==c.near||o!==c.far||a!==c.zoom||s!==this.eyeSep){e=this,t=c.focus,r=c.fov,n=c.aspect*this.aspect,i=c.near,o=c.far,a=c.zoom;var h,p,d=c.projectionMatrix.clone(),f=(s=this.eyeSep/2)*i/t,m=i*Math.tan(ct.DEG2RAD*r*.5)/a;u.elements[12]=-s,l.elements[12]=s,h=-m*n+f,p=m*n+f,d.elements[0]=2*i/(p-h),d.elements[8]=(p+h)/(p-h),this.cameraL.projectionMatrix.copy(d),h=-m*n-f,p=m*n-f,d.elements[0]=2*i/(p-h),d.elements[8]=(p+h)/(p-h),this.cameraR.projectionMatrix.copy(d)}this.cameraL.matrixWorld.copy(c.matrixWorld).multiply(u),this.cameraR.matrixWorld.copy(c.matrixWorld).multiply(l)}}()}),Zo.prototype=Object.create(Ir.prototype),Zo.prototype.constructor=Zo,Jo.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Jo,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new ft,t=new dt,r=new ft,n=new ft;return function(i){Ir.prototype.updateMatrixWorld.call(this,i);var o=this.context.listener,a=this.up;this.matrixWorld.decompose(e,t,r),n.set(0,0,-1).applyQuaternion(t),o.positionX?(o.positionX.setValueAtTime(e.x,this.context.currentTime),o.positionY.setValueAtTime(e.y,this.context.currentTime),o.positionZ.setValueAtTime(e.z,this.context.currentTime),o.forwardX.setValueAtTime(n.x,this.context.currentTime),o.forwardY.setValueAtTime(n.y,this.context.currentTime),o.forwardZ.setValueAtTime(n.z,this.context.currentTime),o.upX.setValueAtTime(a.x,this.context.currentTime),o.upY.setValueAtTime(a.y,this.context.currentTime),o.upZ.setValueAtTime(a.z,this.context.currentTime)):(o.setPosition(e.x,e.y,e.z),o.setOrientation(n.x,n.y,n.z,a.x,a.y,a.z))}}()}),Qo.prototype=Object.assign(Object.create(Ir.prototype),{constructor:Qo,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying){if(!1!==this.hasPlaybackControl){var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),this.startTime=this.context.currentTime,e.start(this.startTime,this.offset),this.isPlaying=!0,this.source=e,this.connect()}console.warn("THREE.Audio: this Audio has no playback control.")}else console.warn("THREE.Audio: Audio is already playing.")},pause:function(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this.source.stop(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.offset=0,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this;console.warn("THREE.Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),ea.prototype=Object.assign(Object.create(Qo.prototype),{constructor:ea,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new ft;return function(t){Ir.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(ta.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),r=0;r<t.length;r++)e+=t[r];return e/t.length}}),Object.assign(ra.prototype,{accumulate:function(e,t){var r=this.buffer,n=this.valueSize,i=e*n+n,o=this.cumulativeWeight;if(0===o){for(var a=0;a!==n;++a)r[i+a]=r[a];o=t}else{var s=t/(o+=t);this._mixBufferRegion(r,i,0,s,n)}this.cumulativeWeight=o},apply:function(e){var t=this.valueSize,r=this.buffer,n=e*t+t,i=this.cumulativeWeight,o=this.binding;if(this.cumulativeWeight=0,i<1){var a=3*t;this._mixBufferRegion(r,n,a,1-i,t)}for(var s=t,l=t+t;s!==l;++s)if(r[s]!==r[s+t]){o.setValue(r,n);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,r=this.valueSize,n=3*r;e.getValue(t,n);for(var i=r,o=n;i!==o;++i)t[i]=t[n+i%r];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,r,n,i){if(n>=.5)for(var o=0;o!==i;++o)e[t+o]=e[r+o]},_slerp:function(e,t,r,n){dt.slerpFlat(e,t,e,t,e,r,n)},_lerp:function(e,t,r,n,i){for(var o=1-n,a=0;a!==i;++a){var s=t+a;e[s]=e[s]*o+e[r+a]*n}}}),Object.assign(na.prototype,{getValue:function(e,t){this.bind();var r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(e,t)},setValue:function(e,t){for(var r=this._bindings,n=this._targetGroup.nCachedObjects_,i=r.length;n!==i;++n)r[n].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].unbind()}}),Object.assign(ia,{Composite:na,create:function(e,t,r){return e&&e.isAnimationObjectGroup?new ia.Composite(e,t,r):new ia(e,t,r)},sanitizeNodeName:function(e){return e.replace(/\s/g,"_").replace(/[^\w-]/g,"")},parseTrackName:function(){var e=new RegExp("^"+/((?:[\w-]+[\/:])*)/.source+/([\w-\.]+)?/.source+/(?:\.([\w-]+)(?:\[(.+)\])?)?/.source+/\.([\w-]+)(?:\[(.+)\])?/.source+"$"),t=["material","materials","bones"];return function(r){var n=e.exec(r);if(!n)throw new Error("PropertyBinding: Cannot parse trackName: "+r);var i={nodeName:n[2],objectName:n[3],objectIndex:n[4],propertyName:n[5],propertyIndex:n[6]},o=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==o&&-1!==o){var a=i.nodeName.substring(o+1);-1!==t.indexOf(a)&&(i.nodeName=i.nodeName.substring(0,o),i.objectName=a)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+r);return i}}(),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var r=function(e){for(var r=0;r<e.bones.length;r++){var n=e.bones[r];if(n.name===t)return n}return null}(e.skeleton);if(r)return r}if(e.children){var n=function(e){for(var r=0;r<e.length;r++){var i=e[r];if(i.name===t||i.uuid===t)return i;var o=n(i.children);if(o)return o}return null},i=n(e.children);if(i)return i}return null}}),Object.assign(ia.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)e[t++]=r[n]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.targetObject[this.propertyName]=e[t]},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=e[t++]},function(e,t){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var r=this.resolvedProperty,n=0,i=r.length;n!==i;++n)r[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,r=t.objectName,n=t.propertyName,i=t.propertyIndex;if(e||(e=ia.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,e){if(r){var o=t.objectIndex;switch(r){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(var a=0;a<e.length;a++)if(e[a].name===o){o=a;break}break;default:if(void 0===e[r])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==o){if(void 0===e[o])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[o]}}var s=e[n];if(void 0!==s){var l=this.Versioning.None;void 0!==e.needsUpdate?(l=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(l=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var u=this.BindingType.Direct;if(void 0!==i){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(a=0;a<this.node.geometry.morphAttributes.position.length;a++)if(e.geometry.morphAttributes.position[a].name===i){i=a;break}}else{if(!e.geometry.morphTargets)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(a=0;a<this.node.geometry.morphTargets.length;a++)if(e.geometry.morphTargets[a].name===i){i=a;break}}}u=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=i}else void 0!==s.fromArray&&void 0!==s.toArray?(u=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(u=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[u],this.setValue=this.SetterByBindingTypeAndVersioning[u][l]}else{var c=t.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+c+"."+n+" but it wasn't found.",e)}}else console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),
//!\ DECLARE ALIAS AFTER assign prototype !
Object.assign(ia.prototype,{_getValue_unbound:ia.prototype.getValue,_setValue_unbound:ia.prototype.setValue}),Object.assign(function(){var e=arguments;this.uuid=ct.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var r=0,n=arguments.length;r!==n;++r)t[e[r].uuid]=r;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var i=this;this.stats={objects:{get total(){return i._objects.length},get inUse(){return this.total-i.nCachedObjects_}},get bindingsPerObject(){return i._bindings.length}}}.prototype,{isAnimationObjectGroup:!0,add:function(){for(var e=arguments,t=this._objects,r=t.length,n=this.nCachedObjects_,i=this._indicesByUUID,o=this._paths,a=this._parsedPaths,s=this._bindings,l=s.length,u=0,c=arguments.length;u!==c;++u){var h=e[u],p=h.uuid,d=i[p],f=void 0;if(void 0===d){d=r++,i[p]=d,t.push(h);for(var m=0,g=l;m!==g;++m)s[m].push(new ia(h,o[m],a[m]))}else if(d<n){f=t[d];var v=--n,y=t[v];i[y.uuid]=d,t[d]=y,i[p]=v,t[v]=h;for(m=0,g=l;m!==g;++m){var b=s[m],w=b[v],x=b[d];b[d]=w,void 0===x&&(x=new ia(h,o[m],a[m])),b[v]=x}}else t[d]!==f&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=n},remove:function(){for(var e=arguments,t=this._objects,r=this.nCachedObjects_,n=this._indicesByUUID,i=this._bindings,o=i.length,a=0,s=arguments.length;a!==s;++a){var l=e[a],u=l.uuid,c=n[u];if(void 0!==c&&c>=r){var h=r++,p=t[h];n[p.uuid]=c,t[c]=p,n[u]=h,t[h]=l;for(var d=0,f=o;d!==f;++d){var m=i[d],g=m[h],v=m[c];m[c]=g,m[h]=v}}}this.nCachedObjects_=r},uncache:function(){for(var e=arguments,t=this._objects,r=t.length,n=this.nCachedObjects_,i=this._indicesByUUID,o=this._bindings,a=o.length,s=0,l=arguments.length;s!==l;++s){var u=e[s].uuid,c=i[u];if(void 0!==c)if(delete i[u],c<n){var h=--n,p=t[h],d=t[y=--r];i[p.uuid]=c,t[c]=p,i[d.uuid]=h,t[h]=d,t.pop();for(var f=0,m=a;f!==m;++f){var g=(b=o[f])[h],v=b[y];b[c]=g,b[h]=v,b.pop()}}else{var y;i[(d=t[y=--r]).uuid]=c,t[c]=d,t.pop();for(f=0,m=a;f!==m;++f){var b;(b=o[f])[c]=b[y],b.pop()}}}this.nCachedObjects_=n},subscribe_:function(e,t){var r=this._bindingsIndicesByPath,n=r[e],i=this._bindings;if(void 0!==n)return i[n];var o=this._paths,a=this._parsedPaths,s=this._objects,l=s.length,u=this.nCachedObjects_,c=new Array(l);n=i.length,r[e]=n,o.push(e),a.push(t),i.push(c);for(var h=u,p=s.length;h!==p;++h){var d=s[h];c[h]=new ia(d,e,t)}return c},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,r=t[e];if(void 0!==r){var n=this._paths,i=this._parsedPaths,o=this._bindings,a=o.length-1,s=o[a];t[e[a]]=r,o[r]=s,o.pop(),i[r]=i[a],i.pop(),n[r]=n[a],n.pop()}}}),Object.assign(oa.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,r){if(e.fadeOut(t),this.fadeIn(t),r){var n=this._clip.duration,i=e._clip.duration,o=i/n,a=n/i;e.warp(1,o,t),this.warp(a,1,t)}return this},crossFadeTo:function(e,t,r){return e.crossFadeFrom(this,t,r)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,r){var n=this._mixer,i=n.time,o=this._timeScaleInterpolant,a=this.timeScale;null===o&&(o=n._lendControlInterpolant(),this._timeScaleInterpolant=o);var s=o.parameterPositions,l=o.sampleValues;return s[0]=i,s[1]=i+r,l[0]=e/a,l[1]=t/a,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,r,n){if(this.enabled){var i=this._startTime;if(null!==i){var o=(e-i)*r;if(o<0||0===r)return;this._startTime=null,t=r*o}t*=this._updateTimeScale(e);var a=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var l=this._interpolants,u=this._propertyBindings,c=0,h=l.length;c!==h;++c)l[c].evaluate(a),u[c].accumulate(n,s)}else this._updateWeight(e)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var r=this._weightInterpolant;if(null!==r){var n=r.evaluate(e)[0];t*=n,e>r.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var r=this._timeScaleInterpolant;if(null!==r)t*=r.evaluate(e)[0],e>r.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var r=this._clip.duration,n=this.loop,i=this._loopCount;if(2200===n){-1===i&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=r)t=r;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var o=2202===n;if(-1===i&&(e>=0?(i=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),t>=r||t<0){var a=Math.floor(t/r);t-=r*a,i+=Math.abs(a);var s=this.repetitions-i;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?r:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var l=e<0;this._setEndings(l,!l,o)}else this._setEndings(!1,!1,o);this._loopCount=i,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:a})}}if(o&&1==(1&i))return this.time=t,r-t}return this.time=t,t},_setEndings:function(e,t,r){var n=this._interpolantSettings;r?(n.endingStart=2401,n.endingEnd=2401):(n.endingStart=e?this.zeroSlopeAtStart?2401:Ze:2402,n.endingEnd=t?this.zeroSlopeAtEnd?2401:Ze:2402)},_scheduleFading:function(e,t,r){var n=this._mixer,i=n.time,o=this._weightInterpolant;null===o&&(o=n._lendControlInterpolant(),this._weightInterpolant=o);var a=o.parameterPositions,s=o.sampleValues;return a[0]=i,s[0]=t,a[1]=i+e,s[1]=r,this}}),Object.assign(function(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}.prototype,s.prototype,{_bindAction:function(e,t){var r=e._localRoot||this._root,n=e._clip.tracks,i=n.length,o=e._propertyBindings,a=e._interpolants,s=r.uuid,l=this._bindingsByRootAndName,u=l[s];void 0===u&&(u={},l[s]=u);for(var c=0;c!==i;++c){var h=n[c],p=h.name,d=u[p];if(void 0!==d)o[c]=d;else{if(void 0!==(d=o[c])){null===d._cacheIndex&&(++d.referenceCount,this._addInactiveBinding(d,s,p));continue}var f=t&&t._propertyBindings[c].binding.parsedPath;++(d=new ra(ia.create(r,p,f),h.ValueTypeName,h.getValueSize())).referenceCount,this._addInactiveBinding(d,s,p),o[c]=d}a[c].resultBuffer=d.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,r=e._clip.uuid,n=this._actionsByClip[r];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,r,t)}for(var i=e._propertyBindings,o=0,a=i.length;o!==a;++o){var s=i[o];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,r=0,n=t.length;r!==n;++r){var i=t[r];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,r){var n=this._actions,i=this._actionsByClip,o=i[t];if(void 0===o)o={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,i[t]=o;else{var a=o.knownActions;e._byClipCacheIndex=a.length,a.push(e)}e._cacheIndex=n.length,n.push(e),o.actionByRoot[r]=e},_removeInactiveAction:function(e){var t=this._actions,r=t[t.length-1],n=e._cacheIndex;r._cacheIndex=n,t[n]=r,t.pop(),e._cacheIndex=null;var i=e._clip.uuid,o=this._actionsByClip,a=o[i],s=a.knownActions,l=s[s.length-1],u=e._byClipCacheIndex;l._byClipCacheIndex=u,s[u]=l,s.pop(),e._byClipCacheIndex=null,delete a.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete o[i],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,r=0,n=t.length;r!==n;++r){var i=t[r];0==--i.referenceCount&&this._removeInactiveBinding(i)}},_lendAction:function(e){var t=this._actions,r=e._cacheIndex,n=this._nActiveActions++,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i},_takeBackAction:function(e){var t=this._actions,r=e._cacheIndex,n=--this._nActiveActions,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i},_addInactiveBinding:function(e,t,r){var n=this._bindingsByRootAndName,i=n[t],o=this._bindings;void 0===i&&(i={},n[t]=i),i[r]=e,e._cacheIndex=o.length,o.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,r=e.binding,n=r.rootNode.uuid,i=r.path,o=this._bindingsByRootAndName,a=o[n],s=t[t.length-1],l=e._cacheIndex;s._cacheIndex=l,t[l]=s,t.pop(),delete a[i];e:{for(var u in a)break e;delete o[n]}},_lendBinding:function(e){var t=this._bindings,r=e._cacheIndex,n=this._nActiveBindings++,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i},_takeBackBinding:function(e){var t=this._bindings,r=e._cacheIndex,n=--this._nActiveBindings,i=t[n];e._cacheIndex=n,t[n]=e,i._cacheIndex=r,t[r]=i},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,r=e[t];return void 0===r&&((r=new co(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t,e[t]=r),r},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,r=e.__cacheIndex,n=--this._nActiveControlInterpolants,i=t[n];e.__cacheIndex=n,t[n]=e,i.__cacheIndex=r,t[r]=i},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var r=t||this._root,n=r.uuid,i="string"==typeof e?_o.findByName(r,e):e,o=null!==i?i.uuid:e,a=this._actionsByClip[o],s=null;if(void 0!==a){var l=a.actionByRoot[n];if(void 0!==l)return l;s=a.knownActions[0],null===i&&(i=s._clip)}if(null===i)return null;var u=new oa(this,i,t);return this._bindAction(u,s),this._addInactiveAction(u,o,n),u},existingAction:function(e,t){var r=t||this._root,n=r.uuid,i="string"==typeof e?_o.findByName(r,e):e,o=i?i.uuid:e,a=this._actionsByClip[o];return void 0!==a&&a.actionByRoot[n]||null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,r=this._bindings,n=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var i=0;i!==t;++i)e[i].reset();for(i=0;i!==n;++i)r[i].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,r=this._nActiveActions,n=this.time+=e,i=Math.sign(e),o=this._accuIndex^=1,a=0;a!==r;++a){t[a]._update(n,e,i,o)}var s=this._bindings,l=this._nActiveBindings;for(a=0;a!==l;++a)s[a].apply(o);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,r=e.uuid,n=this._actionsByClip,i=n[r];if(void 0!==i){for(var o=i.knownActions,a=0,s=o.length;a!==s;++a){var l=o[a];this._deactivateAction(l);var u=l._cacheIndex,c=t[t.length-1];l._cacheIndex=null,l._byClipCacheIndex=null,c._cacheIndex=u,t[u]=c,t.pop(),this._removeInactiveBindingsForAction(l)}delete n[r]}},uncacheRoot:function(e){var t=e.uuid,r=this._actionsByClip;for(var n in r){var i=r[n].actionByRoot[t];void 0!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}var o=this._bindingsByRootAndName[t];if(void 0!==o)for(var a in o){var s=o[a];s.restoreOriginalState(),this._removeInactiveBinding(s)}},uncacheAction:function(e,t){var r=this.existingAction(e,t);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}),aa.prototype.clone=function(){return new aa(void 0===this.value.clone?this.value:this.value.clone())},sa.prototype=Object.assign(Object.create(Yr.prototype),{constructor:sa,isInstancedBufferGeometry:!0,copy:function(e){return Yr.prototype.copy.call(this,e),this.maxInstancedCount=e.maxInstancedCount,this},clone:function(){return(new this.constructor).copy(this)}}),Object.defineProperties(la.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(la.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=i,this}}),Object.defineProperty(ua.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(ua.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(var n=0,i=this.stride;n<i;n++)this.array[e+n]=t.array[r+n];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),ca.prototype=Object.assign(Object.create(ua.prototype),{constructor:ca,isInstancedInterleavedBuffer:!0,copy:function(e){return ua.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),ha.prototype=Object.assign(Object.create(Lr.prototype),{constructor:ha,isInstancedBufferAttribute:!0,copy:function(e){return Lr.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign(function(e,t,r,n){this.ray=new nn(e,t),this.near=r||0,this.far=n||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var r=[];return da(e,this,r,t),r.sort(pa),r},intersectObjects:function(e,t){var r=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),r;for(var n=0,i=e.length;n<i;n++)da(e[n],this,r,t);return r.sort(pa),r}}),Object.assign(function(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(function(e,t,r){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0,this}.prototype,{set:function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(ct.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(function(e,t,r){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==r?r:0,this}.prototype,{set:function(e,t,r){return this.radius=e,this.theta=t,this.y=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),fa.prototype=Object.create(Ir.prototype),fa.prototype.constructor=fa,fa.prototype.isImmediateRenderObject=!0,ma.prototype=Object.create(Vn.prototype),ma.prototype.constructor=ma,ma.prototype.update=function(){var e=new ft,t=new ft,r=new mt;return function(){var n=["a","b","c"];this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);var i=this.object.matrixWorld,o=this.geometry.attributes.position,a=this.object.geometry;if(a&&a.isGeometry)for(var s=a.vertices,l=a.faces,u=0,c=0,h=l.length;c<h;c++)for(var p=l[c],d=0,f=p.vertexNormals.length;d<f;d++){var m=s[p[n[d]]],g=p.vertexNormals[d];e.copy(m).applyMatrix4(i),t.copy(g).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),o.setXYZ(u,e.x,e.y,e.z),u+=1,o.setXYZ(u,t.x,t.y,t.z),u+=1}else if(a&&a.isBufferGeometry){var v=a.attributes.position,y=a.attributes.normal;for(u=0,d=0,f=v.count;d<f;d++)e.set(v.getX(d),v.getY(d),v.getZ(d)).applyMatrix4(i),t.set(y.getX(d),y.getY(d),y.getZ(d)),t.applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),o.setXYZ(u,e.x,e.y,e.z),u+=1,o.setXYZ(u,t.x,t.y,t.z),u+=1}o.needsUpdate=!0}}(),ga.prototype=Object.create(Ir.prototype),ga.prototype.constructor=ga,ga.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},ga.prototype.update=function(){var e=new ft,t=new ft;return function(){this.light.updateMatrixWorld();var r=this.light.distance?this.light.distance:1e3,n=r*Math.tan(this.light.angle);this.cone.scale.set(n,n,r),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}(),va.prototype=Object.create(Vn.prototype),va.prototype.constructor=va,va.prototype.updateMatrixWorld=function(){var e=new ft,t=new pt,r=new pt;return function(n){var i=this.bones,o=this.geometry,a=o.getAttribute("position");r.getInverse(this.root.matrixWorld);for(var s=0,l=0;s<i.length;s++){var u=i[s];u.parent&&u.parent.isBone&&(t.multiplyMatrices(r,u.matrixWorld),e.setFromMatrixPosition(t),a.setXYZ(l,e.x,e.y,e.z),t.multiplyMatrices(r,u.parent.matrixWorld),e.setFromMatrixPosition(t),a.setXYZ(l+1,e.x,e.y,e.z),l+=2)}o.getAttribute("position").needsUpdate=!0,Ir.prototype.updateMatrixWorld.call(this,n)}}(),ya.prototype=Object.create(sn.prototype),ya.prototype.constructor=ya,ya.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},ya.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},ba.prototype=Object.create(Ir.prototype),ba.prototype.constructor=ba,ba.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},ba.prototype.update=function(){var e=.5*this.light.width,t=.5*this.light.height,r=this.line.geometry.attributes.position,n=r.array;n[0]=e,n[1]=-t,n[2]=0,n[3]=e,n[4]=t,n[5]=0,n[6]=-e,n[7]=t,n[8]=0,n[9]=-e,n[10]=-t,n[11]=0,n[12]=e,n[13]=-t,n[14]=0,r.needsUpdate=!0,void 0!==this.color?this.line.material.color.set(this.color):this.line.material.color.copy(this.light.color)},wa.prototype=Object.create(Ir.prototype),wa.prototype.constructor=wa,wa.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},wa.prototype.update=function(){var e=new ft,t=new ur,r=new ur;return function(){var n=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var i=n.geometry.getAttribute("color");t.copy(this.light.color),r.copy(this.light.groundColor);for(var o=0,a=i.count;o<a;o++){var s=o<a/2?t:r;i.setXYZ(o,s.r,s.g,s.b)}i.needsUpdate=!0}n.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate())}}(),xa.prototype=Object.create(Vn.prototype),xa.prototype.constructor=xa,_a.prototype=Object.create(Vn.prototype),_a.prototype.constructor=_a,Sa.prototype=Object.create(Vn.prototype),Sa.prototype.constructor=Sa,Sa.prototype.update=function(){var e=new ft,t=new ft,r=new mt;return function(){this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);for(var n=this.object.matrixWorld,i=this.geometry.attributes.position,o=this.object.geometry,a=o.vertices,s=o.faces,l=0,u=0,c=s.length;u<c;u++){var h=s[u],p=h.normal;e.copy(a[h.a]).add(a[h.b]).add(a[h.c]).divideScalar(3).applyMatrix4(n),t.copy(p).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),i.setXYZ(l,e.x,e.y,e.z),l+=1,i.setXYZ(l,t.x,t.y,t.z),l+=1}i.needsUpdate=!0}}(),Ca.prototype=Object.create(Ir.prototype),Ca.prototype.constructor=Ca,Ca.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},Ca.prototype.update=function(){var e=new ft,t=new ft,r=new ft;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),r.subVectors(t,e),this.lightPlane.lookAt(r),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(r),this.targetLine.scale.z=r.length()}}(),Ma.prototype=Object.create(Vn.prototype),Ma.prototype.constructor=Ma,Ma.prototype.update=function(){var e,t,r=new ft,n=new Nr;function i(i,o,a,s){r.set(o,a,s).unproject(n);var l=t[i];if(void 0!==l)for(var u=e.getAttribute("position"),c=0,h=l.length;c<h;c++)u.setXYZ(l[c],r.x,r.y,r.z)}return function(){e=this.geometry,t=this.pointMap;n.projectionMatrix.copy(this.camera.projectionMatrix),i("c",0,0,-1),i("t",0,0,1),i("n1",-1,-1,-1),i("n2",1,-1,-1),i("n3",-1,1,-1),i("n4",1,1,-1),i("f1",-1,-1,1),i("f2",1,-1,1),i("f3",-1,1,1),i("f4",1,1,1),i("u1",.7,1.1,-1),i("u2",-.7,1.1,-1),i("u3",0,2,-1),i("cf1",-1,0,1),i("cf2",1,0,1),i("cf3",0,-1,1),i("cf4",0,1,1),i("cn1",-1,0,-1),i("cn2",1,0,-1),i("cn3",0,-1,-1),i("cn4",0,1,-1),e.getAttribute("position").needsUpdate=!0}}(),Ta.prototype=Object.create(Vn.prototype),Ta.prototype.constructor=Ta,Ta.prototype.update=function(){var e=new _r;return function(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&e.setFromObject(this.object),!e.isEmpty()){var r=e.min,n=e.max,i=this.geometry.attributes.position,o=i.array;o[0]=n.x,o[1]=n.y,o[2]=n.z,o[3]=r.x,o[4]=n.y,o[5]=n.z,o[6]=r.x,o[7]=r.y,o[8]=n.z,o[9]=n.x,o[10]=r.y,o[11]=n.z,o[12]=n.x,o[13]=n.y,o[14]=r.z,o[15]=r.x,o[16]=n.y,o[17]=r.z,o[18]=r.x,o[19]=r.y,o[20]=r.z,o[21]=n.x,o[22]=r.y,o[23]=r.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),Ta.prototype.setFromObject=function(e){return this.object=e,this.update(),this},Aa.prototype=Object.create(Vn.prototype),Aa.prototype.constructor=Aa,Aa.prototype.updateMatrixWorld=function(e){var t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),Ir.prototype.updateMatrixWorld.call(this,e))},Ea.prototype=Object.create(Un.prototype),Ea.prototype.constructor=Ea,Ea.prototype.updateMatrixWorld=function(e){var t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.lookAt(this.plane.normal),Ir.prototype.updateMatrixWorld.call(this,e)},Pa.prototype=Object.create(Ir.prototype),Pa.prototype.constructor=Pa,Pa.prototype.setDirection=function(){var e,t=new ft;return function(r){r.y>.99999?this.quaternion.set(0,0,0,1):r.y<-.99999?this.quaternion.set(1,0,0,0):(t.set(r.z,0,-r.x).normalize(),e=Math.acos(r.y),this.quaternion.setFromAxisAngle(t,e))}}(),Pa.prototype.setLength=function(e,t,r){void 0===t&&(t=.2*e),void 0===r&&(r=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()},Pa.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},Ra.prototype=Object.create(Vn.prototype),Ra.prototype.constructor=Ra;var Na=new ft,Da=new Ia,ka=new Ia,Oa=new Ia;function Fa(e,t,r,n){ko.call(this),this.type="CatmullRomCurve3",this.points=e||[],this.closed=t||!1,this.curveType=r||"centripetal",this.tension=n||.5}function La(e,t,r,n){ko.call(this),this.type="CubicBezierCurve3",this.v0=e||new ft,this.v1=t||new ft,this.v2=r||new ft,this.v3=n||new ft}function Ua(e,t,r){ko.call(this),this.type="QuadraticBezierCurve3",this.v0=e||new ft,this.v1=t||new ft,this.v2=r||new ft}function Va(e,t){ko.call(this),this.type="LineCurve3",this.v1=e||new ft,this.v2=t||new ft}function Ba(e,t,r,n,i,o){Lo.call(this,e,t,r,r,n,i,o),this.type="ArcCurve"}function za(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Fa.call(this,e),this.type="catmullrom"}function ja(e){if("undefined"!=typeof window){var t=new RegExp(e+"=([^&#=]*)").exec(window.location.search);return t?decodeURIComponent(t[1]):void 0}}function Ha(e,t){return void 0!==e?e:t}function $a(e,t){var r=Object.assign({},e);for(var n in t){void 0===e[n]&&(r[n]=t[n])}return r}function Ga(e,t){for(var r in t){var n=t[r];void 0!==n&&(e[r]=n)}return e}function Wa(e,t){t=Ha(t,[]);for(var r=0;r<e.length;r++)Array.isArray(e[r])?Wa(e[r],t):t.push(e[r]);return t}function qa(){var e=window.location.protocol;return null===e.match(/http(s)?:/gi)?"http:":e}function Xa(){if("undefined"==typeof window)return!1;var e=window.navigator.userAgent;return/Opera|OPR/.test(e)?"Opera":/Chrome/i.test(e)?"Chrome":/Firefox/i.test(e)?"Firefox":/Mobile(\/.*)? Safari/i.test(e)?"Mobile Safari":/MSIE/i.test(e)?"Internet Explorer":!!/Safari/i.test(e)&&"Safari"}function Ka(e){window.open(e,"_blank")||(window.location.href=e)}function Ya(e,t){if(void 0===t&&(t="download"),e){var r="Safari"===Xa(),n=/CriOS\/[\d]+/.test(window.navigator.userAgent),i=document.createElement("a");if("undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(e,t);else if((r||n)&&FileReader)if(e instanceof Blob){var o=new FileReader;o.onloadend=function(){s(o.result)},o.readAsDataURL(e)}else s(e);else{var a=!1;e instanceof Blob&&(e=URL.createObjectURL(e),a=!0),"download"in i?(i.style.display="hidden",document.body.appendChild(i),i.href=e,i.download=t,i.target="_blank",i.click(),document.body.removeChild(i)):Ka(e),a&&window.URL.revokeObjectURL(e)}}function s(e){Ka(n?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"))}}function Za(e,t,r){var n,i,o,a=null,s=0;function l(){s=!1===r.leading?0:Date.now(),a=null,o=e.apply(n,i),a||(n=i=null)}return r||(r={}),function(){var u=Date.now();s||!1!==r.leading||(s=u);var c=t-(u-s);return n=this,i=arguments,c<=0||c>t?(a&&(clearTimeout(a),a=null),s=u,o=e.apply(n,i),a||(n=i=null)):a||!1===r.trailing||(a=setTimeout(l,c)),o}}function Ja(e,t){return e<t?-1:e>t?1:0}function Qa(e,t,r){void 0===r&&(r=Ja);for(var n=0,i=e.length-1;n<=i;){var o=n+i>>1,a=r(t,e[o]);if(a>0)n=o+1;else{if(!(a<0))return o;i=o-1}}return-n-1}function es(e,t,r){var n=function(e,t){var r=e.length-1;if(e[r]<t)return-1;for(var n=0;n<=r;){var i=n+r>>1;e[i]>=t?r=i-1:n=i+1}return r+1}(e,t),i=function(e,t){if(e[0]>t)return-1;for(var r=0,n=e.length-1;r<=n;){var i=r+n>>1;e[i]>t?n=i-1:r=i+1}return r-1}(e,r);return-1===n||-1===i||n>i?0:i-n+1}function ts(e){return e.sort().filter(function(e,t,r){return 0===t||e!==r[t-1]})}function rs(e){if(e.length>28672){for(var t=[],r=0;r<e.length;r+=28672)t.push(String.fromCharCode.apply(null,e.subarray(r,r+28672)));return t.join("")}return String.fromCharCode.apply(null,e)}function ns(e,t){switch(e){case"int8":return new Int8Array(t);case"int16":return new Int16Array(t);case"int32":return new Int32Array(t);case"uint8":return new Uint8Array(t);case"uint16":return new Uint16Array(t);case"uint32":return new Uint32Array(t);case"float32":return new Float32Array(t);default:throw new Error("arrayType unknown: "+e)}}function is(e,t){return new(t>65535?Uint32Array:Uint16Array)(e)}function os(e){return e.buffer&&e.buffer instanceof ArrayBuffer?e.buffer:e}function as(e,t){return void 0===e?e=new t:Array.isArray(e)&&(e=(new t).fromArray(e)),e}function ss(e){return as(e,ft)}function ls(e){return as(e,pt)}function us(e){return as(e,dt)}function cs(e){return function(e,t){return e instanceof t?e:new t(e)}(e,Float32Array)}function hs(e){return Ha(e,"").toString().toLowerCase()}Fa.prototype=Object.create(ko.prototype),Fa.prototype.constructor=Fa,Fa.prototype.isCatmullRomCurve3=!0,Fa.prototype.getPoint=function(e,t){var r,n,i,o,a=t||new ft,s=this.points,l=s.length,u=(l-(this.closed?0:1))*e,c=Math.floor(u),h=u-c;if(this.closed?c+=c>0?0:(Math.floor(Math.abs(c)/s.length)+1)*s.length:0===h&&c===l-1&&(c=l-2,h=1),this.closed||c>0?r=s[(c-1)%l]:(Na.subVectors(s[0],s[1]).add(s[0]),r=Na),n=s[c%l],i=s[(c+1)%l],this.closed||c+2<l?o=s[(c+2)%l]:(Na.subVectors(s[l-1],s[l-2]).add(s[l-1]),o=Na),"centripetal"===this.curveType||"chordal"===this.curveType){var p="chordal"===this.curveType?.5:.25,d=Math.pow(r.distanceToSquared(n),p),f=Math.pow(n.distanceToSquared(i),p),m=Math.pow(i.distanceToSquared(o),p);f<1e-4&&(f=1),d<1e-4&&(d=f),m<1e-4&&(m=f),Da.initNonuniformCatmullRom(r.x,n.x,i.x,o.x,d,f,m),ka.initNonuniformCatmullRom(r.y,n.y,i.y,o.y,d,f,m),Oa.initNonuniformCatmullRom(r.z,n.z,i.z,o.z,d,f,m)}else"catmullrom"===this.curveType&&(Da.initCatmullRom(r.x,n.x,i.x,o.x,this.tension),ka.initCatmullRom(r.y,n.y,i.y,o.y,this.tension),Oa.initCatmullRom(r.z,n.z,i.z,o.z,this.tension));return a.set(Da.calc(h),ka.calc(h),Oa.calc(h)),a},Fa.prototype.copy=function(e){ko.prototype.copy.call(this,e),this.points=[];for(var t=0,r=e.points.length;t<r;t++){var n=e.points[t];this.points.push(n.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this},La.prototype=Object.create(ko.prototype),La.prototype.constructor=La,La.prototype.isCubicBezierCurve3=!0,La.prototype.getPoint=function(e,t){var r=t||new ft,n=this.v0,i=this.v1,o=this.v2,a=this.v3;return r.set(Do(e,n.x,i.x,o.x,a.x),Do(e,n.y,i.y,o.y,a.y),Do(e,n.z,i.z,o.z,a.z)),r},La.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this},Ua.prototype=Object.create(ko.prototype),Ua.prototype.constructor=Ua,Ua.prototype.isQuadraticBezierCurve3=!0,Ua.prototype.getPoint=function(e,t){var r=t||new ft,n=this.v0,i=this.v1,o=this.v2;return r.set(No(e,n.x,i.x,o.x),No(e,n.y,i.y,o.y),No(e,n.z,i.z,o.z)),r},Ua.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this},Va.prototype=Object.create(ko.prototype),Va.prototype.constructor=Va,Va.prototype.isLineCurve3=!0,Va.prototype.getPoint=function(e,t){var r=t||new ft;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},Va.prototype.getPointAt=function(e,t){return this.getPoint(e,t)},Va.prototype.copy=function(e){return ko.prototype.copy.call(this,e),this.v1.copy(e.v1),this.v2.copy(e.v2),this},Ba.prototype=Object.create(Lo.prototype),Ba.prototype.constructor=Ba,Ba.prototype.isArcCurve=!0,ko.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(ko.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Object.assign(Fo.prototype,{createPointsGeometry:function(e){console.warn("THREE.CurvePath: .createPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){console.warn("THREE.CurvePath: .createSpacedPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){console.warn("THREE.CurvePath: .createGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");for(var t=new Fr,r=0,n=e.length;r<n;r++){var i=e[r];t.vertices.push(new ft(i.x,i.y,i.z||0))}return t}}),Object.assign(Ho.prototype,{fromPoints:function(e){console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(e)}}),za.prototype=Object.create(Fa.prototype),Object.assign(za.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),xa.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},va.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(fr.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(_r.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),on.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},Object.assign(ct,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(e){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),ct.floorPowerOfTwo(e)},nextPowerOfTwo:function(e){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),ct.ceilPowerOfTwo(e)}}),Object.assign(mt.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBuffer:function(e){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(pt.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function(){var e;return function(){return void 0===e&&(e=new ft),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,r,n,i,o){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,n,r,i,o)}}),Cr.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},dt.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(nn.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign($o.prototype,{extractAllPoints:function(e){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(e)},extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new di(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new Si(this,e)}}),Object.assign(ht.prototype,{fromAttribute:function(e,t,r){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},distanceToManhattan:function(e){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(ft.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,r){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},distanceToManhattan:function(e){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(e)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(yt.prototype,{fromAttribute:function(e,t,r){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,r)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Fr.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(Ir.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(Ir.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(Dn.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(kn.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(ko.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),Cn.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Yi.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(Lr.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(Yr.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,r){void 0!==r&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(Yr.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(aa.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(br.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new ur}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===e}}}),Object.defineProperties(Li.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(rn.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(Tn.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(Tn.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(Tr.prototype,{cullFace:{get:function(){return this.renderReverseSided?h:c},set:function(e){var t=e!==c;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(bt.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Qo.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this;return(new Yo).load(e,function(e){t.setBuffer(e)}),this},ta.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},Zo.prototype.updateCubeMap=function(e,t){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(e,t)};var ps=function(e){this.name=e,this._dict={}},ds={names:{configurable:!0}};function fs(e){return.01745*e}ps.prototype.add=function(e,t){this._dict[hs(e)]=t},ps.prototype.get=function(e){return this._dict[hs(e)]},ds.names.get=function(){return Object.keys(this._dict)},Object.defineProperties(ps.prototype,ds);var ms="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),gs=new Array(36);function vs(){for(var e,t=0,r=0;r<36;r++)8===r||13===r||18===r||23===r?gs[r]="-":14===r?gs[r]="4":(t<=2&&(t=33554432+16777216*Math.random()|0),e=15&t,t>>=4,gs[r]=ms[19===r?3&e|8:e]);return gs.join("")}function ys(e,t,r){return Math.max(t,Math.min(r,e))}function bs(e){return ys(e,0,100)}function ws(e,t,r){return e+(t-e)*r}function xs(e,t,r,n,i,o){var a=(r-e)*o,s=(n-t)*o,l=i*i;return(2*t-2*r+a+s)*(i*l)+(-3*t+3*r-2*a-s)*l+a*i+t}function _s(e,t,r){return(r=function(e){return ys(e,0,1)}(function(e,t,r){return(e-t)/(r-t)}(r,e,t)))*r*(3-2*r)}var Ss=o(function(e,t){
/**
 * @license
 *
 * chroma.js - JavaScript library for color conversions
 * 
 * Copyright (c) 2011-2017, Gregor Aisch
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 * 
 * 3. The name Gregor Aisch may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL GREGOR AISCH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
(function(){var r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T,A,E,P,R,I,N,D,k,O,F,L,U,V,B,z,j,H,$,G,W,q,X,K,Y,Z,J,Q,ee,te,re,ne,ie,oe,ae,se,le,ue,ce,he,pe,de,fe,ge,ve,ye,be,we,xe,_e,Se,Ce,Me,Te,Ae=[].slice;_e=function(){var e,t,r,n,i;for(e={},n=0,t=(i="Boolean Number String Function Array Date RegExp Undefined Null".split(" ")).length;n<t;n++)r=i[n],e["[object "+r+"]"]=r.toLowerCase();return function(t){var r;return r=Object.prototype.toString.call(t),e[r]||"object"}}(),W=function(e,t,r){return null==t&&(t=0),null==r&&(r=1),e<t&&(e=t),e>r&&(e=r),e},Se=function(e){return e.length>=3?[].slice.call(e):e[0]},x=function(e){var t,r;for(e._clipped=!1,e._unclipped=e.slice(0),t=r=0;r<3;t=++r)t<3?((e[t]<0||e[t]>255)&&(e._clipped=!0),e[t]<0&&(e[t]=0),e[t]>255&&(e[t]=255)):3===t&&(e[t]<0&&(e[t]=0),e[t]>1&&(e[t]=1));return e._clipped||delete e._unclipped,e},o=Math.PI,ve=Math.round,S=Math.cos,E=Math.floor,ee=Math.pow,q=Math.log,be=Math.sin,we=Math.sqrt,f=Math.atan2,Y=Math.max,d=Math.abs,l=2*o,a=o/3,n=o/180,s=180/o,w=function(){return arguments[0]instanceof r?arguments[0]:function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,arguments,function(){})},p=[],null!==e&&null!=e.exports&&(e.exports=w),(null!==t?t:this).chroma=w,w.version="1.3.4",h={},u=[],c=!1,r=function(){function e(){var e,t,r,n,i,o,a,s,l,p=arguments;for(o=this,t=[],s=0,n=arguments.length;s<n;s++)null!=(e=p[s])&&t.push(e);if(a=t[t.length-1],null!=h[a])o._rgb=x(h[a](Se(t.slice(0,-1))));else{for(c||(u=u.sort(function(e,t){return t.p-e.p}),c=!0),l=0,i=u.length;l<i&&!(a=(r=u[l]).test.apply(r,t));l++);a&&(o._rgb=x(h[a].apply(h,t)))}null==o._rgb&&console.warn("unknown format: "+t),null==o._rgb&&(o._rgb=[0,0,0]),3===o._rgb.length&&o._rgb.push(1)}return e.prototype.toString=function(){return this.hex()},e.prototype.clone=function(){return w(me._rgb)},e}(),w._input=h,
/**
  	ColorBrewer colors for chroma.js
  
  	Copyright (c) 2002 Cynthia Brewer, Mark Harrower, and The 
  	Pennsylvania State University.
  
  	Licensed under the Apache License, Version 2.0 (the "License"); 
  	you may not use this file except in compliance with the License.
  	You may obtain a copy of the License at	
  	http://www.apache.org/licenses/LICENSE-2.0
  
  	Unless required by applicable law or agreed to in writing, software distributed
  	under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
  	CONDITIONS OF ANY KIND, either express or implied. See the License for the
  	specific language governing permissions and limitations under the License.
  
      @preserve
   */
w.brewer=y={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Viridis:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},function(){var e,t;for(e in t=[],y)t.push(y[e.toLowerCase()]=y[e])}(),w.colors=Ce={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflower:"#6495ed",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",laserlemon:"#ffff54",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrod:"#fafad2",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",maroon2:"#7f0000",maroon3:"#b03060",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",purple2:"#7f007f",purple3:"#a020f0",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},z=function(){var e,t,r,n,o,a,s;return n=(t=Se(arguments))[0],e=t[1],r=t[2],a=(n+16)/116,o=isNaN(e)?a:a+e/500,s=isNaN(r)?a:a-r/200,a=i.Yn*j(a),o=i.Xn*j(o),s=i.Zn*j(s),[Te(3.2404542*o-1.5371385*a-.4985314*s),Te(-.969266*o+1.8760108*a+.041556*s),r=Te(.0556434*o-.2040259*a+1.0572252*s),t.length>3?t[3]:1]},Te=function(e){return 255*(e<=.00304?12.92*e:1.055*ee(e,1/2.4)-.055)},j=function(e){return e>i.t1?e*e*e:i.t2*(e-i.t0)},i={Kn:18,Xn:.95047,Yn:1,Zn:1.08883,t0:.137931034,t1:.206896552,t2:.12841855,t3:.008856452},le=function(){var e,t,r,n,i,o,a;return r=(n=Se(arguments))[0],t=n[1],e=n[2],o=(i=de(r,t,e))[0],[116*(a=i[1])-16,500*(o-a),200*(a-i[2])]},fe=function(e){return(e/=255)<=.04045?e/12.92:ee((e+.055)/1.055,2.4)},Me=function(e){return e>i.t3?ee(e,1/3):e/i.t2+i.t0},de=function(){var e,t,r,n;return r=(n=Se(arguments))[0],t=n[1],e=n[2],r=fe(r),t=fe(t),e=fe(e),[Me((.4124564*r+.3575761*t+.1804375*e)/i.Xn),Me((.2126729*r+.7151522*t+.072175*e)/i.Yn),Me((.0193339*r+.119192*t+.9503041*e)/i.Zn)]},w.lab=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["lab"]),function(){})},h.lab=z,r.prototype.lab=function(){return le(this._rgb)},m=function(e){var t,r,n,i,o,a,s,l,u,c,h;return 2===(e=function(){var t,r,n;for(n=[],r=0,t=e.length;r<t;r++)i=e[r],n.push(w(i));return n}()).length?(u=function(){var t,r,n;for(n=[],r=0,t=e.length;r<t;r++)i=e[r],n.push(i.lab());return n}(),o=u[0],a=u[1],t=function(e){var t,r;return r=function(){var r,n;for(n=[],t=r=0;r<=2;t=++r)n.push(o[t]+e*(a[t]-o[t]));return n}(),w.lab.apply(w,r)}):3===e.length?(c=function(){var t,r,n;for(n=[],r=0,t=e.length;r<t;r++)i=e[r],n.push(i.lab());return n}(),o=c[0],a=c[1],s=c[2],t=function(e){var t,r;return r=function(){var r,n;for(n=[],t=r=0;r<=2;t=++r)n.push((1-e)*(1-e)*o[t]+2*(1-e)*e*a[t]+e*e*s[t]);return n}(),w.lab.apply(w,r)}):4===e.length?(h=function(){var t,r,n;for(n=[],r=0,t=e.length;r<t;r++)i=e[r],n.push(i.lab());return n}(),o=h[0],a=h[1],s=h[2],l=h[3],t=function(e){var t,r;return r=function(){var r,n;for(n=[],t=r=0;r<=2;t=++r)n.push((1-e)*(1-e)*(1-e)*o[t]+3*(1-e)*(1-e)*e*a[t]+3*(1-e)*e*e*s[t]+e*e*e*l[t]);return n}(),w.lab.apply(w,r)}):5===e.length&&(r=m(e.slice(0,3)),n=m(e.slice(2,5)),t=function(e){return e<.5?r(2*e):n(2*(e-.5))}),t},w.bezier=function(e){var t;return(t=m(e)).scale=function(){return w.scale(t)},t},w.cubehelix=function(e,t,r,n,i){var o,a,s;return null==e&&(e=300),null==t&&(t=-1.5),null==r&&(r=1),null==n&&(n=1),null==i&&(i=[0,1]),o=0,"array"===_e(i)?a=i[1]-i[0]:(a=0,i=[i,i]),(s=function(s){var u,c,h,p,d;return u=l*((e+120)/360+t*s),p=ee(i[0]+a*s,n),c=(0!==o?r[0]+s*o:r)*p*(1-p)/2,h=S(u),d=be(u),w(x([255*(p+c*(-.14861*h+1.78277*d)),255*(p+c*(-.29227*h-.90649*d)),255*(p+c*(1.97294*h))]))}).start=function(t){return null==t?e:(e=t,s)},s.rotations=function(e){return null==e?t:(t=e,s)},s.gamma=function(e){return null==e?n:(n=e,s)},s.hue=function(e){return null==e?r:("array"===_e(r=e)?0===(o=r[1]-r[0])&&(r=r[1]):o=0,s)},s.lightness=function(e){return null==e?i:("array"===_e(e)?(i=e,a=e[1]-e[0]):(i=[e,e],a=0),s)},s.scale=function(){return w.scale(s)},s.hue(r),s},w.random=function(){var e,t;for("0123456789abcdef",e="#",t=0;t<6;++t)e+="0123456789abcdef".charAt(E(16*Math.random()));return new r(e)},w.average=function(e,t){var r,n,i,a,s,l,u,c,h,p,d,m,g;for(c in null==t&&(t="rgb"),h=e.length,a=[],s=0,l=0,m=(u=(e=e.map(function(e){return w(e)})).splice(0,1)[0]).get(t))m[c]=m[c]||0,a.push(isNaN(m[c])?0:1),"h"!==t.charAt(c)||isNaN(m[c])||(r=m[c]/180*o,s+=S(r),l+=be(r));for(n=u.alpha(),d=0,p=e.length;d<p;d++)for(c in g=(i=e[d]).get(t),n+=i.alpha(),m)isNaN(g[c])||(m[c]+=g[c],a[c]+=1,"h"===t.charAt(c)&&(r=m[c]/180*o,s+=S(r),l+=be(r)));for(c in m)if(m[c]=m[c]/a[c],"h"===t.charAt(c)){for(r=f(l/a[c],s/a[c])/o*180;r<0;)r+=360;for(;r>=360;)r-=360;m[c]=r}return w(m,t).alpha(n/h)},h.rgb=function(){var e,t,r,n;for(e in r=[],t=Se(arguments))n=t[e],r.push(n);return r},w.rgb=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["rgb"]),function(){})},r.prototype.rgb=function(e){return null==e&&(e=!0),e?this._rgb.map(Math.round).slice(0,3):this._rgb.slice(0,3)},r.prototype.rgba=function(e){return null==e&&(e=!0),e?[Math.round(this._rgb[0]),Math.round(this._rgb[1]),Math.round(this._rgb[2]),this._rgb[3]]:this._rgb.slice(0)},u.push({p:3,test:function(e){var t;return t=Se(arguments),"array"===_e(t)&&3===t.length?"rgb":4===t.length&&"number"===_e(t[3])&&t[3]>=0&&t[3]<=1?"rgb":void 0}}),R=function(e){var t,r;if(e.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return 4!==e.length&&7!==e.length||(e=e.substr(1)),3===e.length&&(e=(e=e.split(""))[0]+e[0]+e[1]+e[1]+e[2]+e[2]),[(r=parseInt(e,16))>>16,r>>8&255,255&r,1];if(e.match(/^#?([A-Fa-f0-9]{8})$/))return 9===e.length&&(e=e.substr(1)),[(r=parseInt(e,16))>>24&255,r>>16&255,r>>8&255,ve((255&r)/255*100)/100];if(null!=h.css&&(t=h.css(e)))return t;throw"unknown color: "+e},ie=function(e,t){var r,n,i,o,a,s;return null==t&&(t="rgb"),a=e[0],i=e[1],n=e[2],r=e[3],a=Math.round(a),i=Math.round(i),n=Math.round(n),s=(s="000000"+(a<<16|i<<8|n).toString(16)).substr(s.length-6),o=(o="0"+ve(255*r).toString(16)).substr(o.length-2),"#"+function(){switch(t.toLowerCase()){case"rgba":return s+o;case"argb":return o+s;default:return s}}()},h.hex=function(e){return R(e)},w.hex=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["hex"]),function(){})},r.prototype.hex=function(e){return null==e&&(e="rgb"),ie(this._rgb,e)},u.push({p:4,test:function(e){if(1===arguments.length&&"string"===_e(e))return"hex"}}),D=function(){var e,t,r,n,i,o,a,s,l,u,c,h,p,d;if(i=(e=Se(arguments))[0],c=e[1],a=e[2],0===c)l=n=t=255*a;else{for(d=[0,0,0],r=[0,0,0],h=2*a-(p=a<.5?a*(1+c):a+c-a*c),i/=360,d[0]=i+1/3,d[1]=i,d[2]=i-1/3,o=s=0;s<=2;o=++s)d[o]<0&&(d[o]+=1),d[o]>1&&(d[o]-=1),6*d[o]<1?r[o]=h+6*(p-h)*d[o]:2*d[o]<1?r[o]=p:3*d[o]<2?r[o]=h+(p-h)*(2/3-d[o])*6:r[o]=h;l=(u=[ve(255*r[0]),ve(255*r[1]),ve(255*r[2])])[0],n=u[1],t=u[2]}return e.length>3?[l,n,t,e[3]]:[l,n,t]},ae=function(e,t,r){var n,i,o,a,s;return void 0!==e&&e.length>=3&&(e=(a=e)[0],t=a[1],r=a[2]),e/=255,t/=255,r/=255,o=Math.min(e,t,r),i=((Y=Math.max(e,t,r))+o)/2,Y===o?(s=0,n=Number.NaN):s=i<.5?(Y-o)/(Y+o):(Y-o)/(2-Y-o),e===Y?n=(t-r)/(Y-o):t===Y?n=2+(r-e)/(Y-o):r===Y&&(n=4+(e-t)/(Y-o)),(n*=60)<0&&(n+=360),[n,s,i]},w.hsl=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["hsl"]),function(){})},h.hsl=D,r.prototype.hsl=function(){return ae(this._rgb)},k=function(){var e,t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v;if(i=(e=Se(arguments))[0],m=e[1],v=e[2],v*=255,0===m)l=n=t=v;else switch(360===i&&(i=0),i>360&&(i-=360),i<0&&(i+=360),a=v*(1-m),s=v*(1-m*(r=(i/=60)-(o=E(i)))),g=v*(1-m*(1-r)),o){case 0:l=(u=[v,g,a])[0],n=u[1],t=u[2];break;case 1:l=(c=[s,v,a])[0],n=c[1],t=c[2];break;case 2:l=(h=[a,v,g])[0],n=h[1],t=h[2];break;case 3:l=(p=[a,s,v])[0],n=p[1],t=p[2];break;case 4:l=(d=[g,a,v])[0],n=d[1],t=d[2];break;case 5:l=(f=[v,a,s])[0],n=f[1],t=f[2]}return[l,n,t,e.length>3?e[3]:1]},se=function(){var e,t,r,n,i,o,a,s,l;return o=(a=Se(arguments))[0],r=a[1],e=a[2],i=Math.min(o,r,e),t=(Y=Math.max(o,r,e))-i,l=Y/255,0===Y?(n=Number.NaN,s=0):(s=t/Y,o===Y&&(n=(r-e)/t),r===Y&&(n=2+(e-o)/t),e===Y&&(n=4+(o-r)/t),(n*=60)<0&&(n+=360)),[n,s,l]},w.hsv=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["hsv"]),function(){})},h.hsv=k,r.prototype.hsv=function(){return se(this._rgb)},J=function(e){return"number"===_e(e)&&e>=0&&e<=16777215?[e>>16,e>>8&255,255&e,1]:(console.warn("unknown num color: "+e),[0,0,0,1])},he=function(){var e;return((e=Se(arguments))[0]<<16)+(e[1]<<8)+e[2]},w.num=function(e){return new r(e,"num")},r.prototype.num=function(e){return null==e&&(e="rgb"),he(this._rgb,e)},h.num=J,u.push({p:1,test:function(e){if(1===arguments.length&&"number"===_e(e)&&e>=0&&e<=16777215)return"num"}}),P=function(){var e,t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b;if(s=(r=Se(arguments))[0],i=r[1],t=r[2],a=a/100*255,e=255*(i/=100),0===i)h=a=n=t;else switch(360===s&&(s=0),s>360&&(s-=360),s<0&&(s+=360),c=(u=t*(1-i))+e*(1-(o=(s/=60)-(l=E(s)))),y=u+e*o,b=u+e,l){case 0:h=(p=[b,y,u])[0],a=p[1],n=p[2];break;case 1:h=(d=[c,b,u])[0],a=d[1],n=d[2];break;case 2:h=(f=[u,b,y])[0],a=f[1],n=f[2];break;case 3:h=(m=[u,c,b])[0],a=m[1],n=m[2];break;case 4:h=(g=[y,u,b])[0],a=g[1],n=g[2];break;case 5:h=(v=[b,u,c])[0],a=v[1],n=v[2]}return[h,a,n,r.length>3?r[3]:1]},ne=function(){var e,t,r,n,i,o,a,s,l;return s=(l=Se(arguments))[0],i=l[1],t=l[2],a=Math.min(s,i,t),r=100*(n=(Y=Math.max(s,i,t))-a)/255,e=a/(255-n)*100,0===n?o=Number.NaN:(s===Y&&(o=(i-t)/n),i===Y&&(o=2+(t-s)/n),t===Y&&(o=4+(s-i)/n),(o*=60)<0&&(o+=360)),[o,r,e]},w.hcg=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["hcg"]),function(){})},h.hcg=P,r.prototype.hcg=function(){return ne(this._rgb)},C=function(e){var t,r,n,i,o,a,s,l;if(e=e.toLowerCase(),null!=w.colors&&w.colors[e])return R(w.colors[e]);if(o=e.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(s=o.slice(1,4),i=a=0;a<=2;i=++a)s[i]=+s[i];s[3]=1}else if(o=e.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(s=o.slice(1,5),i=l=0;l<=3;i=++l)s[i]=+s[i];else if(o=e.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(s=o.slice(1,4),i=t=0;t<=2;i=++t)s[i]=ve(2.55*s[i]);s[3]=1}else if(o=e.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(s=o.slice(1,5),i=r=0;r<=2;i=++r)s[i]=ve(2.55*s[i]);s[3]=+s[3]}else(o=e.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?((n=o.slice(1,4))[1]*=.01,n[2]*=.01,(s=D(n))[3]=1):(o=e.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&((n=o.slice(1,4))[1]*=.01,n[2]*=.01,(s=D(n))[3]=+o[4]);return s},re=function(e){var t;return"rgb"===(t=e[3]<1?"rgba":"rgb")?t+"("+e.slice(0,3).map(ve).join(",")+")":"rgba"===t?t+"("+e.slice(0,3).map(ve).join(",")+","+e[3]+")":void 0},ge=function(e){return ve(100*e)/100},N=function(e,t){var r;return r=t<1?"hsla":"hsl",e[0]=ge(e[0]||0),e[1]=ge(100*e[1])+"%",e[2]=ge(100*e[2])+"%","hsla"===r&&(e[3]=t),r+"("+e.join(",")+")"},h.css=function(e){return C(e)},w.css=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["css"]),function(){})},r.prototype.css=function(e){return null==e&&(e="rgb"),"rgb"===e.slice(0,3)?re(this._rgb):"hsl"===e.slice(0,3)?N(this.hsl(),this.alpha()):void 0},h.named=function(e){return R(Ce[e])},u.push({p:5,test:function(e){if(1===arguments.length&&null!=Ce[e])return"named"}}),r.prototype.name=function(e){var t,r;for(r in arguments.length&&(Ce[e]&&(this._rgb=R(Ce[e])),this._rgb[3]=1),t=this.hex(),Ce)if(t===Ce[r])return r;return t},H=function(){var e,t,r,i;return r=(i=Se(arguments))[0],e=i[1],t=i[2],[r,S(t*=n)*e,be(t)*e]},$=function(){var e,t,r,n,i,o,a,s,l;return a=(r=Se(arguments))[0],i=r[1],o=r[2],e=(s=H(a,i,o))[0],t=s[1],n=s[2],[(l=z(e,t,n))[0],l[1],n=l[2],r.length>3?r[3]:1]},B=function(){var e,t,r,n,i,o;return i=(o=Se(arguments))[0],e=o[1],t=o[2],r=we(e*e+t*t),n=(f(t,e)*s+360)%360,0===ve(1e4*r)&&(n=Number.NaN),[i,r,n]},ue=function(){var e,t,r,n,i,o,a;return i=(o=Se(arguments))[0],r=o[1],t=o[2],n=(a=le(i,r,t))[0],e=a[1],t=a[2],B(n,e,t)},w.lch=function(){var e;return e=Se(arguments),new r(e,"lch")},w.hcl=function(){var e;return e=Se(arguments),new r(e,"hcl")},h.lch=$,h.hcl=function(){var e,t,r,n;return t=(n=Se(arguments))[0],e=n[1],r=n[2],$([r,e,t])},r.prototype.lch=function(){return ue(this._rgb)},r.prototype.hcl=function(){return ue(this._rgb).reverse()},te=function(e){var t,r,n,i,o,a;return null==e&&(e="rgb"),o=(a=Se(arguments))[0],n=a[1],t=a[2],n/=255,t/=255,[(1-(o/=255)-(i=1-Math.max(o,Math.max(n,t))))*(r=i<1?1/(1-i):0),(1-n-i)*r,(1-t-i)*r,i]},_=function(){var e,t,r,n,i,o;return r=(t=Se(arguments))[0],i=t[1],o=t[2],n=t[3],e=t.length>4?t[4]:1,1===n?[0,0,0,e]:[r>=1?0:255*(1-r)*(1-n),i>=1?0:255*(1-i)*(1-n),o>=1?0:255*(1-o)*(1-n),e]},h.cmyk=function(){return _(Se(arguments))},w.cmyk=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["cmyk"]),function(){})},r.prototype.cmyk=function(){return te(this._rgb)},h.gl=function(){var e,t,r,n,i;for(n=function(){var e,r;for(t in r=[],e=Se(arguments))i=e[t],r.push(i);return r}.apply(this,arguments),e=r=0;r<=2;e=++r)n[e]*=255;return n},w.gl=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["gl"]),function(){})},r.prototype.gl=function(){var e;return[(e=this._rgb)[0]/255,e[1]/255,e[2]/255,e[3]]},ce=function(e,t,r){var n;return e=(n=Se(arguments))[0],t=n[1],r=n[2],.2126*(e=X(e))+.7152*(t=X(t))+.0722*(r=X(r))},X=function(e){return(e/=255)<=.03928?e/12.92:ee((e+.055)/1.055,2.4)},p=[],w.interpolate=O=function(e,t,r,n){var i,o,a,s;for(null==r&&(r=.5),null==n&&(n="rgb"),"object"!==_e(e)&&(e=w(e)),"object"!==_e(t)&&(t=w(t)),a=0,o=p.length;a<o;a++)if(n===(i=p[a])[0]){s=i[1](e,t,r,n);break}if(null==s)throw"color mode "+n+" is not supported";return s.alpha(e.alpha()+r*(t.alpha()-e.alpha()))},r.prototype.interpolate=function(e,t,r){return O(this,e,t,r)},w.mix=O,r.prototype.mix=r.prototype.interpolate,V=function(e,t,n,i){var o,a;return o=e._rgb,a=t._rgb,new r(o[0]+n*(a[0]-o[0]),o[1]+n*(a[1]-o[1]),o[2]+n*(a[2]-o[2]),i)},p.push(["rgb",V]),r.prototype.luminance=function(e,t){var r,n,i,o;return null==t&&(t="rgb"),arguments.length?(0===e?this._rgb=[0,0,0,this._rgb[3]]:1===e?this._rgb=[255,255,255,this._rgb[3]]:(n=1e-7,i=20,o=function(r,a){var s,l;return s=(l=r.interpolate(a,.5,t)).luminance(),Math.abs(e-s)<n||!i--?l:s>e?o(r,l):o(l,a)},r=ce(this._rgb),this._rgb=(r>e?o(w("black"),this):o(this,w("white"))).rgba()),this):ce(this._rgb)},xe=function(e){var t,r,n,i;return(i=e/100)<66?(n=255,r=-155.25485562709179-.44596950469579133*(r=i-2)+104.49216199393888*q(r),t=i<20?0:.8274096064007395*(t=i-10)-254.76935184120902+115.67994401066147*q(t)):(n=351.97690566805693+.114206453784165*(n=i-55)-40.25366309332127*q(n),r=325.4494125711974+.07943456536662342*(r=i-50)-28.0852963507957*q(r),t=255),[n,r,t]},pe=function(){var e,t,r,n,i,o,a;for(n=(i=Se(arguments))[0],i[1],e=i[2],r=1e3,t=4e4,.4;t-r>.4;)(o=xe(a=.5*(t+r)))[2]/o[0]>=e/n?t=a:r=a;return ve(a)},w.temperature=w.kelvin=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["temperature"]),function(){})},h.temperature=h.kelvin=h.K=xe,r.prototype.temperature=function(){return pe(this._rgb)},r.prototype.kelvin=r.prototype.temperature,w.contrast=function(e,t){var n,i,o,a;return"string"!==(o=_e(e))&&"number"!==o||(e=new r(e)),"string"!==(a=_e(t))&&"number"!==a||(t=new r(t)),(n=e.luminance())>(i=t.luminance())?(n+.05)/(i+.05):(i+.05)/(n+.05)},w.distance=function(e,t,n){var i,o,a,s,l,u,c;for(o in null==n&&(n="lab"),"string"!==(l=_e(e))&&"number"!==l||(e=new r(e)),"string"!==(u=_e(t))&&"number"!==u||(t=new r(t)),a=e.get(n),s=t.get(n),c=0,a)c+=(i=(a[o]||0)-(s[o]||0))*i;return Math.sqrt(c)},w.deltaE=function(e,t,n,i){var a,s,l,u,c,h,p,m,g,v,y,b,w,x,_,C,M,T,A,E,P,R,I,N;for(null==n&&(n=1),null==i&&(i=1),"string"!==(_=_e(e))&&"number"!==_||(e=new r(e)),"string"!==(C=_e(t))&&"number"!==C||(t=new r(t)),a=(M=e.lab())[0],l=M[1],c=M[2],s=(T=t.lab())[0],u=T[1],h=T[2],p=we(l*l+c*c),m=we(u*u+h*h),E=a<16?.511:.040975*a/(1+.01765*a),A=.0638*p/(1+.0131*p)+.638,x=p<1e-6?0:180*f(c,l)/o;x<0;)x+=360;for(;x>=360;)x-=360;return P=x>=164&&x<=345?.56+d(.2*S(o*(x+168)/180)):.36+d(.4*S(o*(x+35)/180)),w=we((g=p*p*p*p)/(g+1900)),we((R=(a-s)/(n*E))*R+(I=(b=p-m)/(i*A))*I+((v=l-u)*v+(y=c-h)*y-b*b)/((N=A*(w*P+1-w))*N))},r.prototype.get=function(e){var t,r,n,i,o;return this,n=(i=e.split("."))[0],t=i[1],o=this[n](),t?(r=n.indexOf(t))>-1?o[r]:console.warn("unknown channel "+t+" in mode "+n):o},r.prototype.set=function(e,t){var r,n,i,o,a;if(this,i=(o=e.split("."))[0],r=o[1])if(a=this[i](),(n=i.indexOf(r))>-1)if("string"===_e(t))switch(t.charAt(0)){case"+":case"-":a[n]+=+t;break;case"*":a[n]*=+t.substr(1);break;case"/":a[n]/=+t.substr(1);break;default:a[n]=+t}else a[n]=t;else console.warn("unknown channel "+r+" in mode "+i);else a=t;return w(a,i).alpha(this.alpha())},r.prototype.clipped=function(){return this._rgb._clipped||!1},r.prototype.alpha=function(e){return arguments.length?w.rgb([this._rgb[0],this._rgb[1],this._rgb[2],e]):this._rgb[3]},r.prototype.darken=function(e){var t;return null==e&&(e=1),this,(t=this.lab())[0]-=i.Kn*e,w.lab(t).alpha(this.alpha())},r.prototype.brighten=function(e){return null==e&&(e=1),this.darken(-e)},r.prototype.darker=r.prototype.darken,r.prototype.brighter=r.prototype.brighten,r.prototype.saturate=function(e){var t;return null==e&&(e=1),this,(t=this.lch())[1]+=e*i.Kn,t[1]<0&&(t[1]=0),w.lch(t).alpha(this.alpha())},r.prototype.desaturate=function(e){return null==e&&(e=1),this.saturate(-e)},r.prototype.premultiply=function(){var e,t;return t=this.rgb(),e=this.alpha(),w(t[0]*e,t[1]*e,t[2]*e,e)},Z=function(e,t){return e*t/255},M=function(e,t){return e>t?t:e},G=function(e,t){return e>t?e:t},ye=function(e,t){return 255*(1-(1-e/255)*(1-t/255))},Q=function(e,t){return t<128?2*e*t/255:255*(1-2*(1-e/255)*(1-t/255))},b=function(e,t){return 255*(1-(1-t/255)/(e/255))},T=function(e,t){return 255===e?255:(e=t/255*255/(1-e/255))>255?255:e},(g=function(e,t,r){if(!g[r])throw"unknown blend mode "+r;return g[r](e,t)}).normal=(v=function(e){return function(t,r){var n,i;return n=w(r).rgb(),i=w(t).rgb(),w(e(n,i),"rgb")}})((A=function(e){return function(t,r){var n,i,o;for(o=[],n=i=0;i<=3;n=++i)o[n]=e(t[n],r[n]);return o}})(function(e,t){return e})),g.multiply=v(A(Z)),g.screen=v(A(ye)),g.overlay=v(A(Q)),g.darken=v(A(M)),g.lighten=v(A(G)),g.dodge=v(A(T)),g.burn=v(A(b)),w.blend=g,w.analyze=function(e){var t,r,n,i;for(n={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},r=0,t=e.length;r<t;r++)null==(i=e[r])||isNaN(i)||(n.values.push(i),n.sum+=i,i<n.min&&(n.min=i),i>n.max&&(n.max=i),n.count+=1);return n.domain=[n.min,n.max],n.limits=function(e,t){return w.limits(n,e,t)},n},w.scale=function(e,t){var r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,x,_;return u="rgb",c=w("#ccc"),f=0,a=[0,1],d=[],p=[0,0],r=!1,i=[],h=!1,l=0,s=1,o=!1,n={},m=!0,x=function(e){var t,r,n,o,a,s;if(null==e&&(e=["#fff","#000"]),null!=e&&"string"===_e(e)&&null!=w.brewer&&(e=w.brewer[e]||w.brewer[e.toLowerCase()]||e),"array"===_e(e)){for(t=n=0,o=(e=e.slice(0)).length-1;0<=o?n<=o:n>=o;t=0<=o?++n:--n)r=e[t],"string"===_e(r)&&(e[t]=w(r));for(d.length=0,t=s=0,a=e.length-1;0<=a?s<=a:s>=a;t=0<=a?++s:--s)d.push(t/(e.length-1))}return b(),i=e},v=function(e){var t,n;if(null!=r){for(n=r.length-1,t=0;t<n&&e>=r[t];)t++;return t-1}return 0},_=function(e){return e},y=function(e,t){var o,a,h,f,g,y,b;if(null==t&&(t=!1),isNaN(e))return c;if(t?b=e:r&&r.length>2?(b=v(e)/(r.length-2),b=p[0]+b*(1-p[0]-p[1])):s!==l?(b=(e-l)/(s-l),b=p[0]+b*(1-p[0]-p[1]),b=Math.min(1,Math.max(0,b))):b=1,t||(b=_(b)),h=Math.floor(1e4*b),m&&n[h])o=n[h];else{if("array"===_e(i))for(a=f=0,y=d.length-1;0<=y?f<=y:f>=y;a=0<=y?++f:--f){if(b<=(g=d[a])){o=i[a];break}if(b>=g&&a===d.length-1){o=i[a];break}if(b>g&&b<d[a+1]){b=(b-g)/(d[a+1]-g),o=w.interpolate(i[a],i[a+1],b,u);break}}else"function"===_e(i)&&(o=i(b));m&&(n[h]=o)}return o},b=function(){return n={}},x(e),(g=function(e){var t;return t=w(y(e)),h&&t[h]?t[h]():t}).classes=function(e){var t;return null!=e?("array"===_e(e)?(r=e,a=[e[0],e[e.length-1]]):(t=w.analyze(a),r=0===e?[t.min,t.max]:w.limits(t,"e",e)),g):r},g.domain=function(e){var t,r,n,o,u,c,h;if(!arguments.length)return a;if(l=e[0],s=e[e.length-1],d=[],n=i.length,e.length===n&&l!==s)for(u=0,o=e.length;u<o;u++)r=e[u],d.push((r-l)/(s-l));else for(t=h=0,c=n-1;0<=c?h<=c:h>=c;t=0<=c?++h:--h)d.push(t/(n-1));return a=[l,s],g},g.mode=function(e){return arguments.length?(u=e,b(),g):u},g.range=function(e,t){return x(e),g},g.out=function(e){return h=e,g},g.spread=function(e){return arguments.length?(f=e,g):f},g.correctLightness=function(e){return null==e&&(e=!0),o=e,b(),_=o?function(e){var t,r,n,i,o,a,s,l,u;for(t=y(0,!0).lab()[0],r=y(1,!0).lab()[0],s=t>r,n=y(e,!0).lab()[0],i=n-(o=t+(r-t)*e),l=0,u=1,a=20;Math.abs(i)>.01&&a-- >0;)s&&(i*=-1),i<0?(l=e,e+=.5*(u-e)):(u=e,e+=.5*(l-e)),n=y(e,!0).lab()[0],i=n-o;return e}:function(e){return e},g},g.padding=function(e){return null!=e?("number"===_e(e)&&(e=[e,e]),p=e,g):p},g.colors=function(t,n){var o,s,l,u,c,h,p,d;if(arguments.length<2&&(n="hex"),c=[],0===arguments.length)c=i.slice(0);else if(1===t)c=[g(.5)];else if(t>1)s=a[0],o=a[1]-s,c=function(){h=[];for(var e=0;0<=t?e<t:e>t;0<=t?e++:e--)h.push(e);return h}.apply(this).map(function(e){return g(s+e/(t-1)*o)});else{if(e=[],p=[],r&&r.length>2)for(l=d=1,u=r.length;1<=u?d<u:d>u;l=1<=u?++d:--d)p.push(.5*(r[l-1]+r[l]));else p=a;c=p.map(function(e){return g(e)})}return w[n]&&(c=c.map(function(e){return e[n]()})),c},g.cache=function(e){return null!=e?m=e:m},g},null==w.scales&&(w.scales={}),w.scales.cool=function(){return w.scale([w.hsl(180,1,.9),w.hsl(250,.7,.4)])},w.scales.hot=function(){return w.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},w.analyze=function(e,t,r){var n,i,o,a,s,l;if(s={min:Number.MAX_VALUE,max:-1*Number.MAX_VALUE,sum:0,values:[],count:0},null==r&&(r=function(){return!0}),n=function(e){null==e||isNaN(e)||(s.values.push(e),s.sum+=e,e<s.min&&(s.min=e),e>s.max&&(s.max=e),s.count+=1)},l=function(e,i){if(r(e,i))return null!=t&&"function"===_e(t)?n(t(e)):null!=t&&"string"===_e(t)||"number"===_e(t)?n(e[t]):n(e)},"array"===_e(e))for(a=0,o=e.length;a<o;a++)l(e[a]);else for(i in e)l(e[i],i);return s.domain=[s.min,s.max],s.limits=function(e,t){return w.limits(s,e,t)},s},w.limits=function(e,t,r){var n,i,o,a,s,l,u,c,h,p,f,m,g,v,y,b,x,_,S,C,M,T,A,P,R,I,N,D,k,O,F,L,U,V,B,z,j,H,$,G,W,X,K,Z,J,Q,te,re,ne,ie,oe,ae,se,le,ue;if(null==t&&(t="equal"),null==r&&(r=7),"array"===_e(e)&&(e=w.analyze(e)),R=e.min,Y=e.max,e.sum,le=e.values.sort(function(e,t){return e-t}),1===r)return[R,Y];if(A=[],"c"===t.substr(0,1)&&(A.push(R),A.push(Y)),"e"===t.substr(0,1)){for(A.push(R),C=F=1,B=r-1;1<=B?F<=B:F>=B;C=1<=B?++F:--F)A.push(R+C/r*(Y-R));A.push(Y)}else if("l"===t.substr(0,1)){if(R<=0)throw"Logarithmic scales are only possible for values > 0";for(I=Math.LOG10E*q(R),P=Math.LOG10E*q(Y),A.push(R),C=ue=1,z=r-1;1<=z?ue<=z:ue>=z;C=1<=z?++ue:--ue)A.push(ee(10,I+C/r*(P-I)));A.push(Y)}else if("q"===t.substr(0,1)){for(A.push(R),C=n=1,X=r-1;1<=X?n<=X:n>=X;C=1<=X?++n:--n)L=(le.length-1)*C/r,(U=E(L))===L?A.push(le[U]):(V=L-U,A.push(le[U]*(1-V)+le[U+1]*V));A.push(Y)}else if("k"===t.substr(0,1)){for(D=le.length,v=new Array(D),_=new Array(r),ie=!0,k=0,b=null,(b=[]).push(R),C=i=1,K=r-1;1<=K?i<=K:i>=K;C=1<=K?++i:--i)b.push(R+C/r*(Y-R));for(b.push(Y);ie;){for(M=o=0,Z=r-1;0<=Z?o<=Z:o>=Z;M=0<=Z?++o:--o)_[M]=0;for(C=a=0,J=D-1;0<=J?a<=J:a>=J;C=0<=J?++a:--a){for(se=le[C],N=Number.MAX_VALUE,M=s=0,Q=r-1;0<=Q?s<=Q:s>=Q;M=0<=Q?++s:--s)(S=d(b[M]-se))<N&&(N=S,y=M);_[y]++,v[C]=y}for(O=new Array(r),M=l=0,te=r-1;0<=te?l<=te:l>=te;M=0<=te?++l:--l)O[M]=null;for(C=u=0,re=D-1;0<=re?u<=re:u>=re;C=0<=re?++u:--u)null===O[x=v[C]]?O[x]=le[C]:O[x]+=le[C];for(M=c=0,ne=r-1;0<=ne?c<=ne:c>=ne;M=0<=ne?++c:--c)O[M]*=1/_[M];for(ie=!1,M=h=0,j=r-1;0<=j?h<=j:h>=j;M=0<=j?++h:--h)if(O[M]!==b[C]){ie=!0;break}b=O,++k>200&&(ie=!1)}for(T={},M=p=0,H=r-1;0<=H?p<=H:p>=H;M=0<=H?++p:--p)T[M]=[];for(C=f=0,$=D-1;0<=$?f<=$:f>=$;C=0<=$?++f:--f)T[x=v[C]].push(le[C]);for(oe=[],M=m=0,G=r-1;0<=G?m<=G:m>=G;M=0<=G?++m:--m)oe.push(T[M][0]),oe.push(T[M][T[M].length-1]);for(oe=oe.sort(function(e,t){return e-t}),A.push(oe[0]),C=g=1,W=oe.length-1;g<=W;C=g+=2)ae=oe[C],isNaN(ae)||-1!==A.indexOf(ae)||A.push(ae)}return A},I=function(e,t,r){var n,i,o,s;return e=(n=Se(arguments))[0],t=n[1],r=n[2],isNaN(e)&&(e=0),(e/=360)<1/3?o=1-((i=(1-t)/3)+(s=(1+t*S(l*e)/S(a-l*e))/3)):e<2/3?i=1-((s=(1-t)/3)+(o=(1+t*S(l*(e-=1/3))/S(a-l*e))/3)):s=1-((o=(1-t)/3)+(i=(1+t*S(l*(e-=2/3))/S(a-l*e))/3)),[255*(s=W(r*s*3)),255*(o=W(r*o*3)),255*(i=W(r*i*3)),n.length>3?n[3]:1]},oe=function(){var e,t,r,n,i,o,a;return i=(o=Se(arguments))[0],t=o[1],e=o[2],l=2*Math.PI,i/=255,t/=255,e/=255,0===(a=1-Math.min(i,t,e)/(n=(i+t+e)/3))?r=0:(r=(i-t+(i-e))/2,r/=Math.sqrt((i-t)*(i-t)+(i-e)*(t-e)),r=Math.acos(r),e>t&&(r=l-r),r/=l),[360*r,a,n]},w.hsi=function(){return function(e,t,r){r.prototype=e.prototype;var n=new r,i=e.apply(n,t);return Object(i)===i?i:n}(r,Ae.call(arguments).concat(["hsi"]),function(){})},h.hsi=I,r.prototype.hsi=function(){return oe(this._rgb)},F=function(e,t,r,n){var i,o,a,s,l,u,c,h,p,d;return"hsl"===n?(p=e.hsl(),d=t.hsl()):"hsv"===n?(p=e.hsv(),d=t.hsv()):"hcg"===n?(p=e.hcg(),d=t.hcg()):"hsi"===n?(p=e.hsi(),d=t.hsi()):"lch"!==n&&"hcl"!==n||(n="hcl",p=e.hcl(),d=t.hcl()),"h"===n.substr(0,1)&&(o=p[0],c=p[1],s=p[2],a=d[0],h=d[1],l=d[2]),isNaN(o)||isNaN(a)?isNaN(o)?isNaN(a)?i=Number.NaN:(i=a,1!==s&&0!==s||"hsv"===n||(u=h)):(i=o,1!==l&&0!==l||"hsv"===n||(u=c)):i=o+r*(a>o&&a-o>180?a-(o+360):a<o&&o-a>180?a+360-o:a-o),null==u&&(u=c+r*(h-c)),w[n](i,u,s+r*(l-s))},U=function(e,t,r,n){var i,o;return i=e.num(),o=t.num(),w.num(i+(o-i)*r,"num")},(p=p.concat(function(){var e,t,r,n;for(n=[],t=0,e=(r=["hsv","hsl","hsi","hcl","lch","hcg"]).length;t<e;t++)K=r[t],n.push([K,F]);return n}())).push(["num",U]),L=function(e,t,n,i){var o,a;return o=e.lab(),a=t.lab(),new r(o[0]+n*(a[0]-o[0]),o[1]+n*(a[1]-o[1]),o[2]+n*(a[2]-o[2]),i)},p.push(["lab",L])}).call(i)}).scale,Cs={scale:"uniform",mode:"hcl",domain:[0,1],value:16777215,reverse:!1},Ms=new ur,Ts=function(e){void 0===e&&(e={}),this.parameters=$a(e,Cs),"string"==typeof this.parameters.value&&(this.parameters.value=Ms.set(this.parameters.value).getHex()),this.parameters.structure&&(this.atomProxy=this.parameters.structure.getAtomProxy())};Ts.prototype.getScale=function(e){void 0===e&&(e={});var t=$a(e,this.parameters);return"rainbow"===t.scale?t.scale=["red","orange","yellow","green","blue"]:"rwb"===t.scale&&(t.scale=["red","white","blue"]),t.reverse&&(t.domain=[t.domain[1],t.domain[0]]),Ss(t.scale).mode(t.mode).domain(t.domain).out("num")},Ts.prototype.colorToArray=function(e,t,r){return void 0===t&&(t=[]),void 0===r&&(r=0),t[r]=(e>>16&255)/255,t[r+1]=(e>>8&255)/255,t[r+2]=(255&e)/255,t},Ts.prototype.atomColorToArray=function(e,t,r){return this.colorToArray(this.atomColor?this.atomColor(e):0,t,r)},Ts.prototype.bondColor=function(e,t){return this.atomProxy&&this.atomColor?(this.atomProxy.index=t?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):0},Ts.prototype.bondColorToArray=function(e,t,r,n){return this.colorToArray(this.bondColor(e,t),r,n)},Ts.prototype.volumeColorToArray=function(e,t,r){return this.colorToArray(this.volumeColor?this.volumeColor(e):0,t,r)},Ts.prototype.positionColorToArray=function(e,t,r){return this.colorToArray(this.positionColor?this.positionColor(e):0,t,r)};var As=o(function(e){
/** @license
 * JS Signals <http://millermedeiros.github.com/js-signals/>
 * Released under the MIT license
 * Author: Miller Medeiros
 * Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
 */
!function(t){function r(e,t,r,n,i){this._listener=t,this._isOnce=r,this.context=n,this._signal=e,this._priority=i||0}function n(e,t){if("function"!=typeof e)throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))}function i(){this._bindings=[],this._prevParams=null;var e=this;this.dispatch=function(){i.prototype.dispatch.apply(e,arguments)}}r.prototype={active:!0,params:null,execute:function(e){var t,r;return this.active&&this._listener&&(r=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,r),this._isOnce&&this.detach()),t},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},i.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(e,t,n,i){var o,a=this._indexOfListener(e,n);if(-1!==a){if((o=this._bindings[a]).isOnce()!==t)throw new Error("You cannot add"+(t?"":"Once")+"() then add"+(t?"Once":"")+"() the same listener without removing the relationship first.")}else o=new r(this,e,t,n,i),this._addBinding(o);return this.memorize&&this._prevParams&&o.execute(this._prevParams),o},_addBinding:function(e){var t=this._bindings.length;do{--t}while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){for(var r,n=this._bindings.length;n--;)if((r=this._bindings[n])._listener===e&&r.context===t)return n;return-1},has:function(e,t){return-1!==this._indexOfListener(e,t)},add:function(e,t,r){return n(e,"add"),this._registerListener(e,!1,t,r)},addOnce:function(e,t,r){return n(e,"addOnce"),this._registerListener(e,!0,t,r)},remove:function(e,t){n(e,"remove");var r=this._indexOfListener(e,t);return-1!==r&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)),e},removeAll:function(){for(var e=this._bindings.length;e--;)this._bindings[e]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(e){if(this.active){var t,r=Array.prototype.slice.call(arguments),n=this._bindings.length;if(this.memorize&&(this._prevParams=r),n){t=this._bindings.slice(),this._shouldPropagate=!0;do{n--}while(t[n]&&this._shouldPropagate&&!1!==t[n].execute(r))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var o=i;o.Signal=i,e.exports?e.exports=o:t.signals=o}(i)}).Signal,Es={PROTEIN:1,NUCLEIC:2,RNA:3,DNA:4,POLYMER:5,WATER:6,HELIX:7,SHEET:8,TURN:9,BACKBONE:10,SIDECHAIN:11,ALL:12,HETERO:13,ION:14,SACCHARIDE:15,SUGAR:15,BONDED:16,RING:17,AROMATICRING:18},Ps=["*","","ALL"],Rs=[Es.BACKBONE,Es.SIDECHAIN,Es.BONDED,Es.RING,Es.AROMATICRING],Is=[Es.POLYMER,Es.WATER],Ns=["ALA","GLY","SER"],Ds=["CYS","SER","THR"],ks=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],Os=["PHE","TRP","TYR","HIS"],Fs=["ASN","GLN"],Ls=["ASP","GLU"],Us=["ARG","HIS","LYS"],Vs=["ARG","ASP","GLU","HIS","LYS"],Bs=["ASN","ARG","ASP","CYS","GLY","GLN","GLU","HIS","LYS","SER","THR","TYR"],zs=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],js=["HIS","PHE","PRO","TRP","TYR"],Hs=["ALA","GLY","ILE","LEU","VAL"];function $s(e,t){if(void 0===t.atomname&&void 0===t.element&&void 0===t.altloc&&void 0===t.atomindex&&void 0===t.keyword&&void 0===t.inscode&&void 0===t.resname&&void 0===t.sstruc&&void 0===t.resno&&void 0===t.chainname&&void 0===t.model)return-1;if(void 0!==t.keyword){if(t.keyword===Es.BACKBONE&&!e.isBackbone())return!1;if(t.keyword===Es.SIDECHAIN&&!e.isSidechain())return!1;if(t.keyword===Es.BONDED&&!e.isBonded())return!1;if(t.keyword===Es.RING&&!e.isRing())return!1;if(t.keyword===Es.AROMATICRING&&!e.isAromatic())return!1;if(t.keyword===Es.HETERO&&!e.isHetero())return!1;if(t.keyword===Es.PROTEIN&&!e.isProtein())return!1;if(t.keyword===Es.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===Es.RNA&&!e.isRna())return!1;if(t.keyword===Es.DNA&&!e.isDna())return!1;if(t.keyword===Es.POLYMER&&!e.isPolymer())return!1;if(t.keyword===Es.WATER&&!e.isWater())return!1;if(t.keyword===Es.HELIX&&!e.isHelix())return!1;if(t.keyword===Es.SHEET&&!e.isSheet())return!1;if(t.keyword===Es.TURN&&!e.isTurn())return!1;if(t.keyword===Es.ION&&!e.isIon())return!1;if(t.keyword===Es.SACCHARIDE&&!e.isSaccharide())return!1}if(void 0!==t.atomname&&t.atomname!==e.atomname)return!1;if(void 0!==t.element&&t.element!==e.element)return!1;if(void 0!==t.altloc&&t.altloc!==e.altloc)return!1;if(void 0!==t.atomindex&&Qa(t.atomindex,e.index)<0)return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function Gs(e,t){if(void 0===t.resname&&void 0===t.resno&&void 0===t.inscode&&void 0===t.sstruc&&void 0===t.model&&void 0===t.chainname&&void 0===t.atomindex&&(void 0===t.keyword||Rs.includes(t.keyword)))return-1;if(void 0!==t.keyword){if(t.keyword===Es.HETERO&&!e.isHetero())return!1;if(t.keyword===Es.PROTEIN&&!e.isProtein())return!1;if(t.keyword===Es.NUCLEIC&&!e.isNucleic())return!1;if(t.keyword===Es.RNA&&!e.isRna())return!1;if(t.keyword===Es.DNA&&!e.isDna())return!1;if(t.keyword===Es.POLYMER&&!e.isPolymer())return!1;if(t.keyword===Es.WATER&&!e.isWater())return!1;if(t.keyword===Es.HELIX&&!e.isHelix())return!1;if(t.keyword===Es.SHEET&&!e.isSheet())return!1;if(t.keyword===Es.TURN&&!e.isTurn())return!1;if(t.keyword===Es.ION&&!e.isIon())return!1;if(t.keyword===Es.SACCHARIDE&&!e.isSaccharide())return!1}if(void 0!==t.atomindex&&0===es(t.atomindex,e.atomOffset,e.atomEnd))return!1;if(void 0!==t.resname)if(Array.isArray(t.resname)){if(!t.resname.includes(e.resname))return!1}else if(t.resname!==e.resname)return!1;if(void 0!==t.sstruc&&t.sstruc!==e.sstruc)return!1;if(void 0!==t.resno)if(Array.isArray(t.resno)&&2===t.resno.length){if(t.resno[0]>e.resno||t.resno[1]<e.resno)return!1}else if(t.resno!==e.resno)return!1;return(void 0===t.inscode||t.inscode===e.inscode)&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function Ws(e,t){if(!(void 0!==t.chainname||void 0!==t.model||void 0!==t.atomindex||void 0!==t.keyword&&Is.includes(t.keyword)&&e.entity))return-1;if(void 0!==t.keyword){if(t.keyword===Es.POLYMER&&!e.entity.isPolymer())return!1;if(t.keyword===Es.WATER&&!e.entity.isWater())return!1}return(void 0===t.atomindex||0!==es(t.atomindex,e.atomOffset,e.atomEnd))&&((void 0===t.chainname||t.chainname===e.chainname)&&(void 0===t.model||t.model===e.modelIndex))}function qs(e,t){return void 0===t.model&&void 0===t.atomindex?-1:(void 0===t.atomindex||0!==es(t.atomindex,e.atomOffset,e.atomEnd))&&(void 0===t.model||t.model===e.index)}function Xs(e,t){if(null===e)return!1;if(e.error)return!1;if(!e.rules||0===e.rules.length)return!1;for(var r=e.rules.length,n=!e.negate,i=!!e.negate,o=[],a=0;a<r;++a){var s=e.rules[a];s.hasOwnProperty("operator")&&(o[a]=Xs(s,t))}return function(a){for(var s="AND"===e.operator,l=!1,u=0;u<r;++u){var c=e.rules[u],h=void 0;if(c.hasOwnProperty("operator")){var p=o[u];if(-1===(h=!1!==p?p(a):-1)){l=!0;continue}if(!0===h){if(s)continue;return n}if(s)return i}else{if(c.keyword===Es.ALL){if(s)continue;return n}if(-1!==(h=t(a,c))){if(!0===h){if(s)continue;return n}if(s)return i}else l=!0}}return l?-1:s?n:i}}function Ks(e,t){if(e.error)return e;if(!e.rules||0===e.rules.length)return e;var r=e.rules.length,n={operator:e.operator,rules:[]};e.hasOwnProperty("negate")&&(n.negate=e.negate);for(var i=0;i<r;++i){var o=e.rules[i];if(o.hasOwnProperty("operator")){var a=Ks(o,t);null!==a&&n.rules.push(a)}else t(o)||n.rules.push(o)}return n.rules.length>0?e:null}function Ys(e,t){void 0===t&&(t=!1);var r=e;return t&&(r=Ks(e,function(e){return void 0!==e.keyword&&!Rs.includes(e.keyword)||(void 0!==e.model||(void 0!==e.chainname||(void 0!==e.resname||(void 0!==e.resno||void 0!==e.sstruc))))})),Xs(r,$s)}function Zs(e,t){void 0===t&&(t=!1);var r=e;return t&&(r=Ks(e,function(e){return!(void 0===e.keyword||!Rs.includes(e.keyword))||(void 0!==e.model||(void 0!==e.chainname||(void 0!==e.atomname||(void 0!==e.element||void 0!==e.altloc))))})),Xs(r,Gs)}function Js(e,t){void 0===t&&(t=!1);var r=e;return t&&(r=Ks(e,function(e){return void 0!==e.keyword&&!Is.includes(e.keyword)||(void 0!==e.resname||(void 0!==e.resno||(void 0!==e.atomname||(void 0!==e.element||(void 0!==e.altloc||(void 0!==e.sstruc||void 0!==e.inscode))))))})),Xs(r,Ws)}function Qs(e,t){void 0===t&&(t=!1);var r=e;return t&&(r=Ks(e,function(e){return void 0!==e.keyword||(void 0!==e.chainname||(void 0!==e.resname||(void 0!==e.resno||(void 0!==e.atomname||(void 0!==e.element||(void 0!==e.altloc||(void 0!==e.sstruc||void 0!==e.inscode)))))))})),Xs(r,qs)}var el=function(e){this.signals={stringChanged:new As},this.setString(e)},tl={type:{configurable:!0}};tl.type.get=function(){return"selection"},el.prototype.setString=function(e,t){if(void 0===e&&(e=this.string||""),e!==this.string){try{this.selection=function(e){var t={operator:void 0,rules:[]};if(!e)return t;var r,n,i=t,o=[];"("===(e=e.replace(/\(/g," ( ").replace(/\)/g," ) ").trim()).charAt(0)&&")"===e.substr(-1)&&(e=e.slice(1,-1).trim());for(var a=e.split(/\s+/),s=function(e){r={operator:e,rules:[]},void 0===i?(i=r,t=r):(i.rules.push(r),o.push(i),i=r)},l=function(e){n=i,void 0===(i=o.pop())&&(s(e),u(n))},u=function(e){i.rules.push(e)},c=!1,h=0;h<a.length;++h){var p=a[h],d=p.toUpperCase();if("("!==p)if(")"!==p){if(c>0)if("NOT"===d)c=1;else if(1===c)c=2;else{if(2!==c)throw new Error("something went wrong with 'not'");c=!1,l()}if("AND"!==d)if("OR"!==d)if("NOT"!==p.toUpperCase()){var f=Es[d];if(void 0===f)if("HYDROGEN"!==d)if("SMALL"!==d)if("NUCLEOPHILIC"!==d)if("HYDROPHOBIC"!==d)if("AROMATIC"!==d)if("AMIDE"!==d)if("ACIDIC"!==d)if("BASIC"!==d)if("CHARGED"!==d)if("POLAR"!==d)if("NONPOLAR"!==d)if("CYCLIC"!==d)if("ALIPHATIC"!==d)if("SIDECHAINATTACHED"!==d)if("LIGAND"!==d)if(-1===Ps.indexOf(d))if("@"!==p.charAt(0))if("#"!==p.charAt(0))if("_"!==p.charAt(0))if("["!==p[0]||"]"!==p[p.length-1])if(p.length>=1&&p.length<=4&&"^"!==p[0]&&":"!==p[0]&&"."!==p[0]&&"%"!==p[0]&&"/"!==p[0]&&isNaN(parseInt(p)))u({resname:d});else{var m={operator:"AND",rules:[]},g=p.split("/");if(g.length>1&&g[1]){if(isNaN(parseInt(g[1])))throw new Error("model must be an integer");m.rules.push({model:parseInt(g[1])})}var v=g[0].split("%");v.length>1&&m.rules.push({altloc:v[1]});var y=v[0].split(".");if(y.length>1&&y[1]){if(y[1].length>4)throw new Error("atomname must be one to four characters");m.rules.push({atomname:y[1].substring(0,4).toUpperCase()})}var b=y[0].split(":");b.length>1&&b[1]&&m.rules.push({chainname:b[1]});var w=b[0].split("^");if(w.length>1&&m.rules.push({inscode:w[1]}),w[0]){var x=void 0,_=void 0;"-"===w[0][0]&&(w[0]=w[0].substr(1),x=!0),w[0].includes("--")&&(w[0]=w[0].replace("--","-"),_=!0);var S=w[0].split("-");if(1===S.length){var C=parseInt(S[0]);if(isNaN(C))throw new Error("resi must be an integer");x&&(C*=-1),m.rules.push({resno:C})}else{if(2!==S.length)throw new Error("resi range must contain one '-'");var M=S.map(function(e){return parseInt(e)});x&&(M[0]*=-1),_&&(M[1]*=-1),m.rules.push({resno:[M[0],M[1]]})}}if(1===m.rules.length)u(m.rules[0]);else{if(!(m.rules.length>1))throw new Error("empty selection chunk");u(m)}}else{var T=d.substr(1,p.length-2).split(","),A=T.length>1?T:T[0];u({resname:A})}else u({element:d.substr(1)});else console.error("# for element selection deprecated, use _"),u({element:d.substr(1)});else{var E=p.substr(1).split(",").map(function(e){return parseInt(e)});E.sort(function(e,t){return e-t}),u({atomindex:E})}else u({keyword:Es.ALL});else u({operator:"AND",rules:[{operator:"OR",rules:[{operator:"AND",rules:[{keyword:Es.HETERO},{negate:!0,operator:void 0,rules:[{keyword:Es.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{keyword:Es.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{operator:"OR",rules:[{keyword:Es.WATER},{keyword:Es.ION}]}]}]});else u({operator:"OR",rules:[{keyword:Es.SIDECHAIN},{operator:"AND",negate:!1,rules:[{keyword:Es.PROTEIN},{operator:"OR",negate:!1,rules:[{atomname:"CA"},{atomname:"BB"}]}]},{operator:"AND",negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{operator:"AND",negate:!1,rules:[{keyword:Es.NUCLEIC},{operator:"OR",negate:!0,rules:[{atomname:"P"},{atomname:"OP1"},{atomname:"OP2"},{atomname:"O3'"},{atomname:"O3*"},{atomname:"O5'"},{atomname:"O5*"},{atomname:"C5'"},{atomname:"C5*"}]}]}]});else u({resname:Hs});else u({resname:js});else u({resname:zs});else u({resname:Bs});else u({resname:Vs});else u({resname:Us});else u({resname:Ls});else u({resname:Fs});else u({resname:Os});else u({resname:ks});else u({resname:Ds});else u({resname:Ns});else u({element:"H"});else u({keyword:f})}else c=1,s(),i.negate=!0;else"AND"===i.operator?l("OR"):i.operator="OR";else if("OR"===i.operator){var P=i.rules.pop();s("AND"),u(P)}else i.operator="AND"}else l(),i.negate&&l();else c=!1,s()}return void 0===t.operator&&1===t.rules.length&&t.rules[0].hasOwnProperty("operator")&&(t=t.rules[0]),t}(e)}catch(e){this.selection={error:e.message}}var r=this.selection;this.string=e,this.test=Ys(r),this.residueTest=Zs(r),this.chainTest=Js(r),this.modelTest=Qs(r),this.atomOnlyTest=Ys(r,!0),this.residueOnlyTest=Zs(r,!0),this.chainOnlyTest=Js(r,!0),this.modelOnlyTest=Qs(r,!0),t||this.signals.stringChanged.dispatch(this.string)}},Object.defineProperties(el.prototype,tl);var rl=function(e){function t(t){var r=this;e.call(this,t),this.colormakerList=[],this.selectionList=[],(t.dataList||[]).forEach(function(e){var t=e[0],n=e[1],i=e[2];void 0===i&&(i={}),Sl.hasScheme(t)?Object.assign(i,{scheme:t,structure:r.parameters.structure}):Object.assign(i,{scheme:"uniform",value:new ur(t).getHex()}),r.colormakerList.push(Sl.getScheme(i)),r.selectionList.push(new el(n))})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){for(var t=0,r=this.selectionList.length;t<r;++t){var n=this.selectionList[t].test;if(n&&n(e))return this.colormakerList[t].atomColor(e)}return 16777215},t}(Ts),nl={"":"",OrRd:"[S] Orange-Red",PuBu:"[S] Purple-Blue",BuPu:"[S] Blue-Purple",Oranges:"[S] Oranges",BuGn:"[S] Blue-Green",YlOrBr:"[S] Yellow-Orange-Brown",YlGn:"[S] Yellow-Green",Reds:"[S] Reds",RdPu:"[S] Red-Purple",Greens:"[S] Greens",YlGnBu:"[S] Yellow-Green-Blue",Purples:"[S] Purples",GnBu:"[S] Green-Blue",Greys:"[S] Greys",YlOrRd:"[S] Yellow-Orange-Red",PuRd:"[S] Purple-Red",Blues:"[S] Blues",PuBuGn:"[S] Purple-Blue-Green",Viridis:"[D] Viridis",Spectral:"[D] Spectral",RdYlGn:"[D] Red-Yellow-Green",RdBu:"[D] Red-Blue",PiYG:"[D] Pink-Yellowgreen",PRGn:"[D] Purplered-Green",RdYlBu:"[D] Red-Yellow-Blue",BrBG:"[D] Brown-Bluegreen",RdGy:"[D] Red-Grey",PuOr:"[D] Purple-Orange",Set1:"[Q] Set1",Set2:"[Q] Set2",Set3:"[Q] Set3",Dark2:"[Q] Dark2",Paired:"[Q] Paired",Pastel1:"[Q] Pastel1",Pastel2:"[Q] Pastel2",Accent:"[Q] Accent",rainbow:"[?] Rainbow",rwb:"[?] Red-White-Blue"},il={"":"",rgb:"Red Green Blue",hsv:"Hue Saturation Value",hsl:"Hue Saturation Lightness",hsi:"Hue Saturation Intensity",lab:"CIE L*a*b*",hcl:"Hue Chroma Lightness"},ol=function(){this.schemes={},this.userSchemes={}};ol.prototype.getScheme=function(e){var t=((e||{}).scheme||"").toLowerCase();return new(t in this.schemes?this.schemes[t]:t in this.userSchemes?this.userSchemes[t]:Ts)(e)},ol.prototype.getSchemes=function(){var e={};return Object.keys(this.schemes).forEach(function(t){e[t]=t}),Object.keys(this.userSchemes).forEach(function(t){e[t]=t.split("|")[1]}),e},ol.prototype.getScales=function(){return nl},ol.prototype.getModes=function(){return il},ol.prototype.add=function(e,t){e=e.toLowerCase(),this.schemes[e]=t},ol.prototype.addScheme=function(e,t){return e instanceof Ts||(e=this._createScheme(e)),this._addUserScheme(e,t)},ol.prototype._addUserScheme=function(e,t){t=t||"";var r=(vs()+"|"+t).toLowerCase();return this.userSchemes[r]=e,r},ol.prototype.removeScheme=function(e){e=e.toLowerCase(),delete this.userSchemes[e]},ol.prototype._createScheme=function(e){var t=function(t){Ts.call(this,t),e.call(this,t)};return(t.prototype=Ts.prototype).constructor=Ts,t},ol.prototype.addSelectionScheme=function(e,t){var r=function(t){function r(r){t.call(this,Object.assign({dataList:e},r))}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r}(rl);return this._addUserScheme(r,t)},ol.prototype.hasScheme=function(e){return(e=e.toLowerCase())in this.schemes||e in this.userSchemes};var al=function(e){function t(){e.call(this,"parser")}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.__hasObjName=function(e,t){var r=this.get(e);return r&&r.prototype.__objName===t},t.prototype.isTrajectory=function(e){return this.__hasObjName(e,"frames")},t.prototype.isStructure=function(e){return this.__hasObjName(e,"structure")},t.prototype.isVolume=function(e){return this.__hasObjName(e,"volume")},t.prototype.isSurface=function(e){return this.__hasObjName(e,"surface")},t.prototype.isBinary=function(e){var t=this.get(e);return t&&t.prototype.isBinary},t.prototype.isXml=function(e){var t=this.get(e);return t&&t.prototype.isXml},t.prototype.isJson=function(e){var t=this.get(e);return t&&t.prototype.isJson},t.prototype.getTrajectoryExtensions=function(){var e=this;return this.names.filter(function(t){return e.isTrajectory(t)})},t.prototype.getStructureExtensions=function(){var e=this;return this.names.filter(function(t){return e.isStructure(t)})},t.prototype.getVolumeExtensions=function(){var e=this;return this.names.filter(function(t){return e.isVolume(t)})},t.prototype.getSurfaceExtensions=function(){var e=this;return this.names.filter(function(t){return e.isSurface(t)})},t}(ps);function sl(e){return ts(function e(t){var r=t;return t.forEach(function(t){t.__deps&&Array.prototype.push.apply(r,e(t.__deps))}),r}(e)).map(function(e){return e.toString()}).join("\n\n\n")}function ll(e,t){var r="'use strict';\n\n"+sl(t);return r+="\n\n\nself.func = "+e.toString()+";",r+="\n\n\nself.onmessage = "+function(e){var t=e.data.__name,r=e.data.__postId;void 0===t?console.error("message __name undefined"):void 0===self.func?console.error("worker func undefined",t):self.func(e,function(e,t){e=e||{},void 0!==r&&(e.__postId=r);try{self.postMessage(e,t)}catch(t){console.error("self.postMessage:",t),self.postMessage(e)}})}.toString()+";",new Blob([r],{type:"application/javascript"})}var ul=function(){this.activeWorkerCount=0,this._funcDict={},this._depsDict={},this._blobDict={}};ul.prototype.add=function(e,t,r){this._funcDict[e]=t,this._depsDict[e]=r},ul.prototype.get=function(e){return this._blobDict[e]||(this._blobDict[e]=ll(this._funcDict[e],this._depsDict[e])),this._blobDict[e]};var cl=Xa(),hl=!1;try{var pl=Object.defineProperty({},"passive",{get:function(){hl=!0}});window.addEventListener("test",function(e){},pl)}catch(e){}var dl="undefined"!=typeof window&&void 0!==window.orientation,fl=!1;var ml=!1;var gl={log:Function.prototype.bind.call(console.log,console),info:Function.prototype.bind.call(console.info,console),warn:Function.prototype.bind.call(console.warn,console),error:Function.prototype.bind.call(console.error,console),time:Function.prototype.bind.call(console.time,console),timeEnd:Function.prototype.bind.call(console.timeEnd,console)},vl=function(e){return!!e&&("string"!=typeof e||/^1|true|t|yes|y$/i.test(e))}(ja("debug"));function yl(e){vl=e}var bl,wl,xl=["ngl","js"],_l=new ul,Sl=new ol,Cl=new ps("datasource"),Ml=new ps("representatation"),Tl=new al,Al=new ps("shader"),El=new ps("decompressor"),Pl=new ps("component"),Rl=new ps("buffer"),Il=new ps("picker");function Nl(e){bl=e}function Dl(e){wl=e}var kl=function(e,t){void 0===t&&(t={}),this.chunkSize=10485760,this.newline="\n",this.__pointer=0,this.__partialLine="",this.compressed=Ha(t.compressed,!1),this.binary=Ha(t.binary,!1),this.json=Ha(t.json,!1),this.xml=Ha(t.xml,!1),this.src=e};kl.prototype.isBinary=function(){return this.binary||this.compressed},kl.prototype.read=function(){var e=this;return this._read().then(function(t){var r=e.compressed?El.get(e.compressed):void 0;return e.compressed&&r?e.data=r(t):((e.binary||e.compressed)&&t instanceof ArrayBuffer&&(t=new Uint8Array(t)),e.data=t),e.data})},kl.prototype._chunk=function(e,t){return t=Math.min(this.data.length,t),0===e&&this.data.length===t?this.data:this.isBinary()?this.data.subarray(e,t):this.data.substring(e,t)},kl.prototype.chunk=function(e){var t=e+this.chunkSize;return this._chunk(e,t)},kl.prototype.peekLines=function(e){var t,r=this.data,n=r.length,i=this.isBinary()?this.newline.charCodeAt(0):this.newline,o=0;for(t=0;t<n&&(r[t]===i&&++o,o!==e);++t);var a=this._chunk(0,t+1);return this.chunkToLines(a,"",t>n).lines},kl.prototype.chunkCount=function(){return Math.floor(this.data.length/this.chunkSize)+1},kl.prototype.asText=function(){return this.isBinary()?rs(this.data):this.data},kl.prototype.chunkToLines=function(e,t,r){var n=this.newline;if(!this.isBinary()&&e.length===this.data.length)return{lines:e.split(n),partialLine:""};var i=[],o=this.isBinary()?rs(e):e,a=o.lastIndexOf(n);if(-1===a)t+=o;else{var s=t+o.substr(0,a);i=i.concat(s.split(n)),t=a===o.length-n.length?"":o.substr(a+n.length)}return r&&""!==t&&i.push(t),{lines:i,partialLine:t}},kl.prototype.nextChunk=function(){var e=this.__pointer;if(!(e>this.data.length))return this.__pointer+=this.chunkSize,this.chunk(e)},kl.prototype.nextChunkOfLines=function(){var e=this.nextChunk();if(void 0!==e){var t=this.__pointer>this.data.length,r=this.chunkToLines(e,this.__partialLine,t);return this.__partialLine=r.partialLine,r.lines}},kl.prototype.eachChunk=function(e){for(var t=this.chunkSize,r=this.data.length,n=this.chunkCount(),i=0;i<r;i+=t){e(this.chunk(i),Math.round(i/t),n)}},kl.prototype.eachChunkOfLines=function(e){var t=this;this.eachChunk(function(r,n,i){var o=n===i+1,a=t.chunkToLines(r,t.__partialLine,o);t.__partialLine=a.partialLine,e(a.lines,n,i)})},kl.prototype.dispose=function(){delete this.src};var Ol=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._read=function(){var e=this;return new Promise(function(t,r){var n=e.src,i=new FileReader;i.onload=function(e){return t(e.target.result)},i.onerror=function(e){return r(e)},e.binary||e.compressed?i.readAsArrayBuffer(n):i.readAsText(n)})},t}(kl),Fl=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._read=function(){var e=this;return new Promise(function(t,r){var n=e.src,i=new XMLHttpRequest;i.open("GET",n,!0),i.addEventListener("load",function(){if(200===i.status||304===i.status||0===i.status)try{t(i.response)}catch(e){r(e)}else r(i.statusText)},!1),i.addEventListener("error",function(e){return r("network error")},!1),e.isBinary()?i.responseType="arraybuffer":e.json?i.responseType="json":e.xml?i.responseType="document":i.responseType="text",i.send(null)})},t}(kl),Ll=function(e,t){void 0===t&&(t={}),this.parameters=$a(t,{ext:"",compressed:!1,binary:Tl.isBinary(t.ext||""),name:"",dir:"",path:"",protocol:""});var r={compressed:this.parameters.compressed,binary:this.parameters.binary,json:Tl.isJson(this.parameters.ext),xml:Tl.isXml(this.parameters.ext)};"undefined"!=typeof File&&e instanceof File||"undefined"!=typeof Blob&&e instanceof Blob?this.streamer=new Ol(e,r):this.streamer=new Fl(e,r)},Ul=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.parserParams={voxelSize:r.voxelSize,firstModelOnly:r.firstModelOnly,asTrajectory:r.asTrajectory,cAlphaOnly:r.cAlphaOnly,name:this.parameters.name,path:this.parameters.path}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.load=function(){return new(Tl.get(this.parameters.ext))(this.streamer,this.parserParams).parse()},t}(Ll),Vl=function(e,t,r){this.name=t,this.path=r,this.signals={elementAdded:new As,elementRemoved:new As,nameChanged:new As},this.type="Script",this.dir=r.substring(0,r.lastIndexOf("/")+1);try{this.fn=new Function("stage","__name","__path","__dir",e)}catch(e){gl.error("Script compilation failed",e),this.fn=function(){}}};Vl.prototype.run=function(e){var t=this;return new Promise(function(r,n){try{t.fn.apply(null,[e,t.name,t.path,t.dir]),r()}catch(e){gl.error("Script.fn",e),n(e)}})};var Bl=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.load=function(){var e=this;return this.streamer.read().then(function(){return new Vl(e.streamer.asText(),e.parameters.name,e.parameters.path)})},t}(Ll);function zl(e){var t,r,n=El.names,i="",o=(t=e instanceof File?e.name:e instanceof Blob?"":e).lastIndexOf("?"),a=-1!==o?t.substring(o):"",s=(t=t.substring(0,-1===o?t.length:o)).replace(/^.*[\\/]/,""),l=s.substring(0,s.lastIndexOf(".")),u=s.split("."),c=u.length>1?(u.pop()||"").toLowerCase():"",h=t.match(/^(.+):\/\/(.+)$/);h&&(i=h[1].toLowerCase(),t=h[2]||"");var p=t.substring(0,t.lastIndexOf("/")+1);if(n.includes(c)){r=c;var d=t.length-c.length-1;c=(t.substr(0,d).split(".").pop()||"").toLowerCase();var f=l.length-c.length-1;l=l.substr(0,f)}else r=!1;return{path:t,name:s,ext:c,base:l,dir:p,compressed:r,protocol:i,query:a,src:e}}function jl(e){var t=zl(e),r=Cl.get(t.protocol);return r&&!(t=zl(r.getUrl(t.src))).ext&&r.getExt&&(t.ext=r.getExt(e)),t}function Hl(e,t){void 0===t&&(t={});var r,n=Object.assign(jl(e),t);return Tl.names.includes(n.ext)?r=new Ul(n.src,n):xl.includes(n.ext)&&(r=new Bl(n.src,n)),r?r.load():Promise.reject(new Error("autoLoad: ext '"+n.ext+"' unknown"))}var $l=o(function(e,t){!function(){var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};function r(t){return function(t,n){var i,o,a,s,l,u,c,h,p,d=1,f=t.length,m="";for(o=0;o<f;o++)if("string"==typeof t[o])m+=t[o];else if(Array.isArray(t[o])){if((s=t[o])[2])for(i=n[d],a=0;a<s[2].length;a++){if(!i.hasOwnProperty(s[2][a]))throw new Error(r('[sprintf] property "%s" does not exist',s[2][a]));i=i[s[2][a]]}else i=s[1]?n[s[1]]:n[d++];if(e.not_type.test(s[8])&&e.not_primitive.test(s[8])&&i instanceof Function&&(i=i()),e.numeric_arg.test(s[8])&&"number"!=typeof i&&isNaN(i))throw new TypeError(r("[sprintf] expecting number but found %T",i));switch(e.number.test(s[8])&&(h=i>=0),s[8]){case"b":i=parseInt(i,10).toString(2);break;case"c":i=String.fromCharCode(parseInt(i,10));break;case"d":case"i":i=parseInt(i,10);break;case"j":i=JSON.stringify(i,null,s[6]?parseInt(s[6]):0);break;case"e":i=s[7]?parseFloat(i).toExponential(s[7]):parseFloat(i).toExponential();break;case"f":i=s[7]?parseFloat(i).toFixed(s[7]):parseFloat(i);break;case"g":i=s[7]?String(Number(i.toPrecision(s[7]))):parseFloat(i);break;case"o":i=(parseInt(i,10)>>>0).toString(8);break;case"s":i=String(i),i=s[7]?i.substring(0,s[7]):i;break;case"t":i=String(!!i),i=s[7]?i.substring(0,s[7]):i;break;case"T":i=Object.prototype.toString.call(i).slice(8,-1).toLowerCase(),i=s[7]?i.substring(0,s[7]):i;break;case"u":i=parseInt(i,10)>>>0;break;case"v":i=i.valueOf(),i=s[7]?i.substring(0,s[7]):i;break;case"x":i=(parseInt(i,10)>>>0).toString(16);break;case"X":i=(parseInt(i,10)>>>0).toString(16).toUpperCase()}e.json.test(s[8])?m+=i:(!e.number.test(s[8])||h&&!s[3]?p="":(p=h?"+":"-",i=i.toString().replace(e.sign,"")),u=s[4]?"0"===s[4]?"0":s[4].charAt(1):" ",c=s[6]-(p+i).length,l=s[6]&&c>0?u.repeat(c):"",m+=s[5]?p+i+l:"0"===u?p+l+i:l+p+i)}return m}(function(t){if(i[t])return i[t];var r,n=t,o=[],a=0;for(;n;){if(null!==(r=e.text.exec(n)))o.push(r[0]);else if(null!==(r=e.modulo.exec(n)))o.push("%");else{if(null===(r=e.placeholder.exec(n)))throw new SyntaxError("[sprintf] unexpected placeholder");if(r[2]){a|=1;var s=[],l=r[2],u=[];if(null===(u=e.key.exec(l)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(s.push(u[1]);""!==(l=l.substring(u[0].length));)if(null!==(u=e.key_access.exec(l)))s.push(u[1]);else{if(null===(u=e.index_access.exec(l)))throw new SyntaxError("[sprintf] failed to parse named argument key");s.push(u[1])}r[2]=s}else a|=2;if(3===a)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o.push(r)}n=n.substring(r[0].length)}return i[t]=o}(t),arguments)}function n(e,t){return r.apply(null,[e].concat(t||[]))}var i=Object.create(null);t.sprintf=r,t.vsprintf=n,"undefined"!=typeof window&&(window.sprintf=r,window.vsprintf=n)}()}).sprintf,Gl=function(){};Gl.prototype.getBlob=function(){return new Blob([this.getData()],{type:this.mimeType})},Gl.prototype.download=function(e,t){e=Ha(e,this.defaultName),t=Ha(t,this.defaultExt),Ya(this.getBlob(),e+"."+t)};var Wl=function(e){function t(t,r){e.call(this),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="pdb";var n=Object.assign({},r);this.renumberSerial=Ha(n.renumberSerial,!0),this.remarks=function(e){return Array.isArray(e)?e:[e]}(Ha(n.remarks,[])),this.structure=t,this._records=[]}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._writeRecords=function(){this._records.length=0,this._writeTitle(),this._writeRemarks(),this._writeAtoms()},t.prototype._writeTitle=function(){this._records.push($l("TITLE %-74s",this.structure.name))},t.prototype._writeRemarks=function(){var e=this;this.remarks.forEach(function(t){e._records.push($l("REMARK %-73s",t))}),this.structure.trajectory&&(this._records.push($l("REMARK %-73s","Trajectory '"+this.structure.trajectory.name+"'")),this._records.push($l("REMARK %-73s","Frame "+this.structure.trajectory.frame)))},t.prototype._writeAtoms=function(){var e=this,t=1,r=1;this.structure.eachModel(function(n){e._records.push($l("MODEL %-74d",r++)),n.eachAtom(function(r){var n=r.hetero?"HETATM%5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s":"ATOM  %5d %-4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s",i=e.renumberSerial?t:r.serial,o=r.atomname;1===o.length&&(o=" "+o),e._records.push($l(n,i,o,r.resname,Ha(r.chainname," "),r.resno,r.x,r.y,r.z,Ha(r.occupancy,1),Ha(r.bfactor,0),"",Ha(r.element,""))),t+=1}),e._records.push($l("%-80s","ENDMDL")),r+=1}),this._records.push($l("%-80s","END"))},t.prototype.getString=function(){return console.warn("PdbWriter.getString() is deprecated, use .getData instead"),this.getData()},t.prototype.getData=function(){return this._writeRecords(),this._records.join("\n")},t}(Gl),ql=function(e){function t(t){e.call(this),this.mimeType="text/plain",this.defaultName="structure",this.defaultExt="sdf",this.structure=t,this._records=[]}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={idString:{configurable:!0},titleString:{configurable:!0},countsString:{configurable:!0},chargeLines:{configurable:!0}};return r.idString.get=function(){return this.structure.id},r.titleString.get=function(){return"  "+this.structure.title},r.countsString.get=function(){return $l("%3i%3i  0  0  0  0  0  0  0  0999 V2000",this.structure.atomCount,this.structure.bondCount)},r.chargeLines.get=function(){var e=[];this.structure.eachAtom(function(t){null!=t.formalCharge&&0!==t.formalCharge&&e.push([t.index,t.formalCharge])});for(var t=[],r=0;r<e.length;r+=8){for(var n=Math.min(8,e.length-r),i=$l("M  CHG%3i",n),o=r;o<r+n;o++)i+=$l(" %3i %3i",e[o][0]+1,e[o][1]);t.push(i)}return t},t.prototype.formatAtom=function(e){var t=0;null!=e.formalCharge&&0!==e.formalCharge&&(t=4-e.formalCharge);var r=$l("%10.4f%10.4f%10.4f %-3s 0%3i  0  0  0",e.x,e.y,e.z,e.element,t);if(48!==r.length)throw new Error("Incompatible atom for sdf format");return r},t.prototype.formatBond=function(e){return $l("%3i%3i%3i  0  0  0",e.atomIndex1+1,e.atomIndex2+1,e.bondOrder)},t.prototype._writeRecords=function(){this._records.length=0,this._writeHeader(),this._writeCTab(),this._writeFooter()},t.prototype._writeHeader=function(){this._records.push(this.idString,this.titleString,"")},t.prototype._writeCTab=function(){var e=this;this._records.push(this.countsString),this.structure.eachAtom(function(t){e._records.push(e.formatAtom(t))}),this.structure.eachBond(function(t){e._records.push(e.formatBond(t))}),this.chargeLines.forEach(function(t){e._records.push(t)}),this._records.push("M  END")},t.prototype._writeFooter=function(){this._records.push("$$$$")},t.prototype.getData=function(){return this._writeRecords(),this._records.join("\n")},Object.defineProperties(t.prototype,r),t}(Gl),Xl=[],Kl=function(e,t){void 0===t&&(t={}),this._mark=0,this._marks=[],this.offset=0,this.littleEndian=!0;var r=!1;void 0===e&&(e=8192),"number"==typeof e?e=new ArrayBuffer(e):r=!0;var n=t.offset?t.offset>>>0:0,i=e.byteLength-n,o=n;e instanceof ArrayBuffer||(e.byteLength!==e.buffer.byteLength&&(o=e.byteOffset+n),e=e.buffer),this._lastWrittenByte=r?i:0,this.buffer=e,this.length=i,this.byteLength=i,this.byteOffset=o,this._data=new DataView(this.buffer,o,i)};Kl.prototype.available=function(e){return void 0===e&&(e=1),this.offset+e<=this.length},Kl.prototype.isLittleEndian=function(){return this.littleEndian},Kl.prototype.setLittleEndian=function(){return this.littleEndian=!0,this},Kl.prototype.isBigEndian=function(){return!this.littleEndian},Kl.prototype.setBigEndian=function(){return this.littleEndian=!1,this},Kl.prototype.skip=function(e){return void 0===e&&(e=1),this.offset+=e,this},Kl.prototype.seek=function(e){return this.offset=e,this},Kl.prototype.mark=function(){return this._mark=this.offset,this},Kl.prototype.reset=function(){return this.offset=this._mark,this},Kl.prototype.pushMark=function(){return this._marks.push(this.offset),this},Kl.prototype.popMark=function(){var e=this._marks.pop();if(void 0===e)throw new Error("Mark stack empty");return this.seek(e),this},Kl.prototype.rewind=function(){return this.offset=0,this},Kl.prototype.ensureAvailable=function(e){if(void 0===e&&(e=1),!this.available(e)){var t=2*(this.offset+e),r=new Uint8Array(t);r.set(new Uint8Array(this.buffer)),this.buffer=r.buffer,this.length=this.byteLength=t,this._data=new DataView(this.buffer)}return this},Kl.prototype.readBoolean=function(){return 0!==this.readUint8()},Kl.prototype.readInt8=function(){return this._data.getInt8(this.offset++)},Kl.prototype.readUint8=function(){return this._data.getUint8(this.offset++)},Kl.prototype.readByte=function(){return this.readUint8()},Kl.prototype.readBytes=function(e){void 0===e&&(e=1);for(var t=new Uint8Array(e),r=0;r<e;r++)t[r]=this.readByte();return t},Kl.prototype.readInt16=function(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},Kl.prototype.readUint16=function(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},Kl.prototype.readInt32=function(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},Kl.prototype.readUint32=function(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},Kl.prototype.readFloat32=function(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},Kl.prototype.readFloat64=function(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},Kl.prototype.readChar=function(){return String.fromCharCode(this.readInt8())},Kl.prototype.readChars=function(e){void 0===e&&(e=1),Xl.length=e;for(var t=0;t<e;t++)Xl[t]=this.readChar();return Xl.join("")},Kl.prototype.writeBoolean=function(e){return void 0===e&&(e=!1),this.writeUint8(e?255:0),this},Kl.prototype.writeInt8=function(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this},Kl.prototype.writeUint8=function(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this},Kl.prototype.writeByte=function(e){return this.writeUint8(e)},Kl.prototype.writeBytes=function(e){this.ensureAvailable(e.length);for(var t=0;t<e.length;t++)this._data.setUint8(this.offset++,e[t]);return this._updateLastWrittenByte(),this},Kl.prototype.writeInt16=function(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this},Kl.prototype.writeUint16=function(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this},Kl.prototype.writeInt32=function(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},Kl.prototype.writeUint32=function(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},Kl.prototype.writeFloat32=function(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this},Kl.prototype.writeFloat64=function(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this},Kl.prototype.writeChar=function(e){return this.writeUint8(e.charCodeAt(0))},Kl.prototype.writeChars=function(e){for(var t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));return this},Kl.prototype.toArray=function(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)},Kl.prototype._updateLastWrittenByte=function(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)};var Yl=function(e){function t(t){e.call(this),this.mimeType="application/vnd.ms-pki.stl",this.defaultName="surface",this.defaultExt="stl",this.surface=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getData=function(){var e=this.surface.index.length/3,t=new Kl(2*e+3*e*4*4+80+4);t.skip(80),t.writeUint32(e);for(var r=new ft,n=new ft,i=new ft,o=new ft,a=0;a<e;a++){var s=[this.surface.index[3*a],this.surface.index[3*a+1],this.surface.index[3*a+2]];n.fromArray(this.surface.normal,3*s[0]),i.fromArray(this.surface.normal,3*s[1]),o.fromArray(this.surface.normal,3*s[2]),r.addVectors(n,i).add(o).normalize(),t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z);for(var l=0;l<3;l++)r.fromArray(this.surface.position,3*s[l]),t.writeFloat32(r.x),t.writeFloat32(r.y),t.writeFloat32(r.z);t.writeUint16(0)}return new DataView(t.buffer)},t}(Gl),Zl=function(){this.count=0,this.signals={countChanged:new As}};Zl.prototype.clear=function(){this.change(-this.count)},Zl.prototype.change=function(e){this.count+=e,this.signals.countChanged.dispatch(e,this.count),this.count<0&&gl.warn("Counter.count below zero",this.count)},Zl.prototype.increment=function(){this.change(1)},Zl.prototype.decrement=function(){this.change(-1)},Zl.prototype.listen=function(e){this.change(e.count),e.signals.countChanged.add(this.change,this)},Zl.prototype.unlisten=function(e){var t=e.signals.countChanged;t.has(this.change,this)&&t.remove(this.change,this)},Zl.prototype.onZeroOnce=function(e,t){var r=this;if(0===this.count)e.call(t);else{var n=function(){0===r.count&&(r.signals.countChanged.remove(n,r),e.call(t))};this.signals.countChanged.add(n,this)}},Zl.prototype.dispose=function(){this.clear(),this.signals.countChanged.dispose()},Al.add("shader/BasicLine.vert","void main(){\n#include begin_vertex\n#include project_vertex\n}"),Al.add("shader/BasicLine.frag","uniform vec3 uColor;\n#include common\n#include fog_pars_fragment\nvoid main(){\ngl_FragColor = vec4( uColor, 1.0 );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}"),Al.add("shader/Quad.vert","varying vec2 vUv;\nvoid main() {\nvUv = uv;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}"),Al.add("shader/Quad.frag","varying vec2 vUv;\nuniform sampler2D tForeground;\nuniform float scale;\nvoid main() {\nvec4 foreground = texture2D( tForeground, vUv );\ngl_FragColor = foreground * scale;\n}");var Jl=function(){this.signals={updated:new As},this.maxDuration=-1/0,this.minDuration=1/0,this.avgDuration=14,this.lastDuration=1/0,this.prevFpsTime=0,this.lastFps=1/0,this.lastFrames=1,this.frames=0,this.count=0,this.begin()};Jl.prototype.update=function(){this.startTime=this.end(),this.currentTime=this.startTime,this.signals.updated.dispatch()},Jl.prototype.begin=function(){this.startTime=window.performance.now(),this.lastFrames=this.frames},Jl.prototype.end=function(){var e=window.performance.now();return this.count+=1,this.frames+=1,this.lastDuration=e-this.startTime,this.minDuration=Math.min(this.minDuration,this.lastDuration),this.maxDuration=Math.max(this.maxDuration,this.lastDuration),this.avgDuration-=this.avgDuration/30,this.avgDuration+=this.lastDuration/30,e>this.prevFpsTime+1e3&&(this.lastFps=this.frames,this.prevFpsTime=e,this.frames=0),e},Al.add("shader/chunk/dull_interior_fragment.glsl","#ifdef DULL_INTERIOR\nif( gl_FrontFacing == false ){\nnormal = vec3( 0.0, 0.0, 0.4 );\n}\n#endif"),Al.add("shader/chunk/fog_fragment.glsl","#ifdef USE_FOG\nfloat depth = length( vViewPosition );\n#ifdef FOG_EXP2\nfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif"),Al.add("shader/chunk/matrix_scale.glsl","float matrixScale( in mat4 m ){\nvec4 r = m[ 0 ];\nreturn sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );\n}"),Al.add("shader/chunk/nearclip_vertex.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear - 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),Al.add("shader/chunk/nearclip_fragment.glsl","#ifdef NEAR_CLIP\nif( vViewPosition.z < clipNear )\ndiscard;\n#endif"),Al.add("shader/chunk/opaque_back_fragment.glsl","#ifdef OPAQUE_BACK\n#ifdef FLIP_SIDED\nif( gl_FrontFacing == true ){\ngl_FragColor.a = 1.0;\n}\n#else\nif( gl_FrontFacing == false ){\ngl_FragColor.a = 1.0;\n}\n#endif\n#endif"),Al.add("shader/chunk/radiusclip_vertex.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius + 5.0 )\ngl_Position.z = 2.0 * gl_Position.w;\n#endif"),Al.add("shader/chunk/radiusclip_fragment.glsl","#ifdef RADIUS_CLIP\nif( distance( vViewPosition, vClipCenter ) > clipRadius )\ndiscard;\n#endif"),Al.add("shader/chunk/unpack_color.glsl","vec3 unpackColor(float f) {\nvec3 color;\ncolor.r = floor(f / 256.0 / 256.0);\ncolor.g = floor((f - color.r * 256.0 * 256.0) / 256.0);\ncolor.b = floor(f - color.r * 256.0 * 256.0 - color.g * 256.0);\nreturn color / 255.0;\n}");var Ql=/^(?!\/\/)\s*#include\s+(\S+)/gim,eu={};function tu(e,t){void 0===t&&(t={});var r=e+"|";for(var n in t)r+=n+":"+t[n];if(!eu[r]){var i=function(e){if(void 0===e)return"";var t=[];for(var r in e){var n=e[r];n&&t.push("#define "+r+" "+n)}return t.join("\n")+"\n"}(t),o=Al.get("shader/"+e);if(!o)throw new Error("empty shader, '"+e+"'");o=o.replace(Ql,function(e,t){var r="shader/chunk/"+t+".glsl";return Al.get(r)||pr[t]||""}),eu[r]=i+o}return eu[r]}if("undefined"!=typeof WebGLRenderingContext){var ru=WebGLRenderingContext.prototype,nu=ru.getShaderParameter;ru.getShaderParameter=function(){return!vl||nu.apply(this,arguments)};var iu=ru.getShaderInfoLog;ru.getShaderInfoLog=function(){return vl?iu.apply(this,arguments):""};var ou=ru.getProgramParameter;ru.getProgramParameter=function(e,t){return!vl&&t===ru.LINK_STATUS||ou.apply(this,arguments)};var au=ru.getProgramInfoLog;ru.getProgramInfoLog=function(){return vl?au.apply(this,arguments):""}}var su=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];su.forEach(function(e){e.forEach(function(e){e[0]*=.0625,e[1]*=.0625})});var lu=function(e,t,r,n){this.canvas=document.createElement("canvas"),this._viewer=r,this._factor=Ha(n.factor,2),this._antialias=Ha(n.antialias,!1),this._onProgress=n.onProgress,this._onFinish=n.onFinish,this._antialias&&(this._factor*=2),this._n=this._factor*this._factor,this._width=this._viewer.width,this._height=this._viewer.height,this._antialias?(this.canvas.width=this._width*this._factor/2,this.canvas.height=this._height*this._factor/2):(this.canvas.width=this._width*this._factor,this.canvas.height=this._height*this._factor),this._ctx=this.canvas.getContext("2d"),this._viewerSampleLevel=r.sampleLevel,this._viewer.setSampling(-1)};lu.prototype._renderTile=function(e){var t=this._viewer,r=this._width,n=this._height,i=this._factor,o=e%i*r,a=Math.floor(e/i)*n;t.camera.setViewOffset(r*i,n*i,o,a,r,n),t.render(),this._antialias?this._ctx.drawImage(t.renderer.domElement,Math.floor(o/2),Math.floor(a/2),Math.ceil(r/2),Math.ceil(n/2)):this._ctx.drawImage(t.renderer.domElement,Math.floor(o),Math.floor(a),Math.ceil(r),Math.ceil(n)),"function"==typeof this._onProgress&&this._onProgress(e+1,this._n,!1)},lu.prototype._finalize=function(){this._viewer.setSampling(this._viewerSampleLevel),this._viewer.camera.view=null,"function"==typeof this._onFinish&&this._onFinish(this._n+1,this._n,!1)},lu.prototype.render=function(){for(var e=0;e<=this._n;++e)e===this._n?this._finalize():this._renderTile(e)},lu.prototype.renderAsync=function(){for(var e=this,t=0,r=this._n,n=function(){t===r?e._finalize():e._renderTile(t),t+=1},i=0;i<=r;++i)setTimeout(n,0)};var uu=2*Math.PI,cu=(Math.PI,180/Math.PI);function hu(e,t,r,n,i){void 0===r&&(r=1),void 0===n&&(n=0);var o=i?i.length:e.length/r,a=0,s=0;if(i)for(var l=0;l<o;++l){var u=(e[i[l]*r+n]+t)%t/t*uu-Math.PI;a+=Math.cos(u),s+=Math.sin(u)}else for(var c=n;c<o;c+=r){var h=(e[c]+t)%t/t*uu-Math.PI;a+=Math.cos(h),s+=Math.sin(h)}return a/=o,s/=o,(Math.atan2(s,a)+Math.PI)/uu*t}function pu(e,t,r,n){void 0===n&&(n=0);var i=e.length;r=r||new Float32Array(i);for(var o=0;o<i;o+=3)r[n+o+0]=(e[o+0]+t[o+0])/2,r[n+o+1]=(e[o+1]+t[o+1])/2,r[n+o+2]=(e[o+2]+t[o+2])/2;return r}function du(e,t){for(var r=e.length,n=new Float32Array(r),i=0;i<r;i+=3)n[i+0]=t[i+0]-e[i+0],n[i+1]=t[i+1]-e[i+1],n[i+2]=t[i+2]-e[i+2];return n}function fu(e,t,r){for(var n=r||new Float32Array(e),i=0;i<e;++i)n[i]=t;return n}function mu(e,t,r,n,i){for(var o=i||new Float32Array(3*e),a=0;a<e;++a){var s=3*a;o[s+0]=t,o[s+1]=r,o[s+2]=n}return o}function gu(e){for(var t=new Float32Array(e),r=0;r<e;++r)t[r]=r;return t}function vu(e,t,r,n){void 0===r&&(r=0);for(var i=n||new Float32Array(e*t),o=0;o<e;++o)for(var a=r+o*t,s=0;s<t;++s)i[a+s]=o;return i}function yu(e,t){for(var r=e.length,n=new Float32Array(r*t),i=0;i<r;++i)for(var o=i*t,a=e[i],s=0;s<t;++s)n[o+s]=a;return n}function bu(e,t,r,n,i){for(var o=0;o<i;++o)t[n+o]=e[r+o]}function wu(e,t,r,n){bu(e,e,t,r,n)}
/**
 * quicksortIP
 * @function
 * @author Roman Bolzern <roman.bolzern@fhnw.ch>, 2013
 * @author I4DS http://www.fhnw.ch/i4ds, 2013
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 * @description
 * In-place quicksort for typed arrays (e.g. for Float32Array)
 * provides fast sorting
 * useful e.g. for a custom shader and/or BufferGeometry
 * Complexity: http://bigocheatsheet.com/ see Quicksort
 *
 * @example
 * points: [x, y, z, x, y, z, x, y, z, ...]
 * eleSize: 3 //because of (x, y, z)
 * orderElement: 0 //order according to x
 *
 * @param {TypedArray} arr - array to be sorted
 * @param {Integer} eleSize - element size
 * @param {Integer} orderElement - index of element used for sorting, < eleSize
 * @param {Integer} [begin] - start index for range to be sorted
 * @param {Integer} [end] - end index for range to be sorted
 * @return {TypedArray} the input array
 */function xu(e){for(var t=-1/0,r=0,n=e.length;r<n;++r)e[r]>t&&(t=e[r]);return t}function _u(e){for(var t=1/0,r=0,n=e.length;r<n;++r)e[r]<t&&(t=e[r]);return t}function Su(e,t,r){void 0===t&&(t=1),void 0===r&&(r=0);for(var n=e.length,i=0,o=r;o<n;o+=t)i+=e[o];return i}function Cu(e,t,r){return void 0===t&&(t=1),void 0===r&&(r=0),Su(e,t,r)/(e.length/t)}var Mu={trim:!1,factor:1,antialias:!1,transparent:!1,onProgress:void 0};function Tu(e,t){void 0===t&&(t={});var r=$a(t,Mu),n=r.trim,i=r.factor,o=r.antialias,a=r.transparent,s=e.renderer,l=e.camera,u=s.getClearAlpha(),c=s.getClearColor();function h(t){void 0===t&&(t=!1);var r=i;o&&(r*=2),t&&(r=1/r),e.scene.traverse(function(e){var t=e.material;t&&t.linewidth&&(t.linewidth*=r),t&&t.uniforms&&t.uniforms.size&&void 0===t.uniforms.size.__seen&&(t.uniforms.size.value*=r,t.uniforms.size.__seen=!0),t&&t.uniforms&&t.uniforms.linewidth&&void 0===t.uniforms.linewidth.__seen&&(t.uniforms.linewidth.value*=r,t.uniforms.linewidth.__seen=!0)}),e.scene.traverse(function(e){var t=e.material;t&&t.uniforms&&t.uniforms.size&&delete t.uniforms.size.__seen,t&&t.uniforms&&t.uniforms.linewidth&&delete t.uniforms.linewidth.__seen})}function p(e){if(n){var t=c;return function(e,t,r,n,i){var o,a,s,l,u=e.height,c=e.width,h=e.getContext("2d").getImageData(0,0,c,u).data;for(s=!1,a=0;a<u;a++){for(o=0;o<c;o++)if(h[l=4*(a*c+o)]!==t||h[l+1]!==r||h[l+2]!==n||h[l+3]!==i){s=!0;break}if(s)break}var p=a;for(s=!1,o=0;o<c;o++){for(a=0;a<u;a++)if(h[l=4*(a*c+o)]!==t||h[l+1]!==r||h[l+2]!==n||h[l+3]!==i){s=!0;break}if(s)break}var d=o;for(s=!1,a=u-1;a>=0;a--){for(o=c-1;o>=0;o--)if(h[l=4*(a*c+o)]!==t||h[l+1]!==r||h[l+2]!==n||h[l+3]!==i){s=!0;break}if(s)break}var f=a;for(s=!1,o=c-1;o>=0;o--){for(a=u-1;a>=0;a--)if(h[l=4*(a*c+o)]!==t||h[l+1]!==r||h[l+2]!==n||h[l+3]!==i){s=!0;break}if(s)break}var m=o,g=document.createElement("canvas");return g.width=m-d,g.height=f-p,g.getContext("2d").drawImage(e,d,p,g.width,g.height,0,0,g.width,g.height),g}(e,a?0:255*t.r,a?0:255*t.g,a?0:255*t.b,a?0:255)}return e}function d(e,r,n){"function"==typeof t.onProgress&&t.onProgress(e,r,n)}return new Promise(function(t,r){var n=new lu(s,l,e,{factor:i,antialias:o,onProgress:d,onFinish:function(i,o){p(n.canvas).toBlob(function(n){s.setClearAlpha(u),h(!0),e.requestRender(),d(o,o,!0),n?t(n):r("error creating image")},"image/png")}});s.setClearAlpha(a?0:1),h(),n.renderAsync()})}var Au=new ft,Eu=new pt,Pu=new pt;var Ru=new ht,Iu=new pt,Nu=new pt;function Du(e,t,r){var n=e.createShader(r);return e.shaderSource(n,t),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.log("error compiling shader "+n+": "+e.getShaderInfoLog(n)),e.deleteShader(n),null)}function ku(e,t){var r=e.getExtension(t);return r||console.log("extension '"+t+"' not available"),r}var Ou="\nattribute vec4 a_position;\n\nvoid main() {\n  gl_Position = a_position;\n}",Fu="\nprecision mediump float;\nuniform vec4 u_color;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;\n}",Lu=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function Uu(e){var t=document.createElement("canvas");t.width=16,t.height=16,t.style.width="16px",t.style.height="16px";var r=t.getContext("webgl")||t.getContext("experimental-webgl");if(!r)return console.log("error creating webgl context for "+e),!1;ku(r,"OES_texture_float"),ku(r,"OES_texture_half_float"),ku(r,"WEBGL_color_buffer_float");var n=Du(r,Ou,r.VERTEX_SHADER),i=Du(r,Fu,r.FRAGMENT_SHADER);if(!n||!i)return!1;var o=function(e,t,r,n){var i=e.createProgram();return t.forEach(function(t){return e.attachShader(i,t)}),r&&r.forEach(function(t,r){e.bindAttribLocation(i,n?n[r]:r,t)}),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)?i:(console.log("error linking program: "+e.getProgramInfoLog(i)),e.deleteProgram(i),null)}(r,[n,i]);r.useProgram(o);var a=r.getAttribLocation(o,"a_position"),s=r.getUniformLocation(o,"u_color");if(!s)return console.log("error getting 'u_color' uniform location"),!1;var l=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,l),r.bufferData(r.ARRAY_BUFFER,Lu,r.STATIC_DRAW),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0);var u=r.createTexture(),c=new Uint8Array([255,255,255,255]);r.bindTexture(r.TEXTURE_2D,u),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,c);var h=r.createTexture();r.bindTexture(r.TEXTURE_2D,h),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,e,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST);var p=r.createFramebuffer();if(r.bindFramebuffer(r.FRAMEBUFFER,p),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,h,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)return console.log("error creating framebuffer for "+e),!1;r.bindTexture(r.TEXTURE_2D,u),r.uniform4fv(s,[0,10,20,1]),r.drawArrays(r.TRIANGLES,0,6),r.bindTexture(r.TEXTURE_2D,h),r.bindFramebuffer(r.FRAMEBUFFER,null),r.clearColor(1,0,0,1),r.clear(r.COLOR_BUFFER_BIT),r.uniform4fv(s,[0,.1,.05,1]),r.drawArrays(r.TRIANGLES,0,6);var d=new Uint8Array(4);if(r.readPixels(0,0,1,1,r.RGBA,r.UNSIGNED_BYTE,d),0!==d[0]||d[1]<248||d[2]<248||d[3]<254)return console.log("not able to actually render to "+e+" texture"),!1;if(e===r.FLOAT){r.bindFramebuffer(r.FRAMEBUFFER,p);var f=new Float32Array(4);r.readPixels(0,0,1,1,r.RGBA,r.FLOAT,f);var m=r.getError();if(m)return console.log("error reading pixels as float: '"+function(e,t){switch(t){case e.NO_ERROR:return"no error";case e.INVALID_ENUM:return"invalid enum";case e.INVALID_VALUE:return"invalid value";case e.INVALID_OPERATION:return"invalid operation";case e.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case e.OUT_OF_MEMORY:return"out of memory";case e.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"}(r,m)+"'"),!1}return!0}var Vu=new Float32Array(4),Bu=new Uint8Array(4),zu=new pt;function ju(e,t,r,n,i){var o=i.uniforms,a=[];if(o.objectId&&(o.objectId.value=fl?this.id:this.id/255,a.push("objectId")),(o.modelViewMatrixInverse||o.modelViewMatrixInverseTranspose||o.modelViewProjectionMatrix||o.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,this.matrixWorld),o.modelViewMatrixInverse&&(o.modelViewMatrixInverse.value.getInverse(this.modelViewMatrix),a.push("modelViewMatrixInverse")),o.modelViewMatrixInverseTranspose&&(o.modelViewMatrixInverse?o.modelViewMatrixInverseTranspose.value.copy(o.modelViewMatrixInverse.value).transpose():o.modelViewMatrixInverseTranspose.value.getInverse(this.modelViewMatrix).transpose(),a.push("modelViewMatrixInverseTranspose")),o.modelViewProjectionMatrix&&(r.updateProjectionMatrix(),o.modelViewProjectionMatrix.value.multiplyMatrices(r.projectionMatrix,this.modelViewMatrix),a.push("modelViewProjectionMatrix")),o.modelViewProjectionMatrixInverse&&(o.modelViewProjectionMatrix?(zu.copy(o.modelViewProjectionMatrix.value),o.modelViewProjectionMatrixInverse.value.getInverse(zu)):(r.updateProjectionMatrix(),zu.multiplyMatrices(r.projectionMatrix,this.modelViewMatrix),o.modelViewProjectionMatrixInverse.value.getInverse(zu)),a.push("modelViewProjectionMatrixInverse")),a.length){var s=e.properties.get(i);if(s.program){var l=e.getContext(),u=s.program;l.useProgram(u.program);var c=u.getUniforms();a.forEach(function(e){c.setValue(l,e,o[e].value)})}}}var Hu=function(e){if(this.boundingBox=new _r,this.boundingBoxSize=new ft,this.boundingBoxLength=0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}},this.distVector=new ft,this.signals={ticked:new As},"string"==typeof e){var t=document.getElementById(e);this.container=null===t?document.createElement("div"):t}else e instanceof HTMLElement?this.container=e:this.container=document.createElement("div");if(this.container===document.body)this.width=window.innerWidth||1,this.height=window.innerHeight||1;else{var r=this.container.getBoundingClientRect();this.width=r.width||1,this.height=r.height||1}this._initParams(),this._initStats(),this._initCamera(),this._initScene(),!1!==this._initRenderer()?(this._initHelper(),this.setBackground(),this.setFog(),this.animate=this.animate.bind(this)):gl.error("Viewer: could not initialize renderer")};Hu.prototype._initParams=function(){this.parameters={fogColor:new ur(0),fogNear:50,fogFar:100,backgroundColor:new ur(0),cameraType:"perspective",cameraFov:40,cameraZ:-80,clipNear:0,clipFar:100,clipDist:10,lightColor:new ur(14540253),lightIntensity:1,ambientColor:new ur(14540253),ambientIntensity:.2,sampleLevel:0}},Hu.prototype._initCamera=function(){var e=new ft(0,0,0),t=this.width,r=this.height;this.perspectiveCamera=new Cn(this.parameters.cameraFov,t/r),this.perspectiveCamera.position.z=this.parameters.cameraZ,this.perspectiveCamera.lookAt(e),this.orthographicCamera=new Dr(t/-2,t/2,r/2,r/-2),this.orthographicCamera.position.z=this.parameters.cameraZ,this.orthographicCamera.lookAt(e),"orthographic"===this.parameters.cameraType?this.camera=this.orthographicCamera:this.camera=this.perspectiveCamera,this.camera.updateProjectionMatrix()},Hu.prototype._initStats=function(){this.stats=new Jl},Hu.prototype._initScene=function(){this.scene||(this.scene=new Pn,this.scene.name="scene"),this.rotationGroup=new Hn,this.rotationGroup.name="rotationGroup",this.scene.add(this.rotationGroup),this.translationGroup=new Hn,this.translationGroup.name="translationGroup",this.rotationGroup.add(this.translationGroup),this.modelGroup=new Hn,this.modelGroup.name="modelGroup",this.translationGroup.add(this.modelGroup),this.pickingGroup=new Hn,this.pickingGroup.name="pickingGroup",this.translationGroup.add(this.pickingGroup),this.backgroundGroup=new Hn,this.backgroundGroup.name="backgroundGroup",this.translationGroup.add(this.backgroundGroup),this.helperGroup=new Hn,this.helperGroup.name="helperGroup",this.translationGroup.add(this.helperGroup),this.scene.fog=new En(this.parameters.fogColor.getHex()),this.spotLight=new eo(this.parameters.lightColor.getHex(),this.parameters.lightIntensity),this.scene.add(this.spotLight),this.ambientLight=new io(this.parameters.ambientColor.getHex(),this.parameters.ambientIntensity),this.scene.add(this.ambientLight)},Hu.prototype._initRenderer=function(){var e=window.devicePixelRatio,t=this.width,r=this.height;try{this.renderer=new Tn({preserveDrawingBuffer:!0,alpha:!0,antialias:!0})}catch(e){return this.container.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;"><p style="padding:15px;text-align:center;">Your browser/graphics card does not seem to support <a target="_blank" href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>.<br/><br/>Find out how to get it <a target="_blank" href="http://get.webgl.org/">here</a>.</p></div>',!1}this.renderer.setPixelRatio(e),this.renderer.setSize(t,r),this.renderer.autoClear=!1,this.renderer.sortObjects=!0;var n=this.renderer.getContext();!function(e){ml=e}(this.renderer.extensions.get("EXT_frag_depth")),this.renderer.extensions.get("OES_element_index_uint"),function(e){fl=e}(this.renderer.extensions.get("OES_texture_float")&&this.renderer.extensions.get("WEBGL_color_buffer_float")||this.renderer.extensions.get("OES_texture_float")&&Uu(n.FLOAT)),this.container.appendChild(this.renderer.domElement);var i=t*e,o=r*e;this.renderer.extensions.get("OES_texture_float"),this.supportsHalfFloat=this.renderer.extensions.get("OES_texture_half_float")&&Uu(36193),this.renderer.extensions.get("WEBGL_color_buffer_float"),vl&&console.log(JSON.stringify({Browser:cl,OES_texture_float:!!this.renderer.extensions.get("OES_texture_float"),OES_texture_half_float:!!this.renderer.extensions.get("OES_texture_half_float"),WEBGL_color_buffer_float:!!this.renderer.extensions.get("WEBGL_color_buffer_float"),"testTextureSupport Float":Uu(n.FLOAT),"testTextureSupport HalfFloat":Uu(36193),"this.supportsHalfFloat":this.supportsHalfFloat,SupportsReadPixelsFloat:fl},null,2)),this.pickingTarget=new bt(i,o,{minFilter:ge,magFilter:ge,stencilBuffer:!1,format:Fe,type:fl?Ee:_e}),this.pickingTarget.texture.generateMipmaps=!1,this.renderer.clearTarget(this.pickingTarget,!0,!0,!0),this.renderer.setRenderTarget(null),this.sampleTarget=new bt(i,o,{minFilter:be,magFilter:be,format:Fe}),this.holdTarget=new bt(i,o,{minFilter:ge,magFilter:ge,format:Fe,type:_e}),this.compositeUniforms={tForeground:new aa(this.sampleTarget.texture),scale:new aa(1)},this.compositeMaterial=new rn({uniforms:this.compositeUniforms,vertexShader:tu("Quad.vert"),fragmentShader:tu("Quad.frag"),premultipliedAlpha:!0,transparent:!0,blending:S,depthTest:!1,depthWrite:!1}),this.compositeCamera=new Dr(-1,1,1,-1,0,1),this.compositeScene=new Pn,this.compositeScene.name="compositeScene",this.compositeScene.add(new sn(new Qr(2,2),this.compositeMaterial))},Hu.prototype._initHelper=function(){var e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),t=new Float32Array(24),r=new Yr;r.setIndex(new Lr(e,1)),r.addAttribute("position",new Lr(t,3));var n=new rn({uniforms:{uColor:{value:new ur("skyblue")}},vertexShader:tu("BasicLine.vert"),fragmentShader:tu("BasicLine.frag")});this.boundingBoxMesh=new Vn(r,n),this.helperGroup.add(this.boundingBoxMesh)},Hu.prototype.updateHelper=function(){var e=this.boundingBoxMesh.geometry.attributes.position,t=e.array,r=this.boundingBox,n=r.min,i=r.max;t[0]=i.x,t[1]=i.y,t[2]=i.z,t[3]=n.x,t[4]=i.y,t[5]=i.z,t[6]=n.x,t[7]=n.y,t[8]=i.z,t[9]=i.x,t[10]=n.y,t[11]=i.z,t[12]=i.x,t[13]=i.y,t[14]=n.z,t[15]=n.x,t[16]=i.y,t[17]=n.z,t[18]=n.x,t[19]=n.y,t[20]=n.z,t[21]=i.x,t[22]=n.y,t[23]=n.z,e.needsUpdate=!0,this.boundingBox.isEmpty()||this.boundingBoxMesh.geometry.computeBoundingSphere()},Hu.prototype.add=function(e,t){var r=this;t?t.forEach(function(t){return r.addBuffer(e,t)}):this.addBuffer(e),e.parameters.background?(this.backgroundGroup.add(e.group),this.backgroundGroup.add(e.wireframeGroup)):(this.modelGroup.add(e.group),this.modelGroup.add(e.wireframeGroup)),e.pickable&&this.pickingGroup.add(e.pickingGroup),vl&&this.updateHelper()},Hu.prototype.addBuffer=function(e,t){function r(n){n instanceof Hn?n.children.forEach(r):(n.userData.buffer=e,n.userData.instance=t,n.onBeforeRender=ju)}var n=e.getMesh();t&&n.applyMatrix(t.matrix),r(n),e.group.add(n);var i=e.getWireframeMesh();if(t&&(i.matrix.copy(n.matrix),i.position.copy(n.position),i.quaternion.copy(n.quaternion),i.scale.copy(n.scale)),r(i),e.wireframeGroup.add(i),e.pickable){var o=e.getPickingMesh();t&&(o.matrix.copy(n.matrix),o.position.copy(n.position),o.quaternion.copy(n.quaternion),o.scale.copy(n.scale)),r(o),e.pickingGroup.add(o)}t?this._updateBoundingBox(e.geometry,e.matrix,t.matrix):this._updateBoundingBox(e.geometry,e.matrix)},Hu.prototype.remove=function(e){this.translationGroup.children.forEach(function(t){t.remove(e.group),t.remove(e.wireframeGroup)}),e.pickable&&this.pickingGroup.remove(e.pickingGroup),this.updateBoundingBox(),vl&&this.updateHelper()},Hu.prototype._updateBoundingBox=function(e,t,r){var n=this.boundingBox;function i(e,t,r){e.boundingBox||e.computeBoundingBox();var i=e.boundingBox.clone();t&&i.applyMatrix4(t),r&&i.applyMatrix4(r),i.min.equals(i.max)&&i.expandByScalar(5),n.union(i)}function o(e){var t,r;void 0!==e.geometry&&(e.userData.buffer&&(t=e.userData.buffer.matrix),e.userData.instance&&(r=e.userData.instance.matrix),i(e.geometry,t,r))}e?i(e,t,r):(n.makeEmpty(),this.modelGroup.traverse(o),this.backgroundGroup.traverse(o)),n.getSize(this.boundingBoxSize),this.boundingBoxLength=this.boundingBoxSize.length()},Hu.prototype.updateBoundingBox=function(){this._updateBoundingBox(),vl&&this.updateHelper()},Hu.prototype.getPickingPixels=function(){var e=this.width,t=this.height,r=e*t*4,n=fl?new Float32Array(r):new Uint8Array(r);return this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,0,0,e,t,n),n},Hu.prototype.getImage=function(e){var t=this;return new Promise(function(r){if(e){var n=t,i=n.width,o=n.height,a=i*o*4,s=t.getPickingPixels();if(fl){for(var l=new Uint8Array(a),u=0;u<a;++u)l[u]=Math.round(255*s[u]);s=l}var c=document.createElement("canvas");c.width=i,c.height=o;var h=c.getContext("2d"),p=h.getImageData(0,0,i,o);p.data.set(s),h.putImageData(p,0,0),c.toBlob(r,"image/png")}else t.renderer.domElement.toBlob(r,"image/png")})},Hu.prototype.makeImage=function(e){return void 0===e&&(e={}),Tu(this,e)},Hu.prototype.setLight=function(e,t,r,n){var i=this.parameters;void 0!==e&&i.lightColor.set(e),void 0!==t&&(i.lightIntensity=t),void 0!==r&&i.ambientColor.set(r),void 0!==n&&(i.ambientIntensity=n),this.requestRender()},Hu.prototype.setFog=function(e,t,r){var n=this.parameters;void 0!==e&&n.fogColor.set(e),void 0!==t&&(n.fogNear=t),void 0!==r&&(n.fogFar=r),this.requestRender()},Hu.prototype.setBackground=function(e){var t=this.parameters;e&&t.backgroundColor.set(e),this.setFog(t.backgroundColor),this.renderer.setClearColor(t.backgroundColor,0),this.renderer.domElement.style.backgroundColor=t.backgroundColor.getStyle(),this.requestRender()},Hu.prototype.setSampling=function(e){void 0!==e&&(this.parameters.sampleLevel=e,this.sampleLevel=e),this.requestRender()},Hu.prototype.setCamera=function(e,t){var r=this.parameters;e&&(r.cameraType=e),t&&(r.cameraFov=t),"orthographic"===r.cameraType?this.camera!==this.orthographicCamera&&(this.camera=this.orthographicCamera,this.camera.position.copy(this.perspectiveCamera.position),this.camera.up.copy(this.perspectiveCamera.up),this.updateZoom()):this.camera!==this.perspectiveCamera&&(this.camera=this.perspectiveCamera,this.camera.position.copy(this.orthographicCamera.position),this.camera.up.copy(this.orthographicCamera.up)),this.perspectiveCamera.fov=r.cameraFov,this.camera.updateProjectionMatrix(),this.requestRender()},Hu.prototype.setClip=function(e,t,r){var n=this.parameters;void 0!==e&&(n.clipNear=e),void 0!==t&&(n.clipFar=t),void 0!==r&&(n.clipDist=r),this.requestRender()},Hu.prototype.setSize=function(e,t){this.width=e||1,this.height=t||1,this.perspectiveCamera.aspect=this.width/this.height,this.orthographicCamera.left=-this.width/2,this.orthographicCamera.right=this.width/2,this.orthographicCamera.top=this.height/2,this.orthographicCamera.bottom=-this.height/2,this.camera.updateProjectionMatrix();var r=window.devicePixelRatio;this.renderer.setPixelRatio(r),this.renderer.setSize(e,t);var n=this.width*r,i=this.height*r;this.pickingTarget.setSize(n,i),this.sampleTarget.setSize(n,i),this.holdTarget.setSize(n,i),this.requestRender()},Hu.prototype.handleResize=function(){if(this.container===document.body)this.setSize(window.innerWidth,window.innerHeight);else{var e=this.container.getBoundingClientRect();this.setSize(e.width,e.height)}},Hu.prototype.updateInfo=function(e){var t=this.info,r=t.memory,n=t.render;if(e)r.programs=0,r.geometries=0,r.textures=0,n.calls=0,n.vertices=0,n.faces=0,n.points=0;else{var i=this.renderer.info,o=i.memory,a=i.render;r.geometries=o.geometries,r.textures=o.textures,n.calls+=a.calls,n.vertices+=a.vertices,n.faces+=a.faces,n.points+=a.points}},Hu.prototype.animate=function(){if(this.signals.ticked.dispatch(this.stats),window.performance.now()-this.stats.startTime>500&&!this.isStill&&this.sampleLevel<3&&-1!==this.sampleLevel){var e=this.sampleLevel;this.sampleLevel=3,this.renderPending=!0,this.render(),this.isStill=!0,this.sampleLevel=e,vl&&gl.log("rendered still frame")}window.requestAnimationFrame(this.animate)},Hu.prototype.pick=function(e,t){var r,n,i;e*=window.devicePixelRatio,t*=window.devicePixelRatio;var o=fl?Vu:Bu;this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,e,t,1,1,o),r=fl?Math.round(255*o[0])<<16&16711680|Math.round(255*o[1])<<8&65280|255&Math.round(255*o[2]):o[0]<<16|o[1]<<8|o[2];var a=Math.round(o[3]),s=this.pickingGroup.getObjectById(a);return s&&(n=s.userData.instance,i=s.userData.buffer.picking),{pid:r,instance:n,picker:i}},Hu.prototype.requestRender=function(){var e=this;this.renderPending||(window.performance.now()-this.stats.startTime>22&&(this.stats.begin(),this.isStill=!1),this.renderPending=!0,window.requestAnimationFrame(function(){e.render(),e.stats.update()}))},Hu.prototype.updateZoom=function(){var e=fs(this.perspectiveCamera.fov),t=2*Math.tan(e/2)*-this.camera.position.z;this.orthographicCamera.zoom=this.height/t},Hu.prototype.__updateClipping=function(){var e=this.parameters;this.cDist=this.distVector.copy(this.camera.position).length(),this.cDist||(this.camera.position.set(0,0,e.cameraZ),this.cDist=Math.abs(e.cameraZ)),this.bRadius=Math.max(10,.5*this.boundingBoxLength),this.bRadius+=this.boundingBox.getCenter(this.distVector).length(),(this.bRadius===1/0||this.bRadius===-1/0||isNaN(this.bRadius))&&(this.bRadius=50);var t=(50-e.clipNear)/50,r=-(50-e.clipFar)/50;this.camera.near=this.cDist-this.bRadius*t,this.camera.far=this.cDist+this.bRadius*r;var n=(50-e.fogNear)/50,i=-(50-e.fogFar)/50,o=this.scene.fog;o.color.set(e.fogColor),o.near=this.cDist-this.bRadius*n,o.far=this.cDist+this.bRadius*i,"PerspectiveCamera"===this.camera.type?(this.camera.near=Math.max(.1,e.clipDist,this.camera.near),this.camera.far=Math.max(1,this.camera.far),o.near=Math.max(.1,o.near),o.far=Math.max(1,o.far)):"OrthographicCamera"===this.camera.type&&0===e.clipNear&&e.clipDist>0&&this.cDist+this.camera.zoom>2*-e.clipDist&&(this.camera.near+=this.camera.zoom+e.clipDist)},Hu.prototype.__updateCamera=function(){this.camera.updateMatrix(),this.camera.updateMatrixWorld(!0),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.camera.updateProjectionMatrix(),function(e,t,r,n,i){var o=r.getSize(),a=o.width,s=o.height,l=s,u=r.getPixelRatio(),c="OrthographicCamera"===t.type;Ru.set(a,s),Iu.getInverse(t.projectionMatrix),Nu.copy(t.projectionMatrix).transpose(),e.traverse(function(e){var t=e.material;if(t){var r=t.uniforms;if(r){if(t.clipNear){var o=(50-t.clipNear)/50,a=n-i*o;r.clipNear.value=a}r.canvasHeight&&(r.canvasHeight.value=l),r.resolution&&r.resolution.value.copy(Ru),r.pixelRatio&&(r.pixelRatio.value=u),r.projectionMatrixInverse&&r.projectionMatrixInverse.value.copy(Iu),r.projectionMatrixTranspose&&r.projectionMatrixTranspose.value.copy(Nu),r.ortho&&(r.ortho.value=c)}}})}(this.scene,this.camera,this.renderer,this.cDist,this.bRadius),function(e,t){e.traverseVisible(function(e){if(e instanceof jn&&e.userData.buffer.parameters.sortParticles){var r=e.geometry.attributes,n=r.position.count;if(0!==n){var i,o,a,s,l,u,c;Eu.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld),Pu.multiplyMatrices(t.projectionMatrix,Eu),e.userData.sortData?(i=e.userData.sortData,a=i.__zArray,o=i.__sortArray,s=i.__cmpFn):(a=new Float32Array(n),o=new Uint32Array(n),i={__zArray:a,__sortArray:o,__cmpFn:s=function(e,t){var r=a[e],n=a[t];return r>n?1:r<n?-1:0}},e.userData.sortData=i);for(var h=0;h<n;++h)Au.fromArray(r.position.array,3*h),Au.applyMatrix4(Pu),a[h]=-Au.z,o[h]=h;for(var p in function(e,t,r,n){void 0===r&&(r=0),t=t||function(e,t){return e>t?1:e<t?-1:0};var i,o,a,s=[],l=-1,u=r,c=n=(n||e.length)-1;function h(t,r){var n=e[t];e[t]=e[r],e[r]=n}for(;;)if(c-u<=25){for(a=u+1;a<=c;++a){for(i=e[a],o=a-1;o>=u&&t(e[o],i)>0;)e[o+1]=e[o],--o;e[o+1]=i}if(-1===l)break;c=s[l--],u=s[l--]}else{for(a=c,h(u+c>>1,o=u+1),t(e[u],e[c])>0&&h(u,c),t(e[o],e[c])>0&&h(o,c),t(e[u],e[o])>0&&h(u,o),i=e[o];;){do{o++}while(t(e[o],i)<0);do{a--}while(t(e[a],i)>0);if(a<o)break;h(o,a)}e[u+1]=e[a],e[a]=i,c-o+1>=a-u?(s[++l]=o,s[++l]=c,c=a-1):(s[++l]=u,s[++l]=a-1,u=o)}}(o,s),r){var d=r[p],f=d.array,m=d.itemSize;i[p]||(i[p]=new Float32Array(m*n)),c=i[p],i[p]=f;for(var g=0;g<n;++g){l=o[g];for(var v=0;v<m;++v)u=l*m+v,c[g*m+v]=f[u]}r[p].array=c,r[p].needsUpdate=!0}}}})}(this.scene,this.camera)},Hu.prototype.__setVisibility=function(e,t,r,n){this.modelGroup.visible=e,this.pickingGroup.visible=t,this.backgroundGroup.visible=r,this.helperGroup.visible=n},Hu.prototype.__updateLights=function(){this.distVector.copy(this.camera.position).setLength(100*this.boundingBoxLength),this.spotLight.position.copy(this.camera.position).add(this.distVector),this.spotLight.color.set(this.parameters.lightColor),this.spotLight.intensity=this.parameters.lightIntensity,this.ambientLight.color.set(this.parameters.ambientColor),this.ambientLight.intensity=this.parameters.ambientIntensity},Hu.prototype.__renderPickingGroup=function(){this.renderer.clearTarget(this.pickingTarget,!0,!0,!0),this.__setVisibility(!1,!0,!1,!1),this.renderer.render(this.scene,this.camera,this.pickingTarget),this.updateInfo(),this.renderer.setRenderTarget(null)},Hu.prototype.__renderModelGroup=function(e){e?this.renderer.clearTarget(e,!0,!0,!0):this.renderer.clear(),this.__setVisibility(!1,!1,!0,!1),this.renderer.render(this.scene,this.camera,e),e?this.renderer.clearTarget(e,!1,!0,!1):this.renderer.clearDepth(),this.updateInfo(),this.__setVisibility(!0,!1,!1,vl),this.renderer.render(this.scene,this.camera,e),this.updateInfo()},Hu.prototype.__renderSuperSample=function(){var e=su[Math.max(0,Math.min(this.sampleLevel,5))],t=1/e.length;this.compositeUniforms.tForeground.value=this.sampleTarget.texture;for(var r=this.sampleTarget.width,n=this.sampleTarget.height,i=0;i<e.length;++i){var o=e[i];this.camera.setViewOffset(r,n,o[0],o[1],r,n),this.__updateCamera();var a=t;a+=1/32*((i+.5)/e.length-.5),this.compositeUniforms.scale.value=a,this.__renderModelGroup(this.sampleTarget),this.renderer.render(this.compositeScene,this.compositeCamera,this.holdTarget,0===i)}this.compositeUniforms.scale.value=1,this.compositeUniforms.tForeground.value=this.holdTarget.texture,this.camera.clearViewOffset(),this.renderer.render(this.compositeScene,this.compositeCamera,null,!0)},Hu.prototype.render=function(e){void 0===e&&(e=!1),this.rendering?gl.warn("'tried to call 'render' from within 'render'"):(this.rendering=!0,this.__updateClipping(),this.__updateCamera(),this.__updateLights(),this.updateInfo(!0),e?this.lastRenderedPicking||this.__renderPickingGroup():this.sampleLevel>0?this.__renderSuperSample():this.__renderModelGroup(),this.lastRenderedPicking=e,this.rendering=!1,this.renderPending=!1)},Hu.prototype.clear=function(){gl.log("scene cleared"),this.scene.remove(this.rotationGroup),this._initScene(),this.renderer.clear()};var $u=1,Gu=2,Wu=3;function qu(e){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(t*t+r*r)}var Xu=function(e,t){void 0===t&&(t={}),this.domElement=e,this.signals={moved:new As,scrolled:new As,dragged:new As,dropped:new As,clicked:new As,hovered:new As,doubleClicked:new As},this.position=new ht,this.prevPosition=new ht,this.down=new ht,this.canvasPosition=new ht,this.prevClickCP=new ht,this.moving=!1,this.hovering=!0,this.scrolled=!1,this.lastMoved=1/0,this.which=0,this.buttons=0,this.pressed=!1,this.altKey=!1,this.ctrlKey=!1,this.metaKey=!1,this.shiftKey=!1,this.domElement.style.touchAction="none",this.hoverTimeout=Ha(t.hoverTimeout,50),this.handleScroll=Ha(t.handleScroll,!0),this.doubleClickSpeed=Ha(t.doubleClickSpeed,500),this._listen=this._listen.bind(this),this._onMousewheel=this._onMousewheel.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onContextmenu=this._onContextmenu.bind(this),this._onTouchstart=this._onTouchstart.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._listen(),document.addEventListener("mousewheel",this._onMousewheel),document.addEventListener("wheel",this._onMousewheel),document.addEventListener("MozMousePixelScroll",this._onMousewheel),document.addEventListener("mousemove",this._onMousemove),document.addEventListener("mousedown",this._onMousedown),document.addEventListener("mouseup",this._onMouseup),document.addEventListener("contextmenu",this._onContextmenu),document.addEventListener("touchstart",this._onTouchstart),document.addEventListener("touchend",this._onTouchend),document.addEventListener("touchmove",this._onTouchmove)},Ku={key:{configurable:!0}};Ku.key.get=function(){var e=0;return this.altKey&&(e+=1),this.ctrlKey&&(e+=2),this.metaKey&&(e+=4),this.shiftKey&&(e+=8),e},Xu.prototype.setParameters=function(e){void 0===e&&(e={}),this.hoverTimeout=Ha(e.hoverTimeout,this.hoverTimeout)},Xu.prototype._listen=function(){var e=window.performance.now(),t=this.canvasPosition;this.doubleClickPending&&e-this.lastClicked>this.doubleClickSpeed&&(this.doubleClickPending=!1),e-this.lastMoved>this.hoverTimeout&&(this.moving=!1),(this.scrolled||!this.moving&&!this.hovering)&&(this.scrolled=!1,-1!==this.hoverTimeout&&this.overElement&&(this.hovering=!0,this.signals.hovered.dispatch(t.x,t.y))),window.requestAnimationFrame(this._listen)},Xu.prototype._onMousewheel=function(e){var t=this;if(e.target===this.domElement&&this.handleScroll){e.preventDefault(),this._setKeys(e);var r=0;r=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail/3:-e.deltaY/(e.deltaMode?.33:30),this.signals.scrolled.dispatch(r),setTimeout(function(){t.scrolled=!0},this.hoverTimeout)}},Xu.prototype._onMousemove=function(e){e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,this._setKeys(e),this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.clientX,e.clientY),this._setCanvasPosition(e);var t=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(t,r),this.pressed&&this.signals.dragged.dispatch(t,r)},Xu.prototype._onMousedown=function(e){e.target===this.domElement&&(e.preventDefault(),this._setKeys(e),this.moving=!1,this.hovering=!1,this.down.set(e.clientX,e.clientY),this.position.set(e.clientX,e.clientY),this.which=e.which,this.buttons=function(e){if("object"==typeof e){if("buttons"in e)return e.buttons;if("which"in e){var t=e.which;if(2===t)return 4;if(3===t)return 2;if(t>0)return 1<<t-1}else if("button"in e){var r=e.button;if(1===r)return 4;if(2===r)return 2;if(r>=0)return 1<<r}}return 0}(e),this.pressed=!0,this._setCanvasPosition(e))},Xu.prototype._onMouseup=function(e){e.target===this.domElement&&e.preventDefault(),this._setKeys(e);var t=this.canvasPosition;this._distance()<4&&(this.lastClicked=window.performance.now(),this.doubleClickPending&&this.prevClickCP.distanceTo(t)<4&&(this.signals.doubleClicked.dispatch(t.x,t.y),this.doubleClickPending=!1),this.signals.clicked.dispatch(t.x,t.y),this.doubleClickPending=!0,this.prevClickCP.copy(t)),this.which=void 0,this.buttons=void 0,this.pressed=void 0},Xu.prototype._onContextmenu=function(e){e.target===this.domElement&&e.preventDefault()},Xu.prototype._onTouchstart=function(e){if(e.target===this.domElement)switch(e.preventDefault(),this.pressed=!0,e.touches.length){case 1:this.moving=!1,this.hovering=!1,this.down.set(e.touches[0].pageX,e.touches[0].pageY),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);break;case 2:this.down.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.lastTouchDistance=qu(e)}},Xu.prototype._onTouchend=function(e){e.target===this.domElement&&e.preventDefault(),this.which=void 0,this.buttons=void 0,this.pressed=void 0},Xu.prototype._onTouchmove=function(e){switch(e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,e.touches.length){case 1:this._setKeys(e),this.which=$u,this.buttons=1,this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);var t=this.prevPosition.x-this.position.x,r=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(t,r),this.pressed&&this.signals.dragged.dispatch(t,r);break;case 2:var n=qu(e),i=n-this.lastTouchDistance;if(this.lastTouchDistance=n,this.prevPosition.copy(this.position),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),Math.abs(i)>2&&this.handleScroll&&this.position.distanceTo(this.prevPosition)<2)this.which=0,this.buttons=0,this.signals.scrolled.dispatch(i/2);else{this.which=Wu,this.buttons=2;var o=this.prevPosition.x-this.position.x,a=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(o,a),this.pressed&&this.signals.dragged.dispatch(o,a)}}},Xu.prototype._distance=function(){return this.position.distanceTo(this.down)},Xu.prototype._setCanvasPosition=function(e){var t,r,n=this.domElement.getBoundingClientRect();"offsetX"in e&&"offsetY"in e?(t=e.offsetX,r=e.offsetY):(t=e.clientX-n.left,r=e.clientY-n.top),this.canvasPosition.set(t,n.height-r)},Xu.prototype._setKeys=function(e){this.altKey=e.altKey,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey},Xu.prototype.dispose=function(){document.removeEventListener("mousewheel",this._onMousewheel),document.removeEventListener("wheel",this._onMousewheel),document.removeEventListener("MozMousePixelScroll",this._onMousewheel),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mousedown",this._onMousedown),document.removeEventListener("mouseup",this._onMouseup),document.removeEventListener("contextmenu",this._onContextmenu),document.removeEventListener("touchstart",this._onTouchstart),document.removeEventListener("touchend",this._onTouchend),document.removeEventListener("touchmove",this._onTouchmove)},Object.defineProperties(Xu.prototype,Ku);var Yu=new pt,Zu=new pt,Ju=new pt,Qu=new ft,ec=new dt,tc=new pt,rc=new ft,nc=new ft,ic=function(e,t){void 0===t&&(t={}),this.stage=e,this.rotateSpeed=Ha(t.rotateSpeed,2),this.zoomSpeed=Ha(t.zoomSpeed,1.2),this.panSpeed=Ha(t.panSpeed,1),this.viewer=e.viewer,this.mouse=e.mouseObserver,this.controls=e.viewerControls},oc={component:{configurable:!0},atom:{configurable:!0}};oc.component.get=function(){return this.stage.transformComponent},oc.atom.get=function(){return this.stage.transformAtom},ic.prototype._setPanVector=function(e,t,r){var n;void 0===r&&(r=0);var i=this.viewer.camera;if(r=-r,r+=i.position.z,i instanceof Dr)n=1/i.zoom;else{var o=fs(i.fov);n=-2*r*Math.tan(o/2)/this.viewer.height}rc.set(e,t,0),rc.multiplyScalar(this.panSpeed*n)},ic.prototype._getRotateXY=function(e,t){return[this.rotateSpeed*-e*.01,this.rotateSpeed*t*.01]},ic.prototype._transformPanVector=function(){this.component&&(tc.extractRotation(this.component.transform),tc.premultiply(this.viewer.rotationGroup.matrix),tc.getInverse(tc),rc.applyMatrix4(tc))},ic.prototype.zoom=function(e){this.controls.zoom(this.zoomSpeed*e*.02)},ic.prototype.pan=function(e,t){this._setPanVector(e,t),tc.getInverse(this.viewer.rotationGroup.matrix),rc.applyMatrix4(tc),this.controls.translate(rc)},ic.prototype.panComponent=function(e,t){this.component&&(this._setPanVector(e,t),this._transformPanVector(),this.component.position.add(rc),this.component.updateMatrix())},ic.prototype.panAtom=function(e,t){this.atom&&this.component&&(this.atom.positionToVector3(nc),nc.add(this.viewer.translationGroup.position),nc.applyMatrix4(this.viewer.rotationGroup.matrix),this._setPanVector(e,t,nc.z),this._transformPanVector(),this.atom.positionAdd(rc),this.component.updateRepresentations({position:!0}))},ic.prototype.rotate=function(e,t){var r=this._getRotateXY(e,t),n=r[0],i=r[1];Yu.makeRotationX(i),Zu.makeRotationY(n),Yu.multiply(Zu),this.controls.applyMatrix(Yu)},ic.prototype.rotateComponent=function(e,t){if(this.component){var r=this._getRotateXY(e,t),n=r[0],i=r[1];Ju.extractRotation(this.component.transform),Ju.premultiply(this.viewer.rotationGroup.matrix),Ju.getInverse(Ju),Qu.set(1,0,0),Qu.applyMatrix4(Ju),Yu.makeRotationAxis(Qu,i),Qu.set(0,1,0),Qu.applyMatrix4(Ju),Zu.makeRotationAxis(Qu,n),Yu.multiply(Zu),ec.setFromRotationMatrix(Yu),this.component.quaternion.premultiply(ec),this.component.updateMatrix()}},Object.defineProperties(ic.prototype,oc);var ac=function(e,t){this.stage=t,this.pid=e.pid,this.picker=e.picker,this.instance=e.instance,this.stage=t,this.controls=t.viewerControls,this.mouse=t.mouseObserver},sc={type:{configurable:!0},altKey:{configurable:!0},ctrlKey:{configurable:!0},metaKey:{configurable:!0},shiftKey:{configurable:!0},canvasPosition:{configurable:!0},component:{configurable:!0},object:{configurable:!0},position:{configurable:!0},closestBondAtom:{configurable:!0},arrow:{configurable:!0},atom:{configurable:!0},axes:{configurable:!0},bond:{configurable:!0},box:{configurable:!0},cone:{configurable:!0},clash:{configurable:!0},contact:{configurable:!0},cylinder:{configurable:!0},distance:{configurable:!0},ellipsoid:{configurable:!0},octahedron:{configurable:!0},mesh:{configurable:!0},slice:{configurable:!0},sphere:{configurable:!0},tetrahedron:{configurable:!0},torus:{configurable:!0},surface:{configurable:!0},unitcell:{configurable:!0},unknown:{configurable:!0},volume:{configurable:!0}};sc.type.get=function(){return this.picker.type},sc.altKey.get=function(){return this.mouse.altKey},sc.ctrlKey.get=function(){return this.mouse.ctrlKey},sc.metaKey.get=function(){return this.mouse.metaKey},sc.shiftKey.get=function(){return this.mouse.shiftKey},sc.canvasPosition.get=function(){return this.mouse.canvasPosition},sc.component.get=function(){return this.stage.getComponentsByObject(this.picker.data).list[0]},sc.object.get=function(){return this.picker.getObject(this.pid)},sc.position.get=function(){return this.picker.getPosition(this.pid,this.instance,this.component)},sc.closestBondAtom.get=function(){if("bond"===this.type&&this.bond){var e=this.bond,t=this.controls;return function(e,t,r){return e.distanceTo(t)<e.distanceTo(r)}(this.canvasPosition,t.getPositionOnCanvas(e.atom1),t.getPositionOnCanvas(e.atom2))?e.atom1:e.atom2}},sc.arrow.get=function(){return this._objectIfType("arrow")},sc.atom.get=function(){return this._objectIfType("atom")},sc.axes.get=function(){return this._objectIfType("axes")},sc.bond.get=function(){return this._objectIfType("bond")},sc.box.get=function(){return this._objectIfType("box")},sc.cone.get=function(){return this._objectIfType("cone")},sc.clash.get=function(){return this._objectIfType("clash")},sc.contact.get=function(){return this._objectIfType("contact")},sc.cylinder.get=function(){return this._objectIfType("cylinder")},sc.distance.get=function(){return this._objectIfType("distance")},sc.ellipsoid.get=function(){return this._objectIfType("ellipsoid")},sc.octahedron.get=function(){return this._objectIfType("octahedron")},sc.mesh.get=function(){return this._objectIfType("mesh")},sc.slice.get=function(){return this._objectIfType("slice")},sc.sphere.get=function(){return this._objectIfType("sphere")},sc.tetrahedron.get=function(){return this._objectIfType("tetrahedron")},sc.torus.get=function(){return this._objectIfType("torus")},sc.surface.get=function(){return this._objectIfType("surface")},sc.unitcell.get=function(){return this._objectIfType("unitcell")},sc.unknown.get=function(){return this._objectIfType("unknown")},sc.volume.get=function(){return this._objectIfType("volume")},ac.prototype._objectIfType=function(e){return this.type===e?this.object:void 0},ac.prototype.getLabel=function(){var e="nothing";return this.arrow?e="arrow: "+(this.arrow.name||this.pid)+" ("+this.arrow.shape.name+")":this.atom?e="atom: "+this.atom.qualifiedName()+" ("+this.atom.structure.name+")":this.axes?e="axes":this.bond?e="bond: "+this.bond.atom1.qualifiedName()+" - "+this.bond.atom2.qualifiedName()+" ("+this.bond.structure.name+")":this.box?e="box: "+(this.box.name||this.pid)+" ("+this.box.shape.name+")":this.cone?e="cone: "+(this.cone.name||this.pid)+" ("+this.cone.shape.name+")":this.clash?e="clash: "+this.clash.clash.sele1+" - "+this.clash.clash.sele2:this.contact?e=this.contact.type+": "+this.contact.atom1.qualifiedName()+" - "+this.contact.atom2.qualifiedName()+" ("+this.contact.atom1.structure.name+")":this.cylinder?e="cylinder: "+(this.cylinder.name||this.pid)+" ("+this.cylinder.shape.name+")":this.distance?e="distance: "+this.distance.atom1.qualifiedName()+" - "+this.distance.atom2.qualifiedName()+" ("+this.distance.structure.name+")":this.ellipsoid?e="ellipsoid: "+(this.ellipsoid.name||this.pid)+" ("+this.ellipsoid.shape.name+")":this.octahedron?e="octahedron: "+(this.octahedron.name||this.pid)+" ("+this.octahedron.shape.name+")":this.mesh?e="mesh: "+(this.mesh.name||this.mesh.serial)+" ("+this.mesh.shape.name+")":this.slice?e="slice: "+this.slice.value.toPrecision(3)+" ("+this.slice.volume.name+")":this.sphere?e="sphere: "+(this.sphere.name||this.pid)+" ("+this.sphere.shape.name+")":this.surface?e="surface: "+this.surface.surface.name:this.tetrahedron?e="tetrahedron: "+(this.tetrahedron.name||this.pid)+" ("+this.tetrahedron.shape.name+")":this.torus?e="torus: "+(this.torus.name||this.pid)+" ("+this.torus.shape.name+")":this.unitcell?e="unitcell: "+this.unitcell.unitcell.spacegroup+" ("+this.unitcell.structure.name+")":this.unknown?e="unknown":this.volume&&(e="volume: "+this.volume.value.toPrecision(3)+" ("+this.volume.volume.name+")"),e},Object.defineProperties(ac.prototype,sc);var lc=function(e){this.stage=e,this.viewer=e.viewer};lc.prototype.pick=function(e,t){var r=this.viewer.pick(e,t);if(r.picker&&"ignore"!==r.picker.type&&void 0!==r.pid){var n=r.picker.array;if(!(n&&r.pid>=n.length))return new ac(r,this.stage);console.error("pid >= picker.array.length")}};var uc=new dt,cc=new ft,hc=new ft,pc=new ft,dc=new ft,fc=new pt,mc=new ft,gc=new pt,vc=function(e){this.stage=e,this.signals={changed:new As},this.viewer=e.viewer},yc={position:{configurable:!0},rotation:{configurable:!0}};yc.position.get=function(){return this.viewer.translationGroup.position},yc.rotation.get=function(){return this.viewer.rotationGroup.quaternion},vc.prototype.changed=function(){this.viewer.requestRender(),this.signals.changed.dispatch()},vc.prototype.getPositionOnCanvas=function(e,t){var r=function(e){return as(e,ht)}(t),n=this.viewer;return pc.copy(e).add(n.translationGroup.position).applyMatrix4(n.rotationGroup.matrix).project(n.camera),r.set((pc.x+1)*n.width/2,(pc.y+1)*n.height/2)},vc.prototype.getOrientation=function(e){var t=ls(e);t.copy(this.viewer.rotationGroup.matrix);var r=-this.viewer.camera.position.z;return t.scale(dc.set(r,r,r)),t.setPosition(this.viewer.translationGroup.position),t},vc.prototype.orient=function(e){ls(e).decompose(cc,uc,hc);var t=this.viewer;t.rotationGroup.setRotationFromQuaternion(uc),t.translationGroup.position.copy(cc),t.camera.position.z=-hc.z,t.updateZoom(),this.changed()},vc.prototype.translate=function(e){this.viewer.translationGroup.position.add(ss(e)),this.changed()},vc.prototype.center=function(e){this.viewer.translationGroup.position.copy(ss(e)).negate(),this.changed()},vc.prototype.zoom=function(e){this.distance(this.viewer.camera.position.z*(1-e))},vc.prototype.distance=function(e){this.viewer.camera.position.z=e,this.viewer.updateZoom(),this.changed()},vc.prototype.spin=function(e,t){fc.getInverse(this.viewer.rotationGroup.matrix),mc.copy(ss(e)).applyMatrix4(fc),this.viewer.rotationGroup.rotateOnAxis(mc,t),this.changed()},vc.prototype.rotate=function(e){this.viewer.rotationGroup.setRotationFromQuaternion(us(e)),this.changed()},vc.prototype.align=function(e){gc.getInverse(ls(e)),this.viewer.rotationGroup.setRotationFromMatrix(gc),this.changed()},vc.prototype.applyMatrix=function(e){this.viewer.rotationGroup.applyMatrix(ls(e)),this.changed()},Object.defineProperties(vc.prototype,yc);var bc=function(e,t){for(var r,n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];this.pausedTime=-1,this.elapsedDuration=0,this.pausedDuration=0,this.ignoreGlobalToggle=!1,this._paused=!1,this._resolveList=[],this.duration=Ha(e,1e3),this.controls=t,this.startTime=window.performance.now(),(r=this)._init.apply(r,n)},wc={done:{configurable:!0},paused:{configurable:!0}};wc.done.get=function(){return 1===this.alpha},wc.paused.get=function(){return this._paused},bc.prototype.tick=function(e){if(!this._paused)return this.elapsedDuration=e.currentTime-this.startTime-this.pausedDuration,0===this.duration?this.alpha=1:this.alpha=_s(0,1,this.elapsedDuration/this.duration),this._tick(e),this.done&&this._resolveList.forEach(function(e){return e()}),this.done},bc.prototype.pause=function(e){e&&(this._hold=!0),-1===this.pausedTime&&(this.pausedTime=window.performance.now()),this._paused=!0},bc.prototype.resume=function(e){!e&&this._hold||(this.pausedDuration+=window.performance.now()-this.pausedTime,this._paused=!1,this._hold=!1,this.pausedTime=-1)},bc.prototype.toggle=function(){this._paused?this.resume():this.pause()},bc.prototype.then=function(e){var t=this;return(this.done?Promise.resolve():new Promise(function(e){return t._resolveList.push(e)})).then(e)},Object.defineProperties(bc.prototype,wc);var xc=function(e){function t(t,r){for(var n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];e.apply(this,[Ha(t,1/0),r].concat(n))}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t){Array.isArray(e)?this.axis=(new ft).fromArray(e):this.axis=Ha(e,new ft(0,1,0)),this.angle=Ha(t,.01)},t.prototype._tick=function(e){this.axis&&this.angle&&this.controls.spin(this.axis,this.angle*e.lastDuration/16)},t}(bc),_c=function(e){function t(t,r){for(var n=[],i=arguments.length-2;i-- >0;)n[i]=arguments[i+2];e.apply(this,[Ha(t,1/0),r].concat(n)),this.angleSum=0,this.direction=1}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t,r){Array.isArray(e)?this.axis=(new ft).fromArray(e):this.axis=Ha(e,new ft(0,1,0)),this.angleStep=Ha(t,.01),this.angleEnd=Ha(r,.2)},t.prototype._tick=function(e){if(this.axis&&this.angleStep&&this.angleEnd){var t=_s(0,1,Math.abs(this.angleSum)/this.angleEnd),r=this.angleStep*this.direction*(1.1-t);this.controls.spin(this.axis,r*e.lastDuration/16),this.angleSum+=this.angleStep,this.angleSum>=this.angleEnd&&(this.direction*=-1,this.angleSum=-this.angleEnd)}},t}(bc),Sc=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t){this.moveFrom=ss(Ha(e,new ft)),this.moveTo=ss(Ha(t,new ft))},t.prototype._tick=function(){this.controls.position.lerpVectors(this.moveFrom,this.moveTo,this.alpha).negate(),this.controls.changed()},t}(bc),Cc=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t){this.zoomFrom=e,this.zoomTo=t},t.prototype._tick=function(){this.controls.distance(ws(this.zoomFrom,this.zoomTo,this.alpha))},t}(bc),Mc=function(e){function t(){e.apply(this,arguments),this._currentRotation=new dt}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t){this.rotateFrom=us(e),this.rotateTo=us(t),this._currentRotation=new dt},t.prototype._tick=function(){this._currentRotation.copy(this.rotateFrom).slerp(this.rotateTo,this.alpha),this.controls.rotate(this._currentRotation)},t}(bc),Tc=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e,t,r){this.valueFrom=e,this.valueTo=t,this.callback=r},t.prototype._tick=function(){this.callback(ws(this.valueFrom,this.valueTo,this.alpha))},t}(bc),Ac=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._init=function(e){this.callback=e},t.prototype._tick=function(){1===this.alpha&&this.callback()},t}(bc),Ec=function(e){void 0===e&&(e=[]),this._resolveList=[],this._list=e},Pc={done:{configurable:!0}};Pc.done.get=function(){return this._list.every(function(e){return e.done})},Ec.prototype.then=function(e){var t=this;return(this.done?Promise.resolve():new Promise(function(e){t._resolveList.push(e),t._list.forEach(function(e){e.then(function(){t._resolveList.forEach(function(e){e()}),t._resolveList.length=0})})})).then(e)},Object.defineProperties(Ec.prototype,Pc);var Rc=function(e){this.stage=e,this.animationList=[],this.finishedList=[],this.viewer=e.viewer,this.controls=e.viewerControls},Ic={paused:{configurable:!0}};Ic.paused.get=function(){return this.animationList.every(function(e){return e.paused})},Rc.prototype.add=function(e){return 0===e.duration?e.tick(this.viewer.stats):this.animationList.push(e),e},Rc.prototype.remove=function(e){var t=this.animationList,r=t.indexOf(e);r>-1&&t.splice(r,1)},Rc.prototype.run=function(e){for(var t=this.finishedList,r=this.animationList,n=r.length,i=0;i<n;++i){var o=r[i];o.tick(e)&&t.push(o)}var a=t.length;if(a){for(var s=0;s<a;++s)this.remove(t[s]);t.length=0}},Rc.prototype.spin=function(e,t,r){return this.add(new xc(r,this.controls,e,t))},Rc.prototype.rock=function(e,t,r,n){return this.add(new _c(n,this.controls,e,t,r))},Rc.prototype.rotate=function(e,t){var r=this.viewer.rotationGroup.quaternion.clone();return this.add(new Mc(t,this.controls,r,e))},Rc.prototype.move=function(e,t){var r=this.controls.position.clone().negate();return this.add(new Sc(t,this.controls,r,e))},Rc.prototype.zoom=function(e,t){var r=this.viewer.camera.position.z;return this.add(new Cc(t,this.controls,r,e))},Rc.prototype.zoomMove=function(e,t,r){return new Ec([this.move(e,r),this.zoom(t,r)])},Rc.prototype.orient=function(e,t){var r=new ft,n=new dt,i=new ft;return ls(e).decompose(r,n,i),new Ec([this.move(r.negate(),t),this.rotate(n,t),this.zoom(-i.x,t)])},Rc.prototype.value=function(e,t,r,n){return this.add(new Tc(n,this.controls,e,t,r))},Rc.prototype.timeout=function(e,t){return this.add(new Ac(t,this.controls,e))},Rc.prototype.spinComponent=function(e,t,r,n){return this.add(new xc(n,e.controls,t,r))},Rc.prototype.rockComponent=function(e,t,r,n,i){return this.add(new _c(i,e.controls,t,r,n))},Rc.prototype.moveComponent=function(e,t,r){var n=e.controls.position.clone().negate();return this.add(new Sc(r,e.controls,n,t))},Rc.prototype.pause=function(){this.animationList.forEach(function(e){return e.pause()})},Rc.prototype.resume=function(){this.animationList.forEach(function(e){return e.resume()})},Rc.prototype.toggle=function(){this.paused?this.resume():this.pause()},Rc.prototype.clear=function(){this.animationList.length=0},Rc.prototype.dispose=function(){this.clear()},Object.defineProperties(Rc.prototype,Ic);var Nc=function(e,t){if(this.fn=e,this.queue=[],this.pending=!1,this.next=this.next.bind(this),t){for(var r=0,n=t.length;r<n;++r)this.queue.push(t[r]);this.next()}};Nc.prototype.run=function(e){this.fn(e,this.next)},Nc.prototype.next=function(){var e=this,t=this.queue.shift();void 0!==t?(this.pending=!0,setTimeout(function(){return e.run(t)})):this.pending=!1},Nc.prototype.push=function(e){this.queue.push(e),this.pending||this.next()},Nc.prototype.kill=function(){this.queue.length=0},Nc.prototype.length=function(){return this.queue.length};var Dc=function(e,t,r){this.type="",this.parameters={lazy:{type:"boolean"},clipNear:{type:"range",step:1,max:100,min:0,buffer:!0},clipRadius:{type:"number",precision:1,max:1e3,min:0,buffer:!0},clipCenter:{type:"vector3",precision:1,buffer:!0},flatShaded:{type:"boolean",buffer:!0},opacity:{type:"range",step:.01,max:1,min:0,buffer:!0},depthWrite:{type:"boolean",buffer:!0},side:{type:"select",buffer:!0,options:{front:"front",back:"back",double:"double"}},wireframe:{type:"boolean",buffer:!0},colorScheme:{type:"select",update:"color",options:{}},colorScale:{type:"select",update:"color",options:Sl.getScales()},colorReverse:{type:"boolean",update:"color"},colorValue:{type:"color",update:"color"},colorDomain:{type:"hidden",update:"color"},colorMode:{type:"select",update:"color",options:Sl.getModes()},roughness:{type:"range",step:.01,max:1,min:0,buffer:!0},metalness:{type:"range",step:.01,max:1,min:0,buffer:!0},diffuse:{type:"color",buffer:!0},matrix:{type:"hidden",buffer:!0},disablePicking:{type:"boolean",rebuild:!0}},this.viewer=t,this.tasks=new Zl,this.queue=new Nc(this.make.bind(this)),this.bufferList=[],this.parameters.colorScheme&&(this.parameters.colorScheme.options=Sl.getSchemes())};Dc.prototype.init=function(e){var t=e||{};this.clipNear=Ha(t.clipNear,0),this.clipRadius=Ha(t.clipRadius,0),this.clipCenter=Ha(t.clipCenter,new ft),this.flatShaded=Ha(t.flatShaded,!1),this.side=Ha(t.side,"double"),this.opacity=Ha(t.opacity,1),this.depthWrite=Ha(t.depthWrite,!0),this.wireframe=Ha(t.wireframe,!1),this.setColor(t.color,t),this.colorScheme=Ha(t.colorScheme,"uniform"),this.colorScale=Ha(t.colorScale,""),this.colorReverse=Ha(t.colorReverse,!1),this.colorValue=Ha(t.colorValue,9474192),this.colorDomain=Ha(t.colorDomain,void 0),this.colorMode=Ha(t.colorMode,"hcl"),this.visible=Ha(t.visible,!0),this.quality=Ha(t.quality,void 0),this.roughness=Ha(t.roughness,.4),this.metalness=Ha(t.metalness,0),this.diffuse=Ha(t.diffuse,16777215),this.lazy=Ha(t.lazy,!1),this.lazyProps={build:!1,bufferParams:{},what:{}},this.matrix=Ha(t.matrix,new pt),this.disablePicking=Ha(t.disablePicking,!1);var r=this.parameters;!0===r.sphereDetail&&(r.sphereDetail={type:"integer",max:3,min:0,rebuild:"impostor"}),!0===r.radialSegments&&(r.radialSegments={type:"integer",max:25,min:5,rebuild:"impostor"}),!0===r.openEnded&&(r.openEnded={type:"boolean",rebuild:"impostor",buffer:!0}),!0===r.disableImpostor&&(r.disableImpostor={type:"boolean",rebuild:!0}),"low"===t.quality?(r.sphereDetail&&(this.sphereDetail=0),r.radialSegments&&(this.radialSegments=5)):"medium"===t.quality?(r.sphereDetail&&(this.sphereDetail=1),r.radialSegments&&(this.radialSegments=10)):"high"===t.quality?(r.sphereDetail&&(this.sphereDetail=2),r.radialSegments&&(this.radialSegments=20)):(r.sphereDetail&&(this.sphereDetail=Ha(t.sphereDetail,1)),r.radialSegments&&(this.radialSegments=Ha(t.radialSegments,10))),r.openEnded&&(this.openEnded=Ha(t.openEnded,!0)),r.disableImpostor&&(this.disableImpostor=Ha(t.disableImpostor,!1))},Dc.prototype.getColorParams=function(e){return Object.assign({scheme:this.colorScheme,scale:this.colorScale,reverse:this.colorReverse,value:this.colorValue,domain:this.colorDomain,mode:this.colorMode},e)},Dc.prototype.getBufferParams=function(e){return Object.assign({clipNear:this.clipNear,clipRadius:this.clipRadius,clipCenter:this.clipCenter,flatShaded:this.flatShaded,opacity:this.opacity,depthWrite:this.depthWrite,side:this.side,wireframe:this.wireframe,roughness:this.roughness,metalness:this.metalness,diffuse:this.diffuse,matrix:this.matrix,disablePicking:this.disablePicking},e)},Dc.prototype.setColor=function(e,t){var r=Object.keys(Sl.getSchemes());return"string"==typeof e&&r.includes(e.toLowerCase())?t?t.colorScheme=e:this.setParameters({colorScheme:e}):void 0!==e&&(e=new ur(e).getHex(),t?(t.colorScheme="uniform",t.colorValue=e):this.setParameters({colorScheme:"uniform",colorValue:e})),this},Dc.prototype.create=function(){},Dc.prototype.update=function(){this.build()},Dc.prototype.build=function(e){if(!this.lazy||this.visible){if(!this.prepare)return this.tasks.increment(),void this.make();this.queue.length()>0?(this.tasks.change(1-this.queue.length()),this.queue.kill()):this.tasks.increment(),this.queue.push(e||!1)}else this.lazyProps.build=!0},Dc.prototype.make=function(e,t){var r=this;vl&&gl.time("Representation.make "+this.type);var n=function(){e?(r.update(e),r.viewer.requestRender(),r.tasks.decrement(),t&&t()):(r.clear(),r.create(),r.manualAttach||r.disposed||(vl&&gl.time("Representation.attach "+r.type),r.attach(function(){vl&&gl.timeEnd("Representation.attach "+r.type),r.tasks.decrement(),t&&t()}))),vl&&gl.timeEnd("Representation.make "+r.type)};this.prepare?this.prepare(n):n()},Dc.prototype.attach=function(e){this.setVisibility(this.visible),e()},Dc.prototype.setVisibility=function(e,t){if(this.visible=e,this.visible){var r=this.lazyProps,n=r.bufferParams,i=r.what;if(r.build)return r.build=!1,void this.build();(Object.keys(n).length||Object.keys(i).length)&&(r.bufferParams={},r.what={},this.updateParameters(n,i))}return this.bufferList.forEach(function(t){t.setVisibility(e)}),t||this.viewer.requestRender(),this},Dc.prototype.setParameters=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r=!1);var n=e||{},i=this.parameters,o={};for(var a in this.setColor(n.color,n),n)void 0!==n[a]&&void 0!==i[a]&&(i[a].int&&(n[a]=parseInt(n[a])),i[a].float&&(n[a]=parseFloat(n[a])),(n[a]!==this[a]||n[a].equals&&!n[a].equals(this[a]))&&(this[a]&&this[a].copy&&n[a].copy?this[a].copy(n[a]):this[a]&&this[a].set?this[a].set(n[a]):this[a]=n[a],i[a].buffer&&(!0===i[a].buffer?o[a]=n[a]:o[i[a].buffer]=n[a]),i[a].update&&(t[i[a].update]=!0),!i[a].rebuild||"impostor"===i[a].rebuild&&ml&&!this.disableImpostor||(r=!0)));return r?this.build():this.updateParameters(o,t),this},Dc.prototype.updateParameters=function(e,t){if(this.lazy&&!this.visible)return Object.assign(this.lazyProps.bufferParams,e),void Object.assign(this.lazyProps.what,t);this.bufferList.forEach(function(t){t.setParameters(e)}),Object.keys(t).length&&this.update(t),this.viewer.requestRender()},Dc.prototype.getParameters=function(){var e=this,t={lazy:this.lazy,visible:this.visible,quality:this.quality};return Object.keys(this.parameters).forEach(function(r){null!==e.parameters[r]&&(t[r]=e[r])}),t},Dc.prototype.clear=function(){var e=this;this.bufferList.forEach(function(t){e.viewer.remove(t),t.dispose()}),this.bufferList.length=0,this.viewer.requestRender()},Dc.prototype.dispose=function(){this.disposed=!0,this.queue.kill(),this.tasks.dispose(),this.clear()};var kc=function(e){var t=this;this.pending=0,this.postCount=0,this.onmessageDict={},this.onerrorDict={},this.name=e,this.blobUrl=window.URL.createObjectURL(_l.get(e)),this.worker=new Worker(this.blobUrl),_l.activeWorkerCount+=1,this.worker.onmessage=function(r){t.pending-=1;var n=r.data.__postId;vl&&gl.timeEnd("Worker.postMessage "+e+" #"+n);var i=t.onmessageDict[n];i&&i.call(t.worker,r),delete t.onmessageDict[n],delete t.onerrorDict[n]},this.worker.onerror=function(r){if(t.pending-=1,r.data){var n=r.data.__postId,i=t.onerrorDict[n];i?i.call(t.worker,r):gl.error("Worker.onerror",n,e,r),delete t.onmessageDict[n],delete t.onerrorDict[n]}else gl.error("Worker.onerror",e,r)}};kc.prototype.post=function(e,t,r,n){void 0===e&&(e={}),this.onmessageDict[this.postCount]=r,this.onerrorDict[this.postCount]=n,e.__name=this.name,e.__postId=this.postCount,e.__debug=vl,vl&&gl.time("Worker.postMessage "+this.name+" #"+this.postCount);try{this.worker.postMessage(e,t)}catch(t){gl.error("worker.post:",t),this.worker.postMessage(e)}return this.pending+=1,this.postCount+=1,this},kc.prototype.terminate=function(){this.worker?(this.worker.terminate(),window.URL.revokeObjectURL(this.blobUrl),_l.activeWorkerCount-=1):gl.log("no worker to terminate")};var Oc=function(e,t){void 0===t&&(t=2),this.pool=[],this.count=0,this.maxCount=Math.min(8,t),this.name=e};function Fc(e){for(var t=e.length,r=t/3,n=0,i=0,o=0,a=0;a<t;a+=3)n+=e[a+0],i+=e[a+1],o+=e[a+2];return new ft(n/r,i/r,o/r)}function Lc(e,t,r){return r?e.sub(r).projectOnVector(t).add(r):e.projectOnVector(t),e}function Uc(e){for(var t=1/0,r=1/0,n=1/0,i=-1/0,o=-1/0,a=-1/0,s=0,l=e.length;s<l;s+=3){var u=e[s],c=e[s+1],h=e[s+2];u<t&&(t=u),c<r&&(r=c),h<n&&(n=h),u>i&&(i=u),c>o&&(o=c),h>a&&(a=h)}return[jc([t,r,n]),jc([i,o,a])]}function Vc(e,t){for(var r=0,n=t.length;r<n;r+=3){var i=t[r],o=t[r+1],a=t[r+2];t[r]=e[0]*i+e[4]*o+e[8]*a+e[12],t[r+1]=e[1]*i+e[5]*o+e[9]*a+e[13],t[r+2]=e[2]*i+e[6]*o+e[10]*a+e[14]}}function Bc(e,t){for(var r=0,n=t.length;r<n;r+=3){var i=t[r],o=t[r+1],a=t[r+2];t[r]=e[0]*i+e[3]*o+e[6]*a,t[r+1]=e[1]*i+e[4]*o+e[7]*a,t[r+2]=e[2]*i+e[5]*o+e[8]*a}}function zc(e){for(var t=0,r=e.length;t<r;t+=3){var n=e[t],i=e[t+1],o=e[t+2],a=1/Math.sqrt(n*n+i*i+o*o);e[t]=n*a,e[t+1]=i*a,e[t+2]=o*a}}function jc(e){return new Float32Array(e||3)}function Hc(e,t,r){var n=t[0],i=t[1],o=t[2],a=r[0],s=r[1],l=r[2];e[0]=i*l-o*s,e[1]=o*a-n*l,e[2]=n*s-i*a}function $c(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Gc(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}function Wc(e,t,r){e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2]}function qc(e,t,r){void 0===r&&(r=0),e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}function Xc(e,t,r){void 0===r&&(r=0),t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2]}function Kc(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function Yc(e,t,r){Zc(e,t,1/r)}function Zc(e,t,r){e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}function Jc(e,t){Zc(e,t,1/Kc(t))}function Qc(e,t,r){e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r}function eh(e,t,r){e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r}function th(e,t){e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2])}function rh(e,t){e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2])}function nh(e,t){e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]}Oc.prototype.post=function(e,t,r,n){void 0===e&&(e={});var i=this.getNextWorker();return i?i.post(e,t,r,n):console.error("unable to get worker from pool"),this},Oc.prototype.terminate=function(){this.pool.forEach(function(e){e.terminate()})},Oc.prototype.getNextWorker=function(){for(var e,t=1/0,r=0;r<this.maxCount;++r){if(r>=this.count){e=new kc(this.name),this.pool.push(e),this.count+=1;break}var n=this.pool[r];if(0===n.pending){e=n;break}n.pending<t&&(t=n.pending,e=n)}return e},Oc.prototype.constructor=Oc,Uc.__deps=[jc],Yc.__deps=[Zc],Jc.__deps=[Zc,Kc];var ih=new ft,oh=function(){},ah={Picker:{configurable:!0},Buffer:{configurable:!0}};ah.Picker.get=function(){return Il.get(this.type)},ah.Buffer.get=function(){return Rl.get(this.type)},oh.getShapeKey=function(e){return this.type+e[0].toUpperCase()+e.substr(1)},oh.expandBoundingBox=function(e,t){},oh.valueToShape=function(e,t,r){var n=e._primitiveData[this.getShapeKey(t)];switch(this.fields[t]){case"v3":case"c":!function(e,t){void 0!==e.toArray?e=e.toArray():void 0!==e.x?e=[e.x,e.y,e.z]:void 0!==e.r&&(e=[e.r,e.g,e.b]),t.push.apply(t,e)}(r,n);break;default:n.push(r)}},oh.objectToShape=function(e,t){var r=this;Object.keys(this.fields).forEach(function(n){r.valueToShape(e,n,t[n])}),this.valueToShape(e,"name",t.name),this.expandBoundingBox(e.boundingBox,t)},oh.valueFromShape=function(e,t,r){var n=e._primitiveData[this.getShapeKey(r)];switch(this.fields[r]){case"v3":return(new ft).fromArray(n,3*t);case"c":return(new ur).fromArray(n,3*t);default:return n[t]}},oh.objectFromShape=function(e,t){var r=this,n={shape:e,name:this.valueFromShape(e,t,"name")};return Object.keys(this.fields).forEach(function(i){n[i]=r.valueFromShape(e,t,i)}),n},oh.arrayFromShape=function(e,t){var r=e._primitiveData[this.getShapeKey(t)];switch(this.fields[t]){case"s":return r;default:return new Float32Array(r)}},oh.dataFromShape=function(e){var t=this,r={};return this.Picker&&(r.picking=new this.Picker(e)),Object.keys(this.fields).forEach(function(n){r[n]=t.arrayFromShape(e,n)}),r},oh.bufferFromShape=function(e,t){return new this.Buffer(this.dataFromShape(e),t)},Object.defineProperties(oh,ah),oh.type="",oh.fields={};var sh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.positionFromShape=function(e,t){return this.valueFromShape(e,t,"position")},t.expandBoundingBox=function(e,t){e.expandByPoint(ih.fromArray(t.position))},t}(oh);sh.type="sphere",sh.fields={position:"v3",color:"c",radius:"f"};var lh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.positionFromShape=function(e,t){return this.valueFromShape(e,t,"position")},t.expandBoundingBox=function(e,t){e.expandByPoint(ih.fromArray(t.position))},t}(oh);lh.type="box",lh.fields={position:"v3",color:"c",size:"f",heightAxis:"v3",depthAxis:"v3"};var uh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(lh);uh.type="octahedron";var ch=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(lh);ch.type="tetrahedron";var hh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.positionFromShape=function(e,t){var r=this.valueFromShape(e,t,"position1"),n=this.valueFromShape(e,t,"position2");return r.add(n).multiplyScalar(.5)},t.expandBoundingBox=function(e,t){e.expandByPoint(ih.fromArray(t.position1)),e.expandByPoint(ih.fromArray(t.position2))},t}(oh);hh.type="cylinder",hh.fields={position1:"v3",position2:"v3",color:"c",radius:"f"};var ph=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(hh);ph.type="arrow";var dh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(hh);dh.type="cone";var fh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(sh);fh.type="ellipsoid",fh.fields={position:"v3",color:"c",radius:"f",majorAxis:"v3",minorAxis:"v3"};var mh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(fh);mh.type="torus";var gh=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.positionFromShape=function(e,t){return this.valueFromShape(e,t,"position")},t.expandBoundingBox=function(e,t){e.expandByPoint(ih.fromArray(t.position))},t}(oh);gh.type="text",gh.fields={position:"v3",color:"c",size:"f",text:"s"};var vh=function(e,t){this.exp=3;var r=t||function(e){for(var t=e.x,r=e.y,n=e.z,i=new _r,o=t.length,a=i.min,s=i.max,l=0;l<o;l++)a.x=Math.min(t[l],a.x),a.y=Math.min(r[l],a.y),a.z=Math.min(n[l],a.z),s.x=Math.max(t[l],s.x),s.y=Math.max(r[l],s.y),s.z=Math.max(n[l],s.z);return i}(e);this.minX=r.min.x,this.minY=r.min.y,this.minZ=r.min.z,this.boundX=1+(r.max.x-this.minX>>this.exp),this.boundY=1+(r.max.y-this.minY>>this.exp),this.boundZ=1+(r.max.z-this.minZ>>this.exp);for(var n=this.boundX*this.boundY*this.boundZ,i=e.x.length,o=e.x,a=e.y,s=e.z,l=0,u=new Uint32Array(n),c=new Int32Array(i),h=0;h<i;++h){var p=o[h]-this.minX>>this.exp,d=a[h]-this.minY>>this.exp,f=s[h]-this.minZ>>this.exp,m=(p*this.boundY+d)*this.boundZ+f;1===(u[m]+=1)&&(l+=1),c[h]=m}for(var g=new Uint16Array(l),v=0,y=0;v<n;++v){var b=u[v];b>0&&(u[v]=y+1,g[y]=b,y+=1)}for(var w=new Uint32Array(l),x=1;x<l;++x)w[x]+=w[x-1]+g[x-1];for(var _=new Uint16Array(l),S=new Int32Array(i),C=0;C<i;++C){var M=u[c[C]];if(M>0){var T=M-1;S[w[T]+_[T]]=C,_[T]+=1}}this.grid=u,this.bucketCount=g,this.bucketOffset=w,this.bucketArray=S,this.xArray=o,this.yArray=a,this.zArray=s};vh.prototype.within=function(e,t,r,n){var i=[];return this.eachWithin(e,t,r,n,function(e){return i.push(e)}),i},vh.prototype.eachWithin=function(e,t,r,n,i){for(var o=n*n,a=Math.max(0,e-n-this.minX>>this.exp),s=Math.max(0,t-n-this.minY>>this.exp),l=Math.max(0,r-n-this.minZ>>this.exp),u=Math.min(this.boundX,e+n-this.minX>>this.exp),c=Math.min(this.boundY,t+n-this.minY>>this.exp),h=Math.min(this.boundZ,r+n-this.minZ>>this.exp),p=a;p<=u;++p)for(var d=s;d<=c;++d)for(var f=l;f<=h;++f){var m=(p*this.boundY+d)*this.boundZ+f,g=this.grid[m];if(g>0)for(var v=g-1,y=this.bucketOffset[v],b=y+this.bucketCount[v],w=y;w<b;++w){var x=this.bucketArray[w],_=this.xArray[x]-e,S=this.yArray[x]-t,C=this.zArray[x]-r,M=_*_+S*S+C*C;M<=o&&i(x,M)}}};var yh=function(e){void 0===e&&(e=0),this._fields=this._defaultFields,this._init(0)};yh.prototype._init=function(e){this.length=e,this.count=0;for(var t=0,r=this._fields.length;t<r;++t){var n=this._fields[t],i=n[0],o=n[1],a=n[2];this._initField(i,o,a)}},yh.prototype._initField=function(e,t,r){this[e]=ns(r,this.length*t)},yh.prototype.addField=function(e,t,r){this._fields.push([e,t,r]),this._initField(e,t,r)},yh.prototype.resize=function(e){this.length=Math.round(e||0),this.count=Math.min(this.count,this.length);for(var t=0,r=this._fields.length;t<r;++t){var n=this._fields[t][0],i=this._fields[t][1],o=this.length*i,a=new this[n].constructor(o);this[n].length>o?a.set(this[n].subarray(0,o)):a.set(this[n]),this[n]=a}},yh.prototype.growIfFull=function(){if(this.count>=this.length){var e=Math.round(1.5*this.length);this.resize(Math.max(256,e))}},yh.prototype.copyFrom=function(e,t,r,n){for(var i=0,o=this._fields.length;i<o;++i)for(var a=this._fields[i][0],s=this._fields[i][1],l=this[a],u=e[a],c=0;c<n;++c)for(var h=s*(t+c),p=s*(r+c),d=0;d<s;++d)l[h+d]=u[p+d]},yh.prototype.copyWithin=function(e,t,r){for(var n=0,i=this._fields.length;n<i;++n)for(var o=this._fields[n][0],a=this._fields[n][1],s=this[o],l=0;l<r;++l)for(var u=a*(e+l),c=a*(t+l),h=0;h<a;++h)s[u+h]=s[c+h]},yh.prototype.sort=function(e){gl.time("Store.sort");var t=this,r=new this.constructor(1);function n(e,n){e!==n&&(r.copyFrom(t,0,e,1),t.copyWithin(e,n,1),t.copyFrom(r,n,0,1))}!function t(r,i){if(r<i){var o=Math.floor((r+i)/2),a=r,s=i;do{for(;e(a,o)<0;)a+=1;for(;e(s,o)>0;)s-=1;a<=s&&(a===o?o=s:s===o&&(o=a),n(a,s),a+=1,s-=1)}while(a<=s);t(r,s),t(a,i)}}(0,this.count-1),gl.timeEnd("Store.sort")},yh.prototype.clear=function(){this.count=0},yh.prototype.dispose=function(){delete this.length,delete this.count;for(var e=0,t=this._fields.length;e<t;++e){delete this[this._fields[e][0]]}};var bh=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["index1",1,"int32"],["index2",1,"int32"],["type",1,"int8"]]},t.prototype.addContact=function(e,t,r){this.growIfFull();var n=this.count;e<t?(this.index1[n]=e,this.index2[n]=t):(this.index2[n]=e,this.index1[n]=t),r&&(this.type[n]=r),this.count+=1},Object.defineProperties(t.prototype,r),t}(yh);function wh(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}var xh=function(e,t){this.length=e,this._words=new Uint32Array(e+32>>>5),!0===t&&this.setAll()};function _h(e){for(var t=e.edgeCount,r=e.nodeCount,n=e.nodeArray1,i=e.nodeArray2,o=new Uint8Array(r),a=new Int32Array(r),s=0;s<t;++s)o[n[s]]+=1,o[i[s]]+=1;for(var l=1;l<r;++l)a[l]+=a[l-1]+o[l-1];for(var u=2*t,c=new Int32Array(u),h=0;h<u;++h)c[h]=-1;for(var p=0;p<t;++p){for(var d=n[p],f=i[p],m=a[d];-1!==c[m];)m+=1;c[m]=p;for(var g=a[f];-1!==c[g];)g+=1;c[g]=p}return{countArray:o,offsetArray:a,indexArray:c}}function Sh(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),{type:e,group:t,x:0,y:0,z:0,atomSet:[]}}function Ch(e,t){e.x+=t.x,e.y+=t.y,e.z+=t.z,e.atomSet.push(t.index)}function Mh(e,t){var r=t.atomSet.length;if(r>0){var n=e.types,i=e.groups,o=e.centers,a=e.atomSets;n.push(t.type),i.push(t.group),o.x.push(t.x/r),o.y.push(t.y/r),o.z.push(t.z/r),a.push(t.atomSet)}}xh.prototype.get=function(e){return 0!=(this._words[e>>>5]&1<<e)},xh.prototype.set=function(e){this._words[e>>>5]|=1<<e},xh.prototype.clear=function(e){this._words[e>>>5]&=~(1<<e)},xh.prototype.flip=function(e){this._words[e>>>5]^=1<<e},xh.prototype._assignRange=function(e,t,r){if(!(t<e)){for(var n=this._words,i=!0===r?4294967295:0,o=e>>>5,a=t>>>5,s=o;s<a;++s)n[s]=i;var l=o<<5,u=a<<5;if(!0===r)if(t-e<32)for(var c=e,h=t+1;c<h;++c)n[c>>>5]|=1<<c;else{for(var p=e,d=l;p<d;++p)n[p>>>5]|=1<<p;for(var f=u,m=t+1;f<m;++f)n[f>>>5]|=1<<f}else if(t-e<32)for(var g=e,v=t+1;g<v;++g)n[g>>>5]&=~(1<<g);else{for(var y=e,b=l;y<b;++y)n[y>>>5]&=~(1<<y);for(var w=u,x=t+1;w<x;++w)n[w>>>5]&=~(1<<w)}return this}},xh.prototype.setRange=function(e,t){return this._assignRange(e,t,!0)},xh.prototype.clearRange=function(e,t){return this._assignRange(e,t,!1)},xh.prototype.setBits=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var r=this._words,n=e.length,i=0;i<n;++i){var o=e[i];r[o>>>5]|=1<<o}return this},xh.prototype.clearBits=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var r=this._words,n=e.length,i=0;i<n;++i){var o=e[i];r[o>>>5]&=~(1<<o)}return this},xh.prototype.setAll=function(){return this._assignRange(0,this.length-1,!0)},xh.prototype.clearAll=function(){return this._assignRange(0,this.length-1,!1)},xh.prototype.flipAll=function(){for(var e=this._words.length,t=this._words,r=32-this.length%32,n=0;n<e-1;++n)t[n]=~t[n];return t[e-1]=~(t[e-1]<<r)>>>r,this},xh.prototype._isRangeValue=function(e,t,r){if(!(t<e)){for(var n=this._words,i=!0===r?4294967295:0,o=e>>>5,a=t>>>5,s=o;s<a;++s)if(n[s]!==i)return!1;if(t-e<32){for(var l=e,u=t+1;l<u;++l)if(!!(n[l>>>5]&1<<l)!==r)return!1}else{for(var c=a<<5,h=e,p=o<<5<<5;h<p;++h)if(!!(n[h>>>5]&1<<h)!==r)return!1;for(var d=c,f=t+1;d<f;++d)if(!!(n[d>>>5]&1<<d)!==r)return!1}return!0}},xh.prototype.isRangeSet=function(e,t){return this._isRangeValue(e,t,!0)},xh.prototype.isRangeClear=function(e,t){return this._isRangeValue(e,t,!1)},xh.prototype.isAllSet=function(){return this._isRangeValue(0,this.length-1,!0)},xh.prototype.isAllClear=function(){return this._isRangeValue(0,this.length-1,!1)},xh.prototype.isSet=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var r=this._words,n=e.length,i=0;i<n;++i){var o=e[i];if(0==(r[o>>>5]&1<<o))return!1}return!0},xh.prototype.isClear=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var r=this._words,n=e.length,i=0;i<n;++i){var o=e[i];if(0!=(r[o>>>5]&1<<o))return!1}return!0},xh.prototype.isEqualTo=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0;i<n;++i)if(t[i]!==r[i])return!1;return!0},xh.prototype.getSize=function(){for(var e=this._words.length,t=this._words,r=0,n=0;n<e;++n)r+=wh(t[n]);return r},xh.prototype.difference=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0;i<n;++i)t[i]=t[i]&~r[i];for(var o=t.length;o<n;++o)t[o]=0;return this},xh.prototype.union=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0;i<n;++i)t[i]|=r[i];for(var o=t.length;o<n;++o)t[o]=0;return this},xh.prototype.intersection=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0;i<n;++i)t[i]&=r[i];for(var o=t.length;o<n;++o)t[o]=0;return this},xh.prototype.intersects=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0;i<n;++i)if(0!=(t[i]&r[i]))return!0;return!1},xh.prototype.getIntersectionSize=function(e){for(var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=0,o=0;o<n;++o)i+=wh(t[o]&r[o]);return i},xh.prototype.makeIntersection=function(e){var t=this._words,r=e._words,n=Math.min(t.length,r.length),i=new Uint32Array(n),o=Object.create(xh.prototype);o._words=i,o.length=Math.min(this.length,e.length);for(var a=0;a<n;++a)i[a]=t[a]&r[a];return o},xh.prototype.forEach=function(e){for(var t=this._words.length,r=this._words,n=0,i=0;i<t;++i)for(var o=r[i];0!==o;){var a=o&-o;e((i<<5)+wh(a-1),n),o^=a,++n}},xh.prototype.toArray=function(){for(var e=this._words,t=new Array(this.getSize()),r=this._words.length,n=0,i=0;i<r;++i)for(var o=e[i];0!==o;){var a=o&-o;t[n++]=(i<<5)+wh(a-1),o^=a}return t},xh.prototype.toString=function(){return"{"+this.toArray().join(",")+"}"},xh.prototype.toSeleString=function(){var e=this.toArray().join(",");return e?"@"+e:"NONE"},xh.prototype.clone=function(){var e=Object.create(xh.prototype);return e.length=this.length,e._words=new Uint32Array(this._words),e};var Th=0,Ah=1,Eh=2,Ph=3,Rh=4,Ih=0,Nh=["D-BETA-PEPTIDE, C-GAMMA LINKING","D-GAMMA-PEPTIDE, C-DELTA LINKING","D-PEPTIDE COOH CARBOXY TERMINUS","D-PEPTIDE NH3 AMINO TERMINUS","D-PEPTIDE LINKING","L-BETA-PEPTIDE, C-GAMMA LINKING","L-GAMMA-PEPTIDE, C-DELTA LINKING","L-PEPTIDE COOH CARBOXY TERMINUS","L-PEPTIDE NH3 AMINO TERMINUS","L-PEPTIDE LINKING","PEPTIDE LINKING","PEPTIDE-LIKE"],Dh=["RNA OH 3 PRIME TERMINUS","RNA OH 5 PRIME TERMINUS","RNA LINKING"],kh=["DNA OH 3 PRIME TERMINUS","DNA OH 5 PRIME TERMINUS","DNA LINKING","L-DNA LINKING","L-RNA LINKING"],Oh=["D-SACCHARIDE","D-SACCHARIDE 1,4 AND 1,4 LINKING","D-SACCHARIDE 1,4 AND 1,6 LINKING","L-SACCHARIDE","L-SACCHARIDE 1,4 AND 1,4 LINKING","L-SACCHARIDE 1,4 AND 1,6 LINKING","SACCHARIDE"],Fh=["NON-POLYMER"].concat(["OTHER"],Oh),Lh=["h","g","i"],Uh=["e","b"],Vh=["s","t","l",""],Bh={H:1,D:1,T:1,HE:2,LI:3,BE:4,B:5,C:6,N:7,O:8,F:9,NE:10,NA:11,MG:12,AL:13,SI:14,P:15,S:16,CL:17,AR:18,K:19,CA:20,SC:21,TI:22,V:23,CR:24,MN:25,FE:26,CO:27,NI:28,CU:29,ZN:30,GA:31,GE:32,AS:33,SE:34,BR:35,KR:36,RB:37,SR:38,Y:39,ZR:40,NB:41,MO:42,TC:43,RU:44,RH:45,PD:46,AG:47,CD:48,IN:49,SN:50,SB:51,TE:52,I:53,XE:54,CS:55,BA:56,LA:57,CE:58,PR:59,ND:60,PM:61,SM:62,EU:63,GD:64,TB:65,DY:66,HO:67,ER:68,TM:69,YB:70,LU:71,HF:72,TA:73,W:74,RE:75,OS:76,IR:77,PT:78,AU:79,HG:80,TL:81,PB:82,BI:83,PO:84,AT:85,RN:86,FR:87,RA:88,AC:89,TH:90,PA:91,U:92,NP:93,PU:94,AM:95,CM:96,BK:97,CF:98,ES:99,FM:100,MD:101,NO:102,LR:103,RF:104,DB:105,SG:106,BH:107,HS:108,MT:109,DS:110,RG:111,CN:112,NH:113,FL:114,MC:115,LV:116,TS:117,OG:118},zh={1:1.1,2:1.4,3:1.81,4:1.53,5:1.92,6:1.7,7:1.55,8:1.52,9:1.47,10:1.54,11:2.27,12:1.73,13:1.84,14:2.1,15:1.8,16:1.8,17:1.75,18:1.88,19:2.75,20:2.31,21:2.3,22:2.15,23:2.05,24:2.05,25:2.05,26:2.05,27:2,28:2,29:2,30:2.1,31:1.87,32:2.11,33:1.85,34:1.9,35:1.83,36:2.02,37:3.03,38:2.49,39:2.4,40:2.3,41:2.15,42:2.1,43:2.05,44:2.05,45:2,46:2.05,47:2.1,48:2.2,49:2.2,50:1.93,51:2.17,52:2.06,53:1.98,54:2.16,55:3.43,56:2.68,57:2.5,58:2.48,59:2.47,60:2.45,61:2.43,62:2.42,63:2.4,64:2.38,65:2.37,66:2.35,67:2.33,68:2.32,69:2.3,70:2.28,71:2.27,72:2.25,73:2.2,74:2.1,75:2.05,76:2,77:2,78:2.05,79:2.1,80:2.05,81:1.96,82:2.02,83:2.07,84:1.97,85:2.02,86:2.2,87:3.48,88:2.83,89:2,90:2.4,91:2,92:2.3,93:2,94:2,95:2,96:2,97:2,98:2,99:2,100:2,101:2,102:2,103:2,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:2,114:2,115:2,116:2,117:2,118:2},jh={1:.31,2:.28,3:1.28,4:.96,5:.84,6:.76,7:.71,8:.66,9:.57,10:.58,11:1.66,12:1.41,13:1.21,14:1.11,15:1.07,16:1.05,17:1.02,18:1.06,19:2.03,20:1.76,21:1.7,22:1.6,23:1.53,24:1.39,25:1.39,26:1.32,27:1.26,28:1.24,29:1.32,30:1.22,31:1.22,32:1.2,33:1.19,34:1.2,35:1.2,36:1.16,37:2.2,38:1.95,39:1.9,40:1.75,41:1.64,42:1.54,43:1.47,44:1.46,45:1.42,46:1.39,47:1.45,48:1.44,49:1.42,50:1.39,51:1.39,52:1.38,53:1.39,54:1.4,55:2.44,56:2.15,57:2.07,58:2.04,59:2.03,60:2.01,61:1.99,62:1.98,63:1.98,64:1.96,65:1.94,66:1.92,67:1.92,68:1.89,69:1.9,70:1.87,71:1.87,72:1.75,73:1.7,74:1.62,75:1.51,76:1.44,77:1.41,78:1.36,79:1.36,80:1.32,81:1.45,82:1.46,83:1.48,84:1.4,85:1.5,86:1.5,87:2.6,88:2.21,89:2.15,90:2.06,91:2,92:1.96,93:1.9,94:1.87,95:1.8,96:1.69,97:1.6,98:1.6,99:1.6,100:1.6,101:1.6,102:1.6,103:1.6,104:1.6,105:1.6,106:1.6,107:1.6,108:1.6,109:1.6,110:1.6,111:1.6,112:1.6,113:1.6,114:1.6,115:1.6,116:1.6,117:1.6,118:1.6},Hh={1:[1],2:[0],3:[1],4:[2],5:[3],6:[4],7:[3],8:[2],9:[1],10:[0],11:[1],12:[2],13:[6],14:[6],15:[3,5,7],16:[2,4,6],17:[1],18:[0],19:[1],20:[2],31:[3],32:[4],33:[3,5],34:[2,4,6],35:[1],36:[0],37:[1],38:[2],49:[3],50:[4],51:[3,5],52:[2],53:[1,2,5],54:[0,2],55:[1],56:[2],81:[3],82:[4],83:[3],84:[2],85:[1],86:[0],87:[1],88:[2]},$h={1:1,2:2,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:1,12:2,13:3,14:4,15:5,16:6,17:7,18:8,19:1,20:2,21:3,22:4,23:5,24:6,25:7,26:8,27:9,28:10,29:11,30:2,31:3,32:4,33:5,34:6,35:7,36:8,37:1,38:2,39:3,40:4,41:5,42:6,43:7,44:8,45:9,46:10,47:11,48:2,49:3,50:4,51:5,52:6,53:7,54:8,55:1,56:2,57:3,58:4,59:3,60:4,61:5,62:6,63:7,64:8,65:9,66:10,67:11,68:12,69:13,70:14,71:15,72:4,73:5,74:6,75:7,76:8,77:9,78:10,79:11,80:2,81:3,82:4,83:5,84:6,85:7,86:8,87:1,88:2,89:3,90:4,91:3,92:4,93:5,94:6,95:7,96:8,97:9,98:10,99:11,100:12,101:13,102:14,103:15,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:3,114:4,115:5,116:6,117:7,118:8},Gh={ALA:[.17,.5,.33],ARG:[.81,1.81,1],ASN:[.42,.85,.43],ASP:[1.23,3.64,2.41],ASH:[-.07,.43,.5],CYS:[-.24,-.02,.22],GLN:[.58,.77,.19],GLU:[2.02,3.63,1.61],GLH:[-.01,.11,.12],GLY:[.01,1.15,1.14],HIS:[.17,.11,-.06],ILE:[-.31,-1.12,-.81],LEU:[-.56,-1.25,-.69],LYS:[.99,2.8,1.81],MET:[-.23,-.67,-.44],PHE:[-1.13,-1.71,-.58],PRO:[.45,.14,-.31],SER:[.13,.46,.33],THR:[.14,.25,.11],TRP:[-1.85,-2.09,-.24],TYR:[-.94,-.71,.23],VAL:[.07,-.46,-.53]},Wh=[0,0,0],qh={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",ASH:"D",GLH:"E"},Xh=Object.keys(qh),Kh=["A","C","T","G","U"],Yh=["DA","DC","DT","DG","DU","TCY","MCY","5CM"],Zh=["A","G","DA","DG"],Jh=Kh.concat(Yh),Qh=["SOL","WAT","HOH","H2O","W","DOD","D3O","TIP3","TIP4","SPC"],ep=["118","119","1AL","1CU","2FK","2HP","2OF","3CO","3MT","3NI","3OF","3P8","4MO","4PU","543","6MO","ACT","AG","AL","ALF","AM","ATH","AU","AU3","AUC","AZI","BA","BCT","BEF","BF4","BO4","BR","BS3","BSY","CA","CAC","CD","CD1","CD3","CD5","CE","CHT","CL","CO","CO3","CO5","CON","CR","CS","CSB","CU","CU1","CU3","CUA","CUZ","CYN","DME","DMI","DSC","DTI","DY","E4N","EDR","EMC","ER3","EU","EU3","F","FE","FE2","FPO","GA","GD3","GEP","HAI","HG","HGC","IN","IOD","IR","IR3","IRI","IUM","K","KO4","LA","LCO","LCP","LI","LU","MAC","MG","MH2","MH3","MLI","MLT","MMC","MN","MN3","MN5","MN6","MO1","MO2","MO3","MO4","MO5","MO6","MOO","MOS","MOW","MW1","MW2","MW3","NA","NA2","NA5","NA6","NAO","NAW","NCO","NET","NH4","NI","NI1","NI2","NI3","NO2","NO3","NRU","O4M","OAA","OC1","OC2","OC3","OC4","OC5","OC6","OC7","OC8","OCL","OCM","OCN","OCO","OF1","OF2","OF3","OH","OS","OS4","OXL","PB","PBM","PD","PDV","PER","PI","PO3","PO4","PR","PT","PT4","PTN","RB","RH3","RHD","RU","SB","SCN","SE4","SEK","SM","SMO","SO3","SO4","SR","T1A","TB","TBA","TCN","TEA","TH","THE","TL","TMA","TRA","UNX","V","VN3","VO4","W","WO5","Y1","YB","YB2","YH","YT3","ZCM","ZN","ZN2","ZN3","ZNO","ZO3","OHX"],tp=["045","0AT","0BD","0MK","0NZ","0TS","0V4","0XY","0YT","10M","147","149","14T","15L","16G","18T","18Y","1AR","1BW","1GL","1GN","1JB","1LL","1NA","1S3","26M","26Q","26R","26V","26W","26Y","27C","289","291","293","2DG","2F8","2FG","2FL","2FP","2GL","2M4","2M5","32O","34V","3CM","3DO","3DY","3FM","3LR","3MF","3MG","3SA","3ZW","46D","46M","46Z","48Z","4CQ","4GC","4NN","50A","5DI","5GF","5MM","5RP","5SA","5SP","64K","6PG","6SA","7JZ","7SA","A1Q","A2G","AAB","AAL","AAO","ABC","ABD","ABE","ABF","ABL","ACG","ACI","ACR","ACX","ADA","ADG","ADR","AF1","AFD","AFL","AFO","AFP","AFR","AGC","AGH","AGL","AHR","AIG","ALL","ALX","AMU","AOG","AOS","ARA","ARB","ARE","ARI","ASG","ASO","AXP","AXR","B0D","B16","B2G","B4G","B6D","B8D","B9D","BBK","BCD","BDG","BDP","BDR","BEM","BFP","BGC","BGL","BGP","BGS","BHG","BMA","BMX","BNG","BNX","BOG","BRI","BXF","BXP","BXX","BXY","C3X","C4X","C5X","CAP","CBI","CBK","CBS","CDR","CEG","CGF","CHO","CR1","CR6","CRA","CT3","CTO","CTR","CTT","D6G","DAF","DAG","DDA","DDB","DDL","DEL","DFR","DFX","DG0","DGC","DGD","DGM","DGS","DIG","DLF","DLG","DMU","DNO","DOM","DP5","DQQ","DQR","DR2","DR3","DR4","DRI","DSR","DT6","DVC","E4P","E5G","EAG","EBG","EBQ","EGA","EJT","EPG","ERE","ERI","F1P","F1X","F6P","FBP","FCA","FCB","FCT","FDP","FDQ","FFC","FIX","FMO","FRU","FSI","FU4","FUB","FUC","FUD","FUL","FXP","G16","G1P","G2F","G3I","G4D","G4S","G6D","G6P","G6S","GAC","GAD","GAL","GC1","GC4","GCD","GCN","GCO","GCS","GCT","GCU","GCV","GCW","GCX","GE1","GFG","GFP","GIV","GL0","GL2","GL5","GL6","GL7","GL9","GLA","GLB","GLC","GLD","GLF","GLG","GLO","GLP","GLS","GLT","GLW","GMH","GN1","GNX","GP1","GP4","GPH","GPM","GQ1","GQ2","GQ4","GS1","GS4","GSA","GSD","GTE","GTH","GTK","GTR","GTZ","GU0","GU1","GU2","GU3","GU4","GU5","GU6","GU8","GU9","GUF","GUP","GUZ","GYP","GYV","H2P","HDL","HMS","HS2","HSD","HSG","HSH","HSJ","HSQ","HSR","HSU","HSX","HSY","HSZ","IAB","IDG","IDR","IDS","IDT","IDU","IDX","IDY","IMK","IN1","IPT","ISL","KBG","KD2","KDA","KDM","KDO","KFN","KO1","KO2","KTU","L6S","LAG","LAI","LAK","LAO","LAT","LB2","LBT","LCN","LDY","LGC","LGU","LM2","LMT","LMU","LOG","LOX","LPK","LSM","LTM","LVZ","LXB","LXZ","M1F","M3M","M6P","M8C","MA1","MA2","MA3","MAB","MAG","MAL","MAN","MAT","MAV","MAW","MBG","MCU","MDA","MDM","MDP","MFA","MFB","MFU","MG5","MGA","MGL","MLB","MMA","MMN","MN0","MRP","MTT","MUG","MVP","MXY","N1L","N9S","NAA","NAG","NBG","NDG","NED","NG1","NG6","NGA","NGB","NGC","NGE","NGF","NGL","NGS","NGY","NHF","NM6","NM9","NTF","NTO","NTP","NXD","NYT","OPG","OPM","ORP","OX2","P3M","P53","P6P","PA5","PNA","PNG","PNW","PRP","PSJ","PSV","PTQ","QDK","QPS","QV4","R1P","R1X","R2B","R5P","RAA","RAE","RAF","RAM","RAO","RAT","RB5","RBL","RCD","RDP","REL","RER","RF5","RG1","RGG","RHA","RIB","RIP","RNS","RNT","ROB","ROR","RPA","RST","RUB","RUU","RZM","S6P","S7P","SA0","SCR","SDD","SF6","SF9","SG4","SG5","SG6","SG7","SGA","SGC","SGD","SGN","SGS","SHB","SHG","SI3","SIO","SOE","SOL","SSG","SUC","SUP","SUS","T6P","T6T","TAG","TCB","TDG","TGK","TGY","TH1","TIA","TM5","TM6","TM9","TMR","TMX","TOA","TOC","TRE","TYV","UCD","UDC","VG1","X0X","X1X","X2F","X4S","X5S","X6X","XBP","XDN","XDP","XIF","XIM","XLF","XLS","XMM","XUL","XXR","XYP","XYS","YO5","Z3Q","Z6J","Z9M","ZDC","ZDM"],rp=["CA","C","N","O","O1","O2","OC1","OC2","OX1","OXT","H","H1","H2","H3","HA","HN","BB"],np=["P","O3'","O5'","C5'","C4'","C3'","OP1","OP2","O3*","O5*","C5*","C4*","C3*"],ip={};function op(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;default:return 8}}ip[1]={trace:"CA",direction1:"C",direction2:["O","OC1","O1","OX1","OXT"],backboneStart:"N",backboneEnd:"C"},ip[2]={trace:["C4'","C4*"],direction1:["C1'","C1*"],direction2:["C3'","C3*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},ip[3]={trace:["C3'","C3*"],direction1:["C2'","C2*"],direction2:["O4'","O4*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},ip[4]={trace:["CA","BB"],backboneStart:["CA","BB"],backboneEnd:["CA","BB"]},ip[5]={trace:["C4'","C4*","P"],backboneStart:["C4'","C4*","P"],backboneEnd:["C4'","C4*","P"]},ip[6]={trace:["C3'","C3*","C2'","P"],backboneStart:["C3'","C3*","C2'","P"],backboneEnd:["C3'","C3*","C2'","P"]},ip[Ih]={};var ap=new Map([[2,fs(180)],[3,fs(120)],[4,fs(109.4721)],[6,fs(90)]]);function sp(e,t){var r,n=new ft,i=new ft;return n.subVectors(t,e),e.eachBondedAtom(function(t){if(1!==t.number){i.subVectors(t,e);var o=n.angleTo(i);r=r?Math.min(r,o):o}}),r}function lp(e,t){var r=e.clone(),n=new ft;n.subVectors(t,e);var i=[new ft,new ft],o=0;if(e.eachBondedAtom(function(t){o>1||1!==t.number&&(r.index=t.index,i[o++].subVectors(t,e))}),1===o&&r.eachBondedAtom(function(t){o>1||1!==t.number&&t.index!==e.index&&i[o++].subVectors(t,e)}),2===o){var a=i[0].cross(i[1]);return Math.abs(Math.PI/2-a.angleTo(n))}}function up(e,t){var r=e.structure,n=r.atomCount,i=new Int8Array(n),o=new Int8Array(n),a=new Int8Array(n),s=new Int8Array(n);return r.eachAtom(function(e){var r=e.index,n=function(e,t){var r=e.bondToElementCount("H"),n=e.formalCharge||0,i="always"===t.assignCharge||"auto"===t.assignCharge&&0===n,o="always"===t.assignH||"auto"===t.assignH&&0===r,a=e.bondCount,s=function(e){var t=0;return e.eachBond(function(e){return t+=e.bondOrder}),t}(e),l=function(e){var t=e.structure.getBondProxy(),r=e.number,n=7===r||8===r;if(n&&4===e.bondCount)return!1;var i=!1;return e.eachBond(function(r){if(r.bondOrder>1)i=!0;else if(n){var o=r.getOtherAtom(e);o.eachBond(function(e){if(e.bondOrder>1){var t=o.number;if((15===t||16===t)&&8===e.getOtherAtom(o).number)return;i=!0}},t)}}),i}(e),u=s-a>0,c=0,h=8;switch(e.number){case 1:i&&(0===a?(n=1,h=0):1===a&&(n=0,h=1));break;case 6:i&&(n=0),o&&(c=Math.max(0,4-s-Math.abs(n))),h=op(a+c+Math.max(0,-n));break;case 7:i&&(n=o?l&&s<4?a-r==1&&s-r==2?1:0:1:s-3),o&&(c=Math.max(0,3-s+n)),h=op(l&&!u?a+c-n:a+c+1-n);break;case 8:i&&(o||(n=s-2),1===s&&e.eachBondedAtom(function(t){t.eachBond(function(r){var i=r.getOtherAtom(t);i.index!==e.index&&8===i.number&&2===r.bondOrder&&(n=-1)})})),o&&(c=Math.max(0,2-s+n)),h=op(l&&!u?a+c-n+1:a+c-n+2);break;case 16:i&&(o||(n=s<=3&&!e.bondToElementCount("O")?s-2:0)),o&&s<2&&(c=Math.max(0,2-s+n)),s<=3&&(h=op(a+c-n+2));break;case 9:case 17:case 35:case 53:case 85:i&&(n=s-1);break;case 3:case 11:case 19:case 37:case 55:case 87:i&&(n=1-s);break;case 4:case 12:case 20:case 38:case 56:case 88:i&&(n=2-s);break;default:console.warn("Requested charge, protonation for an unhandled element",e.element)}return[n,c,c+r,h]}(e,t),l=n[0],u=n[1],c=n[2],h=n[3];i[r]=l,o[r]=u,a[r]=c,s[r]=h}),{charge:i,implicitH:o,totalH:a,idealGeometry:s}}function cp(e){if(e["@valenceModel"])return e["@valenceModel"];var t=up(e,{assignCharge:"auto",assignH:"auto"});return e["@valenceModel"]=t,t}function hp(e){return 15===e.number&&e.bondToElementCount("O")===e.bondCount}function pp(e){var t=!1;return e.eachBondedAtom(function(e){e.aromatic&&(t=!0)}),t}var dp=["ARG","HIS","LYS"],fp=["GLU","ASP"];function mp(e,t,r){void 0===r&&(r={});for(var n=Ha(r.maxSaltBridgeDist,_p.maxSaltBridgeDist),i=Ha(r.maxPiStackingDist,_p.maxPiStackingDist),o=Ha(r.maxPiStackingOffset,_p.maxPiStackingOffset),a=Ha(r.maxPiStackingAngle,_p.maxPiStackingAngle),s=Ha(r.maxCationPiDist,_p.maxCationPiDist),l=Ha(r.maxCationPiOffset,_p.maxCationPiOffset),u=Math.max(n+2,i,s),c=i*i,h=s*s,p=t.features,d=t.spatialHash,f=t.contactStore,m=t.featureSet,g=p.types,v=p.centers,y=p.atomSets,b=v.x,w=v.y,x=v.z,_=g.length,S=e.atomStore.x,C=e.atomStore.y,M=e.atomStore.z,T=e.getAtomProxy(),A=e.getAtomProxy(),E=new ft,P=new ft,R=new ft,I=new ft,N=new ft,D=new ft,k=new ft,O=function(e,t){E.set(S[e[0]],C[e[0]],M[e[0]]),P.set(S[e[1]],C[e[1]],M[e[1]]),R.set(S[e[2]],C[e[2]],M[e[2]]),I.subVectors(E,P),N.subVectors(E,R),t.crossVectors(I,N)},F=function(e,t,r){return E.set(b[e],w[e],x[e]),P.set(b[t],w[t],x[t]),E.sub(P).projectOnPlane(r).add(P).distanceTo(P)},L=function(e,t,r){m.setBits(e,t),f.addContact(e,t,r)},U=function(e){d.eachWithin(b[e],w[e],x[e],u,function(t,r){if(!(t<=e||(T.index=y[e][0],A.index=y[t][0],Sp(T,A)))){var i=g[e],s=g[t];if(function(e,t){return 2===e&&1===t||1===e&&2===t}(i,s))(function(e,t,r){for(var n=e.length,i=t.length,o=0;o<n;++o){T.index=e[o];for(var a=0;a<i;++a)if(A.index=t[a],T.distanceTo(A)<=r)return!0}return!1})(y[e],y[t],n)&&L(e,t,1);else if(function(e,t){return 3===e&&3===t}(i,s)){if(r<=c){O(y[e],D),O(y[t],k);var u=function(e){return 57.29578*e}(D.angleTo(k));Math.min(F(e,t,k),F(t,e,D))<=o&&(u<=a||u>=180-a?L(e,t,3):u<=a+90&&u>=90-a&&L(e,t,3))}}else if(function(e,t){return 3===e&&1===t||1===e&&3===t}(i,s)&&r<=h){var p=3===i?[e,t]:[t,e],d=p[0],f=p[1];O(y[d],D),F(f,d,D)<=l&&L(d,f,2)}}})},V=0;V<_;++V)U(V)}function gp(e){return"HIS"===e.resname&&7==e.number&&e.isRing()}var vp=[17,35,53,85];var yp=[7,8,16],bp=[6,7,15,16];var wp=fs(165),xp=fs(120);var _p={maxHydrophobicDist:4,maxHbondDist:3.5,maxHbondSulfurDist:4.1,maxHbondAccAngle:60,maxHbondDonAngle:45,maxHbondAccDihedral:45,maxHbondDonDihedral:45,maxPiStackingDist:5.5,maxPiStackingOffset:2,maxPiStackingAngle:30,maxCationPiDist:6,maxCationPiOffset:1.5,maxSaltBridgeDist:6,maxHalogenBondDist:4,maxHalogenBondAngle:30,maxMetalDist:3,refineSaltBridges:!0};function Sp(e,t){return e.modelIndex!==t.modelIndex||e.residueIndex===t.residueIndex||e.altloc&&t.altloc&&e.altloc!==t.altloc}function Cp(e){var t={types:[],groups:[],centers:{x:[],y:[],z:[]},atomSets:[]};return vl&&gl.time("calculateFeatures"),function(e,t){var r=cp(e.data).charge,n={};e.eachResidue(function(e){if(dp.includes(e.resname)){var i=Sh(1);e.eachAtom(function(e){"N"===e.element&&e.isSidechain()&&Ch(i,e)}),Mh(t,i)}else Xh.includes(e.resname)||e.isNucleic()||(e.eachAtom(function(e){var r=!1,i=Sh(1);!function(e){var t=0;return 6===e.number&&3===e.bondCount&&3===e.bondToElementCount("N")&&e.eachBondedAtom(function(e){e.bondCount-e.bondToElementCount("H")==1&&++t}),2===t}(e)?function(e){var t=0;return 6===e.number&&3===e.bondCount&&2===e.bondToElementCount("N")&&1===e.bondToElementCount("C")&&e.eachBondedAtom(function(e){e.bondCount-e.bondToElementCount("H")==1&&++t}),2===t}(e)&&(i.group=9,r=!0):(i.group=8,r=!0),r&&(e.eachBondedAtom(function(e){7===e.number&&(n[e.index]=!0,Ch(i,e))}),Mh(t,i))}),e.eachAtom(function(e){var i=Sh(1);r[e.index]>0&&(n[e.index]||(Ch(i,e),Mh(t,i)))}))})}(e,t),function(e,t){var r=cp(e.data).charge,n={};e.eachResidue(function(e){if(fp.includes(e.resname)){var i=Sh(2);e.eachAtom(function(e){"O"===e.element&&e.isSidechain()&&Ch(i,e)}),Mh(t,i)}else if(Jh.includes(e.resname)){var o=Sh(2);e.eachAtom(function(e){hp(e)&&(o.group=6,e.eachBondedAtom(function(e){8===e.number&&Ch(o,e)}),Mh(t,o))})}else Xh.includes(e.resname)||Jh.includes(e.resname)||(e.eachAtom(function(e){var r=!1,i=Sh(2);!function(e){return 16===e.number&&3===e.bondToElementCount("O")}(e)?hp(e)?(i.group=6,r=!0):function(e){return 16===e.number&&4===e.bondToElementCount("O")}(e)?(i.group=5,r=!0):function(e){var t=0;return 6===e.number&&2===e.bondToElementCount("O")&&1===e.bondToElementCount("C")&&e.eachBondedAtom(function(e){e.bondCount-e.bondToElementCount("H")==1&&++t}),2===t}(e)&&(i.group=10,r=!0):(i.group=4,r=!0),r&&(e.eachBondedAtom(function(e){8===e.number&&(n[e.index]=!0,Ch(i,e))}),Mh(t,i))}),e.eachAtom(function(e){var i=Sh(2);r[e.index]<0&&(n[e.index]||(Ch(i,e),Mh(t,i)))}))})}(e,t),function(e,t){var r=e.getAtomProxy();e.eachResidue(function(e){var n=e.getAromaticRings();if(n){var i=e.atomOffset;n.forEach(function(e){var n=Sh(3);e.forEach(function(e){r.index=e+i,Ch(n,r)}),Mh(t,n)})}})}(e,t),function(e,t){var r=cp(e.data),n=r.charge,i=r.implicitH,o=r.idealGeometry;e.eachAtom(function(e){var r=Sh(5),a=e.number;if(8===a)Ch(r,e),Mh(t,r);else if(7===a){if(gp(e))Ch(r,e),Mh(t,r);else if(n[e.index]<1){var s=e.bondCount+i[e.index],l=o[e.index];(4===l&&s<4||3===l&&s<3||2===l&&s<2)&&(Ch(r,e),Mh(t,r))}}else 16===a&&("CYS"!==e.resname&&"MET"!==e.resname&&-1!==e.formalCharge||(Ch(r,e),Mh(t,r)))})}(e,t),function(e,t){var r=cp(e.data).totalH;e.eachAtom(function(e){var n=Sh(4),i=e.number;gp(e)?(Ch(n,e),Mh(t,n)):r[e.index]>0&&(7===i||8===i||16===i)&&(Ch(n,e),Mh(t,n))})}(e,t),function(e,t){var r=cp(e.data).totalH;e.eachAtom(function(e){if(6===e.number&&r[e.index]>0&&(e.bondToElementCount("N")>0||e.bondToElementCount("O")>0||function(e){if(!e.isAromatic())return!1;var t=e.residueType.getRings();if(!t)return!1;var r=!1;return t.rings.forEach(function(t){r||t.some(function(t){return e.index-e.residueAtomOffset===t})&&(r=t.some(function(t){var r=e.residueType.atomTypeIdList[t],n=e.atomMap.get(r).number;return 7===n||8===n}))}),r}(e))){var n=Sh(11);Ch(n,e),Mh(t,n)}})}(e,t),function(e,t){var r=cp(e.data).charge;e.eachAtom(function(e){var n=Sh(9),i=e.resname,o=e.element,a=e.atomname;if(e.isProtein())if("O"===o){if(["ASP","GLU","SER","THR","TYR"].includes(i)&&e.isSidechain())return Ch(n,e),void Mh(t,n);if(e.isBackbone())return Ch(n,e),void Mh(t,n)}else{if("S"===o&&"CYS"===i)return Ch(n,e),void Mh(t,n);if("N"===o&&"HIS"===i&&e.isSidechain())return Ch(n,e),void Mh(t,n)}else if(e.isNucleic()){if(["C","DC"].includes(i)&&["O2","N3","N4","C5"].includes(a)||["T","DT"].includes(i)&&["O2","N3","O4"].includes(a)||["U","DU"].includes(i)&&["O2","N3","O4","C5"].includes(a)||["G","DG"].includes(i)&&["N3","N7","O6"].includes(a)||["A","DA"].includes(i)&&["N1","N7","N3"].includes(a))return Ch(n,e),void Mh(t,n)}else if(!e.isPolymer())if("O"===o){if(0===e.bondCount||e.isWater())return Ch(n,e),void Mh(t,n);if(2===e.bondCount&&r[e.index]||e.hasBondToElement("H"))return Ch(n,e),void Mh(t,n);if(pp(e)&&!e.aromatic)return Ch(n,e),void Mh(t,n);if(1===e.bondToElementCount("C")){var s=!1;if(e.eachBondedAtom(function(e){"C"===e.element&&2===e.bondToElementCount("O")&&1===e.bondToElementCount("C")&&(s=!0)}),s)return Ch(n,e),void Mh(t,n)}if(1===e.bondToElementCount("P")){var l=!1;if(e.eachBondedAtom(function(e){"P"===e.element&&e.bondToElementCount("O")>=3&&(l=!0)}),l)return Ch(n,e),void Mh(t,n)}}else if("N"===o){if(2===e.bondToElementCount("C"))return Ch(n,e),void Mh(t,n)}else if("S"===o){if(pp(e)&&!e.aromatic)return Ch(n,e),void Mh(t,n);var u=e.bondToElementCount("FE");if(u>0&&u===e.bondCount)return Ch(n,e),void Mh(t,n)}})}(e,t),function(e,t){e.eachAtom(function(e){if(e.isMetal()){var r=Sh(8);Ch(r,e),Mh(t,r)}})}(e,t),function(e,t){e.eachAtom(function(e){var r=Sh(10),n=!1;6===e.number&&(n=!0,e.eachBondedAtom(function(e){var t=e.number;6!==t&&1!==t&&(n=!1)})),n&&(Ch(r,e),Mh(t,r))})}(e,t),function(e,t){e.eachAtom(function(e){if(yp.includes(e.number)){var r=!1;if(e.eachBondedAtom(function(e){bp.includes(e.number)&&(r=!0)}),r){var n=Sh(7);Ch(n,e),Mh(t,n)}}})}(e,t),function(e,t){e.eachAtom(function(e){if(vp.includes(e.number)&&1===e.bondToElementCount("C")){var r=Sh(6);Ch(r,e),Mh(t,r)}})}(e,t),vl&&gl.timeEnd("calculateFeatures"),t}function Mp(e,t){void 0===t&&(t=_p);var r=function(e){var t=e.types,r=e.centers;return{features:e,spatialHash:new vh(r),contactStore:new bh,featureSet:new xh(t.length,!1)}}(Cp(e));vl&&gl.time("calculateContacts"),mp(e,r,t),function(e,t,r){void 0===r&&(r={});for(var n=Ha(r.maxHbondDist,_p.maxHbondDist),i=Ha(r.maxHbondSulfurDist,_p.maxHbondSulfurDist),o=fs(Ha(r.maxHbondAccAngle,_p.maxHbondAccAngle)),a=fs(Ha(r.maxHbondDonAngle,_p.maxHbondDonAngle)),s=fs(Ha(r.maxHbondAccDihedral,_p.maxHbondAccDihedral)),l=fs(Ha(r.maxHbondDonDihedral,_p.maxHbondDonDihedral)),u=Math.max(n,i),c=n*n,h=t.features,p=t.spatialHash,d=t.contactStore,f=t.featureSet,m=h.types,g=h.centers,v=h.atomSets,y=g.x,b=g.y,w=g.z,x=m.length,_=cp(e.data).idealGeometry,S=e.getAtomProxy(),C=e.getAtomProxy(),M=function(e){p.eachWithin(y[e],b[e],w[e],u,function(t,r){if(!(t<=e)){var n=m[e],i=m[t],u=function(e,t){return 11===e&&5===t||5===e&&11===t}(n,i);if(u||function(e,t){return 5===e&&4===t||4===e&&5===t}(n,i)){var h=5===m[t]?[e,t]:[t,e],p=h[0],g=h[1];if(S.index=v[p][0],C.index=v[g][0],!(Sp(S,C)||16!==S.number&&16!==C.number&&r>c)){var y=sp(S,C);if(void 0!==y){var b=ap.get(_[S.index])||fs(120);if(Math.abs(b-y)>a)return}if(3===_[S.index]){var w=lp(S,C);if(void 0!==w&&w>l)return}var x=sp(C,S);if(void 0!==x){var M=ap.get(_[C.index])||fs(120);if(Math.abs(M-x)>o)return}if(3===_[C.index]){var T=lp(C,S);if(void 0!==T&&T>s)return}f.setBits(p,g);var A=u?8:function(e,t){return function(e,t){return e.isWater()&&t.isWater()}(e,t)?9:function(e,t){return e.isBackbone()&&t.isBackbone()}(e,t)?10:4}(S,C);d.addContact(p,g,A)}}}})},T=0;T<x;++T)M(T)}(e,r,t),function(e,t,r){void 0===r&&(r={});for(var n=Ha(r.maxMetalDist,_p.maxMetalDist),i=t.features,o=t.spatialHash,a=t.contactStore,s=t.featureSet,l=i.types,u=i.centers,c=i.atomSets,h=u.x,p=u.y,d=u.z,f=l.length,m=e.getAtomProxy(),g=e.getAtomProxy(),v=function(e){o.eachWithin(h[e],p[e],d[e],n,function(t,r){t<=e||(m.index=c[e][0],g.index=c[t][0],Sp(m,g)||function(e,t){return 8===e&&9===t||9===e&&8===t}(l[e],l[t])&&(s.setBits(e,t),a.addContact(e,t,7)))})},y=0;y<f;++y)v(y)}(e,r,t),function(e,t,r){void 0===r&&(r={});for(var n=Ha(r.maxHydrophobicDist,_p.maxHydrophobicDist),i=t.features,o=t.spatialHash,a=t.contactStore,s=t.featureSet,l=i.types,u=i.centers,c=i.atomSets,h=u.x,p=u.y,d=u.z,f=l.length,m=e.getAtomProxy(),g=e.getAtomProxy(),v=function(e){o.eachWithin(h[e],p[e],d[e],n,function(t,r){t<=e||(m.index=c[e][0],g.index=c[t][0],Sp(m,g)||function(e,t){return 10===e&&10===t}(l[e],l[t])&&(s.setBits(e,t),a.addContact(e,t,6)))})},y=0;y<f;++y)v(y)}(e,r,t),function(e,t,r){void 0===r&&(r={});for(var n=Ha(r.maxHalogenBondDist,_p.maxHalogenBondDist),i=fs(Ha(r.maxHalogenBondAngle,_p.maxHalogenBondAngle)),o=t.features,a=t.spatialHash,s=t.contactStore,l=t.featureSet,u=o.types,c=o.centers,h=o.atomSets,p=c.x,d=c.y,f=c.z,m=u.length,g=e.getAtomProxy(),v=e.getAtomProxy(),y=function(e){a.eachWithin(p[e],d[e],f[e],n,function(t,r){if(!(t<=e)&&(g.index=h[e][0],v.index=h[t][0],!Sp(g,v)&&function(e,t){return 7===e&&6===t||6===e&&7===t}(u[e],u[t]))){var n=6===u[e]?[g,v]:[v,g],o=n[0],a=n[1],c=sp(o,a);if(void 0!==c&&!(wp-c>i)){var p=sp(a,o);void 0!==p&&(xp-p>i||(l.setBits(e,t),s.addContact(e,t,5)))}}})},b=0;b<m;++b)y(b)}(e,r,t);var n=function(e){var t=e.contactStore,r=_h({nodeArray1:t.index1,nodeArray2:t.index2,edgeCount:t.count,nodeCount:e.featureSet.length}),n=new xh(e.contactStore.count,!0);return Object.assign({adjacencyList:r,contactSet:n},e)}(r);return function(e,t){var r=t.contactSet,n=t.contactStore,i=t.features,o=n.type,a=n.index1,s=n.index2,l=i.atomSets,u=e.getAtomProxy(),c=e.getAtomProxy(),h={},p=function(e,t,n){var i=h[n]||[1/0,-1],o=i[0],a=i[1];e<o?(-1!==a&&r.clear(a),h[n]=[e,t]):r.clear(t)};r.forEach(function(e){if(6===o[e]){u.index=l[a[e]][0],c.index=l[s[e]][0];var t=u.distanceTo(c);p(t,e,u.index+"|"+c.residueIndex),p(t,e,c.index+"|"+u.residueIndex)}})}(e,n),t.refineSaltBridges&&function(e,t){var r=t.contactSet,n=t.contactStore,i=t.features,o=n.type,a=n.index1,s=n.index2,l=i.atomSets,u={},c=function(e,t){u[e]||(u[e]=[]),u[e].push(t)};r.forEach(function(e){1===o[e]&&(l[a[e]].forEach(function(t){return c(t,e)}),l[s[e]].forEach(function(t){return c(t,e)}))}),r.forEach(function(e){if(function(e){return 4===e||9===e||10===e}(o[e])){var t=u[l[a[e]][0]],n=u[l[s[e]][0]];if(t&&n)for(var i=t.length,c=0;c<i;++c)if(n.includes(t[c]))return void r.clear(e)}})}(0,n),function(e,t){var r=t.contactSet,n=t.contactStore,i=t.features,o=n.type,a=n.index1,s=n.index2,l=i.atomSets,u={},c=function(e,t){u[e]||(u[e]=[]),u[e].push(t)};r.forEach(function(e){3===o[e]&&(l[a[e]].forEach(function(t){return c(t,e)}),l[s[e]].forEach(function(t){return c(t,e)}))}),r.forEach(function(e){if(6===o[e]||2===o[e]){var t=u[l[a[e]][0]],n=u[l[s[e]][0]];if(t&&n)for(var i=t.length,c=0;c<i;++c)if(n.includes(t[c]))return void r.clear(e)}})}(0,n),vl&&gl.timeEnd("calculateContacts"),n}var Tp={hydrogenBond:!0,hydrophobic:!0,halogenBond:!0,saltBridge:!0,metalComplex:!0,cationPi:!0,piStacking:!0,weakHydrogenBond:!0,waterHydrogenBond:!0,backboneHydrogenBond:!0,radius:1},Ap=new ur;function Ep(e,t,r){var n=$a(r,Tp),i=[];n.hydrogenBond&&i.push(4),n.hydrophobic&&i.push(6),n.halogenBond&&i.push(5),n.saltBridge&&i.push(1),n.metalComplex&&i.push(7),n.cationPi&&i.push(2),n.piStacking&&i.push(3),n.weakHydrogenBond&&i.push(8),n.waterHydrogenBond&&i.push(9),n.backboneHydrogenBond&&i.push(10);var o=e.features,a=e.contactSet,s=e.contactStore,l=o.centers,u=l.x,c=l.y,h=l.z,p=s.index1,d=s.index2,f=s.type,m=[],g=[],v=[],y=[],b=[];return a.forEach(function(e){var t=f[e];if(i.includes(t)){var r=p[e],o=d[e];m.push(u[r],c[r],h[r]),g.push(u[o],c[o],h[o]),v.push.apply(v,function(e){switch(e){case 4:case 9:case 10:return Ap.setHex(2851770).toArray();case 6:return Ap.setHex(8421504).toArray();case 5:return Ap.setHex(4259775).toArray();case 1:return Ap.setHex(15779860).toArray();case 7:return Ap.setHex(9191577).toArray();case 2:return Ap.setHex(16744448).toArray();case 3:return Ap.setHex(9220966).toArray();case 8:return Ap.setHex(12967404).toArray();default:return Ap.setHex(13421772).toArray()}}(t)),y.push(n.radius),b.push(e)}}),{position1:new Float32Array(m),position2:new Float32Array(g),color:new Float32Array(v),radius:new Float32Array(y),picking:new Lp(b,e,t)}}var Pp=function(e){this.array=e},Rp={type:{configurable:!0},data:{configurable:!0}};Rp.type.get=function(){return""},Rp.data.get=function(){return{}},Pp.prototype.getIndex=function(e){return this.array?this.array[e]:e},Pp.prototype.getObject=function(e){return{}},Pp.prototype._applyTransformations=function(e,t,r){return t&&e.applyMatrix4(t.matrix),r&&e.applyMatrix4(r.matrix),e},Pp.prototype._getPosition=function(){return new ft},Pp.prototype.getPosition=function(e,t,r){return this._applyTransformations(this._getPosition(e),t,r)},Object.defineProperties(Pp.prototype,Rp);var Ip=function(e){function t(t){e.call(this),this.shape=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0},data:{configurable:!0},type:{configurable:!0}};return r.primitive.get=function(){},r.data.get=function(){return this.shape},r.type.get=function(){return this.primitive.type},t.prototype.getObject=function(e){return this.primitive.objectFromShape(this.shape,e)},t.prototype._getPosition=function(e){return this.primitive.positionFromShape(this.shape,e)},Object.defineProperties(t.prototype,r),t}(Pp),Np=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return hh},Object.defineProperties(t.prototype,r),t}(Ip),Dp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return ph},Object.defineProperties(t.prototype,r),t}(Ip),kp=function(e){function t(t,r){e.call(this,t),this.structure=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"atom"},r.data.get=function(){return this.structure},t.prototype.getObject=function(e){return this.structure.getAtomProxy(this.getIndex(e))},t.prototype._getPosition=function(e){return(new ft).copy(this.getObject(e))},Object.defineProperties(t.prototype,r),t}(Pp),Op=function(e){function t(t){e.call(this),this.axes=t}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"axes"},r.data.get=function(){return this.axes},t.prototype.getObject=function(){return{axes:this.axes}},t.prototype._getPosition=function(){return this.axes.center.clone()},Object.defineProperties(t.prototype,r),t}(Pp),Fp=function(e){function t(t,r,n){e.call(this,t),this.structure=r,this.bondStore=n||r.bondStore}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"bond"},r.data.get=function(){return this.structure},t.prototype.getObject=function(e){var t=this.structure.getBondProxy(this.getIndex(e));return t.bondStore=this.bondStore,t},t.prototype._getPosition=function(e){var t=this.getObject(e);return(new ft).copy(t.atom1).add(t.atom2).multiplyScalar(.5)},Object.defineProperties(t.prototype,r),t}(Pp),Lp=function(e){function t(t,r,n){e.call(this,t),this.contacts=r,this.structure=n}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"contact"},r.data.get=function(){return this.contacts},t.prototype.getObject=function(e){var t=this.getIndex(e),r=this.contacts,n=r.features,i=r.contactStore,o=n.centers,a=n.atomSets,s=o.x,l=o.y,u=o.z,c=i.index1,h=i.index2,p=i.type,d=c[t],f=h[t];return{center1:new ft(s[d],l[d],u[d]),center2:new ft(s[f],l[f],u[f]),atom1:this.structure.getAtomProxy(a[d][0]),atom2:this.structure.getAtomProxy(a[f][0]),type:function(e){switch(e){case 4:case 9:case 10:return"hydrogen bond";case 6:return"hydrophobic contact";case 5:return"halogen bond";case 1:return"salt bridge";case 7:return"metal complexation";case 2:return"cation-pi interaction";case 3:return"pi-pi stacking";case 8:return"weak hydrogen bond";default:return"unknown contact"}}(p[t])}},t.prototype._getPosition=function(e){var t=this.getObject(e),r=t.center1,n=t.center2;return(new ft).addVectors(r,n).multiplyScalar(.5)},Object.defineProperties(t.prototype,r),t}(Pp),Up=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return dh},Object.defineProperties(t.prototype,r),t}(Ip),Vp=function(e){function t(t,r,n){e.call(this,t),this.validation=r,this.structure=n}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"clash"},r.data.get=function(){return this.validation},t.prototype.getObject=function(e){var t=this.validation,r=this.getIndex(e);return{validation:t,index:r,clash:t.clashArray[r]}},t.prototype._getAtomProxyFromSele=function(e){var t=new el(e),r=this.structure.getAtomIndices(t)[0];return this.structure.getAtomProxy(r)},t.prototype._getPosition=function(e){var t=this.getObject(e).clash,r=this._getAtomProxyFromSele(t.sele1),n=this._getAtomProxyFromSele(t.sele2);return(new ft).copy(r).add(n).multiplyScalar(.5)},Object.defineProperties(t.prototype,r),t}(Pp),Bp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"distance"},Object.defineProperties(t.prototype,r),t}(Fp),zp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return fh},Object.defineProperties(t.prototype,r),t}(Ip),jp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return uh},Object.defineProperties(t.prototype,r),t}(Ip),Hp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return lh},Object.defineProperties(t.prototype,r),t}(Ip),$p=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"ignore"},Object.defineProperties(t.prototype,r),t}(Pp),Gp=function(e){function t(t,r){e.call(this,t),this.mesh=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"mesh"},t.prototype.getObject=function(){var e=this.mesh;return{shape:this.shape,name:e.name,serial:e.serial}},t.prototype._getPosition=function(){return this.__position||(this.__position=Fc(this.mesh.position)),this.__position},Object.defineProperties(t.prototype,r),t}(Ip),Wp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return sh},Object.defineProperties(t.prototype,r),t}(Ip),qp=function(e){function t(t,r){e.call(this,t),this.surface=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"surface"},r.data.get=function(){return this.surface},t.prototype.getObject=function(e){return{surface:this.surface,index:this.getIndex(e)}},t.prototype._getPosition=function(){return this.surface.center.clone()},Object.defineProperties(t.prototype,r),t}(Pp),Xp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return ch},Object.defineProperties(t.prototype,r),t}(Ip),Kp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={primitive:{configurable:!0}};return r.primitive.get=function(){return mh},Object.defineProperties(t.prototype,r),t}(Ip),Yp=function(e){function t(t,r){e.call(this),this.unitcell=t,this.structure=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"unitcell"},r.data.get=function(){return this.unitcell},t.prototype.getObject=function(){return{unitcell:this.unitcell,structure:this.structure}},t.prototype._getPosition=function(){return this.unitcell.getCenter(this.structure)},Object.defineProperties(t.prototype,r),t}(Pp),Zp=(function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};r.type.get=function(){return"unknown"},Object.defineProperties(t.prototype,r)}(Pp),function(e){function t(t,r){e.call(this,t),this.volume=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},data:{configurable:!0}};return r.type.get=function(){return"volume"},r.data.get=function(){return this.volume},t.prototype.getObject=function(e){var t=this.volume,r=this.getIndex(e);return{volume:t,index:r,value:t.data[r]}},t.prototype._getPosition=function(e){var t=this.volume.position,r=this.getIndex(e);return new ft(t[3*r],t[3*r+1],t[3*r+2])},Object.defineProperties(t.prototype,r),t}(Pp)),Jp=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"slice"},Object.defineProperties(t.prototype,r),t}(Zp);function Qp(){return new Uint32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0])}function ed(){return new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1])}function td(){return[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]]}function rd(e,t,r,n,i){var o,a,s,l,u,c,h,p=0,d=!1,f=!1,m=!1,g=t*r*n,v=t,y=t*r,b=new Int32Array(12),w=[],x=[],_=[],S=[],C=Qp(),M=ed(),T=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]];function A(e,t,r){return e+(t-e)*r}function E(e,i,o){return y*(o=(o+h)%n)+v*(i=(i+c)%r)+(e=(e+u)%t)}function P(e,t,r,n,l,u,c){var h=f?3*e:e;if(a[h]<0){var m=(p-u)/(c-u),g=o,v=3*s;if(w[v+0]=r+m,w[v+1]=n,w[v+2]=l,!d){var y=3*e;x[v]=-A(g[y],g[y+3],m),x[v+1]=-A(g[y+1],g[y+4],m),x[v+2]=-A(g[y+2],g[y+5],m)}i&&(S[s]=i[e+Math.round(m)]),a[h]=s,b[t]=s,s+=1}else b[t]=a[h]}function R(e,t,r,n,l,u,c){var h=f?3*e+1:e;if(a[h]<0){var m=(p-u)/(c-u),g=o,y=3*s;if(w[y]=r,w[y+1]=n+m,w[y+2]=l,!d){var _=3*e,C=_+3*v;x[y]=-A(g[_],g[C],m),x[y+1]=-A(g[_+1],g[C+1],m),x[y+2]=-A(g[_+2],g[C+2],m)}i&&(S[s]=i[e+Math.round(m)*v]),a[h]=s,b[t]=s,s+=1}else b[t]=a[h]}function I(e,t,r,n,l,u,c){var h=f?3*e+2:e;if(a[h]<0){var m=(p-u)/(c-u),g=o,v=3*s;if(w[v]=r,w[v+1]=n,w[v+2]=l+m,!d){var _=3*e,C=_+3*y;x[v]=-A(g[_],g[C],m),x[v+1]=-A(g[_+1],g[C+1],m),x[v+2]=-A(g[_+2],g[C+2],m)}i&&(S[s]=i[e+Math.round(m)*y]),a[h]=s,b[t]=s,s+=1}else b[t]=a[h]}function N(t){var r=3*t;0===o[r]&&(o[r]=e[(t-1+g)%g]-e[(t+1)%g],o[r+1]=e[(t-v+g)%g]-e[(t+v)%g],o[r+2]=e[(t-y+g)%g]-e[(t+y)%g])}function D(t,r,n,i,o){var a,s,u,c,h,g,w;m?(i=E(t,r,n),a=E(t+1,r,n),s=E(t,r+1,n),u=E(t,r,n+1),c=E(t+1,r+1,n),h=E(t+1,r,n+1),g=E(t,r+1,n+1),w=E(t+1,r+1,n+1)):(a=i+1,c=(s=i+v)+1,h=(u=i+y)+1,w=(g=s+y)+1);var x=0,S=e[i],A=e[a],D=e[s],k=e[c],O=e[u],F=e[h],L=e[g],U=e[w];S<p&&(x|=1),A<p&&(x|=2),D<p&&(x|=8),k<p&&(x|=4),O<p&&(x|=16),F<p&&(x|=32),L<p&&(x|=128),U<p&&(x|=64);var V=C[x];if(0===V)return 0;var B=t+1,z=r+1,j=n+1;1&V&&(d||(N(i),N(a)),P(i,0,t,r,n,S,A)),2&V&&(d||(N(a),N(c)),R(a,1,B,r,n,A,k)),4&V&&(d||(N(s),N(c)),P(s,2,t,z,n,D,k)),8&V&&(d||(N(i),N(s)),R(i,3,t,r,n,S,D)),16&V&&(d||(N(u),N(h)),P(u,4,t,r,j,O,F)),32&V&&(d||(N(h),N(w)),R(h,5,B,r,j,F,U)),64&V&&(d||(N(g),N(w)),P(g,6,t,z,j,L,U)),128&V&&(d||(N(u),N(g)),R(u,7,t,r,j,O,L)),256&V&&(d||(N(i),N(u)),I(i,8,t,r,n,S,O)),512&V&&(d||(N(a),N(h)),I(a,9,B,r,n,A,F)),1024&V&&(d||(N(c),N(w)),I(c,10,B,z,n,k,U)),2048&V&&(d||(N(s),N(g)),I(s,11,t,z,n,D,L));for(var H,$,G,W=x<<4,q=0;-1!==M[W+q];)H=M[W+q],$=M[W+q+1],G=M[W+q+2],f?(T[H][$]&o&&(_[l++]=b[H],_[l++]=b[$]),T[$][G]&o&&(_[l++]=b[$],_[l++]=b[G]),T[H][G]&o&&(_[l++]=b[H],_[l++]=b[G])):(_[l++]=b[$],_[l++]=b[H],_[l++]=b[G]),q+=3}function k(i,o,s,l,u,c){var h,g,b,w,x,_,S,C,M,T,A,P,R;if(i=void 0!==i?i:0,o=void 0!==o?o:0,s=void 0!==s?s:0,l=void 0!==l?l:t-1,u=void 0!==u?u:r-1,c=void 0!==c?c:n-1,m||(d?(i=Math.max(0,i),o=Math.max(0,o),s=Math.max(0,s),l=Math.min(t-1,l),u=Math.min(r-1,u),c=Math.min(n-1,c)):(i=Math.max(1,i),o=Math.max(1,o),s=Math.max(1,s),l=Math.min(t-2,l),u=Math.min(r-2,u),c=Math.min(n-2,c))),m)for(C=i-2,M=o-2,A=l+2,P=u+2,R=c+2,x=T=s-2;x<R;++x)for(w=M;w<P;++w)for(b=C;b<A;++b)f?(g=3*E(b,w,x),a[g]=-1,a[g+1]=-1,a[g+2]=-1):(h=E(b,w,x),a[h]=-1);else for(C=Math.max(0,i-2),M=Math.max(0,o-2),T=Math.max(0,s-2),A=Math.min(t,l+2),P=Math.min(r,u+2),R=Math.min(n,c+2),x=T;x<R;++x)for(S=y*x,w=M;w<P;++w)for(_=S+v*w,b=C;b<A;++b)f?(a[h=3*(_+b)]=-1,a[h+1]=-1,a[h+2]=-1):a[h=_+b]=-1;if(!m){var I,N=i,k=o,O=s,F=l,L=u,U=c;for(I=!1,x=s;x<c;++x){for(w=o;w<u;++w){for(b=i;b<l;++b)if(e[h=t*r*x+t*w+b]>=p){O=x,I=!0;break}if(I)break}if(I)break}for(I=!1,w=o;w<u;++w){for(x=O;x<c;++x){for(b=i;b<l;++b)if(e[h=t*r*x+t*w+b]>=p){k=w,I=!0;break}if(I)break}if(I)break}for(I=!1,b=i;b<l;++b){for(w=k;w<u;++w){for(x=O;x<c;++x)if(e[h=t*r*x+t*w+b]>=p){N=b,I=!0;break}if(I)break}if(I)break}for(I=!1,x=c;x>=s;--x){for(w=u;w>=o;--w){for(b=l;b>=i;--b)if(e[h=t*r*x+t*w+b]>=p){U=x,I=!0;break}if(I)break}if(I)break}for(I=!1,w=u;w>=o;--w){for(x=U;x>=s;--x){for(b=l;b>=i;--b)if(e[h=t*r*x+t*w+b]>=p){L=w,I=!0;break}if(I)break}if(I)break}for(I=!1,b=l;b>=i;--b){for(w=L;w>=o;--w){for(x=U;x>=s;--x)if(e[h=t*r*x+t*w+b]>=p){F=b,I=!0;break}if(I)break}if(I)break}d?(i=Math.max(0,N-1),o=Math.max(0,k-1),s=Math.max(0,O-1),l=Math.min(t-1,F+1),u=Math.min(r-1,L+1),c=Math.min(n-1,U+1)):(i=Math.max(1,N-1),o=Math.max(1,k-1),s=Math.max(1,O-1),l=Math.min(t-2,F+1),u=Math.min(r-2,L+1),c=Math.min(n-2,U+1))}var V=15;for(x=s;x<c;++x,V&=-5)for(S=y*x,V|=2,w=o;w<u;++w,V&=-3)for(_=S+v*w,V|=1,b=i;b<l;++b,V&=-2)D(b,w,x,h=_+b,V)}this.triangulate=function(e,v,y,b,C){p=e,f=b,m=C,(d=v||f)||o||(o=new Float32Array(3*g));var M=f?3*g:g;if(a&&a.length===M||(a=new Int32Array(M)),s=0,l=0,void 0!==y){var T=y[0].map(Math.round),A=y[1].map(Math.round);u=t*Math.ceil(Math.abs(T[0])/t),c=r*Math.ceil(Math.abs(T[1])/r),h=n*Math.ceil(Math.abs(T[2])/n),k(T[0],T[1],T[2],A[0],A[1],A[2])}else u=c=h=0,k();return w.length=3*s,d||(x.length=3*s),_.length=l,i&&(S.length=s),{position:new Float32Array(w),normal:d?void 0:new Float32Array(x),index:is(_,w.length/3),atomindex:i?new Int32Array(S):void 0,contour:f}}}Il.add("arrow",Dp),Il.add("box",Hp),Il.add("cone",Up),Il.add("cylinder",Np),Il.add("ellipsoid",zp),Il.add("octahedron",jp),Il.add("sphere",Wp),Il.add("tetrahedron",Xp),Il.add("torus",Kp),rd.__deps=[Qp,ed,td,is];var nd=function(e,t){this.cols=e,this.rows=t,this.size=this.cols*this.rows,this.data=new Float32Array(this.size)};function id(e,t){for(var r=0,n=0,i=t.rows,o=t.cols,a=0,s=0,l=0,u=t.data,c=e.data;r<i;s+=1,a+=o,r++)for(l=s,n=0;n<o;l+=i,n++)c[l]=u[a+n]}function od(e,t,r){for(var n=0,i=0,o=0,a=0,s=0,l=0,u=0,c=t.cols,h=t.rows,p=r.rows,d=t.data,f=r.data,m=e.data,g=0;n<h;a+=c,n++)for(l=0,i=0;i<p;u++,i++){for(s=a,g=0,o=0;o<c;s++,l++,o++)g+=d[s]*f[l];m[u]=g}}function ad(e,t,r){var n=e.data,i=t.data,o=r.data,a=i[0],s=i[1],l=i[2],u=i[3],c=i[4],h=i[5],p=i[6],d=i[7],f=i[8],m=o[0],g=o[1],v=o[2],y=o[3],b=o[4],w=o[5],x=o[6],_=o[7],S=o[8];n[0]=a*m+s*y+l*x,n[1]=a*g+s*b+l*_,n[2]=a*v+s*w+l*S,n[3]=u*m+c*y+h*x,n[4]=u*g+c*b+h*_,n[5]=u*v+c*w+h*S,n[6]=p*m+d*y+f*x,n[7]=p*g+d*b+f*_,n[8]=p*v+d*w+f*S}function sd(e){for(var t=e.rows,r=e.cols,n=e.data,i=new Array(r),o=0;o<r;++o)i[o]=0;for(var a=0,s=0;a<t;++a)for(var l=0;l<r;++l,++s)i[l]+=n[s];for(var u=0;u<r;++u)i[u]/=t;return i}function ld(e,t){for(var r=e.rows,n=e.cols,i=e.data,o=0,a=0;o<r;++o)for(var s=0;s<n;++s,++a)i[a]-=t[s]}function ud(e,t,r,n){n=e[t],e[t]=e[r],e[r]=n}function cd(e,t){return(e=Math.abs(e))>(t=Math.abs(t))?(t/=e,e*Math.sqrt(1+t*t)):t>0?(e/=t,t*Math.sqrt(1+e*e)):0}nd.prototype.copyTo=function(e){e.data.set(this.data)};var hd=1.192092896e-7,pd=1e-37;function dd(e,t,r,n){var i=0,o=0,a=e.rows,s=e.cols,l=a,u=s;l<u&&(i=1,o=l,l=u,u=o);var c=new nd(l,l),h=new nd(1,u),p=new nd(u,u);if(0===i)id(c,e);else{for(o=0;o<s*a;o++)c.data[o]=e.data[o];for(;o<u*l;o++)c.data[o]=0}if(function(e,t,r,n,i,o,a,s){for(var l=2*hd,u=pd,c=0,h=0,p=0,d=0,f=Math.max(o,30),m=0,g=0,v=0,y=0,b=0,w=0,x=0,_=0,S=0,C=0,M=0,T=0,A=0,E=0,P=0,R=0,I=0,N=4660,D=0,k=0,O=0,F=new Float64Array(a<<3);c<a;c++){for(p=0,M=0;p<o;p++)M+=(_=e[c*t+p])*_;if(F[c]=M,n){for(p=0;p<a;p++)n[c*i+p]=0;n[c*i+c]=1}}for(;d<f;d++){for(b=0,c=0;c<a-1;c++)for(h=c+1;h<a;h++){for(m=c*t|0,g=h*t|0,P=F[c],R=0,I=F[h],p=2,R+=e[m]*e[g],R+=e[m+1]*e[g+1];p<o;p++)R+=e[m+p]*e[g+p];if(!(Math.abs(R)<=l*Math.sqrt(P*I))){for(A=cd(R*=2,T=P-I),T<0?(E=.5*(A-T),w=R/(A*(x=Math.sqrt(E/A))*2)):x=R/(A*(w=Math.sqrt((A+T)/(2*A)))*2),P=0,I=0,p=2,S=w*e[m]+x*e[g],C=-x*e[m]+w*e[g],e[m]=S,e[g]=C,P+=S*S,I+=C*C,S=w*e[m+1]+x*e[g+1],C=-x*e[m+1]+w*e[g+1],e[m+1]=S,e[g+1]=C,P+=S*S,I+=C*C;p<o;p++)S=w*e[m+p]+x*e[g+p],C=-x*e[m+p]+w*e[g+p],e[m+p]=S,e[g+p]=C,P+=S*S,I+=C*C;if(F[c]=P,F[h]=I,b=1,n)for(y=h*i|0,p=2,S=w*n[v=c*i|0]+x*n[y],C=-x*n[v]+w*n[y],n[v]=S,n[y]=C,S=w*n[v+1]+x*n[y+1],C=-x*n[v+1]+w*n[y+1],n[v+1]=S,n[y+1]=C;p<a;p++)S=w*n[v+p]+x*n[y+p],C=-x*n[v+p]+w*n[y+p],n[v+p]=S,n[y+p]=C}}if(0===b)break}for(c=0;c<a;c++){for(p=0,M=0;p<o;p++)M+=(_=e[c*t+p])*_;F[c]=Math.sqrt(M)}for(c=0;c<a-1;c++){for(h=c,p=c+1;p<a;p++)F[h]<F[p]&&(h=p);if(c!==h&&(ud(F,c,h,M),n)){for(p=0;p<o;p++)ud(e,c*t+p,h*t+p,_);for(p=0;p<a;p++)ud(n,c*i+p,h*i+p,_)}}for(c=0;c<a;c++)r[c]=F[c];if(n)for(c=0;c<s;c++){for(M=c<a?F[c]:0;M<=u;){for(k=1/o,p=0;p<o;p++)D=0!=(256&(N=214013*N+2531011)>>16)?k:-k,e[c*t+p]=D;for(d=0;d<2;d++)for(h=0;h<c;h++){for(M=0,p=0;p<o;p++)M+=e[c*t+p]*e[h*t+p];for(O=0,p=0;p<o;p++)_=e[c*t+p]-M*e[h*t+p],e[c*t+p]=_,O+=Math.abs(_);for(O=O?1/O:0,p=0;p<o;p++)e[c*t+p]*=O}for(M=0,p=0;p<o;p++)M+=(_=e[c*t+p])*_;M=Math.sqrt(M)}for(x=1/M,p=0;p<o;p++)e[c*t+p]*=x}}(c.data,l,h.data,p.data,u,l,u,l),t){for(o=0;o<u;o++)t.data[o]=h.data[o];for(;o<s;o++)t.data[o]=0}0===i?(r&&id(r,c),n&&id(n,p)):(r&&id(r,p),n&&id(n,c))}function fd(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function md(e,t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g){e[0]=t,e[4]=r,e[8]=n,e[12]=i,e[1]=o,e[5]=a,e[9]=s,e[13]=l,e[2]=u,e[6]=c,e[10]=h,e[14]=p,e[3]=d,e[7]=f,e[11]=m,e[15]=g}function gd(e,t,r){var n=t[0],i=t[4],o=t[8],a=t[12],s=t[1],l=t[5],u=t[9],c=t[13],h=t[2],p=t[6],d=t[10],f=t[14],m=t[3],g=t[7],v=t[11],y=t[15],b=r[0],w=r[4],x=r[8],_=r[12],S=r[1],C=r[5],M=r[9],T=r[13],A=r[2],E=r[6],P=r[10],R=r[14],I=r[3],N=r[7],D=r[11],k=r[15];e[0]=n*b+i*S+o*A+a*I,e[4]=n*w+i*C+o*E+a*N,e[8]=n*x+i*M+o*P+a*D,e[12]=n*_+i*T+o*R+a*k,e[1]=s*b+l*S+u*A+c*I,e[5]=s*w+l*C+u*E+c*N,e[9]=s*x+l*M+u*P+c*D,e[13]=s*_+l*T+u*R+c*k,e[2]=h*b+p*S+d*A+f*I,e[6]=h*w+p*C+d*E+f*N,e[10]=h*x+p*M+d*P+f*D,e[14]=h*_+p*T+d*R+f*k,e[3]=m*b+g*S+v*A+y*I,e[7]=m*w+g*C+v*E+y*N,e[11]=m*x+g*M+v*P+y*D,e[15]=m*_+g*T+v*R+y*k}function vd(e,t,r,n){md(e,t,0,0,0,0,r,0,0,0,0,n,0,0,0,0,1)}function yd(e,t,r,n){md(e,1,0,0,t,0,1,0,r,0,0,1,n,0,0,0,1)}function bd(e,t){var r=Math.cos(t),n=Math.sin(t);md(e,r,0,n,0,0,1,0,0,-n,0,r,0,0,0,0,1)}function wd(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function xd(e,t){var r=jc([t[0],t[1],t[2]]),n=jc([t[4],t[5],t[6]]),i=jc([t[8],t[9],t[10]]),o=jc();Hc(o,n,i),e[0]=o[0],e[1]=o[1],e[2]=o[2],Hc(o,i,r),e[3]=o[0],e[4]=o[1],e[5]=o[2],Hc(o,r,n),e[6]=o[0],e[7]=o[1],e[8]=o[2]}function _d(e,t,r,n){r=r||1,n=n||!0;var i,o=e.length/3,a=t.length/3;n&&(i=new Float32Array(3*o));var s,l,u,c,h=new Float32Array(3*o),p=new Array(20);for(s=0;s<20;++s)p[s]=new Uint32Array(o);for(s=0;s<o;++s)p[0][s]=0;for(s=0;s<a;++s){var d=3*s,f=3*s+1,m=3*s+2;for(c=!0,l=0,u=p[0][t[d]];l<u;++l)if(t[f]===p[l+1][t[d]]){c=!1;break}for(c&&(p[0][t[d]]++,p[p[0][t[d]]][t[d]]=t[f]),c=!0,l=0,u=p[0][t[d]];l<u;++l)if(t[m]===p[l+1][t[d]]){c=!1;break}for(c&&(p[0][t[d]]++,p[p[0][t[d]]][t[d]]=t[m]),c=!0,l=0,u=p[0][t[f]];l<u;++l)if(t[d]===p[l+1][t[f]]){c=!1;break}for(c&&(p[0][t[f]]++,p[p[0][t[f]]][t[f]]=t[d]),c=!0,l=0,u=p[0][t[f]];l<u;++l)if(t[m]===p[l+1][t[f]]){c=!1;break}for(c&&(p[0][t[f]]++,p[p[0][t[f]]][t[f]]=t[m]),c=!0,l=0;l<p[0][t[m]];++l)if(t[d]===p[l+1][t[m]]){c=!1;break}for(c&&(p[0][t[m]]++,p[p[0][t[m]]][t[m]]=t[d]),c=!0,l=0,u=p[0][t[m]];l<u;++l)if(t[f]===p[l+1][t[m]]){c=!1;break}c&&(p[0][t[m]]++,p[p[0][t[m]]][t[m]]=t[f])}for(var g,v,y,b,w,x=0;x<r;++x){for(s=0;s<o;++s)if(g=3*s,(y=p[0][s])<3)h[g]=e[g],h[g+1]=e[g+1],h[g+2]=e[g+2];else if(3===y||4===y){for(h[g]=0,h[g+1]=0,h[g+2]=0,l=0;l<y;++l)v=3*p[l+1][s],h[g]+=e[v],h[g+1]+=e[v+1],h[g+2]+=e[v+2];h[g]+=.5*e[g],h[g+1]+=.5*e[g+1],h[g+2]+=.5*e[g+2],w=.5+y,h[g]/=w,h[g+1]/=w,h[g+2]/=w}else{for(h[g]=0,h[g+1]=0,h[g+2]=0,l=0;l<y;++l)v=3*p[l+1][s],h[g]+=e[v],h[g+1]+=e[v+1],h[g+2]+=e[v+2];h[g]+=1*e[g],h[g+1]+=1*e[g+1],h[g+2]+=1*e[g+2],b=1+y,h[g]/=b,h[g+1]/=b,h[g+2]/=b}if(e.set(h),n){Sd(e,t,i);var _=3*o;for(g=0;g<_;g+=3)e[g]+=.75/4.5*-1*i[g],e[g+1]+=.75/4.5*-1*i[g+1],e[g+2]+=.75/4.5*-1*i[g+2]}}}function Sd(e,t,r){var n,i;if(void 0===r)r=new Float32Array(e.length);else for(n=0,i=r.length;n<i;n++)r[n]=0;var o=new Float32Array(3),a=new Float32Array(3),s=new Float32Array(3),l=new Float32Array(3),u=new Float32Array(3);if(t)for(n=0,i=t.length;n<i;n+=3){var c=3*t[n],h=3*t[n+1],p=3*t[n+2];qc(o,e,c),qc(a,e,h),qc(s,e,p),Gc(l,s,a),Gc(u,o,a),Hc(l,l,u),r[c]+=l[0],r[c+1]+=l[1],r[c+2]+=l[2],r[h]+=l[0],r[h+1]+=l[1],r[h+2]+=l[2],r[p]+=l[0],r[p+1]+=l[1],r[p+2]+=l[2]}else for(n=0,i=e.length;n<i;n+=9)qc(o,e,n),qc(a,e,n+3),qc(s,e,n+6),Gc(l,s,a),Gc(u,o,a),Hc(l,l,u),r[n]=l[0],r[n+1]=l[1],r[n+2]=l[2],r[n+3]=l[0],r[n+4]=l[1],r[n+5]=l[2],r[n+6]=l[0],r[n+7]=l[1],r[n+8]=l[2];return zc(r),r}function Cd(e){for(var t={},r=0,n=e.length;r<n;++r)t[e[r]]=!0;return t}function Md(e,t,r,n,i){var o=1/n*3;Qc(e,e,i+(o+=r)),eh(t,t,i+o),Zc(e,e,n),th(e,e),Yc(e,e,n),Zc(t,t,n),rh(t,t),Yc(t,t,n);var a=new Float32Array(3);Gc(a,t,e),Zc(a,a,n),rh(a,a),eh(a,a,1);var s=256*Math.pow(10,6),l=a[0]*a[1]*a[2]*3;s<=l&&(Zc(e,e,n*=Math.pow(s/l,1/3)),th(e,e),Yc(e,e,n),Zc(t,t,n),rh(t,t),Yc(t,t,n),Gc(a,t,e),Zc(a,a,n),rh(a,a),eh(a,a,1));var u=new Float32Array(e);nh(u,u);var c=fd(),h=fd();bd(h,fs(90)),gd(c,c,h);var p=fd();vd(p,-1/n,1/n,1/n),gd(c,c,p);var d=fd();return yd(d,-n*u[2],-n*u[1],-n*u[0]),gd(c,c,d),{dim:a,tran:u,matrix:c,scaleFactor:n}}vd.__deps=[md],yd.__deps=[md],bd.__deps=[md],xd.__deps=[jc,Hc],_d.__deps=[Sd],Sd.__deps=[Gc,Hc,qc,zc],Md.__deps=[fs,Qc,eh,Yc,Zc,th,rh,Gc,nh,fd,gd,yd,vd,bd];var Td=function(e,t,r){this.name=e||"",this.path=t||"",this.info={},this.center=new ft,this.boundingBox=new _r,r instanceof Fr||r instanceof Yr||r instanceof Hn?this.fromGeometry(r):r&&(this.set(r.position,r.index,r.normal,r.color,r.atomindex,r.contour),this.boundingBox.setFromArray(r.position),this.boundingBox.getCenter(this.center))},Ad={type:{configurable:!0}};function Ed(e,t,r,n,i){var o=new rd(e,t,r,n,i);this.getSurface=function(e,t,r,n,i,a){var s=o.triangulate(e,t,r,i,a);if(t&&!i&&(_d(s.position,s.index,t,!0),s.normal=Sd(s.position,s.index)),n&&(Vc(n,s.position),s.normal)){var l=wd();xd(l,n),Bc(l,s.normal)}return s}}Ad.type.get=function(){return"Surface"},Td.prototype.set=function(e,t,r,n,i,o){this.position=e,this.index=t,this.normal=r,this.color=n,this.atomindex=i,this.size=e.length/3,this.contour=o},Td.prototype.fromGeometry=function(e){var t,r,n,i;if(vl&&gl.time("GeometrySurface.fromGeometry"),e instanceof Fr?(e.computeVertexNormals(!0),t=(new Yr).fromGeometry(e)):t=e instanceof Yr?e:e[0],t.boundingBox||t.computeBoundingBox(),this.boundingBox.copy(t.boundingBox),this.boundingBox.getCenter(this.center),t instanceof Yr){var o=t.attributes,a=!!o.normal&&o.normal.array;(!a||0===a[0]&&0===a[1]&&0===a[2])&&t.computeVertexNormals(),r=o.position.array,n=o.index?o.index.array:null,i=o.normal.array}this.set(r,n,i,void 0,void 0),vl&&gl.timeEnd("GeometrySurface.setGeometry")},Td.prototype.getPosition=function(){return this.position},Td.prototype.getColor=function(e){var t=e||{};t.surface=this;var r=this.size,n=new Float32Array(3*r),i=Sl.getScheme(t);if(i.volumeColor||"random"===t.scheme)for(var o=0;o<r;++o)i.volumeColorToArray(o,n,3*o);else if(i.positionColor)for(var a=new ft,s=this.position,l=0;l<r;++l){var u=3*l;a.set(s[u],s[u+1],s[u+2]),i.positionColorToArray(a,n,u)}else if(i.atomColor&&this.atomindex)for(var c=t.structure.getAtomProxy(),h=this.atomindex,p=0;p<r;++p)c.index=h[p],i.atomColorToArray(c,n,3*p);else{var d=new ur(t.value);mu(r,d.r,d.g,d.b,n)}return n},Td.prototype.getPicking=function(e){return this.atomindex&&e?new kp(this.atomindex,e):new qp(gu(this.size),this)},Td.prototype.getNormal=function(){return this.normal},Td.prototype.getSize=function(e,t){return fu(this.size,e*t)},Td.prototype.getIndex=function(){return this.index},Td.prototype.getFilteredIndex=function(e,t){if(e&&this.atomindex){for(var r=new el(e),n=t.getAtomSet(r),i=[],o=this.atomindex,a=this.index,s=a.length,l=this.contour?2:3,u=0,c=0;c<s;c+=l){for(var h=!0,p=0;p<l;p++){var d=o[a[c+p]];if(!n.get(d)){h=!1;break}}if(h)for(var f=0;f<l;f++,u++)i[u]=a[c+f]}return is(i,this.position.length/3)}return this.index},Td.prototype.getAtomindex=function(){return this.atomindex},Td.prototype.dispose=function(){},Object.defineProperties(Td.prototype,Ad),Ed.__deps=[_d,Sd,rd,Vc,Bc,wd,xd],_l.add("surf",function(e,t){var r=e.data.args,n=e.data.params;if(r&&(self.volsurf=new Ed(r[0],r[1],r[2],r[3],r[4])),n){var i=self.volsurf.getSurface(n.isolevel,n.smooth,n.box,n.matrix,n.contour,n.wrap),o=[i.position.buffer,i.index.buffer];i.normal&&o.push(i.normal.buffer),i.atomindex&&o.push(i.atomindex.buffer),t({sd:i,p:n},o)}},[Ed]);var Pd=function(e,t,r,n,i,o,a){this.name=e,this.path=t,this.matrix=new pt,this.normalMatrix=new mt,this.inverseMatrix=new pt,this.center=new ft,this.boundingBox=new _r,this.setData(r,n,i,o,a)},Rd={type:{configurable:!0},position:{configurable:!0},min:{configurable:!0},max:{configurable:!0},sum:{configurable:!0},mean:{configurable:!0},rms:{configurable:!0}};function Id(e){return"front"===e?m:"back"===e?g:v}Rd.type.get=function(){return"Volume"},Pd.prototype.setData=function(e,t,r,n,i){this.nx=t||1,this.ny=r||1,this.nz=n||1,this.data=e||new Float32Array(1),this.setAtomindex(i),delete this._position,delete this._min,delete this._max,delete this._mean,delete this._rms,this.worker&&this.worker.terminate()},Pd.prototype.setStats=function(e,t,r,n){this._min=e,this._max=t,this._mean=r,this._rms=n},Pd.prototype.setMatrix=function(e){this.matrix.copy(e);var t=this.boundingBox,r=this.center,n=this.nx-1,i=this.ny-1,o=this.nz-1;t.makeEmpty(),t.expandByPoint(r.set(n,i,o)),t.expandByPoint(r.set(n,i,0)),t.expandByPoint(r.set(n,0,o)),t.expandByPoint(r.set(n,0,0)),t.expandByPoint(r.set(0,i,o)),t.expandByPoint(r.set(0,0,o)),t.expandByPoint(r.set(0,i,0)),t.expandByPoint(r.set(0,0,0)),t.applyMatrix4(this.matrix),t.getCenter(this.center);var a=this.matrix.elements,s=new ft(a[0],a[1],a[2]),l=new ft(a[4],a[5],a[6]),u=new ft(a[8],a[9],a[10]),c=new ft,h=this.normalMatrix.elements;c.crossVectors(l,u),h[0]=c.x,h[1]=c.y,h[2]=c.z,c.crossVectors(u,s),h[3]=c.x,h[4]=c.y,h[5]=c.z,c.crossVectors(s,l),h[6]=c.x,h[7]=c.y,h[8]=c.z,this.inverseMatrix.getInverse(this.matrix)},Pd.prototype.setAtomindex=function(e){this.atomindex=e},Pd.prototype.getBox=function(e,t,r){return r||(r=new _r),r.set(e,e),r.expandByScalar(t),r.applyMatrix4(this.inverseMatrix),r.min.round(),r.max.round(),r},Pd.prototype._getBox=function(e,t){if(e&&t){this.__box||(this.__box=new _r);var r=this.getBox(e,t,this.__box);return[r.min.toArray(),r.max.toArray()]}},Pd.prototype._makeSurface=function(e,t,r){var n=this.name+"@"+t.toPrecision(2),i=new Td(n,"",e);return i.info.isolevel=t,i.info.smooth=r,i.info.volume=this,i},Pd.prototype.getSurface=function(e,t,r,n,i,o){e=isNaN(e)?this.getValueForSigma(2):e,t=Ha(t,0),void 0===this.volsurf&&(this.volsurf=new Ed(this.data,this.nx,this.ny,this.nz,this.atomindex));var a=this._getBox(r,n),s=this.volsurf.getSurface(e,t,a,this.matrix.elements,i,o);return this._makeSurface(s,e,t)},Pd.prototype.getSurfaceWorker=function(e,t,r,n,i,o,a){var s=this;if(e=isNaN(e)?this.getValueForSigma(2):e,t=t||0,window.Worker){void 0===this.workerPool&&(this.workerPool=new Oc("surf",2));var l={},u=this.workerPool.getNextWorker();0===u.postCount&&(l.args=[this.data,this.nx,this.ny,this.nz,this.atomindex]),l.params={isolevel:e,smooth:t,box:this._getBox(r,n),matrix:this.matrix.elements,contour:i,wrap:o},u.post(l,void 0,function(e){var t=e.data.sd,r=e.data.p;a(s._makeSurface(t,r.isolevel,r.smooth))},function(l){console.warn("Volume.getSurfaceWorker error - trying without worker",l);var u=s.getSurface(e,t,r,n,i,o);a(u)})}else{var c=this.getSurface(e,t,r,n,i,o);a(c)}},Pd.prototype.getValueForSigma=function(e){return this.mean+Ha(e,2)*this.rms},Pd.prototype.getSigmaForValue=function(e){return(Ha(e,0)-this.mean)/this.rms},Rd.position.get=function(){if(!this._position){for(var e=this.nz,t=this.ny,r=this.nx,n=new Float32Array(r*t*e*3),i=0,o=0;o<e;++o)for(var a=0;a<t;++a)for(var s=0;s<r;++s)n[i+0]=s,n[i+1]=a,n[i+2]=o,i+=3;Vc(this.matrix.elements,n),this._position=n}return this._position},Pd.prototype.getDataAtomindex=function(){return this.atomindex},Pd.prototype.getDataPosition=function(){return this.position},Pd.prototype.getDataColor=function(e){var t=e||{};t.volume=this,t.scale=t.scale||"Spectral",t.domain=t.domain||[this.min,this.max];for(var r=Sl.getScheme(t),n=this.position.length/3,i=new Float32Array(3*n),o=0;o<n;++o)r.volumeColorToArray(o,i,3*o);return i},Pd.prototype.getDataPicking=function(){var e=gu(this.position.length/3);return new Zp(e,this)},Pd.prototype.getDataSize=function(e,t){var r,n=this.data,i=this.position.length/3;switch(e){case"value":r=new Float32Array(n);break;case"abs-value":r=new Float32Array(n);for(var o=0;o<i;++o)r[o]=Math.abs(r[o]);break;case"value-min":r=new Float32Array(n);for(var a=this.min,s=0;s<i;++s)r[s]-=a;break;case"deviation":r=new Float32Array(n);break;default:r=fu(i,e)}if(1!==t)for(var l=0;l<i;++l)r[l]*=t;return r},Rd.min.get=function(){return void 0===this._min&&(this._min=_u(this.data)),this._min},Rd.max.get=function(){return void 0===this._max&&(this._max=xu(this.data)),this._max},Rd.sum.get=function(){return void 0===this._sum&&(this._sum=Su(this.data)),this._sum},Rd.mean.get=function(){return void 0===this._mean&&(this._mean=Cu(this.data)),this._mean},Rd.rms.get=function(){return void 0===this._rms&&(this._rms=function(e){for(var t=e.length,r=0,n=0;n<t;++n){var i=e[n];r+=i*i}return Math.sqrt(r/t)}(this.data)),this._rms},Pd.prototype.clone=function(){var e=new Pd(this.name,this.path,this.data,this.nx,this.ny,this.nz,this.atomindex);return e.matrix.copy(this.matrix),e.header=Object.assign({},this.header),e},Pd.prototype.dispose=function(){this.workerPool&&this.workerPool.terminate()},Object.defineProperties(Pd.prototype,Rd),Al.add("shader/Mesh.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#elif defined( NOLIGHT )\nvColor = color;\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Al.add("shader/Mesh.frag","#define STANDARD\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#elif defined( NOLIGHT )\nvarying vec3 vColor;\n#else\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars\n#include lights_physical_pars_fragment\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.7 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#elif defined( NOLIGHT )\ngl_FragColor = vec4( vColor, opacity );\n#else\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_flip\n#include normal_fragment\n#include dull_interior_fragment\n#include lights_physical_fragment\n#include lights_template\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#include opaque_back_fragment\n#endif\n}");var Nd={f:1,v2:2,v3:3,c:3};function Dd(e,t){e.matrix.copy(t),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorldNeedsUpdate=!0}var kd={opaqueBack:!1,dullInterior:!1,side:"double",opacity:1,depthWrite:!0,clipNear:0,clipRadius:0,clipCenter:new ft,flatShaded:!1,wireframe:!1,roughness:.4,metalness:0,diffuse:16777215,forceTransparent:!1,matrix:new pt,disablePicking:!1,sortParticles:!1,background:!1},Od={opaqueBack:{updateShader:!0},dullInterior:{updateShader:!0},side:{updateShader:!0,property:!0},opacity:{uniform:!0},depthWrite:{property:!0},clipNear:{updateShader:!0,property:!0},clipRadius:{updateShader:!0,uniform:!0},clipCenter:{uniform:!0},flatShaded:{updateShader:!0},background:{updateShader:!0},wireframe:{updateVisibility:!0},roughness:{uniform:!0},metalness:{uniform:!0},diffuse:{uniform:!0},matrix:{}},Fd=function(e,t){void 0===t&&(t={}),this.parameterTypes=Od,this.geometry=new Yr,this.indexVersion=0,this.wireframeIndexVersion=-1,this.group=new Hn,this.wireframeGroup=new Hn,this.pickingGroup=new Hn,this.vertexShader="",this.fragmentShader="",this.isImpostor=!1,this.isText=!1,this.isSurface=!1,this.isPoint=!1,this.isLine=!1,this.dynamic=!0,this.visible=!0,this.wireframeIndexCount=0,this.parameters=$a(t,this.defaultParameters),this.uniforms=hr.merge([cr.common,{fogColor:{value:null},fogNear:{value:0},fogFar:{value:0},opacity:{value:this.parameters.opacity},clipNear:{value:0},clipRadius:{value:this.parameters.clipRadius},clipCenter:{value:this.parameters.clipCenter}},{emissive:{value:new ur(0)},roughness:{value:this.parameters.roughness},metalness:{value:this.parameters.metalness}},cr.lights]),this.uniforms.diffuse.value.set(this.parameters.diffuse),this.pickingUniforms={clipNear:{value:0},objectId:{value:0},opacity:{value:this.parameters.opacity}};var r=e.position||e.position1;this._positionDataSize=r?r.length/3:0,e.primitiveId||(e.primitiveId=gu(this._positionDataSize)),this.addAttributes({position:{type:"v3",value:e.position},color:{type:"c",value:e.color},primitiveId:{type:"f",value:e.primitiveId}}),t.matrix&&(this.matrix=t.matrix),e.index&&this.initIndex(e.index),this.picking=e.picking,this.makeWireframeGeometry()},Ld={defaultParameters:{configurable:!0},matrix:{configurable:!0},transparent:{configurable:!0},size:{configurable:!0},attributeSize:{configurable:!0},pickable:{configurable:!0}};Ld.defaultParameters.get=function(){return kd},Ld.matrix.set=function(e){this.setMatrix(e)},Ld.matrix.get=function(){return this.group.matrix.clone()},Ld.transparent.get=function(){return this.parameters.opacity<1||this.parameters.forceTransparent},Ld.size.get=function(){return this._positionDataSize},Ld.attributeSize.get=function(){return this.size},Ld.pickable.get=function(){return!!this.picking&&!this.parameters.disablePicking},Fd.prototype.setMatrix=function(e){Dd(this.group,e),Dd(this.wireframeGroup,e),Dd(this.pickingGroup,e)},Fd.prototype.initIndex=function(e){this.geometry.setIndex(new Lr(e,1)),this.geometry.getIndex().setDynamic(this.dynamic)},Fd.prototype.makeMaterial=function(){var e=Id(this.parameters.side),t=new rn({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!0,fog:!0,side:e});t.vertexColors=w,t.extensions.derivatives=this.parameters.flatShaded,t.extensions.fragDepth=this.isImpostor;var r=new rn({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!1,fog:!0,side:e});r.vertexColors=w;var n=new rn({uniforms:this.pickingUniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:!1,depthWrite:this.parameters.depthWrite,lights:!1,fog:!1,side:e,blending:x});n.vertexColors=w,n.extensions.fragDepth=this.isImpostor,t.clipNear=this.parameters.clipNear,r.clipNear=this.parameters.clipNear,n.clipNear=this.parameters.clipNear,this.material=t,this.wireframeMaterial=r,this.pickingMaterial=n,this.updateShader()},Fd.prototype.makeWireframeGeometry=function(){this.makeWireframeIndex();var e=this.geometry,t=this.wireframeIndex,r=new Yr;r.attributes=e.attributes,t&&(r.setIndex(new Lr(t,1).setDynamic(this.dynamic)),r.setDrawRange(0,this.wireframeIndexCount)),this.wireframeGeometry=r},Fd.prototype.makeWireframeIndex=function(){var e=[];function t(t,r){if(t>r){var n=t;t=r,r=n}var i=e[t];return void 0===i?(e[t]=[r],!0):!i.includes(r)&&(i.push(r),!0)}var r=this.geometry,n=r.index;if(this.parameters.wireframe)if(n){var i,o=n.array,a=o.length;if(r.drawRange.count!==1/0&&(a=r.drawRange.count),this.wireframeIndex&&this.wireframeIndex.length>2*a)i=this.wireframeIndex;else i=is(2*a,r.attributes.position.count);var s=0;e.length=0;for(var l=0;l<a;l+=3){var u=o[l+0],c=o[l+1],h=o[l+2];t(u,c)&&(i[s+0]=u,i[s+1]=c,s+=2),t(c,h)&&(i[s+0]=c,i[s+1]=h,s+=2),t(h,u)&&(i[s+0]=h,i[s+1]=u,s+=2)}this.wireframeIndex=i,this.wireframeIndexCount=s,this.wireframeIndexVersion=this.indexVersion}else{var p,d=r.attributes.position.count;p=this.wireframeIndex&&this.wireframeIndex.length>2*d?this.wireframeIndex:is(2*d,d);for(var f=0,m=0;f<d;f+=3)p[m+0]=f,p[m+1]=f+1,p[m+2]=f+1,p[m+3]=f+2,p[m+4]=f+2,p[m+5]=f,m+=6;this.wireframeIndex=p,this.wireframeIndexCount=2*d,this.wireframeIndexVersion=this.indexVersion}else this.wireframeIndex=new Uint16Array(0),this.wireframeIndexCount=0},Fd.prototype.updateWireframeIndex=function(){if(this.wireframeGeometry&&this.wireframeIndex){if(this.wireframeGeometry.setDrawRange(0,1/0),this.wireframeIndexVersion<this.indexVersion&&this.makeWireframeIndex(),this.wireframeIndex.length>this.wireframeGeometry.index.array.length)this.wireframeGeometry.setIndex(new Lr(this.wireframeIndex,1).setDynamic(this.dynamic));else{var e=this.wireframeGeometry.getIndex();e.set(this.wireframeIndex),e.needsUpdate=this.wireframeIndexCount>0,e.updateRange.count=this.wireframeIndexCount}this.wireframeGeometry.setDrawRange(0,this.wireframeIndexCount)}},Fd.prototype.getRenderOrder=function(){var e=0;return this.isText?e=1:this.transparent&&(e=this.isSurface?3:2),e},Fd.prototype._getMesh=function(e){this.material||this.makeMaterial();var t,r=this.geometry,n=this[e];return(t=this.isLine?new Vn(r,n):this.isPoint?new jn(r,n):new sn(r,n)).frustumCulled=!1,t.renderOrder=this.getRenderOrder(),t},Fd.prototype.getMesh=function(){return this._getMesh("material")},Fd.prototype.getWireframeMesh=function(){var e;return this.material||this.makeMaterial(),this.wireframeGeometry||this.makeWireframeGeometry(),(e=new Vn(this.wireframeGeometry,this.wireframeMaterial)).frustumCulled=!1,e.renderOrder=this.getRenderOrder(),e},Fd.prototype.getPickingMesh=function(){return this._getMesh("pickingMaterial")},Fd.prototype.getShader=function(e,t){return tu(e,this.getDefines(t))},Fd.prototype.getVertexShader=function(e){return this.getShader(this.vertexShader,e)},Fd.prototype.getFragmentShader=function(e){return this.getShader(this.fragmentShader,e)},Fd.prototype.getDefines=function(e){var t={};return this.parameters.clipNear&&(t.NEAR_CLIP=1),this.parameters.clipRadius&&(t.RADIUS_CLIP=1),"picking"===e?t.PICKING=1:(("background"===e||this.parameters.background)&&(t.NOLIGHT=1),this.parameters.flatShaded&&(t.FLAT_SHADED=1),this.parameters.opaqueBack&&(t.OPAQUE_BACK=1),this.parameters.dullInterior&&(t.DULL_INTERIOR=1)),t},Fd.prototype.getParameters=function(){return this.parameters},Fd.prototype.addUniforms=function(e){this.uniforms=hr.merge([this.uniforms,e]),this.pickingUniforms=hr.merge([this.pickingUniforms,e])},Fd.prototype.addAttributes=function(e){for(var t in e){var r=void 0,n=e[t],i=this.attributeSize*Nd[n.type];n.value?(i!==n.value.length&&gl.error("attribute value has wrong length",t),r=n.value):r=ns("float32",i),this.geometry.addAttribute(t,new Lr(r,Nd[n.type]).setDynamic(this.dynamic))}},Fd.prototype.updateRenderOrder=function(){var e=this.getRenderOrder();function t(t){t.renderOrder=e}this.group.children.forEach(t),this.pickingGroup&&this.pickingGroup.children.forEach(t)},Fd.prototype.updateShader=function(){var e=this.material,t=this.wireframeMaterial,r=this.pickingMaterial;e.vertexShader=this.getVertexShader(),e.fragmentShader=this.getFragmentShader(),e.needsUpdate=!0,t.vertexShader=this.getShader("Line.vert"),t.fragmentShader=this.getShader("Line.frag"),t.needsUpdate=!0,r.vertexShader=this.getVertexShader("picking"),r.fragmentShader=this.getFragmentShader("picking"),r.needsUpdate=!0},Fd.prototype.setParameters=function(e){var t=e,r=this.parameterTypes,n=this.parameters,i={},o={},a=!1,s=!1;for(var l in t){var u=t[l];void 0!==u&&(n[l]=u,void 0!==r[l]&&(r[l].property&&(!0!==r[l].property?i[r[l].property]=u:i[l]=u),r[l].uniform&&(!0!==r[l].uniform?o[r[l].uniform]=u:o[l]=u),r[l].updateShader&&(a=!0),r[l].updateVisibility&&(s=!0),this.dynamic&&"wireframe"===l&&!0===u&&this.updateWireframeIndex(),"flatShaded"===l&&(this.material.extensions.derivatives=this.parameters.flatShaded||this.isText),"forceTransparent"===l&&(i.transparent=this.transparent),"matrix"===l&&(this.matrix=u)))}this.setProperties(i),this.setUniforms(o),a&&this.updateShader(),s&&this.setVisibility(this.visible)},Fd.prototype.setAttributes=function(e){var t=this.geometry,r=t.attributes;for(var n in e)if("picking"!==n){var i=e[n],o=i.length;if("index"===n){var a=t.getIndex();t.setDrawRange(0,1/0),o>a.array.length?t.setIndex(new Lr(i,1).setDynamic(this.dynamic)):(a.set(i),a.needsUpdate=o>0,a.updateRange.count=o,t.setDrawRange(0,o)),this.indexVersion++,this.parameters.wireframe&&this.updateWireframeIndex()}else{var s=r[n];o>s.array.length?t.addAttribute(n,new Lr(i,s.itemSize).setDynamic(this.dynamic)):(r[n].set(i),r[n].needsUpdate=o>0,r[n].updateRange.count=o)}}},Fd.prototype.setUniforms=function(e){if(e){var t=this.material.uniforms,r=this.wireframeMaterial.uniforms,n=this.pickingMaterial.uniforms;for(var i in e)"opacity"===i&&this.setProperties({transparent:this.transparent}),void 0!==t[i]&&(t[i].value.isVector3?t[i].value.copy(e[i]):t[i].value.set?t[i].value.set(e[i]):t[i].value=e[i]),void 0!==r[i]&&(r[i].value.isVector3?r[i].value.copy(e[i]):r[i].value.set?r[i].value.set(e[i]):r[i].value=e[i]),void 0!==n[i]&&(n[i].value.isVector3?n[i].value.copy(e[i]):n[i].value.set?n[i].value.set(e[i]):n[i].value=e[i])}},Fd.prototype.setProperties=function(e){if(e){var t=this.material,r=this.wireframeMaterial,n=this.pickingMaterial;for(var i in e){var o=i,a=e[o];"transparent"===o?this.updateRenderOrder():"side"===o&&(a=Id(a)),t[o]=a,r[o]=a,n[o]=a}t.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0}},Fd.prototype.setVisibility=function(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))},Fd.prototype.dispose=function(){this.material&&this.material.dispose(),this.wireframeMaterial&&this.wireframeMaterial.dispose(),this.pickingMaterial&&this.pickingMaterial.dispose(),this.geometry.dispose(),this.wireframeGeometry&&this.wireframeGeometry.dispose()},Object.defineProperties(Fd.prototype,Ld);var Ud=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.vertexShader="Mesh.vert",this.fragmentShader="Mesh.frag",this.addAttributes({normal:{type:"v3",value:t.normal}}),void 0===t.normal&&this.geometry.computeVertexNormals()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Fd),Vd=function(e){function t(){e.apply(this,arguments),this.isSurface=!0}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Ud);function Bd(e){e.visible=!0}function zd(e){e.visible=!1}var jd=function(e){this.group=new Hn,this.wireframeGroup=new Hn,this.pickingGroup=new Hn,this.frontMeshes=[],this.backMeshes=[],this.size=e.size,this.side=e.parameters.side,this.visible=e.visible,this.geometry=e.geometry,this.picking=e.picking,this.group=new Hn,this.wireframeGroup=new Hn,this.pickingGroup=new Hn,this.matrix=e.matrix;var t=e,r=new e.constructor({position:new Float32Array(0)});t.makeMaterial(),r.makeMaterial(),r.picking=e.picking,r.geometry=e.geometry,r.wireframeGeometry=e.wireframeGeometry,r.setParameters(e.getParameters()),r.updateShader(),t.setParameters({side:"front"}),r.setParameters({side:"back",opacity:r.parameters.opacity}),this.buffer=e,this.frontBuffer=t,this.backBuffer=r},Hd={matrix:{configurable:!0},pickable:{configurable:!0},parameters:{configurable:!0}};Hd.matrix.set=function(e){Fd.prototype.setMatrix.call(this,e)},Hd.matrix.get=function(){return this.group.matrix.clone()},Hd.pickable.get=function(){return!!this.picking&&!this.parameters.disablePicking},Hd.parameters.get=function(){return this.buffer.parameters},jd.prototype.getParameters=function(){var e=Object.assign({},this.buffer.parameters);return e.side=this.side,e},jd.prototype.getMesh=function(e){var t,r;return e?(r=this.backBuffer.getPickingMesh(),t=this.frontBuffer.getPickingMesh()):(r=this.backBuffer.getMesh(),t=this.frontBuffer.getMesh()),this.frontMeshes.push(t),this.backMeshes.push(r),this.setParameters({side:this.side}),(new Hn).add(r,t)},jd.prototype.getWireframeMesh=function(){return this.buffer.getWireframeMesh()},jd.prototype.getPickingMesh=function(){return this.getMesh(!0)},jd.prototype.setAttributes=function(e){this.buffer.setAttributes(e)},jd.prototype.setParameters=function(e){"front"===(e=Object.assign({},e)).side?(this.frontMeshes.forEach(Bd),this.backMeshes.forEach(zd)):"back"===e.side?(this.frontMeshes.forEach(zd),this.backMeshes.forEach(Bd)):"double"===e.side&&(this.frontMeshes.forEach(Bd),this.backMeshes.forEach(Bd)),void 0!==e.side&&(this.side=e.side),delete e.side,void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,this.frontBuffer.setParameters(e),void 0!==e.wireframe&&(this.wireframe=e.wireframe,this.setVisibility(this.visible)),delete e.wireframe,this.backBuffer.setParameters(e)},jd.prototype.setVisibility=function(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))},jd.prototype.dispose=function(){this.frontBuffer.dispose(),this.backBuffer.dispose()},Object.defineProperties(jd.prototype,Hd),Al.add("shader/Line.vert","uniform float clipNear;\nuniform vec3 clipCenter;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include color_pars_vertex\nvoid main(){\n#include color_vertex\n#include begin_vertex\n#include project_vertex\nvViewPosition = -mvPosition.xyz;\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Al.add("shader/Line.frag","uniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\ngl_FragColor = vec4( vColor, opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n}");var $d=function(e){function t(){e.apply(this,arguments),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Fd),Gd=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="surface",this.parameters=Object.assign({isolevelType:{type:"select",options:{value:"value",sigma:"sigma"}},isolevel:{type:"number",precision:2,max:1e3,min:-1e3},negateIsolevel:{type:"boolean"},isolevelScroll:{type:"boolean"},smooth:{type:"integer",precision:1,max:10,min:0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},boxSize:{type:"integer",precision:1,max:100,min:0},colorVolume:{type:"hidden"},contour:{type:"boolean",rebuild:!0},useWorker:{type:"boolean",rebuild:!0},wrap:{type:"boolean",rebuild:!0}},this.parameters),t instanceof Pd?(this.surface=void 0,this.volume=t):(this.surface=t,this.volume=void 0),this.boxCenter=new ft,this.__boxCenter=new ft,this.box=new _r,this.__box=new _r,this._position=new ft,this.setBox=function(){this._position.copy(r.translationGroup.position).negate(),this._position.equals(this.boxCenter)||this.setParameters({boxCenter:this._position})},this.viewer.signals.ticked.add(this.setBox,this),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"uniform"),r.colorValue=Ha(r.colorValue,14540253),this.isolevelType=Ha(r.isolevelType,"sigma"),this.isolevel=Ha(r.isolevel,2),this.negateIsolevel=Ha(r.negateIsolevel,!1),this.isolevelScroll=Ha(r.isolevelScroll,!1),this.smooth=Ha(r.smooth,0),this.background=Ha(r.background,!1),this.opaqueBack=Ha(r.opaqueBack,!0),this.boxSize=Ha(r.boxSize,0),this.colorVolume=Ha(r.colorVolume,void 0),this.contour=Ha(r.contour,!1),this.useWorker=Ha(r.useWorker,!0),this.wrap=Ha(r.wrap,!1),e.prototype.init.call(this,r),this.build()},t.prototype.attach=function(e){var t=this;this.bufferList.forEach(function(e){t.viewer.add(e)}),this.setVisibility(this.visible),e()},t.prototype.prepare=function(e){var t,r=this;if(this.volume)if(t="sigma"===this.isolevelType?this.volume.getValueForSigma(this.isolevel):this.isolevel,this.negateIsolevel&&(t*=-1),!this.surface||this.__isolevel!==t||this.__smooth!==this.smooth||this.__contour!==this.contour||this.__wrap!==this.wrap||this.__boxSize!==this.boxSize||this.boxSize>0&&!this.__boxCenter.equals(this.boxCenter)){this.__isolevel=t,this.__smooth=this.smooth,this.__contour=this.contour,this.__wrap=this.wrap,this.__boxSize=this.boxSize,this.__boxCenter.copy(this.boxCenter),this.__box.copy(this.box);var n=function(t){r.surface=t,e()};this.useWorker?this.volume.getSurfaceWorker(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap,n):n(this.volume.getSurface(t,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap))}else e();else e()},t.prototype.create=function(){var e,t={position:this.surface.getPosition(),color:this.surface.getColor(this.getColorParams()),index:this.surface.getIndex()};if(this.contour)e=new $d(t,this.getBufferParams({wireframe:!1}));else{t.normal=this.surface.getNormal(),t.picking=this.surface.getPicking();var r=new Vd(t,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));e=new jd(r)}this.bufferList.push(e)},t.prototype.update=function(e){if(0!==this.bufferList.length){var t={};(e=e||{}).position&&(t.position=this.surface.getPosition()),e.color&&(t.color=this.surface.getColor(this.getColorParams())),e.index&&(t.index=this.surface.getIndex()),e.normal&&(t.normal=this.surface.getNormal()),this.bufferList.forEach(function(e){e.setAttributes(t)})}},t.prototype.setParameters=function(t,r,n){return t&&void 0!==t.isolevelType&&this.volume&&("value"===this.isolevelType&&"sigma"===t.isolevelType?this.isolevel=this.volume.getSigmaForValue(this.isolevel):"sigma"===this.isolevelType&&"value"===t.isolevelType&&(this.isolevel=this.volume.getValueForSigma(this.isolevel)),this.isolevelType=t.isolevelType),t&&t.boxCenter&&(this.boxCenter.copy(t.boxCenter),delete t.boxCenter),t&&t.wireframe&&(t.contour||void 0===t.contour&&this.contour)&&(t.wireframe=!1),e.prototype.setParameters.call(this,t,r,n),this.volume&&this.volume.getBox(this.boxCenter,this.boxSize,this.box),t&&void 0!==t.colorVolume&&(r.color=!0),this.surface&&(void 0!==t.isolevel||void 0!==t.negateIsolevel||void 0!==t.smooth||void 0!==t.wrap||void 0!==t.boxSize||this.boxSize>0&&!this.__box.equals(this.box))&&this.build({position:!0,color:!0,index:!0,normal:!this.contour}),this},t.prototype.getColorParams=function(){var t=e.prototype.getColorParams.call(this);return t.volume=this.colorVolume,t},t.prototype.dispose=function(){this.viewer.signals.ticked.remove(this.setBox,this),e.prototype.dispose.call(this)},t}(Dc),Wd=function(){};Wd.zoomScroll=function(e,t){e.trackballControls.zoom(t)},Wd.clipNearScroll=function(e,t){var r=e.getParameters();e.setParameters({clipNear:r.clipNear+t/10})},Wd.focusScroll=function(e,t){var r=2*e.getParameters().clipNear,n=Math.sign(t)*function(e,t,r){if(e>t)return e;var n=e/t;return((2*r-t)*n+(2*t-3*r))*n*n+r}((100-r)/10,5,.2);e.setFocus(r+n)},Wd.isolevelScroll=function(e,t){var r=Math.sign(t)/10;e.eachRepresentation(function(e,t){if(e.repr instanceof Gd){var n=e.getParameters();n.isolevelScroll&&e.setParameters({isolevel:n.isolevel+r})}})},Wd.panDrag=function(e,t,r){e.trackballControls.pan(t,r)},Wd.rotateDrag=function(e,t,r){e.trackballControls.rotate(t,r)},Wd.zoomDrag=function(e,t,r){e.trackballControls.zoom((t+r)/-2)},Wd.zoomFocusDrag=function(e,t,r){e.trackballControls.zoom((t+r)/-2);var n=e.viewer.camera.position.z;e.setFocus(100-Math.abs(n/8))},Wd.panComponentDrag=function(e,t,r){e.trackballControls.panComponent(t,r)},Wd.panAtomDrag=function(e,t,r){e.trackballControls.panAtom(t,r)},Wd.rotateComponentDrag=function(e,t,r){e.trackballControls.rotateComponent(t,r)},Wd.movePick=function(e,t){t&&e.animationControls.move(t.position.clone())},Wd.tooltipPick=function(e,t){var r=e.tooltip;if(e.getParameters().tooltip&&t){var n=t.mouse.position;r.innerText=t.getLabel(),r.style.bottom=window.innerHeight-n.y+3+"px",r.style.left=n.x+3+"px",r.style.display="block"}else r.style.display="none"},Wd.measurePick=function(e,t){if(t&&(t.atom||t.bond)){var r=t.atom||t.closestBondAtom;t.component.measurePick(r)}else e.measureClear()};var qd={default:[["scroll",Wd.zoomScroll],["scroll-ctrl",Wd.clipNearScroll],["scroll-shift",Wd.focusScroll],["scroll-alt",Wd.isolevelScroll],["drag-right",Wd.panDrag],["drag-left",Wd.rotateDrag],["drag-middle",Wd.zoomDrag],["drag-shift-right",Wd.zoomDrag],["drag-left+right",Wd.zoomDrag],["drag-ctrl-right",Wd.panComponentDrag],["drag-ctrl-left",Wd.rotateComponentDrag],["clickPick-alt-left",Wd.measurePick],["clickPick-middle",Wd.movePick],["clickPick-shift-left",Wd.movePick],["hoverPick",Wd.tooltipPick]],pymol:[["drag-left",Wd.rotateDrag],["drag-middle",Wd.panDrag],["drag-right",Wd.zoomDrag],["drag-shift-right",Wd.focusScroll],["clickPick-ctrl+shift-middle",Wd.movePick],["hoverPick",Wd.tooltipPick]],coot:[["scroll",Wd.isolevelScroll],["drag-left",Wd.rotateDrag],["drag-middle",Wd.panDrag],["drag-ctrl-left",Wd.panDrag],["drag-right",Wd.zoomFocusDrag],["drag-ctrl-right",Wd.focusScroll],["clickPick-middle",Wd.movePick],["hoverPick",Wd.tooltipPick]],astexviewer:[["drag-left",Wd.rotateDrag],["drag-ctrl-left",Wd.panDrag],["drag-shift-left",Wd.zoomDrag],["scroll",Wd.focusScroll],["clickPick-middle",Wd.movePick]]};function Xd(e){var t=e.split(/[-+]/),r="";t.includes("scroll")&&(r="scroll"),t.includes("drag")&&(r="drag"),t.includes("click")&&(r="click"),t.includes("doubleClick")&&(r="doubleClick"),t.includes("hover")&&(r="hover"),t.includes("clickPick")&&(r="clickPick"),t.includes("hoverPick")&&(r="hoverPick");var n=0;t.includes("alt")&&(n+=1),t.includes("ctrl")&&(n+=2),t.includes("meta")&&(n+=4),t.includes("shift")&&(n+=8);var i=0;return t.includes("left")&&(i+=1),t.includes("right")&&(i+=2),t.includes("middle")&&(i+=4),[r,n,i]}var Kd=function(e,t){void 0===t&&(t={}),this.stage=e,this.actionList=[],this.mouse=e.mouseObserver,this.disabled=t.disabled||!1,this.preset(t.preset||"default")};Kd.prototype.run=function(e){for(var t=this,r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];if(!this.disabled){var i=this.mouse.key||0,o=this.mouse.buttons||0;this.actionList.forEach(function(n){n.type===e&&n.key===i&&n.button===o&&n.callback.apply(n,[t.stage].concat(r))})}},Kd.prototype.add=function(e,t){var r=Xd(e),n=r[0],i=r[1],o=r[2];this.actionList.push({type:n,key:i,button:o,callback:t})},Kd.prototype.remove=function(e,t){var r=e.includes("*"),n=Xd(e),i=n[0],o=n[1],a=n[2],s=this.actionList.filter(function(e){return!((e.type===i||r&&""===i)&&(e.key===o||r&&0===o)&&(e.button===a||r&&0===a)&&(e.callback===t||void 0===t))});this.actionList=s},Kd.prototype.preset=function(e){var t=this;this.clear(),(qd[e]||[]).forEach(function(e){return t.add(e[0],e[1])})},Kd.prototype.clear=function(){this.actionList.length=0};var Yd=function(){};Yd.autoView=function(e){e.autoView(1e3)},Yd.toggleAnimations=function(e){e.animationControls.toggle()},Yd.toggleRock=function(e){e.toggleRock()},Yd.toggleSpin=function(e){e.toggleSpin()},Yd.toggleAntialiasing=function(e){var t=e.getParameters();e.setParameters({sampleLevel:-1===t.sampleLevel?0:-1})};var Zd={default:[["i",Yd.toggleSpin],["k",Yd.toggleRock],["p",Yd.toggleAnimations],["a",Yd.toggleAntialiasing],["r",Yd.autoView]]},Jd=function(e,t){void 0===t&&(t={}),this.stage=e,this.actionList=[],this.disabled=t.disabled||!1,this.preset(t.preset||"default")};Jd.prototype.run=function(e){var t=this;this.disabled||this.actionList.forEach(function(r){r.keyCode===e&&r.callback(t.stage)})},Jd.prototype.add=function(e,t){var r=e.charCodeAt(0);this.actionList.push({keyCode:r,callback:t})},Jd.prototype.remove=function(e,t){var r=e.charCodeAt(0),n=this.actionList.filter(function(e){return!(e.keyCode===r&&(e.callback===t||void 0===t))});this.actionList=n},Jd.prototype.preset=function(e){var t=this;this.clear(),(Zd[e]||[]).forEach(function(e){return t.add(e[0],e[1])})},Jd.prototype.clear=function(){this.actionList.length=0};var Qd=function(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this)};Qd.prototype._onClick=function(e,t){var r=this.stage.pickingControls.pick(e,t);this.stage.signals.clicked.dispatch(r),this.controls.run("clickPick",r)},Qd.prototype._onHover=function(e,t){var r=this.stage.pickingControls.pick(e,t);r&&this.mouse.down.equals(this.mouse.position)&&(this.stage.transformComponent=r.component,this.stage.transformAtom=r.atom),this.stage.signals.hovered.dispatch(r),this.controls.run("hoverPick",r)},Qd.prototype.dispose=function(){this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)};var ef=function(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.moved.add(this._onMove,this),this.mouse.signals.scrolled.add(this._onScroll,this),this.mouse.signals.dragged.add(this._onDrag,this),this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this),this.mouse.signals.doubleClicked.add(this._onDblclick,this)};ef.prototype._onMove=function(){this.stage.tooltip.style.display="none"},ef.prototype._onScroll=function(e){this.controls.run("scroll",e)},ef.prototype._onDrag=function(e,t){this.controls.run("drag",e,t)},ef.prototype._onClick=function(e,t){this.controls.run("click",e,t)},ef.prototype._onDblclick=function(e,t){this.controls.run("doubleClick",e,t)},ef.prototype._onHover=function(e,t){this.controls.run("hover",e,t)},ef.prototype.dispose=function(){this.mouse.signals.moved.remove(this._onMove,this),this.mouse.signals.scrolled.remove(this._onScroll,this),this.mouse.signals.dragged.remove(this._onDrag,this),this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)};var tf=function(e){this.stage=e,this.viewer=e.viewer,this.animationControls=e.animationControls,this.viewer.signals.ticked.add(this._onTick,this)};tf.prototype._onTick=function(e){this.animationControls.run(e)},tf.prototype.dispose=function(){this.viewer.signals.ticked.remove(this._onTick,this)};var rf=!!hl&&{passive:!0},nf=function(e){this.stage=e,this.stage=e,this.controls=e.keyControls,this.domElement=e.viewer.renderer.domElement,this.domElement.setAttribute("tabIndex","-1"),this.domElement.style.outline="none",this._focusDomElement=this._focusDomElement.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onKeypress=this._onKeypress.bind(this),this.domElement.addEventListener("mousedown",this._focusDomElement),this.domElement.addEventListener("touchstart",this._focusDomElement,rf),this.domElement.addEventListener("keydown",this._onKeydown),this.domElement.addEventListener("keyup",this._onKeyup),this.domElement.addEventListener("keypress",this._onKeypress)};nf.prototype._onKeydown=function(){},nf.prototype._onKeyup=function(){},nf.prototype._onKeypress=function(e){this.controls.run(e.keyCode)},nf.prototype._focusDomElement=function(){this.domElement.focus()},nf.prototype.dispose=function(){this.domElement.removeEventListener("mousedown",this._focusDomElement),this.domElement.removeEventListener("touchstart",this._focusDomElement,rf),this.domElement.removeEventListener("keydown",this._onKeypress),this.domElement.removeEventListener("keyup",this._onKeypress),this.domElement.removeEventListener("keypress",this._onKeypress)};var of=function(e,t,r,n){void 0===n&&(n={}),this.component=e,this.position=t,this.offsetX=Ha(n.offsetX,0),this.offsetY=Ha(n.offsetY,0),this.visible=Ha(n.visible,!0),this.stage=e.stage,this.viewer=e.stage.viewer,this._viewerPosition=new ft,this._updateViewerPosition(),this._canvasPosition=new ht,this._cameraPosition=new ft,this.element=document.createElement("div"),Object.assign(this.element.style,{display:"block",position:"fixed",zIndex:1+parseInt(this.viewer.container.style.zIndex||"0"),pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif",left:"-10000px"}),this.viewer.container.appendChild(this.element),this.setContent(r),this.updateVisibility(),this.viewer.signals.ticked.add(this._update,this),this.component.signals.matrixChanged.add(this._updateViewerPosition,this)};of.prototype.setContent=function(e){var t=this.element.style.display;"none"===t&&(this.element.style.left="-10000px",this.element.style.display="block"),e instanceof HTMLElement?(this.element.innerHTML="",this.element.appendChild(e)):this.element.innerHTML=e,this._clientRect=this.element.getBoundingClientRect(),"none"===t&&(this.element.style.display=t)},of.prototype.setVisibility=function(e){this.visible=e,this.updateVisibility()},of.prototype.getVisibility=function(){return this.visible&&this.component.parameters.visible},of.prototype.updateVisibility=function(){this.element.style.display=this.getVisibility()?"block":"none"},of.prototype._updateViewerPosition=function(){this._viewerPosition.copy(this.position).applyMatrix4(this.component.matrix)},of.prototype._update=function(){if(this.getVisibility()){var e=this.element.style,t=this._canvasPosition,r=this._viewerPosition,n=this._clientRect;if(this._cameraPosition.copy(r).add(this.viewer.translationGroup.position).applyMatrix4(this.viewer.rotationGroup.matrix).sub(this.viewer.camera.position),this._cameraPosition.z<0)e.display="none";else{e.display="block";var i=this.viewer.scene.fog;e.opacity=(1-_s(i.near,i.far,this._cameraPosition.length())).toString(),this.stage.viewerControls.getPositionOnCanvas(r,t),e.bottom=this.offsetX+t.y+n.height/2+"px",e.left=this.offsetY+t.x-n.width/2+"px"}}},of.prototype.dispose=function(){this.viewer.container.removeChild(this.element),this.viewer.signals.ticked.remove(this._update,this),this.component.signals.matrixChanged.remove(this._updateViewerPosition,this)};var af=new pt,sf=new ft,lf=new dt,uf=function(e){this.component=e,this.signals={changed:new As},this.stage=e.stage,this.viewer=e.stage.viewer},cf={position:{configurable:!0},rotation:{configurable:!0}};cf.position.get=function(){return this.component.position},cf.rotation.get=function(){return this.component.quaternion},uf.prototype.changed=function(){this.component.updateMatrix(),this.viewer.requestRender(),this.signals.changed.dispatch()},uf.prototype.spin=function(e,t){af.getInverse(this.viewer.rotationGroup.matrix),sf.copy(ss(e)).applyMatrix4(af),af.extractRotation(this.component.transform),af.premultiply(this.viewer.rotationGroup.matrix),af.getInverse(af),sf.copy(ss(e)),sf.applyMatrix4(af),af.makeRotationAxis(sf,t),lf.setFromRotationMatrix(af),this.component.quaternion.premultiply(lf),this.changed()},Object.defineProperties(uf.prototype,cf);var hf={"":"",vdw:"by vdW radius",covalent:"by covalent radius",sstruc:"by secondary structure",bfactor:"by bfactor",size:"size",data:"data"},pf=function(e){void 0===e&&(e={}),this.max=10,this.type=Ha(e.type,"size"),this.scale=Ha(e.scale,1),this.size=Ha(e.size,1),this.data=Ha(e.data,{})};pf.prototype.atomRadius=function(e){var t;switch(this.type){case"vdw":t=e.vdw;break;case"covalent":t=e.covalent;break;case"bfactor":t=e.bfactor||1;break;case"sstruc":var r=e.sstruc;t="h"===r?.25:"g"===r?.25:"i"===r?.25:"e"===r?.25:"b"===r?.25:np.includes(e.atomname)?.4:.1;break;case"data":t=Ha(this.data[e.index],1);break;default:t=this.size}return Math.min(t*this.scale,this.max)},pf.types=hf;var df=new ft(-1,-1,-1),ff=new pt,mf=function(e){var t=e.rows,r=t/3,n=new nd(t,3),i=new nd(3,3),o=new nd(1,3),a=new nd(3,3),s=new nd(3,3),l=sd(e);ld(e,l),id(n,e),od(i,n,n),dd(i,o,a,s);var u=new ft(l[0],l[1],l[2]),c=new ft(a.data[0],a.data[3],a.data[6]),h=new ft(a.data[1],a.data[4],a.data[7]),p=new ft(a.data[2],a.data[5],a.data[8]),d=c.clone().multiplyScalar(Math.sqrt(o.data[0]/r)),f=h.clone().multiplyScalar(Math.sqrt(o.data[1]/r)),m=p.clone().multiplyScalar(Math.sqrt(o.data[2]/r));this.begA=u.clone().sub(d),this.endA=u.clone().add(d),this.begB=u.clone().sub(f),this.endB=u.clone().add(f),this.begC=u.clone().sub(m),this.endC=u.clone().add(m),this.center=u,this.vecA=d,this.vecB=f,this.vecC=m,this.normVecA=c,this.normVecB=h,this.normVecC=p};mf.prototype.getBasisMatrix=function(e){void 0===e&&(e=new pt);var t=e;return t.makeBasis(this.normVecB,this.normVecA,this.normVecC),t.determinant()<0&&t.scale(df),t},mf.prototype.getRotationQuaternion=function(e){void 0===e&&(e=new dt);var t=e;return t.setFromRotationMatrix(this.getBasisMatrix(ff)),t.inverse()},mf.prototype.getProjectedScaleForAtoms=function(e){var t=-1/0,r=-1/0,n=-1/0,i=-1/0,o=-1/0,a=-1/0,s=new ft,l=new ft,u=this.center,c=this.normVecA,h=this.normVecB,p=this.normVecC;return e.eachAtom(function(e){Lc(s.copy(e),c,u);var d=l.subVectors(s,u).normalize().dot(c),f=s.distanceTo(u);d>0?f>t&&(t=f):f>r&&(r=f),Lc(s.copy(e),h,u);var m=l.subVectors(s,u).normalize().dot(h),g=s.distanceTo(u);m>0?g>n&&(n=g):g>i&&(i=g),Lc(s.copy(e),p,u);var v=l.subVectors(s,u).normalize().dot(p),y=s.distanceTo(u);v>0?y>o&&(o=y):y>a&&(a=y)}),{d1a:t,d2a:n,d3a:o,d1b:-r,d2b:-i,d3b:-a}};var gf=function(e,t,r,n){this.volume=e,this.setFilter(t,r,n)},vf={header:{configurable:!0},matrix:{configurable:!0},normalMatrix:{configurable:!0},inverseMatrix:{configurable:!0},center:{configurable:!0},boundingBox:{configurable:!0},min:{configurable:!0},max:{configurable:!0},mean:{configurable:!0},rms:{configurable:!0}};vf.header.get=function(){return this.volume.header},vf.matrix.get=function(){return this.volume.matrix},vf.normalMatrix.get=function(){return this.volume.normalMatrix},vf.inverseMatrix.get=function(){return this.volume.inverseMatrix},vf.center.get=function(){return this.volume.center},vf.boundingBox.get=function(){return this.volume.boundingBox},vf.min.get=function(){return this.volume.min},vf.max.get=function(){return this.volume.max},vf.mean.get=function(){return this.volume.mean},vf.rms.get=function(){return this.volume.rms},gf.prototype._getFilterHash=function(e,t,r){return JSON.stringify([e,t,r])},gf.prototype.setFilter=function(e,t,r){isNaN(e)&&this.header&&(e=this.header.DMEAN+2*this.header.ARMS),e=void 0===e||isNaN(e)?-1/0:e,t=Ha(t,1/0),r=Ha(r,!1);var n=this.volume.data,i=this.volume.position,o=this.volume.atomindex,a=this._getFilterHash(e,t,r);if(a!==this._filterHash){if(e===-1/0&&t===1/0)this.data=n,this.position=i,this.atomindex=o;else{var s=n.length;this._dataBuffer||(this._dataBuffer=new ArrayBuffer(4*s),this._positionBuffer=new ArrayBuffer(3*s*4),o&&(this._atomindexBuffer=new ArrayBuffer(4*s)));var l,u=new Float32Array(this._dataBuffer),c=new Float32Array(this._positionBuffer);o&&(l=new Uint32Array(this._atomindexBuffer));for(var h=0,p=0;p<s;++p){var d=3*p,f=n[p];if(!r&&f>=e&&f<=t||r&&(f<e||f>t)){var m=3*h;u[h]=f,c[m+0]=i[d+0],c[m+1]=i[d+1],c[m+2]=i[d+2],o&&(l[h]=o[p]),h+=1}}this.data=new Float32Array(this._dataBuffer,0,h),this.position=new Float32Array(this._positionBuffer,0,3*h),o&&(this.atomindex=new Float32Array(this._atomindexBuffer,0,h))}this._filterHash=a}},Object.defineProperties(gf.prototype,vf),gf.prototype.getValueForSigma=Pd.prototype.getValueForSigma,gf.prototype.getSigmaForValue=Pd.prototype.getSigmaForValue,gf.prototype.getDataAtomindex=Pd.prototype.getDataAtomindex,gf.prototype.getDataPosition=Pd.prototype.getDataPosition,gf.prototype.getDataColor=Pd.prototype.getDataColor,gf.prototype.getDataPicking=Pd.prototype.getDataPicking,gf.prototype.getDataSize=Pd.prototype.getDataSize;var yf=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["atomIndex1",1,"int32"],["atomIndex2",1,"int32"],["bondOrder",1,"int8"]]},t.prototype.addBond=function(e,t,r){this.growIfFull();var n=this.count,i=e.index,o=t.index;i<o?(this.atomIndex1[n]=i,this.atomIndex2[n]=o):(this.atomIndex2[n]=i,this.atomIndex1[n]=o),r&&(this.bondOrder[n]=r),this.count+=1},t.prototype.addBondIfConnected=function(e,t,r){return!!e.connectedTo(t)&&(this.addBond(e,t,r),!0)},Object.defineProperties(t.prototype,r),t}(yh),bf=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["residueIndex",1,"uint32"],["atomTypeId",1,"uint16"],["x",1,"float32"],["y",1,"float32"],["z",1,"float32"],["serial",1,"int32"],["bfactor",1,"float32"],["altloc",1,"uint8"],["occupancy",1,"float32"]]},t.prototype.setAltloc=function(e,t){this.altloc[e]=t.charCodeAt(0)},t.prototype.getAltloc=function(e){var t=this.altloc[e];return t?String.fromCharCode(t):""},Object.defineProperties(t.prototype,r),t}(yh),wf=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["chainIndex",1,"uint32"],["atomOffset",1,"uint32"],["atomCount",1,"uint16"],["residueTypeId",1,"uint16"],["resno",1,"int32"],["sstruc",1,"uint8"],["inscode",1,"uint8"]]},t.prototype.setSstruc=function(e,t){this.sstruc[e]=t.charCodeAt(0)},t.prototype.getSstruc=function(e){var t=this.sstruc[e];return t?String.fromCharCode(t):""},t.prototype.setInscode=function(e,t){this.inscode[e]=t.charCodeAt(0)},t.prototype.getInscode=function(e){var t=this.inscode[e];return t?String.fromCharCode(t):""},Object.defineProperties(t.prototype,r),t}(yh),xf=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["entityIndex",1,"uint16"],["modelIndex",1,"uint16"],["residueOffset",1,"uint32"],["residueCount",1,"uint32"],["chainname",4,"uint8"],["chainid",4,"uint8"]]},t.prototype.setChainname=function(e,t){var r=4*e;this.chainname[r]=t.charCodeAt(0),this.chainname[r+1]=t.charCodeAt(1),this.chainname[r+2]=t.charCodeAt(2),this.chainname[r+3]=t.charCodeAt(3)},t.prototype.getChainname=function(e){for(var t="",r=0;r<4;++r){var n=this.chainname[4*e+r];if(!n)break;t+=String.fromCharCode(n)}return t},t.prototype.setChainid=function(e,t){var r=4*e;this.chainid[r]=t.charCodeAt(0),this.chainid[r+1]=t.charCodeAt(1),this.chainid[r+2]=t.charCodeAt(2),this.chainid[r+3]=t.charCodeAt(3)},t.prototype.getChainid=function(e){for(var t="",r=0;r<4;++r){var n=this.chainid[4*e+r];if(!n)break;t+=String.fromCharCode(n)}return t},Object.defineProperties(t.prototype,r),t}(yh),_f=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={_defaultFields:{configurable:!0}};return r._defaultFields.get=function(){return[["chainOffset",1,"uint32"],["chainCount",1,"uint32"]]},Object.defineProperties(t.prototype,r),t}(yh),Sf=function(e){this.polymer=e,this.size=e.residueCount};Sf.prototype.getCenterIterator=function(e){void 0===e&&(e=0);var t=this.getPosition().center,r=t.length/3,n=0,i=-1,o=[new ft,new ft,new ft,new ft];return{size:r,next:function(){var e=this.get(i);return i+=1,e},get:function(i){i=Math.min(r-1,Math.max(0,i));var a=o[n%4],s=3*i;if(a.fromArray(t,s),e){for(var l=Math.min(e,i,r-i-1),u=1;u<=l;++u){var c=3*u,h=(l+1-u)/(l+1);a.x+=h*t[s-c+0]+h*t[s+c+0],a.y+=h*t[s-c+1]+h*t[s+c+1],a.z+=h*t[s-c+2]+h*t[s+c+2]}a.x/=l+1,a.y/=l+1,a.z/=l+1}return n+=1,a},reset:function(){n=0,i=-1}}},Sf.prototype.getColor=function(e){var t=this.polymer,r=t.structure,n=t.residueCount,i=t.residueIndexStart,o=new Float32Array(3*n),a=e||{};a.structure=r;for(var s=Sl.getScheme(a),l=r.getResidueProxy(),u=r.getAtomProxy(),c=0;c<n;++c)l.index=i+c,u.index=l.traceAtomIndex,s.atomColorToArray(u,o,3*c);return{color:o}},Sf.prototype.getPicking=function(){for(var e=this.polymer,t=e.structure,r=e.residueCount,n=e.residueIndexStart,i=new Float32Array(r),o=t.getResidueProxy(),a=0;a<r;++a)o.index=n+a,i[a]=o.traceAtomIndex;return{picking:new kp(i,t)}},Sf.prototype.getSize=function(e){for(var t=this.polymer,r=t.structure,n=t.residueCount,i=t.residueIndexStart,o=new Float32Array(n),a=new pf(e),s=r.getResidueProxy(),l=r.getAtomProxy(),u=0;u<n;++u)s.index=i+u,l.index=s.traceAtomIndex,o[u]=a.atomRadius(l);return{size:o}},Sf.prototype.getPosition=function(){for(var e,t,r,n,i,o=this.polymer,a=o.structure,s=o.residueCount,l=s-3,u=new Float32Array(3*s),c=new Float32Array(3*s),h=new Float32Array(s),p=new Float32Array(s),d=new Float32Array(s),f=new Float32Array(s),m=new Float32Array(3*s),g=new ft,v=new ft,y=new ft,b=new ft,w=new ft,x=new ft,_=new ft,S=new ft,C=new ft,M=new ft,T=new ft,A=new ft(0,0,0),E="trace",P=a.getAtomProxy(),R=a.getAtomProxy(o.getAtomIndexByType(0,E)),I=a.getAtomProxy(o.getAtomIndexByType(1,E)),N=a.getAtomProxy(o.getAtomIndexByType(2,E)),D=0;D<l;++D)P.index=R.index,R.index=I.index,I.index=N.index,N.index=o.getAtomIndexByType(D+3,E),t=3*D,g.subVectors(R,P),v.subVectors(I,R),y.subVectors(N,I),b.subVectors(g,v),w.subVectors(v,y),C.crossVectors(b,w).normalize(),C.toArray(c,t),D>0&&(h[D]=C.angleTo(M)),e=Math.cos(b.angleTo(w)),f[D]=180/Math.PI*Math.acos(e),n=b.length(),i=w.length(),p[D]=Math.sqrt(i*n)/Math.max(2,2*(1-e)),d[D]=Math.abs(v.dot(C)),x.copy(b).multiplyScalar(p[D]/n),_.copy(w).multiplyScalar(p[D]/i),x.subVectors(R,x),_.subVectors(I,_),x.toArray(u,t+3),_.toArray(u,t+6),T.subVectors(P,A),T.toArray(m,t),M.copy(C),A.copy(x);for(x.fromArray(u,3),_.fromArray(u,6),C.subVectors(x,_).normalize(),P.index=o.getAtomIndexByType(0,E),A.copy(P),S.copy(P),Lc(S,C,x),S.toArray(u,0),T.subVectors(A,x),T.toArray(m,0),x.fromArray(u,3*s-6),_.fromArray(u,3*s-9),C.subVectors(x,_).normalize(),P.index=o.getAtomIndexByType(s-1,E),A.copy(P),S.copy(P),Lc(S,C,x),S.toArray(u,3*s-3),r=s-3;r<s;++r)x.fromArray(u,3*r),P.index=o.getAtomIndexByType(r,E),A.copy(P),T.subVectors(A,x),T.toArray(m,3*r);var k=new Float32Array(s),O=new Float32Array(s),F=new Float32Array(s),L=new Float32Array(s);k[1]=p[0],O[1]=f[0],F[1]=p[0];for(var U=2;U<s-2;++U)k[U]=.5*(p[U-2]+p[U-1]),O[U]=.5*(f[U-2]+f[U-1]),F[U]=.5*(d[U-2]+d[U-1]),x.fromArray(c,3*(U-2)),_.fromArray(c,3*(U-1)),L[U]=180/Math.PI*Math.acos(Math.cos(x.angleTo(_)));k[s-2]=p[s-4],O[s-2]=f[s-4],F[s-2]=d[s-4];var V=new Float32Array(3*s);for(bu(c,V,0,0,3),bu(c,V,0,3,3),r=2;r<s-2;++r)x.fromArray(c,3*(r-2)),_.fromArray(c,3*(r-1)),C.addVectors(_,x).multiplyScalar(.5).normalize(),C.toArray(V,3*r);return bu(c,V,3*s-12,3*s-6,3),bu(c,V,3*s-12,3*s-3,3),{center:u,axis:V,bending:L,radius:k,rise:F,twist:O,resdir:m}};var Cf=function(e){this.polymer=e,this.helixorient=new Sf(e),this.position=this.helixorient.getPosition()};Cf.prototype.getAxis=function(e,t,r,n,i){e=e||30,t=t||2.5,r=void 0!==r&&r;var o=this.polymer,a=o.structure,s=o.residueCount,l=o.residueIndexStart,u=this.position,c=n||{};c.structure=a;for(var h,p,d=Sl.getScheme(c),f=new pf(i),m=0,g=0,v=[],y=[],b=[],w=[],x=[],_=[],S=[],C=[],M=[],T=[],A=[],E=new ft,P=new ft,R=a.getResidueProxy(),I=a.getResidueProxy(),N=a.getAtomProxy(),D=new ft,k=new ft,O=!1,F=0;F<s;++F)if(R.index=l+F,D.fromArray(u.center,3*F),F===s-1?O=!0:(I.index=l+F+1,k.fromArray(u.center,3*F+3),r&&R.sstruc!==I.sstruc?O=!0:D.distanceTo(k)>t?O=!0:u.bending[F]>e&&(O=!0)),O){if(F-m<4){m=F,O=!1;continue}N.index=R.traceAtomIndex,T=u.axis.subarray(3*m+3,3*F),A=u.center.subarray(3*m,3*F+3),h=Fc(T).normalize(),p=Fc(A),E.fromArray(A),Lc(E,h,p),P.fromArray(A,A.length-3),Lc(P,h,p),h.subVectors(P,E),h.toArray(v,g),p.toArray(y,g),E.toArray(b,g),P.toArray(w,g),d.atomColorToArray(N,x,g),_.push(N.index),S.push(f.atomRadius(N)),C.push(l+m),M.push(l+F+1-m),g+=3,m=F,O=!1}var L=new Float32Array(_);return{axis:new Float32Array(v),center:new Float32Array(y),begin:new Float32Array(b),end:new Float32Array(w),color:new Float32Array(x),picking:new kp(L,a),size:new Float32Array(S),residueOffset:C,residueCount:M}};var Mf=function(e){this.scoreFunction=e,this.content=[],this.scoreFunction=e};Mf.prototype.push=function(e){this.content.push(e),this.bubbleUp(this.content.length-1)},Mf.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return t&&this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),e},Mf.prototype.peek=function(){return this.content[0]},Mf.prototype.remove=function(e){for(var t=this.content.length,r=0;r<t;r++)if(this.content[r]===e){var n=this.content.pop();return void(n&&r!==t-1&&(this.content[r]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.bubbleUp(r):this.sinkDown(r)))}throw new Error("Node not found.")},Mf.prototype.size=function(){return this.content.length},Mf.prototype.bubbleUp=function(e){for(var t=this.content[e];e>0;){var r=Math.floor((e+1)/2)-1,n=this.content[r];if(!(this.scoreFunction(t)<this.scoreFunction(n)))break;this.content[r]=t,this.content[e]=n,e=r}},Mf.prototype.sinkDown=function(e){for(var t=this.content.length,r=this.content[e],n=this.scoreFunction(r),i=0;;){var o=2*(e+1),a=o-1,s=null;if(a<t){var l=this.content[a];(i=this.scoreFunction(l))<n&&(s=a)}if(o<t){var u=this.content[o];this.scoreFunction(u)<(null===s?n:i)&&(s=o)}if(null===s)break;this.content[e]=this.content[s],this.content[s]=r,e=s}};
/**
 * Kdtree
 * @class
 * @author Alexander Rose <alexander.rose@weirdbyte.de>, 2016
 * @author Roman Bolzern <roman.bolzern@fhnw.ch>, 2013
 * @author I4DS http://www.fhnw.ch/i4ds, 2013
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 * @description
 * k-d Tree for typed arrays of 3d points (e.g. for Float32Array), in-place
 * provides fast nearest neighbour search
 *
 * Based on https://github.com/ubilabs/kd-tree-javascript by Ubilabs
 *
 * Further information (including mathematical properties)
 * http://en.wikipedia.org/wiki/Binary_tree
 * http://en.wikipedia.org/wiki/K-d_tree
 *
 * @example
 * points: [x, y, z, x, y, z, x, y, z, ...]
 * metric: function(a, b){
 *    return Math.pow(a[0]-b[0], 2) + Math.pow(a[1]-b[1], 2) + Math.pow(a[2]-b[2], 2);
 * }
 *
 * @param {Float32Array} points - points
 * @param {Function} metric - metric
 */
var Tf=function(e,t){this.points=e,this.metric=t,this.maxDepth=0,this.currentNode=0;for(var r=e.length/3,n=new Uint32Array(r),i=0;i<r;++i)n[i]=i;this.indices=n,this.nodes=new Int32Array(4*r),this.rootIndex=this.buildTree(0,-1,0,r)};Tf.prototype.buildTree=function(e,t,r,n){e>this.maxDepth&&(this.maxDepth=e);var i=n-r;if(0===i)return-1;var o=4*this.currentNode,a=this.nodes;if(this.currentNode+=1,1===i)return a[o]=r,a[o+1]=-1,a[o+2]=-1,a[o+3]=t,o;for(var s,l,u,c,h,p=this.indices,d=this.points,f=r+Math.floor(i/2),m=e%3,g=r,v=n-1;v>g;){for(c=d[3*p[u=g+v>>1]+m],l=p[u],p[u]=p[v],p[v]=l,h=g,s=g;s<v;++s)d[3*p[s]+m]<c&&(l=p[h],p[h]=p[s],p[s]=l,++h);if(l=p[v],p[v]=p[h],p[h]=l,f===(u=h))break;f<u?v=u-1:g=u+1}return a[o]=f,a[o+1]=this.buildTree(e+1,o,r,f),a[o+2]=this.buildTree(e+1,o,f+1,n),a[o+3]=t,o},Tf.prototype.getNodeDepth=function(e){var t=this.nodes[e+3];return-1===t?0:this.getNodeDepth(t)+1},Tf.prototype.nearest=function(e,t,r){var n=this,i=new Mf(function(e){return-e[1]}),o=this.nodes,a=this.points,s=this.indices,l=function(u){var c,h,p=n.getNodeDepth(u)%3,d=3*s[o[u]],f=[a[d+0],a[d+1],a[d+2]],m=n.metric(e,f);function g(e,r){i.push([e,r]),i.size()>t&&i.pop()}var v=o[u+1],y=o[u+2];if(-1!==y||-1!==v){c=-1===y?v:-1===v?y:e[p]<=a[d+p]?v:y,l(c),(i.size()<t||m<i.peek()[1])&&m<=r&&g(u,m);for(var b=[],w=0;w<3;w+=1)b[w]=w===p?e[w]:a[d+w];var x=n.metric(b,f);(i.size()<t||Math.abs(x)<i.peek()[1])&&Math.abs(x)<=r&&-1!==(h=c===v?y:v)&&l(h)}else(i.size()<t||m<i.peek()[1])&&m<=r&&g(u,m)};l(this.rootIndex);for(var u=[],c=0,h=Math.min(i.size(),t);c<h;c+=1)u.push(i.content[c]);return u},Tf.prototype.verify=function(e,t){void 0===t&&(t=0);var r=1;if(void 0===e&&(e=this.rootIndex),-1===e)throw new Error("node is null");var n=t%3,i=this.nodes,o=this.points,a=this.indices,s=i[e+1],l=i[e+2];if(-1!==s){if(o[3*a[i[s]]+n]>o[3*a[i[e]]+n])throw new Error("left child is > parent!");r+=this.verify(s,t+1)}if(-1!==l){if(o[3*a[i[l]]+n]<o[3*a[i[e]]+n])throw new Error("right child is < parent!");r+=this.verify(l,t+1)}return r};var Af=function(e,t){void 0===t&&(t=0),this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap},Ef={bondHash:{configurable:!0},entity:{configurable:!0},entityIndex:{configurable:!0},modelIndex:{configurable:!0},chainIndex:{configurable:!0},residue:{configurable:!0},residueIndex:{configurable:!0},sstruc:{configurable:!0},inscode:{configurable:!0},resno:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0},residueType:{configurable:!0},atomType:{configurable:!0},residueAtomOffset:{configurable:!0},resname:{configurable:!0},hetero:{configurable:!0},atomname:{configurable:!0},number:{configurable:!0},element:{configurable:!0},vdw:{configurable:!0},covalent:{configurable:!0},x:{configurable:!0},y:{configurable:!0},z:{configurable:!0},serial:{configurable:!0},bfactor:{configurable:!0},occupancy:{configurable:!0},altloc:{configurable:!0},partialCharge:{configurable:!0},formalCharge:{configurable:!0},aromatic:{configurable:!0},bondCount:{configurable:!0}};function Pf(e,t){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}function Rf(e,t){return Math.sqrt(Pf(e,t))}Ef.bondHash.get=function(){return this.structure.bondHash},Ef.entity.get=function(){return this.structure.entityList[this.entityIndex]},Ef.entityIndex.get=function(){return this.chainStore.entityIndex[this.chainIndex]},Ef.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},Ef.chainIndex.get=function(){return this.residueStore.chainIndex[this.residueIndex]},Ef.residue.get=function(){return console.warn("residue - might be expensive"),this.structure.getResidueProxy(this.residueIndex)},Ef.residueIndex.get=function(){return this.atomStore.residueIndex[this.index]},Ef.residueIndex.set=function(e){this.atomStore.residueIndex[this.index]=e},Ef.sstruc.get=function(){return this.residueStore.getSstruc(this.residueIndex)},Ef.inscode.get=function(){return this.residueStore.getInscode(this.residueIndex)},Ef.resno.get=function(){return this.residueStore.resno[this.residueIndex]},Ef.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},Ef.chainid.get=function(){return this.chainStore.getChainid(this.chainIndex)},Ef.residueType.get=function(){return this.residueMap.get(this.residueStore.residueTypeId[this.residueIndex])},Ef.atomType.get=function(){return this.atomMap.get(this.atomStore.atomTypeId[this.index])},Ef.residueAtomOffset.get=function(){return this.residueStore.atomOffset[this.residueIndex]},Ef.resname.get=function(){return this.residueType.resname},Ef.hetero.get=function(){return this.residueType.hetero},Ef.atomname.get=function(){return this.atomType.atomname},Ef.number.get=function(){return this.atomType.number},Ef.element.get=function(){return this.atomType.element},Ef.vdw.get=function(){return this.atomType.vdw},Ef.covalent.get=function(){return this.atomType.covalent},Ef.x.get=function(){return this.atomStore.x[this.index]},Ef.x.set=function(e){this.atomStore.x[this.index]=e},Ef.y.get=function(){return this.atomStore.y[this.index]},Ef.y.set=function(e){this.atomStore.y[this.index]=e},Ef.z.get=function(){return this.atomStore.z[this.index]},Ef.z.set=function(e){this.atomStore.z[this.index]=e},Ef.serial.get=function(){return this.atomStore.serial[this.index]},Ef.serial.set=function(e){this.atomStore.serial[this.index]=e},Ef.bfactor.get=function(){return this.atomStore.bfactor[this.index]},Ef.bfactor.set=function(e){this.atomStore.bfactor[this.index]=e},Ef.occupancy.get=function(){return this.atomStore.occupancy[this.index]},Ef.occupancy.set=function(e){this.atomStore.occupancy[this.index]=e},Ef.altloc.get=function(){return this.atomStore.getAltloc(this.index)},Ef.altloc.set=function(e){this.atomStore.setAltloc(this.index,e)},Ef.partialCharge.get=function(){return this.atomStore.partialCharge?this.atomStore.partialCharge[this.index]:null},Ef.partialCharge.set=function(e){this.atomStore.partialCharge&&(this.atomStore.partialCharge[this.index]=e)},Ef.formalCharge.get=function(){return this.atomStore.formalCharge?this.atomStore.formalCharge[this.index]:null},Ef.formalCharge.set=function(e){this.atomStore.formalCharge&&(this.atomStore.formalCharge[this.index]=e)},Ef.aromatic.get=function(){return this.atomStore.aromatic?this.atomStore.aromatic[this.index]:this.residueType.isAromatic(this)?1:0},Ef.aromatic.set=function(e){this.atomStore.aromatic&&(this.atomStore.aromatic[this.index]=e)},Ef.bondCount.get=function(){return this.bondHash.countArray[this.index]},Af.prototype.eachBond=function(e,t){t=t||this.structure._bp;for(var r=this.index,n=this.bondHash,i=n.indexArray,o=n.countArray[r],a=n.offsetArray[r],s=0;s<o;++s)t.index=i[a+s],e(t)},Af.prototype.eachBondedAtom=function(e,t){var r=t||this.structure._ap,n=this.index;this.eachBond(function(t){r.index=n!==t.atomIndex1?t.atomIndex1:t.atomIndex2,e(r)}),this.index=n},Af.prototype.hasBondTo=function(e){var t=!1;return this.eachBondedAtom(function(r){e.index===r.index&&(t=!0)}),t},Af.prototype.bondToElementCount=function(e){var t=0,r=this.index;return this.eachBondedAtom(function(r){r.element===e&&(t+=1)}),this.index=r,t},Af.prototype.hasBondToElement=function(e){return this.bondToElementCount(e)>0},Af.prototype.isBackbone=function(){var e=this.residueType.backboneIndexList;return e.length>0&&e.includes(this.index-this.residueAtomOffset)},Af.prototype.isPolymer=function(){if(this.structure.entityList.length>0)return this.entity.isPolymer();var e=this.residueType.moleculeType;return 3===e||4===e||5===e},Af.prototype.isSidechain=function(){return this.isPolymer()&&!this.isBackbone()},Af.prototype.isCg=function(){var e=this.residueType.backboneType;return 4===e||5===e||6===e},Af.prototype.isTrace=function(){return this.index===this.residueType.traceAtomIndex+this.residueAtomOffset},Af.prototype.isHetero=function(){return 1===this.residueType.hetero},Af.prototype.isProtein=function(){return 3===this.residueType.moleculeType},Af.prototype.isNucleic=function(){var e=this.residueType.moleculeType;return 4===e||5===e},Af.prototype.isRna=function(){return 4===this.residueType.moleculeType},Af.prototype.isDna=function(){return 5===this.residueType.moleculeType},Af.prototype.isWater=function(){return 1===this.residueType.moleculeType},Af.prototype.isIon=function(){return 2===this.residueType.moleculeType},Af.prototype.isSaccharide=function(){return 6===this.residueType.moleculeType},Af.prototype.isHelix=function(){return Lh.includes(this.sstruc)},Af.prototype.isSheet=function(){return Uh.includes(this.sstruc)},Af.prototype.isTurn=function(){return Vh.includes(this.sstruc)&&this.isProtein()},Af.prototype.isBonded=function(){return 0!==this.bondHash.countArray[this.index]},Af.prototype.isRing=function(){return 1===this.residueType.getRings().flags[this.index-this.residueAtomOffset]},Af.prototype.isAromatic=function(){return 1===this.aromatic},Af.prototype.isMetal=function(){return this.atomType.isMetal()},Af.prototype.isNonmetal=function(){return this.atomType.isNonmetal()},Af.prototype.isMetalloid=function(){return this.atomType.isMetalloid()},Af.prototype.isHalogen=function(){return this.atomType.isHalogen()},Af.prototype.isDiatomicNonmetal=function(){return this.atomType.isDiatomicNonmetal()},Af.prototype.isPolyatomicNonmetal=function(){return this.atomType.isPolyatomicNonmetal()},Af.prototype.isAlkaliMetal=function(){return this.atomType.isAlkaliMetal()},Af.prototype.isAlkalineEarthMetal=function(){return this.atomType.isAlkalineEarthMetal()},Af.prototype.isNobleGas=function(){return this.atomType.isNobleGas()},Af.prototype.isTransitionMetal=function(){return this.atomType.isTransitionMetal()},Af.prototype.isPostTransitionMetal=function(){return this.atomType.isPostTransitionMetal()},Af.prototype.isLanthanide=function(){return this.atomType.isLanthanide()},Af.prototype.isActinide=function(){return this.atomType.isActinide()},Af.prototype.getDefaultValence=function(){return this.atomType.getDefaultValence()},Af.prototype.getValenceList=function(){return this.atomType.getValenceList()},Af.prototype.getOuterShellElectronCount=function(){return this.atomType.getOuterShellElectronCount()},Af.prototype.distanceTo=function(e){var t=this.atomStore,r=e.atomStore,n=this.index,i=e.index,o=t.x[n]-r.x[i],a=t.y[n]-r.y[i],s=t.z[n]-r.z[i],l=o*o+a*a+s*s;return Math.sqrt(l)},Af.prototype.connectedTo=function(e){var t=this.atomStore,r=e.atomStore,n=this.index,i=e.index;if(t.altloc&&r.altloc){var o=t.altloc[n],a=r.altloc[i];if(0!==o&&0!==a&&32!==o&&32!==a&&o!==a)return!1}var s=t.x[n]-r.x[i],l=t.y[n]-r.y[i],u=t.z[n]-r.z[i],c=s*s+l*l+u*u;if(c<64&&this.isCg())return!0;if(isNaN(c))return!1;var h=this.covalent+e.covalent,p=h+.3,d=h-.5;return c<p*p&&c>d*d},Af.prototype.positionFromArray=function(e,t){return void 0===t&&(t=0),this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this},Af.prototype.positionToArray=function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.index,n=this.atomStore;return e[t+0]=n.x[r],e[t+1]=n.y[r],e[t+2]=n.z[r],e},Af.prototype.positionToVector3=function(e){return void 0===e&&(e=new ft),e.x=this.x,e.y=this.y,e.z=this.z,e},Af.prototype.positionFromVector3=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},Af.prototype.positionAdd=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},Af.prototype.positionSub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},Af.prototype.getResidueBonds=function(e){void 0===e&&(e=!1);var t,r,n,i,o=this.residueAtomOffset,a=this.index-this.residueAtomOffset,s=this.residueType.getBonds(),l=s.atomIndices1,u=s.atomIndices2;for(e||(i=[]),t=l.indexOf(a);-1!==t;){if(n=u[t]+o,!i)return n;i.push(n),t=l.indexOf(a,t+1)}for(r=u.indexOf(a);-1!==r;){if(n=l[r]+o,!i)return n;i.push(n),r=u.indexOf(a,r+1)}return i},Af.prototype.qualifiedName=function(e){void 0===e&&(e=!1);var t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chainname&&(t+=":"+this.chainname),this.atomname&&(t+="."+this.atomname),this.altloc&&(t+="%"+this.altloc),this.structure.modelStore.count>1&&(t+="/"+this.modelIndex),t},Af.prototype.clone=function(){return new Af(this.structure,this.index)},Af.prototype.toObject=function(){return{index:this.index,residueIndex:this.residueIndex,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,modelIndex:this.modelIndex}},Object.defineProperties(Af.prototype,Ef);var If=new Float32Array(3),Nf=function(e,t){void 0===t&&(t=!1),vl&&gl.time("Kdtree build");var r=t?Pf:Rf,n=new Float32Array(3*e.atomCount),i=new Uint32Array(e.atomCount),o=0;e.eachAtom(function(e){n[o+0]=e.x,n[o+1]=e.y,n[o+2]=e.z,i[o/3]=e.index,o+=3}),this.atomIndices=i,this.points=n,this.kdtree=new Tf(n,r),vl&&gl.timeEnd("Kdtree build")};Nf.prototype.nearest=function(e,t,r){e instanceof ft?e.toArray(If):e instanceof Af&&e.positionToArray(If);for(var n=this.kdtree.nearest(If,t,r),i=this.kdtree.indices,o=this.kdtree.nodes,a=this.atomIndices,s=[],l=0,u=n.length;l<u;++l){var c=n[l],h=c[0],p=c[1];s.push({index:a[i[o[h]]],distance:p})}return s};var Df={" ":"X","!":"Y","#":"Z",$:"-X","%":"-Y","&":"-Z","'":"Y+1/2","(":"1/2+X",")":"1/2+Y","*":"1/2-X","+":"1/2+Z",",":"1/2-Y","-":"1/2-Z",".":"X+1/2","/":"Z+1/2",0:"-X+1/2",1:"-Y+1/2",2:"-Z+1/2",3:"1/4+X",4:"1/4-Y",5:"1/4+Z",6:"1/4-X",7:"1/4+Y",8:"3/4-Y",9:"3/4+Z",":":"3/4+Y",";":"3/4+X","<":"3/4-X","=":"1/4-Z",">":"3/4-Z","?":"X-Y","@":"Y-X",A:"Z+1/3",B:"Z+2/3",C:"X+2/3",D:"Y+1/3",E:"-Y+2/3",F:"X-Y+1/3",G:"Y-X+2/3",H:"-X+1/3",I:"X+1/3",J:"Y+2/3",K:"-Y+1/3",L:"X-Y+2/3",M:"Y-X+1/3",N:"-X+2/3",O:"2/3+X",P:"1/3+Y",Q:"1/3+Z",R:"2/3-Y",S:"1/3+X-Y",T:"2/3+Y-X",U:"1/3-X",V:"2/3-X",W:"1/3-Y",X:"1/3-Z",Y:"2/3+Y",Z:"1/3+Y-X","[":"2/3+X-Y","]":"1/3+X","^":"2/3+Z",_:"2/3-Z","`":"5/6+Z",a:"1/6+Z",b:"5/6-Z",c:"1/6-Z",d:"Z+5/6",e:"Z+1/6",f:"Z+1/4",g:"+Y"},kf={"P 1":" !#","P -1":" !#$%&","P 1 2 1":" !#$!&","P 1 21 1":" !#$'&","C 1 2 1":" !#$!&()#*)&","P 1 m 1":" !# %#","P 1 c 1":" !# %+","C 1 m 1":" !# %#()#(,#","C 1 c 1":" !# %+()#(,+","P 1 2/m 1":" !# %#$!&$%&","P 1 21/m 1":" !#$)&$%& ,#","C 1 2/m 1":" !# %#$!&$%&()#(,#*)&*,&","P 1 2/c 1":" !#$!-$%& %+","P 1 21/c 1":" !#$%&$)- ,+","C 1 2/c 1":" !#$!-$%& %+()#*)-*,&(,+","P 2 2 2":" !#$%#$!& %&","P 2 2 21":" !#$%+$!- %&","P 21 21 2":" !#$%#*)&(,&","P 21 21 21":" !#*%+$)-(,&","C 2 2 21":" !#$%+$!- %&()#*,+*)-(,&","C 2 2 2":" !#$%#$!& %&()#*,#*)&(,&","F 2 2 2":" !#$%#$!& %& )+$,+$)- ,-(!+*%+*!-(%-()#*,#*)&(,&","I 2 2 2":" !#$%# %&$!&.'/01/.120'2","I 21 21 21":" !#*%+$)-(,&()+$,#*!& %-","P m m 2":" !#$%# %#$!#","P m c 21":" !#$%+ %+$!#","P c c 2":" !#$%# %+$!+","P m a 2":" !#$%#(%#*!#","P c a 21":" !#$%+(%#*!+","P n c 2":" !#$%# ,+$)+","P m n 21":" !#*%+(%+$!#","P b a 2":" !#$%#(,#*)#","P n a 21":" !#$%+(,#*)+","P n n 2":" !#$%#(,+*)+","C m m 2":" !#$%# %#$!#()#*,#(,#*)#","C m c 21":" !#$%+ %+$!#()#*,+(,+*)#","C c c 2":" !#$%# %+$!+()#*,#(,+*)+","A m m 2":" !#$%# %#$!# )+$,+ ,+$)+","A b m 2":" !#$%# ,#$)# )+$,+ %+$!+","A m a 2":" !#$%#(%#*!# )+$,+(,+*)+","A b a 2":" !#$%#(,#*)# )+$,+(%+*!+","F m m 2":" !#$%# %#$!# )+$,+ ,+$)+(!+*%+(%+*!+()#*,#(,#*)#","F d d 2":" !#$%#345675 )+$,+3896:9(!+*%+;49<79()#*,#;85<:5","I m m 2":" !#$%# %#$!#()+*,+(,+*)+","I b a 2":" !#$%#(,#*)#()+*,+ %+$!+","I m a 2":" !#$%#(%#*!#()+*,+ ,+$)+","P 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#","P 2/n 2/n 2/n":" !#$%#$!& %&*,-()-(,+*)+","P 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+","P 2/b 2/a 2/n":" !#$%#$!& %&*,&()&(,#*)#","P 21/m 2/m 2/a":" !#*%#$!&(%&$%&(!& %#*!#","P 2/n 21/n 2/a":" !#*%#*)- ,-$%&(!&(,+$)+","P 2/m 2/n 21/a":" !#*%+*!- %&$%&(!-(%+$!#","P 21/c 2/c 2/a":" !#*%#$!-(%-$%&(!& %+*!+","P 21/b 21/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#","P 21/c 21/c 2/n":" !#*,#$)-(%-$%&()& ,+*!+","P 2/b 21/c 21/m":" !#$%+$)- ,&$%& !- ,+$)#","P 21/n 21/n 2/m":" !#$%#*)-(,-$%& !&(,+*)+","P 21/m 21/m 2/n":" !#$%#*'&.,&*,&.'& %#$!#","P 21/b 2/c 21/n":" !#*,+$!-(,&$%&()- %+*)#","P 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#","P 21/n 21/m 21/a":" !#0%/$'&.12$%&.!2 1#0'/","C 2/m 2/c 21/m":" !#$%+$!- %&$%& !- %+$!#()#*,+*)-(,&*,&()-(,+*)#","C 2/m 2/c 21/a":" !#$,+$)- %&$%& )- ,+$!#()#*%+*!-(,&*,&(!-(%+*)#","C 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()#*,#*)&(,&*,&()&(,#*)#","C 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+()#*,#*)-(,-*,&()&(,+*)+","C 2/m 2/m 2/a":" !#$,#$)& %&$%& )& ,#$!#()#*%#*!&(,&*,&(!&(%#*)#","C 2/c 2/c 2/a":" !#*,#$!&(,&$,-(!- ,+*!+()#$%#*)& %&*%- )-(%+$)+","F 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!# )+$,+$)- ,-$,- )- ,+$)+(!+*%+*!-(%-*%-(!-(%+*!+()#*,#*)&(,&*,&()&(,#*)#","F 2/d 2/d 2/d":" !#$%#$!& %&64=37=345675 )+$,+$)- ,-68>3:>3896:9(!+*%+*!-(%-<4>;7>;49<79()#*,#*)&(,&<8=;:=;85<:5","I 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()+*,+*)-(,-*,-()-(,+*)+","I 2/b 2/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#()+*,+$!- %-*,-()- %+$!+","I 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#()+$,#*!& %-*,- )&(%#$!+","I 21/m 21/m 21/a":" !#$,#$)& %&$%& )& ,#$!#()+*%+*!-(,-*,-(!-(%+*)+","P 4":" !#$%#% #!$#","P 41":" !#$%+% 5!$9","P 42":" !#$%#% +!$+","P 43":" !#$%+% 9!$5","I 4":" !#$%#% #!$#()+*,+,(+)*+","I 41":" !#*,+%(5)$9()+$%#, 9!*5","P -4":" !#$%#!$&% &","I -4":" !#$%#!$&% &()+*,+)*-,(-","P 4/m":" !#$%#% #!$#$%& !&!$&% &","P 42/m":" !#$%#% +!$+$%& !&!$-% -","P 4/n":" !#$%#,(#)*#*,&()&!$&% &","P 42/n":" !#$%#,(+)*+*,-()-!$&% &","I 4/m":" !#$%#% #!$#$%& !&!$&% &()+*,+,(+)*+*,-()-)*-,(-","I 41/a":" !#*,+%(5)$9$,=(!>!$&,(-()+$%#, 9!*5*%> )=)*-% &","P 4 2 2":" !#$%#% #!$#$!& %&! &%$&","P 4 21 2":" !#$%#,(#)*#*)&(,&! &%$&","P 41 2 2":" !#$%+% 5!$9$!& %-! >%$=","P 41 21 2":" !#$%+,(5)*9*)=(,>! &%$-","P 42 2 2":" !#$%#% +!$+$!& %&! -%$-","P 42 21 2":" !#$%#,(+)*+*)-(,-! &%$&","P 43 2 2":" !#$%+% 9!$5$!& %-! =%$>","P 43 21 2":" !#$%+,(9)*5*)>(,=! &%$-","I 4 2 2":" !#$%#% #!$#$!& %&! &%$&()+*,+,(+)*+*)-(,-)(-,*-","I 41 2 2":" !#*,+%(5)$9*!> ,=)(-%$&()+$%#, 9!*5$)=(%>! &,*-","P 4 m m":" !#$%#% #!$# %#$!#%$#! #","P 4 b m":" !#$%#% #!$#(,#*)#,*#)(#","P 42 c m":" !#$%#% +!$+ %+$!+%$#! #","P 42 n m":" !#$%#,(+)*+(,+*)+%$#! #","P 4 c c":" !#$%#% #!$# %+$!+%$+! +","P 4 n c":" !#$%#% #!$#(,+*)+,*+)(+","P 42 m c":" !#$%#% +!$+ %#$!#%$+! +","P 42 b c":" !#$%#% +!$+(,#*)#,*+)(+","I 4 m m":" !#$%#% #!$# %#$!#%$#! #()+*,+,(+)*+(,+*)+,*+)(+","I 4 c m":" !#$%#% #!$# %+$!+%$+! +()+*,+,(+)*+(,#*)#,*#)(#","I 41 m d":" !#*,+%(5)$9 %#*)+%*5) 9()+$%#, 9!*5(,+$!#,$9!(5","I 41 c d":" !#*,+%(5)$9 %+*)#%*9) 5()+$%#, 9!*5(,#$!+,$5!(9","P -4 2 m":" !#$%#% &!$&$!& %&%$#! #","P -4 2 c":" !#$%#% &!$&$!- %-%$+! +","P -4 21 m":" !#$%#% &!$&*)&(,&,*#)(#","P -4 21 c":" !#$%#% &!$&*)-(,-,*+)(+","P -4 m 2":" !#$%#!$&% & %#$!#! &%$&","P -4 c 2":" !#$%#% &!$& %+$!+! -%$-","P -4 b 2":" !#$%#% &!$&(,#*)#)(&,*&","P -4 n 2":" !#$%#% &!$&(,+*)+)(-,*-","I -4 m 2":" !#$%#% &!$& %#$!#! &%$&()+*,+,(-)*-(,+*)+)(-,*-","I -4 c 2":" !#$%#% &!$& %+$!+! -%$-()+*,+,(-)*-(,#*)#)(&,*&","I -4 2 m":" !#$%#% &!$&$!& %&%$#! #()+*,+,(-)*-*)-(,-,*+)(+","I -4 2 d":" !#$%#% &!$&*!>(%>,$9) 9()+*,+,(-)*-$)= ,=%*5!(5","P 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #","P 4/m 2/c 2/c":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +","P 4/n 2/b 2/m":" !#$%#% #!$#$!& %&! &%$&*,&()&)*&,(&(,#*)#,*#)(#","P 4/n 2/n 2/c":" !#$%#% #!$#$!& %&! &%$&*,-()-)*-,(-(,+*)+,*+)(+","P 4/m 21/b 2/m":" !#$%#% #!$#*)&(,&)(&,*&$%& !&!$&% &(,#*)#,*#)(#","P 4/m 21/n 2/c":" !#$%#% #!$#*)-(,-)(-,*-$%& !&!$&% &(,+*)+,*+)(+","P 4/n 21/m 2/m":" !#$%#,(#)*#*)&(,&! &%$&*,&()&!$&% & %#$!#,*#)(#","P 4/n 2/c 2/c":" !#$%#,(#)*#*)-(,-! -%$-*,&()&!$&% & %+$!+,*+)(+","P 42/m 2/m 2/c":" !#$%#% +!$+$!& %&! -%$-$%& !&!$-% - %#$!#%$+! +","P 42/m 2/c 2/m":" !#$%#% +!$+$!- %-! &%$&$%& !&!$-% - %+$!+%$#! #","P 42/n 2/b 2/c":" !#$%#,(+)*+$!- %-)(&,*&*,-()-!$&% &(,#*)#%$+! +","P 42/n 2/n 2/m":" !#$%#,(+)*+$!& %&)(-,*-*,-()-!$&% &(,+*)+%$#! #","P 42/m 21/b 2/c":" !#$%#% +!$+*)&(,&)(-,*-$%& !&!$-% -(,#*)#,*+)(+","P 42/m 21/n 2/m":" !#$%#,./'*/*'-.,-! &%$&$%& !&'*-,.-.,/*'/%$#! #","P 42/n 21/m 2/c":" !#$%#,(+)*+*)-(,-! &%$&*,-()-!$&% & %#$!#,*+)(+","P 42/n 21/c 2/m":" !#$%#,(+)*+*)&(,&! -%$-*,-()-!$&% & %+$!+,*#)(#","I 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #()+*,+,(+)*+*)-(,-)(-,*-*,-()-)*-,(-(,+*)+,*+)(+","I 4/m 2/c 2/m":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +()+*,+,(+)*+*)&(,&)(&,*&*,-()-)*-,(-(,#*)#,*#)(#","I 41/a 2/m 2/d":" !#*,+%(5)$9*!> ,=)(-%$&$,=(!>!$&,(-(,+$!#,$9!(5()+$%#, 9!*5$)=(%>! &,*-*%> )=)*-% & %#*)+%*5) 9","I 41/a 2/c 2/d":" !#*,+%(5)$9*!= ,>)(&%$-$,=(!>!$&,(-(,#$!+,$5!(9()+$%#, 9!*5$)>(%=! -,*&*%> )=)*-% & %+*)#%*9) 5","P 3":" !#%?#@$#","P 31":" !#%?A@$B","P 32":" !#%?B@$A","H 3":" !#%?#@$#CDAEFAGHAIJBKLBMNB","R 3":" !## !!# ","P -3":" !#%?#@$#$%&!@&? &","H -3":" !#%?#@$#$%&!@&? &OPQRSQTUQVWXYZX[]X]Y^W[^ZV^UR_PT_SO_","R -3":" !## !!# $%&&$%%&$","P 3 1 2":" !#%?#@$#%$&@!& ?&","P 3 2 1":" !#%?#@$#! &?%&$@&","P 31 1 2":" !#%?Q@$^%$_@!X ?&","P 31 2 1":" !#%?A@$B! &?%_$@X","P 32 1 2":" !#%?^@$Q%$X@!_ ?&","P 32 2 1":" !#%?B@$A! &?%X$@_","H 3 2":" !#%?#@$#! &?%&$@&OPQRSQTUQY]X[WXVZX]Y^W[^ZV^PO_SR_UT_","R 3 2":" !## !!# %$&$&%&%$","P 3 m 1":" !#%?#@$#%$#@!# ?#","P 3 1 m":" !#%?#@$#! #?%#$@#","P 3 c 1":" !#%?#@$#%$+@!+ ?+","P 3 1 c":" !#%?#@$#! +?%+$@+","H 3 m":" !#%?#@$#%$#@!# ?#OPQRSQTUQRUQTPQOSQ]Y^W[^ZV^WV^ZY^][^","R 3 m":" !## !!# ! # #!#! ","H 3 c":" !#%?#@$#%$+@!+ ?+OPQRSQTUQRU`TP`OS`]Y^W[^ZV^WVaZYa][a","R 3 c":" !## !!# '././'/'.","P -3 1 2/m":" !#%?#@$#%$&@!& ?&$%&!@&? &! #?%#$@#","P -3 1 2/c":" !#%?#@$#%$-@!- ?-$%&!@&? &! +?%+$@+","P -3 2/m 1":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#","P -3 2/c 1":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+","H -3 2/m":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#OPQRSQTUQY]X[WXVZXVWXYZX[]XRUQTPQOSQ]Y^W[^ZV^PO_SR_UT_UR_PT_SO_WV^ZY^][^","R -3 2/m":" !## !!# %$&$&%&%$$%&&$%%&$! # #!#! ","H -3 2/c":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+OPQRSQTUQY]b[WbVZbVWXYZX[]XRU`TP`OS`]Y^W[^ZV^POcSRcUTcUR_PT_SO_WVaZYa][a","R -3 2/c":" !## !!# 102021210$%&&$%%&$'././'/'.","P 6":" !#%?#@$#$%#!@#? #","P 61":" !#%?A@$B$%/!@d? e","P 65":" !#%?B@$A$%/!@e? d","P 62":" !#%?^@$Q$%#!@^? Q","P 64":" !#%?Q@$^$%#!@Q? ^","P 63":" !#%?#@$#$%+!@+? +","P -6":" !#%?#@$# !&%?&@$&","P 6/m":" !#%?#@$#$%#!@#? #$%&!@&? & !&%?&@$&","P 63/m":" !#%?#@$#$%+!@+? +$%&!@&? & !-%?-@$-","P 6 2 2":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&","P 61 2 2":" !#%?Q@$^$%+!@`? a! X?%&$@_%$b@!- ?c","P 65 2 2":" !#%?^@$Q$%+!@a? `! _?%&$@X%$c@!- ?b","P 62 2 2":" !#%?^@$Q$%#!@^? Q! _?%&$@X%$_@!& ?X","P 64 2 2":" !#%?Q@$^$%#!@Q? ^! X?%&$@_%$X@!& ?_","P 63 2 2":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-","P 6 m m":" !#%?#@$#$%#!@#? #%$#@!# ?#! #?%#$@#","P 6 c c":" !#%?#@$#$%#!@#? #%$+@!+ ?+! +?%+$@+","P 63 c m":" !#%?#@$#$%+!@+? +%$+@!+ ?+! #?%#$@#","P 63 m c":" !#%?#@$#$%+!@+? +%$#@!# ?#! +?%+$@+","P -6 m 2":" !#%?#@$# !&%?&@$&%$#@!# ?#%$&@!& ?&","P -6 c 2":" !#%?#@$# !-%?-@$-%$+@!+ ?+%$&@!& ?&","P -6 2 m":" !#%?#@$# !&%?&@$&! &?%&$@&! #?%#$@#","P -6 2 c":" !#%?#@$# !-%?-@$-! &?%&$@&! +?%+$@+","P 6/m 2/m 2/m":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&$%&!@&? & !&@$&%?&%$#@!# ?#! #?%#$@#","P 6/m 2/c 2/c":" !#%?#@$#$%#!@#? #! -?%-$@-%$-@!- ?-$%&!@&? & !&@$&%?&%$+@!+ ?+! +?%+$@+","P 63/m 2/c 2/m":" !#%?#@$#$%+!@+? +! -?%-$@-%$&@!& ?&$%&!@&? & !-@$-%?-%$+@!+ ?+! #?%#$@#","P 63/m 2/m 2/c":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-$%&!@&? & !-@$-%?-%$#@!# ?#! +?%+$@+","P 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ","F 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%&  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ","I 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(","P 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(","I 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- ","P 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$","P 2/n -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& *,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","F 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-($,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- *,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$","F 2/d -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& 64=37=345675=64=375345674=67=3453756 )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(68>3:>3896:9=<8=;:5;85<:4><7>;49;79<(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(<4>;7>;49<79>68>3:93896:8=<:=;85;:5<()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- <8=;:=;8f<:f><4>;79;49<78>6:>3893:96","I 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","P 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*","I 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*()+$,#*g& %-+()#$,&*!- %)+(,#$!&*%- *,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$","P 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$","P 42 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","F 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$","F 41 3 2":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46 )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<(!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86","I 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","P 43 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7;>46=:<5839398<5:6=4;>75:<983>7;=46","P 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<","I 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46","P -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ","F -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&%  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(+%*+!*-%(- +)$+,$-) -,#)(#,*&)*&,((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() +,$+)$-, -(#)*#,*&)(&,+!(+%*-!*-%(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(#,*#)*&,(&(+!*+%*-!(-%+) +,$-)$-, ","I -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","P -4 3 n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","F -4 3 c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() #,$#)$&, &(#!*#%*&!(&%+! +%$-!$-% (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(#%*#!*&%(& +!$+%$-! -%#) #,$&)$&, ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! +%$+!$-% - #)$#,$&) &,#!(#%*&!*&%(","I -4 3 d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7354<9:6>8;=357<946>:;=857394<>:6=8;()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- :;98657<=43>;9:658<=73>49:;586=7<>43","P 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","P 4/n -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/m -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/n -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","F 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#!  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*%*+!(+%(-!*-$-) -, +)$+,&,(&)*#,*#)((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%**%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*,$+) +, -)$-*&)(&,(#)*#,-%(-!*+%*+!(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$*,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$,*#)(#,(&)*&*-!(-%(+!*+%-, -)$+,$+) ","F 4/m -3 2/c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() &,$&)$#, #(#%*#!*&%(&!+!$+% -! -%$$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*,$#) #, &)$&*&!(&%(#!*#%-% -!$+%$+! (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(&%*&!*#%(# +%$+!$-% -!#)$#, &) &,$*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*%*#!(#%(&!*&$-! -% +!$+%&, &)$#,$#) ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! -%$-!$+% + #,$#)$&, &)#!*#%(&!(&%**,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$%$+! +% -!$-$&) &, #)$#,&%(&!*#%*#!(","F 41/d -3 2/m":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=4664=3:>;85<79=64>3:5;89<74=6:>385;79<,$+! #%(-)*&*&)(-% #!$+,-%(&)*+,$#!  )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<68>37=;49<:5=<8>;753496:4><:=;893756,*#!(+% &)$-*-!(&, +)$#%-, &!$+%*#)((!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<<4>;:=389675>68=379;45<:8=<7>;453:96%$#) +,(&!*-$&! -,(#)*+%&% -)$#,*+!(()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86<8=;7>3456:9><4=;:9385678>67=349;:5<%*+)(#, -!$&$-) &%(+!*#,&,(-!*#%$+) ","F 41/d -3 2/c":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46<8>;7=3496:5><8=;793456:8><7=;493:56%*#)(+, &!$-$-! &,(+)*#%&, -!$#%*+)( )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<<4=;:>385679>64=3:9;85<78=67>345;:9<%$+) #,(-!*&$&) -%(#!*+,&%(-)*#,$+! (!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<68=37>;45<:9=<4>;:5389674>6:=389;75<,*+!(#% -)$&*-)(&% +!$#,-,(&!*+%$#) ()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>8664>3:=;89<75=68>375;49<:4=<:>;853796,$#! +%(&)*-*&!(-, #)$+%-% &)$+,*#!(","I 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","I 41/a -3 2/d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<$%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*4<97358;=:6>6>:;=8357<94=8;>:694<573()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46*,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$865:;943>7<=<=73>4;9:658>43=7<5869:;","P 1 1 2":" !#$%#","P 1 1 21":" !#$%+","B 1 1 2":" !#$%#(g+*%+","A 1 2 1":" !#$!& )+$)-","C 1 21 1":" !#$)&()#*!&","I 1 2 1":" !#$!&.'/0'2","I 1 21 1":" !#$)&.'/0!-","P 1 1 m":" !# !&","P 1 1 b":" !# )&","B 1 1 m":" !# !&(!+(!-","B 1 1 b":" !# )&(!+()-","P 1 1 2/m":" !# !&$%#$%&","P 1 1 21/m":" !#$%+$%& !-","B 1 1 2/m":" !# !&$%#$%&(!+(!-*%+*%-","P 1 1 2/b":" !#$,#$%& )&","P 1 1 21/b":" !#$%&$,+ )-","B 1 1 2/b":" !#$,#$%& )&(!+*,+*%-()-","P 21 2 2":" !#$!&(%&*%#","P 2 21 2":" !# ,&$)&$%#","P 21 21 2 (a)":" !#*,#.%&$'&","P 21 2 21":" !#$!&(%-*%+","P 2 21 21":" !# %&$)-$,+","C 2 2 21a)":" !#*%+(,&$)-()#$,+ %&*!-","C 2 2 2a":" !#*,#.%&$'&()#$%# ,&*!&","F 2 2 2a":" !#*,#.%&$'& '/*%/.12$!2.!/$,/ %20'2.'#$%# 1&0!&","I 2 2 2a":" !#*,#.%&$'&()+$%+*!- ,-","P 21/m 21/m 2/n a":" !#*,#$)&(%&$%&.'& ,#*!#","P 42 21 2a":" !#*,#%.+'$+$'&.%&! -,*-","I 2 3a":" !#*,#.%&$'&!# ,- '&$%/$# !-*!/$%&.%()+$%+ ,-*!-)+(%&(!-*,#*+()&$)#*,- ,"},Of=/^[1-9]$/;function Ff(e){var t="";return e.length>0&&(t=":"+ts(e).join(" OR :")),new el(t)}var Lf=function(e){void 0===e&&(e=""),this.name=e,this.partList=[]},Uf={type:{configurable:!0}};Uf.type.get=function(){return"Assembly"},Lf.prototype.addPart=function(e,t){var r=new Vf(e,t);return this.partList.push(r),r},Lf.prototype.getAtomCount=function(e){return this.partList.reduce(function(t,r){return t+r.getAtomCount(e)},0)},Lf.prototype.getResidueCount=function(e){return this.partList.reduce(function(t,r){return t+r.getResidueCount(e)},0)},Lf.prototype.getInstanceCount=function(){var e=0;return this.partList.forEach(function(t){e+=t.matrixList.length}),e},Lf.prototype.isIdentity=function(e){if(1!==this.partList.length)return!1;var t=this.partList[0];if(1!==t.matrixList.length)return!1;if(!(new pt).equals(t.matrixList[0]))return!1;var r=[];return e.eachChain(function(e){r.push(e.chainname)}),r=ts(r),t.chainList.length===r.length},Lf.prototype.getBoundingBox=function(e){var t=new _r;return this.partList.forEach(function(r){var n=r.getBoundingBox(e);t.expandByPoint(n.min),t.expandByPoint(n.max)}),t},Lf.prototype.getCenter=function(e){return this.getBoundingBox(e).getCenter()},Lf.prototype.getSelection=function(){var e=[];return this.partList.forEach(function(t){e=e.concat(t.chainList)}),Ff(e)},Object.defineProperties(Lf.prototype,Uf);var Vf=function(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.matrixList=e,this.chainList=t},Bf={type:{configurable:!0}};function zf(e,t){if(t){vl&&gl.time("assignSecondaryStructure");var r=[];e.eachModel(function(e){e.eachChain(function(e){r.push(e.chainname)})});var n=r.slice().sort(),i=[];n.forEach(function(e){i.push(r.indexOf(e))});var o=t.helices.filter(function(e){return Qa(n,e[0])>=0});o.sort(function(e,t){var r=e[0],o=t[0],a=e[1],s=t[1];if(r===o)return a===s?0:a<s?-1:1;var l=Qa(n,r),u=Qa(n,o);return i[l]<i[u]?-1:1});var a=e.residueStore;e.eachModel(function(e){var t=0,r=o.length;if(0!==r){var n=o[t],i=!1,s=!1;e.eachChain(function(e){var l=!1;if(e.chainname===n[0])for(var u=e.residueCount,c=e.residueOffset,h=c+u,p=c;p<h;++p)if(a.resno[p]===n[1]&&a.getInscode(p)===n[2]&&(i=!0),i&&(a.sstruc[p]=n[6],a.resno[p]===n[4]&&a.getInscode(p)===n[5]&&(i=!1,(t+=1)<r?(p=c-1,n=o[t],l=e.chainname!==n[0]):s=!0)),l||s)return})}});var s=t.sheets.filter(function(e){return Qa(n,e[0])>=0});s.sort(function(e,t){var r=e[0],o=t[0];if(r===o)return 0;var a=Qa(n,r),s=Qa(n,o);return i[a]<i[s]?-1:1});var l="e".charCodeAt(0);e.eachModel(function(e){var t=0,r=s.length;if(0!==r){var n=s[t],i=!1,o=!1;e.eachChain(function(e){var u=!1;if(e.chainname===n[0])for(var c=e.residueCount,h=e.residueOffset,p=h+c,d=h;d<p;++d)if(a.resno[d]===n[1]&&a.getInscode(d)===n[2]&&(i=!0),i&&(a.sstruc[d]=l,a.resno[d]===n[4]&&a.getInscode(d)===n[5]&&(i=!1,(t+=1)<r?(d=h-1,n=s[t],u=e.chainname!==n[0]):o=!0)),u||o)return})}}),vl&&gl.timeEnd("assignSecondaryStructure")}}Bf.type.get=function(){return"AssemblyPart"},Vf.prototype._getCount=function(e,t){var r=this,n=0;return e.eachChain(function(e){(0===r.chainList.length||r.chainList.includes(e.chainname))&&(n+=e[t])}),this.matrixList.length*n},Vf.prototype.getAtomCount=function(e){return this._getCount(e,"atomCount")},Vf.prototype.getResidueCount=function(e){return this._getCount(e,"residueCount")},Vf.prototype.getBoundingBox=function(e){var t=new _r,r=new _r,n=this.getSelection(),i=e.getBoundingBox(n);return this.matrixList.forEach(function(e){r.copy(i).applyMatrix4(e),t.expandByPoint(r.min),t.expandByPoint(r.max)}),t},Vf.prototype.getSelection=function(){return Ff(this.chainList)},Vf.prototype.getView=function(e){var t=this.getSelection();return t?e.getView(t):e},Vf.prototype.getInstanceList=function(){for(var e=[],t=0,r=this.matrixList.length;t<r;++t)e.push({id:t+1,name:t,matrix:this.matrixList[t]});return e},Object.defineProperties(Vf.prototype,Bf);var jf=function(){var e=function(e,t,r,n){for(var i=e.structure,o=e.residueIndexStart,a=i.getResidueProxy(),s=i.getResidueProxy(),l=i.getAtomProxy(),u=i.getAtomProxy(),c=Math.max(0,t-2);c<=t;++c)for(var h=2;h<5;++h)if(!(c+h>=e.residueCount)){a.index=o+c,s.index=o+c+h,l.index=a.traceAtomIndex,u.index=s.traceAtomIndex;var p=l.distanceTo(u);if(Math.abs(p-r[h-2])>n)return!1}return!0},t=function(t,r){return e(t,r,[5.45,5.18,6.37],2.1)},r=function(t,r){return e(t,r,[6.1,10.4,13],1.42)};return function(e){vl&&gl.time("calculateSecondaryStructure"),e.eachPolymer(function(e){if(!(e.residueCount<4)){if(e.isCg())!function(e){for(var t=e.residueStore,r=e.residueIndexStart,n=new Cf(e).position,i=new ft,o=new ft,a=0,s=e.residueCount;a<s;++a){i.fromArray(n.center,3*a),o.fromArray(n.center,3*a+3);var l=i.distanceTo(o);l<2&&l>1&&n.bending[a]<20&&(t.sstruc[r+a]="h".charCodeAt(0),t.sstruc[r+a+1]="h".charCodeAt(0))}}(e);else{if(!e.isProtein())return;!function(e){for(var n=e.residueStore,i=e.residueIndexStart,o=0,a=e.residueCount;o<a;++o){var s="c";t(e,o)?s="h":r(e,o)&&(s="s"),n.sstruc[i+o]=s.charCodeAt(0)}}(e)}var n,i=0;e.eachResidue(function(e){e.sstruc===n?i+=1:(1===i&&(e.index-=1,e.sstruc="c"),i=1,n=e.sstruc)})}}),vl&&gl.timeEnd("calculateSecondaryStructure")}}(),Hf="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function $f(e){for(var t=Hf.length,r=e,n=0,i=Hf[r%t];r>=t;)r=Math.floor(r/t),i+=Hf[r%t],n+=1;return n>=5&&gl.warn("chainname overflow"),i}function Gf(e,t){void 0===t&&(t=!1),vl&&gl.time("calculateChainnames");var r=!0;if(e.eachChain(function(e){e.chainname&&(r=!1)}),r){var n=e.modelStore,i=e.chainStore,o=e.residueStore,a=e.getAtomProxy(),s=e.getAtomProxy(),l=0,u=0,c=0,h=0,p=[];1===o.count?p.push({mIndex:0,chainname:"A",rStart:0,rCount:1}):e.eachResidueN(2,function(e,r){var n=!1,i=e.backboneType,d=r.backboneType,f=Ih;h=e.index,e.modelIndex!==r.modelIndex?n=!0:e.moleculeType!==r.moleculeType?n=!0:i!==f&&i===d&&(a.index=e.backboneEndAtomIndex,s.index=r.backboneStartAtomIndex,n=t?!a.hasBondTo(s):!a.connectedTo(s)),n||r.index!==o.count-1||(n=!0,h=r.index),n&&(p.push({mIndex:u,chainname:$f(l),rStart:c,rCount:h-c+1}),l+=1,e.modelIndex!==r.modelIndex&&(l=0,u+=1),r.index===o.count-1&&h!==r.index&&p.push({mIndex:u,chainname:$f(l),rStart:o.count-1,rCount:1}),c=r.index,h=r.index)}),i.count=0,p.forEach(function(e){!function(e,t,r,a){for(var s=i.count,l=0;l<a;++l)o.chainIndex[r+l]=s;i.growIfFull(),i.modelIndex[s]=e,i.setChainname(s,t),i.setChainid(s,t),i.residueOffset[s]=r,i.residueCount[s]=a,i.count+=1,n.chainCount[e]+=1}(e.mIndex,e.chainname,e.rStart,e.rCount)});var d=0;e.eachModel(function(e){n.chainOffset[e.index]=d,n.chainCount[e.index]-=1,d+=n.chainCount[e.index]})}vl&&gl.timeEnd("calculateChainnames")}function Wf(e){vl&&gl.time("calculateBonds"),Kf(e),Yf(e),vl&&gl.timeEnd("calculateBonds")}var qf={"HIS|CD2|CG":2,"HIS|CE1|ND1":2,"ARG|CZ|NH2":2,"PHE|CE1|CZ":2,"PHE|CD2|CE2":2,"PHE|CD1|CG":2,"TRP|CD1|CG":2,"TRP|CD2|CE2":2,"TRP|CE3|CZ3":2,"TRP|CH2|CZ2":2,"ASN|CG|OD1":2,"GLN|CD|OE1":2,"TYR|CD1|CG":2,"TYR|CD2|CE2":2,"TYR|CE1|CZ":2,"ASP|CD1|CG":2,"GLU|CD|OE1":2,"G|C8|N7":2,"G|C4|C5":2,"G|C2|N3":2,"G|C6|O6":2,"C|C4|N3":2,"C|C5|C6":2,"C|C2|O2":2,"A|C2|N3":2,"A|C6|N1":2,"A|C4|C5":2,"A|C8|N7":2,"U|C5|C6":2,"U|C2|O2":2,"U|C4|O4":2,"DG|C8|N7":2,"DG|C4|C5":2,"DG|C2|N3":2,"DG|C6|O6":2,"DC|C4|N3":2,"DC|C5|C6":2,"DC|C2|O2":2,"DA|C2|N3":2,"DA|C6|N1":2,"DA|C4|C5":2,"DA|C8|N7":2,"DT|C5|C6":2,"DT|C2|O2":2,"DT|C4|O4":2};function Xf(e,t,r){var n;return t=(n=t<r?[t,r]:[r,t])[0],r=n[1],Xh.includes(e)&&"C"===t&&"O"===r?2:Jh.includes(e)&&"OP1"===t&&"P"===r?2:qf[e+"|"+t+"|"+r]||1}function Kf(e,t){void 0===t&&(t=!1),vl&&gl.time("calculateBondsWithin");var r=e.bondStore,n=e.rungBondStore,i=e.getAtomSet(!1),o=e.getAtomProxy(),a=e.getAtomProxy(),s=e.getBondProxy(),l=t?null:function(e){vl&&gl.time("calculateAtomBondMap");var t=[];return e.eachBond(function(e){var r=e.atomIndex1,n=e.atomIndex2;void 0===t[r]&&(t[r]=[]),t[r][n]=e.index}),vl&&gl.timeEnd("calculateAtomBondMap"),t}(e);e.eachResidue(function(e){if(!t&&l){var u=e.atomCount,c=e.atomOffset;if(u>500)return void gl.warn("more than 500 atoms, skip residue for auto-bonding",e.qualifiedName());for(var h=e.getBonds(),p=h.atomIndices1,d=h.atomIndices2,f=h.bondOrders,m=p.length,g=0;g<m;++g){var v=p[g]+c,y=d[g]+c,b=l[v];if(void 0!==b&&void 0!==b[y])s.index=b[y],f[e.residueType.getBondIndex(v,y)]=s.bondOrder;else o.index=v,a.index=y,r.addBond(o,a,f[g])}}var w=e.residueType.traceAtomIndex,x=e.residueType.rungEndAtomIndex;-1!==w&&-1!==x&&(o.index=e.traceAtomIndex,a.index=e.rungEndAtomIndex,n.addBond(o,a),i.set(o.index),i.set(a.index))}),e.atomSetDict.rung=i,vl&&gl.timeEnd("calculateBondsWithin")}function Yf(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1),vl&&gl.time("calculateBondsBetween");var n=e.bondStore,i=e.backboneBondStore,o=e.getAtomSet(!1),a=e.getAtomProxy(),s=e.getAtomProxy();function l(e,l){var u=e.backboneType,c=l.backboneType;u!==Ih&&u===c&&(a.index=e.backboneEndAtomIndex,s.index=l.backboneStartAtomIndex,(r&&a.hasBondTo(s)||a.connectedTo(s))&&(t||n.addBond(a,s,1),a.index=e.traceAtomIndex,s.index=l.traceAtomIndex,i.addBond(a,s),o.set(a.index),o.set(s.index)))}0===i.count&&i.resize(e.residueStore.count),e.eachResidueN(2,l);var u=e.getResidueProxy(),c=e.getResidueProxy();if(e.eachChain(function(e){0!==e.residueCount&&(u.index=e.residueOffset,c.index=e.residueOffset+e.residueCount-1,l(c,u))}),e.atomSetDict.backbone=o,!t){vl&&gl.time("calculateBondsBetween inter");var h=e.spatialHash;e.eachResidue(function(e){e.backboneType!==Ih||e.isWater()||e.eachAtom(function(e){h.eachWithin(e.x,e.y,e.z,4,function(t){s.index=t,e.residueIndex!==s.residueIndex&&n.addBondIfConnected(e,s,1)})})}),vl&&gl.timeEnd("calculateBondsBetween inter")}vl&&gl.timeEnd("calculateBondsBetween")}function Zf(e){if(e.unitcell){vl&&gl.time("buildUnitcellAssembly");var t=e.unitcell,r=e.center.clone().applyMatrix4(t.cartToFrac),n=function(e){var t=kf[e],r={};if(void 0===t)return console.warn("spacegroup '"+e+"' not found in symop library"),r;for(var n=[],i=0,o=t.length;i<o;i+=3){for(var a=[],s=0;s<3;++s)a.push(Df[t[i+s]]);n.push(a)}return n.forEach(function(e){var t=0,n=(new pt).set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),i=n.elements;r[e.toString()]=n,e.forEach(function(e){for(var r=!1,n=!1,o=0,a=e.length;o<a;++o){var s=e[o];if("-"===s)r=!0;else if("+"===s)r=!1;else if("/"===s)n=!0;else if("X"===s)i[0+t]=r?-1:1;else if("Y"===s)i[4+t]=r?-1:1;else if("Z"===s)i[8+t]=r?-1:1;else if(Of.test(s)){var l=parseInt(s);n?i[12+t]/=l:i[12+t]=l}else gl.warn("getSymmetryOperations: unknown token '"+s+"'")}t+=1})}),r}(t.spacegroup),i=new ft,o=new ft,a=new ft;r.x>1&&(i.x-=1),r.x<0&&(i.x+=1),r.y>1&&(i.y-=1),r.y<0&&(i.y+=1),r.z>1&&(i.z-=1),r.z<0&&(i.z+=1);var s=new Lf("UNITCELL"),l=m(),u=[];if(e.biomolDict.NCS){u.push.apply(u,[new pt].concat(e.biomolDict.NCS.partList[0].matrixList));var c=[];l.forEach(function(e){u.forEach(function(t){c.push(e.clone().multiply(t))})}),s.addPart(c)}else s.addPart(l);var h=new ft,p=new Lf("SUPERCELL"),d=Array.prototype.concat.call(m(h.set(1,0,0)),m(h.set(0,1,0)),m(h.set(0,0,1)),m(h.set(-1,0,0)),m(h.set(0,-1,0)),m(h.set(0,0,-1)),m(h.set(1,1,0)),m(h.set(1,0,1)),m(h.set(0,1,1)),m(h.set(-1,-1,0)),m(h.set(-1,0,-1)),m(h.set(0,-1,-1)),m(h.set(1,-1,-1)),m(h.set(1,1,-1)),m(h.set(1,-1,1)),m(h.set(-1,1,1)),m(h.set(-1,-1,1)),m(h.set(-1,1,-1)),m(h.set(0,1,-1)),m(h.set(0,-1,1)),m(h.set(1,0,-1)),m(h.set(-1,0,1)),m(h.set(1,-1,0)),m(h.set(-1,1,0)),m(),m(h.set(1,1,1)),m(h.set(-1,-1,-1)));if(e.biomolDict.NCS){var f=[];d.forEach(function(e){u.forEach(function(t){f.push(e.clone().multiply(t))})}),p.addPart(f)}else p.addPart(d);e.biomolDict.UNITCELL=s,e.biomolDict.SUPERCELL=p,vl&&gl.timeEnd("buildUnitcellAssembly")}function m(e){var s=[];return Object.keys(n).forEach(function(l){var u=n[l].clone();o.copy(r).applyMatrix4(u),a.setFromMatrixPosition(u),a.sub(i),o.x>1&&(a.x-=1),o.x<0&&(a.x+=1),o.y>1&&(a.y-=1),o.y<0&&(a.y+=1),o.z>1&&(a.z-=1),o.z<0&&(a.z+=1),e&&a.add(e),u.setPosition(a),u.multiplyMatrices(t.fracToCart,u),u.multiply(t.cartToFrac),s.push(u)}),s}}var Jf=["H","C","O","N","S","P"],Qf=["NA","CL","FE"];function em(e){var t=e.trim().toUpperCase();parseInt(t.charAt(0))&&(t=t.substr(1)),parseInt(t.charAt(0))&&(t=t.substr(1));var r=t.length;if(0===r)return"";if(1===r)return t;if(2===r){if(-1!==Qf.indexOf(t))return t;if(-1!==Jf.indexOf(t[0]))return t[0]}return r>=3&&-1!==Jf.indexOf(t[0])?t[0]:""}function tm(e){var t=e.bondHash,r=t.countArray,n=t.offsetArray,i=t.indexArray,o=e.getBondProxy();e.eachResidue(function(e){var t=e.residueType;if(void 0===t.bonds){var a=e.atomOffset,s=[],l=[],u=[],c={};e.eachAtom(function(e){for(var t=e.index,h=n[t],p=0,d=r[t];p<d;++p){o.index=i[h+p];var f=o.atomIndex1,m=o.atomIndex2;if(f>m){var g=m;m=f,f=g}var v=f+"|"+m;void 0===c[v]&&(c[v]=!0,s.push(f-a),l.push(m-a),u.push(o.bondOrder))}}),t.bonds={atomIndices1:s,atomIndices2:l,bondOrders:u}}})}var rm=[3,11,19,37,55,87],nm=[4,12,20,38,56,88],im=[6,15,16,34],om=[1,7,8,9,17,35,53],am=[2,10,18,36,54,86],sm=[13,30,31,48,49,50,80,81,82,83,84,85,112],lm=[5,14,32,33,51,52,85],um=[9,17,35,53,85],cm=function(e,t,r){this.structure=e,this.atomname=t,r=r||em(t),this.element=r,this.number=Bh[r]||0,this.vdw=zh[this.number]||2,this.covalent=jh[this.number]||1.6};cm.prototype.getDefaultValence=function(){var e=Hh[this.number];return e?e[0]:-1},cm.prototype.getValenceList=function(){return Hh[this.number]||[]},cm.prototype.getOuterShellElectronCount=function(){return $h[this.number]||2},cm.prototype.isMetal=function(){return this.isAlkaliMetal()||this.isAlkalineEarthMetal()||this.isLanthanide()||this.isActinide()||this.isTransitionMetal()||this.isPostTransitionMetal()},cm.prototype.isNonmetal=function(){return this.isDiatomicNonmetal()||this.isPolyatomicNonmetal()||this.isNobleGas()},cm.prototype.isMetalloid=function(){return lm.includes(this.number)},cm.prototype.isHalogen=function(){return um.includes(this.number)},cm.prototype.isDiatomicNonmetal=function(){return om.includes(this.number)},cm.prototype.isPolyatomicNonmetal=function(){return im.includes(this.number)},cm.prototype.isAlkaliMetal=function(){return rm.includes(this.number)},cm.prototype.isAlkalineEarthMetal=function(){return nm.includes(this.number)},cm.prototype.isNobleGas=function(){return am.includes(this.number)},cm.prototype.isTransitionMetal=function(){var e=this.number;return e>=21&&e<=29||e>=39&&e<=47||e>=72&&e<=79||e>=104&&e<=108},cm.prototype.isPostTransitionMetal=function(){return sm.includes(this.number)},cm.prototype.isLanthanide=function(){return this.number>=57&&this.number<=71},cm.prototype.isActinide=function(){return this.number>=89&&this.number<=103};var hm=function(e){this.structure=e,this.dict={},this.list=[],this.structure=e};hm.prototype.add=function(e,t){var r=function(e,t){return e+"|"+t}(e=e.toUpperCase(),t=t?t.toUpperCase():em(e)),n=this.dict[r];if(void 0===n){var i=new cm(this.structure,e,t);n=this.list.length,this.dict[r]=n,this.list.push(i)}return n},hm.prototype.get=function(e){return this.list[e]};var pm=function(e,t,r,n,i,o){this.structure=e,this.bondReferenceAtomIndices=[],this.resname=t,this.atomTypeIdList=r,this.hetero=n?1:0,this.chemCompType=i,this.bonds=o,this.atomCount=r.length,this.moleculeType=this.getMoleculeType(),this.backboneType=this.getBackboneType(0),this.backboneEndType=this.getBackboneType(-1),this.backboneStartType=this.getBackboneType(1),this.backboneIndexList=this.getBackboneIndexList();var a=ip[this.backboneType],s=ip[this.backboneStartType],l=ip[this.backboneEndType],u=this.getAtomIndexByName(a.trace);this.traceAtomIndex=Ha(u,-1);var c=this.getAtomIndexByName(a.direction1);this.direction1AtomIndex=Ha(c,-1);var h=this.getAtomIndexByName(a.direction2);this.direction2AtomIndex=Ha(h,-1);var p=this.getAtomIndexByName(s.backboneStart);this.backboneStartAtomIndex=Ha(p,-1);var d,f=this.getAtomIndexByName(l.backboneEnd);this.backboneEndAtomIndex=Ha(f,-1),d=Zh.includes(t)?this.getAtomIndexByName("N1"):this.getAtomIndexByName("N3"),this.rungEndAtomIndex=Ha(d,-1)};pm.prototype.getBackboneIndexList=function(){var e,t=[];switch(this.moleculeType){case 3:e=rp;break;case 4:case 5:e=np;break;default:return t}for(var r=this.structure.atomMap,n=this.atomTypeIdList,i=0,o=this.atomCount;i<o;++i){var a=r.get(n[i]);e.includes(a.atomname)&&t.push(i)}return t},pm.prototype.getMoleculeType=function(){return this.isProtein()?3:this.isRna()?4:this.isDna()?5:this.isWater()?1:this.isIon()?2:this.isSaccharide()?6:0},pm.prototype.getBackboneType=function(e){return this.hasProteinBackbone(e)?1:this.hasRnaBackbone(e)?2:this.hasDnaBackbone(e)?3:this.hasCgProteinBackbone(e)?4:this.hasCgRnaBackbone(e)?5:this.hasCgDnaBackbone(e)?6:Ih},pm.prototype.isProtein=function(){return this.chemCompType?Nh.includes(this.chemCompType):this.hasAtomWithName("CA","C","N")||Xh.includes(this.resname)},pm.prototype.isCg=function(){var e=this.backboneType;return 4===e||5===e||6===e},pm.prototype.isNucleic=function(){return this.isRna()||this.isDna()},pm.prototype.isRna=function(){return this.chemCompType?Dh.includes(this.chemCompType):this.hasAtomWithName(["P","O3'","O3*"],["C4'","C4*"],["O2'","O2*","F2'","F2*"])||Kh.includes(this.resname)&&this.hasAtomWithName(["O2'","O2*","F2'","F2*"])},pm.prototype.isDna=function(){return this.chemCompType?kh.includes(this.chemCompType):this.hasAtomWithName(["P","O3'","O3*"],["C3'","C3*"])&&!this.hasAtomWithName(["O2'","O2*","F2'","F2*"])||Yh.includes(this.resname)},pm.prototype.isHetero=function(){return 1===this.hetero},pm.prototype.isIon=function(){return ep.includes(this.resname)},pm.prototype.isWater=function(){return Qh.includes(this.resname)},pm.prototype.isSaccharide=function(){return this.chemCompType?Oh.includes(this.chemCompType):tp.includes(this.resname)},pm.prototype.hasBackboneAtoms=function(e,t){var r=ip[t];return-1===e?this.hasAtomWithName(r.trace,r.backboneEnd,r.direction1,r.direction2):0===e?this.hasAtomWithName(r.trace,r.direction1,r.direction2):1===e?this.hasAtomWithName(r.trace,r.backboneStart,r.direction1,r.direction2):this.hasAtomWithName(r.trace,r.backboneStart,r.backboneEnd,r.direction1,r.direction2)},pm.prototype.hasProteinBackbone=function(e){return this.isProtein()&&this.hasBackboneAtoms(e,1)},pm.prototype.hasRnaBackbone=function(e){return this.isRna()&&this.hasBackboneAtoms(e,2)},pm.prototype.hasDnaBackbone=function(e){return this.isDna()&&this.hasBackboneAtoms(e,3)},pm.prototype.hasCgProteinBackbone=function(e){return this.atomCount<7&&this.isProtein()&&this.hasBackboneAtoms(e,4)},pm.prototype.hasCgRnaBackbone=function(e){return this.atomCount<11&&this.isRna()&&this.hasBackboneAtoms(e,5)},pm.prototype.hasCgDnaBackbone=function(e){return this.atomCount<11&&this.isDna()&&this.hasBackboneAtoms(e,6)},pm.prototype.hasBackbone=function(e){return this.hasProteinBackbone(e)||this.hasRnaBackbone(e)||this.hasDnaBackbone(e)||this.hasCgProteinBackbone(e)||this.hasCgRnaBackbone(e)||this.hasCgDnaBackbone(e)},pm.prototype.getAtomIndexByName=function(e){var t=this.atomCount,r=this.structure.atomMap,n=this.atomTypeIdList;if(Array.isArray(e))for(var i=0;i<t;++i){var o=n[i];if(e.includes(r.get(o).atomname))return i}else for(var a=0;a<t;++a){var s=n[a];if(e===r.get(s).atomname)return a}},pm.prototype.hasAtomWithName=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];for(var r=e.length,n=0;n<r;++n)if(void 0!==e[n]&&void 0===this.getAtomIndexByName(e[n]))return!1;return!0},pm.prototype.getBonds=function(e){return void 0===this.bonds&&(this.bonds=function(e){var t=e.structure,r=t.getAtomProxy(),n=t.getAtomProxy(),i=e.atomCount,o=e.atomOffset,a=o+i-1,s=[],l=[],u=[];if(i>500)vl&&gl.warn("more than 500 atoms, skip residue for auto-bonding",e.qualifiedName());else if(i>50)for(var c=new Nf(e,!0),h=e.isCg()?1.2:2.3,p=o;p<a;++p){r.index=p;for(var d=r.covalent+h+.3,f=c.nearest(r,1/0,d*d),m=f.length,g=0;g<m;++g)n.index=f[g].index,r.index<n.index&&r.connectedTo(n)&&(s.push(r.index-o),l.push(n.index-o),u.push(Xf(r.resname,r.atomname,n.atomname)))}else for(var v=o;v<a;++v){r.index=v;for(var y=v+1;y<=a;++y)n.index=y,r.connectedTo(n)&&(s.push(v-o),l.push(y-o),u.push(Xf(r.resname,r.atomname,n.atomname)))}return{atomIndices1:s,atomIndices2:l,bondOrders:u}}(e)),this.bonds},pm.prototype.getRings=function(){return void 0===this.rings&&this.calculateRings(),this.rings},pm.prototype.getBondGraph=function(){return void 0===this.bondGraph&&this.calculateBondGraph(),this.bondGraph},pm.prototype.getAromatic=function(e){return void 0===this.aromaticAtoms&&this.calculateAromatic(this.structure.getResidueProxy(e.residueIndex)),this.aromaticAtoms},pm.prototype.getAromaticRings=function(e){return void 0===this.aromaticRings&&this.calculateAromatic(e),this.aromaticRings},pm.prototype.calculateBondGraph=function(){for(var e=this.bondGraph={},t=this.getBonds(),r=t.atomIndices1.length,n=t.atomIndices1,i=t.atomIndices2,o=0;o<r;++o){var a=n[o],s=i[o];(e[a]=e[a]||[]).push(s),(e[s]=e[s]||[]).push(a)}},pm.prototype.calculateRings=function(){for(var e=function(e,t){for(var r={count:t,visited:new Int32Array(t),queue:new Int32Array(t),pred:new Int32Array(t),left:new Int32Array(vm),right:new Int32Array(vm),color:new Int32Array(t),currentColor:0,rings:[],flags:new Int8Array(t),bonds:e},n=0;n<t;n++)r.visited[n]=-1,r.pred[n]=-1;return r}(this.getBondGraph(),this.atomCount),t=0;t<e.count;t++)e.visited[t]>=0||gm(e,t);this.rings={flags:e.flags,rings:e.rings}},pm.prototype.isAromatic=function(e){return this.aromaticAtoms=this.getAromatic(e),1===this.aromaticAtoms[e.index-e.residueAtomOffset]},pm.prototype.calculateAromatic=function(e){var t=this,r=this.aromaticAtoms=new Uint8Array(this.atomCount),n=this.getRings().rings,i=n.map(function(r){return function(e){if(e.some(function(e){return!dm.includes(e.number)}))return!1;var t=0,r=new nd(3,e.length),n=r.data;return e.forEach(function(e){n[t+0]=e.x,n[t+1]=e.y,n[t+2]=e.z,t+=3}),new mf(r).vecC.length()<fm}(r.map(function(r){return t.structure.getAtomProxy(r+e.atomOffset)}))}),o=this.aromaticRings=[];n.forEach(function(e,t){i[t]&&(o.push(e),e.forEach(function(e){return r[e]=1}))})},pm.prototype.assignBondReferenceAtomIndices=function(){var e=this.getBondGraph(),t=this.getRings(),r=t.flags,n=t.rings,i=this.bonds,o=i.atomIndices1,a=i.atomIndices2,s=i.bondOrders,l=this.bondReferenceAtomIndices,u=i.atomIndices1.length;l.length=0;for(var c=0;c<u;++c)if(!(s[c]<=1)){var h=o[c],p=a[c];if(r[h]&&r[p]){for(var d=0;d<n.length&&void 0===l[c];++d)for(var f=n[d],m=null,g=!1,v=0;v<f.length;++v){var y=f[v];if(y===h||y===p?g=!0:m=y,g&&null!==m){l[c]=m;break}}if(void 0!==l[c])continue}if(e[h].length>1)for(var b=0;b<e[h].length;++b){var w=e[h][b];if(w!==p){l[c]=w;break}}else if(e[p].length>1)for(var x=0;x<e[p].length;++x){var _=e[p][x];if(_!==h){l[c]=_;break}}else;}},pm.prototype.getBondIndex=function(e,t){for(var r=this.bonds,n=r.atomIndices1,i=r.atomIndices2,o=n.indexOf(e),a=i.indexOf(t),s=a;-1!==o;){for(;-1!==a;){if(o===a)return o;a=i.indexOf(t,a+1)}o=n.indexOf(e,o+1),a=s}},pm.prototype.getBondReferenceAtomIndex=function(e,t){var r=this.getBondIndex(e,t);if(void 0!==r)return 0===this.bondReferenceAtomIndices.length&&this.assignBondReferenceAtomIndices(),this.bondReferenceAtomIndices[r]};var dm=[5,6,7,8,14,15,16,32,33,50,51,83],fm=.05;function mm(e,t,r){if(!(r<t)){for(var n=e.pred,i=e.color,o=e.left,a=e.right,s=++e.currentColor,l=t,u=0;u<vm&&(i[l]=s,!((l=n[l])<0));u++);var c=0,h=0,p=!1,d=0;l=r;for(var f=0;f<vm;f++){if(i[l]===s){d=l,p=!0;break}if(a[h++]=l,(l=n[l])<0)break}if(p){l=t;for(var m=0;m<vm&&(o[c++]=l,d!==l)&&!((l=n[l])<0);m++);for(var g=c+h,v=new Array(g),y=0,b=0;b<c;b++)v[y++]=o[b];for(var w=h-1;w>=0;w--)v[y++]=a[w];for(var x=0;x<g;++x)e.flags[v[x]]=1;e.rings.push(v)}}}function gm(e,t){var r=e.bonds,n=e.visited,i=e.queue,o=e.pred;n[t]=1,i[0]=t;for(var a=0,s=1;a<s;){var l=i[a++];if(void 0!==r[l])for(var u=r[l].length,c=0;c<u;c++){var h=r[l][c];n[h]>0?o[h]!==l&&o[l]!==h&&mm(e,l,h):(n[h]=1,i[s++]=h,o[h]=l)}}}var vm=4;var ym=function(e){this.structure=e,this.dict={},this.list=[]};ym.prototype.add=function(e,t,r,n,i){void 0===n&&(n="");var o=function(e,t,r,n){return void 0===n&&(n=""),e+"|"+t.join(",")+"|"+(r?1:0)+"|"+n}(e=e.toUpperCase(),t,r,n),a=this.dict[o];if(void 0===a){var s=new pm(this.structure,e,t,r,n,i);a=this.list.length,this.dict[o]=a,this.list.push(s)}return a},ym.prototype.get=function(e){return this.list[e]};var bm=function(e,t){void 0===t&&(t=0),this.structure=e,this.index=t,this.bondStore=e.bondStore,this._v12=new ft,this._v13=new ft,this._ap1=this.structure.getAtomProxy(),this._ap2=this.structure.getAtomProxy(),this._ap3=this.structure.getAtomProxy()},wm={atom1:{configurable:!0},atom2:{configurable:!0},atomIndex1:{configurable:!0},atomIndex2:{configurable:!0},bondOrder:{configurable:!0}};wm.atom1.get=function(){return this.structure.getAtomProxy(this.atomIndex1)},wm.atom2.get=function(){return this.structure.getAtomProxy(this.atomIndex2)},wm.atomIndex1.get=function(){return this.bondStore.atomIndex1[this.index]},wm.atomIndex1.set=function(e){this.bondStore.atomIndex1[this.index]=e},wm.atomIndex2.get=function(){return this.bondStore.atomIndex2[this.index]},wm.atomIndex2.set=function(e){this.bondStore.atomIndex2[this.index]=e},wm.bondOrder.get=function(){return this.bondStore.bondOrder[this.index]},wm.bondOrder.set=function(e){this.bondStore.bondOrder[this.index]=e},bm.prototype.getOtherAtomIndex=function(e){return e===this.atomIndex1?this.atomIndex2:this.atomIndex1},bm.prototype.getOtherAtom=function(e){return this.structure.getAtomProxy(this.getOtherAtomIndex(e.index))},bm.prototype.getReferenceAtomIndex=function(){var e=this._ap1,t=this._ap2;if(e.index=this.atomIndex1,t.index=this.atomIndex2,e.residueIndex===t.residueIndex){var r=e.index-e.residueAtomOffset,n=t.index-t.residueAtomOffset,i=e.residueType.getBondReferenceAtomIndex(r,n);if(void 0!==i)return i+e.residueAtomOffset;console.warn("No reference atom found",e.index,t.index)}},bm.prototype.calculateShiftDir=function(e){void 0===e&&(e=new ft);var t=this._ap1,r=this._ap2,n=this._ap3,i=this._v12,o=this._v13;t.index=this.atomIndex1,r.index=this.atomIndex2;var a=this.getReferenceAtomIndex();i.subVectors(t,r).normalize(),void 0!==a?(n.index=a,o.subVectors(t,n)):o.copy(t),o.normalize();var s=i.dot(o);return 1-Math.abs(s)<1e-5&&(o.set(1,0,0),s=i.dot(o),1-Math.abs(s)<1e-5&&(o.set(0,1,0),s=i.dot(o))),e.copy(o.sub(i.multiplyScalar(s))).normalize()},bm.prototype.qualifiedName=function(){return this.atomIndex1+"="+this.atomIndex2},bm.prototype.clone=function(){return new bm(this.structure,this.index)},bm.prototype.toObject=function(){return{atomIndex1:this.atomIndex1,atomIndex2:this.atomIndex2,bondOrder:this.bondOrder}},Object.defineProperties(bm.prototype,wm);var xm=function(e,t){void 0===t&&(t=0),this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap},_m={entity:{configurable:!0},entityIndex:{configurable:!0},chain:{configurable:!0},chainIndex:{configurable:!0},atomOffset:{configurable:!0},atomCount:{configurable:!0},atomEnd:{configurable:!0},modelIndex:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0},resno:{configurable:!0},sstruc:{configurable:!0},inscode:{configurable:!0},residueType:{configurable:!0},resname:{configurable:!0},hetero:{configurable:!0},moleculeType:{configurable:!0},backboneType:{configurable:!0},backboneStartType:{configurable:!0},backboneEndType:{configurable:!0},traceAtomIndex:{configurable:!0},direction1AtomIndex:{configurable:!0},direction2AtomIndex:{configurable:!0},backboneStartAtomIndex:{configurable:!0},backboneEndAtomIndex:{configurable:!0},rungEndAtomIndex:{configurable:!0}};_m.entity.get=function(){return this.structure.entityList[this.entityIndex]},_m.entityIndex.get=function(){return this.chainStore.entityIndex[this.chainIndex]},_m.chain.get=function(){return this.structure.getChainProxy(this.chainIndex)},_m.chainIndex.get=function(){return this.residueStore.chainIndex[this.index]},_m.chainIndex.set=function(e){this.residueStore.chainIndex[this.index]=e},_m.atomOffset.get=function(){return this.residueStore.atomOffset[this.index]},_m.atomOffset.set=function(e){this.residueStore.atomOffset[this.index]=e},_m.atomCount.get=function(){return this.residueStore.atomCount[this.index]},_m.atomCount.set=function(e){this.residueStore.atomCount[this.index]=e},_m.atomEnd.get=function(){return this.atomOffset+this.atomCount-1},_m.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},_m.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},_m.chainid.get=function(){return this.chainStore.getChainid(this.chainIndex)},_m.resno.get=function(){return this.residueStore.resno[this.index]},_m.resno.set=function(e){this.residueStore.resno[this.index]=e},_m.sstruc.get=function(){return this.residueStore.getSstruc(this.index)},_m.sstruc.set=function(e){this.residueStore.setSstruc(this.index,e)},_m.inscode.get=function(){return this.residueStore.getInscode(this.index)},_m.inscode.set=function(e){this.residueStore.setInscode(this.index,e)},_m.residueType.get=function(){return this.residueMap.get(this.residueStore.residueTypeId[this.index])},_m.resname.get=function(){return this.residueType.resname},_m.hetero.get=function(){return this.residueType.hetero},_m.moleculeType.get=function(){return this.residueType.moleculeType},_m.backboneType.get=function(){return this.residueType.backboneType},_m.backboneStartType.get=function(){return this.residueType.backboneStartType},_m.backboneEndType.get=function(){return this.residueType.backboneEndType},_m.traceAtomIndex.get=function(){return this.residueType.traceAtomIndex+this.atomOffset},_m.direction1AtomIndex.get=function(){return this.residueType.direction1AtomIndex+this.atomOffset},_m.direction2AtomIndex.get=function(){return this.residueType.direction2AtomIndex+this.atomOffset},_m.backboneStartAtomIndex.get=function(){return this.residueType.backboneStartAtomIndex+this.atomOffset},_m.backboneEndAtomIndex.get=function(){return this.residueType.backboneEndAtomIndex+this.atomOffset},_m.rungEndAtomIndex.get=function(){return this.residueType.rungEndAtomIndex+this.atomOffset},xm.prototype.eachAtom=function(e,t){var r=this.atomCount,n=this.atomOffset,i=this.structure._ap,o=n+r;if(t&&t.atomOnlyTest)for(var a=t.atomOnlyTest,s=n;s<o;++s)i.index=s,a(i)&&e(i);else for(var l=n;l<o;++l)i.index=l,e(i)},xm.prototype.isProtein=function(){return 3===this.residueType.moleculeType},xm.prototype.isNucleic=function(){var e=this.residueType.moleculeType;return 4===e||5===e},xm.prototype.isRna=function(){return 4===this.residueType.moleculeType},xm.prototype.isDna=function(){return 5===this.residueType.moleculeType},xm.prototype.isCg=function(){var e=this.residueType.backboneType;return 4===e||5===e||6===e},xm.prototype.isPolymer=function(){if(this.structure.entityList.length>0)return this.entity.isPolymer();var e=this.residueType.moleculeType;return 3===e||4===e||5===e},xm.prototype.isHetero=function(){return 1===this.residueType.hetero},xm.prototype.isWater=function(){return 1===this.residueType.moleculeType},xm.prototype.isIon=function(){return 2===this.residueType.moleculeType},xm.prototype.isSaccharide=function(){return 6===this.residueType.moleculeType},xm.prototype.isHelix=function(){return Lh.includes(this.sstruc)},xm.prototype.isSheet=function(){return Uh.includes(this.sstruc)},xm.prototype.isTurn=function(){return Vh.includes(this.sstruc)&&this.isProtein()},xm.prototype.getAtomType=function(e){return this.atomMap.get(this.atomStore.atomTypeId[e])},xm.prototype.getResname1=function(){return qh[this.resname.toUpperCase()]||"X"},xm.prototype.getBackboneType=function(e){switch(e){case-1:return this.residueType.backboneStartType;case 1:return this.residueType.backboneEndType;default:return this.residueType.backboneType}},xm.prototype.getAtomIndexByName=function(e){var t=this.residueType.getAtomIndexByName(e);return void 0!==t&&(t+=this.atomOffset),t},xm.prototype.hasAtomWithName=function(e){return this.residueType.hasAtomWithName(e)},xm.prototype.getAtomnameList=function(){console.warn("getAtomnameList - might be expensive");for(var e=this.atomCount,t=this.atomOffset,r=new Array(e),n=0;n<e;++n)r[n]=this.getAtomType(t+n).atomname;return r},xm.prototype.connectedTo=function(e){var t=this.structure.getAtomProxy(this.backboneEndAtomIndex),r=this.structure.getAtomProxy(e.backboneStartAtomIndex);return!(!t||!r)&&t.connectedTo(r)},xm.prototype.getNextConnectedResidue=function(){var e=this.chainStore.residueOffset[this.chainIndex],t=this.chainStore.residueCount[this.chainIndex],r=this.index+1;if(r<e+t){var n=this.structure.getResidueProxy(r);if(this.connectedTo(n))return n}else if(r===e+t){var i=this.structure.getResidueProxy(e);if(this.connectedTo(i))return i}},xm.prototype.getPreviousConnectedResidue=function(e){var t=this.chainStore.residueOffset[this.chainIndex],r=this.index-1;if(r>=t){var n=Ha(e,this.structure.getResidueProxy());if(n.index=r,n.connectedTo(this))return n}else if(r===t-1){var i=this.chainStore.residueCount[this.chainIndex],o=Ha(e,this.structure.getResidueProxy());if(o.index=t+i-1,o.connectedTo(this))return o}},xm.prototype.getBonds=function(){return this.residueType.getBonds(this)},xm.prototype.getRings=function(){return this.residueType.getRings()},xm.prototype.getAromaticRings=function(){return this.residueType.getAromaticRings(this)},xm.prototype.qualifiedName=function(e){void 0===e&&(e=!1);var t="";return this.resname&&!e&&(t+="["+this.resname+"]"),void 0!==this.resno&&(t+=this.resno),this.inscode&&(t+="^"+this.inscode),this.chain&&(t+=":"+this.chainname),t+="/"+this.modelIndex},xm.prototype.clone=function(){return new xm(this.structure,this.index)},xm.prototype.toObject=function(){return{index:this.index,chainIndex:this.chainIndex,atomOffset:this.atomOffset,atomCount:this.atomCount,resno:this.resno,resname:this.resname,sstruc:this.sstruc}},Object.defineProperties(xm.prototype,_m);var Sm=function(e,t,r){this.structure=e,this.residueIndexStart=t,this.residueIndexEnd=r,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueCount=r-t+1;var n=this.structure.getResidueProxy(this.residueIndexStart),i=this.structure.getResidueProxy(this.residueIndexEnd);this.isPrevConnected=void 0!==n.getPreviousConnectedResidue();var o=i.getNextConnectedResidue();this.isNextConnected=void 0!==o,this.isNextNextConnected=void 0!==o&&void 0!==o.getNextConnectedResidue(),this.isCyclic=i.connectedTo(n),this.__residueProxy=this.structure.getResidueProxy()},Cm={chainIndex:{configurable:!0},modelIndex:{configurable:!0},chainname:{configurable:!0}};Cm.chainIndex.get=function(){return this.residueStore.chainIndex[this.residueIndexStart]},Cm.modelIndex.get=function(){return this.chainStore.modelIndex[this.chainIndex]},Cm.chainname.get=function(){return this.chainStore.getChainname(this.chainIndex)},Sm.prototype.isProtein=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isProtein()},Sm.prototype.isCg=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isCg()},Sm.prototype.isNucleic=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isNucleic()},Sm.prototype.getMoleculeType=function(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.moleculeType},Sm.prototype.getBackboneType=function(e){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.getBackboneType(e)},Sm.prototype.getAtomIndexByType=function(e,t){this.isCyclic?-1===e?e=this.residueCount-1:e===this.residueCount&&(e=0):(-1!==e||this.isPrevConnected||(e+=1),e!==this.residueCount||this.isNextNextConnected||(e-=1));var r,n=this.__residueProxy;switch(n.index=this.residueIndexStart+e,t){case"trace":r=n.traceAtomIndex;break;case"direction1":r=n.direction1AtomIndex;break;case"direction2":r=n.direction2AtomIndex;break;default:r=n.getAtomIndexByName(t)}return r},Sm.prototype.eachAtom=function(e,t){this.eachResidue(function(r){r.eachAtom(e,t)})},Sm.prototype.eachAtomN=function(e,t,r){for(var n=this.residueCount,i=new Array(e),o=0;o<e;++o)i[o]=this.structure.getAtomProxy(this.getAtomIndexByType(o,r));t.apply(this,i);for(var a=e;a<n;++a){for(var s=1;s<e;++s)i[s-1].index=i[s].index;i[e-1].index=this.getAtomIndexByType(a,r),t.apply(this,i)}},Sm.prototype.eachResidue=function(e){for(var t=this.structure.getResidueProxy(),r=this.residueCount,n=this.residueIndexStart,i=0;i<r;++i)t.index=n+i,e(t)},Sm.prototype.qualifiedName=function(){var e=this.structure.getResidueProxy(this.residueIndexStart),t=this.structure.getResidueProxy(this.residueIndexEnd);return e.qualifiedName()+" - "+t.qualifiedName()},Object.defineProperties(Sm.prototype,Cm);var Mm=function(e,t){void 0===t&&(t=0),this.structure=e,this.index=t,this.chainStore=e.chainStore,this.residueStore=e.residueStore},Tm={entity:{configurable:!0},model:{configurable:!0},entityIndex:{configurable:!0},modelIndex:{configurable:!0},residueOffset:{configurable:!0},residueCount:{configurable:!0},residueEnd:{configurable:!0},atomOffset:{configurable:!0},atomEnd:{configurable:!0},atomCount:{configurable:!0},chainname:{configurable:!0},chainid:{configurable:!0}};Tm.entity.get=function(){return this.structure.entityList[this.entityIndex]},Tm.model.get=function(){return this.structure.getModelProxy(this.modelIndex)},Tm.entityIndex.get=function(){return this.chainStore.entityIndex[this.index]},Tm.entityIndex.set=function(e){this.chainStore.entityIndex[this.index]=e},Tm.modelIndex.get=function(){return this.chainStore.modelIndex[this.index]},Tm.modelIndex.set=function(e){this.chainStore.modelIndex[this.index]=e},Tm.residueOffset.get=function(){return this.chainStore.residueOffset[this.index]},Tm.residueOffset.set=function(e){this.chainStore.residueOffset[this.index]=e},Tm.residueCount.get=function(){return this.chainStore.residueCount[this.index]},Tm.residueCount.set=function(e){this.chainStore.residueCount[this.index]=e},Tm.residueEnd.get=function(){return this.residueOffset+this.residueCount-1},Tm.atomOffset.get=function(){return this.residueStore.atomOffset[this.residueOffset]},Tm.atomEnd.get=function(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1},Tm.atomCount.get=function(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1},Tm.chainname.get=function(){return this.chainStore.getChainname(this.index)},Tm.chainname.set=function(e){this.chainStore.setChainname(this.index,e)},Tm.chainid.get=function(){return this.chainStore.getChainid(this.index)},Tm.chainid.set=function(e){this.chainStore.setChainid(this.index,e)},Mm.prototype.eachAtom=function(e,t){this.eachResidue(function(r){r.eachAtom(e,t)},t)},Mm.prototype.eachResidue=function(e,t){var r=this.residueCount,n=this.residueOffset,i=this.structure._rp,o=n+r;if(t&&t.test){var a=t.residueOnlyTest;if(a)for(var s=n;s<o;++s)i.index=s,a(i)&&e(i);else for(var l=n;l<o;++l)i.index=l,e(i)}else for(var u=n;u<o;++u)i.index=u,e(i)},Mm.prototype.eachResidueN=function(e,t){var r=this.residueCount,n=this.residueOffset,i=n+r;if(!(r<e)){for(var o=new Array(e),a=0;a<e;++a)o[a]=this.structure.getResidueProxy(n+a);t.apply(this,o);for(var s=n+e;s<i;++s){for(var l=0;l<e;++l)o[l].index+=1;t.apply(this,o)}}},Mm.prototype.eachPolymer=function(e,t){for(var r=0,n=0,i=t?t.residueOnlyTest:void 0,o=this.model.structure,a=this.residueCount,s=this.residueOffset,l=s+a,u=this.structure.getResidueProxy(),c=this.structure.getResidueProxy(s),h=this.structure.getAtomProxy(),p=this.structure.getAtomProxy(),d=!0,f=s+1;f<l;++f){u.index=c.index,c.index=f;var m=d?u.backboneEndType:u.backboneType,g=c.backboneType;d&&(r=u.index,d=!1),n=c.index,m!==Ih&&m===g?(h.index=u.backboneEndAtomIndex,p.index=c.backboneStartAtomIndex,h&&p&&h.connectedTo(p)&&(!i||i(u)&&i(c))||(u.index-r>1&&e(new Sm(o,r,u.index)),r=n)):(m!==Ih&&u.index-r>1&&e(new Sm(o,r,u.index)),r=n)}n-r>1&&this.structure.getResidueProxy(r).backboneEndType&&e(new Sm(o,r,n))},Mm.prototype.qualifiedName=function(){return":"+this.chainname+"/"+this.modelIndex},Mm.prototype.clone=function(){return new Mm(this.structure,this.index)},Mm.prototype.toObject=function(){return{index:this.index,residueOffset:this.residueOffset,residueCount:this.residueCount,chainname:this.chainname}},Object.defineProperties(Mm.prototype,Tm);var Am=function(e,t){void 0===t&&(t=0),this.structure=e,this.index=t,this.modelStore=e.modelStore,this.chainStore=e.chainStore,this.residueStore=e.residueStore},Em={chainOffset:{configurable:!0},chainCount:{configurable:!0},residueOffset:{configurable:!0},atomOffset:{configurable:!0},chainEnd:{configurable:!0},residueEnd:{configurable:!0},atomEnd:{configurable:!0},residueCount:{configurable:!0},atomCount:{configurable:!0}};Em.chainOffset.get=function(){return this.modelStore.chainOffset[this.index]},Em.chainOffset.set=function(e){this.modelStore.chainOffset[this.index]=e},Em.chainCount.get=function(){return this.modelStore.chainCount[this.index]},Em.chainCount.set=function(e){this.modelStore.chainCount[this.index]=e},Em.residueOffset.get=function(){return this.chainStore.residueOffset[this.chainOffset]},Em.atomOffset.get=function(){return this.residueStore.atomOffset[this.residueOffset]},Em.chainEnd.get=function(){return this.chainOffset+this.chainCount-1},Em.residueEnd.get=function(){return this.chainStore.residueOffset[this.chainEnd]+this.chainStore.residueCount[this.chainEnd]-1},Em.atomEnd.get=function(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1},Em.residueCount.get=function(){return 0===this.chainCount?0:this.residueEnd-this.residueOffset+1},Em.atomCount.get=function(){return 0===this.residueCount?0:this.atomEnd-this.atomOffset+1},Am.prototype.eachAtom=function(e,t){this.eachChain(function(r){r.eachAtom(e,t)},t)},Am.prototype.eachResidue=function(e,t){this.eachChain(function(r){r.eachResidue(e,t)},t)},Am.prototype.eachPolymer=function(e,t){if(t&&t.chainOnlyTest){var r=t.chainOnlyTest;this.eachChain(function(n){r(n)&&n.eachPolymer(e,t)})}else this.eachChain(function(r){r.eachPolymer(e,t)})},Am.prototype.eachChain=function(e,t){var r=this.chainCount,n=this.chainOffset,i=this.structure._cp,o=n+r;if(t&&t.test){var a=t.chainOnlyTest;if(a)for(var s=n;s<o;++s)i.index=s,a(i)&&e(i);else for(var l=n;l<o;++l)i.index=l,e(i)}else for(var u=n;u<o;++u)i.index=u,e(i)},Am.prototype.qualifiedName=function(){return"/"+this.index},Am.prototype.clone=function(){return new Am(this.structure,this.index)},Am.prototype.toObject=function(){return{index:this.index,chainOffset:this.chainOffset,chainCount:this.chainCount}},Object.defineProperties(Am.prototype,Em);var Pm=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this.signals={refreshed:new As},this.init(e,t)},Rm={type:{configurable:!0}};Pm.prototype.init=function(e,t){this.name=e,this.path=t,this.title="",this.id="",this.data=function(e){return{structure:e,"@spatialLookup":void 0,"@valenceModel":void 0}}(this),this.header={},this.extraData={},this.atomSetCache={},this.atomSetDict={},this.biomolDict={},this.entityList=[],this.unitcell=void 0,this.frames=[],this.boxes=[],this.validation=void 0,this.bondStore=new yf(0),this.backboneBondStore=new yf(0),this.rungBondStore=new yf(0),this.atomStore=new bf(0),this.residueStore=new wf(0),this.chainStore=new xf(0),this.modelStore=new _f(0),this.atomMap=new hm(this),this.residueMap=new ym(this),this.bondHash=void 0,this.spatialHash=void 0,this.atomSet=void 0,this.bondSet=void 0,this.center=new ft,this.boundingBox=new _r,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy()},Rm.type.get=function(){return"Structure"},Pm.prototype.finalizeAtoms=function(){this.atomSet=this.getAtomSet(),this.atomCount=this.atomStore.count,this.boundingBox=this.getBoundingBox(void 0,this.boundingBox),this.center=this.boundingBox.getCenter(),this.spatialHash=new vh(this.atomStore,this.boundingBox)},Pm.prototype.finalizeBonds=function(){for(var e in this.bondSet=this.getBondSet(),this.bondCount=this.bondStore.count,this.bondHash=new function(e,t){var r=_h({nodeArray1:e.atomIndex1,nodeArray2:e.atomIndex2,edgeCount:e.count,nodeCount:t});this.countArray=r.countArray,this.offsetArray=r.offsetArray,this.indexArray=r.indexArray}(this.bondStore,this.atomStore.count),this.atomSetCache={},this.atomSetDict.rung||(this.atomSetDict.rung=this.getAtomSet(!1)),this.atomSetDict)this.atomSetCache["__"+e]=this.atomSetDict[e].clone()},Pm.prototype.getBondProxy=function(e){return new bm(this,e)},Pm.prototype.getAtomProxy=function(e){return new Af(this,e)},Pm.prototype.getResidueProxy=function(e){return new xm(this,e)},Pm.prototype.getChainProxy=function(e){return new Mm(this,e)},Pm.prototype.getModelProxy=function(e){return new Am(this,e)},Pm.prototype.getBondSet=function(){var e=this.bondStore.count,t=new xh(e),r=this.atomSet;if(r)for(var n=this.getBondProxy(),i=0;i<e;++i)n.index=i,r.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index);else t.setAll();return t},Pm.prototype.getBackboneBondSet=function(){var e=this.backboneBondStore.count,t=new xh(e),r=this.atomSetCache.__backbone;if(r){var n=this.getBondProxy();n.bondStore=this.backboneBondStore;for(var i=0;i<e;++i)n.index=i,r.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index)}else t.setAll();return t},Pm.prototype.getRungBondSet=function(){var e=this.rungBondStore.count,t=new xh(e),r=this.atomSetCache.__rung;if(r){var n=this.getBondProxy();n.bondStore=this.rungBondStore;for(var i=0;i<e;++i)n.index=i,r.isSet(n.atomIndex1,n.atomIndex2)&&t.set(n.index)}else t.setAll();return t},Pm.prototype.getAtomSet=function(e){var t=this.atomStore.count;if(void 0===e)return new xh(t,!0);if(e instanceof xh)return e;if(!0===e)return new xh(t,!0);if(e&&e.test){var r=e.string;if(r in this.atomSetCache)return this.atomSetCache[r];var n=new xh(t);return this.eachAtom(function(e){n.set(e.index)},e),this.atomSetCache[r]=n,n}return!1===e?new xh(t):new xh(t,!0)},Pm.prototype.getAtomSetWithinSelection=function(e,t){var r=this.spatialHash,n=this.getAtomSet(!1),i=this.getAtomProxy();return r?(this.getAtomSet(e).forEach(function(e){i.index=e,r.within(i.x,i.y,i.z,t).forEach(function(e){n.set(e)})}),n):n},Pm.prototype.getAtomSetWithinPoint=function(e,t){var r=e,n=this.getAtomSet(!1);return this.spatialHash?(this.spatialHash.within(r.x,r.y,r.z,t).forEach(function(e){n.set(e)}),n):n},Pm.prototype.getAtomSetWithinVolume=function(e,t,r,n,i){var o=new gf(e,r,n,i),a=o.getDataPosition(),s=a.length,l=o.matrix.getMaxScaleOnAxis(),u=this.getAtomSet(!1);if(!this.spatialHash)return u;for(var c=0;c<s;c+=3)this.spatialHash.within(a[c],a[c+1],a[c+2],l).forEach(function(e){u.set(e)});return u},Pm.prototype.getAtomSetWithinGroup=function(e){var t=this.atomStore.residueIndex,r=this.getAtomSet(!1),n=this.getResidueProxy();return this.getAtomSet(e).forEach(function(e){n.index=t[e];for(var i=n.atomOffset;i<=n.atomEnd;++i)r.set(i)}),r},Pm.prototype.getSelection=function(){return!1},Pm.prototype.getStructure=function(){return this},Pm.prototype.eachEntity=function(e,t){this.entityList.forEach(function(r){void 0!==t&&r.getEntityType()!==t||e(r)})},Pm.prototype.eachBond=function(e,t){var r,n=this.getBondProxy();if(t&&t.test&&(r=this.getBondSet(),this.bondSet&&r.intersection(this.bondSet)),r)r.forEach(function(t){n.index=t,e(n)});else for(var i=this.bondStore.count,o=0;o<i;++o)n.index=o,e(n)},Pm.prototype.eachAtom=function(e,t){if(t&&t.test)this.eachModel(function(r){r.eachAtom(e,t)},t);else for(var r=this.atomStore.count,n=this.getAtomProxy(),i=0;i<r;++i)n.index=i,e(n)},Pm.prototype.eachResidue=function(e,t){if(t&&t.test){var r=this.modelStore.count,n=this.getModelProxy(),i=t.modelOnlyTest;if(i)for(var o=0;o<r;++o)n.index=o,i(n)&&n.eachResidue(e,t);else for(var a=0;a<r;++a)n.index=a,n.eachResidue(e,t)}else for(var s=this.residueStore.count,l=this.getResidueProxy(),u=0;u<s;++u)l.index=u,e(l)},Pm.prototype.eachResidueN=function(e,t){var r=this.residueStore.count;if(!(r<e)){for(var n=new Array(e),i=0;i<e;++i)n[i]=this.getResidueProxy(i);t.apply(this,n);for(var o=e;o<r;++o){for(var a=0;a<e;++a)n[a].index+=1;t.apply(this,n)}}},Pm.prototype.eachPolymer=function(e,t){if(t&&t.modelOnlyTest){var r=t.modelOnlyTest;this.eachModel(function(n){r(n)&&n.eachPolymer(e,t)})}else this.eachModel(function(r){r.eachPolymer(e,t)})},Pm.prototype.eachChain=function(e,t){if(t&&t.test)this.eachModel(function(r){r.eachChain(e,t)});else for(var r=this.chainStore.count,n=this.getChainProxy(),i=0;i<r;++i)n.index=i,e(n)},Pm.prototype.eachModel=function(e,t){var r=this.modelStore.count,n=this.getModelProxy();if(t&&t.test){var i=t.modelOnlyTest;if(i)for(var o=0;o<r;++o)n.index=o,i(n)&&e(n);else for(var a=0;a<r;++a)n.index=a,e(n)}else for(var s=0;s<r;++s)n.index=s,e(n)},Pm.prototype.getAtomData=function(e){var t=Object.assign({},e);t.colorParams&&(t.colorParams.structure=this.getStructure());var r,n,i=t.what,o=Ha(t.atomSet,this.atomSet),a={},s=this.getAtomProxy(),l=o.getSize();i&&!i.position||(a.position=new Float32Array(3*l)),i&&!i.color||!t.colorParams||(a.color=new Float32Array(3*l),n=Sl.getScheme(t.colorParams)),i&&!i.picking||(a.picking=new kp(new Float32Array(l),this.getStructure())),i&&!i.radius||(a.radius=new Float32Array(l),r=new pf(t.radiusParams)),i&&!i.index||(a.index=new Uint32Array(l));var u=a.position,c=a.color,h=a.picking,p=a.radius,d=a.index;return o.forEach(function(e,t){var i=3*t;s.index=e,u&&s.positionToArray(u,i),c&&n.atomColorToArray(s,c,i),h&&(h.array[t]=e),p&&(p[t]=r.atomRadius(s)),d&&(d[t]=e)}),a},Pm.prototype.getBondData=function(e){var t=Object.assign({},e);t.colorParams&&(t.colorParams.structure=this.getStructure());var r,n,i=t.what,o=Ha(t.bondSet,this.bondSet),a=Ha(t.multipleBond,"off"),s="off"!==a,l="offset"===a,u=Ha(t.bondScale,.4),c=Ha(t.bondSpacing,1),h={},p=this.getBondProxy();t.bondStore&&(p.bondStore=t.bondStore);var d,f=this.getAtomProxy(),m=this.getAtomProxy();if(s){var g=p.bondStore.bondOrder;d=0,o.forEach(function(e){d+=g[e]})}else d=o.getSize();i&&!i.position||(h.position1=new Float32Array(3*d),h.position2=new Float32Array(3*d)),i&&!i.color||!t.colorParams||(h.color=new Float32Array(3*d),h.color2=new Float32Array(3*d),n=Sl.getScheme(t.colorParams)),i&&!i.picking||(h.picking=new Fp(new Float32Array(d),this.getStructure(),t.bondStore)),(!i||i.radius||s&&i.position)&&(r=new pf(t.radiusParams)),i&&!i.radius||(h.radius=new Float32Array(d),t.radius2&&(h.radius2=new Float32Array(d)));var v,y,b,w,x,_,S=h.position1,C=h.position2,M=h.color,T=h.color2,A=h.picking,E=h.radius,P=h.radius2,R=0,I=new ft,N=new ft,D=new ft;return o.forEach(function(e){if(y=3*R,p.index=e,f.index=p.atomIndex1,m.index=p.atomIndex2,w=p.bondOrder,S)if(s&&w>1){var t=r.atomRadius(f);_=t*u/(.5*w),p.calculateShiftDir(D),l?(x=2*c*t,D.multiplyScalar(x),D.negate(),N.subVectors(m,f).multiplyScalar(Math.max(.1,x/1.88)),f.positionToArray(S,y),m.positionToArray(C,y),w>=2&&(I.addVectors(f,D).add(N).toArray(S,y+3),I.addVectors(m,D).sub(N).toArray(C,y+3),w>=3&&(I.subVectors(f,D).add(N).toArray(S,y+6),I.subVectors(m,D).sub(N).toArray(C,y+6)))):(x=(c-u)*t,D.multiplyScalar(x),2===w?(I.addVectors(f,D).toArray(S,y),I.subVectors(f,D).toArray(S,y+3),I.addVectors(m,D).toArray(C,y),I.subVectors(m,D).toArray(C,y+3)):3===w?(f.positionToArray(S,y),I.addVectors(f,D).toArray(S,y+3),I.subVectors(f,D).toArray(S,y+6),m.positionToArray(C,y),I.addVectors(m,D).toArray(C,y+3),I.subVectors(m,D).toArray(C,y+6)):(f.positionToArray(S,y),m.positionToArray(C,y)))}else f.positionToArray(S,y),m.positionToArray(C,y);if(M&&T&&(n.bondColorToArray(p,1,M,y),n.bondColorToArray(p,0,T,y),s&&w>1))for(v=1;v<w;++v)wu(M,y,b=3*v+y,3),wu(T,y,b,3);if(A&&(A.array[R]=e,s&&w>1))for(v=1;v<w;++v)A.array[R+v]=e;if(E&&(E[R]=r.atomRadius(f),s&&w>1))for(_=E[R]*u/(l?1:.5*w),v=l?1:0;v<w;++v)E[R+v]=_;if(P&&(P[R]=r.atomRadius(m),s&&w>1))for(_=P[R]*u/(l?1:.5*w),v=l?1:0;v<w;++v)P[R+v]=_;R+=s?w:1}),h},Pm.prototype.getBackboneAtomData=function(e){return e=Object.assign({atomSet:this.atomSetCache.__backbone},e),this.getAtomData(e)},Pm.prototype.getBackboneBondData=function(e){return e=Object.assign({bondSet:this.getBackboneBondSet(),bondStore:this.backboneBondStore},e),this.getBondData(e)},Pm.prototype.getRungAtomData=function(e){return e=Object.assign({atomSet:this.atomSetCache.__rung},e),this.getAtomData(e)},Pm.prototype.getRungBondData=function(e){return e=Object.assign({bondSet:this.getRungBondSet(),bondStore:this.rungBondStore},e),this.getBondData(e)},Pm.prototype.getBoundingBox=function(e,t){vl&&gl.time("getBoundingBox"),t=t||new _r;var r=1/0,n=1/0,i=1/0,o=-1/0,a=-1/0,s=-1/0;return this.eachAtom(function(e){var t=e.x,l=e.y,u=e.z;t<r&&(r=t),l<n&&(n=l),u<i&&(i=u),t>o&&(o=t),l>a&&(a=l),u>s&&(s=u)},e),t.min.set(r,n,i),t.max.set(o,a,s),vl&&gl.timeEnd("getBoundingBox"),t},Pm.prototype.getPrincipalAxes=function(e){vl&&gl.time("getPrincipalAxes");var t=0,r=new nd(3,this.atomCount),n=r.data;return this.eachAtom(function(e){n[t+0]=e.x,n[t+1]=e.y,n[t+2]=e.z,t+=3},e),vl&&gl.timeEnd("getPrincipalAxes"),new mf(r)},Pm.prototype.atomCenter=function(e){return e?this.getBoundingBox(e).getCenter():this.center.clone()},Pm.prototype.hasCoords=function(){var e=this.atomStore;return 0!==_u(e.x)||0!==xu(e.x)||0!==_u(e.y)||0!==xu(e.y)||0!==_u(e.z)||0!==xu(e.z)},Pm.prototype.getSequence=function(e){var t=[],r=this.getResidueProxy();return this.eachAtom(function(e){r.index=e.residueIndex,e.index===r.traceAtomIndex&&t.push(r.getResname1())},e),t},Pm.prototype.getAtomIndices=function(e){if(e&&e.string){var t=[];return this.eachAtom(function(e){t.push(e.index)},e),new Uint32Array(t)}return this.getAtomData({what:{index:!0}}).index},Pm.prototype.getChainnameCount=function(e){var t=new Set;return this.eachChain(function(e){e.residueCount&&t.add(e.chainname)},e),t.size},Pm.prototype.updatePosition=function(e){var t=0;this.eachAtom(function(r){r.positionFromArray(e,t),t+=3},void 0)},Pm.prototype.refreshPosition=function(){this.getBoundingBox(void 0,this.boundingBox),this.boundingBox.getCenter(this.center),this.spatialHash=new vh(this.atomStore,this.boundingBox)},Pm.prototype.dispose=function(){this.frames&&(this.frames.length=0),this.boxes&&(this.boxes.length=0),this.bondStore.dispose(),this.backboneBondStore.dispose(),this.rungBondStore.dispose(),this.atomStore.dispose(),this.residueStore.dispose(),this.chainStore.dispose(),this.modelStore.dispose(),delete this.bondStore,delete this.atomStore,delete this.residueStore,delete this.chainStore,delete this.modelStore,delete this.frames,delete this.boxes,delete this.bondSet,delete this.atomSet},Object.defineProperties(Pm.prototype,Rm);var Im=new _r,Nm=[ph,lh,dh,hh,fh,uh,sh,ch,gh,mh],Dm={aspectRatio:1.5,sphereDetail:2,radialSegments:50,disableImpostor:!1,openEnded:!1,labelParams:{}},km=function(e,t){var r=this;void 0===e&&(e="shape"),void 0===t&&(t={}),this.boundingBox=new _r,this.bufferList=[],this.meshCount=0,this._primitiveData={},this.name=e,this.parameters=$a(t,Dm),Nm.forEach(function(e){Object.keys(e.fields).forEach(function(t){r._primitiveData[e.getShapeKey(t)]=[]}),r._primitiveData[e.getShapeKey("name")]=[]})},Om={center:{configurable:!0},type:{configurable:!0}};km.prototype.addBuffer=function(e){this.bufferList.push(e);var t=e.geometry;return t.boundingBox||t.computeBoundingBox(),this.boundingBox.union(t.boundingBox),this},km.prototype.addMesh=function(e,t,r,n,i){e=cs(e),t=cs(t),Array.isArray(r)&&(r=is(r,e.length)),n&&(n=cs(n));var o={position:e,color:t,index:r,normal:n},a=new Gp(this,Object.assign({serial:this.meshCount,name:i},o)),s=new Ud(Object.assign({picking:a},o));return this.bufferList.push(s),Im.setFromArray(e),this.boundingBox.union(Im),this.meshCount+=1,this},km.prototype.addSphere=function(e,t,r,n){return sh.objectToShape(this,{position:e,color:t,radius:r,name:n}),this},km.prototype.addEllipsoid=function(e,t,r,n,i,o){return fh.objectToShape(this,{position:e,color:t,radius:r,majorAxis:n,minorAxis:i,name:o}),this},km.prototype.addTorus=function(e,t,r,n,i,o){return mh.objectToShape(this,{position:e,color:t,radius:r,majorAxis:n,minorAxis:i,name:o}),this},km.prototype.addCylinder=function(e,t,r,n,i){return hh.objectToShape(this,{position1:e,position2:t,color:r,radius:n,name:i}),this},km.prototype.addCone=function(e,t,r,n,i){return dh.objectToShape(this,{position1:e,position2:t,color:r,radius:n,name:i}),this},km.prototype.addArrow=function(e,t,r,n,i){return ph.objectToShape(this,{position1:e,position2:t,color:r,radius:n,name:i}),this},km.prototype.addBox=function(e,t,r,n,i,o){return lh.objectToShape(this,{position:e,color:t,size:r,heightAxis:n,depthAxis:i,name:o}),this},km.prototype.addOctahedron=function(e,t,r,n,i,o){return uh.objectToShape(this,{position:e,color:t,size:r,heightAxis:n,depthAxis:i,name:o}),this},km.prototype.addTetrahedron=function(e,t,r,n,i,o){return ch.objectToShape(this,{position:e,color:t,size:r,heightAxis:n,depthAxis:i,name:o}),this},km.prototype.addText=function(e,t,r,n){return gh.objectToShape(this,{position:e,color:t,size:r,text:n}),this},km.prototype.addLabel=function(e,t,r,n){return console.warn("Shape.addLabel is deprecated, use .addText instead"),this.addText(e,t,r,n)},km.prototype.getBufferList=function(){var e=this,t=[];return Nm.forEach(function(r){e._primitiveData[r.getShapeKey("color")].length&&t.push(r.bufferFromShape(e,e.parameters))}),this.bufferList.concat(t)},km.prototype.dispose=function(){var e=this;this.bufferList.forEach(function(e){e.dispose()}),this.bufferList.length=0,Nm.forEach(function(t){Object.keys(t.fields).forEach(function(r){e._primitiveData[t.getShapeKey(r)].length=0}),e._primitiveData[t.getShapeKey("name")].length=0})},Om.center.get=function(){return this._center||(this._center=this.boundingBox.getCenter()),this._center},Om.type.get=function(){return"Shape"},Object.defineProperties(km.prototype,Om);var Fm=function(e){function t(t,r,n){Array.isArray(t)||(t=[t]),e.call(this,t,r,n),this.type="buffer",this.parameters=Object.assign({},this.parameters,{colorScheme:null,colorScale:null,colorValue:null,colorDomain:null,colorMode:null}),this.buffer=t,this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){e.prototype.init.call(this,t),this.build()},t.prototype.create=function(){this.bufferList.push.apply(this.bufferList,this.buffer)},t.prototype.attach=function(e){var t=this;this.bufferList.forEach(function(e){t.viewer.add(e),e.setParameters(t.getBufferParams())}),this.setVisibility(this.visible),e()},t}(Dc),Lm=new pt,Um=new mt;var Vm=function(e){function t(t,r,n){void 0===r&&(r={}),e.call(this,function(e,t){var r,n=t.attributes.position.array,i=t.index?t.index.array:void 0,o=e.position.length/3,a=n.length/3,s=o*a,l=new Float32Array(3*s),u=new Float32Array(3*s),c=new Float32Array(3*s);return i&&(r=is(o*i.length,s)),{position:l,color:c,index:r,normal:u,primitiveId:e.primitiveId||vu(o,a),picking:e.picking}}(t,n),r),this.updateNormals=!1;var i=n.attributes.position.array,o=n.attributes.normal.array,a=n.index?n.index.array:void 0;this.geoPosition=i,this.geoNormal=o,this.geoIndex=a,this.positionCount=t.position.length/3,this.geoPositionCount=i.length/3,this.transformedGeoPosition=new Float32Array(3*this.geoPositionCount),this.transformedGeoNormal=new Float32Array(3*this.geoPositionCount);var s=this.geometry.attributes;this.meshPosition=s.position.array,this.meshColor=s.color.array,this.meshNormal=s.normal.array,this.setAttributes(t),a&&(this.meshIndex=this.geometry.getIndex().array,this.makeIndex())}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setAttributes=function(e,t){void 0===e&&(e={}),void 0===t&&(t=!1);var r,n,i,o,a,s,l,u,c,h=this.geometry.attributes,p=this.updateNormals;e.position&&(r=e.position,i=this.geoPosition,l=this.meshPosition,a=this.transformedGeoPosition,h.position.needsUpdate=!0,(p||t)&&(o=this.geoNormal,c=this.meshNormal,s=this.transformedGeoNormal,h.normal.needsUpdate=!0)),e.color&&(n=e.color,u=this.meshColor,h.color.needsUpdate=!0);for(var d=this.positionCount,f=this.geoPositionCount,m=0;m<d;++m){var g=void 0,v=void 0,y=m*f*3,b=3*m;if(r&&a&&l&&c&&i&&o&&(a.set(i),Lm.makeTranslation(r[b],r[b+1],r[b+2]),this.applyPositionTransform(Lm,m,b),Vc(Lm.elements,a),l.set(a,y),p&&s?(s.set(o),Um.getNormalMatrix(Lm),Bc(Um.elements,s),c.set(s,y)):t&&c.set(o,y)),n&&u)for(g=0;g<f;++g)u[v=y+3*g]=n[b],u[v+1]=n[b+1],u[v+2]=n[b+2]}},t.prototype.makeIndex=function(){var e=this.geoIndex,t=this.meshIndex;if(e)for(var r=this.positionCount,n=this.geoPositionCount,i=3*(e.length/3),o=0;o<r;++o){var a=o*i,s=a+i;t.set(e,a);for(var l=a;l<s;++l)t[l]+=o*n}},t}(Ud),Bm=new ft,zm=Object.assign({sphereDetail:1},kd),jm=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new ni(1,Ha(r.sphereDetail,1))),this.setAttributes(t,!0)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return zm},t.prototype.applyPositionTransform=function(e,t){var r=this._radius[t];Bm.set(r,r,r),e.scale(Bm)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),e.prototype.setAttributes.call(this,t,r)},Object.defineProperties(t.prototype,r),t}(Vm);Al.add("shader/SphereImpostor.vert","uniform mat4 projectionMatrixInverse;\nuniform float clipNear;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\nattribute vec2 mapping;\nattribute float radius;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\n#include matrix_scale\nconst mat4 D = mat4(\n1.0, 0.0, 0.0, 0.0,\n0.0, 1.0, 0.0, 0.0,\n0.0, 0.0, 1.0, 0.0,\n0.0, 0.0, 0.0, -1.0\n);\nmat4 transpose( in mat4 inMatrix ) {\nvec4 i0 = inMatrix[0];\nvec4 i1 = inMatrix[1];\nvec4 i2 = inMatrix[2];\nvec4 i3 = inMatrix[3];\nmat4 outMatrix = mat4(\nvec4(i0.x, i1.x, i2.x, i3.x),\nvec4(i0.y, i1.y, i2.y, i3.y),\nvec4(i0.z, i1.z, i2.z, i3.z),\nvec4(i0.w, i1.w, i2.w, i3.w)\n);\nreturn outMatrix;\n}\nvoid ComputePointSizeAndPositionInClipCoordSphere(){\nvec2 xbc;\nvec2 ybc;\nmat4 T = mat4(\nradius, 0.0, 0.0, 0.0,\n0.0, radius, 0.0, 0.0,\n0.0, 0.0, radius, 0.0,\nposition.x, position.y, position.z, 1.0\n);\nmat4 R = transpose( projectionMatrix * modelViewMatrix * T );\nfloat A = dot( R[ 3 ], D * R[ 3 ] );\nfloat B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );\nfloat C = dot( R[ 0 ], D * R[ 0 ] );\nxbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nxbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;\nA = dot( R[ 3 ], D * R[ 3 ] );\nB = -2.0 * dot( R[ 1 ], D * R[ 3 ] );\nC = dot( R[ 1 ], D * R[ 1 ] );\nybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );\nfloat sy = abs( ybc[ 0 ] - ybc[ 1 ] ) * 0.5;\ngl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );\ngl_Position.xy -= mapping * vec2( sx, sy );\ngl_Position.xy *= gl_Position.w;\n}\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\nvRadius = radius * matrixScale( modelViewMatrix );\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nmvPosition.z -= vRadius;\ngl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );\nComputePointSizeAndPositionInClipCoordSphere();\nvRadiusSq = vRadius * vRadius;\nvec4 vPoint4 = projectionMatrixInverse * gl_Position;\nvPoint = vPoint4.xyz / vPoint4.w;\nvPointViewPosition = -mvPosition.xyz / mvPosition.w;\n}"),Al.add("shader/SphereImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying float vRadius;\nvarying float vRadiusSq;\nvarying vec3 vPoint;\nvarying vec3 vPointViewPosition;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars\n#include lights_physical_pars_fragment\n#endif\nbool flag2 = false;\nbool interior = false;\nvec3 cameraPos;\nvec3 cameraNormal;\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nbool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){\nvec3 cameraSpherePos = -vPointViewPosition;\ncameraSpherePos.z += vRadius;\nvec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );\nvec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );\nvec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );\nfloat B = dot( rayDirection, cameraSphereDir );\nfloat det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );\nif( det < 0.0 ){\ndiscard;\nreturn false;\n}else{\nfloat sqrtDet = sqrt( det );\nfloat posT = mix( B + sqrtDet, B + sqrtDet, ortho );\nfloat negT = mix( B - sqrtDet, sqrtDet - B, ortho );\ncameraPos = rayDirection * negT + rayOrigin;\n#ifdef NEAR_CLIP\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nreturn false;\n}else if( calcClip( cameraPos ) > 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nflag2 = true;\nreturn false;\n}else{\ncameraNormal = normalize( cameraPos - cameraSpherePos );\n}\n#else\nif( calcDepth( cameraPos ) <= 0.0 ){\ncameraPos = rayDirection * posT + rayOrigin;\ninterior = true;\nreturn false;\n}else{\ncameraNormal = normalize( cameraPos - cameraSpherePos );\n}\n#endif\nreturn true;\n}\nreturn false;\n}\nvoid main(void){\nbool flag = Impostor( cameraPos, cameraNormal );\n#ifdef NEAR_CLIP\nif( calcClip( cameraPos ) > 0.0 )\ndiscard;\n#endif\ngl_FragDepthEXT = calcDepth( cameraPos );\nif( !flag ){\n#ifdef NEAR_CLIP\nif( flag2 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}else if( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#else\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n#endif\n}\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vNormal = cameraNormal;\nvec3 vViewPosition = -cameraPos;\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\n#include normal_flip\n#include normal_fragment\nif( interior ){\nnormal = vec3( 0.0, 0.0, 0.4 );\n}\n#include lights_physical_fragment\n#include lights_template\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Hm=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.index=is(this.indexSize,this.attributeSize),this.makeIndex(),this.initIndex(this.index),this.addAttributes({mapping:{type:this.mappingType,value:null}}),this.setAttributes({primitiveId:gu(this.size)})}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={attributeSize:{configurable:!0},indexSize:{configurable:!0}};return r.attributeSize.get=function(){return this.size*this.mappingSize},r.indexSize.get=function(){return this.size*this.mappingIndicesSize},t.prototype.addAttributes=function(t){var r={};for(var n in t){var i=t[n];r[n]={type:i.type,value:null}}e.prototype.addAttributes.call(this,r)},t.prototype.getAttributeIndex=function(e){return 3*e*this.mappingSize},t.prototype.setAttributes=function(e){e&&!e.position&&e.position1&&e.position2&&(e.position=pu(e.position1,e.position2));var t,r,n,i,o,a,s,l=this.size,u=this.mappingSize,c=this.geometry.attributes;for(var h in e)if("index"!==h&&"picking"!==h){r=e[h],n=(t=c[h]).itemSize,i=t.array;for(var p=0;p<l;++p){a=(o=p*n)*u;for(var d=0;d<u;++d){s=a+n*d;for(var f=0;f<n;++f)i[s+f]=r[o+f]}}t.needsUpdate=!0}},t.prototype.makeMapping=function(){for(var e=this.size,t=this.mapping,r=this.mappingSize,n=this.mappingItemSize,i=this.geometry.attributes.mapping.array,o=0;o<e;o++)i.set(t,o*n*r)},t.prototype.makeIndex=function(){for(var e=this.size,t=this.mappingSize,r=this.mappingIndices,n=this.mappingIndicesSize,i=this.index,o=0;o<e;o++){var a=o*n,s=o*t;i.set(r,a);for(var l=0;l<n;++l)i[a+l]+=s}},Object.defineProperties(t.prototype,r),t}(Fd),$m=new Float32Array([-1,1,-1,-1,1,1,1,-1]),Gm=new Uint16Array([0,1,2,1,3,2]),Wm=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingType:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return r.mapping.get=function(){return $m},r.mappingIndices.get=function(){return Gm},r.mappingIndicesSize.get=function(){return 6},r.mappingType.get=function(){return"v2"},r.mappingSize.get=function(){return 4},r.mappingItemSize.get=function(){return 2},Object.defineProperties(t.prototype,r),t}(Hm),qm=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.isImpostor=!0,this.vertexShader="SphereImpostor.vert",this.fragmentShader="SphereImpostor.frag",this.addUniforms({projectionMatrixInverse:{value:new pt},ortho:{value:0}}),this.addAttributes({radius:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Wm),Xm=(Object.assign({disableImpostor:!1},zm),function(e,t){return!ml||t&&t.disableImpostor?new jm(e,t):new qm(e,t)});function Km(e,t,r,n){var i=r-e,o=n-t;return Math.sqrt(i*i+o*o)}Rl.add("sphere",Xm),Al.add("shader/Point.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float size;\nuniform float canvasHeight;\nuniform float pixelRatio;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\nvarying vec3 vViewPosition;\n#endif\n#include common\nvoid main(){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\n#include begin_vertex\n#include project_vertex\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * pixelRatio * ( ( canvasHeight / 2.0 ) / -mvPosition.z );\n#else\ngl_PointSize = size * pixelRatio;\n#endif\n#ifndef PICKING\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),Al.add("shader/Point.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\n#ifdef USE_MAP\nif( texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).a < 0.5 )\ndiscard;\n#endif\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\n#ifdef USE_MAP\ndiffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif\n#include color_fragment\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Ym=Object.assign({pointSize:1,sizeAttenuation:!0,sortParticles:!1,alphaTest:.5,useTexture:!1,forceTransparent:!1,edgeBleach:0},kd),Zm=Object.assign({pointSize:{uniform:"size"},sizeAttenuation:{updateShader:!0},sortParticles:{},alphaTest:{updateShader:!0},useTexture:{updateShader:!0},forceTransparent:{},edgeBleach:{uniform:!0}},Od),Jm=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.parameterTypes=Zm,this.vertexShader="Point.vert",this.fragmentShader="Point.frag",this.isPoint=!0,this.addUniforms({size:{value:this.parameters.pointSize},canvasHeight:{value:1},pixelRatio:{value:1},map:{value:null}})}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return Ym},t.prototype.makeMaterial=function(){e.prototype.makeMaterial.call(this),this.makeTexture();var t=this.material,r=this.wireframeMaterial,n=this.pickingMaterial;t.uniforms.map.value=this.tex,t.needsUpdate=!0,r.uniforms.map.value=this.tex,r.needsUpdate=!0,n.uniforms.map.value=this.tex,n.needsUpdate=!0},t.prototype.makeTexture=function(){this.tex&&this.tex.dispose(),this.tex=function(e){for(var t=e||{},r=Ha(t.width,256),n=Ha(t.height,256),i=[r/2,n/2],o=Math.min(r/2,n/2),a=Ha(t.delta,1/(o+1))*o,s=0,l=0,u=new Uint8Array(r*n*4),c=0,h=u.length;c<h;c+=4){var p=1-_s(o-a,o,Km(s,l,i[0],i[1]));u[c]=255*p,u[c+1]=255*p,u[c+2]=255*p,u[c+3]=255*p,++s===r&&(s=0,l++)}var d=new xt(u,r,n);return d.needsUpdate=!0,d}({delta:this.parameters.edgeBleach})},t.prototype.getDefines=function(t){var r=e.prototype.getDefines.call(this,t);return this.parameters.sizeAttenuation&&(r.USE_SIZEATTENUATION=1),this.parameters.useTexture&&(r.USE_MAP=1),this.parameters.alphaTest>0&&this.parameters.alphaTest<=1&&(r.ALPHATEST=this.parameters.alphaTest.toPrecision(2)),r},t.prototype.setUniforms=function(t){t&&void 0!==t.edgeBleach&&(this.makeTexture(),t.map=this.tex),e.prototype.setUniforms.call(this,t)},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.tex&&this.tex.dispose()},Object.defineProperties(t.prototype,r),t}(Fd),Qm=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="dot",this.parameters=Object.assign({thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdOut:{type:"boolean",rebuild:!0},dotType:{type:"select",rebuild:!0,options:{"":"",sphere:"sphere",point:"point"}},radiusType:{type:"select",options:{"":"",value:"value","abs-value":"abs-value","value-min":"value-min",deviation:"deviation",size:"size"}},radius:{type:"number",precision:3,max:10,min:.001,property:"size"},scale:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,disableImpostor:!0,pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{colorScheme:{type:"select",update:"color",options:{"":"",value:"value",uniform:"uniform",random:"random"}}}),t instanceof Pd?(this.surface=void 0,this.volume=new gf(t)):(this.surface=t,this.volume=void 0),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"uniform"),r.colorValue=Ha(r.colorValue,14540253),this.thresholdType=Ha(r.thresholdType,"sigma"),this.thresholdMin=Ha(r.thresholdMin,2),this.thresholdMax=Ha(r.thresholdMax,1/0),this.thresholdOut=Ha(r.thresholdOut,!1),this.dotType=Ha(r.dotType,"point"),this.radius=Ha(r.radius,.1),this.scale=Ha(r.scale,1),this.pointSize=Ha(r.pointSize,1),this.sizeAttenuation=Ha(r.sizeAttenuation,!0),this.sortParticles=Ha(r.sortParticles,!1),this.useTexture=Ha(r.useTexture,!1),this.alphaTest=Ha(r.alphaTest,.5),this.forceTransparent=Ha(r.forceTransparent,!1),this.edgeBleach=Ha(r.edgeBleach,0),e.prototype.init.call(this,r),this.build()},t.prototype.attach=function(e){var t=this;this.bufferList.forEach(function(e){t.viewer.add(e)}),this.setVisibility(this.visible),e()},t.prototype.create=function(){var e={};if(this.volume){var t,r,n=this.volume;"sigma"===this.thresholdType?(t=n.getValueForSigma(this.thresholdMin),r=n.getValueForSigma(this.thresholdMax)):(t=this.thresholdMin,r=this.thresholdMax),n.setFilter(t,r,this.thresholdOut),e.position=n.getDataPosition(),e.color=n.getDataColor(this.getColorParams()),"sphere"===this.dotType&&(e.radius=n.getDataSize(this.radius,this.scale),e.picking=n.getDataPicking())}else{var i=this.surface;e.position=i.getPosition(),e.color=i.getColor(this.getColorParams()),"sphere"===this.dotType&&(e.radius=i.getSize(this.radius,this.scale),e.picking=i.getPicking())}"sphere"===this.dotType?this.dotBuffer=new Xm(e,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!1})):this.dotBuffer=new Jm(e,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach})),this.bufferList.push(this.dotBuffer)},t.prototype.update=function(e){if(0!==this.bufferList.length){var t={};(e=e||{}).color&&(this.volume?t.color=this.volume.getDataColor(this.getColorParams()):t.color=this.surface.getColor(this.getColorParams())),"sphere"===this.dotType&&(e.radius||e.scale)&&(this.volume?t.radius=this.volume.getDataSize(this.radius,this.scale):t.radius=this.surface.getSize(this.radius,this.scale)),this.dotBuffer.setAttributes(t)}},t.prototype.setParameters=function(t,r,n){return r=r||{},t&&void 0!==t.thresholdType&&this.volume instanceof Pd&&("value"===this.thresholdType&&"sigma"===t.thresholdType?(this.thresholdMin=this.volume.getSigmaForValue(this.thresholdMin),this.thresholdMax=this.volume.getSigmaForValue(this.thresholdMax)):"sigma"===this.thresholdType&&"value"===t.thresholdType&&(this.thresholdMin=this.volume.getValueForSigma(this.thresholdMin),this.thresholdMax=this.volume.getValueForSigma(this.thresholdMax)),this.thresholdType=t.thresholdType),t&&void 0!==t.radiusType&&("radius"===t.radiusType?this.radius=.1:this.radius=t.radiusType,r.radius=!0,"sphere"!==this.dotType||ml&&!this.disableImpostor||(n=!0)),t&&void 0!==t.radius&&(r.radius=!0,"sphere"!==this.dotType||ml&&!this.disableImpostor||(n=!0)),t&&void 0!==t.scale&&(r.scale=!0,"sphere"!==this.dotType||ml&&!this.disableImpostor||(n=!0)),e.prototype.setParameters.call(this,t,r,n),this},t}(Dc);Al.add("shader/Image.vert","uniform float clipRadius;\nuniform vec3 clipCenter;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid main() {\n#include begin_vertex\n#include project_vertex\nvUv = uv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n}"),Al.add("shader/Image.frag","uniform sampler2D map;\nuniform float opacity;\nuniform vec2 mapSize;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec2 vUv;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform sampler2D pickingMap;\nuniform float objectId;\n#else\n#include fog_pars_fragment\n#endif\n#if defined( CUBIC_INTERPOLATION )\n#if defined( CATMULROM_FILTER ) || defined( MITCHELL_FILTER )\n#if defined( CATMULROM_FILTER )\nconst float B = 0.0;\nconst float C = 0.5;\n#elif defined( MITCHELL_FILTER )\nconst float B = 0.333;\nconst float C = 0.333;\n#endif\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f < 1.0 ){\nreturn ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +\n( -18.0 + 12.0 * B + 6.0 *C ) * ( f * f ) +\n( 6.0 - 2.0 * B ) ) / 6.0;\n}else if( f >= 1.0 && f < 2.0 ){\nreturn ( ( -B - 6.0 * C ) * ( f * f * f )\n+ ( 6.0 * B + 30.0 * C ) * ( f *f ) +\n( - ( 12.0 * B ) - 48.0 * C ) * f +\n8.0 * B + 24.0 * C ) / 6.0;\n}else{\nreturn 0.0;\n}\n}\n#elif defined( BSPLINE_FILTER )\nfloat filter( float x ){\nfloat f = x;\nif( f < 0.0 ){\nf = -f;\n}\nif( f >= 0.0 && f <= 1.0 ){\nreturn ( 2.0 / 3.0 ) + ( 0.5 ) * ( f * f * f ) - ( f * f );\n}else if( f > 1.0 && f <= 2.0 ){\nreturn 1.0 / 6.0 * pow( ( 2.0 - f ), 3.0 );\n}\nreturn 1.0;\n}\n#else\nfloat filter( float x ){\nreturn 1.0;\n}\n#endif\nvec4 biCubic( sampler2D tex, vec2 texCoord ){\nvec2 texelSize = 1.0 / mapSize;\ntexCoord -= texelSize / 2.0;\nvec4 nSum = vec4( 0.0 );\nfloat nDenom = 0.0;\nvec2 cell = fract( texCoord * mapSize );\nfor( float m = -1.0; m <= 2.0; ++m ){\nfor( float n = -1.0; n <= 2.0; ++n ){\nvec4 vecData = texture2D(\ntex, texCoord + texelSize * vec2( m, n )\n);\nfloat c = filter( m - cell.x ) * filter( -n + cell.y );\nnSum += vecData * c;\nnDenom += c;\n}\n}\nreturn nSum / nDenom;\n}\n#endif\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( CUBIC_INTERPOLATION )\ngl_FragColor = biCubic( map, vUv );\n#else\ngl_FragColor = texture2D( map, vUv );\n#endif\n#if defined( PICKING )\nif( gl_FragColor.a < 0.7 )\ndiscard;\ngl_FragColor = vec4( texture2D( pickingMap, vUv ).xyz, objectId );\n#else\nif( gl_FragColor.a < 0.01 )\ndiscard;\ngl_FragColor.a *= opacity;\n#include fog_fragment\n#endif\n}");var eg=new Uint16Array([0,1,2,1,3,2]),tg=new Float32Array([0,1,0,0,1,1,1,0]),rg=Object.assign({filter:"nearest",forceTransparent:!0},kd),ng=Object.assign({filter:{updateShader:!0,uniform:!0}},Od),ig=function(e){function t(t,r){e.call(this,{position:t.position,index:eg,picking:t.picking},r),this.parameterTypes=ng,this.alwaysTransparent=!0,this.hasWireframe=!1,this.vertexShader="Image.vert",this.fragmentShader="Image.frag";var n=t.imageData,i=t.width,o=t.height,a=new xt(n,i,o);a.flipY=!0,this.tex=a;for(var s=n.length,l=new Uint8Array(s),u=0;u<s;u+=4){var c=u/4;l[u]=c>>16&255,l[u+1]=c>>8&255,l[u+2]=255&c}var h=new xt(l,i,o);h.flipY=!0,h.minFilter=ge,h.magFilter=ge,this.pickingTex=h,this.addUniforms({map:{value:a},pickingMap:{value:h},mapSize:{value:new ht(i,o)}}),this.geometry.addAttribute("uv",new Lr(tg,2))}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return rg},t.prototype.getDefines=function(t){var r=e.prototype.getDefines.call(this,t),n=this.parameters.filter;return n.startsWith("cubic")&&(r.CUBIC_INTERPOLATION=1,n.endsWith("bspline")?r.BSPLINE_FILTER=1:n.endsWith("catmulrom")?r.CATMULROM_FILTER=1:n.endsWith("mitchell")&&(r.MITCHELL_FILTER=1)),r},t.prototype.updateTexture=function(){var e=this.tex,t=this.parameters.filter;t.startsWith("cubic")?(e.minFilter=ge,e.magFilter=ge):"linear"===t?(e.minFilter=be,e.magFilter=be):(e.minFilter=ge,e.magFilter=ge),e.needsUpdate=!0,this.pickingTex.needsUpdate=!0},t.prototype.makeMaterial=function(){e.prototype.makeMaterial.call(this),this.updateTexture();var t=this.material;t.uniforms.map.value=this.tex,t.blending=_,t.needsUpdate=!0;var r=this.wireframeMaterial;r.uniforms.map.value=this.tex,r.blending=_,r.needsUpdate=!0;var n=this.pickingMaterial;n.uniforms.map.value=this.tex,n.uniforms.pickingMap.value=this.pickingTex,n.blending=_,n.needsUpdate=!0},t.prototype.setUniforms=function(t){t&&void 0!==t.filter&&(this.updateTexture(),t.map=this.tex),e.prototype.setUniforms.call(this,t)},Object.defineProperties(t.prototype,r),t}(Fd),og=function(e,t){var r=t||{};this.dimension=Ha(r.dimension,"x"),this.positionType=Ha(r.positionType,"percent"),this.position=Ha(r.position,30),this.thresholdType=Ha(r.thresholdType,"sigma"),this.thresholdMin=Ha(r.thresholdMin,-1/0),this.thresholdMax=Ha(r.thresholdMax,1/0),this.normalize=Ha(r.normalize,!1),this.volume=e};og.prototype.getPositionFromCoordinate=function(e){var t,r=this.dimension,n=this.volume,i=n.matrix,o=(new ft).setFromMatrixPosition(i)[r],a=(new ft).setFromMatrixScale(i)[r];return t="x"===r?n.nx:"y"===r?n.ny:n.nz,Math.round(((e-o)/(t/100)+1)/a)},og.prototype.getData=function(e){e=e||{};var t,r=this.volume,n=r.data,i=r.matrix;function o(e){return Math.round(e/100*(t-1))}function a(e,t,n,i){return 3*(n*r.ny*r.nx+t*r.nx+e)+i}t="coordinate"===this.positionType?this.getPositionFromCoordinate(this.position):this.position;var s,l,u,c,h,p=new Float32Array(12),d=new ft,f=0,m=0,g=0,v=r.nx,y=r.ny,b=r.nz;function w(e,t,r,n){d.set(e,t,r).applyMatrix4(i).toArray(p,n)}"x"===this.dimension?(u=o(r.nx),c=r.ny-1,h=r.nz-1,s=r.nz,l=r.ny,v=(f=u)+1,w(u,0,0,0),w(u,c,0,3),w(u,0,h,6),w(u,c,h,9)):"y"===this.dimension?(u=r.nx-1,c=o(r.ny),h=r.nz-1,s=r.nz,l=r.nx,y=(m=c)+1,w(0,c,0,0),w(u,c,0,3),w(0,c,h,6),w(u,c,h,9)):"z"===this.dimension&&(u=r.nx-1,c=r.ny-1,h=o(r.nz),s=r.nx,l=r.ny,b=(g=h)+1,w(0,0,h,0),w(0,c,h,3),w(u,0,h,6),w(u,c,h,9));var x,_,S=0,C=0,M=new Uint8Array(s*l*4),T=new Float32Array(s*l);"sigma"===this.thresholdType?(x=r.getValueForSigma(this.thresholdMin),_=r.getValueForSigma(this.thresholdMax)):(x=this.thresholdMin,_=this.thresholdMax);var A=Object.assign({},e.colorParams,{volume:r});this.normalize&&(A.domain=[0,1]);var E,P,R,I=Sl.getScheme(A),N=new Float32Array(3),D=I.getScale();if(this.normalize){E=1/0,P=-1/0;for(var k=m;k<y;++k)for(var O=f;O<v;++O)for(var F=g;F<b;++F){var L=n[a(O,k,F,0)/3];L<E&&(E=L),L>P&&(P=L)}R=P-E}for(var U=m;U<y;++U)for(var V=f;V<v;++V)for(var B=g;B<b;++B){var z=a(V,U,B,0)/3,j=n[z];this.normalize&&(j=(j-E)/R),I.colorToArray(D(j),N),M[S]=Math.round(255*N[0]),M[S+1]=Math.round(255*N[1]),M[S+2]=Math.round(255*N[2]),M[S+3]=j>x&&j<_?255:0,T[C]=z,++C,S+=4}var H=new Jp(T,r);return{position:p,imageData:M,width:s,height:l,picking:H}};var ag=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="slice",this.parameters=Object.assign({filter:{type:"select",buffer:!0,options:{nearest:"nearest",linear:"linear","cubic-bspline":"cubic-bspline","cubic-catmulrom":"cubic-catmulrom","cubic-mitchell":"cubic-mitchell"}},positionType:{type:"select",rebuild:!0,options:{percent:"percent",coordinate:"coordinate"}},position:{type:"range",step:.1,max:100,min:1,rebuild:!0},dimension:{type:"select",rebuild:!0,options:{x:"x",y:"y",z:"z"}},thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},normalize:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null,linewidth:null,colorScheme:null,roughness:null,metalness:null,diffuse:null}),this.volume=t,this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=this.volume,n=t||{};n.colorDomain=Ha(n.colorDomain,[r.min,r.max]),n.colorScheme=Ha(n.colorScheme,"value"),n.colorScale=Ha(n.colorScale,"Spectral"),this.colorScheme="value",this.dimension=Ha(n.dimension,"x"),this.filter=Ha(n.filter,"cubic-bspline"),this.positionType=Ha(n.positionType,"percent"),this.position=Ha(n.position,30),this.thresholdType=Ha(n.thresholdType,"sigma"),this.thresholdMin=Ha(n.thresholdMin,-1/0),this.thresholdMax=Ha(n.thresholdMax,1/0),this.normalize=Ha(n.normalize,!1),e.prototype.init.call(this,n),this.build()},t.prototype.attach=function(e){var t=this;this.bufferList.forEach(function(e){t.viewer.add(e)}),this.setVisibility(this.visible),e()},t.prototype.create=function(){var e=new og(this.volume,{positionType:this.positionType,position:this.position,dimension:this.dimension,thresholdType:this.thresholdType,thresholdMin:this.thresholdMin,thresholdMax:this.thresholdMax,normalize:this.normalize}),t=new ig(e.getData({colorParams:this.getColorParams()}),this.getBufferParams({filter:this.filter}));this.bufferList.push(t)},t}(Dc);function sg(e){gl.error("makeRepresentation: representation type "+e+" unknown")}var lg={name:"some element",status:""},ug=function(e,t){void 0===t&&(t={}),this.stage=e,this.signals={statusChanged:new As,nameChanged:new As,disposed:new As},this.parameters=$a(t,this.defaultParameters),this.uuid=vs()},cg={defaultParameters:{configurable:!0},name:{configurable:!0}};cg.defaultParameters.get=function(){return lg},cg.name.get=function(){return this.parameters.name},ug.prototype.setStatus=function(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this},ug.prototype.setName=function(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this},ug.prototype.dispose=function(){this.signals.disposed.dispatch()},Object.defineProperties(ug.prototype,cg);var hg=Object.assign({visible:!0},lg),pg=function(e){function t(t,r,n,i){void 0===n&&(n={}),e.call(this,t,Object.assign({name:r.type},n)),this.parent=i,this.signals=Object.assign({visibilityChanged:new As,parametersChanged:new As},this.signals),this.setRepresentation(r)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0},visible:{configurable:!0},type:{configurable:!0}};return r.defaultParameters.get=function(){return hg},r.visible.get=function(){return this.parameters.visible},r.type.get=function(){return"representation"},t.prototype.getType=function(){return this.repr.type},t.prototype.setRepresentation=function(e){this._disposeRepresentation(),this.repr=e,this.stage.tasks.listen(this.repr.tasks),this.updateVisibility()},t.prototype._disposeRepresentation=function(){this.repr&&(this.stage.tasks.unlisten(this.repr.tasks),this.repr.dispose())},t.prototype.dispose=function(){this.parent&&this.parent.hasRepresentation(this)?this.parent.removeRepresentation(this):(this._disposeRepresentation(),this.signals.disposed.dispatch())},t.prototype.setVisibility=function(e){return this.parameters.visible=e,this.updateVisibility(),this.signals.visibilityChanged.dispatch(this.parameters.visible),this},t.prototype.getVisibility=function(){return this.parent?this.parent.parameters.visible&&this.parameters.visible:this.parameters.visible},t.prototype.toggleVisibility=function(){return this.setVisibility(!this.parameters.visible)},t.prototype.updateVisibility=function(){this.repr.setVisibility(this.getVisibility())},t.prototype.update=function(e){return this.repr.update(e),this},t.prototype.build=function(e){return this.repr.build(e),this},t.prototype.setSelection=function(e){var t=this.repr;return t.setSelection&&t.setSelection(e),this},t.prototype.setParameters=function(e){return this.repr.setParameters(e),this.signals.parametersChanged.dispatch(this.repr.getParameters()),this},t.prototype.getParameters=function(){return this.repr.getParameters()},t.prototype.setColor=function(e){return this.repr.setColor(e),this},Object.defineProperties(t.prototype,r),t}(ug),dg=new pt,fg=new ft,mg={name:"",status:"",visible:!0},gg=function(e,t,r){void 0===r&&(r={}),this.stage=e,this.object=t,this.signals={representationAdded:new As,representationRemoved:new As,visibilityChanged:new As,matrixChanged:new As,statusChanged:new As,nameChanged:new As,disposed:new As},this.reprList=[],this.annotationList=[],this.matrix=new pt,this.position=new ft,this.quaternion=new dt,this.scale=new ft(1,1,1),this.transform=new pt,this.parameters=$a(r,this.defaultParameters),this.uuid=vs(),this.viewer=e.viewer,this.controls=new uf(this)},vg={defaultParameters:{configurable:!0},name:{configurable:!0},status:{configurable:!0},visible:{configurable:!0}};vg.defaultParameters.get=function(){return mg},vg.name.get=function(){return this.parameters.name},vg.status.get=function(){return this.parameters.status},vg.visible.get=function(){return this.parameters.visible},gg.prototype.setPosition=function(e){return Array.isArray(e)?this.position.fromArray(e):this.position.copy(e),this.updateMatrix(),this},gg.prototype.setRotation=function(e){if(Array.isArray(e))if(3===e.length){var t=(new Er).fromArray(e);this.quaternion.setFromEuler(t)}else this.quaternion.fromArray(e);else e instanceof Er?this.quaternion.setFromEuler(e):this.quaternion.copy(e);return this.updateMatrix(),this},gg.prototype.setScale=function(e){return this.scale.set(e,e,e),this.updateMatrix(),this},gg.prototype.setTransform=function(e){return this.transform.copy(e),this.updateMatrix(),this},gg.prototype.updateMatrix=function(){var e=this,t=this.getCenterUntransformed(fg);this.matrix.makeTranslation(-t.x,-t.y,-t.z),dg.makeRotationFromQuaternion(this.quaternion),this.matrix.premultiply(dg),dg.makeScale(this.scale.x,this.scale.y,this.scale.z),this.matrix.premultiply(dg);var r=this.position;dg.makeTranslation(r.x+t.x,r.y+t.y,r.z+t.z),this.matrix.premultiply(dg),this.matrix.premultiply(this.transform),this.reprList.forEach(function(t){t.setParameters({matrix:e.matrix})}),this.stage.viewer.updateBoundingBox(),this.signals.matrixChanged.dispatch(this.matrix)},gg.prototype.addAnnotation=function(e,t,r){var n=new of(this,e,t,r);return this.annotationList.push(n),n},gg.prototype.eachAnnotation=function(e){this.annotationList.slice().forEach(e)},gg.prototype.removeAnnotation=function(e){var t=this.annotationList.indexOf(e);-1!==t&&(this.annotationList.splice(t,1),e.dispose())},gg.prototype.removeAllAnnotations=function(){this.eachAnnotation(function(e){return e.dispose()}),this.annotationList.length=0},gg.prototype._addRepresentation=function(e,t,r,n){void 0===n&&(n=!1);var i=r||{},o=this.stage.getParameters();i.matrix=this.matrix.clone(),i.quality=i.quality||o.quality,i.disableImpostor=Ha(i.disableImpostor,!o.impostor),i.useWorker=Ha(i.useWorker,o.workerDefault),i.visible=Ha(i.visible,!0);var a=Object.assign({},i,{visible:this.parameters.visible&&i.visible}),s=function(e,t,r,n){var i;if(vl&&gl.time("makeRepresentation "+e),t instanceof Pm){if(!(i=Ml.get(e)))return void sg(e)}else if(t instanceof Td)if("surface"===e)i=Gd;else{if("dot"!==e)return void sg(e);i=Qm}else if(t instanceof Pd)if("surface"===e)i=Gd;else if("dot"===e)i=Qm;else{if("slice"!==e)return void sg(e);i=ag}else if(t instanceof km)i=Fm,t=t.getBufferList();else{if("buffer"!==e)return void gl.error("makeRepresentation: object "+t+" unknown");i=Fm}var o=new i(t,r,n);return vl&&gl.timeEnd("makeRepresentation "+e),o}(e,t,this.viewer,a),l=new pg(this.stage,s,i,this);return n||(this.reprList.push(l),this.signals.representationAdded.dispatch(l)),l},gg.prototype.addBufferRepresentation=function(e,t){return this._addRepresentation.call(this,"buffer",e,t)},gg.prototype.hasRepresentation=function(e){return-1!==this.reprList.indexOf(e)},gg.prototype.eachRepresentation=function(e){this.reprList.slice().forEach(e)},gg.prototype.removeRepresentation=function(e){var t=this.reprList.indexOf(e);-1!==t&&(this.reprList.splice(t,1),e.dispose(),this.signals.representationRemoved.dispatch(e))},gg.prototype.updateRepresentations=function(e){this.reprList.forEach(function(t){return t.update(e)}),this.stage.viewer.requestRender()},gg.prototype.removeAllRepresentations=function(){this.eachRepresentation(function(e){return e.dispose()})},gg.prototype.dispose=function(){this.removeAllAnnotations(),this.removeAllRepresentations(),delete this.annotationList,delete this.reprList,this.signals.disposed.dispatch()},gg.prototype.setVisibility=function(e){return this.parameters.visible=e,this.eachRepresentation(function(e){return e.updateVisibility()}),this.eachAnnotation(function(e){return e.updateVisibility()}),this.signals.visibilityChanged.dispatch(e),this},gg.prototype.setStatus=function(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this},gg.prototype.setName=function(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this},gg.prototype.getBox=function(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];return(e=this).getBoxUntransformed.apply(e,t).clone().applyMatrix4(this.matrix)},gg.prototype.getCenter=function(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];return(e=this).getCenterUntransformed.apply(e,t).clone().applyMatrix4(this.matrix)},gg.prototype.getZoom=function(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];return this.stage.getZoomForBox((e=this).getBox.apply(e,t))},gg.prototype.getBoxUntransformed=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return new _r},gg.prototype.getCenterUntransformed=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return this.getBoxUntransformed().getCenter()},gg.prototype.autoView=function(e){this.stage.animationControls.zoomMove(this.getCenter(),this.getZoom(),Ha(e,0))},Object.defineProperties(gg.prototype,vg);var yg=function(e){void 0===e&&(e=[]),this.list=e;for(var t=e.length,r=0;r<t;++r){e[r].signals.disposed.add(this._remove,this)}},bg={first:{configurable:!0}};yg.prototype._remove=function(e){var t=this.list.indexOf(e);-1!==t&&this.list.splice(t,1)},bg.first.get=function(){return this.list.length>0?this.list[0]:void 0},yg.prototype.forEach=function(e){return this.list.forEach(e),this},yg.prototype.dispose=function(){return this.forEach(function(e){return e.dispose()})},Object.defineProperties(yg.prototype,bg);var wg=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setParameters=function(e){return this.forEach(function(t){return t.setParameters(e)})},t.prototype.setVisibility=function(e){return this.forEach(function(t){return t.setVisibility(e)})},t.prototype.setSelection=function(e){return this.forEach(function(t){return t.setSelection(e)})},t.prototype.setColor=function(e){return this.forEach(function(t){return t.setColor(e)})},t.prototype.update=function(e){return this.forEach(function(t){return t.update(e)})},t.prototype.build=function(e){return this.forEach(function(t){return t.build(e)})},t}(yg),xg=Object.assign({defaultStep:1,defaultTimeout:50,defaultInterpolateType:"",defaultInterpolateStep:5,defaultMode:"loop",defaultDirection:"forward",initialFrame:0},lg),_g=function(e){function t(t,r,n){var i=this;void 0===n&&(n={}),e.call(this,t,Object.assign({name:r.name},n)),this.trajectory=r,this.signals=Object.assign(this.signals,{frameChanged:new As,playerChanged:new As,countChanged:new As,parametersChanged:new As}),r.signals.frameChanged.add(function(e){i.signals.frameChanged.dispatch(e)}),r.signals.playerChanged.add(function(e){i.signals.playerChanged.dispatch(e)}),r.signals.countChanged.add(function(e){i.signals.countChanged.dispatch(e)}),void 0!==n.initialFrame&&this.setFrame(n.initialFrame)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0},type:{configurable:!0}};return r.defaultParameters.get=function(){return xg},r.type.get=function(){return"trajectory"},t.prototype.setFrame=function(e){this.trajectory.setFrame(e)},t.prototype.setParameters=function(e){void 0===e&&(e={}),this.trajectory.setParameters(e),this.signals.parametersChanged.dispatch(e)},t.prototype.dispose=function(){this.trajectory.dispose(),e.prototype.dispose.call(this)},Object.defineProperties(t.prototype,r),t}(ug),Sg=function(e,t){this.name=e,this.path=t,this.coordinates=[],this.boxes=[],this.times=[],this.timeOffset=0,this.deltaTime=1},Cg={type:{configurable:!0}};Cg.type.get=function(){return"Frames"},Object.defineProperties(Sg.prototype,Cg);var Mg=function(e,t){var r,n;if(this.A=new nd(3,3),this.W=new nd(1,3),this.U=new nd(3,3),this.V=new nd(3,3),this.VH=new nd(3,3),this.R=new nd(3,3),this.tmp=new nd(3,3),this.c=new nd(3,3),e instanceof Pm)r=e.atomCount;else{if(!(e instanceof Float32Array))return;r=e.length/3}if(t instanceof Pm)n=t.atomCount;else{if(!(t instanceof Float32Array))return;n=t.length/3}var i=Math.min(r,n),o=new nd(3,i),a=new nd(3,i);this.coords1t=new nd(i,3),this.coords2t=new nd(i,3),this.c.data.set([1,0,0,0,1,0,0,0,-1]),this.prepCoords(e,o,i),this.prepCoords(t,a,i),this._superpose(o,a)};Mg.prototype._superpose=function(e,t){this.mean1=sd(e),this.mean2=sd(t),ld(e,this.mean1),ld(t,this.mean2),id(this.coords1t,e),id(this.coords2t,t),od(this.A,this.coords2t,this.coords1t),dd(this.A,this.W,this.U,this.V),function(e,t){var r=e.data,n=t.data,i=r[4],o=r[8],a=r[5],s=r[7],l=r[0],u=l*i,c=l*a,h=r[3],p=r[1],d=h*p,f=r[2],m=h*f,g=r[6],v=g*p,y=g*f,b=1/(u*o-c*s-d*o+m*s+v*a-y*i);n[0]=(i*o-a*s)*b,n[1]=-(p*o-f*s)*b,n[2]=-(-p*a+f*i)*b,n[3]=-(h*o-a*g)*b,n[4]=(l*o-y)*b,n[5]=-(c-m)*b,n[6]=-(-h*s+i*g)*b,n[7]=-(l*s-v)*b,n[8]=(u-d)*b}(this.V,this.VH),ad(this.R,this.U,this.VH),function(e){var t=e.data;return t[0]*t[4]*t[8]-t[0]*t[5]*t[7]-t[3]*t[1]*t[8]+t[3]*t[2]*t[7]+t[6]*t[1]*t[5]-t[6]*t[2]*t[4]}(this.R)<0&&(vl&&gl.log("R not a right handed system"),ad(this.tmp,this.c,this.VH),ad(this.R,this.U,this.tmp))},Mg.prototype.prepCoords=function(e,t,r){var n=0,i=3*r,o=t.data;e instanceof Pm?e.eachAtom(function(e){n<i&&(o[n+0]=e.x,o[n+1]=e.y,o[n+2]=e.z,n+=3)}):e instanceof Float32Array?o.set(e.subarray(0,i)):gl.warn("prepCoords: input type unknown")},Mg.prototype.transform=function(e){var t;if(e instanceof Pm)t=e.atomCount;else{if(!(e instanceof Float32Array))return;t=e.length/3}var r=new nd(3,t),n=new nd(t,3);this.prepCoords(e,r,t),ld(r,this.mean1),od(n,this.R,r),id(r,n),function(e,t){for(var r=e.rows,n=e.cols,i=e.data,o=0,a=0;o<r;++o)for(var s=0;s<n;++s,++a)i[a]+=t[s]}(r,this.mean2);var i=0,o=r.data;e instanceof Pm?e.eachAtom(function(e){e.x=o[i+0],e.y=o[i+1],e.z=o[i+2],i+=3}):e instanceof Float32Array?e.set(o.subarray(0,3*t)):gl.warn("transform: input type unknown")};var Tg={step:1,timeout:50,start:0,end:0,interpolateType:"",interpolateStep:5,mode:"loop",direction:"forward"},Ag=function(e,t){var r=this;void 0===t&&(t={}),this.signals={startedRunning:new As,haltedRunning:new As},this._run=!1,this._previousTime=0,this._currentTime=0,this._currentStep=1,e.signals.playerChanged.add(function(e){e!==r&&r.pause()},this);var n=Ha(e.frameCount,1);this.traj=e,this.parameters=$a(t,Tg),this.parameters.end=Math.min(Ha(t.end,n-1),n-1),this.parameters.step=Ha(t.step,Math.ceil((n+1)/100)),this._currentFrame=this.parameters.start,this._direction="bounce"===this.parameters.direction?"forward":this.parameters.direction,e.signals.countChanged.add(function(e){r.parameters.end=Math.min(Ha(r.parameters.end,e-1),e-1)},this),this._animate=this._animate.bind(this)},Eg={isRunning:{configurable:!0}};Eg.isRunning.get=function(){return this._run},Ag.prototype.setParameters=function(e){void 0===e&&(e={}),Ga(this.parameters,e),void 0!==e.direction&&"bounce"!==this.parameters.direction&&(this._direction=this.parameters.direction)},Ag.prototype._animate=function(){if(this._run){this._currentTime=window.performance.now();var e=this._currentTime-this._previousTime,t=this.parameters.interpolateType?this.parameters.interpolateStep:1,r=this.parameters.timeout/t,n=this.traj;if(n&&n.frameCount&&!n.inProgress&&e>=r)if(this.parameters.interpolateType)if(this._currentStep>this.parameters.interpolateStep&&(this._currentStep=1),1===this._currentStep&&(this._currentFrame=this._nextInterpolated()),n.hasFrame(this._currentFrame)){this._currentStep+=1;var i=this._currentStep/(this.parameters.interpolateStep+1),o=this._currentFrame,a=o[0],s=o[1],l=o[2],u=o[3];n.setFrameInterpolated(a,s,l,u,i,this.parameters.interpolateType),this._previousTime=this._currentTime}else n.loadFrame(this._currentFrame);else{var c=this._next();n.hasFrame(c)?(n.setFrame(c),this._previousTime=this._currentTime):n.loadFrame(c)}window.requestAnimationFrame(this._animate)}},Ag.prototype._next=function(){var e,t=this.parameters;return((e="forward"===this._direction?this.traj.currentFrame+t.step:this.traj.currentFrame-t.step)>t.end||e<t.start)&&("bounce"===t.direction&&("forward"===this._direction?this._direction="backward":this._direction="forward"),"once"===t.mode?(this.pause(),e="forward"===t.direction?t.end:"backward"===t.direction?t.start:"forward"===this._direction?t.start:t.end):"forward"===this._direction?(e=t.start,t.interpolateType&&(e=Math.min(t.end,e+t.step))):(e=t.end,t.interpolateType&&(e=Math.max(t.start,e-t.step)))),e},Ag.prototype._nextInterpolated=function(){var e,t,r,n=this.parameters,i=this._next();return"forward"===this._direction?(e=Math.max(n.start,i-n.step),t=Math.max(n.start,i-2*n.step),r=Math.max(n.start,i-3*n.step)):(e=Math.min(n.end,i+n.step),t=Math.min(n.end,i+2*n.step),r=Math.min(n.end,i+3*n.step)),[i,e,t,r]},Ag.prototype.toggle=function(){this._run?this.pause():this.play()},Ag.prototype.play=function(){if(!this._run){this.traj.player!==this&&this.traj.setPlayer(this),this._currentStep=1;var e=this.parameters,t=this.traj.currentFrame,r=Math.ceil(t/e.step)*e.step;"forward"===e.direction&&t>=e.end?r=e.start:"backward"===e.direction&&t<=e.start&&(r=e.end),this.traj.setFrame(r),this._run=!0,this._animate(),this.signals.startedRunning.dispatch()}},Ag.prototype.pause=function(){this._run=!1,this.signals.haltedRunning.dispatch()},Ag.prototype.stop=function(){this.pause(),this.traj.setFrame(this.parameters.start)},Object.defineProperties(Ag.prototype,Eg);var Pg=function(e,t,r){var n=this;void 0===r&&(r={}),this.signals={countChanged:new As,frameChanged:new As,playerChanged:new As},this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this._frameCount=0,this._currentFrame=-1,this._disposed=!1,this.deltaTime=Ha(r.deltaTime,0),this.timeOffset=Ha(r.timeOffset,0),this.centerPbc=Ha(r.centerPbc,!1),this.removePbc=Ha(r.removePbc,!1),this.removePeriodicity=Ha(r.removePeriodicity,!1),this.superpose=Ha(r.superpose,!1),this.name=e.replace(/^.*[\\/]/,""),this.trajPath=e,this.selection=new el(Ha(r.sele,"backbone and not hydrogen")),this.selection.signals.stringChanged.add(function(){n.selectionIndices=n.structure.getAtomIndices(n.selection),n._resetCache(),n._saveInitialCoords(),n.setFrame(n._currentFrame)})},Rg={frameCount:{configurable:!0},currentFrame:{configurable:!0}};Rg.frameCount.get=function(){return this._frameCount},Rg.currentFrame.get=function(){return this._currentFrame},Pg.prototype._init=function(e){this.setStructure(e),this._loadFrameCount(),this.setPlayer(new Ag(this))},Pg.prototype._loadFrameCount=function(){},Pg.prototype.setStructure=function(e){this.structure=e,this.atomCount=e.atomCount,this.backboneIndices=this._getIndices(new el("backbone and not hydrogen")),this._makeAtomIndices(),this._saveStructureCoords(),this.selectionIndices=this._getIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)},Pg.prototype._saveInitialCoords=function(){var e=this;this.structure.hasCoords()?(this.initialCoords=new Float32Array(this.structureCoords),this._makeSuperposeCoords()):this.frameCache[0]?(this.initialCoords=new Float32Array(this.frameCache[0]),this._makeSuperposeCoords()):this.loadFrame(0,function(){return e._saveInitialCoords()})},Pg.prototype._saveStructureCoords=function(){this.structureCoords=this.structure.getAtomData({what:{position:!0}}).position},Pg.prototype.setSelection=function(e){return this.selection.setString(e),this},Pg.prototype._getIndices=function(e){var t=0,r=e.test,n=[];return r&&this.structure.eachAtom(function(e){r(e)&&n.push(t),t+=1}),n},Pg.prototype._makeSuperposeCoords=function(){var e=3*this.selectionIndices.length;this.coords1=new Float32Array(e),this.coords2=new Float32Array(e);for(var t=this.initialCoords,r=this.coords2,n=0;n<e;n+=3){var i=3*this.selectionIndices[n/3];r[n+0]=t[i+0],r[n+1]=t[i+1],r[n+2]=t[i+2]}},Pg.prototype._makeAtomIndices=function(){gl.error("Trajectory._makeAtomIndices not implemented")},Pg.prototype._resetCache=function(){this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this.initialCoords=new Float32Array(0)},Pg.prototype.setParameters=function(e){void 0===e&&(e={});var t=!1;void 0!==e.centerPbc&&e.centerPbc!==this.centerPbc&&(this.centerPbc=e.centerPbc,t=!0),void 0!==e.removePeriodicity&&e.removePeriodicity!==this.removePeriodicity&&(this.removePeriodicity=e.removePeriodicity,t=!0),void 0!==e.removePbc&&e.removePbc!==this.removePbc&&(this.removePbc=e.removePbc,t=!0),void 0!==e.superpose&&e.superpose!==this.superpose&&(this.superpose=e.superpose,t=!0),this.deltaTime=Ha(e.deltaTime,this.deltaTime),this.timeOffset=Ha(e.timeOffset,this.timeOffset),t&&(this._resetCache(),this.setFrame(this._currentFrame))},Pg.prototype.hasFrame=function(e){var t=this;return Array.isArray(e)?e.every(function(e){return!!t.frameCache[e]}):!!this.frameCache[e]},Pg.prototype.setFrame=function(e,t){var r=this;return void 0===e?this:(this.inProgress=!0,-1===e||this.frameCache[e]?(this._updateStructure(e),t&&t()):this.loadFrame(e,function(){r._updateStructure(e),t&&t()}),this)},Pg.prototype._interpolate=function(e,t,r,n,i,o){var a,s=this.frameCache;a="spline"===o?function(e,t,r,n,i){for(var o=e.length,a=new Float32Array(o),s=0;s<o;s+=3){var l=s+1,u=s+2;a[s]=xs(n[s],r[s],t[s],e[s],i,1),a[l]=xs(n[l],r[l],t[l],e[l],i,1),a[u]=xs(n[u],r[u],t[u],e[u],i,1)}return a}(s[e],s[t],s[r],s[n],i):function(e,t,r){for(var n=e.length,i=new Float32Array(n),o=0;o<n;o+=3){var a=o+1,s=o+2;i[o]=ws(t[o],e[o],r),i[a]=ws(t[a],e[a],r),i[s]=ws(t[s],e[s],r)}return i}(s[e],s[t],i),this.structure.updatePosition(a),this._currentFrame=e,this.signals.frameChanged.dispatch(e)},Pg.prototype.setFrameInterpolated=function(e,t,r,n,i,o,a){var s=this;if(void 0===e)return this;var l=this.frameCache,u=[];return l[n]||u.push(n),l[r]||u.push(r),l[t]||u.push(t),l[e]||u.push(e),u.length?this.loadFrame(u,function(){s._interpolate(e,t,r,n,i,o),a&&a()}):(this._interpolate(e,t,r,n,i,o),a&&a()),this},Pg.prototype.loadFrame=function(e,t){var r=this;Array.isArray(e)?e.forEach(function(e){r.loadQueue[e]||r.frameCache[e]||(r.loadQueue[e]=!0,r._loadFrame(e,function(){delete r.loadQueue[e]}))}):this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,function(){delete r.loadQueue[e],t&&t()}))},Pg.prototype._loadFrame=function(e,t){gl.error("Trajectory._loadFrame not implemented",e,t)},Pg.prototype._updateStructure=function(e){this._disposed?console.error("updateStructure: traj disposed"):(-1===e?this.structureCoords&&this.structure.updatePosition(this.structureCoords):this.structure.updatePosition(this.frameCache[e]),this.structure.trajectory={name:this.trajPath,frame:e},this._currentFrame=e,this.inProgress=!1,this.signals.frameChanged.dispatch(e))},Pg.prototype._doSuperpose=function(e){for(var t=3*this.selectionIndices.length,r=this.coords1,n=this.coords2,i=0;i<t;i+=3){var o=3*this.selectionIndices[i/3];r[i+0]=e[o+0],r[i+1]=e[o+1],r[i+2]=e[o+2]}new Mg(r,n).transform(e)},Pg.prototype._process=function(e,t,r,n){if(this._setFrameCount(n),t){if(this.backboneIndices.length>0&&this.centerPbc){var i=[t[0],t[4],t[8]];!function(e,t,r){if(0!==r[0]&&0!==r[8]&&0!==r[4])for(var n=e.length,i=r[0],o=r[1],a=r[2],s=-t[0]+i+i/2,l=-t[1]+o+o/2,u=-t[2]+a+a/2,c=0;c<n;c+=3)e[c+0]=(e[c+0]+s)%i,e[c+1]=(e[c+1]+l)%o,e[c+2]=(e[c+2]+u)%a}(r,function(e,t,r){return[hu(t,r[0],3,0,e),hu(t,r[1],3,1,e),hu(t,r[2],3,2,e)]}(this.backboneIndices,r,i),i)}if(this.removePeriodicity)!function(e,t,r){if(0!==t[0]&&0!==t[8]&&0!==t[4]){for(var n=e.length,i=3;i<n;i+=3)for(var o=0;o<3;++o){var a=(e[i+o]-r[o])/t[3*o+o];Math.abs(a)>.5&&(e[i+o]-=t[3*o+o]*Math.round(a))}}}(r,t,function(e){return[Cu(e,3,0),Cu(e,3,1),Cu(e,3,2)]}(r));this.removePbc&&function(e,t){if(0!==t[0]&&0!==t[8]&&0!==t[4]){for(var r=e.length,n=3;n<r;n+=3)for(var i=0;i<3;++i){var o=e[n+i]-e[n-3+i];if(Math.abs(o)>.9*t[3*i+i])if(o>0)for(var a=0;a<3;++a)e[n+a]-=t[3*i+a];else for(var s=0;s<3;++s)e[n+s]+=t[3*i+s]}}}(r,t)}this.selectionIndices.length>0&&this.coords1&&this.superpose&&this._doSuperpose(r),this.frameCache[e]=r,this.boxCache[e]=t,this.frameCacheSize+=1},Pg.prototype._setFrameCount=function(e){e!==this._frameCount&&(this._frameCount=e,this.signals.countChanged.dispatch(e))},Pg.prototype.dispose=function(){this._resetCache(),this._disposed=!0,this.player&&this.player.stop()},Pg.prototype.setPlayer=function(e){this.player=e,this.signals.playerChanged.dispatch(e)},Pg.prototype.getFrameTime=function(e){return this.timeOffset+e*this.deltaTime},Object.defineProperties(Pg.prototype,Rg);var Ig=function(e){function t(t,r,n){var i=n||{};i.timeOffset=Ha(i.timeOffset,t.timeOffset),i.deltaTime=Ha(i.deltaTime,t.deltaTime),e.call(this,"",r,i),this.name=t.name,this.path=t.path,this.frames=t.coordinates,this.boxes=t.boxes,this._init(r)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"frames"},t.prototype._makeAtomIndices=function(){"StructureView"===this.structure.type?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0},t.prototype._loadFrame=function(e,t){var r,n=this.frames[e];if(this.atomIndices){var i=this.atomIndices,o=i.length;r=new Float32Array(3*o);for(var a=0;a<o;++a){var s=3*a,l=3*i[a];r[s+0]=n[l+0],r[s+1]=n[l+1],r[s+2]=n[l+2]}}else r=new Float32Array(n);var u=this.boxes[e],c=this.frames.length;this._process(e,u,r,c),"function"==typeof t&&t()},t.prototype._loadFrameCount=function(){this.frames&&this._setFrameCount(this.frames.length)},Object.defineProperties(t.prototype,r),t}(Pg),Ng=function(e){function t(t,r,n){e.call(this,"",r,n),this._init(r)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"structure"},t.prototype._makeAtomIndices=function(){this.structure.atomSet&&this.structure.atomSet.getSize()<this.structure.atomStore.count?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0},t.prototype._loadFrame=function(e,t){var r,n=this.structure,i=n.frames[e];if(this.atomIndices){var o=this.atomIndices,a=o.length;r=new Float32Array(3*a);for(var s=0;s<a;++s){var l=3*s,u=3*o[s];r[l+0]=i[u+0],r[l+1]=i[u+1],r[l+2]=i[u+2]}}else r=new Float32Array(i);var c=n.boxes[e],h=n.frames.length;this._process(e,c,r,h),"function"==typeof t&&t()},t.prototype._loadFrameCount=function(){this._setFrameCount(this.structure.frames.length)},Object.defineProperties(t.prototype,r),t}(Pg),Dg=function(e){function t(t,r,n){e.call(this,t,r,n),this._init(r)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"remote"},t.prototype._makeAtomIndices=function(){var e=[];if("StructureView"===this.structure.type){for(var t=this.structure.getAtomIndices(),r=t.length,n=t[0],i=t[0],o=1;o<r;++o){var a=t[o];i+1<a&&(e.push([n,i+1]),n=a),i=a}e.push([n,i+1])}else e.push([0,this.atomCount]);this.atomIndices=e},t.prototype._loadFrame=function(e,t){var r=this,n=new XMLHttpRequest,i=wl.getFrameUrl(this.trajPath,e),o=wl.getFrameParams(this.trajPath,this.atomIndices);n.open("POST",i,!0),n.responseType="arraybuffer",n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.addEventListener("load",function(){var o=n.response;if(o){var a=new Int32Array(o,0,1)[0],s=new Float32Array(o,8,9),l=new Float32Array(o,44);r._process(e,s,l,a),"function"==typeof t&&t()}else gl.error("empty arrayBuffer for '"+i+"'")},!1),n.send(o)},t.prototype._loadFrameCount=function(){var e=this,t=new XMLHttpRequest,r=wl.getCountUrl(this.trajPath);t.open("GET",r,!0),t.addEventListener("load",function(){e._setFrameCount(parseInt(t.response))},!1),t.send(null)},Object.defineProperties(t.prototype,r),t}(Pg);Pm.prototype.getView=function(e){return new kg(this,e)};var kg=function(e){function t(t,r){e.call(this),this.structure=t,this.selection=r,this.center=new ft,this.boundingBox=new _r,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy(),this.selection&&this.selection.signals.stringChanged.add(this.refresh,this),this.structure.signals.refreshed.add(this.refresh,this),this.refresh()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},name:{configurable:!0},path:{configurable:!0},title:{configurable:!0},id:{configurable:!0},data:{configurable:!0},atomSetDict:{configurable:!0},biomolDict:{configurable:!0},entityList:{configurable:!0},unitcell:{configurable:!0},frames:{configurable:!0},boxes:{configurable:!0},validation:{configurable:!0},bondStore:{configurable:!0},backboneBondStore:{configurable:!0},rungBondStore:{configurable:!0},atomStore:{configurable:!0},residueStore:{configurable:!0},chainStore:{configurable:!0},modelStore:{configurable:!0},atomMap:{configurable:!0},residueMap:{configurable:!0},bondHash:{configurable:!0},spatialHash:{configurable:!0}};return t.prototype.init=function(){},r.type.get=function(){return"StructureView"},r.name.get=function(){return this.structure.name},r.path.get=function(){return this.structure.path},r.title.get=function(){return this.structure.title},r.id.get=function(){return this.structure.id},r.data.get=function(){return this.structure.data},r.atomSetDict.get=function(){return this.structure.atomSetDict},r.biomolDict.get=function(){return this.structure.biomolDict},r.entityList.get=function(){return this.structure.entityList},r.unitcell.get=function(){return this.structure.unitcell},r.frames.get=function(){return this.structure.frames},r.boxes.get=function(){return this.structure.boxes},r.validation.get=function(){return this.structure.validation},r.bondStore.get=function(){return this.structure.bondStore},r.backboneBondStore.get=function(){return this.structure.backboneBondStore},r.rungBondStore.get=function(){return this.structure.rungBondStore},r.atomStore.get=function(){return this.structure.atomStore},r.residueStore.get=function(){return this.structure.residueStore},r.chainStore.get=function(){return this.structure.chainStore},r.modelStore.get=function(){return this.structure.modelStore},r.atomMap.get=function(){return this.structure.atomMap},r.residueMap.get=function(){return this.structure.residueMap},r.bondHash.get=function(){return this.structure.bondHash},r.spatialHash.get=function(){return this.structure.spatialHash},t.prototype.refresh=function(){for(var e in vl&&gl.time("StructureView.refresh"),this.atomSetCache={},this.atomSet=this.getAtomSet(this.selection,!0),this.structure.atomSet&&(this.atomSet=this.atomSet.intersection(this.structure.atomSet)),this.bondSet=this.getBondSet(),this.atomSetDict){var t=this.atomSetDict[e];this.atomSetCache["__"+e]=t.makeIntersection(this.atomSet)}this.atomCount=this.atomSet.getSize(),this.bondCount=this.bondSet.getSize(),this.boundingBox=this.getBoundingBox(),this.center=this.boundingBox.getCenter(),vl&&gl.timeEnd("StructureView.refresh"),this.signals.refreshed.dispatch()},t.prototype.setSelection=function(e){this.selection=e,this.refresh()},t.prototype.getSelection=function(e){var t=[];e&&e.string&&t.push(e.string);var r=this.structure.getSelection();r&&r.string&&t.push(r.string),this.selection&&this.selection.string&&t.push(this.selection.string);var n="";return t.length>0&&(n="( "+t.join(" ) AND ( ")+" )"),new el(n)},t.prototype.getStructure=function(){return this.structure.getStructure()},t.prototype.eachBond=function(e,t){this.structure.eachBond(e,this.getSelection(t))},t.prototype.eachAtom=function(e,t){var r=this.getAtomProxy(),n=this.getAtomSet(t),i=this.atomStore.count;if(n.getSize()<i)n.forEach(function(t){r.index=t,e(r)});else for(var o=0;o<i;++o)r.index=o,e(r)},t.prototype.eachResidue=function(e,t){this.structure.eachResidue(e,this.getSelection(t))},t.prototype.eachResidueN=function(e,t){console.error("StructureView.eachResidueN() not implemented")},t.prototype.eachChain=function(e,t){this.structure.eachChain(e,this.getSelection(t))},t.prototype.eachModel=function(e,t){this.structure.eachModel(e,this.getSelection(t))},t.prototype.getAtomSet=function(e,t){void 0===t&&(t=!1);var r=this.structure.getAtomSet(e);return!t&&this.atomSet&&(r=r.makeIntersection(this.atomSet)),r},t.prototype.getAtomIndices=function(e){return this.structure.getAtomIndices(this.getSelection(e))},t.prototype.refreshPosition=function(){return this.structure.refreshPosition()},t.prototype.dispose=function(){this.selection&&this.selection.signals.stringChanged.remove(this.refresh,this),this.structure.signals.refreshed.remove(this.refresh,this),delete this.structure,delete this.atomSet,delete this.bondSet,delete this.atomCount,delete this.bondCount},Object.defineProperties(t.prototype,r),t}(Pm),Og=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]];function Fg(e,t){var r,n=0,i={};return t.forEach(function(t){r=0;var o={};t.forEach(function(t){o[e[r++]]=t}),i[e[n++]]=o}),i}var Lg={blosum62:Fg("ARNDCQEGHILKMFPSTWYVBZ?",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:Fg("ACDEFGHIKLMNPQRSTVWY",Og)},Ug=function(e,t,r,n,i){void 0===r&&(r=-10),void 0===n&&(n=-1),void 0===i&&(i="blosum62"),this.seq1=e,this.seq2=t,this.gapPenalty=r,this.gapExtensionPenalty=n,i&&(this.substMatrix=Lg[i])};function Vg(e,t,r,n,i){var o,a,s,l,u;if(void 0===r&&(r=!1),void 0===n&&(n=""),void 0===i&&(i=""),r){var c=e,h=t;n&&i&&(c=e.getView(new el(n)),h=t.getView(new el(i)));var p,d,f=c.getSequence(),m=h.getSequence(),g=new Ug(f.join(""),m.join(""));g.calc(),g.trace(),o=0,a=0,s=g.ali1.length;for(var v=[],y=[],b=0;b<s;++b){var w=g.ali1[b],x=g.ali2[b];p=0,d=0,"-"===w?y[a]=!1:(y[a]=!0,p=1),"-"===x?v[o]=!1:(v[o]=!0,d=1),o+=p,a+=d}var _=[],S=[],C=c.getAtomProxy(),M=h.getAtomProxy();o=0,c.eachResidue(function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(v[o]&&(C.index=e.getAtomIndexByName("CA"),_.push(C.x,C.y,C.z)),o+=1)}),o=0,h.eachResidue(function(e){void 0!==e.traceAtomIndex&&e.traceAtomIndex===e.getAtomIndexByName("CA")&&(y[o]&&(M.index=e.getAtomIndexByName("CA"),S.push(M.x,M.y,M.z)),o+=1)}),l=new Float32Array(_),u=new Float32Array(S)}else{l=e.getView(new el(n+" and .CA")),u=t.getView(new el(i+" and .CA"))}new Mg(l,u).transform(e),e.refreshPosition()}Ug.prototype.initMatrices=function(){var e,t;for(this.n=this.seq1.length,this.m=this.seq2.length,this.score=void 0,this.ali="",this.S=[],this.V=[],this.H=[],e=0;e<=this.n;++e)for(this.S[e]=[],this.V[e]=[],this.H[e]=[],t=0;t<=this.m;++t)this.S[e][t]=0,this.V[e][t]=0,this.H[e][t]=0;for(e=0;e<=this.n;++e)this.S[e][0]=this.gap(0),this.H[e][0]=-1/0;for(t=0;t<=this.m;++t)this.S[0][t]=this.gap(0),this.V[0][t]=-1/0;this.S[0][0]=0},Ug.prototype.gap=function(e){return this.gapPenalty+e*this.gapExtensionPenalty},Ug.prototype.makeScoreFn=function(){var e=this.seq1,t=this.seq2,r=this.substMatrix;return r?function(n,i){var o=e[n],a=t[i];try{return r[o][a]}catch(e){return-4}}:(gl.warn("Alignment: no subst matrix"),function(r,n){return e[r]===t[n]?5:-3})},Ug.prototype.calc=function(){vl&&gl.time("Alignment.calc"),this.initMatrices();var e,t,r,n,i,o,a,s=this.gap(0),l=this.makeScoreFn(),u=this.gapExtensionPenalty,c=this.V,h=this.H,p=this.S,d=this.n,f=this.m;for(o=1;o<=d;++o)for(t=p[o-1],e=c[o-1],r=c[o],n=h[o],i=p[o],a=1;a<=f;++a)r[a]=Math.max(t[a]+s,e[a]+u),n[a]=Math.max(i[a-1]+s,n[a-1]+u),i[a]=Math.max(t[a-1]+l(o-1,a-1),r[a],n[a]);vl&&gl.timeEnd("Alignment.calc"),vl&&gl.log(this.S,this.V,this.H)},Ug.prototype.trace=function(){vl&&gl.time("Alignment.trace"),this.ali1="",this.ali2="";var e,t=this.makeScoreFn(),r=this.n,n=this.m;for(this.S[r][n]>=this.V[r][n]?(e="S",this.score=this.S[r][n]):this.V[r][n]>=this.H[r][n]?(e="V",this.score=this.V[r][n]):(e="H",this.score=this.H[r][n]),vl&&gl.log("Alignment: SCORE",this.score),vl&&gl.log("Alignment: S, V, H",this.S[r][n],this.V[r][n],this.H[r][n]);r>0&&n>0;)"S"===e?this.S[r][n]===this.S[r-1][n-1]+t(r-1,n-1)?(this.ali1=this.seq1[r-1]+this.ali1,this.ali2=this.seq2[n-1]+this.ali2,--r,--n,e="S"):this.S[r][n]===this.V[r][n]?e="V":this.S[r][n]===this.H[r][n]?e="H":(--r,--n):"V"===e?this.V[r][n]===this.V[r-1][n]+this.gapExtensionPenalty?(this.ali1=this.seq1[r-1]+this.ali1,this.ali2="-"+this.ali2,--r,e="V"):this.V[r][n]===this.S[r-1][n]+this.gap(0)?(this.ali1=this.seq1[r-1]+this.ali1,this.ali2="-"+this.ali2,--r,e="S"):--r:"H"===e?this.H[r][n]===this.H[r][n-1]+this.gapExtensionPenalty?(this.ali1="-"+this.ali1,this.ali2=this.seq2[n-1]+this.ali2,--n,e="H"):this.H[r][n]===this.S[r][n-1]+this.gap(0)?(this.ali1="-"+this.ali1,this.ali2=this.seq2[n-1]+this.ali2,--n,e="S"):--n:gl.error("Alignment: no matrix");for(;r>0;)this.ali1=this.seq1[r-1]+this.ali1,this.ali2="-"+this.ali2,--r;for(;n>0;)this.ali1="-"+this.ali1,this.ali2=this.seq2[n-1]+this.ali2,--n;vl&&gl.timeEnd("Alignment.trace"),vl&&gl.log([this.ali1,this.ali2])};var Bg=Object.assign({sele:"",defaultAssembly:""},mg),zg=function(e){function t(t,r,n){void 0===n&&(n={}),e.call(this,t,r,Object.assign({name:r.name},n)),this.structure=r,this.trajList=[],this.signals=Object.assign(this.signals,{trajectoryAdded:new As,trajectoryRemoved:new As,defaultAssemblyChanged:new As}),this.initSelection(this.parameters.sele),this.setDefaultAssembly(this.parameters.defaultAssembly),this.pickBuffer=function(e){var t=0,r=0,n=[];return{has:function(e){return-1!==n.indexOf(e)},get:function(e){return n[e]},push:function(i){n[t]=i,t=(e+t+1)%e,++r},get count(){return r},get data(){return n.slice(0,Math.min(r,e))},clear:function(){r=0,t=0,n.length=0}}}(4),this.pickDict=function(){var e={};return{has:function(t){return void 0!==e[JSON.stringify(t)]},add:function(t,r){e[JSON.stringify(t)]=r},del:function(t){delete e[JSON.stringify(t)]},get values(){return Object.keys(e).map(function(t){return e[t]})}}}(),this.spacefillRepresentation=this.addRepresentation("spacefill",{sele:"none",opacity:.6,color:"green",disablePicking:!0,radiusType:"data"},!0);var i={color:"green",labelColor:"grey",labelAttachment:"bottom-center",labelSize:.7,labelZOffset:.5,labelYOffset:.1,labelBorder:!0,labelBorderColor:"lightgrey",labelBorderWidth:.25,lineOpacity:.8,linewidth:5,opacity:.6};this.distanceRepresentation=this.addRepresentation("distance",Object.assign({labelUnit:"angstrom"},i),!0),this.angleRepresentation=this.addRepresentation("angle",Object.assign({arcVisible:!0},i),!0),this.dihedralRepresentation=this.addRepresentation("dihedral",Object.assign({planeVisible:!1},i),!0),this.measureRepresentations=new wg([this.spacefillRepresentation,this.distanceRepresentation,this.angleRepresentation,this.dihedralRepresentation])}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0},type:{configurable:!0}};return r.defaultParameters.get=function(){return Bg},r.type.get=function(){return"structure"},t.prototype.initSelection=function(e){var t=this;this.selection=new el(e),this.structureView=new kg(this.structure,this.selection),this.selection.signals.stringChanged.add(function(){t.structureView.setSelection(t.selection),t.rebuildRepresentations(),t.rebuildTrajectories()})},t.prototype.setSelection=function(e){return this.parameters.sele=e,this.selection.setString(e),this},t.prototype.setDefaultAssembly=function(e){var t=this;this.parameters.defaultAssembly=e,this.reprList.forEach(function(e){e.setParameters({defaultAssembly:t.parameters.defaultAssembly})}),this.signals.defaultAssemblyChanged.dispatch(e)},t.prototype.rebuildRepresentations=function(){this.reprList.forEach(function(e){e.build()}),this.measureRepresentations.build()},t.prototype.rebuildTrajectories=function(){var e=this;this.trajList.forEach(function(t){t.trajectory.setStructure(e.structureView)})},t.prototype.updateRepresentations=function(t){e.prototype.updateRepresentations.call(this,t),this.measureRepresentations.update(t)},t.prototype.addRepresentation=function(e,t,r){var n=this;void 0===t&&(t={}),void 0===r&&(r=!1),t.defaultAssembly=this.parameters.defaultAssembly;var i=this._addRepresentation(e,this.structureView,t,r);return r||i.signals.parametersChanged.add(function(){return n.measureUpdate()}),i},t.prototype.addTrajectory=function(e,t){var r=this;void 0===e&&(e=""),void 0===t&&(t={});var n=function(e,t,r){return e&&e instanceof Sg?new Ig(e,t,r):!e&&t.frames?new Ng(e,t,r):new Dg(e,t,r)}(e,this.structureView,t);n.signals.frameChanged.add(function(){r.updateRepresentations({position:!0})});var i=new _g(this.stage,n,t);return this.trajList.push(i),this.signals.trajectoryAdded.dispatch(i),i},t.prototype.removeTrajectory=function(e){var t=this.trajList.indexOf(e);-1!==t&&this.trajList.splice(t,1),e.dispose(),this.signals.trajectoryRemoved.dispatch(e)},t.prototype.dispose=function(){this.trajList.slice().forEach(function(e){e.dispose()}),this.trajList.length=0,this.structure.dispose(),this.measureRepresentations.dispose(),e.prototype.dispose.call(this)},t.prototype.autoView=function(e,t){"number"==typeof e&&(t=e,e=""),this.stage.animationControls.zoomMove(this.getCenter(e),this.getZoom(e),Ha(t,0))},t.prototype.getBoxUntransformed=function(e){return e?this.structureView.getBoundingBox(new el(e)):this.structureView.boundingBox},t.prototype.getCenterUntransformed=function(e){return e&&"string"==typeof e?this.structure.atomCenter(new el(e)):this.structure.center},t.prototype.superpose=function(e,t,r,n){return Vg(this.structureView,e.structureView,t,r,n),this.updateRepresentations({position:!0}),this},t.prototype.getMaxRepresentationRadius=function(e){var t=0,r=this.structure.getAtomProxy(e);return this.eachRepresentation(function(e){if(e.getVisibility()){var n=e.repr;t=Math.max(n.getAtomRadius(r),t)}}),t},t.prototype.measurePick=function(e){var t=this.pickBuffer.count;if(this.lastPick===e.index&&t>=1){if(t>1){var r=this.pickBuffer.data,n=this.pickBuffer.data.sort();this.pickDict.has(n)?this.pickDict.del(n):this.pickDict.add(n,r),2===t?this.distanceRepresentation.setParameters({atomPair:this.pickDict.values.filter(function(e){return 2===e.length})}):3===t?this.angleRepresentation.setParameters({atomTriple:this.pickDict.values.filter(function(e){return 3===e.length})}):4===t&&this.dihedralRepresentation.setParameters({atomQuad:this.pickDict.values.filter(function(e){return 4===e.length})})}this.pickBuffer.clear(),this.lastPick=void 0}else this.pickBuffer.has(e.index)||this.pickBuffer.push(e.index),this.lastPick=e.index;this.measureUpdate()},t.prototype.measureClear=function(){this.pickBuffer.clear(),this.lastPick=void 0,this.spacefillRepresentation.setSelection("none")},t.prototype.measureBuild=function(){var e=this.measureData();this.distanceRepresentation.setParameters({atomPair:e.distance}),this.angleRepresentation.setParameters({atomTriple:e.angle}),this.dihedralRepresentation.setParameters({atomQuad:e.dihedral})},t.prototype.measureUpdate=function(){var e=this,t={};this.pickBuffer.data.forEach(function(r){var n=Math.max(.1,e.getMaxRepresentationRadius(r));t[r]=n*(2.3-_s(.1,2,n))}),this.spacefillRepresentation.setSelection("@"+this.pickBuffer.data.join(",")),this.spacefillRepresentation.setParameters({radiusData:t})},t.prototype.measureData=function(){var e=this.pickDict.values;return{distance:e.filter(function(e){return 2===e.length}),angle:e.filter(function(e){return 3===e.length}),dihedral:e.filter(function(e){return 4===e.length})}},t.prototype.removeAllMeasurements=function(e){var t=this.pickDict,r=t.values,n=function(e){r.filter(function(t){return t.length===e}).forEach(function(e){return t.del(e.slice().sort())})};(!e||1&e)&&n(2),(!e||2&e)&&n(3),(!e||4&e)&&n(4),this.measureBuild()},t.prototype.removeMeasurement=function(e){this.pickDict.del(e.slice().sort()),this.measureBuild()},t.prototype.addMeasurement=function(e){if(!(e.length<2||e.length>4)){var t=e.slice().sort();this.pickDict.has(t)||this.pickDict.add(t,e),this.measureBuild()}},Object.defineProperties(t.prototype,r),t}(gg);Pl.add("structure",zg),Pl.add("structureview",zg);var jg=function(e){function t(t,r,n){void 0===n&&(n={}),e.call(this,t,r,Object.assign({name:r.name},n)),this.surface=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"surface"},t.prototype.addRepresentation=function(e,t){return void 0===t&&(t={}),this._addRepresentation(e,this.surface,t)},t.prototype.getBoxUntransformed=function(){return this.surface.boundingBox},t.prototype.getCenterUntransformed=function(){return this.surface.center},t.prototype.dispose=function(){this.surface.dispose(),e.prototype.dispose.call(this)},Object.defineProperties(t.prototype,r),t}(gg);Pl.add("surface",jg);var Hg=function(e){function t(t,r,n){void 0===n&&(n={}),e.call(this,t,r,Object.assign({name:r.name},n)),this.volume=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"volume"},t.prototype.addRepresentation=function(e,t){return void 0===t&&(t={}),this._addRepresentation(e,this.volume,t)},t.prototype.getBoxUntransformed=function(){return this.volume.boundingBox},t.prototype.getCenterUntransformed=function(){return this.volume.center},t.prototype.dispose=function(){this.volume.dispose(),e.prototype.dispose.call(this)},Object.defineProperties(t.prototype,r),t}(gg);Pl.add("volume",Hg);var $g=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.addRepresentation=function(e,t){return this.forEach(function(r){return r.addRepresentation(e,t)})},t.prototype.autoView=function(e){return this.forEach(function(t){return t.autoView(e)})},t}(yg);function Gg(e,t){return e instanceof RegExp?null!==t.name.match(e):t.name===e}var Wg=new ft,qg={impostor:!0,quality:"medium",workerDefault:!0,sampleLevel:0,backgroundColor:"black",rotateSpeed:2,zoomSpeed:1.2,panSpeed:1,clipNear:0,clipFar:100,clipDist:10,fogNear:50,fogFar:100,cameraFov:40,cameraType:"perspective",lightColor:14540253,lightIntensity:1,ambientColor:14540253,ambientIntensity:.2,hoverTimeout:0,tooltip:!0,mousePreset:"default"},Xg=function(e,t){void 0===t&&(t={}),this.signals={parametersChanged:new As,fullscreenChanged:new As,componentAdded:new As,componentRemoved:new As,clicked:new As,hovered:new As},this.tasks=new Zl,this.compList=[],this.defaultFileParams={},this.logList=[],this.viewer=new Hu(e),this.viewer.renderer&&(this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{display:"none",position:"fixed",zIndex:2+parseInt(this.viewer.container.style.zIndex||"0"),pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),document.body.appendChild(this.tooltip),this.mouseObserver=new Xu(this.viewer.renderer.domElement),this.viewerControls=new vc(this),this.trackballControls=new ic(this),this.pickingControls=new lc(this),this.animationControls=new Rc(this),this.mouseControls=new Kd(this),this.keyControls=new Jd(this),this.pickingBehavior=new Qd(this),this.mouseBehavior=new ef(this),this.animationBehavior=new tf(this),this.keyBehavior=new nf(this),this.spinAnimation=this.animationControls.spin([0,1,0],.005),this.spinAnimation.pause(!0),this.rockAnimation=this.animationControls.rock([0,1,0],.005),this.rockAnimation.pause(!0),this.parameters=$a(t,qg),this.setParameters(this.parameters),this.viewer.animate())};Xg.prototype.setParameters=function(e){void 0===e&&(e={}),Ga(this.parameters,e);var t=e,r=this.parameters,n=this.viewer,i=this.trackballControls;return void 0!==t.quality&&this.setQuality(r.quality),void 0!==t.impostor&&this.setImpostor(r.impostor),void 0!==t.rotateSpeed&&(i.rotateSpeed=r.rotateSpeed),void 0!==t.zoomSpeed&&(i.zoomSpeed=r.zoomSpeed),void 0!==t.panSpeed&&(i.panSpeed=r.panSpeed),void 0!==t.mousePreset&&this.mouseControls.preset(r.mousePreset),this.mouseObserver.setParameters({hoverTimeout:r.hoverTimeout}),n.setClip(r.clipNear,r.clipFar,r.clipDist),n.setFog(void 0,r.fogNear,r.fogFar),n.setCamera(r.cameraType,r.cameraFov),n.setSampling(r.sampleLevel),n.setBackground(r.backgroundColor),n.setLight(r.lightColor,r.lightIntensity,r.ambientColor,r.ambientIntensity),this.signals.parametersChanged.dispatch(this.getParameters()),this},Xg.prototype.log=function(e){console.log("STAGE LOG",e),this.logList.push(e)},Xg.prototype.getParameters=function(){return Object.assign({},this.parameters)},Xg.prototype.defaultFileRepresentation=function(e){if(e instanceof zg){var t,r,n;e.setSelection("/0");var i=e.structure;if(i.biomolDict.BU1){var o=i.biomolDict.BU1;t=o.getAtomCount(i),r=o.getResidueCount(i),n=o.getInstanceCount(),e.setDefaultAssembly("BU1")}else t=i.getModelProxy(0).atomCount,r=i.getModelProxy(0).residueCount,n=1;var a=t;dl&&(a*=4);var s=i.atomStore.count/i.residueStore.count<2;s&&(a*=10);var l="chainname",u="RdYlBu",c=!1;if(1===i.getChainnameCount(new el("polymer and /0"))&&(l="residueindex",u="spectral",c=!0),vl&&console.log(a,t,n,s),r/n<4)e.addRepresentation("ball+stick",{colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"});else if(n>5&&a>15e3||a>7e5){var h=Math.min(1.5,Math.max(.1,2e3/(a/n)));s&&(h=Math.min(h,.15)),e.addRepresentation("surface",{colorScheme:l,colorScale:u,colorReverse:c,sele:"polymer",surfaceType:"sas",probeRadius:1.4,scaleFactor:h,useWorker:!1})}else a>25e4?e.addRepresentation("backbone",{colorScheme:l,colorScale:u,colorReverse:c,lineOnly:!0}):a>1e5?e.addRepresentation("backbone",{colorScheme:l,colorScale:u,colorReverse:c,quality:"low",disableImpostor:!0,radiusScale:2}):a>8e4?e.addRepresentation("backbone",{colorScheme:l,colorScale:u,colorReverse:c,radiusScale:2}):(e.addRepresentation("cartoon",{colorScheme:l,colorScale:u,colorReverse:c,radiusScale:.7,aspectRatio:5,quality:"auto"}),a<5e4&&e.addRepresentation("base",{colorScheme:l,colorScale:u,colorReverse:c,quality:"auto"}),e.addRepresentation("ball+stick",{sele:"ligand",colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"}));e.structure.frames.length&&e.addTrajectory()}else e instanceof jg?e.addRepresentation("surface"):e instanceof Hg&&e.addRepresentation("surface");this.tasks.onZeroOnce(this.autoView,this)},Xg.prototype.loadFile=function(e,t){var r=this;void 0===t&&(t={});var n=Object.assign({},this.defaultFileParams,t),i=zl(e).name;this.tasks.increment(),this.log("loading file '"+i+"'");var o=Ha(n.ext,zl(e).ext);return(Tl.isTrajectory(o)?Promise.reject(new Error("loadFile: ext '"+o+"' is a trajectory and must be loaded into a structure component")):Hl(e,n)).then(function(e){r.log("loaded '"+i+"'");var t=r.addComponentFromObject(e,n);return n.defaultRepresentation&&r.defaultFileRepresentation(t),r.tasks.decrement(),t},function(e){r.tasks.decrement();var t="error loading file: '"+e+"'";throw r.log(t),t})},Xg.prototype.loadScript=function(e){var t=this,r=zl(e).name;return this.log("loading script '"+r+"'"),Hl(e).then(function(e){t.tasks.increment(),t.log("running script '"+r+"'"),e.run(t).then(function(){t.tasks.decrement(),t.log("finished script '"+r+"'")}),t.log("called script '"+r+"'")},function(e){t.tasks.decrement();var n="errored script '"+r+"' \""+e+'"';throw t.log(n),n})},Xg.prototype.addComponent=function(e){e?(this.compList.push(e),this.signals.componentAdded.dispatch(e)):gl.warn("Stage.addComponent: no component given")},Xg.prototype.addComponentFromObject=function(e,t){void 0===t&&(t={});var r=Pl.get(e.type);if(r){var n=new r(this,e,t);return this.addComponent(n),n}gl.warn("no component for object type",e.type)},Xg.prototype.removeComponent=function(e){var t=this.compList.indexOf(e);-1!==t&&(this.compList.splice(t,1),e.dispose(),this.signals.componentRemoved.dispatch(e))},Xg.prototype.removeAllComponents=function(){var e=this;this.compList.slice().forEach(function(t){return e.removeComponent(t)})},Xg.prototype.handleResize=function(){this.viewer.handleResize()},Xg.prototype.setSize=function(e,t){var r=this.viewer.container;r!==document.body&&(void 0!==e&&(r.style.width=e),void 0!==t&&(r.style.height=t),this.handleResize())},Xg.prototype.toggleFullscreen=function(e){if(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled){var t=this;e=e||this.viewer.container,this.lastFullscreenElement=e,r()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():(e.dataset.normalWidth=e.style.width||"",e.dataset.normalHeight=e.style.height||"",e.style.width=window.screen.width+"px",e.style.height=window.screen.height+"px",e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",n),document.addEventListener("mozfullscreenchange",n),document.addEventListener("webkitfullscreenchange",n),document.addEventListener("MSFullscreenChange",n),this.handleResize(),this.signals.fullscreenChanged.dispatch(!0),setTimeout(function(){t.handleResize()},100))}else gl.log("fullscreen mode (currently) not possible");function r(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function n(){if(!r()&&t.lastFullscreenElement){var e=t.lastFullscreenElement;e.style.width=e.dataset.normalWidth||"",e.style.height=e.dataset.normalHeight||"",document.removeEventListener("fullscreenchange",n),document.removeEventListener("mozfullscreenchange",n),document.removeEventListener("webkitfullscreenchange",n),document.removeEventListener("MSFullscreenChange",n),t.handleResize(),t.signals.fullscreenChanged.dispatch(!1)}}},Xg.prototype.setSpin=function(e){e?(this.spinAnimation.resume(!0),this.rockAnimation.pause(!0)):this.spinAnimation.pause(!0)},Xg.prototype.setRock=function(e){e?(this.rockAnimation.resume(!0),this.spinAnimation.pause(!0)):this.rockAnimation.pause(!0)},Xg.prototype.toggleSpin=function(){this.setSpin(this.spinAnimation.paused)},Xg.prototype.toggleRock=function(){this.setRock(this.rockAnimation.paused)},Xg.prototype.setFocus=function(e){var t=ys(e/2,0,49.9),r=100-t,n=(r-t)/2;this.setParameters({clipNear:t,clipFar:r,fogNear:bs(r-n),fogFar:bs(r+n)})},Xg.prototype.getZoomForBox=function(e){var t=e.getSize(Wg),r=Math.max(t.x,t.y,t.z),n=Math.min(t.x,t.y,t.z),i=r+Math.sqrt(n),o=fs(this.viewer.perspectiveCamera.fov),a=this.viewer.width,s=this.viewer.height,l=s<a?1:a/s;return i=Math.abs(.5*i/l/Math.sin(o/2)),-(i+=this.parameters.clipDist)},Xg.prototype.getBox=function(){return this.viewer.boundingBox},Xg.prototype.getZoom=function(){return this.getZoomForBox(this.getBox())},Xg.prototype.getCenter=function(e){return this.getBox().getCenter(e)},Xg.prototype.autoView=function(e){this.animationControls.zoomMove(this.getCenter(),this.getZoom(),Ha(e,0))},Xg.prototype.makeImage=function(e){var t=this;return void 0===e&&(e={}),new Promise(function(r,n){t.tasks.onZeroOnce(function(){t.tasks.increment(),t.viewer.makeImage(e).then(function(e){t.tasks.decrement(),r(e)}).catch(function(e){t.tasks.decrement(),n(e)})})})},Xg.prototype.setImpostor=function(e){this.parameters.impostor=e;var t=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(r){if(t.includes(r.getType())){var n=r.getParameters();n.disableImpostor=!e,r.build(n)}})},Xg.prototype.setQuality=function(e){this.parameters.quality=e;var t=["tube","cartoon","ribbon","trace","rope"],r=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(n){var i=n.getParameters();if(!t.includes(n.getType())){if(!r.includes(n.getType()))return;if(!i.disableImpostor)return void(n.repr.quality=e)}i.quality=e,n.build(i)})},Xg.prototype.eachComponent=function(e,t){this.compList.slice().forEach(function(r){void 0!==t&&t!==r.type||e(r)})},Xg.prototype.eachRepresentation=function(e,t){this.eachComponent(function(r){r.reprList.slice().forEach(function(n){void 0!==t&&t!==n.getType()||e(n,r)})})},Xg.prototype.getComponentsByName=function(e){var t=[];return this.eachComponent(function(r){(void 0===e||Gg(e,r))&&t.push(r)}),new $g(t)},Xg.prototype.getComponentsByObject=function(e){var t=[];return this.eachComponent(function(r){r.object===e&&t.push(r)}),new $g(t)},Xg.prototype.getRepresentationsByName=function(e){var t=[];return this.eachRepresentation(function(r,n){(void 0===e||Gg(e,r))&&t.push(r)}),new wg(t)},Xg.prototype.measureClear=function(){this.eachComponent(function(e){return e.measureClear()},"structure")},Xg.prototype.measureUpdate=function(){this.eachComponent(function(e){return e.measureUpdate()},"structure")},Xg.prototype.dispose=function(){this.tasks.dispose()};var Kg=function(e){function t(t){var r=this;e.call(this,t),t.scale||(this.parameters.scale="rainbow",this.parameters.reverse=Ha(t.reverse,!0)),this.scalePerModel={},t.structure.eachModel(function(e){r.parameters.domain=[e.atomOffset,e.atomEnd],r.scalePerModel[e.index]=r.getScale()})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.scalePerModel[e.modelIndex](e.index)},t}(Ts);Sl.add("atomindex",Kg);var Yg=function(e){function t(t){if(e.call(this,t),t.scale||(this.parameters.scale="OrRd"),!t.domain){var r,n=1/0,i=-1/0;t.sele&&(r=new el(t.sele)),t.structure.eachAtom(function(e){var t=e.bfactor;n=Math.min(n,t),i=Math.max(i,t)},r),this.parameters.domain=[n,i]}this.bfactorScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.bfactorScale(e.bfactor)},t}(Ts);Sl.add("bfactor",Yg);var Zg=function(e){function t(t){var r=this;e.call(this,t),this.chainidDictPerModel={},this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(e){var t=0,n={};e.eachChain(function(e){void 0===n[e.chainid]&&(n[e.chainid]=t,t+=1)}),r.parameters.domain=[0,t-1],r.chainidDictPerModel[e.index]=n,r.scalePerModel[e.index]=r.getScale()})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=this.chainidDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainid])},t}(Ts);Sl.add("chainid",Zg);var Jg=function(e){function t(t){var r=this;e.call(this,t),this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(e){r.parameters.domain=[e.chainOffset,e.chainEnd],r.scalePerModel[e.index]=r.getScale()})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.scalePerModel[e.modelIndex](e.chainIndex)},t}(Ts);Sl.add("chainindex",Jg);var Qg=function(e){function t(t){var r=this;e.call(this,t),this.chainnameDictPerModel={},this.scalePerModel={},t.scale||(this.parameters.scale="Spectral"),t.structure.eachModel(function(e){var t=0,n={};e.eachChain(function(e){void 0===n[e.chainname]&&(n[e.chainname]=t,t+=1)}),r.parameters.domain=[0,t-1],r.chainnameDictPerModel[e.index]=n,r.scalePerModel[e.index]=r.getScale()})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=this.chainnameDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](t[e.chainname])},t}(Ts);Sl.add("chainname",Qg);var ev=function(e){function t(t){e.call(this,t),this.rsrzDict={},this.rsccDict={},t.scale||(this.parameters.scale="RdYlBu"),this.rsrzScale=this.getScale({domain:[2,0]}),this.rsccScale=this.getScale({domain:[.678,1]});var r=t.structure.validation;r&&(this.rsrzDict=r.rsrzDict,this.rsccDict=r.rsccDict)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=e.resno+"";e.inscode&&(t+="^"+e.inscode),e.chainname&&(t+=":"+e.chainname),t+="/"+e.modelIndex;var r=this.rsrzDict[t];if(void 0!==r)return this.rsrzScale(r);var n=this.rsccDict[t];return void 0!==n?this.rsccScale(n):9474192},t}(Ts);Sl.add("densityfit",ev);var tv={ARG:{CD:.1,CZ:.5,NE:-.1},ASN:{CG:.55,OD1:-.55},ASP:{CB:-.16,CG:.36,OD1:-.6,OD2:-.6},CYS:{CB:.19,SG:-.19},GLN:{CD:.55,OE1:-.55},GLU:{CD:.36,CG:-.16,OE1:-.6,OE2:-.6},HIS:{CB:.1,CD2:.2,CE1:.45,CG:.15,ND1:.05,NE2:.05},LYS:{CE:.25,NZ:.75},MET:{CE:.06,CG:.06,SD:-.12},PTR:{C:.55,CA:.1,CZ:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SEP:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SER:{CB:.25,OG:-.25},THR:{CB:.25,OG1:-.25},TPO:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,OG1:-1.1,O1P:-.85,O2P:-.85,O3P:-.85,P:1.4},TRP:{CD1:.06,CD2:.1,CE2:-.04,CE3:-.03,CG:-.03,NE1:-.06},TYR:{CZ:.25,OH:-.25},backbone:{C:.55,O:-.55,N:-.35,CA:.1}},rv=1.04,nv=.25;var iv=function(e){function t(t){var r=this;e.call(this,t),this.delta=new ft,this.hCharges=[],t.scale||(this.parameters.scale="rwb"),t.domain||(this.parameters.domain=[-.5,0,.5]),this.scale=this.getScale(),this.charges=new Float32Array(t.structure.atomCount);var n=[];t.structure.eachAtom(function(e){if(r.charges[e.index]=function(e){return e.isProtein()&&(tv[e.resname]&&tv[e.resname][e.atomname]||tv.backbone[e.atomname])||0}(e)*e.occupancy,"N"===e.atomname){var t=function(e,t){void 0===t&&(t=new ft);var r=!1,n=!1,i=!1;return t.set(2*e.x,2*e.y,2*e.z),e.eachBondedAtom(function(e){if(!r)return"H"===e.atomname?(t.set(e.x,e.y,e.z),void(r=!0)):void(n||"CA"!==e.atomname?i||"C"!==e.atomname||(i=!0,t.sub(e)):(t.sub(e),n=!0))}),r?t:n&&i?(t.normalize(),t.multiplyScalar(rv),t.add(e),t):void 0}(e);void 0!==t&&(n.push(t),r.hCharges.push(nv*e.occupancy))}});var i=t.structure.getBoundingBox();i.expandByScalar(rv),this.hStore=function(e){for(var t=e.length,r=new Float32Array(t),n=new Float32Array(t),i=new Float32Array(t),o=0;o<e.length;o++){var a=e[o];r[o]=a.x,n[o]=a.y,i[o]=a.z}return{x:r,y:n,z:i,count:t}}(n),this.hHash=new vh(this.hStore,i),this.hash=new vh(t.structure.atomStore,i)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.positionColor=function(e){for(var t=0,r=this.hash.within(e.x,e.y,e.z,12),n=0;n<r.length;n++){var i=r[n],o=this.charges[i];if(0!==o){this.atomProxy.index=i,this.delta.x=e.x-this.atomProxy.x,this.delta.y=e.y-this.atomProxy.y,this.delta.z=e.z-this.atomProxy.z;var a=this.delta.lengthSq();a<144&&(t+=o/a)}}for(var s=this.hHash.within(e.x,e.y,e.z,12),l=0;l<s.length;l++){var u=s[l];this.delta.x=e.x-this.hStore.x[u],this.delta.y=e.y-this.hStore.y[u],this.delta.z=e.z-this.hStore.z[u];var c=this.delta.lengthSq();c<144&&(t+=this.hCharges[u]/c)}return this.scale(t)},t}(Ts);Sl.add("electrostatic",iv);var ov={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120},av=function(e){function t(t){t.value=Ha(t.value,ov.C),e.call(this,t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=e.element;return"C"===t?this.parameters.value:ov[t]||16777215},t}(Ts);Sl.add("element",av);var sv=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="Spectral"),t.domain||(this.parameters.domain=[0,t.structure.entityList.length-1]),this.entityindexScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.entityindexScale(e.entityIndex)},t}(Ts);Sl.add("entityindex",sv);var lv=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=e.entity;switch(t?t.entityType:void 0){case Ah:return 8374655;case Eh:return 16629894;case Ph:return 12496596;case Rh:return 3697840;default:return 16777113}},t}(Ts);Sl.add("entitytype",lv);var uv=function(e){function t(t){e.call(this,t),this.geoAtomDict={},this.geoDict={};var r=t.structure.validation;r&&(this.geoAtomDict=r.geoAtomDict,this.geoDict=r.geoDict)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t,r=e.resno+"";e.inscode&&(r+="^"+e.inscode),e.chainname&&(r+=":"+e.chainname),r+="/"+e.modelIndex;var n=this.geoAtomDict[r];void 0!==n?t=function(e){return 16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24}(n[e.atomname]||0):t=this.geoDict[r]||0;return 0===t?2188972:1===t?16703627:2===t?16018755:t>=3?10813478:9474192},t}(Ts);Sl.add("geoquality",uv);var cv=function(e){function t(t){e.call(this,t),this.resHF={},t.scale||(this.parameters.scale="RdYlGn");for(var r in Gh)this.resHF[r]=Gh[r][0];if(this.defaultResidueHydrophobicity=Wh[0],!t.domain){var n=1/0,i=-1/0;for(var o in this.resHF){var a=this.resHF[o];n=Math.min(n,a),i=Math.max(i,a)}this.parameters.domain=[n,0,i]}this.hfScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.hfScale(this.resHF[e.resname]||this.defaultResidueHydrophobicity)},t}(Ts);Sl.add("hydrophobicity",cv);var hv=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="rainbow"),t.domain||(this.parameters.domain=[0,t.structure.modelStore.count]),this.modelindexScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.modelindexScale(e.modelIndex)},t}(Ts);Sl.add("modelindex",hv);var pv=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){switch(e.residueType.moleculeType){case 1:return 3697840;case 2:return 15729279;case 3:return 12496596;case 4:return 16629894;case 5:return 12540695;case 6:return 8374655;default:return 16777113}},t}(Ts);Sl.add("moleculetype",pv);var dv=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="PuBu"),t.domain||(this.parameters.domain=[0,1]),this.occupancyScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.occupancyScale(e.occupancy)},t}(Ts);Sl.add("occupancy",dv);var fv=function(e){function t(t){e.call(this,t),t.scale||(this.parameters.scale="rwb"),t.domain||(this.parameters.domain=[-1,1]),this.partialchargeScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.partialchargeScale(e.partialCharge||0)},t}(Ts);function mv(){return 16777215*Math.random()}Sl.add("partialcharge",fv);var gv=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(){return mv()},t.prototype.volumeColor=function(){return mv()},t.prototype.positionColor=function(){return mv()},t}(Ts);Sl.add("random",gv);var vv=function(e){function t(t){var r=this;e.call(this,t),this.scalePerChain={},t.scale||(this.parameters.scale="rainbow",this.parameters.reverse=Ha(t.reverse,!0)),t.structure.eachChain(function(e){r.parameters.domain=[e.residueOffset,e.residueEnd],r.scalePerChain[e.index]=r.getScale()})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return this.scalePerChain[e.chainIndex](e.residueIndex)},t}(Ts);Sl.add("residueindex",vv);var yv={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:10526975,G:16740464,I:8454143,C:16747595,T:10551200,U:16744576,DA:10526975,DG:16740464,DI:8454143,DC:16747595,DT:10551200,DU:16744576},bv=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){return yv[e.resname]||16711935},t}(Ts);Sl.add("resname",bv);var wv=16711808,xv=10485888,_v=6291584,Sv=16762880,Cv=6324479,Mv=16777215,Tv=11403518,Av=16580962,Ev=10921722,Pv=function(e){function t(t){e.call(this,t),this.residueProxy=t.structure.getResidueProxy()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(e){var t=e.sstruc,r=this.residueProxy;return"h"===t?wv:"g"===t?xv:"i"===t?_v:"e"===t||"b"===t?Sv:"t"===t?Cv:(r.index=e.residueIndex,r.isDna()?Tv:r.isRna()?Av:r.isSaccharide()?Ev:r.isProtein()||"s"===t||"l"===t?Mv:8421504)},t}(Ts);Sl.add("sstruc",Pv);var Rv=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.atomColor=function(){return this.parameters.value},t.prototype.bondColor=function(){return this.parameters.value},t.prototype.valueColor=function(){return this.parameters.value},t.prototype.volumeColor=function(){return this.parameters.value},t}(Ts);Sl.add("uniform",Rv);var Iv=function(e){function t(t){e.call(this,t),this.valueScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.volumeColor=function(e){return this.valueScale(this.parameters.volume.data[e])},t}(Ts);Sl.add("value",Iv);var Nv=function(e){function t(t){e.call(this,t),this.vec=new ft,this.valueScale=this.getScale()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.positionColor=function(e){var t=this.parameters.volume;if(!t||!t.inverseMatrix)return this.parameters.value;var r=this.vec,n=t.data,i=t.nx,o=t.ny,a=i*o;r.copy(e),r.applyMatrix4(t.inverseMatrix);var s=Math.floor(r.x),l=Math.floor(r.y),u=Math.floor(r.z),c=(u*o+l)*i+s,h=c+1,p=c+i,d=c+a,f=p+1,m=d+1,g=p+a,v=g+1,y=n[c],b=n[h],w=n[p],x=n[d],_=n[f],S=n[m],C=n[g],M=n[v],T=r.x-s,A=r.y-l,E=r.z-u,P=ws(y,b,T),R=ws(x,S,T),I=ws(w,_,T),N=ws(C,M,T),D=ws(ws(P,I,A),ws(R,N,A),E);return this.valueScale(D)},t}(Ts);Sl.add("volume",Nv);var Dv=function(e){function t(t,r,n){void 0===n&&(n={}),e.call(this,t,r,Object.assign({name:r.name},n)),this.shape=r}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"shape"},t.prototype.addRepresentation=function(e,t){return void 0===t&&(t={}),this._addRepresentation(e,this.shape,t)},t.prototype.getBoxUntransformed=function(){return this.shape.boundingBox},t.prototype.getCenterUntransformed=function(){return this.shape.center},t.prototype.dispose=function(){this.shape.dispose(),e.prototype.dispose.call(this)},Object.defineProperties(t.prototype,r),t}(gg);Pl.add("shape",Dv);var kv=function(e){function t(t,r,n){var i=n||{};if(e.call(this,t,r,i),this.type="structure",this.parameters=Object.assign({radiusType:{type:"select",options:pf.types},radiusData:{type:"hidden",rebuild:!0},radiusSize:{type:"number",precision:3,max:10,min:.001},radiusScale:{type:"number",precision:3,max:10,min:.001},assembly:null,defaultAssembly:{type:"hidden"}},this.parameters),this.selection=new el(i.sele),this.dataList=[],this.structure=t,this.structureView=this.structure.getView(this.selection),t.biomolDict){var o={default:"default","":t.unitcell?"AU":"FULL"};Object.keys(t.biomolDict).forEach(function(e){o[e]=e}),this.parameters.assembly={type:"select",options:o,rebuild:!0}}else this.parameters.assembly=null}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultScale:{configurable:!0}};return r.defaultScale.get=function(){return{vdw:1,covalent:1,bfactor:.01,sstruc:1}},t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"element"),this.setRadius(r.radius,r),this.radiusType=Ha(r.radiusType,"vdw"),this.radiusData=Ha(r.radiusData,{}),this.radiusSize=Ha(r.radiusSize,1),this.radiusScale=Ha(r.radiusScale,1),this.assembly=Ha(r.assembly,"default"),this.defaultAssembly=Ha(r.defaultAssembly,""),"auto"===r.quality&&(r.quality=this.getQuality()),e.prototype.init.call(this,r),this.selection.signals.stringChanged.add(function(){this.build()},this),this.build()},t.prototype.setRadius=function(e,t){var r=Object.keys(hf);return"string"==typeof e&&r.includes(e.toLowerCase())?t.radiusType=e:void 0!==e&&(t.radiusType="size",t.radiusSize=e),this},t.prototype.getAssembly=function(){var e="default"===this.assembly?this.defaultAssembly:this.assembly;return this.structure.biomolDict[e]},t.prototype.getQuality=function(){var e,t=this.structureView,r=this.getAssembly();return e=r?r.getAtomCount(t):t.atomCount,dl&&(e*=4),t.atomStore.count/t.residueStore.count<2&&(e*=10),e<15e3?"high":e<8e4?"medium":"low"},t.prototype.create=function(){if(0!==this.structureView.atomCount)if(this.structureView.hasCoords()){this.needsBuild=!1;var e=this.getAssembly();if(e)e.partList.forEach(function(e,t){var r=e.getView(this.structureView);if(0!==r.atomCount){var n=this.createData(r,t);n&&(n.sview=r,n.instanceList=e.getInstanceList(),this.dataList.push(n))}},this);else{var t=this.createData(this.structureView,0);t&&(t.sview=this.structureView,this.dataList.push(t))}}else this.needsBuild=!0},t.prototype.createData=function(){console.error("createData not implemented")},t.prototype.update=function(e){!this.lazy||this.visible?this.needsBuild?this.build():this.dataList.forEach(function(t){t.bufferList.length>0&&this.updateData(e,t)},this):Object.assign(this.lazyProps.what,e)},t.prototype.updateData=function(){this.build()},t.prototype.getColorParams=function(){var t=e.prototype.getColorParams.call(this);return t.structure=this.structure,t},t.prototype.getRadiusParams=function(){return{type:this.radiusType,scale:this.radiusScale,size:this.radiusSize,data:this.radiusData}},t.prototype.getAtomParams=function(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)},t.prototype.getBondParams=function(e,t){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},t)},t.prototype.getAtomRadius=function(e){return this.structureView.atomSet.isSet(e.index)?new pf(this.getRadiusParams()).atomRadius(e):0},t.prototype.setSelection=function(e,t){return this.selection.setString(e,t),this},t.prototype.setParameters=function(t,r,n){void 0===r&&(r={}),void 0===n&&(n=!1);var i=t||{};return this.setRadius(i.radius,i),void 0===i.radiusData&&void 0===i.radiusSize&&void 0===i.radiusScale||(r.radius=!0,ml&&!this.disableImpostor||(n=!0)),void 0!==i.defaultAssembly&&(n=!0),e.prototype.setParameters.call(this,i,r,n),this},t.prototype.getParameters=function(){return Object.assign(e.prototype.getParameters.call(this),{sele:this.selection?this.selection.string:void 0,defaultAssembly:this.defaultAssembly})},t.prototype.attach=function(e){var t=this.viewer,r=this.bufferList;this.dataList.forEach(function(e){e.bufferList.forEach(function(n){r.push(n),t.add(n,e.instanceList)})}),this.setVisibility(this.visible),e()},t.prototype.clear=function(){this.dataList.length=0,e.prototype.clear.call(this)},t.prototype.dispose=function(){this.structureView.dispose(),delete this.structure,delete this.structureView,e.prototype.dispose.call(this)},Object.defineProperties(t.prototype,r),t}(Dc),Ov=function(e){function t(t,r,n){e.call(this,t,r,n),this.n=0,this.parameters=Object.assign({labelVisible:{type:"boolean"},labelSize:{type:"number",precision:3,max:10,min:.001},labelColor:{type:"color"},labelFontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:"fontFamily"},labelFontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:"fontStyle"},labelFontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:"fontWeight"},labelsdf:{type:"boolean",buffer:"sdf"},labelXOffset:{type:"number",precision:1,max:20,min:-20,buffer:"xOffset"},labelYOffset:{type:"number",precision:1,max:20,min:-20,buffer:"yOffset"},labelZOffset:{type:"number",precision:1,max:20,min:-20,buffer:"zOffset"},labelAttachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},labelBorder:{type:"boolean",buffer:"showBorder"},labelBorderColor:{type:"color",buffer:"borderColor"},labelBorderWidth:{type:"number",precision:2,max:.3,min:0,buffer:"borderWidth"},labelBackground:{type:"boolean",rebuild:!0},labelBackgroundColor:{type:"color",buffer:"backgroundColor"},labelBackgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},labelBackgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:"backgroundOpacity"},lineOpacity:{type:"range",min:0,max:1,step:.01},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters,{flatShaded:null,assembly:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};this.labelVisible=Ha(r.labelVisible,!0),this.labelSize=Ha(r.labelSize,2),this.labelColor=Ha(r.labelColor,16777215),this.labelFontFamily=Ha(r.labelFontFamily,"sans-serif"),this.labelFontStyle=Ha(r.labelFontstyle,"normal"),this.labelFontWeight=Ha(r.labelFontWeight,"bold"),this.labelsdf=Ha(r.labelsdf,"Chrome"===cl),this.labelXOffset=Ha(r.labelXOffset,0),this.labelYOffset=Ha(r.labelYOffset,0),this.labelZOffset=Ha(r.labelZOffset,.5),this.labelAttachment=Ha(r.labelAttachment,"bottom-left"),this.labelBorder=Ha(r.labelBorder,!1),this.labelBorderColor=Ha(r.labelBorderColor,"lightgrey"),this.labelBorderWidth=Ha(r.labelBorderWidth,.15),this.labelBackground=Ha(r.labelBackground,!1),this.labelBackgroundColor=Ha(r.labelBackgroundColor,"lightgrey"),this.labelBackgroundMargin=Ha(r.labelBackgroundMargin,.5),this.labelBackgroundOpacity=Ha(r.labelBackgroundOpacity,1),this.lineOpacity=Ha(r.lineOpacity,1),this.linewidth=Ha(r.linewidth,2),e.prototype.init.call(this,r)},t.prototype.update=function(t){t.position?this.build():e.prototype.update.call(this,t)},t.prototype.updateData=function(e,t){var r={};if(e.labelSize&&(r.size=fu(this.n,this.labelSize)),e.labelColor){var n=new ur(this.labelColor);r.color=mu(this.n,n.r,n.g,n.b)}this.textBuffer.setAttributes(r)},t.prototype.setParameters=function(t){var r={};return t&&t.labelSize&&(r.labelSize=!0),t&&(t.labelColor||0===t.labelColor)&&(r.labelColor=!0),e.prototype.setParameters.call(this,t,r,!1),t&&void 0!==t.opacity&&this.textBuffer.setParameters({opacity:1}),t&&void 0!==t.labelVisible&&this.setVisibility(this.visible),this},t.prototype.setVisibility=function(t,r){return e.prototype.setVisibility.call(this,t,!0),this.textBuffer&&this.textBuffer.setVisibility(this.labelVisible&&this.visible),r||this.viewer.requestRender(),this},t.prototype.getLabelBufferParams=function(t){return e.prototype.getBufferParams.call(this,Object.assign({fontFamily:this.labelFontFamily,fontStyle:this.labelFontStyle,fontWeight:this.labelFontWeight,sdf:this.labelsdf,xOffset:this.labelXOffset,yOffset:this.labelYOffset,zOffset:this.labelZOffset,attachment:this.labelAttachment,showBorder:this.labelBorder,borderColor:this.labelBorderColor,borderWidth:this.labelBorderWidth,showBackground:this.labelBackground,backgroundColor:this.labelBackgroundColor,backgroundMargin:this.labelBackgroundMargin,backgroundOpacity:this.labelBackgroundOpacity,disablePicking:!0,visible:this.labelVisible},t,{opacity:1}))},t.prototype.getAtomRadius=function(){return 0},t}(kv);function Fv(e,t){var r=e.getAtomProxy(),n=new el,i=t.length;if(0===i)return new Float32Array(0);var o=t[0].length,a=!Number.isInteger(t[0][0]),s=new Float32Array(i*o*3),l=0;return t.forEach(function(t){for(var i=!1,u=0;u<o;u++){if(a){n.setString(t[u]);var c=e.getAtomIndices(n);if(!c.length){i=!0;break}r.index=c[0]}else r.index=t[u];var h=l+3*u;s[h++]=r.x,s[h++]=r.y,s[h++]=r.z}i||(l+=3*o)}),s.subarray(0,l)}function Lv(e,t,r,n,i){var o=Math.cos(i),a=Math.sin(i);e[0]=t[0]+r[0]*o+n[0]*a,e[1]=t[1]+r[1]*o+n[1]*a,e[2]=t[2]+r[2]*o+n[2]*a}Al.add("shader/SDFFont.vert","uniform float clipNear;\nuniform float clipRadius;\nuniform vec3 clipCenter;\nuniform float xOffset;\nuniform float yOffset;\nuniform float zOffset;\nuniform bool ortho;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvarying vec3 vViewPosition;\n#endif\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#endif\nattribute vec2 mapping;\nattribute vec2 inputTexCoord;\nattribute float inputSize;\n#include matrix_scale\n#include common\nvoid main(void){\n#if defined( PICKING )\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#endif\ntexCoord = inputTexCoord;\nfloat scale = matrixScale( modelViewMatrix );\nfloat _zOffset = zOffset * scale;\nif( texCoord.x == 10.0 ){\n_zOffset -= 0.001;\n}\nvec3 pos = position;\nif( ortho ){\npos += normalize( cameraPosition ) * _zOffset;\n}\nvec4 cameraPos = modelViewMatrix * vec4( pos, 1.0 );\nvec4 cameraCornerPos = vec4( cameraPos.xyz, 1.0 );\ncameraCornerPos.xy += mapping * inputSize * 0.01 * scale;\ncameraCornerPos.x += xOffset * scale;\ncameraCornerPos.y += yOffset * scale;\nif( !ortho ){\ncameraCornerPos.xyz += normalize( -cameraCornerPos.xyz ) * _zOffset;\n}\ngl_Position = projectionMatrix * cameraCornerPos;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )\nvViewPosition = -cameraCornerPos.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n#include radiusclip_vertex\n}"),Al.add("shader/SDFFont.frag","uniform sampler2D fontTexture;\nuniform float opacity;\nuniform bool showBorder;\nuniform vec3 borderColor;\nuniform float borderWidth;\nuniform vec3 backgroundColor;\nuniform float backgroundOpacity;\nuniform float clipNear;\nuniform float clipRadius;\nvarying vec3 vViewPosition;\nvarying vec2 texCoord;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#if defined( PICKING )\nuniform float objectId;\nvarying vec3 vPickingColor;\nconst vec3 vColor = vec3( 0.0 );\n#else\n#include common\n#include color_pars_fragment\n#include fog_pars_fragment\n#endif\n#ifdef SDF\nconst float smoothness = 16.0;\n#else\nconst float smoothness = 256.0;\n#endif\nconst float gamma = 2.2;\nvoid main(){\n#include nearclip_fragment\n#include radiusclip_fragment\nif( texCoord.x > 1.0 ){\ngl_FragColor = vec4( backgroundColor, backgroundOpacity );\n}else{\nfloat sdf = texture2D( fontTexture, texCoord ).a;\nif( showBorder ) sdf += borderWidth;\nfloat w = clamp(\nsmoothness * ( abs( dFdx( texCoord.x ) ) + abs( dFdy( texCoord.y ) ) ),\n0.0,\n0.5\n);\nfloat a = smoothstep( 0.5 - w, 0.5 + w, sdf );\na = pow( a, 1.0 / gamma );\nif( a < 0.2 ) discard;\na *= opacity;\nvec3 outgoingLight = vColor;\nif( showBorder && sdf < ( 0.5 + borderWidth ) ){\noutgoingLight = borderColor;\n}\ngl_FragColor = vec4( outgoingLight, a );\n}\n#if defined( PICKING )\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Uv={};var Vv={font:"sans-serif",size:36,style:"normal",variant:"normal",weight:"normal",outline:0,width:2048,height:2048},Bv=function(e){if(void 0===e&&(e={}),this.gamma=1,this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.parameters=$a(e,Vv),"undefined"!=typeof navigator){var t=navigator.userAgent;t.match(/Chrome/)&&t.match(/OS X/)&&(this.gamma=.5)}this.build(),this.populate(),this.texture=new gr(this.canvas2),this.texture.flipY=!1,this.texture.needsUpdate=!0};Bv.prototype.build=function(){var e=this.parameters,t=e.size+2*e.outline+Math.round(e.size/4),r=e.width/4,n=document.createElement("canvas");n.width=r,n.height=t;var i=n.getContext("2d");i.font=e.style+" "+e.variant+" "+e.weight+" "+e.size+"px "+e.font,i.fillStyle="#FF0000",i.textAlign="left",i.textBaseline="bottom",i.lineJoin="round";for(var o=[],a=3*e.outline,s=0;s<a;++s){var l=("00"+Math.max(0,8*-s+128-8*s).toString(16)).slice(-2);o.push("#"+l+l+l)}var u=new Uint8Array(r*t*2);this.canvas=n,this.context=i,this.lineHeight=t,this.maxWidth=r,this.colors=o,this.scratch=u,this.data=new Uint8Array(e.width*e.height*4),this.canvas2=document.createElement("canvas"),this.canvas2.width=e.width,this.canvas2.height=e.height,this.context2=this.canvas2.getContext("2d")},Bv.prototype.map=function(e){var t=this.parameters;return void 0===this.mapped[e]&&(this.draw(e),this.currentX+this.scratchW>t.width&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>t.height&&console.warn("canvas to small"),this.mapped[e]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH},this.context2.drawImage(this.canvas,0,0,this.scratchW,this.scratchH,this.currentX,this.currentY,this.scratchW,this.scratchH),this.currentX+=this.scratchW),this.mapped[e]},Bv.prototype.get=function(e){return this.mapped[e]||this.placeholder},Bv.prototype.draw=function(e){var t,r,n,i,o,a=this.parameters,s=this.lineHeight,l=a.outline,u=this.context,c=this.scratch,h=this.maxWidth,p=this.colors,d=l,f=s-a.outline,m=u.measureText(e),g=Math.min(h,Math.ceil(m.width+2*d+1));if(u.clearRect(0,0,g,s),0===a.outline)for(u.fillText(e,d,f),n=3,t=0,r=(o=(i=u.getImageData(0,0,g,s)).data).length/4;t<r;++t)c[t]=o[n],n+=4;else{for(u.globalCompositeOperation="source-over",t=l+1;t>0;--t)n=t>1?2*t-2:t,u.strokeStyle=p[n-1],u.lineWidth=n,u.strokeText(e,d,f);u.globalCompositeOperation="multiply",u.fillStyle="#FF00FF",u.fillText(e,d,f),o=(i=u.getImageData(0,0,g,s)).data,n=0;var v=this.gamma;for(t=0,r=o.length/4;t<r;++t){var y=o[n],b=y?o[n+1]/y:1;.5===v&&(b=Math.sqrt(b));var w=256-y,x=w+(y-w)*(b=Math.min(1,Math.max(0,b)));c[t]=Math.max(0,Math.min(255,x+2)),o[n+3]=c[t],n+=4}}u.putImageData(i,0,0),this.scratchW=g,this.scratchH=s},Bv.prototype.populate=function(){this.placeholder=this.map(String.fromCharCode(65533));for(var e=0;e<127;++e)this.map(String.fromCharCode(e));for(var t=128;t<255;++t)this.map(String.fromCharCode(t));for(var r=880;r<1023;++r)this.map(String.fromCharCode(r));for(var n=1024;n<1279;++n)this.map(String.fromCharCode(n));this.map(String.fromCharCode(8491))};var zv=Object.assign({fontFamily:"sans-serif",fontStyle:"normal",fontWeight:"bold",fontSize:48,sdf:"Chrome"===cl,xOffset:0,yOffset:0,zOffset:.5,attachment:"bottom-left",showBorder:!1,borderColor:"lightgrey",borderWidth:.15,showBackground:!1,backgroundColor:"lightgrey",backgroundMargin:.5,backgroundOpacity:1,forceTransparent:!0},kd),jv=Object.assign({fontFamily:{uniform:!0},fontStyle:{uniform:!0},fontWeight:{uniform:!0},fontSize:{uniform:!0},sdf:{updateShader:!0,uniform:!0},xOffset:{uniform:!0},yOffset:{uniform:!0},zOffset:{uniform:!0},showBorder:{uniform:!0},borderColor:{uniform:!0},borderWidth:{uniform:!0},backgroundColor:{uniform:!0},backgroundOpacity:{uniform:!0}},Od);function Hv(e,t){for(var r=e.position.length/3,n=0,i=0;i<r;++i)n+=e.text[i].length;return t.showBackground&&(n+=r),n}var $v=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,{position:new Float32Array(3*Hv(t,r)),color:new Float32Array(3*Hv(t,r)),picking:new $p},r),this.parameterTypes=jv,this.alwaysTransparent=!0,this.hasWireframe=!1,this.isText=!0,this.vertexShader="SDFFont.vert",this.fragmentShader="SDFFont.frag",this.text=t.text,this.positionCount=t.position.length/3,this.addUniforms({fontTexture:{value:null},xOffset:{value:this.parameters.xOffset},yOffset:{value:this.parameters.yOffset},zOffset:{value:this.parameters.zOffset},ortho:{value:!1},showBorder:{value:this.parameters.showBorder},borderColor:{value:new ur(this.parameters.borderColor)},borderWidth:{value:this.parameters.borderWidth},backgroundColor:{value:new ur(this.parameters.backgroundColor)},backgroundOpacity:{value:this.parameters.backgroundOpacity}}),this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}}),this.setAttributes(t),this.makeTexture(),this.makeMapping()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return zv},t.prototype.makeMaterial=function(){e.prototype.makeMaterial.call(this);var t=this.texture,r=this.material;r.transparent=!0,r.extensions.derivatives=!0,r.lights=!1,r.uniforms.fontTexture.value=t,r.needsUpdate=!0;var n=this.wireframeMaterial;n.transparent=!0,n.extensions.derivatives=!0,n.lights=!1,n.uniforms.fontTexture.value=t,n.needsUpdate=!0;var i=this.pickingMaterial;i.extensions.derivatives=!0,i.lights=!1,i.uniforms.fontTexture.value=t,i.needsUpdate=!0},t.prototype.setAttributes=function(e){var t,r,n,i,o,a;void 0===e&&(e={});var s=this.text,l=this.geometry.attributes;e.position&&(t=e.position,i=l.position.array,l.position.needsUpdate=!0),e.size&&(r=e.size,o=l.inputSize.array,l.inputSize.needsUpdate=!0),e.color&&(n=e.color,a=l.color.array,l.color.needsUpdate=!0);for(var u,c,h,p,d=this.positionCount,f=0,m=0;m<d;++m)for(c=3*m,p=s[m].length,this.parameters.showBackground&&(p+=1),h=0;h<p;++h,++f)for(var g=0;g<4;g++)u=4*f*3+3*g,t&&(i[u]=t[c],i[u+1]=t[c+1],i[u+2]=t[c+2]),r&&(o[4*f+g]=r[m]),n&&(a[u]=n[c],a[u+1]=n[c+1],a[u+2]=n[c+2])},t.prototype.makeTexture=function(){this.textAtlas=function(e){var t=JSON.stringify(e);return void 0===Uv[t]&&(Uv[t]=new Bv(e)),Uv[t]}({font:this.parameters.fontFamily,style:this.parameters.fontStyle,weight:this.parameters.fontWeight,size:this.parameters.fontSize,outline:this.parameters.sdf?5:0}),this.texture=this.textAtlas.texture},t.prototype.makeMapping=function(){for(var e,t,r,n,i,o,a,s,l=this.textAtlas,u=this.text,c=this.parameters.attachment,h=l.lineHeight*this.parameters.backgroundMargin*.1-10,p=this.geometry.attributes,d=p.inputTexCoord.array,f=p.mapping.array,m=this.positionCount,g=0,v=0;v<m;++v){for(n=0,o=(r=u[v]).length,i=0;i<o;++i)n+=(e=l.get(r[i])).w-2*l.parameters.outline;for(s=c.startsWith("top")?l.lineHeight/1.25:c.startsWith("middle")?l.lineHeight/2.5:0,a=c.endsWith("right")?n:c.endsWith("center")?n/2:0,a+=l.parameters.outline,s+=l.parameters.outline,this.parameters.showBackground&&(f[(t=2*g*4)+0]=-l.lineHeight/6-a-h,f[t+1]=l.lineHeight-s+h,f[t+2]=-l.lineHeight/6-a-h,f[t+3]=0-s-h,f[t+4]=n+l.lineHeight/6-a+2*l.parameters.outline+h,f[t+5]=l.lineHeight-s+h,f[t+6]=n+l.lineHeight/6-a+2*l.parameters.outline+h,f[t+7]=0-s-h,d[t+0]=10,d[t+2]=10,d[t+4]=10,d[t+6]=10,g+=1),n=0,i=0;i<o;++i,++g){e=l.get(r[i]),f[(t=2*g*4)+0]=n-a,f[t+1]=e.h-s,f[t+2]=n-a,f[t+3]=0-s,f[t+4]=n+e.w-a,f[t+5]=e.h-s,f[t+6]=n+e.w-a,f[t+7]=0-s;var y=l.parameters.width,b=l.parameters.height,w=[e.x/y,e.y/b,e.x/y,(e.y+e.h)/b,(e.x+e.w)/y,e.y/b,(e.x+e.w)/y,(e.y+e.h)/b];d.set(w,t),n+=e.w-2*l.parameters.outline}}p.inputTexCoord.needsUpdate=!0,p.mapping.needsUpdate=!0},t.prototype.getDefines=function(t){var r=e.prototype.getDefines.call(this,t);return this.parameters.sdf&&(r.SDF=1),r},t.prototype.setUniforms=function(t){!t||void 0===t.fontFamily&&void 0===t.fontStyle&&void 0===t.fontWeight&&void 0===t.fontSize&&void 0===t.sdf||(this.makeTexture(),this.makeMapping(),this.texture.needsUpdate=!0,t.fontTexture=this.texture),e.prototype.setUniforms.call(this,t)},Object.defineProperties(t.prototype,r),t}(Wm);Rl.add("text",$v),Al.add("shader/WideLine.vert","\nuniform float clipNear;\nuniform vec3 clipCenter;\nuniform float linewidth;\nuniform vec2 resolution;\nuniform mat4 projectionMatrixInverse;\nattribute vec2 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nvoid trimSegment( const in vec4 start, inout vec4 end ) {\nfloat a = projectionMatrix[ 2 ][ 2 ]; float b = projectionMatrix[ 3 ][ 2 ]; float nearEstimate = - 0.5 * b / a;\nfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\nend.xyz = mix( start.xyz, end.xyz, alpha );\n}\nvoid main() {\nfloat aspect = resolution.x / resolution.y;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nflag = mapping.y;\nvColor = color;\nvColor2 = color2;\n#endif\nvec4 start = modelViewMatrix * vec4( position1, 1.0 );\nvec4 end = modelViewMatrix * vec4( position2, 1.0 );\nbool perspective = ( projectionMatrix[ 2 ][ 3 ] == -1.0 ); if ( perspective ) {\nif ( start.z < 0.0 && end.z >= 0.0 ) {\ntrimSegment( start, end );\n} else if ( end.z < 0.0 && start.z >= 0.0 ) {\ntrimSegment( end, start );\n}\n}\nvec4 clipStart = projectionMatrix * start;\nvec4 clipEnd = projectionMatrix * end;\nvec2 ndcStart = clipStart.xy / clipStart.w;\nvec2 ndcEnd = clipEnd.xy / clipEnd.w;\nvec2 dir = ndcEnd - ndcStart;\ndir.x *= aspect;\ndir = normalize( dir );\nvec2 offset = vec2( dir.y, - dir.x );\ndir.x /= aspect;\noffset.x /= aspect;\nif ( mapping.x < 0.0 ) offset *= - 1.0;\noffset *= linewidth;\noffset /= resolution.y;\nvec4 clip = ( mapping.y < 0.5 ) ? clipStart : clipEnd;\noffset *= clip.w;\nclip.xy += offset;\ngl_Position = clip;\n#ifndef PICKING\nvViewPosition = ( projectionMatrixInverse * clip ).xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}"),Al.add("shader/WideLine.frag","uniform vec3 diffuse;\nuniform float opacity;\nuniform float clipNear;\nuniform float clipRadius;\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\n#include common\n#include fog_pars_fragment\nvarying vec3 vViewPosition;\nvarying vec3 vColor;\nvarying vec3 vColor2;\nvarying float flag;\n#endif\nvoid main() {\n#include nearclip_fragment\n#include radiusclip_fragment\n#if defined( PICKING )\nif( opacity < 0.7 )\ndiscard;\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 outgoingLight = vec3( 0.0 );\nvec4 diffuseColor = vec4( diffuse, 1.0 );\nif ( flag < 0.0 ) {\ndiffuseColor.rgb *= vColor;\n} else {\ndiffuseColor.rgb *= vColor2;\n}\n#include alphatest_fragment\noutgoingLight = diffuseColor.rgb;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Gv=Object.assign({linewidth:2},kd),Wv=Object.assign({linewidth:{uniform:!0}},Od),qv=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.parameterTypes=Wv,this.vertexShader="WideLine.vert",this.fragmentShader="WideLine.frag",this.addUniforms({linewidth:{value:this.parameters.linewidth},resolution:{value:new ht},projectionMatrixInverse:{value:new pt}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null}}),this.setAttributes(t),this.makeMapping()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return Gv},Object.defineProperties(t.prototype,r),t}(Wm);function Xv(e,t){void 0===t&&(t=9);for(var r=Math.floor(t/2),n=e.position1.length/3,i=3*(r*n),o=1/t,a=du(e.position1,e.position2),s=new Float32Array(i),l=new Float32Array(i),u=new ft,c=0;c<n;++c){var h=3*c;u.set(a[h],a[h+1],a[h+2]);for(var p=e.position1[h],d=e.position1[h+1],f=e.position1[h+2],m=0;m<r;++m){var g=r*h+3*m,v=o*(2*m+1),y=o*(2*m+2);s[g]=p+u.x*v,s[g+1]=d+u.y*v,s[g+2]=f+u.z*v,l[g]=p+u.x*y,l[g+1]=d+u.y*y,l[g+2]=f+u.z*y}}var b=pu(s,l),w=function(e,t){for(var r=e.length/3,n=new Float32Array(r*t*3),i=0;i<r;++i)for(var o=3*i,a=i*t*3,s=e[o+0],l=e[o+1],u=e[o+2],c=0;c<t;++c){var h=a+3*c;n[h+0]=s,n[h+1]=l,n[h+2]=u}return n}(e.color,r),x={position:b,position1:s,position2:l,color:w,color2:w};return e.radius&&(x.radius=yu(e.radius,r)),e.picking&&(e.picking.array=yu(e.picking.array,r),x.picking=e.picking),e.primitiveId&&(x.primitiveId=yu(e.primitiveId,r)),x}function Kv(e,t){void 0===t&&(t=.1);for(var r=du(e.position1,e.position2),n=[],i=[],o=[],a=e.radius?[]:void 0,s=e.picking?[]:void 0,l=e.primitiveId?[]:void 0,u=new ft,c=e.position1.length/3,h=t,p=!0,d=0,f=0,m=0,g=0;g<c;++g){var v=3*g,y=e.position1[v],b=e.position1[v+1],w=e.position1[v+2];u.set(r[v],r[v+1],r[v+2]);var x=u.length();p&&(n[f]=y,n[f+1]=b,n[f+2]=w);for(var _=h,S=1/x;_<x;){var C=p?i:n;C[f]=y+u.x*_*S,C[f+1]=b+u.y*_*S,C[f+2]=w+u.z*_*S,p&&(f=3*++d),p=!p,h=t,_+=t}p&&(i[f]=e.position2[v],i[f+1]=e.position2[v+1],i[f+2]=e.position2[v+2],f=3*++d),h=_-x;for(var M=m;M<d;M++){if(e.color){var T=3*M;o[T]=e.color[v],o[T+1]=e.color[v+1],o[T+2]=e.color[v+2]}a&&(a[M]=e.radius[g]),s&&(s[M]=e.picking.array[g]),l&&(l[M]=e.primitiveId[g])}m=d}if(!p&&c>0){var A=3*d;i[A]=e.position2[3*c-3],i[A+1]=e.position2[3*c-2],i[A+1]=e.position2[3*c-1]}var E=new Float32Array(n),P=new Float32Array(i),R=pu(E,P),I=new Float32Array(o),N={position:R,position1:E,position2:P,color:I,color2:I};return a&&(N.radius=new Float32Array(a)),s&&e.picking&&(e.picking.array=new Float32Array(s),N.picking=e.picking),l&&(N.primitiveId=new Float32Array(l)),N}var Yv=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="angle",this.parameters=Object.assign({atomTriple:{type:"hidden",rebuild:!0},vectorVisible:{type:"boolean",default:!0},arcVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.side=Ha(r.side,"double"),r.opacity=Ha(r.opacity,.5),this.atomTriple=Ha(r.atomTriple,[]),this.arcVisible=Ha(r.arcVisible,!0),this.sectorVisible=Ha(r.sectorVisible,!0),this.vectorVisible=Ha(r.vectorVisible,!0),e.prototype.init.call(this,r)},t.prototype.create=function(){if(0!==this.structureView.atomCount){var e=function(e,t){for(var r=Ha((t=t||{}).angleStep,Math.PI/90),n=e.length/9,i=new Float32Array(n),o=new Float32Array(3*n),a=new Array(n),s=new Float32Array(6*n),l=new Float32Array(6*n),u=new Array(n),c=new Array(n),h=new Array(n),p=0,d=jc(),f=jc(),m=jc(),g=jc(),v=jc(),y=jc(),b=jc(),w=jc(),x=jc(),_=function(t){var n=9*t;qc(d,e,n),qc(f,e,n+3),qc(m,e,n+6);var _=6*t;Xc(d,s,_),Xc(f,l,_),Xc(f,s,_+3),Xc(m,l,_+3),Gc(g,d,f),Gc(v,m,f),Jc(g,g),Jc(v,v),Hc(y,g,v);var S=Kc(y),C=$c(g,v),M=i[t]=Math.atan2(S,C);a[t]=(cu*M).toFixed(1)+String.fromCharCode(176),0===Kc(y)&&(y[0]=1,y[1]=0,y[2]=0),Hc(b,y,g),Jc(b,b),Lv(w,f,g,b,M/2),Xc(w,o,3*t);var T=Math.ceil(M/r),A=new Float32Array(9*T);h[t]=A;var E=new Float32Array(3*T),P=new Float32Array(3*T);u[t]=E,c[t]=P,Wc(x,f,g);for(var R=function(e,t){var r=9*t,n=3*t;Xc(f,A,r),Xc(x,A,r+3),Xc(x,E,n),Lv(x,f,g,b,e),Xc(x,A,r+6),Xc(x,P,n)},I=0,N=r;N<M;N+=r)R(N,I),I++;R(M,I),p+=T},S=0;S<n;S++)_(S);for(var C=3*p,M=9*p,T=new Float32Array(C),A=new Float32Array(C),E=new Float32Array(M),P=0,R=0,I=0;I<n;I++){var N=u[I],D=c[I];bu(N,T,0,R,N.length),bu(D,A,0,R,D.length),R+=N.length;var k=h[I];bu(k,E,0,P,k.length),P+=k.length}return{labelPosition:o,labelText:a,vectorPosition1:s,vectorPosition2:l,arcPosition1:T,arcPosition2:A,sectorPosition:E}}(function(e,t){return function(e){for(var t=[],r=e.length/9,n=0;n<r;n++){for(var i=!0,o=n;o<n+3;o+=3)e[o]===e[o+3]&&e[o+1]===e[o+4]&&e[o+2]===e[o+5]&&(i=!1);i&&t.push(n)}var a=new Float32Array(9*t.length),s=0;return t.forEach(function(t){bu(e,a,9*t,9*s,9),s++}),a}(Fv(e,t))}(this.structureView,this.atomTriple)),t=this.n=e.labelPosition.length/3,r=new ur(this.labelColor);this.textBuffer=new $v({position:e.labelPosition,size:fu(t,this.labelSize),color:mu(t,r.r,r.g,r.b),text:e.labelText},this.getLabelBufferParams());var n=new ur(this.colorValue);this.vectorBuffer=new qv(Kv({position1:e.vectorPosition1,position2:e.vectorPosition2,color:mu(2*t,n.r,n.g,n.b),color2:mu(2*t,n.r,n.g,n.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.vectorVisible,opacity:this.lineOpacity})),this.arcLength=e.arcPosition1.length/3,this.arcBuffer=new qv(Kv({position1:e.arcPosition1,position2:e.arcPosition2,color:mu(this.arcLength,n.r,n.g,n.b),color2:mu(this.arcLength,n.r,n.g,n.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.arcVisible,opacity:this.lineOpacity})),this.sectorLength=e.sectorPosition.length/3,this.sectorBuffer=new Ud({position:e.sectorPosition,color:mu(this.sectorLength,n.r,n.g,n.b)},this.getBufferParams({visible:this.sectorVisible})),this.dataList.push({sview:this.structureView,bufferList:[this.textBuffer,this.vectorBuffer,this.arcBuffer,this.sectorBuffer]})}},t.prototype.updateData=function(t,r){e.prototype.updateData.call(this,t,r);var n={},i={},o={};if(t.color){var a=new ur(this.colorValue);n.color=n.color2=mu(2*this.n,a.r,a.g,a.b),i.color=i.color2=mu(this.arcLength,a.r,a.g,a.b),o.color=mu(this.sectorLength,a.r,a.g,a.b)}this.vectorBuffer.setAttributes(n),this.arcBuffer.setAttributes(i),this.sectorBuffer.setAttributes(o)},t.prototype.setParameters=function(t){return e.prototype.setParameters.call(this,t,{},!1),!t||void 0===t.vectorVisible&&void 0===t.arcVisible&&void 0===t.sectorVisible||this.setVisibility(this.visible),t&&t.lineOpacity&&(this.vectorBuffer.setParameters({opacity:t.lineOpacity}),this.arcBuffer.setParameters({opacity:t.lineOpacity})),t&&void 0!==t.opacity&&(this.vectorBuffer.setParameters({opacity:this.lineOpacity}),this.arcBuffer.setParameters({opacity:this.lineOpacity})),t&&t.linewidth&&(this.vectorBuffer.setParameters({linewidth:t.linewidth}),this.arcBuffer.setParameters({linewidth:t.linewidth})),this},t.prototype.setVisibility=function(t,r){return e.prototype.setVisibility.call(this,t,!0),this.vectorBuffer&&this.vectorBuffer.setVisibility(this.vectorVisible&&this.visible),this.arcBuffer&&this.arcBuffer.setVisibility(this.arcVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),r||this.viewer.requestRender(),this},t}(Ov);Ml.add("angle",Yv);var Zv=new ft,Jv=new ft,Qv=new ft,ey=new ft(0,1,0),ty=Object.assign({radialSegments:1,openEnded:!0},kd);function ry(e){void 0===e&&(e={});var t=Ha(e.radialSegments,10),r=Ha(e.openEnded,!0),n=(new pt).makeRotationX(Math.PI/2),i=new Ai(1,1,1,t,1,r);return i.applyMatrix(n),i}var ny=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,function(e,t){void 0===t&&(t={});var r=ry(t),n=e.position1.length,i=r.attributes.position.array.length/3,o=n/3,a=new Float32Array(2*o*i);return vu(o,i,0,a),vu(o,i,o*i,a),{position:new Float32Array(2*n),color:new Float32Array(2*n),primitiveId:a,picking:e.picking}}(t,r),r,ry(r)),this.updateNormals=!0;var n=t.position1.length,i=t.radius.length;this.__center=new Float32Array(n),this._position=new Float32Array(2*n),this._color=new Float32Array(2*n),this._from=new Float32Array(2*n),this._to=new Float32Array(2*n),this._radius=new Float32Array(2*i),this.setAttributes(t,!0)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return ty},t.prototype.applyPositionTransform=function(e,t,r){Jv.fromArray(this._from,r),Qv.fromArray(this._to,r),e.lookAt(Jv,Qv,ey);var n=this._radius[t];Zv.set(n,n,Jv.distanceTo(Qv)),e.scale(Zv)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={});var n={};t.position1&&t.position2&&(pu(t.position1,t.position2,this.__center),pu(t.position1,this.__center,this._position),pu(this.__center,t.position2,this._position,t.position1.length),this._from.set(t.position1),this._from.set(this.__center,t.position1.length),this._to.set(this.__center),this._to.set(t.position2,this.__center.length),n.position=this._position),t.color&&t.color2&&(this._color.set(t.color),this._color.set(t.color2,t.color.length),n.color=this._color),t.radius&&(this._radius.set(t.radius),this._radius.set(t.radius,t.radius.length),n.radius=this._radius),e.prototype.setAttributes.call(this,n,r)},Object.defineProperties(t.prototype,r),t}(Vm);Al.add("shader/CylinderImpostor.vert","\nattribute vec3 mapping;\nattribute vec3 position1;\nattribute vec3 position2;\nattribute float radius;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform mat4 modelViewMatrixInverse;\nuniform float ortho;\n#include matrix_scale\nvoid main(){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nbase_radius.w = radius * matrixScale( modelViewMatrix );\nvec3 center = position;\nvec3 dir = normalize( position2 - position1 );\nfloat ext = length( position2 - position1 ) / 2.0;\nvec3 cam_dir;\nif( ortho == 0.0 ){\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;\n}else{\ncam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;\n}\ncam_dir = normalize( cam_dir );\nvec3 ldir;\nfloat b = dot( cam_dir, dir );\nend_b.w = b;\nif( b < 0.0 )\nldir = -ext * dir;\nelse\nldir = ext * dir;\nvec3 left = normalize( cross( cam_dir, ldir ) );\nleft = radius * left;\nvec3 up = radius * normalize( cross( left, ldir ) );\naxis = normalize( normalMatrix * ldir );\nU = normalize( normalMatrix * up );\nV = normalize( normalMatrix * left );\nvec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );\nbase_radius.xyz = base4.xyz / base4.w;\nvec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );\nvec4 end4 = top_position;\nend_b.xyz = end4.xyz / end4.w;\nw = modelViewMatrix * vec4(\ncenter + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0\n);\ngl_Position = projectionMatrix * w;\ngl_Position.z = 0.99;\n}"),Al.add("shader/CylinderImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform mat4 projectionMatrix;\nuniform float ortho;\nvarying vec3 axis;\nvarying vec4 base_radius;\nvarying vec4 end_b;\nvarying vec3 U;\nvarying vec3 V;\nvarying vec4 w;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat distSq3( vec3 v3a, vec3 v3b ){\nreturn (\n( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +\n( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +\n( v3a.z - v3b.z ) * ( v3a.z - v3b.z )\n);\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nfloat calcClip( vec3 cameraPos ){\nreturn dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nvoid main(){\nvec3 point = w.xyz / w.w;\nvec3 base = base_radius.xyz;\nfloat vRadius = base_radius.w;\nvec3 end = end_b.xyz;\nfloat b = end_b.w;\nvec3 end_cyl = end;\nvec3 surface_point = point;\nvec3 ray_target = surface_point;\nvec3 ray_origin = vec3(0.0);\nvec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);\nmat3 basis = mat3( U, V, axis );\nvec3 diff = ray_target - 0.5 * (base + end_cyl);\nvec3 P = diff * basis;\nfloat dz = dot( axis, ray_direction );\nfloat radius2 = vRadius*vRadius;\nvec3 D = vec3(dot(U, ray_direction),\ndot(V, ray_direction),\ndz);\nfloat a0 = P.x*P.x + P.y*P.y - radius2;\nfloat a1 = P.x*D.x + P.y*D.y;\nfloat a2 = D.x*D.x + D.y*D.y;\nfloat d = a1*a1 - a0*a2;\nif (d < 0.0)\ndiscard;\nfloat dist = (-a1 + sqrt(d)) / a2;\nvec3 new_point = ray_target + dist * ray_direction;\nvec3 tmp_point = new_point - base;\nvec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );\nray_origin = mix( ray_origin, surface_point, ortho );\nfloat front_cap_test = dot( tmp_point, axis );\nfloat end_cap_test = dot((new_point - end_cyl), axis);\n#ifndef CAP\nvec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\nvec3 tmp_point2 = new_point2 - base;\n#endif\nif (front_cap_test < 0.0)\n{\nfloat dNV = dot(-axis, ray_direction);\nif (dNV < 0.0)\ndiscard;\nfloat near = dot(-axis, (base)) / dNV;\nvec3 front_point = ray_direction * near + ray_origin;\nif (dot(front_point - base, front_point-base) > radius2)\ndiscard;\n#ifdef CAP\nnew_point = front_point;\n_normal = axis;\n#else\nnew_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(axis, end_cyl) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - end_cyl, new_point2-base) < radius2)\ndiscard;\ninterior = true;\n#endif\n}\nif( end_cap_test > 0.0 )\n{\nfloat dNV = dot(axis, ray_direction);\nif (dNV < 0.0)\ndiscard;\nfloat near = dot(axis, end_cyl) / dNV;\nvec3 end_point = ray_direction * near + ray_origin;\nif( dot(end_point - end_cyl, end_point-base) > radius2 )\ndiscard;\n#ifdef CAP\nnew_point = end_point;\n_normal = axis;\n#else\nnew_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;\ndNV = dot(-axis, ray_direction);\nnear = dot(-axis, (base)) / dNV;\nnew_point2 = ray_direction * near + ray_origin;\nif (dot(new_point2 - base, new_point2-base) < radius2)\ndiscard;\ninterior = true;\n#endif\n}\ngl_FragDepthEXT = calcDepth( new_point );\n#ifdef NEAR_CLIP\nif( calcClip( new_point ) > 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\nif( calcClip( new_point ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\ndist = (-a1 - sqrt(d)) / a2;\nnew_point = ray_target + dist * ray_direction;\ninterior = true;\ngl_FragDepthEXT = calcDepth( new_point );\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );\n}\n}\n#endif\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\n#ifdef PICKING\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -new_point;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){\nif( b < 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}else{\nif( b > 0.0 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nif( interior ){\nnormal = vec3( 0.0, 0.0, 0.4 );\n}\n#include lights_physical_fragment\n#include lights_template\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var iy=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),oy=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),ay=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingType:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return r.mapping.get=function(){return iy},r.mappingIndices.get=function(){return oy},r.mappingIndicesSize.get=function(){return 12},r.mappingType.get=function(){return"v3"},r.mappingSize.get=function(){return 6},r.mappingItemSize.get=function(){return 3},Object.defineProperties(t.prototype,r),t}(Hm),sy=Object.assign({openEnded:!1},kd),ly=Object.assign({openEnded:{updateShader:!0}},Od),uy=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.parameterTypes=ly,this.isImpostor=!0,this.vertexShader="CylinderImpostor.vert",this.fragmentShader="CylinderImpostor.frag",this.addUniforms({modelViewMatrixInverse:{value:new pt},ortho:{value:0}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return sy},t.prototype.getDefines=function(t){var r=e.prototype.getDefines.call(this,t);return this.parameters.openEnded||(r.CAP=1),r},Object.defineProperties(t.prototype,r),t}(ay),cy=(Object.assign({disableImpostor:!1},ty,sy),function(e,t){return void 0===t&&(t={}),!e.color2&&e.color&&(e.color2=e.color),!ml||t&&t.disableImpostor?new ny(e,t):new uy(e,t)});Rl.add("cylinder",cy);var hy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="axes",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0,showAxes:{type:"boolean",rebuild:!0},showBox:{type:"boolean",rebuild:!0}},this.parameters,{assembly:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.radiusSize=Ha(r.radiusSize,.5),r.colorValue=Ha(r.colorValue,"lightgreen"),this.showAxes=Ha(r.showAxes,!0),this.showBox=Ha(r.showBox,!1),e.prototype.init.call(this,r)},t.prototype.getPrincipalAxes=function(){var e,t=this.getAssembly();return t&&(e=t.partList[0].getSelection()),this.structureView.getPrincipalAxes(e)},t.prototype.getAxesData=function(e){var t=this.getPrincipalAxes(e),r=new ur(this.colorValue),n=0,i=0;this.showAxes&&(n+=6,i+=3),this.showBox&&(n+=8,i+=12);var o=new Float32Array(3*n),a=mu(n,r.r,r.g,r.b),s=fu(n,this.radiusSize),l=new Float32Array(3*i),u=new Float32Array(3*i),c=mu(i,r.r,r.g,r.b),h=fu(i,this.radiusSize),p=0;if(this.showAxes){var d=function(e,t){e.toArray(o,2*p),t.toArray(o,2*p+3),e.toArray(l,p),t.toArray(u,p),p+=3};d(t.begA,t.endA),d(t.begB,t.endB),d(t.begC,t.endC)}if(this.showBox){var f=new ft,m=t.getProjectedScaleForAtoms(e),g=m.d1a,v=m.d2a,y=m.d3a,b=m.d1b,w=m.d2b,x=m.d3b;console.log(g,v,y,b,w,x);var _=2*p,S=function(e,r,n){f.copy(t.center).addScaledVector(t.normVecA,e).addScaledVector(t.normVecB,r).addScaledVector(t.normVecC,n),f.toArray(o,_),_+=3};S(g,v,y),S(g,v,x),S(g,w,x),S(g,w,y),S(b,w,x),S(b,w,y),S(b,v,y),S(b,v,x);var C=p,M=function(e,t){f.fromArray(o,2*p+3*e).toArray(l,C),f.fromArray(o,2*p+3*t).toArray(u,C),C+=3};M(0,1),M(0,3),M(0,6),M(1,2),M(1,7),M(2,3),M(2,4),M(3,5),M(4,5),M(4,7),M(5,6),M(6,7)}var T=new Op(t);return{vertex:{position:o,color:a,radius:s,picking:T},edge:{position1:l,position2:u,color:c,color2:c,radius:h,picking:T}}},t.prototype.create=function(){var e=this.getAxesData(this.structureView);this.sphereBuffer=new Xm(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new cy(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})},t.prototype.updateData=function(e,t){var r=this.getAxesData(t.sview),n={},i={};e&&!e.position||(n.position=r.vertex.position,i.position1=r.edge.position1,i.position2=r.edge.position2),e&&!e.color||(n.color=r.vertex.color,i.color=r.edge.color,i.color2=r.edge.color),e&&!e.radius||(n.radius=r.vertex.radius,i.radius=r.edge.radius),this.sphereBuffer.setAttributes(n),this.cylinderBuffer.setAttributes(i)},t}(kv);Ml.add("axes",hy);var py=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="ball+stick",this.parameters=Object.assign({sphereDetail:!0,radialSegments:!0,openEnded:!0,disableImpostor:!0,aspectRatio:{type:"number",precision:1,max:10,min:1},lineOnly:{type:"boolean",rebuild:!0},cylinderOnly:{type:"boolean",rebuild:!0},multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondScale:{type:"number",precision:2,max:1,min:.01},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.radiusType=Ha(r.radiusType,"size"),r.radiusSize=Ha(r.radiusSize,.15),this.aspectRatio=Ha(r.aspectRatio,2),this.lineOnly=Ha(r.lineOnly,!1),this.cylinderOnly=Ha(r.cylinderOnly,!1),this.multipleBond=Ha(r.multipleBond,"off"),this.bondSpacing=Ha(r.bondSpacing,1),this.bondScale=Ha(r.bondScale,.4),this.linewidth=Ha(r.linewidth,2),e.prototype.init.call(this,r)},t.prototype.getAtomRadius=function(t){return this.aspectRatio*e.prototype.getAtomRadius.call(this,t)},t.prototype.getAtomParams=function(t,r){var n=e.prototype.getAtomParams.call(this,t,r);return n.radiusParams.scale*=this.aspectRatio,n},t.prototype.getAtomData=function(e,t,r){return e.getAtomData(this.getAtomParams(t,r))},t.prototype.getBondParams=function(t,r){return r=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,bondScale:this.bondScale},r),e.prototype.getBondParams.call(this,t,r)},t.prototype.getBondData=function(e,t,r){return e.getBondData(this.getBondParams(t,r))},t.prototype.createData=function(e){var t=[];if(this.lineOnly)this.lineBuffer=new qv(this.getBondData(e,{position:!0,color:!0,picking:!0}),this.getBufferParams({linewidth:this.linewidth})),t.push(this.lineBuffer);else{var r=new cy(this.getBondData(e),this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}));if(t.push(r),!this.cylinderOnly){var n=new Xm(this.getAtomData(e),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));t.push(n)}}return{bufferList:t}},t.prototype.updateData=function(e,t){"off"!==this.multipleBond&&e&&e.radius&&(e.position=!0);var r=this.getBondData(t.sview,e);if(this.lineOnly){var n={};e&&!e.position||(n.position1=r.position1,n.position2=r.position2),e&&!e.color||(n.color=r.color,n.color2=r.color2),t.bufferList[0].setAttributes(n)}else{var i={};if(e&&!e.position||(i.position1=r.position1,i.position2=r.position2),e&&!e.color||(i.color=r.color,i.color2=r.color2),e&&!e.radius||(i.radius=r.radius),t.bufferList[0].setAttributes(i),!this.cylinderOnly){var o=this.getAtomData(t.sview,e),a={};e&&!e.position||(a.position=o.position),e&&!e.color||(a.color=o.color),e&&!e.radius||(a.radius=o.radius),t.bufferList[1].setAttributes(a)}}},t.prototype.setParameters=function(t){void 0===t&&(t={});var r=!1,n={};return(t.aspectRatio||t.bondSpacing||t.bondScale)&&(n.radius=!0,ml&&!this.disableImpostor||(r=!0)),e.prototype.setParameters.call(this,t,n,r),this},t}(kv);Ml.add("ball+stick",py);var dy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="backbone",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.aspectRatio=Ha(r.aspectRatio,1),r.radiusSize=Ha(r.radiusSize,.25),e.prototype.init.call(this,r)},t.prototype.getAtomRadius=function(t){return t.isTrace()?e.prototype.getAtomRadius.call(this,t):0},t.prototype.getAtomData=function(e,t,r){return e.getBackboneAtomData(this.getAtomParams(t,r))},t.prototype.getBondData=function(e,t,r){return e.getBackboneBondData(this.getBondParams(t,r))},t}(py);Ml.add("backbone",dy);var fy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="base",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.aspectRatio=Ha(r.aspectRatio,1),r.radiusSize=Ha(r.radiusSize,.3),e.prototype.init.call(this,r)},t.prototype.getAtomData=function(e,t,r){return e.getRungAtomData(this.getAtomParams(t,r))},t.prototype.getBondData=function(e,t,r){var n=this.getBondParams(t,r);return n.colorParams.rung=!0,e.getRungBondData(n)},t}(py);function my(e,t){this.polymer=e,this.size=e.residueCount;var r=t||{};this.directional=r.directional||!1,this.positionIterator=r.positionIterator||!1,this.subdiv=r.subdiv||1,this.smoothSheet=r.smoothSheet||!1,r.tension?this.tension=r.tension:this.tension=this.polymer.isNucleic()?.5:.9,this.interpolator=new function(e,t){var r=1/e,n=1e-4,i=new ft,o=new ft;function a(e,r,n,i,o,a,s){a[s+0]=xs(e.x,r.x,n.x,i.x,o,t),a[s+1]=xs(e.y,r.y,n.y,i.y,o,t),a[s+2]=xs(e.z,r.z,n.z,i.z,o,t)}function s(e,r,n,i,o,a){a.x=xs(e.x,r.x,n.x,i.x,o,t),a.y=xs(e.y,r.y,n.y,i.y,o,t),a.z=xs(e.z,r.z,n.z,i.z,o,t)}function l(t,n,i,o,s,l){for(var u=0;u<e;++u)a(t,n,i,o,r*u,s,l+3*u)}function u(t,a,l,u,c,h){for(var p=0;p<e;++p){var d=r*p,f=d-n,m=d+n,g=h+3*p;f<0&&(f=0),m>1&&(m=1),s(t,a,l,u,f,i),s(t,a,l,u,m,o),o.sub(i).normalize(),o.toArray(c,g)}}function c(t,r,n,i,o){for(var a=r.next(),s=r.next(),l=r.next(),u=r.size,c=u-1,h=i||0,p=0;p<c;++p)t(a,a=s,s=l,l=r.next(),n,h),h+=3*e;o&&(t(r.get(u-2),a=r.get(u-1),s=r.get(0),l=r.get(1),n,h),h+=3*e)}this.getPosition=function(t,r,n,i){t.reset(),c(l,t,r,n,i);var o=t.size-1,a=o*e*3;i&&(a+=3*e);var s=t.get(i?0:o);r[a]=s.x,r[a+1]=s.y,r[a+2]=s.z},this.getTangent=function(t,r,n,i){t.reset(),c(u,t,r,n,i);var o=(t.size-1)*e*3;i&&(o+=3*e),bu(r,r,o-3,o,3)};var h=new ft,p=new ft,d=new ft,f=new ft,m=Math.ceil(e/2);function g(t,n,a,l,u,c,g,v,y,b,w,x,_){for(var S=0;S<e;++S){var C=x+3*S;_&&(C+=3*m);var M=r*S;s(t,n,a,l,M,i),s(u,c,g,v,M,o),h.subVectors(o,i).normalize(),p.fromArray(y,C),f.crossVectors(h,p).normalize(),f.toArray(w,C),d.crossVectors(p,f).normalize(),d.toArray(b,C)}}function v(t,r,n,i,o){for(var a=0;a<e;++a){var s=o+3*a;t.copy(d),p.fromArray(r,s),f.crossVectors(t,p).normalize(),f.toArray(i,s),d.crossVectors(p,f).normalize(),d.toArray(n,s)}}function y(t,r,n,i,o){var a;for(a=0;a<m;++a)n(t,i,o+3*a);for(a=m;a<e;++a)n(r,i,o+3*a)}function b(t,r,n,i,o){var a;for(a=0;a<m;++a)i[o+a]=n(t);for(a=m;a<e;++a)i[o+a]=n(r)}function w(t,r,n,i,o){for(var a=n(t),s=n(r),l=0;l<e;++l){var u=l/e;i[o+l]=(1-u)*a+u*s}}this.getNormal=function(t,r,n,i,o,a){d.set(0,0,1);for(var s=t-1,l=o||0,u=0;u<s;++u)v(h,r,n,i,l),l+=3*e;a&&(v(h,r,n,i,l),l+=3*e),f.toArray(i,l),d.toArray(n,l)},this.getNormalDir=function(t,r,n,i,o,a,s,l){t.reset(),r.reset();var u=new ft,c=new ft,h=new ft,p=new ft,v=new ft,y=(new ft).copy(t.next()),b=(new ft).copy(t.next()),w=(new ft).copy(t.next()),x=new ft,_=(new ft).copy(r.next()),S=(new ft).copy(r.next()),C=(new ft).copy(r.next());d.set(0,0,1);for(var M=t.size,T=M-1,A=a||0,E=0;E<T;++E)v.copy(y),y.copy(b),b.copy(w),w.copy(t.next()),x.copy(_),_.copy(S),S.copy(C),C.copy(r.next()),0===E?(u.subVectors(x,v),c.subVectors(_,y),u.dot(c)<0&&(c.multiplyScalar(-1),_.addVectors(y,c)),h.subVectors(S,b),c.dot(h)<0&&(h.multiplyScalar(-1),S.addVectors(b,h))):h.copy(p),p.subVectors(C,w),h.dot(p)<0&&(p.multiplyScalar(-1),C.addVectors(w,p)),g(v,y,b,w,x,_,S,C,n,i,o,A,l),A+=3*e;if(s&&(v.copy(t.get(M-2)),y.copy(t.get(M-1)),b.copy(t.get(0)),w.copy(t.get(1)),x.copy(r.get(M-2)),_.copy(r.get(M-1)),S.copy(r.get(0)),C.copy(r.get(1)),h.copy(p),p.subVectors(C,w),h.dot(p)<0&&(p.multiplyScalar(-1),C.addVectors(w,p)),g(v,y,b,w,x,_,S,C,n,i,o,A,l),A+=3*e),l){f.fromArray(o,3*m),d.fromArray(i,3*m);for(var P=0;P<m;++P)f.toArray(o,3*P),d.toArray(i,3*P)}else f.toArray(o,A),d.toArray(i,A)},this.getColor=function(t,r,n,i,o){t.reset(),t.next();for(var a=t.next(),s=t.size,l=s-1,u=i||0,c=0;c<l;++c)y(a,a=t.next(),r,n,u),u+=3*e;o&&(y(t.get(s-1),a=t.get(0),r,n,u),u+=3*e),n[u]=n[u-3],n[u+1]=n[u-2],n[u+2]=n[u-1]},this.getPicking=function(t,r,n,i,o){t.reset(),t.next();for(var a=t.next(),s=t.size,l=s-1,u=i||0,c=0;c<l;++c)b(a,a=t.next(),r,n,u),u+=e;o&&(b(t.get(s-1),a=t.get(0),r,n,u),u+=e),n[u]=n[u-1]},this.getSize=function(t,r,n,i,o){t.reset(),t.next();for(var a=t.next(),s=t.size,l=s-1,u=i||0,c=0;c<l;++c)w(a,a=t.next(),r,n,u),u+=e;o&&(w(t.get(s-1),a=t.get(0),r,n,u),u+=e),n[u]=n[u-1]}}(this.subdiv,this.tension)}Ml.add("base",fy),my.prototype={constructor:my,getAtomIterator:function(e,t){var r=this.polymer,n=r.structure,i=r.residueCount,o=0,a=-1,s=[n.getAtomProxy(),n.getAtomProxy(),n.getAtomProxy(),n.getAtomProxy()],l=[new ft,new ft,new ft,new ft];var u=n.getAtomProxy(),c=n.getAtomProxy();return{size:i,next:function(){var e=this.get(a);return a+=1,e},get:function(n){var a=s[o%4];if(a.index=r.getAtomIndexByType(n,e),t&&n>0&&n<i&&"e"===a.sstruc){var h=l[o%4];return u.index=r.getAtomIndexByType(n+1,e),c.index=r.getAtomIndexByType(n-1,e),h.addVectors(u,c).add(a).add(a).multiplyScalar(.25),o+=1,h}return o+=1,a},reset:function(){o=0,a=-1}}},getSubdividedColor:function(e){var t=this.subdiv,r=this.polymer,n=(r.residueCount-1)*t*3+3;r.isCyclic&&(n+=3*t);var i=new Float32Array(n),o=this.getAtomIterator("trace"),a=e||{};a.structure=r.structure;var s=Sl.getScheme(a);return this.interpolator.getColor(o,function(e,t,r){s.atomColorToArray(e,t,r)},i,0,r.isCyclic),{color:i}},getSubdividedPicking:function(){var e=this.subdiv,t=this.polymer,r=(t.residueCount-1)*e+1;t.isCyclic&&(r+=e);var n=t.structure,i=this.getAtomIterator("trace"),o=new Float32Array(r);return this.interpolator.getPicking(i,function(e){return e.index},o,0,t.isCyclic),{picking:new kp(o,n)}},getSubdividedPosition:function(){return{position:this.getPosition()}},getSubdividedOrientation:function(){var e=this.getTangent(),t=this.getNormals(e);return{tangent:e,normal:t.normal,binormal:t.binormal}},getSubdividedSize:function(e){var t=this.subdiv,r=this.polymer,n=(r.residueCount-1)*t+1;r.isCyclic&&(n+=t);var i=new Float32Array(n),o=this.getAtomIterator("trace"),a=new pf(e);return this.interpolator.getSize(o,function(e){return a.atomRadius(e)},i,0,r.isCyclic),{size:i}},getPosition:function(){var e=this.subdiv,t=this.polymer,r=(t.residueCount-1)*e*3+3;t.isCyclic&&(r+=3*e);var n=new Float32Array(r),i=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getPosition(i,n,0,t.isCyclic),n},getTangent:function(){var e=this.subdiv,t=this.polymer,r=(this.size-1)*e*3+3;t.isCyclic&&(r+=3*e);var n=new Float32Array(r),i=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getTangent(i,n,0,t.isCyclic),n},getNormals:function(e){var t=this.subdiv,r=this.polymer,n=r.isProtein(),i=this.size,o=(i-1)*t*3+3;r.isCyclic&&(o+=3*t);var a=new Float32Array(o),s=new Float32Array(o);if(this.directional&&!this.polymer.isCg()){var l=this.getAtomIterator("direction1"),u=this.getAtomIterator("direction2");this.interpolator.getNormalDir(l,u,e,a,s,0,r.isCyclic,n)}else this.interpolator.getNormal(i,e,a,s,0,r.isCyclic,n);return{normal:a,binormal:s}}};var gy=new ft,vy=new ft,yy=Object.assign({radialSegments:4,capped:!1,aspectRatio:1},kd);var by=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,function(e,t){void 0===t&&(t={});var r=Ha(t.radialSegments,4),n=Ha(t.capped,!1),i=n?r:0,o=n?r-2:0,a=e.position.length/3,s=a*r*3+2*i*3,l=2*(a-1)*r*3+2*o*3;return{position:new Float32Array(s),color:new Float32Array(s),index:is(l,s/3),normal:new Float32Array(s),picking:e.picking}}(t,r),r),this.capVertices=this.parameters.capped?this.parameters.radialSegments:0,this.capTriangles=this.parameters.capped?this.parameters.radialSegments-2:0,this.size2=t.position.length/3,t.primitiveId=gu(this.size2),this.setAttributes(t),this.makeIndex()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return yy},t.prototype.setAttributes=function(e){void 0===e&&(e={});var t,r,n,i,o,a,s,l,u,c,h,p,d,f=this.parameters.aspectRatio,m=this.size2,g=m-1,v=this.parameters.radialSegments,y=this.geometry.attributes;e.position&&(t=e.position,r=e.normal,n=e.binormal,i=e.tangent,a=e.size,l=y.position.array,c=y.normal.array,y.position.needsUpdate=!0,y.normal.needsUpdate=!0),e.color&&(o=e.color,u=y.color.array,y.color.needsUpdate=!0),e.primitiveId&&(s=e.primitiveId,h=y.primitiveId.array,y.primitiveId.needsUpdate=!0);var b=0,w=0,x=0,_=0,S=0,C=0,M=0,T=0,A=0,E=0,P=[],R=[],I=[],N=[],D=[],k=[];if(t)for(var O=0;O<v;++O){var F=O/v*2*Math.PI;P[O]=f*Math.cos(F),R[O]=Math.sin(F),I[O]=f*Math.cos(F-.01),N[O]=Math.sin(F-.01),D[O]=f*Math.cos(F+.01),k[O]=Math.sin(F+.01)}for(var L=0;L<m;++L){d=(p=3*L)*v,t&&i&&r&&n&&a&&(gy.set(i[p],i[p+1],i[p+2]),w=r[p],x=r[p+1],_=r[p+2],S=n[p],C=n[p+1],M=n[p+2],T=t[p],A=t[p+1],E=t[p+2],b=a[L]);for(var U=0;U<v;++U){var V=d+3*U;if(t){var B=-b*P[U],z=b*R[U],j=-b*I[U],H=b*N[U],$=-b*D[U],G=b*k[U];l[V]=T+B*w+z*S,l[V+1]=A+B*x+z*C,l[V+2]=E+B*_+z*M,vy.set($*w+G*S-(j*w+H*S),$*x+G*C-(j*x+H*C),$*_+G*M-(j*_+H*M)).cross(gy),c[V]=vy.x,c[V+1]=vy.y,c[V+2]=vy.z}o&&(u[V]=o[p],u[V+1]=o[p+1],u[V+2]=o[p+2]),s&&(h[L*v+U]=s[L])}}p=0,d=3*m*v;for(var W=0;W<v;++W){var q=p+3*W,X=d+3*W;t&&i&&(l[X]=l[q],l[X+1]=l[q+1],l[X+2]=l[q+2],c[X]=i[p],c[X+1]=i[p+1],c[X+2]=i[p+2]),o&&(u[X]=u[q],u[X+1]=u[q+1],u[X+2]=u[q+2]),s&&(h[m*v+W]=h[0+W])}p=3*(m-1)*v,d=3*(m+1)*v;for(var K=0;K<v;++K){var Y=p+3*K,Z=d+3*K;t&&i&&(l[Z]=l[Y],l[Z+1]=l[Y+1],l[Z+2]=l[Y+2],c[Z]=i[3*g],c[Z+1]=i[3*g+1],c[Z+2]=i[3*g+2]),o&&(u[Z]=u[Y],u[Z+1]=u[Y+1],u[Z+2]=u[Y+2]),s&&(h[(m+1)*v+K]=h[(m-1)*v+K])}},t.prototype.makeIndex=function(){for(var e,t,r=this.geometry.getIndex().array,n=this.size2,i=n-1,o=this.capTriangles,a=this.parameters.radialSegments,s=this.parameters.radialSegments+1,l=0;l<i;++l)for(var u=l*a*3*2,c=l*a,h=(l+1)*a,p=0;p<a;++p)r[t=u+3*p*2]=c+p,r[t+1]=c+(p+1)%a,r[t+2]=h+p,r[t+3]=h+p,r[t+4]=c+(p+1)%a,r[t+5]=h+(p+1)%a;for(var d=[0],f=1;f<s/2;++f)d.push(f),a-f!==f&&d.push(a-f);t=i*a*3*2,e=n*a;for(var m=0;m<d.length-2;++m)m%2==0?(r[t+3*m+0]=e+d[m+0],r[t+3*m+1]=e+d[m+1],r[t+3*m+2]=e+d[m+2]):(r[t+3*m+0]=e+d[m+2],r[t+3*m+1]=e+d[m+1],r[t+3*m+2]=e+d[m+0]);t=i*a*3*2+3*o,e=n*a+a;for(var g=0;g<d.length-2;++g)g%2==0?(r[t+3*g+0]=e+d[g+0],r[t+3*g+1]=e+d[g+1],r[t+3*g+2]=e+d[g+2]):(r[t+3*g+0]=e+d[g+2],r[t+3*g+1]=e+d[g+1],r[t+3*g+2]=e+d[g+0])},Object.defineProperties(t.prototype,r),t}(Ud),wy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="cartoon",this.parameters=Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1,rebuild:!0},subdiv:{type:"integer",max:50,min:1,rebuild:!0},radialSegments:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean",rebuild:!0},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"chainname"),r.colorScale=Ha(r.colorScale,"RdYlBu"),r.radiusType=Ha(r.radiusType,"sstruc"),r.radiusScale=Ha(r.radiusScale,.7),this.aspectRatio=Ha(r.aspectRatio,5),this.tension=Ha(r.tension,NaN),this.capped=Ha(r.capped,!0),this.smoothSheet=Ha(r.smoothSheet,!1),"low"===r.quality?(this.subdiv=3,this.radialSegments=6):"medium"===r.quality?this.subdiv=6:"high"===r.quality?this.subdiv=12:this.subdiv=Ha(r.subdiv,6),e.prototype.init.call(this,r)},t.prototype.getSplineParams=function(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:1!==this.aspectRatio,smoothSheet:this.smoothSheet},e)},t.prototype.getSpline=function(e){return new my(e,this.getSplineParams())},t.prototype.getAspectRatio=function(e){return e.isCg()?1:this.aspectRatio},t.prototype.getAtomRadius=function(t){return t.isTrace()?e.prototype.getAtomRadius.call(this,t):0},t.prototype.createData=function(e){var t=this,r=[],n=[];return this.structure.eachPolymer(function(e){if(!(e.residueCount<4)){n.push(e);var i=t.getSpline(e),o=t.getAspectRatio(e),a=i.getSubdividedPosition(),s=i.getSubdividedOrientation(),l=i.getSubdividedColor(t.getColorParams()),u=i.getSubdividedPicking(),c=i.getSubdividedSize(t.getRadiusParams());r.push(new by(Object.assign({},a,s,l,u,c),t.getBufferParams({radialSegments:t.radialSegments,aspectRatio:o,capped:t.capped,dullInterior:!0})))}},e.getSelection()),{bufferList:r,polymerList:n}},t.prototype.updateData=function(e,t){vl&&gl.time(this.type+" repr update"),e=e||{};for(var r=0,n=t.polymerList.length;r<n;++r){var i={},o=t.polymerList[r],a=this.getSpline(o),s=this.getAspectRatio(o);if(t.bufferList[r].aspectRatio=s,e.position||e.radius){var l=a.getSubdividedPosition(),u=a.getSubdividedOrientation(),c=a.getSubdividedSize(this.getRadiusParams(s));i.position=l.position,i.normal=u.normal,i.binormal=u.binormal,i.tangent=u.tangent,i.size=c.size}if(e.color){var h=a.getSubdividedColor(this.getColorParams());i.color=h.color}if(e.picking){var p=a.getSubdividedPicking();i.picking=p.picking}t.bufferList[r].setAttributes(i)}vl&&gl.timeEnd(this.type+" repr update")},t.prototype.setParameters=function(t){var r={};return t&&t.aspectRatio&&(r.radius=!0),t&&t.tension&&(r.position=!0),e.prototype.setParameters.call(this,t,r,!1),this},t}(kv);Ml.add("cartoon",wy);var xy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="contact",this.parameters=Object.assign({hydrogenBond:{type:"boolean",rebuild:!0},weakHydrogenBond:{type:"boolean",rebuild:!0},waterHydrogenBond:{type:"boolean",rebuild:!0},backboneHydrogenBond:{type:"boolean",rebuild:!0},hydrophobic:{type:"boolean",rebuild:!0},halogenBond:{type:"boolean",rebuild:!0},saltBridge:{type:"boolean",rebuild:!0},metalComplex:{type:"boolean",rebuild:!0},cationPi:{type:"boolean",rebuild:!0},piStacking:{type:"boolean",rebuild:!0},maxHydrophobicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondSulfurDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondAccAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondDonAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondAccDihedral:{type:"integer",max:90,min:0,rebuild:!0},maxHbondDonDihedral:{type:"integer",max:90,min:0,rebuild:!0},maxPiStackingDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingAngle:{type:"integer",max:180,min:0,rebuild:!0},maxCationPiDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxCationPiOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxSaltbridgeDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondAngle:{type:"integer",max:180,min:0,rebuild:!0},maxMetalDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},refineSaltBridges:{type:"boolean",rebuild:!0},radialSegments:!0,disableImpostor:!0},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.radiusSize=Ha(r.radiusSize,.05),this.hydrogenBond=Ha(r.hydrogenBond,!0),this.weakHydrogenBond=Ha(r.weakHydrogenBond,!1),this.waterHydrogenBond=Ha(r.waterHydrogenBond,!1),this.backboneHydrogenBond=Ha(r.backboneHydrogenBond,!1),this.hydrophobic=Ha(r.hydrophobic,!1),this.halogenBond=Ha(r.halogenBond,!0),this.saltBridge=Ha(r.saltBridge,!0),this.metalComplex=Ha(r.metalComplex,!0),this.cationPi=Ha(r.cationPi,!0),this.piStacking=Ha(r.piStacking,!0),this.maxHydrophobicDist=Ha(r.maxHydrophobicDist,4),this.maxHbondDist=Ha(r.maxHbondDist,3.5),this.maxHbondSulfurDist=Ha(r.maxHbondSulfurDist,4.1),this.maxHbondAccAngle=Ha(r.maxHbondAccAngle,60),this.maxHbondDonAngle=Ha(r.maxHbondDonAngle,45),this.maxHbondAccDihedral=Ha(r.maxHbondAccDihedral,45),this.maxHbondDonDihedral=Ha(r.maxHbondDonDihedral,45),this.maxPiStackingDist=Ha(r.maxPiStackingDist,5.5),this.maxPiStackingOffset=Ha(r.maxPiStackingOffset,2),this.maxPiStackingAngle=Ha(r.maxPiStackingAngle,30),this.maxCationPiDist=Ha(r.maxCationPiDist,6),this.maxCationPiOffset=Ha(r.maxCationPiOffset,1.5),this.maxSaltbridgeDist=Ha(r.maxSaltbridgeDist,4),this.maxHalogenBondDist=Ha(r.maxHalogenBondDist,3.5),this.maxHalogenBondAngle=Ha(r.maxHalogenBondAngle,30),this.maxMetalDist=Ha(r.maxMetalDist,3),this.refineSaltBridges=Ha(r.refineSaltBridges,!0),e.prototype.init.call(this,r)},t.prototype.getAtomRadius=function(){return 0},t.prototype.getContactData=function(e){var t={maxHydrophobicDist:this.maxHydrophobicDist,maxHbondDist:this.maxHbondDist,maxHbondSulfurDist:this.maxHbondSulfurDist,maxHbondAccAngle:this.maxHbondAccAngle,maxHbondDonAngle:this.maxHbondDonAngle,maxHbondAccDihedral:this.maxHbondAccDihedral,maxHbondDonDihedral:this.maxHbondDonDihedral,maxPiStackingDist:this.maxPiStackingDist,maxPiStackingOffset:this.maxPiStackingOffset,maxPiStackingAngle:this.maxPiStackingAngle,maxCationPiDist:this.maxCationPiDist,maxCationPiOffset:this.maxCationPiOffset,maxSaltBridgeDist:this.maxSaltbridgeDist,maxHalogenBondDist:this.maxHalogenBondDist,maxHalogenBondAngle:this.maxHalogenBondAngle,maxMetalDist:this.maxMetalDist,refineSaltBridges:this.refineSaltBridges},r={hydrogenBond:this.hydrogenBond,weakHydrogenBond:this.weakHydrogenBond,waterHydrogenBond:this.waterHydrogenBond,backboneHydrogenBond:this.backboneHydrogenBond,hydrophobic:this.hydrophobic,halogenBond:this.halogenBond,saltBridge:this.saltBridge,metalComplex:this.metalComplex,cationPi:this.cationPi,piStacking:this.piStacking,radius:this.radiusSize*this.radiusScale};return Xv(Ep(Mp(e,t),e,r))},t.prototype.createData=function(e){return{bufferList:[new cy(this.getContactData(e),this.getBufferParams({sphereDetail:1,dullInterior:!0,disableImpostor:this.disableImpostor}))]}},t}(kv);Ml.add("contact",xy);var _y=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="dihedral",this.parameters=Object.assign({atomQuad:{type:"hidden",rebuild:!0},lineVisible:{type:"boolean",default:!0},planeVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.side=Ha(r.side,"double"),r.opacity=Ha(r.opacity,.5),this.atomQuad=Ha(r.atomQuad,[]),this.lineVisible=Ha(r.lineVisible,!0),this.planeVisible=Ha(r.planeVisible,!0),this.sectorVisible=Ha(r.sectorVisible,!0),e.prototype.init.call(this,r)},t.prototype.create=function(){if(0!==this.structureView.atomCount){var e=function(e,t){for(var r=Ha((t=t||{}).angleStep,Math.PI/90),n=e.length,i=e.length/12,o=new Float32Array(i),a=new Float32Array(3*i),s=new Array(i),l=new Array(i),u=new Array(i),c=new Array(i),h=new Array(i),p=0,d=0,f=0,m=jc(),g=jc(),v=jc(),y=jc(),b=jc(),w=jc(),x=jc(),_=jc(),S=jc(),C=jc(),M=jc(),T=jc(),A=jc(),E=jc(),P=jc(),R=0,I=function(t){if(qc(m,e,t),qc(g,e,t+3),qc(v,e,t+6),qc(y,e,t+9),Gc(b,m,g),Gc(w,v,g),0!==Kc(w)){Gc(x,y,v),Zc(_,w,.5),Wc(S,g,_),Jc(b,b),Jc(w,w),Jc(x,x),Gc(_,m,S);var n=$c(_,w)>0;Gc(_,y,S);var i=$c(_,w)<0;if(Zc(_,w,$c(w,b)),Gc(C,b,_),Zc(_,w,$c(w,x)),Gc(M,x,_),0!==Kc(C)&&0!==Kc(M)){Jc(C,C),Jc(M,M);var I=o[R]=Math.acos($c(C,M));s[R]=(cu*I).toFixed(1)+String.fromCharCode(176),Hc(E,C,w),Jc(E,E),$c(E,M)<0&&nh(E,E),Lv(_,S,C,E,I/2),Xc(_,a,3*R);var N=Math.ceil(I/r),D=N+2,k=new Float32Array(3*D),O=new Float32Array(3*D),F=new Float32Array(9*N),L=new Float32Array(36);l[R]=k,u[R]=O,c[R]=F,h[R]=L,n?(Gc(_,m,v),Jc(_,_),Zc(T,_,1/$c(C,_)),Wc(T,T,v)):(Zc(T,b,1/$c(C,b)),Wc(T,T,g)),i?(Gc(_,y,g),Jc(_,_),Zc(A,_,1/$c(M,_)),Wc(A,A,g)):(Zc(A,x,1/$c(M,x)),Wc(A,A,v)),Wc(P,S,C),Xc(T,k,0),Xc(P,O,0),Xc(T,L,0),Xc(P,L,3),Xc(n?v:g,L,6),Xc(n?v:g,L,9),Xc(P,L,12),Xc(S,L,15);for(var U=function(e,t){var r=9*t,n=3*(t+1);Xc(S,F,r),Xc(P,F,r+3),Xc(P,k,n),Lv(P,S,C,E,e),Xc(P,F,r+6),Xc(P,O,n)},V=0,B=r;B<I;B+=r)U(B,V++);U(I,V++),Xc(P,k,3*(D-1)),Xc(A,O,3*(D-1)),Xc(A,L,18),Xc(P,L,21),Xc(i?g:v,L,24),Xc(i?g:v,L,27),Xc(P,L,30),Xc(S,L,33),p+=3*D,d+=9*N,f+=36,R+=1}}},N=0;N<n;N+=12)I(N);for(var D=R,k=new Float32Array(p),O=new Float32Array(p),F=new Float32Array(d),L=new Float32Array(f),U=0,V=0,B=0,z=0;z<D;z++){var j=l[z],H=u[z],$=c[z],G=h[z];bu(j,k,0,U,j.length),bu(H,O,0,U,H.length),bu($,F,0,V,$.length),bu(G,L,0,B,G.length),U+=j.length,V+=$.length,B+=G.length}return{labelPosition:a.subarray(0,3*D),labelText:s.slice(0,D),linePosition1:k,linePosition2:O,planePosition:L,sectorPosition:F}}(Fv(this.structureView,this.atomQuad),{planeVisible:this.planeVisible}),t=this.n=e.labelText.length,r=new ur(this.labelColor);this.textBuffer=new $v({position:e.labelPosition,size:fu(t,this.labelSize),color:mu(t,r.r,r.g,r.b),text:e.labelText},this.getLabelBufferParams());var n=new ur(this.colorValue);this.lineLength=e.linePosition1.length/3;var i=mu(this.lineLength,n.r,n.g,n.b);this.lineBuffer=new qv(Kv({position1:e.linePosition1,position2:e.linePosition2,color:i,color2:i}),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.planeLength=e.planePosition.length/3,this.planeBuffer=new Ud({position:e.planePosition,color:mu(this.planeLength,n.r,n.g,n.b)},this.getBufferParams({visible:!1})),this.sectorLength=e.sectorPosition.length/3,this.sectorBuffer=new Ud({position:e.sectorPosition,color:mu(this.sectorLength,n.r,n.g,n.b)},this.getBufferParams({visible:this.sectorVisible})),this.dataList.push({sview:this.structureView,bufferList:[this.textBuffer,this.lineBuffer,this.planeBuffer,this.sectorBuffer]})}},t.prototype.updateData=function(t,r){e.prototype.updateData.call(this,t,r);var n={},i={},o={};if(t.color){var a=new ur(this.colorValue);n.color=n.color2=mu(this.lineLength,a.r,a.g,a.b),i.color=mu(this.planeLength,a.r,a.g,a.b),o.color=mu(this.sectorLength,a.r,a.g,a.b)}this.lineBuffer.setAttributes(n),this.planeBuffer.setAttributes(i),this.sectorBuffer.setAttributes(o)},t.prototype.setParameters=function(t){return e.prototype.setParameters.call(this,t,{},!1),!t||void 0===t.lineVisible&&void 0===t.sectorVisible||this.setVisibility(this.visible),t&&t.lineOpacity&&this.lineBuffer.setParameters({opacity:t.lineOpacity}),t&&void 0!==t.opacity&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),t&&t.linewidth&&this.lineBuffer.setParameters({linewidth:t.linewidth}),this},t.prototype.setVisibility=function(t,r){return e.prototype.setVisibility.call(this,t,!0),this.lineBuffer&&this.lineBuffer.setVisibility(this.lineVisible&&this.visible),this.planeBuffer&&this.planeBuffer.setVisibility(this.planeVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),r||this.viewer.requestRender(),this},t}(Ov);Ml.add("dihedral",_y);var Sy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="distance",this.parameters=Object.assign({labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},atomPair:{type:"hidden",rebuild:!0}},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.linewidth=Ha(r.linewidth,5),this.labelUnit=Ha(r.labelUnit,""),this.atomPair=Ha(r.atomPair,[]),e.prototype.init.call(this,r)},t.prototype.getDistanceData=function(e,t){var r=t.length,n=new Array(r),i=new Float32Array(3*r),o=new el,a=new el,s=new yf,l=e.getAtomProxy(),u=e.getAtomProxy(),c=0;t.forEach(function(t,r){var h=t[0],p=t[1];if(Number.isInteger(h)&&Number.isInteger(p))l.index=h,u.index=p;else{o.setString(h),a.setString(p);var d=e.getAtomIndices(o),f=e.getAtomIndices(a);if(!d.length||!f.length)return void(c+=1);l.index=d[0],u.index=f[0]}s.addBond(l,u,1),r-=c;var m=l.distanceTo(u);switch(this.labelUnit){case"angstrom":n[r]=m.toFixed(2)+" "+String.fromCharCode(8491);break;case"nm":n[r]=(m/10).toFixed(2)+" nm";break;default:n[r]=m.toFixed(2)}var g=3*r;i[g+0]=(l.x+u.x)/2,i[g+1]=(l.y+u.y)/2,i[g+2]=(l.z+u.z)/2},this),c>0&&(r-=c,i=i.subarray(0,3*r));var h=new xh(s.count,!0);return{text:n,position:i,bondSet:h,bondStore:s}},t.prototype.getBondData=function(e,t,r){var n=e.getBondData(this.getBondParams(t,r));return n.picking&&(n.picking=new Bp(n.picking.array,n.picking.structure,r.bondStore)),n},t.prototype.create=function(){if(0!==this.structureView.atomCount){var e=this.atomPair.length;if(0!==e){var t=this.getDistanceData(this.structureView,this.atomPair),r=new ur(this.labelColor);this.textBuffer=new $v({position:t.position,size:fu(e,this.labelSize),color:mu(e,r.r,r.g,r.b),text:t.text},this.getLabelBufferParams());var n={bondSet:t.bondSet,bondStore:t.bondStore},i=this.getBondData(this.structureView,{position:!0,color:!0,picking:!0},n);this.lineBuffer=new qv(function(e,t){void 0===t&&(t=.1);for(var r=du(e.position1,e.position2),n=[],i=[],o=[],a=e.radius?[]:void 0,s=e.picking?[]:void 0,l=e.primitiveId?[]:void 0,u=new ft,c=e.position1.length/3,h=0,p=0;p<c;++p){var d=3*p;u.set(r[d],r[d+1],r[d+2]);for(var f=u.length()/t,m=Math.floor(f/2),g=1/f,v=e.position1[d],y=e.position1[d+1],b=e.position1[d+2],w=0;w<m;++w){var x=3*h+3*w,_=g*(2*w+1),S=g*(2*w+2);n[x]=v+u.x*_,n[x+1]=y+u.y*_,n[x+2]=b+u.z*_,i[x]=v+u.x*S,i[x+1]=y+u.y*S,i[x+2]=b+u.z*S,e.color&&(o[x]=e.color[d],o[x+1]=e.color[d+1],o[x+2]=e.color[d+2]),a&&(a[h*p+w]=e.radius[p]),s&&(s[h*p+w]=e.picking.array[p]),l&&(l[h*p+w]=e.primitiveId[p])}h+=m}var C=new Float32Array(n),M=new Float32Array(i),T=pu(C,M),A=new Float32Array(o),E={position:T,position1:C,position2:M,color:A,color2:A};return a&&(E.radius=new Float32Array(a)),s&&e.picking&&(e.picking.array=new Float32Array(s),E.picking=e.picking),l&&(E.primitiveId=new Float32Array(l)),E}(i),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.dataList.push({sview:this.structureView,bondSet:t.bondSet,bondStore:t.bondStore,position:t.position,bufferList:[this.textBuffer,this.lineBuffer]})}}},t.prototype.updateData=function(e,t){var r={bondSet:t.bondSet,bondStore:t.bondStore},n=this.getBondData(t.sview,e,r),i={},o={},a=this.atomPair.length;if(e.labelSize&&(o.size=fu(a,this.labelSize)),e.labelColor){var s=new ur(this.labelColor);o.color=mu(a,s.r,s.g,s.b)}e.color&&(i.color=n.color,i.color2=n.color2),(e.radius||e.scale)&&(i.radius=n.radius),this.textBuffer.setAttributes(o),this.lineBuffer.setAttributes(i)},t.prototype.setParameters=function(t){return e.prototype.setParameters.call(this,t,{},!1),t&&t.lineOpacity&&this.lineBuffer.setParameters({opacity:t.lineOpacity}),t&&void 0!==t.opacity&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),t&&t.linewidth&&this.lineBuffer.setParameters({linewidth:t.linewidth}),this},t}(Ov);function Cy(e){return 2*(e.position.length/3)*3}Ml.add("distance",Sy);var My=Object.assign({scale:1,color:"grey"},kd),Ty=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,{position:new Float32Array(Cy(t)),color:new Float32Array(Cy(t))},r),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag";var n=new ur(this.parameters.color),i=this.geometry.attributes;mu(Cy(t)/3,n.r,n.g,n.b,i.color.array),this.setAttributes(t)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return My},t.prototype.setAttributes=function(e){void 0===e&&(e={});var t,r,n,i=this.geometry.attributes;e.position&&e.vector&&(t=e.position,r=e.vector,n=i.position.array,i.position.needsUpdate=!0);var o=this.size/2,a=this.parameters.scale;if(t&&r)for(var s=0;s<o;s++){var l=2*s*3,u=3*s;n[l+0]=t[u+0],n[l+1]=t[u+1],n[l+2]=t[u+2],n[l+3]=t[u+0]+r[u+0]*a,n[l+4]=t[u+1]+r[u+1]*a,n[l+5]=t[u+2]+r[u+2]*a}},Object.defineProperties(t.prototype,r),t}(Fd),Ay=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="helixorient",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"sstruc"),r.radiusType=Ha(r.radiusType,"size"),r.radiusSize=Ha(r.radiusSize,.15),r.radiusScale=Ha(r.radiusScale,1),e.prototype.init.call(this,r)},t.prototype.createData=function(e){var t=this,r=[],n=[];return this.structure.eachPolymer(function(e){if(!(e.residueCount<4)){n.push(e);var i=new Sf(e),o=i.getPosition(),a=i.getColor(t.getColorParams()),s=i.getSize(t.getRadiusParams()),l=i.getPicking();r.push(new Xm({position:o.center,color:a.color,radius:s.size,picking:l.picking},t.getBufferParams({sphereDetail:t.sphereDetail,disableImpostor:t.disableImpostor,dullInterior:!0})),new Ty({position:o.center,vector:o.axis},t.getBufferParams({color:"skyblue",scale:1})),new Ty({position:o.center,vector:o.resdir},t.getBufferParams({color:"lightgreen",scale:1})))}},e.getSelection()),{bufferList:r,polymerList:n}},t.prototype.updateData=function(e,t){vl&&gl.time(this.type+" repr update"),e=e||{};for(var r=0,n=t.polymerList.length;r<n;++r){var i=3*r,o={},a=t.polymerList[r],s=new Sf(a);if(e.position){var l=s.getPosition();o.position=l.center,t.bufferList[i+1].setAttributes({position:l.center,vector:l.axis}),t.bufferList[i+2].setAttributes({position:l.center,vector:l.resdir})}t.bufferList[i].setAttributes(o)}vl&&gl.timeEnd(this.type+" repr update")},t}(kv);Ml.add("helixorient",Ay);var Ey=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="licorice",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.aspectRatio=1,e.prototype.init.call(this,r)},t}(py);Ml.add("licorice",Ey),Al.add("shader/HyperballStickImpostor.vert","\nattribute vec3 mapping;\nattribute float radius;\nattribute float radius2;\nattribute vec3 position1;\nattribute vec3 position2;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\nattribute vec3 color2;\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#endif\nuniform float shrink;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewProjectionMatrixInverse;\nvoid main(){\nvRadius = radius;\nvRadius2 = radius2;\nvec4 spaceposition;\nvec3 position_atom1;\nvec3 position_atom2;\nvec4 vertex_position;\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\nvColor1 = color;\nvColor2 = color2;\n#endif\nfloat radius1 = radius;\nposition_atom1 = position1;\nposition_atom2 = position2;\nfloat distance = distance( position_atom1, position_atom2 );\nspaceposition.z = mapping.z * distance;\nif (radius1 > radius2) {\nspaceposition.y = mapping.y * 1.5 * radius1;\nspaceposition.x = mapping.x * 1.5 * radius1;\n} else {\nspaceposition.y = mapping.y * 1.5 * radius2;\nspaceposition.x = mapping.x * 1.5 * radius2;\n}\nspaceposition.w = 1.0;\nvec4 e3 = vec4( 1.0 );\nvec3 e1, e1_temp, e2, e2_temp;\ne3.xyz = normalize(position_atom1-position_atom2);\nif (e3.z == 0.0) { e3.z = 0.0000000000001;}\nif ( (position_atom1.x - position_atom2.x) == 0.0) { position_atom1.x += 0.001;}\nif ( (position_atom1.y - position_atom2.y) == 0.0) { position_atom1.y += 0.001;}\nif ( (position_atom1.z - position_atom2.z) == 0.0) { position_atom1.z += 0.001;}\nvec4 focus = vec4( 1.0 );\nfocus.x = ( position_atom1.x*position_atom1.x - position_atom2.x*position_atom2.x +\n( radius2*radius2 - radius1*radius1 )*e3.x*e3.x/shrink )/(2.0*(position_atom1.x - position_atom2.x));\nfocus.y = ( position_atom1.y*position_atom1.y - position_atom2.y*position_atom2.y +\n( radius2*radius2 - radius1*radius1 )*e3.y*e3.y/shrink )/(2.0*(position_atom1.y - position_atom2.y));\nfocus.z = ( position_atom1.z*position_atom1.z - position_atom2.z*position_atom2.z +\n( radius2*radius2 - radius1*radius1 )*e3.z*e3.z/shrink )/(2.0*(position_atom1.z - position_atom2.z));\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2_temp = e1.yzx * e3.zxy - e1.zxy * e3.yzx;\ne2 = normalize(e2_temp);\nmat3 R= mat3( e1.xyz, e2.xyz, e3.xyz );\nvertex_position.xyz = R * spaceposition.xyz;\nvertex_position.w = 1.0;\nvertex_position.x += (position_atom1.x+position_atom2.x) / 2.0;\nvertex_position.y += (position_atom1.y+position_atom2.y) / 2.0;\nvertex_position.z += (position_atom1.z+position_atom2.z) / 2.0;\ngl_Position = modelViewProjectionMatrix * vertex_position;\nvec4 i_near, i_far;\nvec4 near = gl_Position;\nnear.z = 0.0 ;\nnear = modelViewProjectionMatrixInverse * near;\ni_near = near;\nvec4 far = gl_Position;\nfar.z = far.w ;\ni_far = modelViewProjectionMatrixInverse * far;\nprime1 = vec4( position_atom1 - (position_atom1 - focus.xyz)*shrink, 1.0 );\nprime2 = vec4( position_atom2 - (position_atom2 - focus.xyz)*shrink, 1.0 );\nfloat Rsquare = (radius1*radius1/shrink) - (\n(position_atom1.x - focus.x)*(position_atom1.x - focus.x) +\n(position_atom1.y - focus.y)*(position_atom1.y - focus.y) +\n(position_atom1.z - focus.z)*(position_atom1.z - focus.z)\n);\nfocus.w = Rsquare;\nmatrix_near = mat4( i_near, i_far, focus, e3 );\ngl_Position.z = 1.0;\n}"),Al.add("shader/HyperballStickImpostor.frag","#define STANDARD\n#define IMPOSTOR\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\nuniform float clipNear;\nuniform float shrink;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrixInverseTranspose;\nuniform mat4 projectionMatrix;\nvarying mat4 matrix_near;\nvarying vec4 prime1;\nvarying vec4 prime2;\nvarying float vRadius;\nvarying float vRadius2;\n#ifdef PICKING\nuniform float objectId;\nvarying vec3 vPickingColor;\n#else\nvarying vec3 vColor1;\nvarying vec3 vColor2;\n#include common\n#include fog_pars_fragment\n#include bsdfs\n#include lights_pars\n#include lights_physical_pars_fragment\n#endif\nbool interior = false;\nfloat calcClip( vec4 cameraPos ){\nreturn dot( cameraPos, vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );\n}\nfloat calcClip( vec3 cameraPos ){\nreturn calcClip( vec4( cameraPos, 1.0 ) );\n}\nfloat calcDepth( in vec3 cameraPos ){\nvec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;\nreturn 0.5 + 0.5 * clipZW.x / clipZW.y;\n}\nstruct Ray {\nvec3 origin ;\nvec3 direction ;\n};\nbool cutoff_plane (vec3 M, vec3 cutoff, vec3 x3){\nfloat a = x3.x;\nfloat b = x3.y;\nfloat c = x3.z;\nfloat d = -x3.x*cutoff.x-x3.y*cutoff.y-x3.z*cutoff.z;\nfloat l = a*M.x+b*M.y+c*M.z+d;\nif (l<0.0) {return true;}\nelse{return false;}\n}\nvec3 isect_surf(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t1 =(-b-sqrt(delta))/a;\nreturn r.origin+t1*r.direction;\n}\nvec3 isect_surf2(Ray r, mat4 matrix_coef){\nvec4 direction = vec4(r.direction, 0.0);\nvec4 origin = vec4(r.origin, 1.0);\nfloat a = dot(direction,(matrix_coef*direction));\nfloat b = dot(origin,(matrix_coef*direction));\nfloat c = dot(origin,(matrix_coef*origin));\nfloat delta =b*b-a*c;\ngl_FragColor.a = 1.0;\nif (delta<0.0){\ndiscard;\n}\nfloat t2 =(-b+sqrt(delta))/a;\nreturn r.origin+t2*r.direction;\n}\nRay primary_ray(vec4 near1, vec4 far1){\nvec3 near=near1.xyz/near1.w;\nvec3 far=far1.xyz/far1.w;\nreturn Ray(near,far-near);\n}\nfloat update_z_buffer(vec3 M, mat4 ModelViewP){\nfloat depth1;\nvec4 Ms=(ModelViewP*vec4(M,1.0));\nreturn depth1=(1.0+Ms.z/Ms.w)/2.0;\n}\nvoid main(){\nfloat radius = max( vRadius, vRadius2 );\nvec4 i_near, i_far, focus;\nvec3 e3, e1, e1_temp, e2;\ni_near = vec4(matrix_near[0][0],matrix_near[0][1],matrix_near[0][2],matrix_near[0][3]);\ni_far = vec4(matrix_near[1][0],matrix_near[1][1],matrix_near[1][2],matrix_near[1][3]);\nfocus = vec4(matrix_near[2][0],matrix_near[2][1],matrix_near[2][2],matrix_near[2][3]);\ne3 = vec3(matrix_near[3][0],matrix_near[3][1],matrix_near[3][2]);\ne1.x = 1.0;\ne1.y = 1.0;\ne1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;\ne1_temp = e1 - focus.xyz;\ne1 = normalize(e1_temp);\ne2 = normalize(cross(e1,e3));\nvec4 equation = focus;\nfloat shrinkfactor = shrink;\nfloat t1 = -1.0/(1.0-shrinkfactor);\nfloat t2 = 1.0/(shrinkfactor);\nvec4 colonne1, colonne2, colonne3, colonne4;\nmat4 mat;\nvec3 equation1 = vec3(t2,t2,t1);\nfloat A1 = - e1.x*equation.x - e1.y*equation.y - e1.z*equation.z;\nfloat A2 = - e2.x*equation.x - e2.y*equation.y - e2.z*equation.z;\nfloat A3 = - e3.x*equation.x - e3.y*equation.y - e3.z*equation.z;\nfloat A11 = equation1.x*e1.x*e1.x + equation1.y*e2.x*e2.x + equation1.z*e3.x*e3.x;\nfloat A21 = equation1.x*e1.x*e1.y + equation1.y*e2.x*e2.y + equation1.z*e3.x*e3.y;\nfloat A31 = equation1.x*e1.x*e1.z + equation1.y*e2.x*e2.z + equation1.z*e3.x*e3.z;\nfloat A41 = equation1.x*e1.x*A1 + equation1.y*e2.x*A2 + equation1.z*e3.x*A3;\nfloat A22 = equation1.x*e1.y*e1.y + equation1.y*e2.y*e2.y + equation1.z*e3.y*e3.y;\nfloat A32 = equation1.x*e1.y*e1.z + equation1.y*e2.y*e2.z + equation1.z*e3.y*e3.z;\nfloat A42 = equation1.x*e1.y*A1 + equation1.y*e2.y*A2 + equation1.z*e3.y*A3;\nfloat A33 = equation1.x*e1.z*e1.z + equation1.y*e2.z*e2.z + equation1.z*e3.z*e3.z;\nfloat A43 = equation1.x*e1.z*A1 + equation1.y*e2.z*A2 + equation1.z*e3.z*A3;\nfloat A44 = equation1.x*A1*A1 + equation1.y*A2*A2 + equation1.z*A3*A3 - equation.w;\ncolonne1 = vec4(A11,A21,A31,A41);\ncolonne2 = vec4(A21,A22,A32,A42);\ncolonne3 = vec4(A31,A32,A33,A43);\ncolonne4 = vec4(A41,A42,A43,A44);\nmat = mat4(colonne1,colonne2,colonne3,colonne4);\nRay ray = primary_ray(i_near,i_far) ;\nvec3 M;\nM = isect_surf(ray, mat);\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nvec4 M1 = vec4(M,1.0);\nvec4 M2 = mat*M1;\nvec3 _normal = ( modelViewMatrixInverseTranspose * M2 ).xyz;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\n#ifdef NEAR_CLIP\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 ){\nM = isect_surf2(ray, mat);\nif( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 )\ndiscard;\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / radius ) );\n}\n}else if( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix);\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#else\nif( gl_FragDepthEXT <= 0.0 ){\nM = isect_surf2(ray, mat);\ninterior = true;\ngl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;\nif( gl_FragDepthEXT >= 0.0 ){\ngl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );\n}\n}\n#endif\nif (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }\nif (gl_FragDepthEXT < 0.0)\ndiscard;\nif (gl_FragDepthEXT > 1.0)\ndiscard;\nfloat distance_ratio = ((M.x-prime2.x)*e3.x + (M.y-prime2.y)*e3.y +(M.z-prime2.z)*e3.z) /\ndistance(prime2.xyz,prime1.xyz);\n#ifdef PICKING\ngl_FragColor = vec4( vPickingColor, objectId );\n#else\nvec3 vViewPosition = -( modelViewMatrix * vec4( M, 1.0 ) ).xyz;\nvec3 vNormal = _normal;\nvec3 vColor;\nif( distance_ratio>0.5 ){\nvColor = vColor1;\n}else{\nvColor = vColor2;\n}\nvec4 diffuseColor = vec4( diffuse, opacity );\nReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\nvec3 totalEmissiveLight = emissive;\n#include color_fragment\n#include roughnessmap_fragment\n#include metalnessmap_fragment\nvec3 normal = normalize( vNormal );\nif( interior ){\nnormal = vec3( 0.0, 0.0, 0.4 );\n}\n#include lights_physical_fragment\n#include lights_template\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n#include premultiplied_alpha_fragment\n#include tonemapping_fragment\n#include encodings_fragment\n#include fog_fragment\n#endif\n}");var Py=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]),Ry=new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]),Iy=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={mapping:{configurable:!0},mappingIndices:{configurable:!0},mappingIndicesSize:{configurable:!0},mappingType:{configurable:!0},mappingSize:{configurable:!0},mappingItemSize:{configurable:!0}};return r.mapping.get=function(){return Py},r.mappingIndices.get=function(){return Ry},r.mappingIndicesSize.get=function(){return 36},r.mappingType.get=function(){return"v3"},r.mappingSize.get=function(){return 8},r.mappingItemSize.get=function(){return 3},Object.defineProperties(t.prototype,r),t}(Hm),Ny=Object.assign({shrink:.14},kd),Dy=Object.assign({shrink:{uniform:!0}},Od),ky=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r),this.parameterTypes=Dy,this.isImpostor=!0,this.vertexShader="HyperballStickImpostor.vert",this.fragmentShader="HyperballStickImpostor.frag",this.addUniforms({modelViewProjectionMatrix:{value:new pt},modelViewProjectionMatrixInverse:{value:new pt},modelViewMatrixInverseTranspose:{value:new pt},shrink:{value:this.parameters.shrink}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null}}),this.setAttributes(t),this.makeMapping()}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return Ny},Object.defineProperties(t.prototype,r),t}(Iy),Oy=(Object.assign({disableImpostor:!1},ty,Ny),function(e,t){return void 0===t&&(t={}),!ml||t&&t.disableImpostor?(e.radius=function(e,t){for(var r=e.length,n=new Float32Array(r),i=0;i<r;i++)n[i]=Math.min(e[i],t[i]);return n}(e.radius,e.radius2),new ny(e,t)):new ky(e,t)}),Fy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="hyperball",this.parameters=Object.assign({shrink:{type:"number",precision:3,max:1,min:.001,buffer:!0}},this.parameters,{multipleBond:null,bondSpacing:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.radiusScale=Ha(r.radiusScale,.2),r.radiusType=Ha(r.radiusType,"vdw"),this.shrink=Ha(r.shrink,.12),e.prototype.init.call(this,r)},t.prototype.getBondParams=function(t,r){return t&&!t.radius||(r=Object.assign({radius2:!0},r)),e.prototype.getBondParams.call(this,t,r)},t.prototype.createData=function(e){var t=new Xm(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));return this.__center=new Float32Array(3*e.bondCount),{bufferList:[t,new Oy(e.getBondData(this.getBondParams()),this.getBufferParams({shrink:this.shrink,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))]}},t.prototype.updateData=function(e,t){var r=t.sview.getAtomData(this.getAtomParams()),n=t.sview.getBondData(this.getBondParams()),i={},o={};if(!e||e.position){i.position=r.position;var a=n.position1,s=n.position2;o.position=pu(a,s,this.__center),o.position1=a,o.position2=s}e&&!e.color||(i.color=r.color,o.color=n.color,o.color2=n.color2),e&&!e.radius||(i.radius=r.radius,o.radius=n.radius,o.radius2=n.radius2),t.bufferList[0].setAttributes(i),t.bufferList[1].setAttributes(o)},t}(Ey);Ml.add("hyperball",Fy);var Ly=function(e,t){void 0===t&&(t={}),this.type=e,this.text=t};Ly.prototype.atomLabel=function(e){var t;switch(this.type){case"atomname":t=e.atomname;break;case"atomindex":t=""+e.index;break;case"occupancy":t=e.occupancy.toFixed(2);break;case"bfactor":t=e.bfactor.toFixed(2);break;case"serial":t=""+e.serial;break;case"element":t=e.element;break;case"atom":t=e.atomname+"|"+e.index;break;case"resname":t=e.resname;break;case"resno":t=""+e.resno;break;case"res":var r=e.resname.toUpperCase();t=(qh[r]||r)+e.resno;break;case"text":t=this.text[e.index];break;default:t=e.qualifiedName()}return void 0===t?"":t},Ly.types={"":"",atomname:"atom name",atomindex:"atom index",occupancy:"occupancy",bfactor:"b-factor",serial:"serial",element:"element",atom:"atom name + index",resname:"residue name",resno:"residue no",res:"residue name + no",text:"text",qualified:"qualified name"};var Uy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="label",this.parameters=Object.assign({labelType:{type:"select",options:Ly.types,rebuild:!0},labelText:{type:"hidden",rebuild:!0},fontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:!0},fontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:!0},fontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:!0},sdf:{type:"boolean",buffer:!0},xOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},yOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},zOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},attachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},showBorder:{type:"boolean",buffer:!0},borderColor:{type:"color",buffer:!0},borderWidth:{type:"number",precision:2,max:.3,min:0,buffer:!0},showBackground:{type:"boolean",rebuild:!0},backgroundColor:{type:"color",buffer:!0},backgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},backgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:!0}},this.parameters,{side:null,flatShaded:null,wireframe:null,linewidth:null,roughness:null,metalness:null,diffuse:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};this.labelType=Ha(r.labelType,"res"),this.labelText=Ha(r.labelText,{}),this.fontFamily=Ha(r.fontFamily,"sans-serif"),this.fontStyle=Ha(r.fontStyle,"normal"),this.fontWeight=Ha(r.fontWeight,"bold"),this.sdf=Ha(r.sdf,"Chrome"===cl),this.xOffset=Ha(r.xOffset,0),this.yOffset=Ha(r.yOffset,0),this.zOffset=Ha(r.zOffset,.5),this.attachment=Ha(r.attachment,"bottom-left"),this.showBorder=Ha(r.showBorder,!1),this.borderColor=Ha(r.borderColor,"lightgrey"),this.borderWidth=Ha(r.borderWidth,.15),this.showBackground=Ha(r.showBackground,!1),this.backgroundColor=Ha(r.backgroundColor,"lightgrey"),this.backgroundMargin=Ha(r.backgroundMargin,.5),this.backgroundOpacity=Ha(r.backgroundOpacity,1),e.prototype.init.call(this,r)},t.prototype.createData=function(e){var t=e.getAtomData(this.getAtomParams({position:!0,color:!0,radius:!0})),r=[],n=new Ly(this.labelType,this.labelText);return e.eachAtom(function(e){r.push(n.atomLabel(e))}),{bufferList:[new $v({position:t.position,size:t.radius,color:t.color,text:r},this.getBufferParams({fontFamily:this.fontFamily,fontStyle:this.fontStyle,fontWeight:this.fontWeight,sdf:this.sdf,xOffset:this.xOffset,yOffset:this.yOffset,zOffset:this.zOffset,attachment:this.attachment,showBorder:this.showBorder,borderColor:this.borderColor,borderWidth:this.borderWidth,showBackground:this.showBackground,backgroundColor:this.backgroundColor,backgroundMargin:this.backgroundMargin,backgroundOpacity:this.backgroundOpacity}))]}},t.prototype.updateData=function(e,t){var r=t.sview.getAtomData(this.getAtomParams(e)),n={};e&&!e.position||(n.position=r.position),e&&!e.radius||(n.size=r.radius),e&&!e.color||(n.color=r.color),t.bufferList[0].setAttributes(n)},t}(kv);Ml.add("label",Uy);var Vy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="line",this.parameters=Object.assign({multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0},lines:{type:"boolean",rebuild:!0},crosses:{type:"select",rebuild:!0,options:{off:"off",lone:"lone",all:"all"}},crossSize:{type:"number",precision:2,max:2,min:.1}},this.parameters,{flatShaded:null,side:null,wireframe:null,roughness:null,metalness:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};this.multipleBond=Ha(r.multipleBond,"off"),this.bondSpacing=Ha(r.bondSpacing,1),this.linewidth=Ha(r.linewidth,2),this.lines=Ha(r.lines,!0),this.crosses=Ha(r.crosses,"lone"),this.crossSize=Ha(r.crossSize,.4),e.prototype.init.call(this,r)},t.prototype.getAtomRadius=function(e){return.1},t.prototype.getBondParams=function(t,r){return r=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,radiusParams:{type:"size",size:.1,scale:1}},r),e.prototype.getBondParams.call(this,t,r)},t.prototype._crossData=function(e,t){if(!e||e.position||e.color){var r={};"lone"===this.crosses&&(r.atomSet=function(e){var t=e.getAtomSet(),r=e.getBondSet(),n=e.getBondProxy();return r.forEach(function(e){n.index=e,t.clear(n.atomIndex1),t.clear(n.atomIndex2)}),t}(t));var n,i,o,a,s,l,u=t.getAtomData(this.getAtomParams(e,r)),c={},h=u.position,p=u.color,d=u.picking,f=(h||p).length,m=3*f;e&&!e.position||(n=c.position1=new Float32Array(m),i=c.position2=new Float32Array(m),s=this.crossSize/2),e&&!e.color||(o=c.color=new Float32Array(m),a=c.color2=new Float32Array(m)),e&&!e.picking||(l=new Float32Array(3*u.picking.array.length));for(var g=0;g<f;g++){var v=3*g,y=3*v;if(!e||e.position){var b=h[v],w=h[v+1],x=h[v+2];n[y]=b-s,n[y+1]=w,n[y+2]=x,i[y]=b+s,i[y+1]=w,i[y+2]=x,n[y+3]=b,n[y+4]=w-s,n[y+5]=x,i[y+3]=b,i[y+4]=w+s,i[y+5]=x,n[y+6]=b,n[y+7]=w,n[y+8]=x-s,i[y+6]=b,i[y+7]=w,i[y+8]=x+s}if(!e||e.color)for(var _=y+9,S=y;S<_;S+=3)o[S]=a[S]=p[v],o[S+1]=a[S+1]=p[v+1],o[S+2]=a[S+2]=p[v+2];e&&!e.picking||(l[v]=l[v+1]=l[v+2]=d.array[g])}return e&&!e.picking||(c.picking=new kp(l,u.picking.structure)),c}},t.prototype.createData=function(e){var t={position:!0,color:!0,picking:!0},r=[];if(this.lines){var n=e.getBondData(this.getBondParams(t)),i=new qv(n,this.getBufferParams({linewidth:this.linewidth}));r.push(i)}if("off"!==this.crosses){var o=new qv(this._crossData(t,e),this.getBufferParams({linewidth:this.linewidth}));r.push(o)}return{bufferList:r}},t.prototype.updateData=function(e,t){var r=0;if(this.lines){var n=t.sview.getBondData(this.getBondParams(e)),i={};e&&!e.position||(i.position1=n.position1,i.position2=n.position2),e&&!e.color||(i.color=n.color,i.color2=n.color2),t.bufferList[r++].setAttributes(i)}if("off"!==this.crosses){var o=this._crossData(e,t.sview),a={};e&&!e.position||(a.position1=o.position1,a.position2=o.position2),e&&!e.color||(a.color=o.color,a.color2=o.color2),t.bufferList[r++].setAttributes(a)}},t.prototype.setParameters=function(t){var r={};return t&&(t.bondSpacing||t.crossSize)&&(r.position=!0),e.prototype.setParameters.call(this,t,r,!1),this},t}(kv);function By(e,t,r,n,i){var o,a=new(n=n||Int32Array)(e*t*r*(i=i||1));function s(e,n,o){return((e*t+n)*r+o)*i}this.data=a,this.index=s,this.set=function(e,t,r){var n=arguments,l=s(e,t,r);for(o=0;o<i;++o)a[l+o]=n[3+o]},this.toArray=function(e,t,r,n,l){var u=s(e,t,r);for(void 0===n&&(n=[]),void 0===l&&(l=0),o=0;o<i;++o)n[l+o]=a[u+o]},this.fromArray=function(e,t,r,n,l){var u=s(e,t,r);for(void 0===l&&(l=0),o=0;o<i;++o)a[u+o]=n[l+o]},this.copy=function(e){this.data.set(e.data)},this.clone=function(){return new By(e,t,r,n,i).copy(this)}}function zy(e,t,r){var n=Cd(t),i=Uc(e);0===e.length&&(i[0].set([0,0,0]),i[1].set([0,0,0]));var o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w=i[0],x=i[1];function _(e,t,r,i,_){o=t||1.4,a=r||2,g=_||!0;var S=0;for(var C in n)S=Math.max(S,C);var M=Md(w,x,S,a,e?o:0);l=M.dim[0],u=M.dim[1],c=M.dim[2],h=M.matrix,p=M.tran,a=M.scaleFactor,d={},f={},A(e),m=o*a,s=i||o/a,v=new Uint8Array(l*u*c),e&&(y=new Float64Array(l*u*c)),g&&(b=new Int32Array(l*u*c))}var S=1,C=2,M=4,T=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];function A(e){var t,r,i,s,l,u,c,h,p,m;for(var g in n)if(t=n[g],!d[g]){for(u=(c=e?(t+o)*a+.5:t*a+.5)*c,h=Math.floor(c)+1,p=new Int32Array(h*h),m=0,r=0;r<h;++r)for(i=0;i<h;++i)(s=r*r+i*i)>u?p[m]=-1:(l=Math.sqrt(u-s),p[m]=Math.floor(l)),++m;f[g]=h,d[g]=p}}function E(r){var n,i,o,s,h,m,y,w,x,_,C,M,T,A,E,P,R,I,N=3*r,D=r;n=Math.floor(.5+a*(e[N]+p[0])),i=Math.floor(.5+a*(e[N+1]+p[1])),o=Math.floor(.5+a*(e[N+2]+p[2]));var k,O=t[D],F=d[O],L=0,U=u*c,V=f[O];for(_=0;_<V;++_)for(C=0;C<V;++C){if(-1!==(k=F[L]))for(P=-1;P<2;++P)for(R=-1;R<2;++R)for(I=-1;I<2;++I)if(0!==P&&0!==R&&0!==I)for(y=P*_,x=I*C,M=0;M<=k;++M)if(A=i+(w=M*R),E=o+x,!((T=n+y)<0||A<0||E<0||T>=l||A>=u||E>=c)){var B=T*U+A*c+E;if(g)if(v[B]&S){if(v[B]&S){var z=b[B];z!==N&&y*y+w*w+x*x<(s=n+y-Math.floor(.5+a*(e[z]+p[0])))*s+(h=i+w-Math.floor(.5+a*(e[z+1]+p[1])))*h+(m=o+x-Math.floor(.5+a*(e[z+2]+p[2])))*m&&(b[B]=r)}}else v[B]|=S,b[B]=r;else v[B]|=S}L++}}function P(t){var r,n;for(console.time("EDTSurface fillvoxels"),r=0,n=v.length;r<n;++r)v[r]=0,t&&(y[r]=-1),g&&(b[r]=-1);for(r=0,n=e.length/3;r<n;++r)E(r);for(r=0,n=v.length;r<n;++r)v[r]&S&&(v[r]|=C);console.timeEnd("EDTSurface fillvoxels")}function R(r){var n,i,o,s,h,m,y,w,x,_,S,M,T,A,E,P,R,I,N,D=3*r,k=r,O=0;n=Math.floor(.5+a*(e[D]+p[0])),i=Math.floor(.5+a*(e[D+1]+p[1])),o=Math.floor(.5+a*(e[D+2]+p[2]));var F=t[k],L=u*c;for(T=0,N=f[F];T<N;++T)for(A=0;A<N;++A){if(-1!==d[F][O])for(P=-1;P<2;++P)for(R=-1;R<2;++R)for(I=-1;I<2;++I)if(0!==P&&0!==R&&0!==I)for(y=P*T,x=I*A,E=0;E<=d[F][O];++E)if(S=i+(w=E*R),M=o+x,!((_=n+y)<0||S<0||M<0||_>=l||S>=u||M>=c)){var U=_*L+S*c+M;if(v[U]&C){if(g){var V=b[U];y*y+w*w+x*x<(s=Math.floor(.5+a*(e[V]+p[0])))*s+(h=Math.floor(.5+a*(e[V+1]+p[1])))*h+(m=Math.floor(.5+a*(e[V+2]+p[2])))*m&&(b[U]=r)}}else v[U]|=C,g&&(b[U]=r)}O++}}function I(){var e,t,r,n;console.time("EDTSurface fastdistancemap");var i,o=new By(l,u,c,Uint16Array,3),a=u*c,h=m*m,p=0;for(e=0;e<l;++e)for(t=0;t<u;++t)for(r=0;r<c;++r)v[i=e*a+t*c+r]&=~C,v[i]&S&&v[i]&M&&(o.set(e,t,r,e,t,r),y[i]=0,v[i]|=C,p+=1);var d=new Int32Array(3*p),f=0,w=new Int32Array(3*p),x=0;for(e=0;e<l;++e)for(t=0;t<u;++t)for(r=0;r<c;++r)v[i=e*a+t*c+r]&M&&(d[f]=e,d[f+1]=t,d[f+2]=r,f+=3,v[i]&=~M);do{for(x=N(d,o,f,w),f=0,e=0,n=x;e<n;e+=3)i=a*w[e]+c*w[e+1]+w[e+2],v[i]&=~M,y[i]<=1.0404*h&&(d[f]=w[e],d[f+1]=w[e+1],d[f+2]=w[e+2],f+=3)}while(f>0);var _,T=s*s,A=new Uint16Array(3);for(e=0;e<l;++e)for(t=0;t<u;++t)for(r=0;r<c;++r)v[i=e*a+t*c+r]&=~M,v[i]&S&&(v[i]&C&&!(v[i]&C&&y[i]>=T)||(v[i]|=M,g&&v[i]&C&&(o.toArray(e,t,r,A),_=A[0]*a+A[1]*c+A[2],b[i]=b[_])));console.timeEnd("EDTSurface fastdistancemap")}function N(e,t,r,n){var i,o,a,s,h,p,d,f,m,g,b,w,x=new Uint16Array(3),_=0;if(0===r)return _;var A=-1,E=-1,P=-1,R=u*c;for(d=0,m=r;d<m;d+=3)for(i=e[d],o=e[d+1],a=e[d+2],t.toArray(i,o,a,x),f=0;f<6;++f)A=i+(w=T[f])[0],E=o+w[1],P=a+w[2],A<l&&A>-1&&E<u&&E>-1&&P<c&&P>-1&&(v[b=A*R+c*E+P]&S&&!(v[b]&C)?(t.fromArray(A,E,P,x),g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p,y[b]=g,v[b]|=C,v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3):v[b]&S&&v[b]&C&&(g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p)<y[b]&&(t.fromArray(A,E,P,x),y[b]=g,v[b]&M||(v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3)));for(d=0,m=r;d<m;d+=3)for(i=e[d],o=e[d+1],a=e[d+2],t.toArray(i,o,a,x),f=6;f<18;f++)A=i+(w=T[f])[0],E=o+w[1],P=a+w[2],A<l&&A>-1&&E<u&&E>-1&&P<c&&P>-1&&(v[b=A*R+c*E+P]&S&&!(v[b]&C)?(t.fromArray(A,E,P,x),g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p,y[b]=g,v[b]|=C,v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3):v[b]&S&&v[b]&C&&(g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p)<y[b]&&(t.fromArray(A,E,P,x),y[b]=g,v[b]&M||(v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3)));for(d=0,m=r;d<m;d+=3)for(i=e[d],o=e[d+1],a=e[d+2],t.toArray(i,o,a,x),f=18;f<26;f++)A=i+(w=T[f])[0],E=o+w[1],P=a+w[2],A<l&&A>-1&&E<u&&E>-1&&P<c&&P>-1&&(v[b=A*R+c*E+P]&S&&!(v[b]&C)?(t.fromArray(A,E,P,x),g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p,y[b]=g,v[b]|=C,v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3):v[b]&S&&v[b]&C&&(g=(s=A-x[0])*s+(h=E-x[1])*h+(p=P-x[2])*p)<y[b]&&(t.fromArray(A,E,P,x),y[b]=g,v[b]&M||(v[b]|=M,n[_]=A,n[_+1]=E,n[_+2]=P,_+=3)));return _}this.getVolume=function(t,n,i,o,a){console.time("EDTSurface.getVolume");var s="vws"!==t;_(s,n,i,o,a),P(s),function(){var e,t,r,n=u*c;for(e=0;e<l;++e)for(t=0;t<c;++t)for(r=0;r<u;++r){var i=e*n+r*c+t;if(v[i]&S)for(var o=0;o<26;){var a=e+T[o][0],s=t+T[o][2],h=r+T[o][1];if(a>-1&&a<l&&h>-1&&h<u&&s>-1&&s<c&&!(v[a*n+h*c+s]&S)){v[i]|=M;break}o++}}}(),"ms"!==t&&"ses"!==t||I(),"ses"===t&&(A(!1),function(){var t,r;for(t=0,r=v.length;t<r;++t)v[t]&=~C;for(t=0,r=e.length/3;t<r;++t)R(t)}()),function(e){var t,r=v.length;if("vws"===e)for(t=0;t<r;++t)v[t]&=~M,v[t]=v[t]&C?1:0;else if("ms"===e)for(t=0;t<r;++t)v[t]&=~C,v[t]&M&&(v[t]|=C),v[t]&=~M,v[t]=v[t]&C?1:0;else if("ses"===e)for(t=0;t<r;++t)v[t]&M&&v[t]&C?v[t]&=~M:v[t]&M&&!(v[t]&C)&&(v[t]|=C),v[t]=v[t]&C?1:0;else if("sas"===e)for(t=0;t<r;++t)v[t]&=~M,v[t]=v[t]&C?1:0}(t);for(var h=0,p=b.length;h<p;++h)b[h]=r[b[h]];return console.timeEnd("EDTSurface.getVolume"),{data:v,nx:c,ny:u,nz:l,atomindex:b}},this.getSurface=function(e,t,r,n,i,o,a){var s=this.getVolume(e,t,r,n,i);return new Ed(s.data,s.nx,s.ny,s.nz,s.atomindex).getSurface(1,o,void 0,h,a)}}function jy(e,t,r,n,i,o,a){var s=e.length,l=i[0],u=i[1],c=i[2],h=o[0],p=o[1],d=o[2];function f(e,t){return Math.floor((e-t)/a)}for(var m=f(h,l)+1,g=f(p,u)+1,v=f(d,c)+1,y=m*g*v,b=g*v,w=function(e,t,r){return(f(e,l)*g+f(t,u))*v+f(r,c)},x=[],_=0;_<s;_++){var S=w(e[_],t[_],r[_]);void 0===x[S]?x[S]=[_]:x[S].push(_)}var C=new Uint32Array(y),M=new Uint16Array(y),T=new Uint32Array(s),A=0,E=0;for(_=0;_<y;_++){var P=C[_]=A,R=x[_];if(void 0!==R)for(var I=0;I<R.length;I++)T[A]=R[I],A++;var N=A-P;M[_]=N,N>E&&(E=N)}this.neighbourListLength=27*E+1,this.withinRadii=function(i,o,a,s,h){for(var p=0,d=f(i,l),y=f(o,u),w=f(a,c),x=Math.max(0,d-1),_=Math.max(0,y-1),S=Math.max(0,w-1),A=Math.min(m,d+1),E=Math.min(g,y+1),P=Math.min(v,w+1),R=x;R<=A;++R)for(var I=R*b,N=_;N<=E;++N)for(var D=N*v,k=S;k<=P;++k)for(var O=I+D+k,F=C[O],L=F+M[O],U=F;U<L;U++){var V=T[U],B=e[V]-i,z=t[V]-o,j=r[V]-a,H=n[V]+s;B*B+z*z+j*j<=H*H&&(h[p++]=T[U])}h[p]=-1}}function Hy(e,t,r){for(var n=t.length,i=new Float32Array(n),o=new Float32Array(n),a=new Float32Array(n),s=0;s<n;s++){var l=3*s;i[s]=e[l],o[s]=e[l+1],a[s]=e[l+2]}var u=Uc(e);0===e.length&&(u[0].set([0,0,0]),u[1].set([0,0,0]));var c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T,A,E,P=u[0],R=u[1],I=-1,N=new Float32Array([0,0,0]),D=new Float32Array([0,0,0]),k=new Float32Array([0,0,0]);function O(e,r,s,l){d=Ha(e,1.4),f=Ha(r,2),m=Ha(s,!0),g=Ha(l,30),c=new Float32Array(n),h=new Float32Array(n);for(var u=0;u<c.length;++u){var N=t[u]+d;c[u]=N,h[u]=N*N}p=0;for(var D=0;D<c.length;++D)c[D]>p&&(p=c[D]);!function(){var e=Md(P,R,p,f,0);f=e.scaleFactor,v=e.dim,y=e.matrix,E=Math.min(5,2+Math.floor(d*f)),b=fu(v[0]*v[1]*v[2],-1001),w=new Int32Array(b.length),x=new Float32Array(v[0]),_=new Float32Array(v[1]),S=new Float32Array(v[2]),F(x,P[0],1/f),F(_,P[1],1/f),F(S,P[2],1/f)}(),function(){var e=0,t=2*Math.PI/g;M=new Float32Array(g),C=new Float32Array(g);for(var r=0;r<g;r++)M[r]=Math.cos(e),C[r]=Math.sin(e),e+=t}(),T=new jy(i,o,a,c,P,R,2.01*p),A=new Int32Array(T.neighbourListLength),I=-1}function F(e,t,r){for(var n=0;n<e.length;n++)e[n]=t+r*n}function L(e,t,r,n,i){var o;if(-1!==I){if((o=I)!==n&&o!==i&&U(o,e,t,r))return o;I=-1}var a=0;for(o=A[a];o>=0;){if(o!==n&&o!==i&&U(o,e,t,r))return I=o,o;o=A[++a]}return I=-1,-1}function U(t,r,n,i){var o=3*t,a=h[t],s=e[o]-r,l=e[o+1]-n,u=e[o+2]-i;return s*s+l*l+u*u<a}function V(){for(var e=0;e<n;e++){var t=i[e],r=o[e],s=a[e],l=c[e],u=h[e];T.withinRadii(t,r,s,l,A);for(var p=Math.ceil(l*f),d=Math.floor(f*(t-P[0])),g=Math.floor(f*(r-P[1])),y=Math.floor(f*(s-P[2])),C=Math.max(0,d-p),M=Math.max(0,g-p),E=Math.max(0,y-p),R=Math.min(v[0],d+p+2),I=Math.min(v[1],g+p+2),N=Math.min(v[2],y+p+2),D=C;D<R;D++)for(var k=x[D]-t,O=v[1]*v[2]*D,F=M;F<I;F++)for(var U=_[F]-r,V=k*k+U*U,B=O+v[2]*F,z=E;z<N;z++){var j=S[z]-s,H=V+j*j;if(H<u){var $=z+B;b[$]<0&&(b[$]=-b[$]);var G=Math.sqrt(H),W=l/G,q=k*W,X=U*W,K=j*W;if(-1===L(q+=t,X+=r,K+=s,e,-1)){var Y=l-G;Y<b[$]&&(b[$]=Y,m&&(w[$]=e))}}}}}function B(e,t){var r=c[e],n=c[t],s=N[0]=i[t]-i[e],l=N[1]=o[t]-o[e],u=N[2]=a[t]-a[e],h=s*s+l*l+u*u,p=Math.sqrt(h),d=r*((r*r+p*p-n*n)/(2*r*p));Jc(N,N),function(e,t){e[0]=e[1]=e[2]=1,0!==t[0]?e[0]=(t[1]+t[2])/-t[0]:0!==t[1]?e[1]=(t[0]+t[2])/-t[1]:0!==t[2]&&(e[2]=(t[0]+t[1])/-t[2])}(D,N),Jc(D,D),Hc(k,N,D),Jc(k,k);var y=Math.sqrt(r*r-d*d);Zc(D,D,y),Zc(k,k,y),Zc(N,N,d),N[0]+=i[e],N[1]+=o[e],N[2]+=a[e],I=-1;for(var T=E,A=0;A<g;A++){var R=M[A],O=C[A],F=N[0]+R*D[0]+O*k[0],U=N[1]+R*D[1]+O*k[1],V=N[2]+R*D[2]+O*k[2];if(-1===L(F,U,V,e,t))for(var B=Math.floor(f*(F-P[0])),z=Math.floor(f*(U-P[1])),j=Math.floor(f*(V-P[2])),H=Math.max(0,B-T),$=Math.max(0,z-T),G=Math.max(0,j-T),W=Math.min(v[0],B+T+2),q=Math.min(v[1],z+T+2),X=Math.min(v[2],j+T+2),K=H;K<W;K++){s=F-x[K];for(var Y=v[1]*v[2]*K,Z=$;Z<q;Z++)for(var J=s*s+(l=U-_[Z])*l,Q=Y+v[2]*Z,ee=G;ee<X;ee++){h=J+(u=V-S[ee])*u;var te=ee+Q,re=b[te];re>0&&h<re*re&&(b[te]=Math.sqrt(h),m&&(w[te]=e))}}}}function z(e,t,s){console.time("AVSurface.getVolume"),console.time("AVSurface.init"),O(e,t,s),console.timeEnd("AVSurface.init"),console.time("AVSurface.projectPoints"),V(),console.timeEnd("AVSurface.projectPoints"),console.time("AVSurface.projectTorii"),function(){for(var e=0;e<n;e++){T.withinRadii(i[e],o[e],a[e],c[e],A);for(var t=0,r=A[t];r>=0;)e<r&&B(e,r),r=A[++t]}}(),console.timeEnd("AVSurface.projectTorii"),function(){for(var e=0;e<b.length;e++)b[e]<0&&(b[e]=0)}(),function(){for(var e=0;e<w.length;e++)w[e]=r[w[e]]}(),console.timeEnd("AVSurface.getVolume")}this.getSurface=function(e,t,r,n,i,o,a){return z(t,r,i),new Ed(b,v[2],v[1],v[0],w).getSurface(t,!1,void 0,y,a)}}Ml.add("line",Vy),zy.__deps=[Md,Cd,Ed,Uc,By],Hy.__deps=[Md,Ed,fu,Uc,Zc,Hc,Jc,jy,Ha],_l.add("molsurf",function(e,t){var r=e.data.args,n=e.data.params;if(r&&n){var i=new("av"===n.type?Hy:zy)(r.coordList,r.radiusList,r.indexList).getSurface(n.type,n.probeRadius,n.scaleFactor,n.cutoff,!0,n.smooth,n.contour),o=[i.position.buffer,i.index.buffer];i.normal&&o.push(i.normal.buffer),i.atomindex&&o.push(i.atomindex.buffer),t({sd:i,p:n},o)}},[zy,Hy]);var $y=function(e){this.structure=e};$y.prototype._getAtomData=function(){return this.structure.getAtomData({what:{position:!0,radius:!0,index:!0},radiusParams:{type:"vdw",scale:1}})},$y.prototype._makeSurface=function(e,t){var r=new Td(t.name,"",e);return r.info.type=t.type,r.info.probeRadius=t.probeRadius,r.info.scaleFactor=t.scaleFactor,r.info.smooth=t.smooth,r.info.cutoff=t.cutoff,r},$y.prototype.getSurface=function(e){var t=e||{},r=this._getAtomData(),n=r.position,i=r.radius,o=r.index,a=new("av"===t.type?Hy:zy)(n,i,o).getSurface(t.type,t.probeRadius,t.scaleFactor,t.cutoff,!0,t.smooth,t.contour);return this._makeSurface(a,t)},$y.prototype.getSurfaceWorker=function(e,t){var r=this,n=Object.assign({},e);if(window.Worker){void 0===this.worker&&(this.worker=new kc("molsurf"));var i=this._getAtomData(),o=i.position,a=i.radius,s=i.index,l={args:{coordList:o,radiusList:a,indexList:s},params:n},u=[o.buffer,a.buffer,s.buffer];this.worker.post(l,u,function(e){t(r._makeSurface(e.data.sd,n))},function(e){console.warn("MolecularSurface.getSurfaceWorker error - trying without worker",e),r.worker.terminate(),r.worker=void 0;var i=r.getSurface(n);t(i)})}else{var c=this.getSurface(n);t(c)}},$y.prototype.dispose=function(){this.worker&&this.worker.terminate()};var Gy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="surface",this.parameters=Object.assign({surfaceType:{type:"select",rebuild:!0,options:{vws:"vws",sas:"sas",ms:"ms",ses:"ses",av:"av"}},probeRadius:{type:"number",precision:1,max:20,min:0,rebuild:!0},smooth:{type:"integer",precision:1,max:10,min:0,rebuild:!0},scaleFactor:{type:"number",precision:1,max:5,min:0,rebuild:!0},cutoff:{type:"number",precision:2,max:50,min:0,rebuild:!0},contour:{type:"boolean",rebuild:!0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},filterSele:{type:"text",rebuild:!0},colorVolume:{type:"hidden"},useWorker:{type:"boolean",rebuild:!0}},this.parameters,{radiusType:null,radius:null,scale:null}),this.__infoList=[],this.structure.signals.refreshed.add(function(){this.__forceNewMolsurf=!0},this),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"uniform"),r.colorValue=Ha(r.colorValue,14540253),r.disablePicking=Ha(r.disablePicking,!0),this.surfaceType=Ha(r.surfaceType,"ms"),this.probeRadius=Ha(r.probeRadius,1.4),this.smooth=Ha(r.smooth,2),this.scaleFactor=Ha(r.scaleFactor,2),this.cutoff=Ha(r.cutoff,0),this.contour=Ha(r.contour,!1),this.background=Ha(r.background,!1),this.opaqueBack=Ha(r.opaqueBack,!0),this.filterSele=Ha(r.filterSele,""),this.colorVolume=Ha(r.colorVolume,void 0),this.useWorker=Ha(r.useWorker,!0),e.prototype.init.call(this,t)},t.prototype.prepareData=function(e,t,r){var n=this.__infoList[t];if(n||(n={},this.__infoList[t]=n),n.molsurf&&n.sele===e.selection.string)r(t);else{if(this.filterSele){var i=e.structure.getView(new el(this.filterSele)),o=i.boundingBox.getSize(),a=Math.max(o.x,o.y,o.z),s=e.getAtomSetWithinPoint(i.center,a/2+6);e=e.getView(new el(e.getAtomSetWithinSelection(s,3).toSeleString()))}n.sele=e.selection.string,n.molsurf=new $y(e);var l=this.getSurfaceParams(),u=function(e){n.surface=e,r(t)};this.useWorker?n.molsurf.getSurfaceWorker(l,u):u(n.molsurf.getSurface(l))}},t.prototype.prepare=function(e){var t=this;if((this.__forceNewMolsurf||this.__sele!==this.selection.string||this.__surfaceParams!==JSON.stringify(this.getSurfaceParams()))&&(this.__infoList.forEach(function(e){e.molsurf.dispose()}),this.__infoList.length=0),0!==this.structureView.atomCount){var r=function(){this.__sele=this.selection.string,this.__surfaceParams=JSON.stringify(this.getSurfaceParams()),this.__forceNewMolsurf=!1,e()}.bind(this),n="default"===this.assembly?this.defaultAssembly:this.assembly,i=this.structure.biomolDict[n];i?i.partList.forEach(function(e,n){var o=e.getView(t.structureView);t.prepareData(o,n,function(e){e===i.partList.length-1&&r()})}):this.prepareData(this.structureView,0,r)}else e()},t.prototype.createData=function(e,t){var r=this.__infoList[t],n=r.surface,i={position:n.getPosition(),color:n.getColor(this.getColorParams()),index:n.getFilteredIndex(this.filterSele,e)},o=[];if(n.contour){var a=new $d(i,this.getBufferParams({wireframe:!1}));o.push(a)}else{i.normal=n.getNormal(),i.picking=n.getPicking(e.getStructure());var s=new Vd(i,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1})),l=new jd(s);o.push(l)}return{bufferList:o,info:r}},t.prototype.updateData=function(e,t){var r={};if(e.position)return this.__forceNewMolsurf=!0,void this.build();e.color&&(r.color=t.info.surface.getColor(this.getColorParams())),e.index&&(r.index=t.info.surface.getFilteredIndex(this.filterSele,t.sview)),t.bufferList[0].setAttributes(r)},t.prototype.setParameters=function(t,r,n){return r=r||{},t&&t.filterSele&&(r.index=!0),t&&void 0!==t.colorVolume&&(r.color=!0),t&&t.wireframe&&(t.contour||void 0===t.contour&&this.contour)&&(t.wireframe=!1),e.prototype.setParameters.call(this,t,r,n),this},t.prototype.getSurfaceParams=function(e){return Object.assign({type:this.surfaceType,probeRadius:this.probeRadius,scaleFactor:this.scaleFactor,smooth:this.smooth&&!this.contour,cutoff:this.cutoff,contour:this.contour,useWorker:this.useWorker},e)},t.prototype.getColorParams=function(){var t=e.prototype.getColorParams.call(this);return t.volume=this.colorVolume,t},t.prototype.clear=function(){e.prototype.clear.call(this)},t.prototype.dispose=function(){this.__infoList.forEach(function(e){e.molsurf.dispose()}),this.__infoList.length=0,e.prototype.dispose.call(this)},t}(kv);Ml.add("surface",Gy);var Wy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="point",this.parameters=Object.assign({pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{flatShaded:null,wireframe:null,linewidth:null,side:null,roughness:null,metalness:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};this.pointSize=Ha(r.pointSize,1),this.sizeAttenuation=Ha(r.sizeAttenuation,!0),this.sortParticles=Ha(r.sortParticles,!1),this.useTexture=Ha(r.useTexture,!1),this.alphaTest=Ha(r.alphaTest,.5),this.forceTransparent=Ha(r.forceTransparent,!1),this.edgeBleach=Ha(r.edgeBleach,0),e.prototype.init.call(this,r)},t.prototype.createData=function(e){var t=e.getAtomData(this.getAtomParams({position:!0,color:!0,picking:!0}));return{bufferList:[new Jm(t,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach}))]}},t.prototype.updateData=function(e,t){var r=t.sview.getAtomData(this.getAtomParams(e)),n={};e&&!e.position||(n.position=r.position),e&&!e.color||(n.color=r.color),t.bufferList[0].setAttributes(n)},t}(kv);Ml.add("point",Wy),Al.add("shader/Ribbon.vert","#define STANDARD\nuniform float clipNear;\nuniform vec3 clipCenter;\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvarying vec3 vViewPosition;\n#endif\n#if defined( RADIUS_CLIP )\nvarying vec3 vClipCenter;\n#endif\nattribute vec3 dir;\nattribute float size;\n#ifdef PICKING\n#include unpack_color\nattribute float primitiveId;\nvarying vec3 vPickingColor;\n#else\n#include color_pars_vertex\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#endif\n#include common\nvoid main(void){\n#ifdef PICKING\nvPickingColor = unpackColor( primitiveId );\n#else\n#include color_vertex\n#include beginnormal_vertex\n#include defaultnormal_vertex\n#ifndef FLAT_SHADED\nvNormal = normalize( transformedNormal );\n#endif\n#endif\n#include begin_vertex\ntransformed += normalize( dir ) * size;\n#include project_vertex\n#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )\nvViewPosition = -mvPosition.xyz;\n#endif\n#if defined( RADIUS_CLIP )\nvClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;\n#endif\n#include nearclip_vertex\n}");var qy=new Uint16Array([0,1,2,1,3,2]);function Xy(e){return 3*(4*(e.position.length/3-1))}var Ky=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,{position:new Float32Array(Xy(t)),color:new Float32Array(Xy(t)),index:is(Xy(t),Xy(t)/3),normal:new Float32Array(Xy(t)),picking:t.picking},r),this.vertexShader="Ribbon.vert";var n=t.position.length/3-1,i=4*n,o=3*i;this.addAttributes({dir:{type:"v3",value:new Float32Array(o)}}),this.addAttributes({size:{type:"f",value:new Float32Array(i)}}),t.primitiveId=gu(n),this.setAttributes(t),this.makeIndex()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setAttributes=function(e){void 0===e&&(e={});var t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w=this.size/4,x=this.geometry.attributes;e.position&&(t=e.position,s=x.position.array,x.position.needsUpdate=!0),e.normal&&(r=e.normal,l=x.normal.array,x.normal.needsUpdate=!0),e.size&&(n=e.size,u=x.size.array,x.size.needsUpdate=!0),e.dir&&(i=e.dir,c=x.dir.array,x.dir.needsUpdate=!0),e.color&&(o=e.color,h=x.color.array,x.color.needsUpdate=!0),e.primitiveId&&(a=e.primitiveId,p=x.primitiveId.array,x.primitiveId.needsUpdate=!0);var _=n?n[0]:null;for(d=0;d<w;++d){for(y=3*d,m=3*d*4,v=4*d,t&&(s[m]=s[m+3]=t[y],s[m+1]=s[m+4]=t[y+1],s[m+2]=s[m+5]=t[y+2],s[m+6]=s[m+9]=t[y+3],s[m+7]=s[m+10]=t[y+4],s[m+8]=s[m+11]=t[y+5]),r&&(l[m]=l[m+3]=-r[y],l[m+1]=l[m+4]=-r[y+1],l[m+2]=l[m+5]=-r[y+2],l[m+6]=l[m+9]=-r[y+3],l[m+7]=l[m+10]=-r[y+4],l[m+8]=l[m+11]=-r[y+5]),f=0;f<4;++f)g=m+3*f,o&&(h[g]=o[y],h[g+1]=o[y+1],h[g+2]=o[y+2]),a&&(p[v+f]=a[d]);n&&(b=n[d],_!==n[d]?(u[v]=_,u[v+1]=_,u[v+2]=b,u[v+3]=b):(u[v]=b,u[v+1]=b,u[v+2]=b,u[v+3]=b),_=b),i&&(c[m]=i[y],c[m+1]=i[y+1],c[m+2]=i[y+2],c[m+3]=-i[y],c[m+4]=-i[y+1],c[m+5]=-i[y+2],c[m+6]=i[y+3],c[m+7]=i[y+4],c[m+8]=i[y+5],c[m+9]=-i[y+3],c[m+10]=-i[y+4],c[m+11]=-i[y+5])}},t.prototype.makeIndex=function(){for(var e=this.geometry.getIndex().array,t=e.length/4/3,r=0;r<t;++r){var n=6*r,i=4*r;e.set(qy,n);for(var o=0;o<6;++o)e[n+o]+=i}},t}(Ud),Yy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="ribbon",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{side:null,wireframe:null,linewidth:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"chainname"),r.colorScale=Ha(r.colorScale,"RdYlBu"),r.radiusType=Ha(r.radiusType,"sstruc"),r.radiusScale=Ha(r.radiusScale,4),"low"===r.quality?this.subdiv=3:"medium"===r.quality?this.subdiv=6:"high"===r.quality?this.subdiv=12:this.subdiv=Ha(r.subdiv,6),this.tension=Ha(r.tension,NaN),this.smoothSheet=Ha(r.smoothSheet,!1),e.prototype.init.call(this,r)},t.prototype.getSplineParams=function(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!0,smoothSheet:this.smoothSheet},e)},t.prototype.getAtomRadius=function(t){return t.isTrace()?e.prototype.getAtomRadius.call(this,t):0},t.prototype.createData=function(e){var t=this,r=[],n=[];return this.structure.eachPolymer(function(e){if(!(e.residueCount<4)){n.push(e);var i=new my(e,t.getSplineParams()),o=i.getSubdividedPosition(),a=i.getSubdividedOrientation(),s=i.getSubdividedColor(t.getColorParams()),l=i.getSubdividedPicking(),u=i.getSubdividedSize(t.getRadiusParams());r.push(new Ky({position:o.position,normal:a.binormal,dir:a.normal,color:s.color,size:u.size,picking:l.picking},t.getBufferParams()))}},e.getSelection()),{bufferList:r,polymerList:n}},t.prototype.updateData=function(e,t){e=e||{};var r=0,n=t.polymerList.length;for(r=0;r<n;++r){var i={},o=new my(t.polymerList[r],this.getSplineParams());if(e.position){var a=o.getSubdividedPosition(),s=o.getSubdividedOrientation();i.position=a.position,i.normal=s.binormal,i.dir=s.normal}if(e.radius||e.scale){var l=o.getSubdividedSize(this.getRadiusParams());i.size=l.size}if(e.color){var u=o.getSubdividedColor(this.getColorParams());i.color=u.color}t.bufferList[r].setAttributes(i)}},t.prototype.setParameters=function(t){var r={};return t&&t.tension&&(r.position=!0),e.prototype.setParameters.call(this,t,r,!1),this},t}(kv);Ml.add("ribbon",Yy);var Zy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="rocket",this.parameters=Object.assign({localAngle:{type:"integer",max:180,min:0,rebuild:!0},centerDist:{type:"number",precision:1,max:10,min:0,rebuild:!0},ssBorder:{type:"boolean",rebuild:!0},radialSegments:!0,openEnded:!0,disableImpostor:!0},this.parameters),this.helixbundleList=[],this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"sstruc"),r.radiusSize=Ha(r.radiusSize,1.5),r.radiusScale=Ha(r.radiusScale,1),r.openEnded=Ha(r.openEnded,!1),this.localAngle=Ha(r.localAngle,30),this.centerDist=Ha(r.centerDist,2.5),this.ssBorder=Ha(r.ssBorder,!1),e.prototype.init.call(this,r)},t.prototype.createData=function(e){var t=this,r=0,n=[],i=[];this.structure.eachPolymer(function(e){if(!(e.residueCount<4||e.isNucleic())){var o=new Cf(e),a=o.getAxis(t.localAngle,t.centerDist,t.ssBorder,t.getColorParams(),t.getRadiusParams());r+=a.size.length,n.push(a),i.push(o)}},e.getSelection());var o={begin:new Float32Array(3*r),end:new Float32Array(3*r),size:new Float32Array(r),color:new Float32Array(3*r),picking:new Float32Array(r)},a=0;return n.forEach(function(e){o.begin.set(e.begin,3*a),o.end.set(e.end,3*a),o.size.set(e.size,a),o.color.set(e.color,3*a),o.picking.set(e.picking.array,a),a+=e.size.length}),r&&(o.picking=new kp(o.picking,e.getStructure())),{bufferList:[new cy({position1:o.begin,position2:o.end,color:o.color,color2:o.color,radius:o.size,picking:o.picking},this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))],axisList:n,helixbundleList:i,axisData:o}},t.prototype.updateData=function(e,t){var r=this;if((e=e||{}).position)this.build();else{var n={};if(e.color||e.radius){var i=0;t.helixbundleList.forEach(function(n){var o=n.getAxis(r.localAngle,r.centerDist,r.ssBorder,r.getColorParams(),r.getRadiusParams());e.color&&t.axisData.color.set(o.color,3*i),(e.radius||e.scale)&&t.axisData.size.set(o.size,i),i+=o.size.length}),e.color&&(n.color=t.axisData.color,n.color2=t.axisData.color),(e.radius||e.scale)&&(n.radius=t.axisData.size)}t.bufferList[0].setAttributes(n)}},t}(kv);Ml.add("rocket",Zy);var Jy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="rope",this.parameters=Object.assign({smooth:{type:"integer",max:15,min:0,rebuild:!0}},this.parameters,{aspectRatio:null,smoothSheet:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.aspectRatio=1,r.tension=Ha(r.tension,.5),r.radiusScale=Ha(r.radiusScale,5),r.smoothSheet=!1,this.smooth=Ha(r.smooth,2),e.prototype.init.call(this,r)},t.prototype.getSpline=function(e){var t=new Sf(e);return new my(e,this.getSplineParams({directional:!1,positionIterator:t.getCenterIterator(this.smooth)}))},t}(wy);Ml.add("rope",Jy);var Qy=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="spacefill",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};e.prototype.init.call(this,r)},t.prototype.createData=function(e){return{bufferList:[new Xm(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,dullInterior:!0,disableImpostor:this.disableImpostor}))]}},t.prototype.updateData=function(e,t){var r=t.sview.getAtomData(this.getAtomParams(e)),n={};e&&!e.position||(n.position=r.position),e&&!e.color||(n.color=r.color),e&&!e.radius||(n.radius=r.radius),t.bufferList[0].setAttributes(n)},t}(kv);function eb(e){return 3*(e.position.length/3-1)*2}Ml.add("spacefill",Qy);var tb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,{position:new Float32Array(eb(t)),color:new Float32Array(eb(t))},r),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag",this.setAttributes(t)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setAttributes=function(e){var t,r,n,i,o=this.geometry.attributes;if(e.position&&(t=e.position,n=o.position.array,o.position.needsUpdate=!0),e.color&&(r=e.color,i=o.color.array,o.color.needsUpdate=!0),t||r)for(var a,s,l=this.size-1,u=0;u<l;++u)a=3*u,s=3*u*2,t&&(n[s]=t[a],n[s+1]=t[a+1],n[s+2]=t[a+2],n[s+3]=t[a+3],n[s+4]=t[a+4],n[s+5]=t[a+5]),r&&(i[s]=r[a],i[s+1]=r[a+1],i[s+2]=r[a+2],i[s+3]=r[a+3],i[s+4]=r[a+4],i[s+5]=r[a+5]);else gl.warn("TraceBuffer.prototype.setAttributes no data")},t}(Fd),rb=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="trace",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorScheme=Ha(r.colorScheme,"chainname"),r.colorScale=Ha(r.colorScale,"RdYlBu"),"low"===r.quality?this.subdiv=3:"medium"===r.quality?this.subdiv=6:"high"===r.quality?this.subdiv=12:this.subdiv=Ha(r.subdiv,6),this.tension=Ha(r.tension,NaN),this.smoothSheet=Ha(r.smoothSheet,!1),e.prototype.init.call(this,r)},t.prototype.getSplineParams=function(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!1,smoothSheet:this.smoothSheet},e)},t.prototype.getAtomRadius=function(e){return e.isTrace()?.1:0},t.prototype.createData=function(e){var t=this,r=[],n=[];return this.structure.eachPolymer(function(e){if(!(e.residueCount<4)){n.push(e);var i=new my(e,t.getSplineParams()),o=i.getSubdividedPosition(),a=i.getSubdividedColor(t.getColorParams());r.push(new tb(Object.assign({},o,a),t.getBufferParams()))}},e.getSelection()),{bufferList:r,polymerList:n}},t.prototype.updateData=function(e,t){e=e||{};var r=0,n=t.polymerList.length;for(r=0;r<n;++r){var i={},o=new my(t.polymerList[r],this.getSplineParams());if(e.position){var a=o.getSubdividedPosition();i.position=a.position}if(e.color){var s=o.getSubdividedColor(this.getColorParams());i.color=s.color}t.bufferList[r].setAttributes(i)}},t.prototype.setParameters=function(t){var r={};return t&&t.tension&&(r.position=!0),e.prototype.setParameters.call(this,t,r,!1),this},t}(kv);Ml.add("trace",rb);var nb=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="tube",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.aspectRatio=1,r.radiusScale=Ha(r.radiusScale,2),"low"===r.quality&&(this.radialSegments=5),e.prototype.init.call(this,r)},t.prototype.getSplineParams=function(){return e.prototype.getSplineParams.call(this,{directional:!1})},t}(wy);Ml.add("tube",nb);var ib=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="unitcell",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0},this.parameters,{assembly:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{},n=.5;this.structure.unitcell&&(n=Math.cbrt(this.structure.unitcell.volume)/200),r.radiusSize=Ha(r.radiusSize,n),r.colorValue=Ha(r.colorValue,"orange"),e.prototype.init.call(this,r)},t.prototype.getUnitcellData=function(e){return e.unitcell.getData(e)},t.prototype.create=function(){var e=this.structureView.getStructure();if(e.unitcell){var t=this.getUnitcellData(e);this.sphereBuffer=new Xm(t.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new cy(t.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}},t.prototype.updateData=function(e,t){var r=t.sview.getStructure(),n=this.getUnitcellData(r),i={},o={};e&&!e.position||(i.position=n.vertexPosition,o.position1=n.edgePosition1,o.position2=n.edgePosition2),e&&!e.color||(i.color=n.vertexColor,o.color=n.edgeColor,o.color2=n.edgeColor),e&&!e.radius||(i.radius=n.vertexRadius,o.radius=n.edgeRadius),this.sphereBuffer.setAttributes(i),this.cylinderBuffer.setAttributes(o)},t}(kv);Ml.add("unitcell",ib);var ob=function(e){function t(t,r,n){e.call(this,t,r,n),this.type="validation",this.parameters=Object.assign({},this.parameters,{radiusType:null,radiusSize:null,radiusScale:null}),this.init(n)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.init=function(t){var r=t||{};r.colorValue=Ha(r.colorValue,"#f0027f"),e.prototype.init.call(this,r)},t.prototype.createData=function(e){if(e.validation){var t=e.validation.getClashData({structure:e,color:this.colorValue});return{bufferList:[new cy(t,this.getBufferParams({openEnded:!1}))]}}},t}(kv);Ml.add("validation",ob);var ab=new ft,sb=new ft,lb=new ft,ub=new ft(0,1,0);var cb=Object.assign({radialSegments:60,openEnded:!1},kd),hb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,{position:new Float32Array(t.position1.length),color:t.color,picking:t.picking},r,function(e){void 0===e&&(e={});var t=new Pi(1,1,Ha(e.radialSegments,60),1,Ha(e.openEnded,!1));return t.applyMatrix((new pt).makeRotationX(-Math.PI/2)),t}(r)),this.updateNormals=!0,this._position=new Float32Array(t.position1.length),this.setAttributes(t,!0)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return cb},t.prototype.applyPositionTransform=function(e,t,r){sb.fromArray(this._position1,r),lb.fromArray(this._position2,r),e.lookAt(sb,lb,ub);var n=this._radius[t];ab.set(n,n,sb.distanceTo(lb)),e.scale(ab)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.position1&&t.position2&&(pu(t.position1,t.position2,this._position),this._position1=t.position1,this._position2=t.position2,t.position=this._position),t.radius&&(this._radius=t.radius),e.prototype.setAttributes.call(this,t,r)},Object.defineProperties(t.prototype,r),t}(Vm);Rl.add("cone",hb);var pb=function(e){void 0===e&&(e=[]),this.geometryList=e};pb.prototype.computeBoundingBox=function(){var e=this;this.boundingBox?this.boundingBox.empty():this.boundingBox=new _r,this.geometryList.forEach(function(t){t.boundingBox||t.computeBoundingBox(),e.boundingBox.union(t.boundingBox)})};var db=Object.assign({aspectRatio:1.5,radialSegments:50,openEnded:!1,disableImpostor:!1},kd),fb=function(e,t){void 0===t&&(t={}),this.group=new Hn,this.wireframeGroup=new Hn,this.pickingGroup=new Hn,this.visible=!0,this.parameters=$a(t,this.defaultParameters),this.splitPosition=new Float32Array(e.position1.length),this.cylinderRadius=new Float32Array(e.radius.length);var r=this.makeAttributes(e),n={radialSegments:this.parameters.radialSegments,openEnded:this.parameters.openEnded,disableImpostor:this.parameters.disableImpostor};this.cylinderBuffer=new cy(r.cylinder,n),this.coneBuffer=new hb(r.cone,n),this.geometry=new pb([this.cylinderBuffer.geometry,this.coneBuffer.geometry]),this.matrix=Ha(t.matrix,new pt),this.picking=e.picking},mb={defaultParameters:{configurable:!0},matrix:{configurable:!0},pickable:{configurable:!0}};mb.defaultParameters.get=function(){return db},mb.matrix.set=function(e){Fd.prototype.setMatrix.call(this,e)},mb.matrix.get=function(){return this.group.matrix.clone()},mb.pickable.get=function(){return!!this.picking},fb.prototype.makeAttributes=function(e){void 0===e&&(e={});var t,r,n=this.splitPosition,i=this.cylinderRadius,o=this.parameters.aspectRatio,a={},s={};if(e.radius){for(t=0,r=i.length;t<r;++t)i[t]=e.radius[t]/o;a.radius=i,s.radius=e.radius}if(e.position1&&e.position2){var l=new ft,u=new ft,c=new ft,h=new ft;for(t=0,r=n.length;t<r;t+=3){l.fromArray(e.position1,t),u.fromArray(e.position2,t),c.subVectors(l,u);var p=c.length(),d=i[t/3]*o*2,f=Math.min(p,d);c.setLength(f),h.copy(u).add(c),h.toArray(n,t)}a.position1=e.position1,a.position2=n,s.position1=n,s.position2=e.position2}return e.color&&(a.color=e.color,a.color2=e.color,s.color=e.color),{cylinder:a,cone:s}},fb.prototype.getMesh=function(){return(new Hn).add(this.cylinderBuffer.getMesh(),this.coneBuffer.getMesh())},fb.prototype.getWireframeMesh=function(){return(new Hn).add(this.cylinderBuffer.getWireframeMesh(),this.coneBuffer.getWireframeMesh())},fb.prototype.getPickingMesh=function(){return(new Hn).add(this.cylinderBuffer.getPickingMesh(),this.coneBuffer.getPickingMesh())},fb.prototype.setAttributes=function(e){void 0===e&&(e={});var t=this.makeAttributes(e);this.cylinderBuffer.setAttributes(t.cylinder),this.coneBuffer.setAttributes(t.cone)},fb.prototype.setParameters=function(e){void 0===e&&(e={}),(e=Object.assign({},e))&&void 0!==e.matrix&&(this.matrix=e.matrix),delete e.matrix,e&&void 0!==e.wireframe&&(this.parameters.wireframe=e.wireframe,this.setVisibility(this.visible)),this.cylinderBuffer.setParameters(e),this.coneBuffer.setParameters(e)},fb.prototype.setVisibility=function(e){Fd.prototype.setVisibility.call(this,e)},fb.prototype.dispose=function(){this.cylinderBuffer.dispose(),this.coneBuffer.dispose()},Object.defineProperties(fb.prototype,mb),Rl.add("arrow",fb);var gb=new ft,vb=new ft,yb=new ft,bb=new ft(0,0,0),wb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new Jr(1,1,1)),this.updateNormals=!0,this.setAttributes(t,!0)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.applyPositionTransform=function(e,t,r){vb.fromArray(this._heightAxis,r),yb.fromArray(this._depthAxis,r),e.lookAt(bb,vb,yb),gb.set(this._size[t],yb.length(),vb.length()),e.scale(gb)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),e.prototype.setAttributes.call(this,t,r)},t}(Vm);Rl.add("box",wb);var xb=new ft,_b=new ft,Sb=new ft,Cb=new ft(0,0,0),Mb=Object.assign({sphereDetail:2},kd),Tb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new ni(1,Ha(r.sphereDetail,2))),this.updateNormals=!0,this.setAttributes(t,!0)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return Mb},t.prototype.applyPositionTransform=function(e,t,r){_b.fromArray(this._majorAxis,r),Sb.fromArray(this._minorAxis,r),e.lookAt(Cb,_b,Sb),xb.set(this._radius[t],Sb.length(),_b.length()),e.scale(xb)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),t.majorAxis&&(this._majorAxis=t.majorAxis),t.minorAxis&&(this._minorAxis=t.minorAxis),e.prototype.setAttributes.call(this,t,r)},Object.defineProperties(t.prototype,r),t}(Vm);Rl.add("ellipsoid",Tb);var Ab=new ft,Eb=new ft,Pb=new ft,Rb=new ft(0,0,0),Ib=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new ti(1,0)),this.updateNormals=!0,this.setAttributes(t,!0)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.applyPositionTransform=function(e,t,r){Eb.fromArray(this._heightAxis,r),Pb.fromArray(this._depthAxis,r),e.lookAt(Rb,Eb,Pb),Ab.set(this._size[t],Pb.length(),Eb.length()),e.scale(Ab)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),e.prototype.setAttributes.call(this,t,r)},t}(Vm);Rl.add("octahedron",Ib);var Nb=new ft,Db=new ft,kb=new ft,Ob=new ft(0,0,0),Fb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new Qn(1,0)),this.updateNormals=!0,this.setAttributes(t,!0)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.applyPositionTransform=function(e,t,r){Db.fromArray(this._heightAxis,r),kb.fromArray(this._depthAxis,r),e.lookAt(Ob,Db,kb),Nb.set(this._size[t],kb.length(),Db.length()),e.scale(Nb)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.size&&(this._size=t.size),t.heightAxis&&(this._heightAxis=t.heightAxis),t.depthAxis&&(this._depthAxis=t.depthAxis),e.prototype.setAttributes.call(this,t,r)},t}(Vm);Rl.add("tetrahedron",Fb);var Lb=new ft,Ub=new ft,Vb=new ft,Bb=new ft(0,0,0),zb=Object.assign({radiusRatio:.2,radialSegments:16,tubularSegments:32},kd),jb=function(e){function t(t,r){void 0===r&&(r={}),e.call(this,t,r,new hi(1,Ha(r.radiusRatio,.2),Ha(r.radialSegments,16),Ha(r.tubularSegments,32))),this.updateNormals=!0,this.setAttributes(t,!0)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={defaultParameters:{configurable:!0}};return r.defaultParameters.get=function(){return zb},t.prototype.applyPositionTransform=function(e,t,r){Ub.fromArray(this._majorAxis,r),Vb.fromArray(this._minorAxis,r),e.lookAt(Bb,Ub,Vb);var n=this._radius[t];Lb.set(n,n,n),e.scale(Lb)},t.prototype.setAttributes=function(t,r){void 0===t&&(t={}),t.radius&&(this._radius=t.radius),t.majorAxis&&(this._majorAxis=t.majorAxis),t.minorAxis&&(this._minorAxis=t.minorAxis),e.prototype.setAttributes.call(this,t,r)},Object.defineProperties(t.prototype,r),t}(Vm);Rl.add("torus",jb);var Hb=function(e,t){var r=t||{};this.streamer=e,this.name=Ha(r.name,""),this.path=Ha(r.path,"")},$b={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0},isJson:{configurable:!0},isXml:{configurable:!0}};$b.type.get=function(){return""},$b.__objName.get=function(){return""},$b.isBinary.get=function(){return!1},$b.isJson.get=function(){return!1},$b.isXml.get=function(){return!1},Hb.prototype.parse=function(){var e=this;return this.streamer.read().then(function(){return e._beforeParse(),e._parse(),e._afterParse(),e[e.__objName]})},Hb.prototype._parse=function(){},Hb.prototype._beforeParse=function(){},Hb.prototype._afterParse=function(){vl&&gl.log(this[this.__objName])},Object.defineProperties(Hb.prototype,$b);var Gb=function(e){this.structure=e,this.currentModelindex=null,this.currentChainid=null,this.currentResname=null,this.currentResno=null,this.currentInscode=null,this.currentHetero=null,this.previousResname="",this.previousHetero=null,this.ai=-1,this.ri=-1,this.ci=-1,this.mi=-1};Gb.prototype.addResidueType=function(e){for(var t=this.structure.atomStore,r=this.structure.residueStore,n=this.structure.residueMap,i=r.atomCount[e],o=r.atomOffset[e],a=new Array(i),s=0;s<i;++s)a[s]=t.atomTypeId[o+s];r.residueTypeId[e]=n.add(this.previousResname,a,this.previousHetero)},Gb.prototype.addAtom=function(e,t,r,n,i,o,a,s){var l=this.structure.atomStore,u=this.structure.residueStore,c=this.structure.chainStore,h=this.structure.modelStore,p=!1,d=!1,f=!1;this.currentModelindex!==e?(p=!0,d=!0,f=!0,this.mi+=1,this.ci+=1,this.ri+=1):this.currentChainid!==r?(d=!0,f=!0,this.ci+=1,this.ri+=1):this.currentResno===i&&this.currentResname===n&&this.currentInscode===s||(f=!0,this.ri+=1),this.ai+=1,p&&(h.growIfFull(),h.chainOffset[this.mi]=this.ci,h.chainCount[this.mi]=0,h.count+=1,c.modelIndex[this.ci]=this.mi),d&&(c.growIfFull(),c.setChainname(this.ci,t),c.setChainid(this.ci,r),c.residueOffset[this.ci]=this.ri,c.residueCount[this.ci]=0,c.count+=1,c.modelIndex[this.ci]=this.mi,h.chainCount[this.mi]+=1,u.chainIndex[this.ri]=this.ci),f&&(this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>0&&this.addResidueType(this.ri-1),u.growIfFull(),u.resno[this.ri]=i,void 0!==a&&(u.sstruc[this.ri]=a.charCodeAt(0)),void 0!==s&&(u.inscode[this.ri]=s.charCodeAt(0)),u.atomOffset[this.ri]=this.ai,u.atomCount[this.ri]=0,u.count+=1,u.chainIndex[this.ri]=this.ci,c.residueCount[this.ci]+=1),l.count+=1,l.residueIndex[this.ai]=this.ri,u.atomCount[this.ri]+=1,this.currentModelindex=e,this.currentChainid=r,this.currentResname=n,this.currentResno=i,this.currentInscode=s,this.currentHetero=o},Gb.prototype.finalize=function(){this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>-1&&this.addResidueType(this.ri)};var Wb=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.firstModelOnly=Ha(n.firstModelOnly,!1),this.asTrajectory=Ha(n.asTrajectory,!1),this.cAlphaOnly=Ha(n.cAlphaOnly,!1),this.structure=new Pm(this.name,this.path),this.structureBuilder=new Gb(this.structure)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"structure"},r.__objName.get=function(){return"structure"},Object.defineProperties(t.prototype,r),t}(Hb);var qb=function(e,t,r,n,i){void 0===r&&(r=""),void 0===i&&(i=[]),this.structure=e,this.index=t,this.description=r,this.entityType=function(e){switch(e=e.toLowerCase()){case"polymer":return Ah;case"non-polymer":return Eh;case"macrolide":return Ph;case"water":return Rh;default:return Th}}(n||""),this.chainIndexList=i,i.forEach(function(r){e.chainStore.entityIndex[r]=t})},Xb={type:{configurable:!0}};Xb.type.get=function(){return"Entity"},qb.prototype.getEntityType=function(){return this.entityType},qb.prototype.isPolymer=function(){return this.entityType===Ah},qb.prototype.isNonPolymer=function(){return this.entityType===Eh},qb.prototype.isMacrolide=function(){return this.entityType===Ph},qb.prototype.isWater=function(){return this.entityType===Rh},qb.prototype.eachChain=function(e){var t=this.structure.getChainProxy();this.chainIndexList.forEach(function(r){t.index=r,e(t)})},Object.defineProperties(qb.prototype,Xb);var Kb={a:1,b:1,c:1,alpha:90,beta:90,gamma:90,spacegroup:"P 1"},Yb=function(e){void 0===e&&(e=Kb),this.fracToCart=new pt,this.a=e.a,this.b=e.b,this.c=e.c,this.alpha=e.alpha,this.beta=e.beta,this.gamma=e.gamma,this.spacegroup=e.spacegroup;var t=fs(this.alpha),r=fs(this.beta),n=fs(this.gamma),i=Math.cos(t),o=Math.cos(r),a=Math.cos(n),s=Math.sin(r),l=Math.sin(n);if(this.volume=this.a*this.b*this.c*Math.sqrt(1-i*i-o*o-a*a+2*i*o*a),void 0===e.cartToFrac){var u=this.a*this.b*l/this.volume,c=(o*a-i)/(s*l);this.fracToCart.set(this.a,0,0,0,this.b*a,this.b*l,0,0,this.c*o,-this.c*s*c,1/u,0,0,0,0,1).transpose(),this.cartToFrac=(new pt).getInverse(this.fracToCart)}else this.cartToFrac=e.cartToFrac,this.fracToCart.getInverse(this.cartToFrac)};Yb.prototype.getPosition=function(e){var t=new Float32Array(24);if(e.unitcell){var r=e.unitcell,n=e.center.clone().applyMatrix4(r.cartToFrac).floor().multiplyScalar(2).addScalar(1),i=new ft,o=0,a=function(e,a,s){i.set(e,a,s).multiply(n).applyMatrix4(r.fracToCart).toArray(t,o),o+=3};a(0,0,0),a(1,0,0),a(0,1,0),a(0,0,1),a(1,1,0),a(1,0,1),a(0,1,1),a(1,1,1)}return t},Yb.prototype.getCenter=function(e){return function(e,t){void 0===t&&(t=new ft);for(var r=e.length,n=0;n<r;n+=3)t.x+=e[n],t.y+=e[n+1],t.z+=e[n+2];return t.divideScalar(r/3),t}(this.getPosition(e))},Yb.prototype.getData=function(e,t){void 0===t&&(t={});var r=Ha(t.colorValue,"orange"),n=Ha(t.radius,Math.cbrt(this.volume)/200),i=new ur(r),o=new ft,a=this.getPosition(e),s=mu(8,i.r,i.g,i.b),l=fu(8,n),u=new Float32Array(36),c=new Float32Array(36),h=mu(12,i.r,i.g,i.b),p=fu(12,n),d=0;function f(e,t){o.fromArray(a,3*e).toArray(u,d),o.fromArray(a,3*t).toArray(c,d),d+=3}f(0,1),f(0,2),f(0,3),f(1,4),f(1,5),f(2,6),f(3,5),f(4,7),f(5,7),f(2,4),f(7,6),f(3,6);var m=new Yp(this,e);return{vertex:{position:a,color:s,radius:l,picking:m},edge:{position1:u,position2:c,color:h,color2:h,radius:p,picking:m}}};var Zb={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h","":"h"},Jb=["DAL","DAR","DSG","DAS","DCY","DGL","DGN","DHI","DIL","DLE","DLY","MED","DPN","DPR","DSN","DTH","DTR","DTY","DVA","DNE"],Qb=["MOL_ID","MOLECULE","CHAIN","FRAGMENT","SYNONYM","EC","ENGINEERED","MUTATION","OTHER_DETAILS"],ew=/\s+/;function tw(e,t,r){var n=""+e;return t&&(n+=":"+t),r&&(n+="^"+r),n}var rw=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.hex=Ha(n.hex,!1)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"pdb"},t.prototype._parse=function(){vl&&gl.time("PdbParser._parse "+this.name);var e=!1,t=this.streamer.peekLines(1)[0],r=t.substr(62,4),n=t.substr(72,4);r===n&&n.trim()&&(e=!0);var i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T,A,E,P,R,I,N,D,k,O,F,L="pqr"===this.type,U=this.structure,V=this.structureBuilder,B=this.hex,z=10,j=10,H=this.firstModelOnly,$=this.asTrajectory,G=this.cAlphaOnly,W=U.frames,q=U.boxes,X=!1,K=U.biomolDict,Y={},Z={},J={},Q=[],ee={},te={},re={},ne={},ie={helices:[],sheets:[]},oe=ie.helices,ae=ie.sheets,se=U.atomMap,le=U.atomStore;le.resize(Math.round(this.streamer.data.length/80)),L&&(le.addField("partialCharge",1,"float32"),le.addField("radius",1,"float32"));var ue=U.getAtomProxy(),ce=U.getAtomProxy(),he=0,pe=0,de=!0;this.streamer.eachChunkOfLines(function(t){!function(t,r,n){for(var ie=t;ie<r;++ie)if(u=n[ie],"ATOM  "===(c=u.substr(0,6))||"HETATM"===c){if(de&&($?(X?(i=new Float32Array(3*le.count),W.push(i)):i=[],o=0):H||(Y={}),R=(P=1).toString(),I=!0,de=!1),H&&pe>0)continue;var fe=void 0,me=void 0,ge=void 0,ve=void 0,ye=void 0;if(L){if(ye=10===(ve=u.split(ew)).length?1:0,v=ve[2],G&&"CA"!==v)continue;fe=parseFloat(ve[6-ye]),me=parseFloat(ve[7-ye]),ge=parseFloat(ve[8-ye])}else{if(v=u.substr(12,4).trim(),G&&"CA"!==v)continue;fe=parseFloat(u.substr(30,8)),me=parseFloat(u.substr(38,8)),ge=parseFloat(u.substr(46,8))}if($){var be=3*o;if(i[be+0]=fe,i[be+1]=me,i[be+2]=ge,o+=1,X)continue}var we=void 0;L?(h=parseInt(ve[1]),we="",y="H"===u[0]?1:0,p=ye?"":ve[4],d=parseInt(ve[5-ye]),g="",f=ve[3],w="",m=0):(h=parseInt(u.substr(6,5),z),B&&99999===h&&(z=16),y="H"===u[0]?1:0,p=u[21].trim(),d=parseInt(u.substr(22,4),j),B&&9999===d&&(j=16),g=u[26].trim(),f=u.substr(17,4).trim()||"MOL",b=parseFloat(u.substr(60,6)),w=u[16].trim(),m=parseFloat(u.substr(54,6)),e||(we=u.substr(76,2).trim(),p||(p=u.substr(72,4).trim()))),le.growIfFull(),le.atomTypeId[he]=se.add(v,we),le.x[he]=fe,le.y[he]=me,le.z[he]=ge,le.serial[he]=h,le.altloc[he]=w.charCodeAt(0),le.occupancy[he]=isNaN(m)?0:m,L?(le.partialCharge[he]=parseFloat(ve[9-ye]),le.radius[he]=parseFloat(ve[10-ye])):le.bfactor[he]=isNaN(b)?0:b;var xe=tw(d,p,g);!y||te[xe]||Jb.includes(f)?I||N===p||(R=(P+=1).toString()):N===p&&k===f&&(Qh.includes(f)||D===d&&O===g)||(R=(P+=1).toString(),D=d,k=f,O=g),V.addAtom(pe,p,R,f,d,y,void 0,g),Y[h]=he,he+=1,I=!1,N=p}else if("CONECT"===c){var _e=Y[parseInt(u.substr(6,5))],Se=[11,16,21,26],Ce={};if(void 0===_e)continue;for(var Me=0;Me<4;++Me){var Te=parseInt(u.substr(Se[Me],5));if(!Number.isNaN(Te)&&void 0!==(Te=Y[Te]))if(_e<Te?(ue.index=_e,ce.index=Te):(ue.index=Te,ce.index=_e),void 0!==Ce[Te])U.bondStore.bondOrder[Ce[Te]]+=1;else{var Ae=ue.index+"|"+ce.index;void 0===J[Ae]&&(J[Ae]=!0,Ce[Te]=U.bondStore.count,U.bondStore.addBond(ue,ce,1))}}}else if("HELIX "===c){x=u[19].trim(),_=parseInt(u.substr(21,4)),S=u[25].trim(),C=u[31].trim(),M=parseInt(u.substr(33,4)),T=u[37].trim();var Ee=parseInt(u.substr(39,1));Ee=(Zb[Ee]||Zb[""]).charCodeAt(0),oe.push([x,_,S,C,M,T,Ee])}else if("SHEET "===c)x=u[21].trim(),_=parseInt(u.substr(22,4)),S=u[26].trim(),C=u[32].trim(),M=parseInt(u.substr(33,4)),T=u[37].trim(),ae.push([x,_,S,C,M,T]);else if("HETNAM"===c)ee[u.substr(11,3)]=u.substr(15).trim();else if("SEQRES"===c){var Pe=u[11].trim();Pe!==F&&(ne[Pe]=[],F=Pe),(ht=ne[Pe]).push.apply(ht,u.substr(19).trim().split(ew))}else if("MODRES"===c){var Re=u.substr(12,3).trim(),Ie=u[16].trim(),Ne=u[22].trim(),De=parseInt(u.substr(18,4).trim()),ke=tw(De,Ie,Ne);te[ke]={resname:Re,chainname:Ie,inscode:Ne,resno:De}}else if("COMPND"===c){var Oe=u.substr(10,70).trim(),Fe=Oe.indexOf(":"),Le=Oe.substring(0,Fe),Ue=void 0;Qb.includes(Le)?(E=Le,Ue=Oe.substring(Fe+2)):Ue=Oe,Ue=Ue.replace(/;$/,""),"MOL_ID"===E?(A={chainList:[],name:""},Q.push(A)):"MOLECULE"===E?(A.name&&(A.name+=" "),A.name+=Ue):"CHAIN"===E&&Array.prototype.push.apply(A.chainList,Ue.split(/\s*,\s*/))}else if(u.startsWith("TER")){var Ve=U.getChainProxy(U.chainStore.count-1);re[Ve.chainname]=Ve.index,R=(P+=1).toString(),I=!0}else if("REMARK"===c&&"350"===u.substr(7,3)){if("BIOMOLECULE:"===u.substr(11,12)){var Be=u.substr(23).trim();/^(0|[1-9][0-9]*)$/.test(Be)&&(Be="BU"+Be),a=new Lf(Be),K[Be]=a}else if("BIOMT"===u.substr(13,5)){var ze=u.split(/\s+/),je=parseInt(u[18])-1;0===je&&(l=new pt,s.matrixList.push(l));var He=l.elements;He[0+je]=parseFloat(ze[4]),He[4+je]=parseFloat(ze[5]),He[8+je]=parseFloat(ze[6]),He[12+je]=parseFloat(ze[7])}else if("APPLY THE FOLLOWING TO CHAINS:"===u.substr(11,30)||"                   AND CHAINS:"===u.substr(11,30)){"APPLY"===u.substr(11,5)&&(s=a.addPart());for(var $e=u.substr(41,30).split(","),Ge=0,We=$e.length;Ge<We;++Ge){var qe=$e[Ge].trim();qe&&s.chainList.push(qe)}}}else if("HEADER"===c)U.id=u.substr(62,4);else if("TITLE "===c)U.title+=(U.title?" ":"")+u.substr(10,70).trim();else if("MODEL "===c)de=!0;else if("ENDMDL"===c||u.startsWith("END")){if(de)continue;$&&!X&&(W.push(new Float32Array(i)),X=!0),pe+=1,de=!0}else if("MTRIX"===u.substr(0,5)){if("1"===u[59])continue;a&&"NCS"===a.name||(a=new Lf("NCS"),K.NCS=a,s=a.addPart());var Xe=u.split(/\s+/),Ke=parseInt(u[5])-1;0===Ke&&(l=new pt,s.matrixList.push(l));var Ye=l.elements;Ye[0+Ke]=parseFloat(Xe[2]),Ye[4+Ke]=parseFloat(Xe[3]),Ye[8+Ke]=parseFloat(Xe[4]),Ye[12+Ke]=parseFloat(Xe[5])}else if("ORIGX"===u.substr(0,5)){Z.origx||(Z.origx=new pt);var Ze=u.split(/\s+/),Je=parseInt(u[5])-1,Qe=Z.origx.elements;Qe[0+Je]=parseFloat(Ze[1]),Qe[4+Je]=parseFloat(Ze[2]),Qe[8+Je]=parseFloat(Ze[3]),Qe[12+Je]=parseFloat(Ze[4])}else if("SCALE"===u.substr(0,5)){Z.scale||(Z.scale=new pt);var et=u.split(/\s+/),tt=parseInt(u[5])-1,rt=Z.scale.elements;rt[0+tt]=parseFloat(et[1]),rt[4+tt]=parseFloat(et[2]),rt[8+tt]=parseFloat(et[3]),rt[12+tt]=parseFloat(et[4])}else if("CRYST1"===c){var nt=parseFloat(u.substr(6,9)),it=parseFloat(u.substr(15,9)),ot=parseFloat(u.substr(24,9)),at=parseFloat(u.substr(33,7)),st=parseFloat(u.substr(40,7)),lt=parseFloat(u.substr(47,7)),ut=u.substr(55,11).trim(),ct=new Float32Array(9);ct[0]=nt,ct[4]=it,ct[8]=ot,q.push(ct),0===pe&&(Z.a=nt,Z.b=it,Z.c=ot,Z.alpha=at,Z.beta=st,Z.gamma=lt,Z.spacegroup=ut)}var ht}(0,t.length,t)});var fe=Q.length;if(fe){U.eachChain(function(e){e.entityIndex=fe}),Q.forEach(function(e,t){var r=e.chainList.map(function(e){return re[e]});U.entityList.push(new qb(U,t,e.name,"polymer",r))});var me=Q.length,ge=U.getResidueProxy(),ve={};U.eachChain(function(e){e.entityIndex===fe&&(ge.index=e.residueOffset,ve[ge.resname]||(ve[ge.resname]=[]),ve[ge.resname].push(e.index))}),Object.keys(ve).forEach(function(e){var t=ve[e],r="non-polymer",n=ee[e]||e;Qh.includes(e)&&(n="water",r="water"),U.entityList.push(new qb(U,me,n,r,t)),me+=1})}void 0!==Z.a?U.unitcell=new Yb(Z):U.unitcell=void 0,(oe.length||ae.length)&&zf(U,ie),V.finalize(),U.finalizeAtoms(),e||Gf(U),Wf(U),U.finalizeBonds(),oe.length||ae.length||jf(U),Zf(U),vl&&gl.timeEnd("PdbParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("pdb",rw),Tl.add("pdb1",rw),Tl.add("ent",rw);var nw=/\s+/,iw=/'((?:(?!'\s).)*)'|"((?:(?!"\s).)*)"|(\S+)/g,ow=/"/g,aw=/^['"]+|['"]+$/g;function sw(e){return!e||e[0]!==e[e.length-1]||"'"!==e[0]&&'"'!==e[0]?e:e.substring(1,e.length-1)}function lw(e,t){Array.isArray(e[t])||Object.keys(e).forEach(function(t){e[t]=[e[t]]})}function uw(e){return"?"!==e}function cw(e,t){return uw(e)?e:t}function hw(e){switch(e.toLowerCase()){case"?":case"sing":return 1;case"doub":return 2;case"trip":return 3;case"quad":return 4}return 0}var pw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"cif"},t.prototype._parse=function(){gl.time("CifParser._parse "+this.name);var e,t,r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x=this.structure,_=this.structureBuilder,S=this.firstModelOnly,C=this.asTrajectory,M=this.cAlphaOnly,T=x.frames,A={},E={},P={},R=!1,I=null,N=!1,D=!1,k=!1,O=[],F=null,L=null,U=null,V=null,B=[],z=x.atomMap,j=x.atomStore;j.resize(this.streamer.data.length/100);var H,$=0,G=0;if(this.streamer.eachChunkOfLines(function(W){!function(W,q,X){for(var K=W;K<q;++K)if(r=X[K],((n=r.trim())||R||D)&&"#"!==n[0])if("data_"===n.substring(0,5))A.data=n.substring(5).trim();else if(";"===n[0])R?(D?(F===O.length&&(F=0),O[F].push(I),F+=1):!1===U?A[L]=I:A[L][U]=I,R=!1,I=null):(R=!0,I=n.substring(1));else if("loop_"===n)D=!0,k=!0,O.length=0,B.length=0,F=0;else if("_"===n[0]){var Y,Z,J;if(D&&!k&&(D=!1),D)Z=(Y=n.split("."))[0].substring(1),J=Y[1],1===Y.length?(J=!1,A[Z]||(A[Z]=[]),O.push(A[Z])):(A[Z]||(A[Z]={}),A[Z][J]?vl&&gl.warn(Z,J,"already exists"):(A[Z][J]=[],O.push(A[Z][J]),B.push(J))),L=Z,U=J,V=!0;else{var Q=n.match(iw),ee=Q[0],te=Q[1];Z=(Y=ee.split("."))[0].substring(1),J=Y[1],1===Y.length?(J=!1,A[Z]=te):(A[Z]||(A[Z]={}),A[Z][J]?vl&&gl.warn(Z,J,"already exists"):A[Z][J]=te),te||(N=!0),L=Z,U=J}}else if(R)I+=r;else if(D){if(!n)continue;if("atom_site"===L){var re=n.split(nw);V&&(i=B.indexOf("auth_asym_id"),o=B.indexOf("auth_seq_id"),a=B.indexOf("label_atom_id"),s=B.indexOf("label_comp_id"),l=B.indexOf("label_asym_id"),u=B.indexOf("label_entity_id"),c=B.indexOf("label_alt_id"),g=B.indexOf("Cartn_x"),v=B.indexOf("Cartn_y"),y=B.indexOf("Cartn_z"),p=B.indexOf("id"),d=B.indexOf("type_symbol"),h=B.indexOf("group_PDB"),b=B.indexOf("B_iso_or_equiv"),f=B.indexOf("pdbx_PDB_model_num"),m=B.indexOf("pdbx_PDB_ins_code"),w=B.indexOf("occupancy"),V=!1,H=parseInt(re[f]),C&&(e=[],t=0));var ne=parseInt(re[f]);if(H!==ne&&(C&&(0===G&&T.push(new Float32Array(e)),e=new Float32Array(3*j.count),T.push(e),t=0),G+=1),H=ne,S&&G>0)continue;var ie=re[a].replace(ow,"");if(M&&"CA"!==ie)continue;var oe=parseFloat(re[g]),ae=parseFloat(re[v]),se=parseFloat(re[y]);if(C){var le=3*t;if(e[le+0]=oe,e[le+1]=ae,e[le+2]=se,t+=1,G>0)continue}var ue=re[s],ce=parseInt(re[o]),he=re[m];he="?"===he?"":he;var pe=re[i],de=re[l],fe="H"===re[h][0]?1:0,me=re[d],ge=parseFloat(re[b]),ve=parseFloat(re[w]),ye=re[c];if(ye="."===ye?"":ye,j.growIfFull(),j.atomTypeId[$]=z.add(ie,me),j.x[$]=oe,j.y[$]=ae,j.z[$]=se,j.serial[$]=parseInt(re[p]),j.bfactor[$]=isNaN(ge)?0:ge,j.occupancy[$]=isNaN(ve)?0:ve,j.altloc[$]=ye.charCodeAt(0),_.addAtom(G,pe,de,ue,ce,fe,void 0,he),vl){var be=E[de];void 0!==be&&be!==pe&&vl&&gl.warn(be,pe)}E[de]=pe;var we=re[u];P[we]||(P[we]=new Set),P[we].add(x.chainStore.count-1),$+=1}else{var xe=n.match(iw),_e=xe.length;F===O.length&&(F=0);for(var Se=0;Se<_e;++Se)O[F+Se].push(xe[Se]);F+=_e}k=!1}else if("'"===n[0]&&"'"===n[n.length-1]){var Ce=n.substring(1,n.length-1);!1===U?A[L]=Ce:A[L][U]=Ce}else N?!1===U?A[L]=n:A[L][U]=n:vl&&gl.log("CifParser._parse: unknown state",n);else R=!1,D=!1,N=!1,O.length=0,F=null,L=null,U=null,V=null,B.length=0}(0,W.length,W)}),A.chem_comp&&A.chem_comp_atom)!function(e,t,r){var n,i,o=t.atomStore,a=t.atomMap,s=e.chem_comp,l=e.chem_comp_atom,u=e.chem_comp_bond;s&&(s.name&&(t.title=s.name.trim().replace(aw,"")),s.id&&(t.id=s.id.trim().replace(aw,"")));var c={};if(l){var h,p,d,f;for(i=l.comp_id.length,n=0;n<i;++n)o.growIfFull(),h=l.atom_id[n].replace(ow,""),p=l.type_symbol[n],c[h]=n,o.atomTypeId[n]=a.add(h,p),o.x[n]=l.model_Cartn_x[n],o.y[n]=l.model_Cartn_y[n],o.z[n]=l.model_Cartn_z[n],o.serial[n]=n,d=l.pdbx_component_comp_id[n],f=l.pdbx_residue_numbering?l.pdbx_residue_numbering[n]:1,r.addAtom(0,"","",d,f,1);for(n=0;n<i;++n){var m=n+i;o.growIfFull(),h=l.atom_id[n].replace(ow,""),p=l.type_symbol[n],o.atomTypeId[m]=a.add(h,p),o.x[m]=l.pdbx_model_Cartn_x_ideal[n],o.y[m]=l.pdbx_model_Cartn_y_ideal[n],o.z[m]=l.pdbx_model_Cartn_z_ideal[n],o.serial[m]=m,d=l.pdbx_component_comp_id[n],f=l.pdbx_residue_numbering?l.pdbx_residue_numbering[n]:1,r.addAtom(1,"","",d,f,1)}}if(l&&u){var g,v,y;i=u.comp_id.length;var b=l.comp_id.length,w=t.getAtomProxy(),x=t.getAtomProxy();for(n=0;n<i;++n)g=u.atom_id_1[n].replace(ow,""),v=u.atom_id_2[n].replace(ow,""),y=hw(u.value_order[n]),w.index=c[g],x.index=c[v],t.bondStore.growIfFull(),t.bondStore.addBond(w,x,y),w.index+=b,x.index+=b,t.bondStore.growIfFull(),t.bondStore.addBond(w,x,y)}}(A,x,_),_.finalize(),x.finalizeAtoms(),x.finalizeBonds(),tm(x);else if(A.atom_site_type_symbol&&A.atom_site_label&&A.atom_site_fract_x)!function(e,t,r){var n=t.atomStore,i=t.atomMap;e.data&&(t.id=e.data,t.name=e.data),t.unitcell=new Yb({a:parseFloat(e.cell_length_a),b:parseFloat(e.cell_length_b),c:parseFloat(e.cell_length_c),alpha:parseFloat(e.cell_angle_alpha),beta:parseFloat(e.cell_angle_beta),gamma:parseFloat(e.cell_angle_gamma),spacegroup:sw(e.symmetry_space_group_name_H)});for(var o=new ft,a=new ft,s=e.atom_site_type_symbol.length,l=0;l<s;++l){n.growIfFull();var u=e.atom_site_label[l],c=e.atom_site_type_symbol[l];n.atomTypeId[l]=i.add(u,c),o.set(e.atom_site_fract_x[l],e.atom_site_fract_y[l],e.atom_site_fract_z[l]),o.applyMatrix4(t.unitcell.fracToCart),a.add(o),n.x[l]=o.x,n.y[l]=o.y,n.z[l]=o.z,e.atom_site_occupancy&&(n.occupancy[l]=parseFloat(e.atom_site_occupancy[l])),n.serial[l]=l,r.addAtom(0,"","","HET",1,1)}a.divideScalar(s),t.center=a,Zf(t);var h=new ft,p=new ft,d=t.biomolDict.SUPERCELL.partList[0].matrixList,f=s;function m(e){return i.get(n.atomTypeId[e]).covalent}for(var g=new pt,v=function(e){var t=m(e);o.set(n.x[e],n.y[e],n.z[e]),d.forEach(function(i){if(!g.equals(i)){h.copy(o),h.applyMatrix4(i);for(var a=0;a<s;++a){p.set(n.x[a],n.y[a],n.z[a]);var l=h.distanceToSquared(p),u=m(a)+t,c=u+.3,d=u-.5;if(l<c*c&&l>d*d)return n.growIfFull(),n.atomTypeId[f]=n.atomTypeId[e],n.x[f]=h.x,n.y[f]=h.y,n.z[f]=h.z,n.occupancy[f]=n.occupancy[e],n.serial[f]=f,n.altloc[f]="A".charCodeAt(0),r.addAtom(0,"","","HET",1,1),void(f+=1)}}})},y=0;y<s;++y)v(y)}(A,x,_),_.finalize(),x.finalizeAtoms(),Wf(x),x.finalizeBonds();else{var W=function(e,t,r){var n,i,o,a,s=[],l=[],u=e.struct_conf;if(u)for(lw(u,"id"),n=0,i=u.beg_auth_seq_id.length;n<i;++n){var c=parseInt(u.pdbx_PDB_helix_class[n]);Number.isNaN(c)||(o=u.pdbx_beg_PDB_ins_code[n],a=u.pdbx_end_PDB_ins_code[n],s.push([r[u.beg_label_asym_id[n]],parseInt(u.beg_auth_seq_id[n]),cw(o,""),r[u.end_label_asym_id[n]],parseInt(u.end_auth_seq_id[n]),cw(a,""),(Zb[c]||Zb[""]).charCodeAt(0)]))}var h=e.struct_sheet_range;if(h)for(lw(h,"id"),n=0,i=h.beg_auth_seq_id.length;n<i;++n)o=h.pdbx_beg_PDB_ins_code[n],a=h.pdbx_end_PDB_ins_code[n],l.push([r[h.beg_label_asym_id[n]],parseInt(h.beg_auth_seq_id[n]),cw(o,""),r[h.end_label_asym_id[n]],parseInt(h.end_auth_seq_id[n]),cw(a,"")]);return!(!u&&!h)&&{helices:s,sheets:l}}(A,0,E);if(function(e,t,r){var n={},i=t.biomolDict;if(e.pdbx_struct_oper_list){var o=e.pdbx_struct_oper_list;lw(o,"id"),o.id.forEach(function(e,t){var r=new pt,i=r.elements;i[0]=parseFloat(o["matrix[1][1]"][t]),i[1]=parseFloat(o["matrix[1][2]"][t]),i[2]=parseFloat(o["matrix[1][3]"][t]),i[4]=parseFloat(o["matrix[2][1]"][t]),i[5]=parseFloat(o["matrix[2][2]"][t]),i[6]=parseFloat(o["matrix[2][3]"][t]),i[8]=parseFloat(o["matrix[3][1]"][t]),i[9]=parseFloat(o["matrix[3][2]"][t]),i[10]=parseFloat(o["matrix[3][3]"][t]),i[3]=parseFloat(o["vector[1]"][t]),i[7]=parseFloat(o["vector[2]"][t]),i[11]=parseFloat(o["vector[3]"][t]),r.transpose(),n[e]=r})}if(e.pdbx_struct_assembly_gen){var a=e.pdbx_struct_assembly_gen;lw(a,"assembly_id");var s=function(e){var t={};return e.replace(/[()']/g,"").split(",").forEach(function(e){if(e.includes("-"))for(var r=e.split("-"),i=parseInt(r[0]),o=parseInt(r[1]);i<=o;++i)t[i]=n[i];else t[e]=n[e]}),t};a.assembly_id.forEach(function(e,t){var n={},o=a.oper_expression[t].replace(/['"]\(|['"]/g,"");if(o.includes(")(")||o.indexOf("(")>0){o=o.split("(");var l=s(o[0]),u=s(o[1]);Object.keys(l).forEach(function(e){Object.keys(u).forEach(function(t){var r=new pt;r.multiplyMatrices(l[e],u[t]),n[e+"x"+t]=r})})}else n=s(o);var c=[];for(var h in n)c.push(n[h]);var p=e;/^(0|[1-9][0-9]*)$/.test(p)&&(p="BU"+p);for(var d=a.asym_id_list[t].split(","),f=0,m=d.length;f<m;++f)d[f]=r[d[f]];void 0===i[p]&&(i[p]=new Lf(p)),i[p].addPart(c,d)})}if(e.struct_ncs_oper){var l=e.struct_ncs_oper;lw(l,"id"),i.NCS=new Lf("NCS");var u=i.NCS.addPart();l.id.forEach(function(e,t){if("given"!==l.code[t]){var r=new pt,n=r.elements;n[0]=parseFloat(l["matrix[1][1]"][t]),n[1]=parseFloat(l["matrix[1][2]"][t]),n[2]=parseFloat(l["matrix[1][3]"][t]),n[4]=parseFloat(l["matrix[2][1]"][t]),n[5]=parseFloat(l["matrix[2][2]"][t]),n[6]=parseFloat(l["matrix[2][3]"][t]),n[8]=parseFloat(l["matrix[3][1]"][t]),n[9]=parseFloat(l["matrix[3][2]"][t]),n[10]=parseFloat(l["matrix[3][3]"][t]),n[3]=parseFloat(l["vector[1]"][t]),n[7]=parseFloat(l["vector[2]"][t]),n[11]=parseFloat(l["vector[3]"][t]),r.transpose(),u.matrixList.push(r)}}),0===u.matrixList.length&&delete i.NCS}var c={};if(e.cell){var h=e.cell,p=parseFloat(h.length_a),d=parseFloat(h.length_b),f=parseFloat(h.length_c),m=new Float32Array(9);m[0]=p,m[4]=d,m[8]=f,t.boxes.push(m),c.a=p,c.b=d,c.c=f,c.alpha=parseFloat(h.angle_alpha),c.beta=parseFloat(h.angle_beta),c.gamma=parseFloat(h.angle_gamma)}e.symmetry&&(c.spacegroup=sw(e.symmetry["space_group_name_H-M"]));var g=new pt;if(e.database_PDB_matrix){var v=e.database_PDB_matrix,y=g.elements;y[0]=parseFloat(v["origx[1][1]"]),y[1]=parseFloat(v["origx[1][2]"]),y[2]=parseFloat(v["origx[1][3]"]),y[4]=parseFloat(v["origx[2][1]"]),y[5]=parseFloat(v["origx[2][2]"]),y[6]=parseFloat(v["origx[2][3]"]),y[8]=parseFloat(v["origx[3][1]"]),y[9]=parseFloat(v["origx[3][2]"]),y[10]=parseFloat(v["origx[3][3]"]),y[3]=parseFloat(v["origx_vector[1]"]),y[7]=parseFloat(v["origx_vector[2]"]),y[11]=parseFloat(v["origx_vector[3]"]),g.transpose(),c.origx=g}var b=new pt;if(e.atom_sites){var w=e.atom_sites,x=b.elements;x[0]=parseFloat(w["fract_transf_matrix[1][1]"]),x[1]=parseFloat(w["fract_transf_matrix[1][2]"]),x[2]=parseFloat(w["fract_transf_matrix[1][3]"]),x[4]=parseFloat(w["fract_transf_matrix[2][1]"]),x[5]=parseFloat(w["fract_transf_matrix[2][2]"]),x[6]=parseFloat(w["fract_transf_matrix[2][3]"]),x[8]=parseFloat(w["fract_transf_matrix[3][1]"]),x[9]=parseFloat(w["fract_transf_matrix[3][2]"]),x[10]=parseFloat(w["fract_transf_matrix[3][3]"]),x[3]=parseFloat(w["fract_transf_vector[1]"]),x[7]=parseFloat(w["fract_transf_vector[2]"]),x[11]=parseFloat(w["fract_transf_vector[3]"]),b.transpose(),c.scale=b}void 0!==c.a?t.unitcell=new Yb(c):t.unitcell=void 0}(A,x,E),function(e,t,r){var n=e.struct_conn;if(n){lw(n,"id");for(var i=/"/g,o=t.getAtomProxy(),a=t.getAtomProxy(),s={},l=0,u=n.id.length;l<u;++l){var c=n.conn_type_id[l];if("hydrog"!==c&&"mismat"!==c&&"saltbr"!==c&&"1_555"===n.ptnr1_symmetry[l]&&"1_555"===n.ptnr2_symmetry[l]){var h=n.pdbx_ptnr1_PDB_ins_code[l],p=n.pdbx_ptnr1_label_alt_id[l],d=n.ptnr1_auth_seq_id[l]+(uw(h)?"^"+h:"")+":"+r[n.ptnr1_label_asym_id[l]]+"."+n.ptnr1_label_atom_id[l].replace(i,"")+(uw(p)?"%"+p:""),f=s[d];if(!f){var m=new el(d);if(m.selection.error){vl&&gl.warn("invalid selection for connection",d);continue}f=t.getAtomIndices(m),s[d]=f}var g=n.pdbx_ptnr2_PDB_ins_code[l],v=n.pdbx_ptnr2_label_alt_id[l],y=n.ptnr2_auth_seq_id[l]+(uw(g)?"^"+g:"")+":"+r[n.ptnr2_label_asym_id[l]]+"."+n.ptnr2_label_atom_id[l].replace(i,"")+(uw(v)?"%"+v:""),b=s[y];if(!b){var w=new el(y);if(w.selection.error){vl&&gl.warn("invalid selection for connection",y);continue}b=t.getAtomIndices(w),s[y]=b}var x=f.length,_=b.length;if(x>_){var S=x;x=_,_=S;var C=f;f=b,b=C}if(0!==x&&0!==_)for(var M=0;M<_;++M)o.index=f[M%x],a.index=b[M],o&&a?t.bondStore.addBond(o,a,hw(n.pdbx_value_order[l])):gl.log("atoms for connection not found");else vl&&gl.warn("no atoms found for",d,y)}}}}(A,x,E),function(e,t,r){if(e.entity){lw(e.entity,"id");for(var n=e.entity,i=n.id.length,o=0;o<i;++o){var a=n.pdbx_description[o],s=n.type[o],l=Array.from(r[n.id[o]]);t.entityList[o]=new qb(t,o,a,s,l)}}}(A,x,P),A.struct&&A.struct.title&&(x.title=A.struct.title.trim().replace(aw,"")),A.entry&&A.entry.id&&(x.id=A.entry.id.trim().replace(aw,"")),A.pdbx_audit_revision_history){if(A.pdbx_audit_revision_history.revision_date){lw(A.pdbx_audit_revision_history,"revision_date");var q=A.pdbx_audit_revision_history.revision_date.filter(uw);q.length&&(x.header.releaseDate=q[0])}if(A.pdbx_database_status.recvd_initial_deposition_date){lw(A.pdbx_database_status,"recvd_initial_deposition_date");var X=A.pdbx_database_status.recvd_initial_deposition_date.filter(uw);X.length&&(x.header.depositionDate=X[0])}}else if(A.database_PDB_rev){if(A.database_PDB_rev.date){lw(A.database_PDB_rev,"date");var K=A.database_PDB_rev.date.filter(uw);K.length&&(x.header.releaseDate=K[0])}if(A.database_PDB_rev.date_original){lw(A.database_PDB_rev,"date_original");var Y=A.database_PDB_rev.date_original.filter(uw);Y.length&&(x.header.depositionDate=Y[0])}}A.reflns&&A.reflns.d_resolution_high?uw(A.reflns.d_resolution_high)&&(x.header.resolution=parseFloat(A.reflns.d_resolution_high)):A.refine&&A.refine.ls_d_res_high&&uw(A.refine.ls_d_res_high)&&(x.header.resolution=parseFloat(A.refine.ls_d_res_high)),A.refine&&A.refine.ls_R_factor_R_free&&uw(A.refine.ls_R_factor_R_free)&&(x.header.rFree=parseFloat(A.refine.ls_R_factor_R_free)),A.refine&&A.refine.ls_R_factor_R_work&&uw(A.refine.ls_R_factor_R_work)&&(x.header.rWork=parseFloat(A.refine.ls_R_factor_R_work)),A.exptl&&A.exptl.method&&(lw(A.exptl,"method"),x.header.experimentalMethods=A.exptl.method.map(function(e){return e.replace(aw,"")})),_.finalize(),x.finalizeAtoms(),Wf(x),x.finalizeBonds(),W?zf(x,W):jf(x),Zf(x),x.extraData.cif=A}vl&&gl.timeEnd("CifParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("cif",pw),Tl.add("mcif",pw),Tl.add("mmcif",pw);var dw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"gro"},t.prototype._parse=function(){vl&&gl.time("GroParser._parse "+this.name);var e,t,r=this.structure,n=this.structureBuilder,i=this.firstModelOnly,o=this.asTrajectory,a=this.cAlphaOnly,s=r.frames,l=r.boxes,u=this.streamer.peekLines(3);r.title=u[0].trim();var c,h,p,d,f=5+(u[2].length-u[2].lastIndexOf(".")-1),m=20,g=20+f,v=20+2*f,y=parseInt(u[1]),b=y+3,w=r.atomMap,x=r.atomStore;x.resize(y);var _=0,S=0,C=0;this.streamer.eachChunkOfLines(function(r){!function(r,u,M){for(var T=r;T<u;++T){var A=++C-1,E=M[T];if(E)if(A%b==0)o&&(e=new Float32Array(3*y),s.push(e),t=0);else if(A%b==1);else if(A%b==b-1){var P=E.trim().split(/\s+/),R=new Float32Array(9);if(R[0]=10*parseFloat(P[0]),R[4]=10*parseFloat(P[1]),R[8]=10*parseFloat(P[2]),l.push(R),i)return!0;S+=1}else{if(c=E.substr(10,5).trim(),a&&"CA"!==c)continue;var I=10*parseFloat(E.substr(m,f)),N=10*parseFloat(E.substr(g,f)),D=10*parseFloat(E.substr(v,f));if(o){var k=3*t;if(e[k+0]=I,e[k+1]=N,e[k+2]=D,t+=1,A>b)continue}h=E.substr(5,5).trim(),p=parseInt(E.substr(0,5)),d=parseInt(E.substr(15,5)),x.growIfFull(),x.atomTypeId[_]=w.add(c),x.x[_]=I,x.y[_]=N,x.z[_]=D,x.serial[_]=d,n.addAtom(S,"","",h,p,0,"l"),_+=1}}}(0,r.length,r)}),n.finalize(),r.finalizeAtoms(),Gf(r),Wf(r),r.finalizeBonds(),jf(r),vl&&gl.timeEnd("GroParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("gro",dw);var fw=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"].concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]);function mw(e,t,r){return t?new e(t.buffer,t.byteOffset,t.byteLength/(r||1)):void 0}function gw(e){return mw(DataView,e)}function vw(e){return mw(Int8Array,e)}function yw(e){return mw(Int32Array,e,4)}function bw(e,t){var r=e.length/2;t||(t=new Int16Array(r));for(var n=0,i=0;n<r;++n,i+=2)t[n]=e[i]<<8^e[i+1]<<0;return t}function ww(e,t){var r=e.length/4;t||(t=new Int32Array(r));for(var n=0,i=0;n<r;++n,i+=4)t[n]=e[i]<<24^e[i+1]<<16^e[i+2]<<8^e[i+3]<<0;return t}function xw(e,t,r){var n=e.length,i=1/t;r||(r=new Float32Array(n));for(var o=0;o<n;++o)r[o]=e[o]*i;return r}function _w(e,t){var r,n;if(!t){var i=0;for(r=0,n=e.length;r<n;r+=2)i+=e[r+1];t=new e.constructor(i)}var o=0;for(r=0,n=e.length;r<n;r+=2)for(var a=e[r],s=e[r+1],l=0;l<s;++l)t[o]=a,++o;return t}function Sw(e,t){var r=e.length;t||(t=new e.constructor(r)),r&&(t[0]=e[0]);for(var n=1;n<r;++n)t[n]=e[n]+t[n-1];return t}function Cw(e,t){var r,n,i=e instanceof Int8Array?127:32767,o=-i-1,a=e.length;if(!t){var s=0;for(r=0;r<a;++r)e[r]<i&&e[r]>o&&++s;t=new Int32Array(s)}for(r=0,n=0;r<a;){for(var l=0;e[r]===i||e[r]===o;)l+=e[r],++r;l+=e[r],++r,t[n]=l,++n}return t}function Mw(e,t,r){return xw(Cw(e,yw(r)),t,r)}function Tw(e,t,r){var n=Cw(e,yw(r));return function(e,t,r){return xw(Sw(e,yw(r)),t,r)}(n,t,function(e){return mw(Float32Array,e,4)}(n))}function Aw(e){var t=0,r=new DataView(e.buffer);function n(e){for(var t={},r=0;r<e;r++){t[s()]=s()}return t}function i(r){var n=e.subarray(t,t+r);return t+=r,n}function o(r){var n=e.subarray(t,t+r);t+=r;if(r>65535){for(var i=[],o=0;o<n.length;o+=65535)i.push(String.fromCharCode.apply(null,n.subarray(o,o+65535)));return i.join("")}return String.fromCharCode.apply(null,n)}function a(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=s();return t}function s(){var s,l,u=e[t];if(0==(128&u))return t++,u;if(128==(240&u))return t++,n(l=15&u);if(144==(240&u))return t++,a(l=15&u);if(160==(224&u))return t++,o(l=31&u);if(224==(224&u))return s=r.getInt8(t),t++,s;switch(u){case 192:return t++,null;case 194:return t++,!1;case 195:return t++,!0;case 196:return l=r.getUint8(t+1),t+=2,i(l);case 197:return l=r.getUint16(t+1),t+=3,i(l);case 198:return l=r.getUint32(t+1),t+=5,i(l);case 202:return s=r.getFloat32(t+1),t+=5,s;case 203:return s=r.getFloat64(t+1),t+=9,s;case 204:return s=e[t+1],t+=2,s;case 205:return s=r.getUint16(t+1),t+=3,s;case 206:return s=r.getUint32(t+1),t+=5,s;case 208:return s=r.getInt8(t+1),t+=2,s;case 209:return s=r.getInt16(t+1),t+=3,s;case 210:return s=r.getInt32(t+1),t+=5,s;case 217:return l=r.getUint8(t+1),t+=2,o(l);case 218:return l=r.getUint16(t+1),t+=3,o(l);case 219:return l=r.getUint32(t+1),t+=5,o(l);case 220:return l=r.getUint16(t+1),t+=3,a(l);case 221:return l=r.getUint32(t+1),t+=5,a(l);case 222:return l=r.getUint16(t+1),t+=3,n(l);case 223:return l=r.getUint32(t+1),t+=5,n(l)}throw new Error("Unknown type 0x"+u.toString(16))}return s()}function Ew(e,t,r,n){switch(e){case 1:return function(e,t){var r=e.length;t||(t=new Float32Array(r/4));for(var n=gw(t),i=gw(e),o=0,a=0,s=r/4;o<s;++o,a+=4)n.setFloat32(a,i.getFloat32(a),!0);return t}(t);case 2:return vw(t);case 3:return bw(t);case 4:return ww(t);case 5:return function(e){return mw(Uint8Array,e)}(t);case 6:return _w(ww(t),new Uint8Array(r));case 7:return _w(ww(t));case 8:return function(e,t){return Sw(_w(e),t)}(ww(t));case 9:return function(e,t,r){return xw(_w(e,yw(r)),t,r)}(ww(t),ww(n)[0]);case 10:return Tw(bw(t),ww(n)[0]);case 11:return xw(bw(t),ww(n)[0]);case 12:return Mw(bw(t),ww(n)[0]);case 13:return Mw(vw(t),ww(n)[0]);case 14:return Cw(bw(t));case 15:return Cw(vw(t))}}function Pw(e,t){var r=(t=t||{}).ignoreFields,n={};return fw.forEach(function(t){var i=!!r&&-1!==r.indexOf(t),o=e[t];i||void 0===o||(o instanceof Uint8Array?n[t]=Ew.apply(null,function(e){var t=gw(e),r=t.getInt32(0),n=t.getInt32(4),i=e.subarray(8,12);return[r,e=e.subarray(12),n,i]}(o)):n[t]=o)}),n}var Rw={0:"i".charCodeAt(0),1:"s".charCodeAt(0),2:"h".charCodeAt(0),3:"e".charCodeAt(0),4:"g".charCodeAt(0),5:"b".charCodeAt(0),6:"t".charCodeAt(0),7:"l".charCodeAt(0),"-1":"".charCodeAt(0)},Iw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"mmtf"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){var e,t,r,n,i;vl&&gl.time("MmtfParser._parse "+this.name);var o,a,s,l,u,c,h=this.structure,p=Pw(Aw(this.streamer.data));if(["depositionDate","releaseDate","resolution","rFree","rWork","experimentalMethods"].forEach(function(e){void 0!==p[e]&&(h.header[e]=p[e])}),h.id=p.structureId,h.title=p.title,h.atomStore.addField("formalCharge",1,"int8"),this.firstModelOnly||this.asTrajectory){for(u=1,s=0,e=0,t=l=p.chainsPerModel[0];e<t;++e)s+=p.groupsPerChain[e];for(a=0,e=0,t=s;e<t;++e)a+=(i=p.groupList[p.groupTypeList[e]]).atomNameList.length;o=p.numBonds,c=[l]}else o=p.numBonds,a=p.numAtoms,s=p.numGroups,l=p.numChains,u=p.numModels,c=p.chainsPerModel;if(o+=s,this.asTrajectory)for(e=0,t=p.numModels;e<t;++e){var d=new Float32Array(3*a),f=a*e;for(r=0;r<a;++r){var m=3*r,g=r+f;d[m]=p.xCoordList[g],d[m+1]=p.yCoordList[g],d[m+2]=p.zCoordList[g]}h.frames.push(d)}var v=new Uint32Array(o),y=new Uint32Array(o),b=new Uint8Array(o),w=new Uint32Array(a),x=new Int8Array(a),_=new Uint32Array(s),S=new Uint32Array(s),C=new Uint16Array(s),M=new Uint16Array(l),T=new Uint32Array(l),A=new Uint32Array(l),E=new Uint32Array(u),P=new Uint32Array(u),R=0;for(e=0,t=u;e<t;++e){var I=c[e];for(E[e]=R,P[e]=I,r=0;r<I;++r)M[r+R]=e;R+=I}var N=p.groupsPerChain,D=0;for(e=0,t=l;e<t;++e){var k=N[e];for(T[e]=D,A[e]=k,r=0;r<k;++r)_[r+D]=e;D+=k}var O=0,F=0;for(e=0,t=s;e<t;++e){var L=(i=p.groupList[p.groupTypeList[e]]).atomNameList.length,U=i.formalChargeList,V=i.bondAtomList,B=i.bondOrderList;for(r=0,n=B.length;r<n;++r)v[F]=O+V[2*r],y[F]=O+V[2*r+1],b[F]=B[r],F+=1;for(S[e]=O,C[e]=L,r=0;r<L;++r)w[O]=e,x[O]=U[r],O+=1}var z=p.bondAtomList;if(z)for(p.bondOrderList&&b.set(p.bondOrderList,F),e=0,t=z.length;e<t;e+=2){var j=z[e],H=z[e+1];j<a&&H<a&&(v[F]=j,y[F]=H,F+=1)}h.bondStore.length=b.length,h.bondStore.count=F,h.bondStore.atomIndex1=v,h.bondStore.atomIndex2=y,h.bondStore.bondOrder=b,h.atomStore.length=a,h.atomStore.count=a,h.atomStore.residueIndex=w,h.atomStore.atomTypeId=new Uint16Array(a),h.atomStore.x=p.xCoordList.subarray(0,a),h.atomStore.y=p.yCoordList.subarray(0,a),h.atomStore.z=p.zCoordList.subarray(0,a),h.atomStore.serial=p.atomIdList.subarray(0,a),h.atomStore.bfactor=p.bFactorList.subarray(0,a),h.atomStore.altloc=p.altLocList.subarray(0,a),h.atomStore.occupancy=p.occupancyList.subarray(0,a),h.atomStore.formalCharge=x,h.residueStore.length=s,h.residueStore.count=s,h.residueStore.chainIndex=_,h.residueStore.residueTypeId=p.groupTypeList,h.residueStore.atomOffset=S,h.residueStore.atomCount=C,h.residueStore.resno=p.groupIdList.subarray(0,s),h.residueStore.sstruc=p.secStructList.subarray(0,s),h.residueStore.inscode=p.insCodeList.subarray(0,s),h.chainStore.length=l,h.chainStore.count=l,h.chainStore.entityIndex=new Uint16Array(l),h.chainStore.modelIndex=M,h.chainStore.residueOffset=T,h.chainStore.residueCount=A,h.chainStore.chainname=p.chainNameList.subarray(0,4*l),h.chainStore.chainid=p.chainIdList.subarray(0,4*l),h.modelStore.length=u,h.modelStore.count=u,h.modelStore.chainOffset=E,h.modelStore.chainCount=P;var $={};for(e=0,t=p.groupList.length;e<t;++e){var G=p.groupList[e],W=[];for(r=0,n=G.atomNameList.length;r<n;++r){var q=G.elementList[r].toUpperCase(),X=G.atomNameList[r];W.push(h.atomMap.add(X,q))}var K=G.chemCompType.toUpperCase(),Y=Fh.includes(K),Z=G.bondOrderList.length,J=new Array(Z),Q=new Array(Z);for(r=0;r<Z;++r)J[r]=G.bondAtomList[2*r],Q[r]=G.bondAtomList[2*r+1];var ee={atomIndices1:J,atomIndices2:Q,bondOrders:G.bondOrderList};$[e]=h.residueMap.add(G.groupName,W,Y,K,ee)}for(e=0,t=s;e<t;++e)h.residueStore.residueTypeId[e]=$[h.residueStore.residueTypeId[e]];for(e=0,t=h.atomStore.count;e<t;++e){var te=h.atomStore.residueIndex[e],re=h.residueMap.list[h.residueStore.residueTypeId[te]],ne=h.residueStore.atomOffset[te];h.atomStore.atomTypeId[e]=re.atomTypeIdList[e-ne]}if(p.secStructList){var ie=p.secStructList.length;for(e=0,t=h.residueStore.count;e<t;++e){var oe=Rw[h.residueStore.sstruc[e%ie]];void 0!==oe&&(h.residueStore.sstruc[e]=oe)}}if(p.entityList&&p.entityList.forEach(function(e,t){h.entityList[t]=new qb(h,t,e.description,e.type,e.chainIndexList)}),p.bioAssemblyList&&p.bioAssemblyList.forEach(function(e,t){var r=t+1,n=new Lf(r);h.biomolDict["BU"+r]=n;var i={};e.transformList.forEach(function(e){var t=(new pt).fromArray(e.matrix).transpose(),r=e.chainIndexList.map(function(e){for(var t="",r=0;r<4;++r){var n=p.chainNameList[4*e+r];if(!n)break;t+=String.fromCharCode(n)}return t}),o=i[r];o?o.matrixList.push(t):i[r]=n.addPart([t],r)})}),p.ncsOperatorList){var ae=new Lf("NCS"),se=ae.addPart();p.ncsOperatorList.forEach(function(e){var t=(new pt).fromArray(e).transpose();se.matrixList.push(t)}),se.matrixList.length>0&&(h.biomolDict.NCS=ae)}var le=p.unitCell;le&&Array.isArray(le)&&le[0]?h.unitcell=new Yb({a:le[0],b:le[1],c:le[2],alpha:le[3],beta:le[4],gamma:le[5],spacegroup:p.spaceGroup}):h.unitcell=void 0,Yf(h,!0),Kf(h,!0),h.finalizeAtoms(),h.finalizeBonds(),Zf(h),vl&&gl.timeEnd("MmtfParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("mmtf",Iw);var Nw=/\s+/,Dw={1:1,2:2,3:3,am:1,ar:1,du:1,un:1,nc:0},kw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"mol2"},t.prototype._parse=function(){vl&&gl.time("Mol2Parser._parse "+this.name);var e,t,r=this.structure,n=this.structureBuilder,i=this.firstModelOnly,o=this.asTrajectory,a=r.frames,s=!1,l=r.atomMap,u=r.atomStore;u.resize(Math.round(this.streamer.data.length/60)),u.addField("partialCharge",1,"float32");var c=0,h=0,p=0,d=-1,f=0,m=0,g=1,v=2,y=3,b=r.getAtomProxy(),w=r.getAtomProxy();this.streamer.eachChunkOfLines(function(x){!function(x,_,S){for(var C=x;C<_;++C){var M=S[C].trim();if(""!==M&&"#"!==M[0])if("@"===M[0])"@<TRIPOS>MOLECULE"===M?(m=g,h=0,++d):"@<TRIPOS>ATOM"===M?(m=v,p=u.count,o&&(t=0,e=new Float32Array(3*f),a.push(e),d>0&&(s=!0))):m="@<TRIPOS>BOND"===M?y:0;else if(m===g){if(0===h)r.title=M,r.id=M;else if(1===h){var T=M.split(Nw);f=parseInt(T[0])}++h}else if(m===v){var A=M.split(Nw);if(i&&d>0)continue;var E=parseFloat(A[2]),P=parseFloat(A[3]),R=parseFloat(A[4]);if(o){var I=3*t;if(e[I+0]=E,e[I+1]=P,e[I+2]=R,t+=1,s)continue}var N=A[0],D=A[1],k=A[5].split(".")[0],O=A[6]?parseInt(A[6]):1,F=A[7]?A[7]:"",L=A[8]?parseFloat(A[8]):0;u.growIfFull(),u.atomTypeId[c]=l.add(D,k),u.x[c]=E,u.y[c]=P,u.z[c]=R,u.serial[c]=N,u.partialCharge[c]=L,n.addAtom(d,"","",F,O,1),c+=1}else if(m===y){if(i&&d>0)continue;if(o&&d>0)continue;var U=M.split(Nw);b.index=parseInt(U[1])-1+p,w.index=parseInt(U[2])-1+p;var V=Dw[U[3]];r.bondStore.addBond(b,w,V)}}}(0,x.length,x)}),n.finalize(),r.finalizeAtoms(),Gf(r),Kf(r,!0),Yf(r,!0),r.finalizeBonds(),tm(r),jf(r),vl&&gl.timeEnd("Mol2Parser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("mol2",kw);var Ow=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"pqr"},Object.defineProperties(t.prototype,r),t}(rw);Tl.add("pqr",Ow);var Fw=/> <(.+)>/,Lw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"sdf"},t.prototype._parse=function(){vl&&gl.time("SdfParser._parse "+this.name);var e=this.structure,t=this.structureBuilder,r=this.firstModelOnly,n=this.asTrajectory,i=this.streamer.peekLines(2);e.id=i[0].trim(),e.title=i[1].trim();var o,a,s=e.frames,l=!1,u=e.atomMap,c=e.atomStore;c.resize(Math.round(this.streamer.data.length/50)),c.addField("formalCharge",1,"int8");var h,p,d,f,m,g,v,y=e.getAtomProxy(),b=e.getAtomProxy(),w=0,x=0,_=0,S=0,C=[],M=!1,T={};e.extraData.sdf=C,this.streamer.eachChunkOfLines(function(i){!function(i,A,E){for(var P=i;P<A;++P){var R=E[P];if("$$$$"===R.substr(0,4))x=-1,++_,S=c.count,C.push(T),T={},M=!1;else if(3===x)p=parseInt(R.substr(0,3)),d=parseInt(R.substr(3,3)),v=(g=m=(f=4)+p)+d,n&&(a=0,o=new Float32Array(3*p),s.push(o),_>0&&(l=!0));else if(x>=f&&x<m){if(r&&_>0)continue;var I=parseFloat(R.substr(0,10)),N=parseFloat(R.substr(10,10)),D=parseFloat(R.substr(20,10));if(n){var k=3*a;if(o[k+0]=I,o[k+1]=N,o[k+2]=D,a+=1,l)continue}var O=R.substr(31,3).trim(),F=O+(w+1);c.growIfFull(),c.atomTypeId[w]=u.add(F,O),c.x[w]=I,c.y[w]=N,c.z[w]=D,c.serial[w]=w,c.formalCharge[w]=0,t.addAtom(_,"","","HET",1,1),w+=1}else if(x>=g&&x<v){if(r&&_>0)continue;if(n&&_>0)continue;y.index=parseInt(R.substr(0,3))-1+S,b.index=parseInt(R.substr(3,3))-1+S;var L=parseInt(R.substr(6,3));e.bondStore.addBond(y,b,L)}else if(R.match(/M {2}CHG/))for(var U=parseInt(R.substr(6,3)),V=0,B=10;V<U;++V,B+=8){var z=parseInt(R.substr(B,3))-1+S,j=parseInt(R.substr(B+4,3));c.formalCharge[z]=j}else(h=R.match(Fw))?(M=h[1],T[M]=[]):!1!==M&&R&&T[M].push(R);++x}}(0,i.length,i)}),t.finalize(),e.finalizeAtoms(),e.finalizeBonds(),tm(e),vl&&gl.timeEnd("SdfParser._parse "+this.name)},t.prototype._postProcess=function(){tm(this.structure)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("sdf",Lw),Tl.add("sd",Lw);var Uw=18.2223,Vw=1,Bw=2,zw=3,jw=4,Hw=5,$w=6,Gw=7,Ww=8,qw=9,Xw=10;function Kw(e,t,r){return parseInt(e.substr(t,r).trim())}var Yw=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"prmtop"},t.prototype._parse=function(){vl&&gl.time("PrmtopParser._parse "+this.name);var e=this.structure,t=this.structureBuilder,r=e.atomMap,n=e.atomStore;n.addField("partialCharge",1,"float32"),n.addField("radius",1,"float32");var i,o,a,s,l,u,c,h,p,d,f,m=[],g={},v=["NATOM","NTYPES","NBONH","MBONA","NTHETH","MTHETA","NPHIH","MPHIA","NHPARM","NPARM","NNB","NRES","NBONA","NTHETA","NPHIA","NUMBND","NUMANG","NPTRA","NATYP","NPHB","IFPERT","NBPER","NGPER","NDPER","MBPER","MGPER","MDPER","IFBOX","NMXRS","IFCAP","NUMEXTRA","NCOPY"];v.forEach(function(e){g[e]=0}),this.streamer.eachChunkOfLines(function(e){!function(e,t,r){for(var y=e;y<t;++y){var b=r[y],w=b.trim();if(w)if(b.startsWith("%FORMAT"));else if(b.startsWith("%FLAG")){var x=b.substr(5).trim();d=0,"TITLE"===x?p=Vw:"POINTERS"===x?p=Bw:"ATOM_NAME"===x?p=zw:"CHARGE"===x?p=jw:"MASS"===x?p=Hw:"RESIDUE_LABEL"===x?p=$w:"RESIDUE_POINTER"===x?p=Gw:"BONDS_INC_HYDROGEN"===x?(f=0,p=Ww):"BONDS_WITHOUT_HYDROGEN"===x?(f=g.NBONH,p=qw):p="RADII"===x?Xw:void 0}else if(p===Vw)m.push(w);else if(p===Bw){for(var _=Math.min(d+10,32),S=0;d<_;++S,++d)g[v[d]]=parseInt(b.substr(8*S,8).trim());i=new Array(g.NATOM),o=new Float32Array(g.NATOM),a=new Float32Array(g.NATOM),n.resize(g.NATOM);var C=g.NBONH+g.MBONA;s=new Uint32Array(C),l=new Uint32Array(C),u=new Uint8Array(C),c=new Array(g.NRES),h=new Uint32Array(g.NRES)}else if(p===zw)for(var M=Math.min(d+20,g.NATOM),T=0;d<M;++T,++d)i[d]=b.substr(4*T,4).trim();else if(p===jw)for(var A=Math.min(d+5,g.NATOM),E=0;d<A;++E,++d)o[d]=parseFloat(b.substr(16*E,16))/Uw;else if(p===Hw);else if(p===$w)for(var P=Math.min(d+20,g.NRES),R=0;d<P;++R,++d)c[d]=b.substr(4*R,4).trim();else if(p===Gw)for(var I=Math.min(d+10,g.NRES),N=0;d<I;++N,++d)h[d]=Kw(b,8*N,8);else if(p===Ww)for(var D=Math.min(d+10,3*g.NBONH),k=0;d<D;++k,++d){var O=d%3;0===O&&(s[f]=Kw(b,8*k,8)/3),1===O&&(l[f]=Kw(b,8*k,8)/3,u[f]=1,++f)}else if(p===qw)for(var F=Math.min(d+10,3*g.MBONA),L=0;d<F;++L,++d){var U=d%3;0===U&&(s[f]=Kw(b,8*L,8)/3),1===U&&(l[f]=Kw(b,8*L,8)/3,u[f]=1,++f)}else if(p===Xw)for(var V=Math.min(d+5,g.NATOM),B=0;d<V;++B,++d)a[d]=parseFloat(b.substr(16*B,16))}}(0,e.length,e)}),e.title=m.join(" ");for(var y=g.NATOM,b=0,w=c[0],x=1,_=0;_<y;++_)_+1===h[b+1]&&(w=c[++b],x=b+1),n.atomTypeId[_]=r.add(i[_]),n.serial[_]=_+1,t.addAtom(0,"","",w,x);n.partialCharge.set(o),n.radius.set(a),e.bondStore.length=u.length,e.bondStore.count=u.length,e.bondStore.atomIndex1=s,e.bondStore.atomIndex2=l,e.bondStore.bondOrder=u,t.finalize(),e.finalizeAtoms(),e.finalizeBonds(),Kf(e,!0),Yf(e,!0,!0),Gf(e,!0),tm(e),vl&&gl.timeEnd("PrmtopParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("prmtop",Yw),Tl.add("parm7",Yw);var Zw=1,Jw=2,Qw=3,ex=4,tx=5,rx=6,nx=/\s+/,ix=/(^\*|REMARK)*/,ox=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"psf"},t.prototype._parse=function(){vl&&gl.time("PsfParser._parse "+this.name);var e=this.structure,t=this.structureBuilder,r=e.atomMap,n=e.atomStore;n.addField("partialCharge",1,"float32");var i,o,a,s,l,u,c=[],h=0,p=0,d=0;this.streamer.eachChunkOfLines(function(e){!function(e,f,m){for(var g=e;g<f;++g){var v=m[g].trim();if(v)if(i===Jw){var y=v.split(nx),b=parseInt(y[0]),w=y[1],x=parseInt(y[2]),_=y[3],S=y[4],C=parseFloat(y[6]);w!==a&&(o=$f(p),++p),n.growIfFull(),n.atomTypeId[h]=r.add(S),n.serial[h]=b,n.partialCharge[h]=C,t.addAtom(0,o,o,_,x),h+=1,a=w}else if(i===Qw)for(var M=v.split(nx),T=0,A=M.length;T<A;T+=2)s[d]=parseInt(M[T])-1,l[d]=parseInt(M[T+1])-1,u[d]=1,d+=1;else if(i===Zw)c.push(v.replace(ix,"").trim());else if(i===ex);else if(i===tx);else if(i===rx);else if(v.includes("!NATOM")){i=Jw;var E=parseInt(v.split(nx)[0]);n.resize(E)}else if(v.includes("!NBOND")){i=Qw;var P=parseInt(v.split(nx)[0]);s=new Uint32Array(P),l=new Uint32Array(P),u=new Uint8Array(P)}else v.includes("!NTITLE")?i=Zw:v.includes("!NTHETA")?i=ex:v.includes("!NPHI")?i=tx:v.includes("!NIMPHI")&&(i=rx);else i=void 0}}(0,e.length,e)}),e.title=c.join(" "),e.bondStore.length=u.length,e.bondStore.count=d,e.bondStore.atomIndex1=s,e.bondStore.atomIndex2=l,e.bondStore.bondOrder=u,t.finalize(),e.finalizeAtoms(),e.finalizeBonds(),Kf(e,!0),Yf(e,!0,!0),tm(e),vl&&gl.timeEnd("PsfParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("psf",ox);var ax=1,sx=2,lx=3,ux=4,cx=5,hx=/\[ (.+) \]/,px=/\s+/,dx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"top"},t.prototype._parse=function(){vl&&gl.time("TopParser._parse "+this.name);var e=this.structure,t=this.structureBuilder,r=e.atomMap,n=e.bondStore,i=e.atomStore;i.addField("partialCharge",1,"float32");var o,a,s=[],l={};this.streamer.eachChunkOfLines(function(t){!function(t,r,n){for(var i=t;i<r;++i){var u=n[i],c=u.trim();if(c&&"*"!==c[0]&&";"!==c[0]){if(c.startsWith("#include"))throw new Error("TopParser: #include statements not allowed");var h=u.match(hx);if(null===h){var p=c.indexOf(";");if(-1!==p&&(c=c.substring(0,p).trim()),a===lx){var d=c.split(px)[0];l[d]=o}else if(a===ux){var f=c.split(px);o.atoms.push([parseInt(f[2]),f[3],f[4],parseFloat(f[6])])}else if(a===cx){var m=c.split(px);o.bonds.push([parseInt(m[0]),parseInt(m[1])])}else if(a===ax)e.title=c;else if(a===sx){var g=c.split(px);s.push([g[0],parseInt(g[1])])}}else{var v=h[1];"moleculetype"===v?(a=lx,o={atoms:[],bonds:[]}):a="atoms"===v?ux:"bonds"===v?cx:"system"===v?ax:"molecules"===v?sx:void 0}}}}(0,t.length,t)});var u=0,c=0;s.forEach(function(e){var t=e[0],r=e[1],n=l[t];u+=r*n.atoms.length,c+=r*n.bonds.length}),i.resize(u),n.resize(c);var h,p=0,d=0,f=0,m=0,g=0,v=0;s.forEach(function(e){for(var o=e[0],a=e[1],s=l[o],u=$f(m),c=function(e){h=-1;var a=Qh.includes(o)?u:$f(f);s.atoms.forEach(function(e){var n=e[0],o=e[1],s=e[2],l=e[3];n!==h&&++d,i.atomTypeId[p]=r.add(s),i.serial[p]=p+1,i.partialCharge[p]=l,t.addAtom(0,u,a,o,d+1),++p,h=n}),s.bonds.forEach(function(e){n.atomIndex1[g]=v+e[0]-1,n.atomIndex2[g]=v+e[1]-1,++g}),++f,v+=s.atoms.length},y=0;y<a;++y)c();++m}),n.count=c,t.finalize(),e.finalizeAtoms(),e.finalizeBonds(),Kf(e,!0),Yf(e,!0,!0),tm(e),vl&&gl.timeEnd("TopParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Wb);Tl.add("top",dx);var fx=function(e){function t(t,r){e.call(this,t,r),this.frames=new Sg(this.name,this.path)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"trajectory"},r.__objName.get=function(){return"frames"},Object.defineProperties(t.prototype,r),t}(Hb),mx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dcd"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("DcdParser._parse "+this.name);var e=os(this.streamer.data),t=new DataView(e),r=this.frames,n=r.coordinates,i=r.boxes,o={},a=0,s=new Int32Array(e,0,23),l=s[0]!==t.getInt32(0);if(84!==s[0])for(var u=e.byteLength,c=0;c<u;c+=4)t.setFloat32(c,t.getFloat32(c),!0);84!==s[0]&&gl.error("dcd bad format, header block start"),"CORD"!==String.fromCharCode(t.getUint8(4),t.getUint8(5),t.getUint8(6),t.getUint8(7))&&gl.error("dcd bad format, format string");var h=!1,p=!1,d=!1;0!==s[22]&&(h=!0,0!==s[12]&&(p=!0),1===s[13]&&(d=!0)),o.NSET=s[2],o.ISTART=s[3],o.NSAVC=s[4],o.NAMNF=s[10],o.DELTA=h?t.getFloat32(44,l):t.getFloat64(44,l),84!==s[22]&&gl.error("dcd bad format, header block end"),a=a+84+8;var f=t.getInt32(a,l),m=a+1;if((f-4)%80!=0&&gl.error("dcd bad format, title block start"),o.TITLE=rs(new Uint8Array(e,m,f)),t.getInt32(m+f+4-1,l)!==f&&gl.error("dcd bad format, title block end"),a=a+f+8,4!==t.getInt32(a,l)&&gl.error("dcd bad format, natom block start"),o.NATOM=t.getInt32(a+4,l),4!==t.getInt32(a+8,l)&&gl.error("dcd bad format, natom block end"),a=a+4+8,o.NAMNF>0)gl.error("dcd format with fixed atoms unsupported, aborting");else{for(var g=o.NATOM,v=4*g,y=0,b=o.NSET;y<b;++y){if(p){a+=4;var w=new Float32Array(9);w[0]=t.getFloat64(a,l),w[4]=t.getFloat64(a+16,l),w[8]=t.getFloat64(a+40,l),i.push(w),a+=48,a+=4}for(var x=new Float32Array(3*g),_=0;_<3;++_){t.getInt32(a,l)!==v&&gl.error("dcd bad format, coord block start",y,_),a+=4;for(var S=new Float32Array(e,a,g),C=0;C<g;++C)x[3*C+_]=S[C];a+=v,t.getInt32(a,l)!==v&&gl.error("dcd bad format, coord block end",y,_),a+=4}if(n.push(x),d)a+=4+t.getInt32(a,l)+4}o.DELTA&&(r.deltaTime=20.45482949774598*o.DELTA),o.ISTART>=1&&(r.timeOffset=(o.ISTART-1)*r.deltaTime),vl&&gl.timeEnd("DcdParser._parse "+this.name)}},Object.defineProperties(t.prototype,r),t}(fx);function gx(e,t){if(e)throw new TypeError("Not a valid NetCDF v3.x file: "+t)}function vx(e){e.offset%4!=0&&e.skip(4-e.offset%4)}function yx(e){var t=e.readUint32(),r=e.readChars(t);return vx(e),r}Tl.add("dcd",mx);var bx={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function wx(e){switch(Number(e)){case bx.BYTE:return"byte";case bx.CHAR:return"char";case bx.SHORT:return"short";case bx.INT:return"int";case bx.FLOAT:return"float";case bx.DOUBLE:return"double";default:return"undefined"}}function xx(e){switch(Number(e)){case bx.BYTE:case bx.CHAR:return 1;case bx.SHORT:return 2;case bx.INT:case bx.FLOAT:return 4;case bx.DOUBLE:return 8;default:return-1}}function _x(e){switch(String(e)){case"byte":return bx.BYTE;case"char":return bx.CHAR;case"short":return bx.SHORT;case"int":return bx.INT;case"float":return bx.FLOAT;case"double":return bx.DOUBLE;default:return-1}}function Sx(e,t){if(1!==e){for(var r=new Array(e),n=0;n<e;n++)r[n]=t();return r}return t()}function Cx(e,t,r){switch(t){case bx.BYTE:return e.readBytes(r);case bx.CHAR:return function(e){if(0===e.charCodeAt(e.length-1))return e.substring(0,e.length-1);return e}(e.readChars(r));case bx.SHORT:return Sx(r,e.readInt16.bind(e));case bx.INT:return Sx(r,e.readInt32.bind(e));case bx.FLOAT:return Sx(r,e.readFloat32.bind(e));case bx.DOUBLE:return Sx(r,e.readFloat64.bind(e));default:return void gx(!0,"non valid type "+t)}}var Mx=0,Tx=10,Ax=11,Ex=12;function Px(e,t){var r={recordDimension:{length:e.readUint32()}};r.version=t;var n=function(e){var t,r,n,i=e.readUint32();if(i===Mx)return gx(e.readUint32()!==Mx,"wrong empty tag for list of dimensions"),[];gx(i!==Tx,"wrong tag for list of dimensions");var o=e.readUint32();t=new Array(o);for(var a=0;a<o;a++){var s=yx(e),l=e.readUint32();0===l&&(r=a,n=s),t[a]={name:s,size:l}}return{dimensions:t,recordId:r,recordName:n}}(e);r.recordDimension.id=n.recordId,r.recordDimension.name=n.recordName,r.dimensions=n.dimensions,r.globalAttributes=Rx(e);var i=function(e,t,r){var n,i=e.readUint32(),o=0;if(i===Mx)return gx(e.readUint32()!==Mx,"wrong empty tag for list of variables"),[];gx(i!==Ax,"wrong tag for list of variables");var a=e.readUint32();n=new Array(a);for(var s=0;s<a;s++){for(var l=yx(e),u=e.readUint32(),c=new Array(u),h=0;h<u;h++)c[h]=e.readUint32();var p=Rx(e),d=e.readUint32();gx(d<1&&d>6,"non valid type "+d);var f=e.readUint32(),m=e.readUint32();2===r&&(gx(m>0,"offsets larger than 4GB not supported"),m=e.readUint32()),c[0]===t&&(o+=f),n[s]={name:l,dimensions:c,attributes:p,type:wx(d),size:f,offset:m,record:c[0]===t}}return{variables:n,recordStep:o}}(e,n.recordId,t);return r.variables=i.variables,r.recordDimension.recordStep=i.recordStep,r}function Rx(e){var t,r=e.readUint32();if(r===Mx)return gx(e.readUint32()!==Mx,"wrong empty tag for list of attributes"),[];gx(r!==Ex,"wrong tag for list of attributes");var n=e.readUint32();t=new Array(n);for(var i=0;i<n;i++){var o=yx(e),a=e.readUint32();gx(a<1||a>6,"non valid type "+a);var s=Cx(e,a,e.readUint32());vx(e),t[i]={name:o,type:wx(a),value:s}}return t}var Ix=function(e){var t=new Kl(e);t.setBigEndian(),gx("CDF"!==t.readChars(3),"should start with CDF");var r=t.readByte();gx(r>2,"unknown version"),this.header=Px(t,r),this.buffer=t},Nx={version:{configurable:!0},recordDimension:{configurable:!0},dimensions:{configurable:!0},globalAttributes:{configurable:!0},variables:{configurable:!0}};Nx.version.get=function(){return 1===this.header.version?"classic format":"64-bit offset format"},Nx.recordDimension.get=function(){return this.header.recordDimension},Nx.dimensions.get=function(){return this.header.dimensions},Nx.globalAttributes.get=function(){return this.header.globalAttributes},Nx.variables.get=function(){return this.header.variables},Ix.prototype.hasDataVariable=function(e){return-1!==this.header.variables.findIndex(function(t){return t.name===e})},Ix.prototype.getDataVariable=function(e){var t;return gx(void 0===(t="string"==typeof e?this.header.variables.find(function(t){return t.name===e}):e),"variable not found"),this.buffer.seek(t.offset),t.record?function(e,t,r){for(var n=_x(t.type),i=t.size?t.size/xx(n):1,o=r.length,a=new Array(o),s=r.recordStep,l=0;l<o;l++){var u=e.offset;a[l]=Cx(e,n,i),e.seek(u+s)}return a}(this.buffer,t,this.header.recordDimension):function(e,t){for(var r=_x(t.type),n=t.size/xx(r),i=new Array(n),o=0;o<n;o++)i[o]=Cx(e,r,1);return i}(this.buffer,t)},Object.defineProperties(Ix.prototype,Nx);var Dx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"nctraj"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("NctrajParser._parse "+this.name);var e=new Ix(this.streamer.data),t=this.frames,r=t.coordinates,n=t.boxes,i=t.times;e.getDataVariable("coordinates").forEach(function(e){r.push(new Float32Array(e))}),e.hasDataVariable("cell_lengths")&&e.getDataVariable("cell_lengths").forEach(function(e){n.push(new Float32Array(e))}),e.hasDataVariable("time")&&e.getDataVariable("time").forEach(function(e){i.push(e)}),i.length>=1&&(t.timeOffset=i[0]),i.length>=2&&(t.deltaTime=i[1]-i[0]),vl&&gl.timeEnd("NctrajParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(fx);Tl.add("nctraj",Dx),Tl.add("ncdf",Dx),Tl.add("nc",Dx);var kx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"trr"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("TrrParser._parse "+this.name);for(var e=os(this.streamer.data),t=new DataView(e),r=this.frames,n=r.coordinates,i=r.boxes,o=r.times,a=0;;){a+=8;var s=t.getInt32(a);a+=4,a+=s;var l=t.getInt32(a+8),u=t.getInt32(a+12),c=t.getInt32(a+16),h=t.getInt32(a+28),p=t.getInt32(a+32),d=t.getInt32(a+36),f=t.getInt32(a+40);a+=52;var m=l/9,g=3*f;if(8===m?o.push(t.getFloat64(a)):o.push(t.getFloat32(a)),a+=2*m,l){var v=new Float32Array(9);if(8===m)for(var y=0;y<9;++y)v[y]=10*t.getFloat64(a),a+=8;else for(var b=0;b<9;++b)v[b]=10*t.getFloat32(a),a+=4;i.push(v)}if(a+=u,a+=c,h){var w=void 0;if(8===m){w=new Float32Array(g);for(var x=0;x<g;++x)w[x]=10*t.getFloat64(a),a+=8}else{for(var _=new Uint32Array(e,a,g),S=0;S<g;++S){var C=_[S];_[S]=(255&C)<<24|(65280&C)<<8|C>>8&65280|C>>24&255}w=new Float32Array(e,a,g);for(var M=0;M<g;++M)w[M]*=10,a+=4}n.push(w)}if(a+=p,(a+=d)>=e.byteLength)break}o.length>=1&&(r.timeOffset=o[0]),o.length>=2&&(r.deltaTime=o[1]-o[0]),vl&&gl.timeEnd("TrrParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(fx);Tl.add("trr",kx);var Ox=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]);function Fx(e){for(var t=1,r=0;e>=t&&r<32;)r++,t<<=1;return r}var Lx=new Uint8Array(32);function Ux(e,t){var r=1,n=0;Lx[0]=1;for(var i=0;i<e;i++){var o=void 0,a=0;for(o=0;o<r;o++)a+=Lx[o]*t[i],Lx[o]=255&a,a>>=8;for(;0!==a;)Lx[o++]=255&a,a>>=8;r=o}var s=1;for(r--;Lx[r]>=s;)n++,s*=2;return n+8*r}function Vx(e,t,r,n){for(var i=(1<<r)-1,o=n[1],a=n[2],s=e[0],l=0;r>=8;)l|=(a=a<<8|t[s++])>>o<<r-8,r-=8;return r>0&&(o<r&&(o+=8,a=a<<8|t[s++]),l|=a>>(o-=r)&(1<<r)-1),l&=i,e[0]=s,e[1]=o,e[2]=a,l}var Bx=new Int32Array(32);function zx(e,t,r,n,i,o,a){var s=0;for(Bx[1]=0,Bx[2]=0,Bx[3]=0;n>8;)Bx[s++]=Vx(e,t,8,a),n-=8;n>0&&(Bx[s++]=Vx(e,t,n,a));for(var l=r-1;l>0;l--){for(var u=0,c=s-1;c>=0;c--){var h=(u=u<<8|Bx[c])/i[l]|0;Bx[c]=h,u-=h*i[l]}o[l]=u}o[0]=Bx[0]|Bx[1]<<8|Bx[2]<<16|Bx[3]<<24}var jx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"xtc"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("XtcParser._parse "+this.name);for(var e=os(this.streamer.data),t=new DataView(e),r=this.frames,n=r.coordinates,i=r.boxes,o=r.times,a=new Int32Array(6),s=new Int32Array(3),l=new Int32Array(3),u=new Uint32Array(3),c=new Float32Array(3),h=new Float32Array(3),p=0,d=new Int32Array(3),f=new Uint32Array(d.buffer);;){var m=void 0,g=t.getInt32(p+4);p+=12;var v=3*g;o.push(t.getFloat32(p)),p+=4;for(var y=new Float32Array(9),b=0;b<9;++b)y[b]=10*t.getFloat32(p),p+=4;if(i.push(y),g<=9)for(var w=0;w<g;++w)m[w]=t.getFloat32(p),p+=4;else{d[0]=d[1]=d[2]=0,s[0]=s[1]=s[2]=0,u[0]=u[1]=u[2]=0,l[0]=l[1]=l[2]=0,c[0]=c[1]=c[2]=0,h[0]=h[1]=h[2]=0,m=new Float32Array(v);var x=0,_=t.getInt32(p);p+=4;var S=t.getFloat32(p);p+=4,a[0]=t.getInt32(p),a[1]=t.getInt32(p+4),a[2]=t.getInt32(p+8),a[3]=t.getInt32(p+12),a[4]=t.getInt32(p+16),a[5]=t.getInt32(p+20),s[0]=a[3]-a[0]+1,s[1]=a[4]-a[1]+1,s[2]=a[5]-a[2]+1,p+=24;var C=void 0;(s[0]|s[1]|s[2])>16777215?(l[0]=Fx(s[0]),l[1]=Fx(s[1]),l[2]=Fx(s[2]),C=0):C=Ux(3,s);var M=t.getInt32(p);p+=4;var T=M-1,A=Ox[T=9>T?9:T]/2|0,E=Ox[M]/2|0;u[0]=u[1]=u[2]=Ox[M];var P=4*Math.ceil(t.getInt32(p)/4);p+=4;var R=1/S,I=0,N=0,D=new Uint8Array(e,p);for(c[0]=c[1]=c[2]=0;N<_;){0===C?(c[0]=Vx(d,D,l[0],f),c[1]=Vx(d,D,l[1],f),c[2]=Vx(d,D,l[2],f)):zx(d,D,3,C,s,c,f),N++,c[0]+=a[0],c[1]+=a[1],c[2]+=a[2],h[0]=c[0],h[1]=c[1],h[2]=c[2];var k=0;if(1===Vx(d,D,1,f)&&(I=Vx(d,D,5,f),I-=k=I%3,k--),I>0){c[0]=c[1]=c[2]=0;for(var O=0;O<I;O+=3){if(zx(d,D,3,M,u,c,f),N++,c[0]+=h[0]-E,c[1]+=h[1]-E,c[2]+=h[2]-E,0===O){var F=c[0];c[0]=h[0],h[0]=F,F=c[1],c[1]=h[1],h[1]=F,F=c[2],c[2]=h[2],h[2]=F,m[x++]=h[0]*R,m[x++]=h[1]*R,m[x++]=h[2]*R}else h[0]=c[0],h[1]=c[1],h[2]=c[2];m[x++]=c[0]*R,m[x++]=c[1]*R,m[x++]=c[2]*R}}else m[x++]=c[0]*R,m[x++]=c[1]*R,m[x++]=c[2]*R;if(M+=k,k<0?(E=A,A=M>9?Ox[M-1]/2|0:0):k>0&&(A=E,E=Ox[M]/2|0),u[0]=u[1]=u[2]=Ox[M],0===u[0]||0===u[1]||0===u[2])return void console.error("(xdrfile error) Undefined error.")}p+=P}for(var L=0;L<v;L++)m[L]*=10;if(n.push(m),p>=e.byteLength)break}o.length>=1&&(r.timeOffset=o[0]),o.length>=2&&(r.deltaTime=o[1]-o[0]),vl&&gl.timeEnd("XtcParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(fx);Tl.add("xtc",jx);var Hx=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.volume=new Pd(this.name,this.path),this.voxelSize=Ha(n.voxelSize,1)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"volume"},r.__objName.get=function(){return"volume"},t.prototype._afterParse=function(){this.volume.setMatrix(this.getMatrix()),e.prototype._afterParse.call(this)},t.prototype.getMatrix=function(){return new pt},Object.defineProperties(t.prototype,r),t}(Hb),$x=/\s+/,Gx=/-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?/g,Wx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"cube"},t.prototype._parse=function(){vl&&gl.time("CubeParser._parse "+this.name);var e=this.volume,t=this.streamer.peekLines(6),r={},n=.529177210859*this.voxelSize;function i(e,r){var n=t[e].trim().split($x)[r];return parseFloat(n)}r.atomCount=Math.abs(i(2,0)),r.originX=.529177210859*i(2,1),r.originY=.529177210859*i(2,2),r.originZ=.529177210859*i(2,3),r.NVX=i(3,0),r.NVY=i(4,0),r.NVZ=i(5,0),r.basisX=new ft(i(3,1),i(3,2),i(3,3)).multiplyScalar(n),r.basisY=new ft(i(4,1),i(4,2),i(4,3)).multiplyScalar(n),r.basisZ=new ft(i(5,1),i(5,2),i(5,3)).multiplyScalar(n);var o=new Float32Array(r.NVX*r.NVY*r.NVZ),a=0,s=0,l=i(2,0)>0?0:1;this.streamer.eachChunkOfLines(function(e){!function(e,t,n){for(var i=e;i<t;++i){var u=n[i].trim();if(""!==u&&s>=r.atomCount+6+l)for(var c=u.match(Gx),h=0,p=c.length;h<p;++h)o[a]=parseFloat(c[h]),++a;++s}}(0,e.length,e)}),e.header=r,e.setData(o,r.NVZ,r.NVY,r.NVX),vl&&gl.timeEnd("CubeParser._parse "+this.name)},t.prototype.getMatrix=function(){var e=this.volume.header,t=new pt;return t.multiply((new pt).makeTranslation(e.originX,e.originY,e.originZ)),t.multiply((new pt).makeBasis(e.basisZ,e.basisY,e.basisX)),t},Object.defineProperties(t.prototype,r),t}(Hx);Tl.add("cub",Wx),Tl.add("cube",Wx);var qx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dsn6"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("Dsn6Parser._parse "+this.name);var e,t,r=this.volume,n={},i=os(this.streamer.data),o=new Int16Array(i),a=new Uint8Array(i),s=String.fromCharCode.apply(null,a.subarray(0,512));if(s.startsWith(":-)"))n.xStart=parseInt(s.substr(10,5)),n.yStart=parseInt(s.substr(15,5)),n.zStart=parseInt(s.substr(20,5)),n.xExtent=parseInt(s.substr(32,5)),n.yExtent=parseInt(s.substr(38,5)),n.zExtent=parseInt(s.substr(42,5)),n.xRate=parseInt(s.substr(52,5)),n.yRate=parseInt(s.substr(58,5)),n.zRate=parseInt(s.substr(62,5)),n.xlen=parseFloat(s.substr(73,10))*this.voxelSize,n.ylen=parseFloat(s.substr(83,10))*this.voxelSize,n.zlen=parseFloat(s.substr(93,10))*this.voxelSize,n.alpha=parseFloat(s.substr(103,10)),n.beta=parseFloat(s.substr(113,10)),n.gamma=parseFloat(s.substr(123,10)),e=parseFloat(s.substr(138,12))/100,t=parseInt(s.substr(155,8)),n.sigma=100*parseFloat(s.substr(170,12));else{if(100!==o[18])for(var l=0,u=o.length;l<u;++l){var c=o[l];o[l]=(255&c)<<8|c>>8&255}n.xStart=o[0],n.yStart=o[1],n.zStart=o[2],n.xExtent=o[3],n.yExtent=o[4],n.zExtent=o[5],n.xRate=o[6],n.yRate=o[7],n.zRate=o[8];var h=1/o[17],p=h*this.voxelSize;n.xlen=o[9]*p,n.ylen=o[10]*p,n.zlen=o[11]*p,n.alpha=o[12]*h,n.beta=o[13]*h,n.gamma=o[14]*h,e=o[15]/100,t=o[16],n.gamma=o[14]*h}r.header=n,vl&&gl.log(n,e,t);for(var d=new Float32Array(n.xExtent*n.yExtent*n.zExtent),f=512,m=Math.ceil(n.xExtent/8),g=Math.ceil(n.yExtent/8),v=Math.ceil(n.zExtent/8),y=0;y<v;++y)for(var b=0;b<g;++b)for(var w=0;w<m;++w)for(var x=0;x<8;++x)for(var _=8*y+x,S=0;S<8;++S)for(var C=8*b+S,M=0;M<8;++M){var T=8*w+M;if(!(T<n.xExtent&&C<n.yExtent&&_<n.zExtent)){f+=8-M;break}d[(T*n.yExtent+C)*n.zExtent+_]=(a[f]-t)/e,++f}r.setData(d,n.zExtent,n.yExtent,n.xExtent),n.sigma&&r.setStats(void 0,void 0,void 0,n.sigma),vl&&gl.timeEnd("Dsn6Parser._parse "+this.name)},t.prototype.getMatrix=function(){var e=this.volume.header,t=[e.xlen,0,0],r=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],n=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);var i=[0,t,r,n],o=[0,e.xRate,e.yRate,e.zRate],a=[0,1,2,3],s=new pt;return s.set(i[a[1]][0]/o[a[1]],i[a[2]][0]/o[a[2]],i[a[3]][0]/o[a[3]],0,i[a[1]][1]/o[a[1]],i[a[2]][1]/o[a[2]],i[a[3]][1]/o[a[3]],0,i[a[1]][2]/o[a[1]],i[a[2]][2]/o[a[2]],i[a[3]][2]/o[a[3]],0,0,0,0,1),s.multiply((new pt).makeRotationY(fs(90))),s.multiply((new pt).makeTranslation(-e.zStart,e.yStart,e.xStart)),s.multiply((new pt).makeScale(-1,1,1)),s},Object.defineProperties(t.prototype,r),t}(Hx);Tl.add("dsn6",qx),Tl.add("brix",qx);var Xx=/\s+/,Kx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"dx"},t.prototype._parse=function(){vl&&gl.time("DxParser._parse "+this.name);var e=this.volume,t=this.streamer.peekLines(30),r=this.parseHeaderLines(t),n=this.volume.header,i=r.dataLineStart,o=n.nx*n.ny*n.nz,a=new Float32Array(o),s=0,l=0;this.streamer.eachChunkOfLines(function(e){!function(e,t,r){for(var n=e;n<t;++n){if(s<o&&l>i){var u=r[n].trim();if(""!==u)for(var c=u.split(Xx),h=0,p=c.length;h<p;++h)a[s]=parseFloat(c[h]),++s}++l}}(0,e.length,e)}),e.setData(a,n.nz,n.ny,n.nx),vl&&gl.timeEnd("DxParser._parse "+this.name)},t.prototype.parseHeaderLines=function(e){for(var t={},r=e.length,n=0,i=0,o=0,a=0;a<r;++a){var s=void 0,l=e[a];if(l.startsWith("object 1"))s=l.split(Xx),t.nx=parseInt(s[5]),t.ny=parseInt(s[6]),t.nz=parseInt(s[7]);else if(l.startsWith("origin"))s=l.split(Xx),t.xmin=parseFloat(s[1]),t.ymin=parseFloat(s[2]),t.zmin=parseFloat(s[3]);else if(l.startsWith("delta"))s=l.split(Xx),0===o?t.hx=parseFloat(s[1])*this.voxelSize:1===o?t.hy=parseFloat(s[2])*this.voxelSize:2===o&&(t.hz=parseFloat(s[3])*this.voxelSize),o+=1;else if(l.startsWith("object 3")){n=a,i+=l.length+1;break}i+=l.length+1}return this.volume.header=t,{dataLineStart:n,headerByteCount:i}},t.prototype.getMatrix=function(){var e=this.volume.header,t=new pt;return t.multiply((new pt).makeRotationY(fs(90))),t.multiply((new pt).makeTranslation(-e.zmin,e.ymin,e.xmin)),t.multiply((new pt).makeScale(-e.hz,e.hy,e.hx)),t},Object.defineProperties(t.prototype,r),t}(Hx);Tl.add("dx",Kx);var Yx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"dxbin"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("DxbinParser._parse "+this.name);for(var e=os(this.streamer.data),t=function(e,t,r){void 0===t&&(t=10485760),void 0===r&&(r="\n");for(var n="",i=[],o=0;o<e.length;o+=t){var a=rs(e.subarray(o,o+t)),s=a.lastIndexOf(r);if(-1===s)n+=a;else{var l=n+a.substr(0,s);i=i.concat(l.split(r)),n=s===a.length-r.length?"":a.substr(s+r.length)}}return""!==n&&i.push(n),i}(new Uint8Array(e,0,1e3)),r=this.parseHeaderLines(t),n=this.volume.header,i=r.headerByteCount,o=n.nx*n.ny*n.nz,a=new DataView(e),s=new Float32Array(o),l=0;l<o;++l)s[l]=a.getFloat64(8*l+i,!0);this.volume.setData(s,n.nz,n.ny,n.nx),vl&&gl.timeEnd("DxbinParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Kx);Tl.add("dxbin",Yx);var Zx=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"mrc"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("MrcParser._parse "+this.name);var e,t=this.volume,r={},n=os(this.streamer.data),i=new Int32Array(n,0,56),o=new Float32Array(n,0,56),a=new DataView(n);if(r.MAP=String.fromCharCode(a.getUint8(208),a.getUint8(209),a.getUint8(210),a.getUint8(211)),r.MACHST=[a.getUint8(212),a.getUint8(213)],17===r.MACHST[0]&&17===r.MACHST[1])for(var s=n.byteLength,l=0;l<s;l+=4)a.setFloat32(l,a.getFloat32(l),!0);if(r.NX=i[0],r.NY=i[1],r.NZ=i[2],r.MODE=i[3],r.NXSTART=i[4],r.NYSTART=i[5],r.NZSTART=i[6],r.MX=i[7],r.MY=i[8],r.MZ=i[9],r.xlen=o[10]*this.voxelSize,r.ylen=o[11]*this.voxelSize,r.zlen=o[12]*this.voxelSize,r.alpha=o[13],r.beta=o[14],r.gamma=o[15],r.MAPC=i[16],r.MAPR=i[17],r.MAPS=i[18],r.DMIN=o[19],r.DMAX=o[20],r.DMEAN=o[21],r.ISPG=i[22],r.NSYMBT=i[23],r.LSKFLG=i[24],r.originX=o[49],r.originY=o[50],r.originZ=o[51],r.ARMS=o[54],t.header=r,2===r.MODE)e=new Float32Array(n,1024+r.NSYMBT,r.NX*r.NY*r.NZ);else if(0===r.MODE){if(e=new Float32Array(new Int8Array(n,1024+r.NSYMBT,r.NX*r.NY*r.NZ)),-128===i[39]&&127===i[40])for(var u=(r.DMAX-r.DMIN)/255,c=.5*(r.DMIN+r.DMAX+u),h=0,p=e.length;h<p;++h)e[h]=u*e[h]+c}else gl.error("MrcParser unknown mode",r.MODE);t.setData(e,r.NX,r.NY,r.NZ),0!==r.ARMS&&t.setStats(r.DMIN,r.DMAX,r.DMEAN,r.ARMS),vl&&gl.timeEnd("MrcParser._parse "+this.name)},t.prototype.getMatrix=function(){var e=this.volume.header,t=[e.xlen,0,0],r=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],n=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);var i=[0,t,r,n],o=[0,e.MX,e.MY,e.MZ],a=[0,e.MAPC,e.MAPR,e.MAPS],s=new pt;return s.set(i[a[1]][0]/o[a[1]],i[a[2]][0]/o[a[2]],i[a[3]][0]/o[a[3]],0,i[a[1]][1]/o[a[1]],i[a[2]][1]/o[a[2]],i[a[3]][1]/o[a[3]],0,i[a[1]][2]/o[a[1]],i[a[2]][2]/o[a[2]],i[a[3]][2]/o[a[3]],0,0,0,0,1),s.setPosition(new ft(e.originX,e.originY,e.originZ)),s.multiply((new pt).makeTranslation(e.NXSTART,e.NYSTART,e.NZSTART)),s},Object.defineProperties(t.prototype,r),t}(Hx);Tl.add("mrc",Zx),Tl.add("ccp4",Zx),Tl.add("map",Zx);var Jx=/\s+/;function Qx(e){return e.trim().split(Jx).map(parseFloat)}var e_=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"xplor"},t.prototype._parse=function(){vl&&gl.time("XplorParser._parse "+this.name);var e,t=this.volume,r=this.streamer.peekLines(8),n={},i=(e=r[2].startsWith("REMARKS")?parseInt(r[1].substring(0,8))+2:5)+3,o=Qx(r[e]);n.NA=o[0],n.AMIN=o[1],n.AMAX=o[2],n.NB=o[3],n.BMIN=o[4],n.BMAX=o[5],n.NC=o[6],n.CMIN=o[7],n.CMAX=o[8];var a=Qx(r[e+1]);n.a=a[0]*this.voxelSize,n.b=a[1]*this.voxelSize,n.c=a[2]*this.voxelSize,n.alpha=a[3],n.beta=a[4],n.gamma=a[5];var s=n.AMAX-n.AMIN+1,l=n.BMAX-n.BMIN+1,u=n.CMAX-n.CMIN+1,c=s*l*u,h=new Float32Array(c),p=1+s*l/6,d=0,f=0;this.streamer.eachChunkOfLines(function(e){!function(e,t,r){for(var o=e;o<t;++o){var a=r[o];if(f>=i&&(f-i)%p!=0&&d<c)for(var s=0;s<6;++s)h[d]=parseFloat(a.substr(12*s,12)),++d;else if(d===c){var l=a.trim();if(l&&"-9999"!==l){var u=Qx(a);n.RAVE=u[0],n.RSIGMA=u[1]}}++f}}(0,e.length,e)}),t.header=n,t.setData(h,s,l,u),0!==n.RAVE&&1!==n.RSIGMA&&t.setStats(void 0,void 0,n.RAVE,n.RSIGMA),vl&&gl.timeEnd("XplorParser._parse "+this.name)},t.prototype.getMatrix=function(){var e=this.volume.header,t=[e.a,0,0],r=[e.b*Math.cos(Math.PI/180*e.gamma),e.b*Math.sin(Math.PI/180*e.gamma),0],n=[e.c*Math.cos(Math.PI/180*e.beta),e.c*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];n[2]=Math.sqrt(e.c*e.c*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-n[1]*n[1]);var i=[0,t,r,n],o=[0,e.NA,e.NB,e.NC],a=[0,1,2,3],s=new pt;return s.set(i[a[1]][0]/o[a[1]],i[a[2]][0]/o[a[2]],i[a[3]][0]/o[a[3]],0,i[a[1]][1]/o[a[1]],i[a[2]][1]/o[a[2]],i[a[3]][1]/o[a[3]],0,i[a[1]][2]/o[a[1]],i[a[2]][2]/o[a[2]],i[a[3]][2]/o[a[3]],0,0,0,0,1),s.multiply((new pt).makeTranslation(e.AMIN,e.BMIN,e.CMIN)),s},Object.defineProperties(t.prototype,r),t}(Hx);Tl.add("xplor",e_),Tl.add("cns",e_);var t_=function(e){function t(t,r){e.call(this,t,r),this.loader=this.getLoader(),this.surface=new Td(this.name,this.path)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"surface"},r.__objName.get=function(){return"surface"},t.prototype._parse=function(){var e=this.loader.parse(this.streamer.asText());this.surface.fromGeometry(e)},Object.defineProperties(t.prototype,r),t}(Hb);function r_(){this.regexp={vertex_pattern:/^v\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,normal_pattern:/^vn\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,uv_pattern:/^vt\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}}r_.prototype={constructor:r_,setPath:function(e){this.path=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);this.object={name:e||"",geometry:{vertices:[],normals:[]},fromDeclaration:!1!==t},this.objects.push(this.object)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},addVertex:function(e,t,r){var n=this.vertices,i=this.object.geometry.vertices;i.push(n[e+0]),i.push(n[e+1]),i.push(n[e+2]),i.push(n[t+0]),i.push(n[t+1]),i.push(n[t+2]),i.push(n[r+0]),i.push(n[r+1]),i.push(n[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var n=this.normals,i=this.object.geometry.normals;i.push(n[e+0]),i.push(n[e+1]),i.push(n[e+2]),i.push(n[t+0]),i.push(n[t+1]),i.push(n[t+2]),i.push(n[r+0]),i.push(n[r+1]),i.push(n[r+2])},addFace:function(e,t,r,n,i,o,a,s){var l,u=this.vertices.length,c=this.parseVertexIndex(e,u),h=this.parseVertexIndex(t,u),p=this.parseVertexIndex(r,u);if(void 0===n?this.addVertex(c,h,p):(l=this.parseVertexIndex(n,u),this.addVertex(c,h,l),this.addVertex(h,p,l)),void 0!==i){var d=this.normals.length;c=this.parseNormalIndex(i,d),h=i===o?c:this.parseNormalIndex(o,d),p=i===a?c:this.parseNormalIndex(a,d),void 0===n?this.addNormal(c,h,p):(l=this.parseNormalIndex(s,d),this.addNormal(c,h,l),this.addNormal(h,p,l))}},addLineGeometry:function(e){this.object.geometry.type="Line";for(var t=this.vertices.length,r=0,n=e.length;r<n;r++)this.addVertexLine(this.parseVertexIndex(e[r],t))}};return e.startObject("",!1),e},parse:function(e){var t,r,n=this._createParserState();-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));var i=e.split("\n"),o="",a="",s="",l=[],u="function"==typeof"".trimLeft;for(t=0,r=i.length;t<r;t++)if(o=i[t],0!==(o=u?o.trimLeft():o.trim()).length&&"#"!==(a=o.charAt(0)))if("v"===a){if(" "===(s=o.charAt(1))&&null!==(l=this.regexp.vertex_pattern.exec(o)))n.vertices.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]));else if("n"===s&&null!==(l=this.regexp.normal_pattern.exec(o)))n.normals.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]));else if("t"!==s||null===this.regexp.uv_pattern.exec(o))throw new Error("Unexpected vertex/normal/uv line: '"+o+"'")}else if("f"===a)if(null!==(l=this.regexp.face_vertex_uv_normal.exec(o)))n.addFace(l[1],l[4],l[7],l[10],l[3],l[6],l[9],l[12]);else if(null!==this.regexp.face_vertex_uv.exec(o));else if(null!==(l=this.regexp.face_vertex_normal.exec(o)))n.addFace(l[1],l[3],l[5],l[7],l[2],l[4],l[6],l[8]);else{if(null===(l=this.regexp.face_vertex.exec(o)))throw new Error("Unexpected face line: '"+o+"'");n.addFace(l[1],l[2],l[3],l[4])}else if("l"===a){var c=o.substring(1).trim().split(" "),h=[],p=[];if(-1===o.indexOf("/"))h=c;else for(var d=0,f=c.length;d<f;d++){var m=c[d].split("/");""!==m[0]&&h.push(m[0]),""!==m[1]&&p.push(m[1])}n.addLineGeometry(h,p)}else if(null!==(l=this.regexp.object_pattern.exec(o))){var g=l[0].substr(1).trim();n.startObject(g)}else if(this.regexp.material_use_pattern.test(o));else if(this.regexp.material_library_pattern.test(o));else if(null===this.regexp.smoothing_pattern.exec(o)){if("\0"===o)continue;throw new Error("Unexpected line: '"+o+"'")}var v=[];for(t=0,r=n.objects.length;t<r;t++){var y=n.objects[t].geometry;if(0!==y.vertices.length){var b=new Yr;b.addAttribute("position",new Lr(new Float32Array(y.vertices),3)),y.normals.length>0?b.addAttribute("normal",new Lr(new Float32Array(y.normals),3)):b.computeVertexNormals(),v.push(b)}}return v}};var n_=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"obj"},t.prototype.getLoader=function(){return new r_},Object.defineProperties(t.prototype,r),t}(t_);function i_(){this.propertyNameMapping={}}Tl.add("obj",n_),i_.prototype={constructor:i_,setPropertyNameMapping:function(e){this.propertyNameMapping=e},bin2str:function(e){for(var t=new Uint8Array(e),r="",n=0;n<e.byteLength;n++)r+=String.fromCharCode(t[n]);return r},isASCII:function(e){return"ascii"===this.parseHeader(this.bin2str(e)).format},parse:function(e){return e instanceof ArrayBuffer?this.isASCII(e)?this.parseASCII(this.bin2str(e)):this.parseBinary(e):this.parseASCII(e)},parseHeader:function(e){var t="",r=0,n=/ply([\s\S]*)end_header\s/.exec(e);null!==n&&(t=n[1],r=n[0].length);var i,o,a,s={comments:[],elements:[],headerLength:r},l=t.split("\n");function u(e,t){var r={type:e[0]};return"list"===r.type?(r.name=e[3],r.countType=e[1],r.itemType=e[2]):r.name=e[1],r.name in t&&(r.name=t[r.name]),r}for(var c=0;c<l.length;c++){var h=l[c];if(""!==(h=h.trim()))switch(o=(a=h.split(/\s+/)).shift(),h=a.join(" "),o){case"format":s.format=a[0],s.version=a[1];break;case"comment":s.comments.push(h);break;case"element":void 0!==i&&s.elements.push(i),(i={}).name=a[0],i.count=parseInt(a[1]),i.properties=[];break;case"property":i.properties.push(u(a,this.propertyNameMapping));break;default:console.log("unhandled",o,a)}}return void 0!==i&&s.elements.push(i),s},parseASCIINumber:function(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}},parseASCIIElement:function(e,t){for(var r=t.split(/\s+/),n={},i=0;i<e.length;i++)if("list"===e[i].type){for(var o=[],a=this.parseASCIINumber(r.shift(),e[i].countType),s=0;s<a;s++)o.push(this.parseASCIINumber(r.shift(),e[i].itemType));n[e[i].name]=o}else n[e[i].name]=this.parseASCIINumber(r.shift(),e[i].type);return n},parseASCII:function(e){var t,r=new Fr,n=this.parseHeader(e),i="";null!==(t=/end_header\s([\s\S]*)$/.exec(e))&&(i=t[1]);var o=i.split("\n"),a=0,s=0;r.useColor=!1;for(var l=0;l<o.length;l++){var u=o[l];if(""!==(u=u.trim())){s>=n.elements[a].count&&(a++,s=0);var c=this.parseASCIIElement(n.elements[a].properties,u);this.handleElement(r,n.elements[a].name,c),s++}}return this.postProcess(r)},postProcess:function(e){if(e.useColor){for(var t=0;t<e.faces.length;t++)e.faces[t].vertexColors=[e.colors[e.faces[t].a],e.colors[e.faces[t].b],e.colors[e.faces[t].c]];e.elementsNeedUpdate=!0}return e.computeBoundingSphere(),e},handleElement:function(e,t,r){if("vertex"===t){if(e.vertices.push(new ft(r.x,r.y,r.z)),"red"in r&&"green"in r&&"blue"in r){e.useColor=!0;var n=new ur;n.setRGB(r.red/255,r.green/255,r.blue/255),e.colors.push(n)}}else if("face"===t){var i=r.vertex_indices;3===i.length?e.faces.push(new kr(i[0],i[1],i[2])):4===i.length&&e.faces.push(new kr(i[0],i[1],i[3]),new kr(i[1],i[2],i[3]))}},binaryRead:function(e,t,r,n){switch(r){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,n),2];case"uint16":case"ushort":return[e.getUint16(t,n),2];case"int32":case"int":return[e.getInt32(t,n),4];case"uint32":case"uint":return[e.getUint32(t,n),4];case"float32":case"float":return[e.getFloat32(t,n),4];case"float64":case"double":return[e.getFloat64(t,n),8]}},binaryReadElement:function(e,t,r,n){for(var i,o={},a=0,s=0;s<r.length;s++)if("list"===r[s].type){var l=[],u=(i=this.binaryRead(e,t+a,r[s].countType,n))[0];a+=i[1];for(var c=0;c<u;c++)i=this.binaryRead(e,t+a,r[s].itemType,n),l.push(i[0]),a+=i[1];o[r[s].name]=l}else i=this.binaryRead(e,t+a,r[s].type,n),o[r[s].name]=i[0],a+=i[1];return[o,a]},parseBinary:function(e){for(var t,r=new Fr,n=this.parseHeader(this.bin2str(e)),i="binary_little_endian"===n.format,o=new DataView(e,n.headerLength),a=0,s=0;s<n.elements.length;s++)for(var l=0;l<n.elements[s].count;l++){a+=(t=this.binaryReadElement(o,a,n.elements[s].properties,i))[1];var u=t[0];this.handleElement(r,n.elements[s].name,u)}return this.postProcess(r)}};var o_=function(e){function t(){e.apply(this,arguments)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0}};return r.type.get=function(){return"ply"},t.prototype.getLoader=function(){return new i_},Object.defineProperties(t.prototype,r),t}(t_);Tl.add("ply",o_);var a_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.delimiter=Ha(n.delimiter,","),this.comment=Ha(n.comment,"#"),this.columnNames=Ha(n.columnNames,!1),this.table={name:this.name,path:this.path,columnNames:[],data:[]}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"csv"},r.__objName.get=function(){return"table"},t.prototype._parse=function(){var e=this,t=this.table.data,r=new RegExp("\\s*"+this.delimiter+"\\s*"),n=0;this.streamer.eachChunkOfLines(function(i){for(var o=i.length,a=0;a<o;++a){var s=i[a].trim();if(!s.startsWith(e.comment)){var l=s.split(r);0===n?e.table.columnNames=l:s&&t.push(l),++n}}})},Object.defineProperties(t.prototype,r),t}(Hb);Tl.add("csv",a_);var s_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.string=Ha(n.string,!1),this.json={name:this.name,path:this.path,data:{}}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0},isJson:{configurable:!0}};return r.type.get=function(){return"json"},r.__objName.get=function(){return"json"},r.isJson.get=function(){return!0},t.prototype._parse=function(){this.streamer.isBinary()||this.string?this.json.data=JSON.parse(this.streamer.asText()):this.json.data=this.streamer.data},Object.defineProperties(t.prototype,r),t}(Hb);Tl.add("json",s_);var l_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.msgpack={name:this.name,path:this.path,data:void 0}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"msgpack"},r.__objName.get=function(){return"msgpack"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("MsgpackParser._parse "+this.name),this.msgpack.data=Aw(this.streamer.data),vl&&gl.timeEnd("MsgpackParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Hb);Tl.add("msgpack",l_);var u_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.netcdf={name:this.name,path:this.path,data:void 0}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0},isBinary:{configurable:!0}};return r.type.get=function(){return"netcdf"},r.__objName.get=function(){return"netcdf"},r.isBinary.get=function(){return!0},t.prototype._parse=function(){vl&&gl.time("NetcdfParser._parse "+this.name),this.netcdf.data=new Ix(this.streamer.data),vl&&gl.timeEnd("NetcdfParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Hb);Tl.add("netcdf",u_);var c_=function(e){function t(t,r){e.call(this,t,r),this.text={name:this.name,path:this.path,data:""}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0}};return r.type.get=function(){return"text"},r.__objName.get=function(){return"text"},t.prototype._parse=function(){this.text.data=this.streamer.asText()},Object.defineProperties(t.prototype,r),t}(Hb);Tl.add("txt",c_),Tl.add("text",c_);var h_=/^['"]|['"]$/g,p_=/^<([\w-:.]+)\s*/,d_=/^([^<]*)/,f_=/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/;function m_(e){return e=e.trim().replace(/<!--[\s\S]*?-->/g,""),{declaration:function(){if(r(/^<\?xml\s*/)){for(var e={attributes:{}};!n()&&!i("?>");){var o=t();if(!o)return e;e.attributes[o.name]=o.value}return r(/\?>\s*/),e}}(),root:function e(){var o=r(p_);if(o){for(var a,s={name:o[1],attributes:{},children:[]};!(n()||i(">")||i("?>")||i("/>"));){var l=t();if(!l)return s;s.attributes[l.name]=l.value}if(r(/^\s*\/>\s*/))return s;for(r(/\??>\s*/),s.content=function(){var e=r(d_);return e?e[1]:""}();a=e();)s.children.push(a);return r(/^<\/[\w-:.]+>\s*/),s}}()};function t(){var e=r(f_);if(e)return{name:e[1],value:function(e){return e.replace(h_,"")}(e[2])}}function r(t){var r=e.match(t);if(r)return e=e.slice(r[0].length),r}function n(){return 0===e.length}function i(t){return 0===e.indexOf(t)}}var g_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.useDomParser=Ha(n.useDomParser,!1),this.xml={name:this.name,path:this.path,data:{}}}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={type:{configurable:!0},__objName:{configurable:!0},isXml:{configurable:!0}};return r.type.get=function(){return"xml"},r.__objName.get=function(){return"xml"},r.isXml.get=function(){return!0},t.prototype.__xmlParser=function(e){return m_(e)},t.prototype.__domParser=function(e){return(new window.DOMParser).parseFromString(e,"text/xml")},t.prototype._parse=function(){vl&&gl.time("XmlParser._parse "+this.name),this.useDomParser?this.streamer.data instanceof window.Document?this.xml.data=this.streamer.data:this.xml.data=this.__domParser(this.streamer.asText()):this.xml.data=this.__xmlParser(this.streamer.asText()),vl&&gl.timeEnd("XmlParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(Hb);function v_(e,t,r){void 0===r&&(r=!1);var n=e.getNamedItem("icode").value,i=e.getNamedItem("chain").value,o=e.getNamedItem("altcode").value,a=e.getNamedItem("resnum").value;return n.trim()&&(a+="^"+n),i.trim()&&(a+=":"+i),t&&(a+="."+t),r&&o.trim()&&(a+="%"+o),a+="/"+(parseInt(e.getNamedItem("model").value)-1)}function y_(e,t,r){void 0===e[t]?e[t]=r:e[t]|=r}function b_(e,t){return null!==e&&e.value===t}function w_(e,t,r){for(var n=0,i=t.getElementsByTagName("clash"),o=0,a=i.length;o<a;++o)if(e[i[o].attributes.getNamedItem("cid").value]){n+=1;break}return t.getElementsByTagName("angle-outlier").length>0&&(n+=1),t.getElementsByTagName("bond-outlier").length>0&&(n+=1),t.getElementsByTagName("plane-outlier").length>0&&(n+=1),b_(r.getNamedItem("rota"),"OUTLIER")&&(n+=1),b_(r.getNamedItem("rama"),"OUTLIER")&&(n+=1),b_(r.getNamedItem("RNApucker"),"outlier")&&(n+=1),n}Tl.add("xml",g_);var x_=function(e,t){this.name=e,this.rsrzDict={},this.rsccDict={},this.clashDict={},this.clashArray=[],this.geoDict={},this.geoAtomDict={},this.atomDict={},this.clashSele="NONE"},__={type:{configurable:!0}};__.type.get=function(){return"validation"},x_.prototype.fromXml=function(e){vl&&gl.time("Validation.fromXml");var t=this.rsrzDict,r=this.rsccDict,n=this.clashDict,i=this.clashArray,o=this.geoDict,a=this.geoAtomDict,s=this.atomDict,l=e.getElementsByTagName("ModelledSubgroup"),u={},c=[];vl&&gl.time("Validation.fromXml#clashDict");for(var h=0,p=l.length;h<p;++h){var d=l[h],f=d.attributes,m=v_(f);null!==f.getNamedItem("rsrz")&&(t[m]=parseFloat(f.getNamedItem("rsrz").value)),null!==f.getNamedItem("rscc")&&(r[m]=parseFloat(f.getNamedItem("rscc").value));var g=e.createAttribute("sele");g.value=m,f.setNamedItem(g);for(var v=d.getElementsByTagName("clash"),y=0,b=v.length;y<b;++y){var w=v[y].attributes,x=w.getNamedItem("atom").value;if("H"!==em(x)){var _=w.getNamedItem("cid").value,S=v_(f,x,!0);if(s[S]=!0,void 0===u[_])u[_]={sele1:S,res1:m};else{var C=u[_];C.res1!==m&&(C.sele2=S,C.res2=m,c.push(C.res1,m),n[_]=C,i.push(C))}}}}vl&&gl.timeEnd("Validation.fromXml#clashDict");for(var M=0,T=l.length;M<T;++M){var A=l[M],E=A.attributes,P=E.getNamedItem("sele").value;if("."!==E.getNamedItem("seq").value){var R=w_(n,A,E);R>0&&(o[P]=R)}else{var I=A.getElementsByTagName("clash"),N=A.getElementsByTagName("mog-bond-outlier"),D=A.getElementsByTagName("mog-angle-outlier");if(N.length>0||D.length>0||I.length>0){var k={};a[P]=k;for(var O=0,F=I.length;O<F;++O){var L=I[O].attributes;n[L.getNamedItem("cid").value]&&y_(k,L.getNamedItem("atom").value,1)}for(var U=0,V=N.length;U<V;++U){N[U].attributes.getNamedItem("atoms").value.split(",").forEach(function(e){y_(k,e,2)})}for(var B=0,z=D.length;B<z;++B){D[B].attributes.getNamedItem("atoms").value.split(",").forEach(function(e){y_(k,e,4)})}}}}this.clashSele=c.length?c.join(" OR "):"NONE",vl&&gl.timeEnd("Validation.fromXml")},x_.prototype.getClashData=function(e){vl&&gl.time("Validation.getClashData");var t=e||{},r=t.structure,n=r.atomSet,i=new ur(Ha(t.color,"#f0027f")),o=r.getAtomProxy(),a=r.getAtomProxy(),s=new ft,l=new ft,u=new ft,c=this.clashArray,h=c.length,p=new Float32Array(3*h),d=new Float32Array(3*h),f=mu(h,i.r,i.g,i.b),m=new Float32Array(h),g=new Float32Array(h);vl&&gl.time("Validation.getClashData#atomDict");var v=this.atomDict;r.eachAtom(function(e){var t=function(e){var t=e.inscode,r=e.chainname,n=e.atomname,i=e.altloc,o=e.resno+"";return t&&(o+="^"+t),r&&(o+=":"+r),n&&(o+="."+n),i&&(o+="%"+i),o+="/"+e.modelIndex}(e);!0===v[t]&&(v[t]=e.index)}),vl&&gl.timeEnd("Validation.getClashData#atomDict");var y=0;return c.forEach(function(e,t){if(o.index=v[e.sele1],a.index=v[e.sele2],void 0!==o.index&&void 0!==a.index&&n.isSet(o.index,a.index)){s.subVectors(a,o).setLength(o.vdw),l.copy(o).add(s),s.subVectors(o,a).setLength(a.vdw),u.copy(a).add(s);var r=o.distanceTo(a)/2,i=Math.sqrt(o.vdw*o.vdw-r*r),c=Math.sqrt(a.vdw*a.vdw-r*r);l.toArray(p,3*y),u.toArray(d,3*y),m[y]=(i+c)/2,g[y]=t,++y}}),vl&&gl.timeEnd("Validation.getClashData"),{position1:p.subarray(0,3*y),position2:d.subarray(0,3*y),color:f.subarray(0,3*y),color2:f.subarray(0,3*y),radius:m.subarray(0,y),picking:new Vp(g.subarray(0,y),this,r)}},Object.defineProperties(x_.prototype,__);var S_=function(e){function t(t,r){var n=r||{};e.call(this,t,n),this.useDomParser=!0,this.validation=new x_(this.name,this.path)}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var r={__objName:{configurable:!0},isXml:{configurable:!0}};return r.__objName.get=function(){return"validation"},r.isXml.get=function(){return!0},t.prototype._parse=function(){e.prototype._parse.call(this),vl&&gl.time("ValidationParser._parse "+this.name),this.validation.fromXml(this.xml.data),vl&&gl.timeEnd("ValidationParser._parse "+this.name)},Object.defineProperties(t.prototype,r),t}(g_);function C_(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)}function M_(e,t,r,n,i){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+n),i);else for(var o=0;o<n;o++)e[i+o]=t[r+o]}function T_(e,t,r,n){for(var i=65535&e|0,o=e>>>16&65535|0,a=0;0!==r;){r-=a=r>2e3?2e3:r;do{o=o+(i=i+t[n++]|0)|0}while(--a);i%=65521,o%=65521}return i|o<<16|0}Tl.add("validation",S_);var A_=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();function E_(e,t,r,n){var i=A_,o=n+r;e^=-1;for(var a=n;a<o;a++)e=e>>>8^i[255&(e^t[a])];return-1^e}var P_=30,R_=12;function I_(e,t){var r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T;r=e.state,n=e.next_in,M=e.input,i=n+(e.avail_in-5),o=e.next_out,T=e.output,a=o-(t-e.avail_out),s=o+(e.avail_out-257),l=r.dmax,u=r.wsize,c=r.whave,h=r.wnext,p=r.window,d=r.hold,f=r.bits,m=r.lencode,g=r.distcode,v=(1<<r.lenbits)-1,y=(1<<r.distbits)-1;e:do{f<15&&(d+=M[n++]<<f,f+=8,d+=M[n++]<<f,f+=8),b=m[d&v];t:for(;;){if(d>>>=w=b>>>24,f-=w,0===(w=b>>>16&255))T[o++]=65535&b;else{if(!(16&w)){if(0==(64&w)){b=m[(65535&b)+(d&(1<<w)-1)];continue t}if(32&w){r.mode=R_;break e}e.msg="invalid literal/length code",r.mode=P_;break e}x=65535&b,(w&=15)&&(f<w&&(d+=M[n++]<<f,f+=8),x+=d&(1<<w)-1,d>>>=w,f-=w),f<15&&(d+=M[n++]<<f,f+=8,d+=M[n++]<<f,f+=8),b=g[d&y];r:for(;;){if(d>>>=w=b>>>24,f-=w,!(16&(w=b>>>16&255))){if(0==(64&w)){b=g[(65535&b)+(d&(1<<w)-1)];continue r}e.msg="invalid distance code",r.mode=P_;break e}if(_=65535&b,f<(w&=15)&&(d+=M[n++]<<f,(f+=8)<w&&(d+=M[n++]<<f,f+=8)),(_+=d&(1<<w)-1)>l){e.msg="invalid distance too far back",r.mode=P_;break e}if(d>>>=w,f-=w,_>(w=o-a)){if((w=_-w)>c&&r.sane){e.msg="invalid distance too far back",r.mode=P_;break e}if(S=0,C=p,0===h){if(S+=u-w,w<x){x-=w;do{T[o++]=p[S++]}while(--w);S=o-_,C=T}}else if(h<w){if(S+=u+h-w,(w-=h)<x){x-=w;do{T[o++]=p[S++]}while(--w);if(S=0,h<x){x-=w=h;do{T[o++]=p[S++]}while(--w);S=o-_,C=T}}}else if(S+=h-w,w<x){x-=w;do{T[o++]=p[S++]}while(--w);S=o-_,C=T}for(;x>2;)T[o++]=C[S++],T[o++]=C[S++],T[o++]=C[S++],x-=3;x&&(T[o++]=C[S++],x>1&&(T[o++]=C[S++]))}else{S=o-_;do{T[o++]=T[S++],T[o++]=T[S++],T[o++]=T[S++],x-=3}while(x>2);x&&(T[o++]=T[S++],x>1&&(T[o++]=T[S++]))}break}}break}}while(n<i&&o<s);n-=x=f>>3,d&=(1<<(f-=x<<3))-1,e.next_in=n,e.next_out=o,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=o<s?s-o+257:257-(o-s),r.hold=d,r.bits=f}var N_=15,D_=852,k_=592,O_=0,F_=1,L_=2,U_=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],V_=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],B_=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],z_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function j_(e,t,r,n,i,o,a,s){var l,u,c,h,p,d,f,m,g,v=s.bits,y=0,b=0,w=0,x=0,_=0,S=0,C=0,M=0,T=0,A=0,E=null,P=0,R=new Uint16Array(N_+1),I=new Uint16Array(N_+1),N=null,D=0;for(y=0;y<=N_;y++)R[y]=0;for(b=0;b<n;b++)R[t[r+b]]++;for(_=v,x=N_;x>=1&&0===R[x];x--);if(_>x&&(_=x),0===x)return i[o++]=20971520,i[o++]=20971520,s.bits=1,0;for(w=1;w<x&&0===R[w];w++);for(_<w&&(_=w),M=1,y=1;y<=N_;y++)if(M<<=1,(M-=R[y])<0)return-1;if(M>0&&(e===O_||1!==x))return-1;for(I[1]=0,y=1;y<N_;y++)I[y+1]=I[y]+R[y];for(b=0;b<n;b++)0!==t[r+b]&&(a[I[t[r+b]]++]=b);if(e===O_?(E=N=a,d=19):e===F_?(E=U_,P-=257,N=V_,D-=257,d=256):(E=B_,N=z_,d=-1),A=0,b=0,y=w,p=o,S=_,C=0,c=-1,h=(T=1<<_)-1,e===F_&&T>D_||e===L_&&T>k_)return 1;for(;;){f=y-C,a[b]<d?(m=0,g=a[b]):a[b]>d?(m=N[D+a[b]],g=E[P+a[b]]):(m=96,g=0),l=1<<y-C,w=u=1<<S;do{i[p+(A>>C)+(u-=l)]=f<<24|m<<16|g|0}while(0!==u);for(l=1<<y-1;A&l;)l>>=1;if(0!==l?(A&=l-1,A+=l):A=0,b++,0==--R[y]){if(y===x)break;y=t[r+a[b]]}if(y>_&&(A&h)!==c){for(0===C&&(C=_),p+=w,M=1<<(S=y-C);S+C<x&&!((M-=R[S+C])<=0);)S++,M<<=1;if(T+=1<<S,e===F_&&T>D_||e===L_&&T>k_)return 1;i[c=A&h]=_<<24|S<<16|p-o|0}}return 0!==A&&(i[p+A]=y-C<<24|64<<16|0),s.bits=_,0}var H_=0,$_=1,G_=2,W_=4,q_=5,X_=6,K_=0,Y_=1,Z_=2,J_=-2,Q_=-3,eS=-4,tS=-5,rS=8,nS=1,iS=2,oS=3,aS=4,sS=5,lS=6,uS=7,cS=8,hS=9,pS=10,dS=11,fS=12,mS=13,gS=14,vS=15,yS=16,bS=17,wS=18,xS=19,_S=20,SS=21,CS=22,MS=23,TS=24,AS=25,ES=26,PS=27,RS=28,IS=29,NS=30,DS=31,kS=32,OS=852,FS=592;function LS(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function US(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,function(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=nS,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(OS),t.distcode=t.distdyn=new Int32Array(FS),t.sane=1,t.back=-1,K_):J_}(e)):J_}function VS(e,t){var r,n;return e?(n=new function(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0},e.state=n,n.window=null,(r=function(e,t){var r,n;return e&&e.state?(n=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?J_:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,US(e))):J_}(e,t))!==K_&&(e.state=null),r):J_}var BS,zS,jS=!0;function HS(e){if(jS){var t;for(BS=new Int32Array(512),zS=new Int32Array(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(j_($_,e.lens,0,288,BS,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;j_(G_,e.lens,0,32,zS,0,e.work,{bits:5}),jS=!1}e.lencode=BS,e.lenbits=9,e.distcode=zS,e.distbits=5}function $S(e,t,r,n){var i,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(M_(o.window,t,r-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((i=o.wsize-o.wnext)>n&&(i=n),M_(o.window,t,r-n,i,o.wnext),(n-=i)?(M_(o.window,t,r-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i))),0}function GS(e,t){var r,n,i,o,a,s,l,u,c,h,p,d,f,m,g,v,y,b,w,x,_,S,C,M,T=0,A=new Uint8Array(4),E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return J_;(r=e.state).mode===fS&&(r.mode=mS),a=e.next_out,i=e.output,l=e.avail_out,o=e.next_in,n=e.input,s=e.avail_in,u=r.hold,c=r.bits,h=s,p=l,S=K_;e:for(;;)switch(r.mode){case nS:if(0===r.wrap){r.mode=mS;break}for(;c<16;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(2&r.wrap&&35615===u){r.check=0,A[0]=255&u,A[1]=u>>>8&255,r.check=E_(r.check,A,2,0),u=0,c=0,r.mode=iS;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",r.mode=NS;break}if((15&u)!==rS){e.msg="unknown compression method",r.mode=NS;break}if(c-=4,_=8+(15&(u>>>=4)),0===r.wbits)r.wbits=_;else if(_>r.wbits){e.msg="invalid window size",r.mode=NS;break}r.dmax=1<<_,e.adler=r.check=1,r.mode=512&u?pS:fS,u=0,c=0;break;case iS:for(;c<16;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(r.flags=u,(255&r.flags)!==rS){e.msg="unknown compression method",r.mode=NS;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=NS;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=E_(r.check,A,2,0)),u=0,c=0,r.mode=oS;case oS:for(;c<32;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.head&&(r.head.time=u),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,A[2]=u>>>16&255,A[3]=u>>>24&255,r.check=E_(r.check,A,4,0)),u=0,c=0,r.mode=aS;case aS:for(;c<16;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=E_(r.check,A,2,0)),u=0,c=0,r.mode=sS;case sS:if(1024&r.flags){for(;c<16;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=E_(r.check,A,2,0)),u=0,c=0}else r.head&&(r.head.extra=null);r.mode=lS;case lS:if(1024&r.flags&&((d=r.length)>s&&(d=s),d&&(r.head&&(_=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),M_(r.head.extra,n,o,d,_)),512&r.flags&&(r.check=E_(r.check,n,d,o)),s-=d,o+=d,r.length-=d),r.length))break e;r.length=0,r.mode=uS;case uS:if(2048&r.flags){if(0===s)break e;d=0;do{_=n[o+d++],r.head&&_&&r.length<65536&&(r.head.name+=String.fromCharCode(_))}while(_&&d<s);if(512&r.flags&&(r.check=E_(r.check,n,d,o)),s-=d,o+=d,_)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=cS;case cS:if(4096&r.flags){if(0===s)break e;d=0;do{_=n[o+d++],r.head&&_&&r.length<65536&&(r.head.comment+=String.fromCharCode(_))}while(_&&d<s);if(512&r.flags&&(r.check=E_(r.check,n,d,o)),s-=d,o+=d,_)break e}else r.head&&(r.head.comment=null);r.mode=hS;case hS:if(512&r.flags){for(;c<16;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(u!==(65535&r.check)){e.msg="header crc mismatch",r.mode=NS;break}u=0,c=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=fS;break;case pS:for(;c<32;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}e.adler=r.check=LS(u),u=0,c=0,r.mode=dS;case dS:if(0===r.havedict)return e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,r.hold=u,r.bits=c,Z_;e.adler=r.check=1,r.mode=fS;case fS:if(t===q_||t===X_)break e;case mS:if(r.last){u>>>=7&c,c-=7&c,r.mode=PS;break}for(;c<3;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}switch(r.last=1&u,c-=1,3&(u>>>=1)){case 0:r.mode=gS;break;case 1:if(HS(r),r.mode=_S,t===X_){u>>>=2,c-=2;break e}break;case 2:r.mode=bS;break;case 3:e.msg="invalid block type",r.mode=NS}u>>>=2,c-=2;break;case gS:for(u>>>=7&c,c-=7&c;c<32;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",r.mode=NS;break}if(r.length=65535&u,u=0,c=0,r.mode=vS,t===X_)break e;case vS:r.mode=yS;case yS:if(d=r.length){if(d>s&&(d=s),d>l&&(d=l),0===d)break e;M_(i,n,o,d,a),s-=d,o+=d,l-=d,a+=d,r.length-=d;break}r.mode=fS;break;case bS:for(;c<14;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(r.nlen=257+(31&u),u>>>=5,c-=5,r.ndist=1+(31&u),u>>>=5,c-=5,r.ncode=4+(15&u),u>>>=4,c-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=NS;break}r.have=0,r.mode=wS;case wS:for(;r.have<r.ncode;){for(;c<3;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.lens[E[r.have++]]=7&u,u>>>=3,c-=3}for(;r.have<19;)r.lens[E[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,C={bits:r.lenbits},S=j_(H_,r.lens,0,19,r.lencode,0,r.work,C),r.lenbits=C.bits,S){e.msg="invalid code lengths set",r.mode=NS;break}r.have=0,r.mode=xS;case xS:for(;r.have<r.nlen+r.ndist;){for(;v=(T=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(y<16)u>>>=g,c-=g,r.lens[r.have++]=y;else{if(16===y){for(M=g+2;c<M;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(u>>>=g,c-=g,0===r.have){e.msg="invalid bit length repeat",r.mode=NS;break}_=r.lens[r.have-1],d=3+(3&u),u>>>=2,c-=2}else if(17===y){for(M=g+3;c<M;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}c-=g,_=0,d=3+(7&(u>>>=g)),u>>>=3,c-=3}else{for(M=g+7;c<M;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}c-=g,_=0,d=11+(127&(u>>>=g)),u>>>=7,c-=7}if(r.have+d>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=NS;break}for(;d--;)r.lens[r.have++]=_}}if(r.mode===NS)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=NS;break}if(r.lenbits=9,C={bits:r.lenbits},S=j_($_,r.lens,0,r.nlen,r.lencode,0,r.work,C),r.lenbits=C.bits,S){e.msg="invalid literal/lengths set",r.mode=NS;break}if(r.distbits=6,r.distcode=r.distdyn,C={bits:r.distbits},S=j_(G_,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,C),r.distbits=C.bits,S){e.msg="invalid distances set",r.mode=NS;break}if(r.mode=_S,t===X_)break e;case _S:r.mode=SS;case SS:if(s>=6&&l>=258){e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,r.hold=u,r.bits=c,I_(e,p),a=e.next_out,i=e.output,l=e.avail_out,o=e.next_in,n=e.input,s=e.avail_in,u=r.hold,c=r.bits,r.mode===fS&&(r.back=-1);break}for(r.back=0;v=(T=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(v&&0==(240&v)){for(b=g,w=v,x=y;v=(T=r.lencode[x+((u&(1<<b+w)-1)>>b)])>>>16&255,y=65535&T,!(b+(g=T>>>24)<=c);){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}u>>>=b,c-=b,r.back+=b}if(u>>>=g,c-=g,r.back+=g,r.length=y,0===v){r.mode=ES;break}if(32&v){r.back=-1,r.mode=fS;break}if(64&v){e.msg="invalid literal/length code",r.mode=NS;break}r.extra=15&v,r.mode=CS;case CS:if(r.extra){for(M=r.extra;c<M;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,c-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=MS;case MS:for(;v=(T=r.distcode[u&(1<<r.distbits)-1])>>>16&255,y=65535&T,!((g=T>>>24)<=c);){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(0==(240&v)){for(b=g,w=v,x=y;v=(T=r.distcode[x+((u&(1<<b+w)-1)>>b)])>>>16&255,y=65535&T,!(b+(g=T>>>24)<=c);){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}u>>>=b,c-=b,r.back+=b}if(u>>>=g,c-=g,r.back+=g,64&v){e.msg="invalid distance code",r.mode=NS;break}r.offset=y,r.extra=15&v,r.mode=TS;case TS:if(r.extra){for(M=r.extra;c<M;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,c-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=NS;break}r.mode=AS;case AS:if(0===l)break e;if(d=p-l,r.offset>d){if((d=r.offset-d)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=NS;break}d>r.wnext?(d-=r.wnext,f=r.wsize-d):f=r.wnext-d,d>r.length&&(d=r.length),m=r.window}else m=i,f=a-r.offset,d=r.length;d>l&&(d=l),l-=d,r.length-=d;do{i[a++]=m[f++]}while(--d);0===r.length&&(r.mode=SS);break;case ES:if(0===l)break e;i[a++]=r.length,l--,r.mode=SS;break;case PS:if(r.wrap){for(;c<32;){if(0===s)break e;s--,u|=n[o++]<<c,c+=8}if(p-=l,e.total_out+=p,r.total+=p,p&&(e.adler=r.check=r.flags?E_(r.check,i,p,a-p):T_(r.check,i,p,a-p)),p=l,(r.flags?u:LS(u))!==r.check){e.msg="incorrect data check",r.mode=NS;break}u=0,c=0}r.mode=RS;case RS:if(r.wrap&&r.flags){for(;c<32;){if(0===s)break e;s--,u+=n[o++]<<c,c+=8}if(u!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=NS;break}u=0,c=0}r.mode=IS;case IS:S=Y_;break e;case NS:S=Q_;break e;case DS:return eS;case kS:default:return J_}return e.next_out=a,e.avail_out=l,e.next_in=o,e.avail_in=s,r.hold=u,r.bits=c,(r.wsize||p!==e.avail_out&&r.mode<NS&&(r.mode<PS||t!==W_))&&$S(e,e.output,e.next_out,p-e.avail_out)?(r.mode=DS,eS):(h-=e.avail_in,p-=e.avail_out,e.total_in+=h,e.total_out+=p,r.total+=p,r.wrap&&p&&(e.adler=r.check=r.flags?E_(r.check,i,p,e.next_out-p):T_(r.check,i,p,e.next_out-p)),e.data_type=r.bits+(r.last?64:0)+(r.mode===fS?128:0)+(r.mode===_S||r.mode===vS?256:0),(0===h&&0===p||t===W_)&&S===K_&&(S=tS),S)}function WS(e,t){var r,n=t.length;return e&&e.state?0!==(r=e.state).wrap&&r.mode!==dS?J_:r.mode===dS&&T_(1,t,n,0)!==r.check?Q_:$S(e,t,n,n)?(r.mode=DS,eS):(r.havedict=1,K_):J_}var qS=!0,XS=!0;try{String.fromCharCode.apply(null,[0])}catch(e){qS=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){XS=!1}for(var KS=new Uint8Array(256),YS=0;YS<256;YS++)KS[YS]=YS>=252?6:YS>=248?5:YS>=240?4:YS>=224?3:YS>=192?2:1;function ZS(e){var t,r,n,i,o,a=e.length,s=0;for(i=0;i<a;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<a&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),s+=r<128?1:r<2048?2:r<65536?3:4;for(t=new Uint8Array(s),o=0,i=0;o<s;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<a&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),r<128?t[o++]=r:r<2048?(t[o++]=192|r>>>6,t[o++]=128|63&r):r<65536?(t[o++]=224|r>>>12,t[o++]=128|r>>>6&63,t[o++]=128|63&r):(t[o++]=240|r>>>18,t[o++]=128|r>>>12&63,t[o++]=128|r>>>6&63,t[o++]=128|63&r);return t}function JS(e,t){var r,n,i,o,a=t||e.length,s=new Array(2*a);for(n=0,r=0;r<a;)if((i=e[r++])<128)s[n++]=i;else if((o=KS[i])>4)s[n++]=65533,r+=o-1;else{for(i&=2===o?31:3===o?15:7;o>1&&r<a;)i=i<<6|63&e[r++],o--;o>1?s[n++]=65533:i<65536?s[n++]=i:(i-=65536,s[n++]=55296|i>>10&1023,s[n++]=56320|1023&i)}return function(e,t){if(t<65537&&(e.subarray&&XS||!e.subarray&&qS))return String.fromCharCode.apply(null,C_(e,t));for(var r="",n=0;n<t;n++)r+=String.fromCharCode(e[n]);return r}(s,n)}function QS(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;r>=0&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+KS[e[r]]>t?r:t}KS[254]=KS[254]=1;var eC=0,tC={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};var rC=Object.prototype.toString;function nC(e){if(!(this instanceof nC))return new nC(e);this.options=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])}}return e}({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},this.strm.avail_out=0;var r=VS(this.strm,t.windowBits);if(r!==eC)throw new Error(tC[r]);this.header=new function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},function(e,t){var r;e&&e.state&&(0==(2&(r=e.state).wrap)||(r.head=t,t.done=!1))}(this.strm,this.header)}nC.prototype.push=function(e,t){var r,n,i,o,a,s,l=this.strm,u=this.options.chunkSize,c=this.options.dictionary,h=!1;if(this.ended)return!1;n=t===~~t?t:!0===t?4:0,"string"==typeof e?l.input=function(e){for(var t=new Uint8Array(e.length),r=0,n=t.length;r<n;r++)t[r]=e.charCodeAt(r);return t}(e):"[object ArrayBuffer]"===rC.call(e)?l.input=new Uint8Array(e):l.input=e,l.next_in=0,l.avail_in=l.input.length;do{if(0===l.avail_out&&(l.output=new Uint8Array(u),l.next_out=0,l.avail_out=u),2===(r=GS(l,0))&&c&&(s="string"==typeof c?ZS(c):"[object ArrayBuffer]"===rC.call(c)?new Uint8Array(c):c,r=WS(this.strm,s)),-5===r&&!0===h&&(r=eC,h=!1),1!==r&&r!==eC)return this.onEnd(r),this.ended=!0,!1;l.next_out&&(0!==l.avail_out&&1!==r&&(0!==l.avail_in||4!==n&&2!==n)||("string"===this.options.to?(i=QS(l.output,l.next_out),o=l.next_out-i,a=JS(l.output,i),l.next_out=o,l.avail_out=u-o,o&&M_(l.output,l.output,i,o,0),this.onData(a)):this.onData(C_(l.output,l.next_out)))),0===l.avail_in&&0===l.avail_out&&(h=!0)}while((l.avail_in>0||0===l.avail_out)&&1!==r);return 1===r&&(n=4),4===n?(r=function(e){if(!e||!e.state)return J_;var t=e.state;return t.window&&(t.window=null),e.state=null,K_}(this.strm),this.onEnd(r),this.ended=!0,r===eC):2!==n||(this.onEnd(eC),l.avail_out=0,!0)},nC.prototype.onData=function(e){this.chunks.push(e)},nC.prototype.onEnd=function(e){e===eC&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=function(e){var t,r,n,i,o,a;for(n=0,t=0,r=e.length;t<r;t++)n+=e[t].length;for(a=new Uint8Array(n),i=0,t=0,r=e.length;t<r;t++)o=e[t],a.set(o,i),i+=o.length;return a}(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},El.add("gz",function(e){var t;e instanceof ArrayBuffer&&(e=new Uint8Array(e));try{t=function(e,t){var r=new nC(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}(e)}catch(r){t=e}return t});var iC=function(){},oC="//mmtf.rcsb.org/v1.0/full/",aC=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getUrl=function(e){var t,r=zl(e),n=r.name.substr(0,4);return!["pdb","cif"].includes(r.ext)||!1!==r.compressed&&"gz"!==r.compressed?"mmtf"===r.ext?t=r.base.endsWith(".bb")?"//mmtf.rcsb.org/v1.0/reduced/"+n:oC+n:r.ext?(gl.warn("unsupported ext",r.ext),t=oC+n):t=oC+n:t="//files.rcsb.org/download/"+r.path,qa()+t},t.prototype.getExt=function(e){var t=zl(e).ext;return t||"mmtf"},t}(iC);Cl.add("rcsb",new aC);var sC="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",lC=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getUrl=function(e){var t,r=zl(e),n=r.name;return r.ext&&"sdf"!==r.ext?(gl.warn("unsupported ext",r.ext),t=sC+n+"/SDF?record_type=3d"):t=sC+n+"/SDF?record_type=3d",qa()+t},t.prototype.getExt=function(e){var t=zl(e).ext;return t||"sdf"},t}(iC);Cl.add("pubchem",new lC);var uC=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getUrl=function(e){return e},t.prototype.getExt=function(e){return zl(e).ext},t}(iC);Cl.add("ftp",new uC),Cl.add("http",new uC),Cl.add("https",new uC);var cC=/^((http|https|ftp):)*\/\//,hC=function(e){function t(t){void 0===t&&(t=""),e.call(this),this.baseUrl=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getUrl=function(e){var t=zl(e),r=this.baseUrl+t.path;return cC.test(this.baseUrl)||(r=function(e){var t=window.location,r=t.pathname,n=r.substring(0,r.lastIndexOf("/")+1);return t.origin+n+e}(r)),r},t.prototype.getExt=function(e){return zl(e).ext},t}(iC),pC=function(e){function t(t){void 0===t&&(t=""),e.call(this),this.baseUrl=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getListing=function(e){void 0===e&&(e="");var t=this.baseUrl+"dir/"+e;return"/"!==t[t.length-1]&&(t+="/"),Hl(t,{ext:"json"}).then(function(t){return{path:e,data:t.data}})},t.prototype.getUrl=function(e){var t=zl(e);return this.baseUrl+"file/"+t.path+t.query},t.prototype.getCountUrl=function(e){var t=zl(e);return this.baseUrl+"traj/numframes/"+t.path+t.query},t.prototype.getFrameUrl=function(e,t){var r=zl(e);return this.baseUrl+"traj/frame/"+t+"/"+r.path+r.query},t.prototype.getFrameParams=function(e,t){return"atomIndices="+t.join(";")},t.prototype.getPathUrl=function(e,t){var r=zl(e);return this.baseUrl+"traj/path/"+t+"/"+r.path+r.query},t.prototype.getExt=function(e){return zl(e).ext},t}(iC);function dC(e,t){return{type:"integer",max:e,min:t}}function fC(e,t,r){return{type:"number",precision:e,max:t,min:r}}function mC(e,t,r){return{type:"range",step:e,max:t,min:r}}function gC(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];return{type:"select",options:t.reduce(function(t,r){return Object.assign({},t,((e={})[r]=r,e))},{})}}var vC={backgroundColor:{type:"color"},quality:gC("auto","low","medium","high"),sampleLevel:mC(1,5,-1),impostor:{type:"boolean"},workerDefault:{type:"boolean"},rotateSpeed:fC(1,10,0),zoomSpeed:fC(1,10,0),panSpeed:fC(1,10,0),clipNear:mC(1,100,0),clipFar:mC(1,100,0),clipDist:dC(200,0),fogNear:mC(1,100,0),fogFar:mC(1,100,0),cameraType:gC("perspective","orthographic"),cameraFov:mC(1,120,15),lightColor:{type:"color"},lightIntensity:fC(2,10,0),ambientColor:{type:"color"},ambientIntensity:fC(2,10,0),hoverTimeout:dC(1e4,-1),tooltip:{type:"boolean"},mousePreset:gC.apply(void 0,Object.keys(qd))},yC="2.0.0-dev0.0";window.Promise||(window.Promise=a)}.call(this,r("./node_modules/webpack/buildin/global.js"),r("./node_modules/timers-browserify/main.js").setImmediate)},"./node_modules/node-libs-browser/node_modules/process/browser.js":function(e,t){var r,n,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function s(e){if(r===setTimeout)return setTimeout(e,0);if((r===o||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:o}catch(e){r=o}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var l,u=[],c=!1,h=-1;function p(){c&&l&&(c=!1,l.length?u=l.concat(u):h=-1,u.length&&d())}function d(){if(!c){var e=s(p);c=!0;for(var t=u.length;t;){for(l=u,u=[];++h<t;)l&&l[h].run();h=-1,t=u.length}l=null,c=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new f(e,t)),1!==u.length||c||s(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},"./node_modules/object-assign/index.js":function(e,t,r){"use strict";
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},r=0;r<10;r++)t["_"+String.fromCharCode(r)]=r;if("0123456789"!==Object.getOwnPropertyNames(t).map(function(e){return t[e]}).join(""))return!1;var n={};return"abcdefghijklmnopqrst".split("").forEach(function(e){n[e]=e}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},n)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var r,a,s=function(e){if(null===e||void 0===e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),l=1;l<arguments.length;l++){for(var u in r=Object(arguments[l]))i.call(r,u)&&(s[u]=r[u]);if(n){a=n(r);for(var c=0;c<a.length;c++)o.call(r,a[c])&&(s[a[c]]=r[a[c]])}}return s}},"./node_modules/react-dom/cjs/react-dom.production.min.js":function(e,t,r){"use strict";
/** @license React v16.6.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var n=r("./node_modules/react/index.js"),i=r("./node_modules/object-assign/index.js"),o=r("./node_modules/scheduler/index.js");function a(e){for(var t=arguments.length-1,r="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=0;n<t;n++)r+="&args[]="+encodeURIComponent(arguments[n+1]);!function(e,t,r,n,i,o,a,s){if(!e){if(e=void 0,void 0===t)e=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var l=[r,n,i,o,a,s],u=0;(e=Error(t.replace(/%s/g,function(){return l[u++]}))).name="Invariant Violation"}throw e.framesToPop=1,e}}(!1,"Minified React error #"+e+"; visit %s for the full message or use the non-minified dev environment for full errors and additional helpful warnings. ",r)}n||a("227");var s=!1,l=null,u=!1,c=null,h={onError:function(e){s=!0,l=e}};function p(e,t,r,n,i,o,a,u,c){s=!1,l=null,function(e,t,r,n,i,o,a,s,l){var u=Array.prototype.slice.call(arguments,3);try{t.apply(r,u)}catch(e){this.onError(e)}}.apply(h,arguments)}var d=null,f={};function m(){if(d)for(var e in f){var t=f[e],r=d.indexOf(e);if(-1<r||a("96",e),!v[r])for(var n in t.extractEvents||a("97",e),v[r]=t,r=t.eventTypes){var i=void 0,o=r[n],s=t,l=n;y.hasOwnProperty(l)&&a("99",l),y[l]=o;var u=o.phasedRegistrationNames;if(u){for(i in u)u.hasOwnProperty(i)&&g(u[i],s,l);i=!0}else o.registrationName?(g(o.registrationName,s,l),i=!0):i=!1;i||a("98",n,e)}}}function g(e,t,r){b[e]&&a("100",e),b[e]=t,w[e]=t.eventTypes[r].dependencies}var v=[],y={},b={},w={},x=null,_=null,S=null;function C(e,t,r){var n=e.type||"unknown-event";e.currentTarget=S(r),function(e,t,r,n,i,o,h,d,f){if(p.apply(this,arguments),s){if(s){var m=l;s=!1,l=null}else a("198"),m=void 0;u||(u=!0,c=m)}}(n,t,void 0,e),e.currentTarget=null}function M(e,t){return null==t&&a("30"),null==e?t:Array.isArray(e)?Array.isArray(t)?(e.push.apply(e,t),e):(e.push(t),e):Array.isArray(t)?[e].concat(t):[e,t]}function T(e,t,r){Array.isArray(e)?e.forEach(t,r):e&&t.call(r,e)}var A=null;function E(e){if(e){var t=e._dispatchListeners,r=e._dispatchInstances;if(Array.isArray(t))for(var n=0;n<t.length&&!e.isPropagationStopped();n++)C(e,t[n],r[n]);else t&&C(e,t,r);e._dispatchListeners=null,e._dispatchInstances=null,e.isPersistent()||e.constructor.release(e)}}var P={injectEventPluginOrder:function(e){d&&a("101"),d=Array.prototype.slice.call(e),m()},injectEventPluginsByName:function(e){var t,r=!1;for(t in e)if(e.hasOwnProperty(t)){var n=e[t];f.hasOwnProperty(t)&&f[t]===n||(f[t]&&a("102",t),f[t]=n,r=!0)}r&&m()}};function R(e,t){var r=e.stateNode;if(!r)return null;var n=x(r);if(!n)return null;r=n[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":(n=!n.disabled)||(n=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!n;break e;default:e=!1}return e?null:(r&&"function"!=typeof r&&a("231",t,typeof r),r)}function I(e){if(null!==e&&(A=M(A,e)),e=A,A=null,e&&(T(e,E),A&&a("95"),u))throw e=c,u=!1,c=null,e}var N=Math.random().toString(36).slice(2),D="__reactInternalInstance$"+N,k="__reactEventHandlers$"+N;function O(e){if(e[D])return e[D];for(;!e[D];){if(!e.parentNode)return null;e=e.parentNode}return 5===(e=e[D]).tag||6===e.tag?e:null}function F(e){return!(e=e[D])||5!==e.tag&&6!==e.tag?null:e}function L(e){if(5===e.tag||6===e.tag)return e.stateNode;a("33")}function U(e){return e[k]||null}function V(e){do{e=e.return}while(e&&5!==e.tag);return e||null}function B(e,t,r){(t=R(e,r.dispatchConfig.phasedRegistrationNames[t]))&&(r._dispatchListeners=M(r._dispatchListeners,t),r._dispatchInstances=M(r._dispatchInstances,e))}function z(e){if(e&&e.dispatchConfig.phasedRegistrationNames){for(var t=e._targetInst,r=[];t;)r.push(t),t=V(t);for(t=r.length;0<t--;)B(r[t],"captured",e);for(t=0;t<r.length;t++)B(r[t],"bubbled",e)}}function j(e,t,r){e&&r&&r.dispatchConfig.registrationName&&(t=R(e,r.dispatchConfig.registrationName))&&(r._dispatchListeners=M(r._dispatchListeners,t),r._dispatchInstances=M(r._dispatchInstances,e))}function H(e){e&&e.dispatchConfig.registrationName&&j(e._targetInst,null,e)}function $(e){T(e,z)}var G=!("undefined"==typeof window||!window.document||!window.document.createElement);function W(e,t){var r={};return r[e.toLowerCase()]=t.toLowerCase(),r["Webkit"+e]="webkit"+t,r["Moz"+e]="moz"+t,r}var q={animationend:W("Animation","AnimationEnd"),animationiteration:W("Animation","AnimationIteration"),animationstart:W("Animation","AnimationStart"),transitionend:W("Transition","TransitionEnd")},X={},K={};function Y(e){if(X[e])return X[e];if(!q[e])return e;var t,r=q[e];for(t in r)if(r.hasOwnProperty(t)&&t in K)return X[e]=r[t];return e}G&&(K=document.createElement("div").style,"AnimationEvent"in window||(delete q.animationend.animation,delete q.animationiteration.animation,delete q.animationstart.animation),"TransitionEvent"in window||delete q.transitionend.transition);var Z=Y("animationend"),J=Y("animationiteration"),Q=Y("animationstart"),ee=Y("transitionend"),te="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),re=null,ne=null,ie=null;function oe(){if(ie)return ie;var e,t,r=ne,n=r.length,i="value"in re?re.value:re.textContent,o=i.length;for(e=0;e<n&&r[e]===i[e];e++);var a=n-e;for(t=1;t<=a&&r[n-t]===i[o-t];t++);return ie=i.slice(e,1<t?1-t:void 0)}function ae(){return!0}function se(){return!1}function le(e,t,r,n){for(var i in this.dispatchConfig=e,this._targetInst=t,this.nativeEvent=r,e=this.constructor.Interface)e.hasOwnProperty(i)&&((t=e[i])?this[i]=t(r):"target"===i?this.target=n:this[i]=r[i]);return this.isDefaultPrevented=(null!=r.defaultPrevented?r.defaultPrevented:!1===r.returnValue)?ae:se,this.isPropagationStopped=se,this}function ue(e,t,r,n){if(this.eventPool.length){var i=this.eventPool.pop();return this.call(i,e,t,r,n),i}return new this(e,t,r,n)}function ce(e){e instanceof this||a("279"),e.destructor(),10>this.eventPool.length&&this.eventPool.push(e)}function he(e){e.eventPool=[],e.getPooled=ue,e.release=ce}i(le.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=ae)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=ae)},persist:function(){this.isPersistent=ae},isPersistent:se,destructor:function(){var e,t=this.constructor.Interface;for(e in t)this[e]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null,this.isPropagationStopped=this.isDefaultPrevented=se,this._dispatchInstances=this._dispatchListeners=null}}),le.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:null,isTrusted:null},le.extend=function(e){function t(){}function r(){return n.apply(this,arguments)}var n=this;t.prototype=n.prototype;var o=new t;return i(o,r.prototype),r.prototype=o,r.prototype.constructor=r,r.Interface=i({},n.Interface,e),r.extend=n.extend,he(r),r},he(le);var pe=le.extend({data:null}),de=le.extend({data:null}),fe=[9,13,27,32],me=G&&"CompositionEvent"in window,ge=null;G&&"documentMode"in document&&(ge=document.documentMode);var ve=G&&"TextEvent"in window&&!ge,ye=G&&(!me||ge&&8<ge&&11>=ge),be=String.fromCharCode(32),we={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},xe=!1;function _e(e,t){switch(e){case"keyup":return-1!==fe.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"blur":return!0;default:return!1}}function Se(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var Ce=!1;var Me={eventTypes:we,extractEvents:function(e,t,r,n){var i=void 0,o=void 0;if(me)e:{switch(e){case"compositionstart":i=we.compositionStart;break e;case"compositionend":i=we.compositionEnd;break e;case"compositionupdate":i=we.compositionUpdate;break e}i=void 0}else Ce?_e(e,r)&&(i=we.compositionEnd):"keydown"===e&&229===r.keyCode&&(i=we.compositionStart);return i?(ye&&"ko"!==r.locale&&(Ce||i!==we.compositionStart?i===we.compositionEnd&&Ce&&(o=oe()):(ne="value"in(re=n)?re.value:re.textContent,Ce=!0)),i=pe.getPooled(i,t,r,n),o?i.data=o:null!==(o=Se(r))&&(i.data=o),$(i),o=i):o=null,(e=ve?function(e,t){switch(e){case"compositionend":return Se(t);case"keypress":return 32!==t.which?null:(xe=!0,be);case"textInput":return(e=t.data)===be&&xe?null:e;default:return null}}(e,r):function(e,t){if(Ce)return"compositionend"===e||!me&&_e(e,t)?(e=oe(),ie=ne=re=null,Ce=!1,e):null;switch(e){case"paste":return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return ye&&"ko"!==t.locale?null:t.data;default:return null}}(e,r))?((t=de.getPooled(we.beforeInput,t,r,n)).data=e,$(t)):t=null,null===o?t:null===t?o:[o,t]}},Te=null,Ae=null,Ee=null;function Pe(e){if(e=_(e)){"function"!=typeof Te&&a("280");var t=x(e.stateNode);Te(e.stateNode,e.type,t)}}function Re(e){Ae?Ee?Ee.push(e):Ee=[e]:Ae=e}function Ie(){if(Ae){var e=Ae,t=Ee;if(Ee=Ae=null,Pe(e),t)for(e=0;e<t.length;e++)Pe(t[e])}}function Ne(e,t){return e(t)}function De(e,t,r){return e(t,r)}function ke(){}var Oe=!1;function Fe(e,t){if(Oe)return e(t);Oe=!0;try{return Ne(e,t)}finally{Oe=!1,(null!==Ae||null!==Ee)&&(ke(),Ie())}}var Le={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Ue(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Le[e.type]:"textarea"===t}function Ve(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}function Be(e){if(!G)return!1;var t=(e="on"+e)in document;return t||((t=document.createElement("div")).setAttribute(e,"return;"),t="function"==typeof t[e]),t}function ze(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function je(e){e._valueTracker||(e._valueTracker=function(e){var t=ze(e)?"checked":"value",r=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),n=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==r&&"function"==typeof r.get&&"function"==typeof r.set){var i=r.get,o=r.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return i.call(this)},set:function(e){n=""+e,o.call(this,e)}}),Object.defineProperty(e,t,{enumerable:r.enumerable}),{getValue:function(){return n},setValue:function(e){n=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function He(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var r=t.getValue(),n="";return e&&(n=ze(e)?e.checked?"true":"false":e.value),(e=n)!==r&&(t.setValue(e),!0)}var $e=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Ge=/^(.*)[\\\/]/,We="function"==typeof Symbol&&Symbol.for,qe=We?Symbol.for("react.element"):60103,Xe=We?Symbol.for("react.portal"):60106,Ke=We?Symbol.for("react.fragment"):60107,Ye=We?Symbol.for("react.strict_mode"):60108,Ze=We?Symbol.for("react.profiler"):60114,Je=We?Symbol.for("react.provider"):60109,Qe=We?Symbol.for("react.context"):60110,et=We?Symbol.for("react.concurrent_mode"):60111,tt=We?Symbol.for("react.forward_ref"):60112,rt=We?Symbol.for("react.suspense"):60113,nt=We?Symbol.for("react.memo"):60115,it=We?Symbol.for("react.lazy"):60116,ot="function"==typeof Symbol&&Symbol.iterator;function at(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=ot&&e[ot]||e["@@iterator"])?e:null}function st(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case et:return"ConcurrentMode";case Ke:return"Fragment";case Xe:return"Portal";case Ze:return"Profiler";case Ye:return"StrictMode";case rt:return"Suspense"}if("object"==typeof e)switch(e.$$typeof){case Qe:return"Context.Consumer";case Je:return"Context.Provider";case tt:var t=e.render;return t=t.displayName||t.name||"",e.displayName||(""!==t?"ForwardRef("+t+")":"ForwardRef");case nt:return st(e.type);case it:if(e=1===e._status?e._result:null)return st(e)}return null}function lt(e){var t="";do{e:switch(e.tag){case 2:case 16:case 0:case 1:case 5:case 8:case 13:var r=e._debugOwner,n=e._debugSource,i=st(e.type),o=null;r&&(o=st(r.type)),r=i,i="",n?i=" (at "+n.fileName.replace(Ge,"")+":"+n.lineNumber+")":o&&(i=" (created by "+o+")"),o="\n    in "+(r||"Unknown")+i;break e;default:o=""}t+=o,e=e.return}while(e);return t}var ut=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,ct=Object.prototype.hasOwnProperty,ht={},pt={};function dt(e,t,r,n,i){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=r,this.propertyName=e,this.type=t}var ft={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(e){ft[e]=new dt(e,0,!1,e,null)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(e){var t=e[0];ft[t]=new dt(t,1,!1,e[1],null)}),["contentEditable","draggable","spellCheck","value"].forEach(function(e){ft[e]=new dt(e,2,!1,e.toLowerCase(),null)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(e){ft[e]=new dt(e,2,!1,e,null)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(e){ft[e]=new dt(e,3,!1,e.toLowerCase(),null)}),["checked","multiple","muted","selected"].forEach(function(e){ft[e]=new dt(e,3,!0,e,null)}),["capture","download"].forEach(function(e){ft[e]=new dt(e,4,!1,e,null)}),["cols","rows","size","span"].forEach(function(e){ft[e]=new dt(e,6,!1,e,null)}),["rowSpan","start"].forEach(function(e){ft[e]=new dt(e,5,!1,e.toLowerCase(),null)});var mt=/[\-:]([a-z])/g;function gt(e){return e[1].toUpperCase()}function vt(e,t,r,n){var i=ft.hasOwnProperty(t)?ft[t]:null;(null!==i?0===i.type:!n&&(2<t.length&&("o"===t[0]||"O"===t[0])&&("n"===t[1]||"N"===t[1])))||(function(e,t,r,n){if(null===t||void 0===t||function(e,t,r,n){if(null!==r&&0===r.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!n&&(null!==r?!r.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,r,n))return!0;if(n)return!1;if(null!==r)switch(r.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,r,i,n)&&(r=null),n||null===i?function(e){return!!ct.call(pt,e)||!ct.call(ht,e)&&(ut.test(e)?pt[e]=!0:(ht[e]=!0,!1))}(t)&&(null===r?e.removeAttribute(t):e.setAttribute(t,""+r)):i.mustUseProperty?e[i.propertyName]=null===r?3!==i.type&&"":r:(t=i.attributeName,n=i.attributeNamespace,null===r?e.removeAttribute(t):(r=3===(i=i.type)||4===i&&!0===r?"":""+r,n?e.setAttributeNS(n,t,r):e.setAttribute(t,r))))}function yt(e){switch(typeof e){case"boolean":case"number":case"object":case"string":case"undefined":return e;default:return""}}function bt(e,t){var r=t.checked;return i({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=r?r:e._wrapperState.initialChecked})}function wt(e,t){var r=null==t.defaultValue?"":t.defaultValue,n=null!=t.checked?t.checked:t.defaultChecked;r=yt(null!=t.value?t.value:r),e._wrapperState={initialChecked:n,initialValue:r,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function xt(e,t){null!=(t=t.checked)&&vt(e,"checked",t,!1)}function _t(e,t){xt(e,t);var r=yt(t.value),n=t.type;if(null!=r)"number"===n?(0===r&&""===e.value||e.value!=r)&&(e.value=""+r):e.value!==""+r&&(e.value=""+r);else if("submit"===n||"reset"===n)return void e.removeAttribute("value");t.hasOwnProperty("value")?Ct(e,t.type,r):t.hasOwnProperty("defaultValue")&&Ct(e,t.type,yt(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function St(e,t,r){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var n=t.type;if(!("submit"!==n&&"reset"!==n||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,r||t===e.value||(e.value=t),e.defaultValue=t}""!==(r=e.name)&&(e.name=""),e.defaultChecked=!e.defaultChecked,e.defaultChecked=!!e._wrapperState.initialChecked,""!==r&&(e.name=r)}function Ct(e,t,r){"number"===t&&e.ownerDocument.activeElement===e||(null==r?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+r&&(e.defaultValue=""+r))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(e){var t=e.replace(mt,gt);ft[t]=new dt(t,1,!1,e,null)}),"xlink:actuate xlink:arcrole xlink:href xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(e){var t=e.replace(mt,gt);ft[t]=new dt(t,1,!1,e,"http://www.w3.org/1999/xlink")}),["xml:base","xml:lang","xml:space"].forEach(function(e){var t=e.replace(mt,gt);ft[t]=new dt(t,1,!1,e,"http://www.w3.org/XML/1998/namespace")}),ft.tabIndex=new dt("tabIndex",1,!1,"tabindex",null);var Mt={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}};function Tt(e,t,r){return(e=le.getPooled(Mt.change,e,t,r)).type="change",Re(r),$(e),e}var At=null,Et=null;function Pt(e){I(e)}function Rt(e){if(He(L(e)))return e}function It(e,t){if("change"===e)return t}var Nt=!1;function Dt(){At&&(At.detachEvent("onpropertychange",kt),Et=At=null)}function kt(e){"value"===e.propertyName&&Rt(Et)&&Fe(Pt,e=Tt(Et,e,Ve(e)))}function Ot(e,t,r){"focus"===e?(Dt(),Et=r,(At=t).attachEvent("onpropertychange",kt)):"blur"===e&&Dt()}function Ft(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Rt(Et)}function Lt(e,t){if("click"===e)return Rt(t)}function Ut(e,t){if("input"===e||"change"===e)return Rt(t)}G&&(Nt=Be("input")&&(!document.documentMode||9<document.documentMode));var Vt={eventTypes:Mt,_isInputEventSupported:Nt,extractEvents:function(e,t,r,n){var i=t?L(t):window,o=void 0,a=void 0,s=i.nodeName&&i.nodeName.toLowerCase();if("select"===s||"input"===s&&"file"===i.type?o=It:Ue(i)?Nt?o=Ut:(o=Ft,a=Ot):(s=i.nodeName)&&"input"===s.toLowerCase()&&("checkbox"===i.type||"radio"===i.type)&&(o=Lt),o&&(o=o(e,t)))return Tt(o,r,n);a&&a(e,i,t),"blur"===e&&(e=i._wrapperState)&&e.controlled&&"number"===i.type&&Ct(i,"number",i.value)}},Bt=le.extend({view:null,detail:null}),zt={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function jt(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=zt[e])&&!!t[e]}function Ht(){return jt}var $t=0,Gt=0,Wt=!1,qt=!1,Xt=Bt.extend({screenX:null,screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:Ht,button:null,buttons:null,relatedTarget:function(e){return e.relatedTarget||(e.fromElement===e.srcElement?e.toElement:e.fromElement)},movementX:function(e){if("movementX"in e)return e.movementX;var t=$t;return $t=e.screenX,Wt?"mousemove"===e.type?e.screenX-t:0:(Wt=!0,0)},movementY:function(e){if("movementY"in e)return e.movementY;var t=Gt;return Gt=e.screenY,qt?"mousemove"===e.type?e.screenY-t:0:(qt=!0,0)}}),Kt=Xt.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),Yt={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout","pointerover"]}},Zt={eventTypes:Yt,extractEvents:function(e,t,r,n){var i="mouseover"===e||"pointerover"===e,o="mouseout"===e||"pointerout"===e;if(i&&(r.relatedTarget||r.fromElement)||!o&&!i)return null;if(i=n.window===n?n:(i=n.ownerDocument)?i.defaultView||i.parentWindow:window,o?(o=t,t=(t=r.relatedTarget||r.toElement)?O(t):null):o=null,o===t)return null;var a=void 0,s=void 0,l=void 0,u=void 0;"mouseout"===e||"mouseover"===e?(a=Xt,s=Yt.mouseLeave,l=Yt.mouseEnter,u="mouse"):"pointerout"!==e&&"pointerover"!==e||(a=Kt,s=Yt.pointerLeave,l=Yt.pointerEnter,u="pointer");var c=null==o?i:L(o);if(i=null==t?i:L(t),(e=a.getPooled(s,o,r,n)).type=u+"leave",e.target=c,e.relatedTarget=i,(r=a.getPooled(l,t,r,n)).type=u+"enter",r.target=i,r.relatedTarget=c,n=t,o&&n)e:{for(i=n,u=0,a=t=o;a;a=V(a))u++;for(a=0,l=i;l;l=V(l))a++;for(;0<u-a;)t=V(t),u--;for(;0<a-u;)i=V(i),a--;for(;u--;){if(t===i||t===i.alternate)break e;t=V(t),i=V(i)}t=null}else t=null;for(i=t,t=[];o&&o!==i&&(null===(u=o.alternate)||u!==i);)t.push(o),o=V(o);for(o=[];n&&n!==i&&(null===(u=n.alternate)||u!==i);)o.push(n),n=V(n);for(n=0;n<t.length;n++)j(t[n],"bubbled",e);for(n=o.length;0<n--;)j(o[n],"captured",r);return[e,r]}},Jt=Object.prototype.hasOwnProperty;function Qt(e,t){return e===t?0!==e||0!==t||1/e==1/t:e!=e&&t!=t}function er(e,t){if(Qt(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(n=0;n<r.length;n++)if(!Jt.call(t,r[n])||!Qt(e[r[n]],t[r[n]]))return!1;return!0}function tr(e){var t=e;if(e.alternate)for(;t.return;)t=t.return;else{if(0!=(2&t.effectTag))return 1;for(;t.return;)if(0!=(2&(t=t.return).effectTag))return 1}return 3===t.tag?2:3}function rr(e){2!==tr(e)&&a("188")}function nr(e){if(!(e=function(e){var t=e.alternate;if(!t)return 3===(t=tr(e))&&a("188"),1===t?null:e;for(var r=e,n=t;;){var i=r.return,o=i?i.alternate:null;if(!i||!o)break;if(i.child===o.child){for(var s=i.child;s;){if(s===r)return rr(i),e;if(s===n)return rr(i),t;s=s.sibling}a("188")}if(r.return!==n.return)r=i,n=o;else{s=!1;for(var l=i.child;l;){if(l===r){s=!0,r=i,n=o;break}if(l===n){s=!0,n=i,r=o;break}l=l.sibling}if(!s){for(l=o.child;l;){if(l===r){s=!0,r=o,n=i;break}if(l===n){s=!0,n=o,r=i;break}l=l.sibling}s||a("189")}}r.alternate!==n&&a("190")}return 3!==r.tag&&a("188"),r.stateNode.current===r?e:t}(e)))return null;for(var t=e;;){if(5===t.tag||6===t.tag)return t;if(t.child)t.child.return=t,t=t.child;else{if(t===e)break;for(;!t.sibling;){if(!t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}}return null}var ir=le.extend({animationName:null,elapsedTime:null,pseudoElement:null}),or=le.extend({clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),ar=Bt.extend({relatedTarget:null});function sr(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}var lr={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},ur={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},cr=Bt.extend({key:function(e){if(e.key){var t=lr[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=sr(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?ur[e.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:Ht,charCode:function(e){return"keypress"===e.type?sr(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?sr(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),hr=Xt.extend({dataTransfer:null}),pr=Bt.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:Ht}),dr=le.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),fr=Xt.extend({deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:null,deltaMode:null}),mr=[["abort","abort"],[Z,"animationEnd"],[J,"animationIteration"],[Q,"animationStart"],["canplay","canPlay"],["canplaythrough","canPlayThrough"],["drag","drag"],["dragenter","dragEnter"],["dragexit","dragExit"],["dragleave","dragLeave"],["dragover","dragOver"],["durationchange","durationChange"],["emptied","emptied"],["encrypted","encrypted"],["ended","ended"],["error","error"],["gotpointercapture","gotPointerCapture"],["load","load"],["loadeddata","loadedData"],["loadedmetadata","loadedMetadata"],["loadstart","loadStart"],["lostpointercapture","lostPointerCapture"],["mousemove","mouseMove"],["mouseout","mouseOut"],["mouseover","mouseOver"],["playing","playing"],["pointermove","pointerMove"],["pointerout","pointerOut"],["pointerover","pointerOver"],["progress","progress"],["scroll","scroll"],["seeking","seeking"],["stalled","stalled"],["suspend","suspend"],["timeupdate","timeUpdate"],["toggle","toggle"],["touchmove","touchMove"],[ee,"transitionEnd"],["waiting","waiting"],["wheel","wheel"]],gr={},vr={};function yr(e,t){var r=e[0],n="on"+((e=e[1])[0].toUpperCase()+e.slice(1));t={phasedRegistrationNames:{bubbled:n,captured:n+"Capture"},dependencies:[r],isInteractive:t},gr[e]=t,vr[r]=t}[["blur","blur"],["cancel","cancel"],["click","click"],["close","close"],["contextmenu","contextMenu"],["copy","copy"],["cut","cut"],["auxclick","auxClick"],["dblclick","doubleClick"],["dragend","dragEnd"],["dragstart","dragStart"],["drop","drop"],["focus","focus"],["input","input"],["invalid","invalid"],["keydown","keyDown"],["keypress","keyPress"],["keyup","keyUp"],["mousedown","mouseDown"],["mouseup","mouseUp"],["paste","paste"],["pause","pause"],["play","play"],["pointercancel","pointerCancel"],["pointerdown","pointerDown"],["pointerup","pointerUp"],["ratechange","rateChange"],["reset","reset"],["seeked","seeked"],["submit","submit"],["touchcancel","touchCancel"],["touchend","touchEnd"],["touchstart","touchStart"],["volumechange","volumeChange"]].forEach(function(e){yr(e,!0)}),mr.forEach(function(e){yr(e,!1)});var br={eventTypes:gr,isInteractiveTopLevelEventType:function(e){return void 0!==(e=vr[e])&&!0===e.isInteractive},extractEvents:function(e,t,r,n){var i=vr[e];if(!i)return null;switch(e){case"keypress":if(0===sr(r))return null;case"keydown":case"keyup":e=cr;break;case"blur":case"focus":e=ar;break;case"click":if(2===r.button)return null;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":e=Xt;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":e=hr;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":e=pr;break;case Z:case J:case Q:e=ir;break;case ee:e=dr;break;case"scroll":e=Bt;break;case"wheel":e=fr;break;case"copy":case"cut":case"paste":e=or;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":e=Kt;break;default:e=le}return $(t=e.getPooled(i,t,r,n)),t}},wr=br.isInteractiveTopLevelEventType,xr=[];function _r(e){var t=e.targetInst,r=t;do{if(!r){e.ancestors.push(r);break}var n;for(n=r;n.return;)n=n.return;if(!(n=3!==n.tag?null:n.stateNode.containerInfo))break;e.ancestors.push(r),r=O(n)}while(r);for(r=0;r<e.ancestors.length;r++){t=e.ancestors[r];var i=Ve(e.nativeEvent);n=e.topLevelType;for(var o=e.nativeEvent,a=null,s=0;s<v.length;s++){var l=v[s];l&&(l=l.extractEvents(n,t,o,i))&&(a=M(a,l))}I(a)}}var Sr=!0;function Cr(e,t){if(!t)return null;var r=(wr(e)?Tr:Ar).bind(null,e);t.addEventListener(e,r,!1)}function Mr(e,t){if(!t)return null;var r=(wr(e)?Tr:Ar).bind(null,e);t.addEventListener(e,r,!0)}function Tr(e,t){De(Ar,e,t)}function Ar(e,t){if(Sr){var r=Ve(t);if(null===(r=O(r))||"number"!=typeof r.tag||2===tr(r)||(r=null),xr.length){var n=xr.pop();n.topLevelType=e,n.nativeEvent=t,n.targetInst=r,e=n}else e={topLevelType:e,nativeEvent:t,targetInst:r,ancestors:[]};try{Fe(_r,e)}finally{e.topLevelType=null,e.nativeEvent=null,e.targetInst=null,e.ancestors.length=0,10>xr.length&&xr.push(e)}}}var Er={},Pr=0,Rr="_reactListenersID"+(""+Math.random()).slice(2);function Ir(e){return Object.prototype.hasOwnProperty.call(e,Rr)||(e[Rr]=Pr++,Er[e[Rr]]={}),Er[e[Rr]]}function Nr(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function Dr(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function kr(e,t){var r,n=Dr(e);for(e=0;n;){if(3===n.nodeType){if(r=e+n.textContent.length,e<=t&&r>=t)return{node:n,offset:t-e};e=r}e:{for(;n;){if(n.nextSibling){n=n.nextSibling;break e}n=n.parentNode}n=void 0}n=Dr(n)}}function Or(){for(var e=window,t=Nr();t instanceof e.HTMLIFrameElement;){try{e=t.contentDocument.defaultView}catch(e){break}t=Nr(e.document)}return t}function Fr(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}var Lr=G&&"documentMode"in document&&11>=document.documentMode,Ur={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},Vr=null,Br=null,zr=null,jr=!1;function Hr(e,t){var r=t.window===t?t.document:9===t.nodeType?t:t.ownerDocument;return jr||null==Vr||Vr!==Nr(r)?null:("selectionStart"in(r=Vr)&&Fr(r)?r={start:r.selectionStart,end:r.selectionEnd}:r={anchorNode:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset},zr&&er(zr,r)?null:(zr=r,(e=le.getPooled(Ur.select,Br,e,t)).type="select",e.target=Vr,$(e),e))}var $r={eventTypes:Ur,extractEvents:function(e,t,r,n){var i,o=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;if(!(i=!o)){e:{o=Ir(o),i=w.onSelect;for(var a=0;a<i.length;a++){var s=i[a];if(!o.hasOwnProperty(s)||!o[s]){o=!1;break e}}o=!0}i=!o}if(i)return null;switch(o=t?L(t):window,e){case"focus":(Ue(o)||"true"===o.contentEditable)&&(Vr=o,Br=t,zr=null);break;case"blur":zr=Br=Vr=null;break;case"mousedown":jr=!0;break;case"contextmenu":case"mouseup":case"dragend":return jr=!1,Hr(r,n);case"selectionchange":if(Lr)break;case"keydown":case"keyup":return Hr(r,n)}return null}};function Gr(e,t){return e=i({children:void 0},t),(t=function(e){var t="";return n.Children.forEach(e,function(e){null!=e&&(t+=e)}),t}(t.children))&&(e.children=t),e}function Wr(e,t,r,n){if(e=e.options,t){t={};for(var i=0;i<r.length;i++)t["$"+r[i]]=!0;for(r=0;r<e.length;r++)i=t.hasOwnProperty("$"+e[r].value),e[r].selected!==i&&(e[r].selected=i),i&&n&&(e[r].defaultSelected=!0)}else{for(r=""+yt(r),t=null,i=0;i<e.length;i++){if(e[i].value===r)return e[i].selected=!0,void(n&&(e[i].defaultSelected=!0));null!==t||e[i].disabled||(t=e[i])}null!==t&&(t.selected=!0)}}function qr(e,t){return null!=t.dangerouslySetInnerHTML&&a("91"),i({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function Xr(e,t){var r=t.value;null==r&&(r=t.defaultValue,null!=(t=t.children)&&(null!=r&&a("92"),Array.isArray(t)&&(1>=t.length||a("93"),t=t[0]),r=t),null==r&&(r="")),e._wrapperState={initialValue:yt(r)}}function Kr(e,t){var r=yt(t.value),n=yt(t.defaultValue);null!=r&&((r=""+r)!==e.value&&(e.value=r),null==t.defaultValue&&e.defaultValue!==r&&(e.defaultValue=r)),null!=n&&(e.defaultValue=""+n)}function Yr(e){var t=e.textContent;t===e._wrapperState.initialValue&&(e.value=t)}P.injectEventPluginOrder("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" ")),x=U,_=F,S=L,P.injectEventPluginsByName({SimpleEventPlugin:br,EnterLeaveEventPlugin:Zt,ChangeEventPlugin:Vt,SelectEventPlugin:$r,BeforeInputEventPlugin:Me});var Zr={html:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg"};function Jr(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Qr(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?Jr(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var en=void 0,tn=function(e){return"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(t,r,n,i){MSApp.execUnsafeLocalFunction(function(){return e(t,r)})}:e}(function(e,t){if(e.namespaceURI!==Zr.svg||"innerHTML"in e)e.innerHTML=t;else{for((en=en||document.createElement("div")).innerHTML="<svg>"+t+"</svg>",t=en.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}});function rn(e,t){if(t){var r=e.firstChild;if(r&&r===e.lastChild&&3===r.nodeType)return void(r.nodeValue=t)}e.textContent=t}var nn={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},on=["Webkit","ms","Moz","O"];function an(e,t,r){return null==t||"boolean"==typeof t||""===t?"":r||"number"!=typeof t||0===t||nn.hasOwnProperty(e)&&nn[e]?(""+t).trim():t+"px"}function sn(e,t){for(var r in e=e.style,t)if(t.hasOwnProperty(r)){var n=0===r.indexOf("--"),i=an(r,t[r],n);"float"===r&&(r="cssFloat"),n?e.setProperty(r,i):e[r]=i}}Object.keys(nn).forEach(function(e){on.forEach(function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),nn[t]=nn[e]})});var ln=i({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function un(e,t){t&&(ln[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML)&&a("137",e,""),null!=t.dangerouslySetInnerHTML&&(null!=t.children&&a("60"),"object"==typeof t.dangerouslySetInnerHTML&&"__html"in t.dangerouslySetInnerHTML||a("61")),null!=t.style&&"object"!=typeof t.style&&a("62",""))}function cn(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}function hn(e,t){var r=Ir(e=9===e.nodeType||11===e.nodeType?e:e.ownerDocument);t=w[t];for(var n=0;n<t.length;n++){var i=t[n];if(!r.hasOwnProperty(i)||!r[i]){switch(i){case"scroll":Mr("scroll",e);break;case"focus":case"blur":Mr("focus",e),Mr("blur",e),r.blur=!0,r.focus=!0;break;case"cancel":case"close":Be(i)&&Mr(i,e);break;case"invalid":case"submit":case"reset":break;default:-1===te.indexOf(i)&&Cr(i,e)}r[i]=!0}}}function pn(){}var dn=null,fn=null;function mn(e,t){switch(e){case"button":case"input":case"select":case"textarea":return!!t.autoFocus}return!1}function gn(e,t){return"textarea"===e||"option"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var vn="function"==typeof setTimeout?setTimeout:void 0,yn="function"==typeof clearTimeout?clearTimeout:void 0;function bn(e){for(e=e.nextSibling;e&&1!==e.nodeType&&3!==e.nodeType;)e=e.nextSibling;return e}function wn(e){for(e=e.firstChild;e&&1!==e.nodeType&&3!==e.nodeType;)e=e.nextSibling;return e}new Set;var xn=[],_n=-1;function Sn(e){0>_n||(e.current=xn[_n],xn[_n]=null,_n--)}function Cn(e,t){xn[++_n]=e.current,e.current=t}var Mn={},Tn={current:Mn},An={current:!1},En=Mn;function Pn(e,t){var r=e.type.contextTypes;if(!r)return Mn;var n=e.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===t)return n.__reactInternalMemoizedMaskedChildContext;var i,o={};for(i in r)o[i]=t[i];return n&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=o),o}function Rn(e){return null!==(e=e.childContextTypes)&&void 0!==e}function In(e){Sn(An),Sn(Tn)}function Nn(e){Sn(An),Sn(Tn)}function Dn(e,t,r){Tn.current!==Mn&&a("168"),Cn(Tn,t),Cn(An,r)}function kn(e,t,r){var n=e.stateNode;if(e=t.childContextTypes,"function"!=typeof n.getChildContext)return r;for(var o in n=n.getChildContext())o in e||a("108",st(t)||"Unknown",o);return i({},r,n)}function On(e){var t=e.stateNode;return t=t&&t.__reactInternalMemoizedMergedChildContext||Mn,En=Tn.current,Cn(Tn,t),Cn(An,An.current),!0}function Fn(e,t,r){var n=e.stateNode;n||a("169"),r?(t=kn(e,t,En),n.__reactInternalMemoizedMergedChildContext=t,Sn(An),Sn(Tn),Cn(Tn,t)):Sn(An),Cn(An,r)}var Ln=null,Un=null;function Vn(e){return function(t){try{return e(t)}catch(e){}}}function Bn(e,t,r,n){return new function(e,t,r,n){this.tag=e,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.firstContextDependency=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.effectTag=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.childExpirationTime=this.expirationTime=0,this.alternate=null}(e,t,r,n)}function zn(e){return!(!(e=e.prototype)||!e.isReactComponent)}function jn(e,t){var r=e.alternate;return null===r?((r=Bn(e.tag,t,e.key,e.mode)).elementType=e.elementType,r.type=e.type,r.stateNode=e.stateNode,r.alternate=e,e.alternate=r):(r.pendingProps=t,r.effectTag=0,r.nextEffect=null,r.firstEffect=null,r.lastEffect=null),r.childExpirationTime=e.childExpirationTime,r.expirationTime=e.expirationTime,r.child=e.child,r.memoizedProps=e.memoizedProps,r.memoizedState=e.memoizedState,r.updateQueue=e.updateQueue,r.firstContextDependency=e.firstContextDependency,r.sibling=e.sibling,r.index=e.index,r.ref=e.ref,r}function Hn(e,t,r,n,i,o){var s=2;if(n=e,"function"==typeof e)zn(e)&&(s=1);else if("string"==typeof e)s=5;else e:switch(e){case Ke:return $n(r.children,i,o,t);case et:return Gn(r,3|i,o,t);case Ye:return Gn(r,2|i,o,t);case Ze:return(e=Bn(12,r,t,4|i)).elementType=Ze,e.type=Ze,e.expirationTime=o,e;case rt:return(e=Bn(13,r,t,i)).elementType=rt,e.type=rt,e.expirationTime=o,e;default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case Je:s=10;break e;case Qe:s=9;break e;case tt:s=11;break e;case nt:s=14;break e;case it:s=16,n=null;break e}a("130",null==e?e:typeof e,"")}return(t=Bn(s,r,t,i)).elementType=e,t.type=n,t.expirationTime=o,t}function $n(e,t,r,n){return(e=Bn(7,e,n,t)).expirationTime=r,e}function Gn(e,t,r,n){return e=Bn(8,e,n,t),t=0==(1&t)?Ye:et,e.elementType=t,e.type=t,e.expirationTime=r,e}function Wn(e,t,r){return(e=Bn(6,e,null,t)).expirationTime=r,e}function qn(e,t,r){return(t=Bn(4,null!==e.children?e.children:[],e.key,t)).expirationTime=r,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Xn(e,t){e.didError=!1;var r=e.earliestPendingTime;0===r?e.earliestPendingTime=e.latestPendingTime=t:r<t?e.earliestPendingTime=t:e.latestPendingTime>t&&(e.latestPendingTime=t),Zn(t,e)}function Kn(e,t){e.didError=!1;var r=e.latestPingedTime;0!==r&&r>=t&&(e.latestPingedTime=0),r=e.earliestPendingTime;var n=e.latestPendingTime;r===t?e.earliestPendingTime=n===t?e.latestPendingTime=0:n:n===t&&(e.latestPendingTime=r),r=e.earliestSuspendedTime,n=e.latestSuspendedTime,0===r?e.earliestSuspendedTime=e.latestSuspendedTime=t:r<t?e.earliestSuspendedTime=t:n>t&&(e.latestSuspendedTime=t),Zn(t,e)}function Yn(e,t){var r=e.earliestPendingTime;return e=e.earliestSuspendedTime,r>t&&(t=r),e>t&&(t=e),t}function Zn(e,t){var r=t.earliestSuspendedTime,n=t.latestSuspendedTime,i=t.earliestPendingTime,o=t.latestPingedTime;0===(i=0!==i?i:o)&&(0===e||n<e)&&(i=n),0!==(e=i)&&r>e&&(e=r),t.nextExpirationTimeToWorkOn=i,t.expirationTime=e}var Jn=!1;function Qn(e){return{baseState:e,firstUpdate:null,lastUpdate:null,firstCapturedUpdate:null,lastCapturedUpdate:null,firstEffect:null,lastEffect:null,firstCapturedEffect:null,lastCapturedEffect:null}}function ei(e){return{baseState:e.baseState,firstUpdate:e.firstUpdate,lastUpdate:e.lastUpdate,firstCapturedUpdate:null,lastCapturedUpdate:null,firstEffect:null,lastEffect:null,firstCapturedEffect:null,lastCapturedEffect:null}}function ti(e){return{expirationTime:e,tag:0,payload:null,callback:null,next:null,nextEffect:null}}function ri(e,t){null===e.lastUpdate?e.firstUpdate=e.lastUpdate=t:(e.lastUpdate.next=t,e.lastUpdate=t)}function ni(e,t){var r=e.alternate;if(null===r){var n=e.updateQueue,i=null;null===n&&(n=e.updateQueue=Qn(e.memoizedState))}else n=e.updateQueue,i=r.updateQueue,null===n?null===i?(n=e.updateQueue=Qn(e.memoizedState),i=r.updateQueue=Qn(r.memoizedState)):n=e.updateQueue=ei(i):null===i&&(i=r.updateQueue=ei(n));null===i||n===i?ri(n,t):null===n.lastUpdate||null===i.lastUpdate?(ri(n,t),ri(i,t)):(ri(n,t),i.lastUpdate=t)}function ii(e,t){var r=e.updateQueue;null===(r=null===r?e.updateQueue=Qn(e.memoizedState):oi(e,r)).lastCapturedUpdate?r.firstCapturedUpdate=r.lastCapturedUpdate=t:(r.lastCapturedUpdate.next=t,r.lastCapturedUpdate=t)}function oi(e,t){var r=e.alternate;return null!==r&&t===r.updateQueue&&(t=e.updateQueue=ei(t)),t}function ai(e,t,r,n,o,a){switch(r.tag){case 1:return"function"==typeof(e=r.payload)?e.call(a,n,o):e;case 3:e.effectTag=-2049&e.effectTag|64;case 0:if(null===(o="function"==typeof(e=r.payload)?e.call(a,n,o):e)||void 0===o)break;return i({},n,o);case 2:Jn=!0}return n}function si(e,t,r,n,i){Jn=!1;for(var o=(t=oi(e,t)).baseState,a=null,s=0,l=t.firstUpdate,u=o;null!==l;){var c=l.expirationTime;c<i?(null===a&&(a=l,o=u),s<c&&(s=c)):(u=ai(e,0,l,u,r,n),null!==l.callback&&(e.effectTag|=32,l.nextEffect=null,null===t.lastEffect?t.firstEffect=t.lastEffect=l:(t.lastEffect.nextEffect=l,t.lastEffect=l))),l=l.next}for(c=null,l=t.firstCapturedUpdate;null!==l;){var h=l.expirationTime;h<i?(null===c&&(c=l,null===a&&(o=u)),s<h&&(s=h)):(u=ai(e,0,l,u,r,n),null!==l.callback&&(e.effectTag|=32,l.nextEffect=null,null===t.lastCapturedEffect?t.firstCapturedEffect=t.lastCapturedEffect=l:(t.lastCapturedEffect.nextEffect=l,t.lastCapturedEffect=l))),l=l.next}null===a&&(t.lastUpdate=null),null===c?t.lastCapturedUpdate=null:e.effectTag|=32,null===a&&null===c&&(o=u),t.baseState=o,t.firstUpdate=a,t.firstCapturedUpdate=c,e.expirationTime=s,e.memoizedState=u}function li(e,t,r){null!==t.firstCapturedUpdate&&(null!==t.lastUpdate&&(t.lastUpdate.next=t.firstCapturedUpdate,t.lastUpdate=t.lastCapturedUpdate),t.firstCapturedUpdate=t.lastCapturedUpdate=null),ui(t.firstEffect,r),t.firstEffect=t.lastEffect=null,ui(t.firstCapturedEffect,r),t.firstCapturedEffect=t.lastCapturedEffect=null}function ui(e,t){for(;null!==e;){var r=e.callback;if(null!==r){e.callback=null;var n=t;"function"!=typeof r&&a("191",r),r.call(n)}e=e.nextEffect}}function ci(e,t){return{value:e,source:t,stack:lt(t)}}var hi={current:null},pi=null,di=null,fi=null;function mi(e,t){var r=e.type._context;Cn(hi,r._currentValue),r._currentValue=t}function gi(e){var t=hi.current;Sn(hi),e.type._context._currentValue=t}function vi(e){pi=e,fi=di=null,e.firstContextDependency=null}function yi(e,t){return fi!==e&&!1!==t&&0!==t&&("number"==typeof t&&1073741823!==t||(fi=e,t=1073741823),t={context:e,observedBits:t,next:null},null===di?(null===pi&&a("293"),pi.firstContextDependency=di=t):di=di.next=t),e._currentValue}var bi={},wi={current:bi},xi={current:bi},_i={current:bi};function Si(e){return e===bi&&a("174"),e}function Ci(e,t){Cn(_i,t),Cn(xi,e),Cn(wi,bi);var r=t.nodeType;switch(r){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:Qr(null,"");break;default:t=Qr(t=(r=8===r?t.parentNode:t).namespaceURI||null,r=r.tagName)}Sn(wi),Cn(wi,t)}function Mi(e){Sn(wi),Sn(xi),Sn(_i)}function Ti(e){Si(_i.current);var t=Si(wi.current),r=Qr(t,e.type);t!==r&&(Cn(xi,e),Cn(wi,r))}function Ai(e){xi.current===e&&(Sn(wi),Sn(xi))}function Ei(e,t){if(e&&e.defaultProps)for(var r in t=i({},t),e=e.defaultProps)void 0===t[r]&&(t[r]=e[r]);return t}var Pi=$e.ReactCurrentOwner,Ri=(new n.Component).refs;function Ii(e,t,r,n){r=null===(r=r(n,t=e.memoizedState))||void 0===r?t:i({},t,r),e.memoizedState=r,null!==(n=e.updateQueue)&&0===e.expirationTime&&(n.baseState=r)}var Ni={isMounted:function(e){return!!(e=e._reactInternalFiber)&&2===tr(e)},enqueueSetState:function(e,t,r){e=e._reactInternalFiber;var n=Sa(),i=ti(n=Ko(n,e));i.payload=t,void 0!==r&&null!==r&&(i.callback=r),$o(),ni(e,i),Jo(e,n)},enqueueReplaceState:function(e,t,r){e=e._reactInternalFiber;var n=Sa(),i=ti(n=Ko(n,e));i.tag=1,i.payload=t,void 0!==r&&null!==r&&(i.callback=r),$o(),ni(e,i),Jo(e,n)},enqueueForceUpdate:function(e,t){e=e._reactInternalFiber;var r=Sa(),n=ti(r=Ko(r,e));n.tag=2,void 0!==t&&null!==t&&(n.callback=t),$o(),ni(e,n),Jo(e,r)}};function Di(e,t,r,n,i,o,a){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(n,o,a):!t.prototype||!t.prototype.isPureReactComponent||(!er(r,n)||!er(i,o))}function ki(e,t,r){var n=!1,i=Mn,o=t.contextType;return"object"==typeof o&&null!==o?o=Pi.currentDispatcher.readContext(o):(i=Rn(t)?En:Tn.current,o=(n=null!==(n=t.contextTypes)&&void 0!==n)?Pn(e,i):Mn),t=new t(r,o),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=Ni,e.stateNode=t,t._reactInternalFiber=e,n&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=i,e.__reactInternalMemoizedMaskedChildContext=o),t}function Oi(e,t,r,n){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(r,n),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(r,n),t.state!==e&&Ni.enqueueReplaceState(t,t.state,null)}function Fi(e,t,r,n){var i=e.stateNode;i.props=r,i.state=e.memoizedState,i.refs=Ri;var o=t.contextType;"object"==typeof o&&null!==o?i.context=Pi.currentDispatcher.readContext(o):(o=Rn(t)?En:Tn.current,i.context=Pn(e,o)),null!==(o=e.updateQueue)&&(si(e,o,r,i,n),i.state=e.memoizedState),"function"==typeof(o=t.getDerivedStateFromProps)&&(Ii(e,t,o,r),i.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof i.getSnapshotBeforeUpdate||"function"!=typeof i.UNSAFE_componentWillMount&&"function"!=typeof i.componentWillMount||(t=i.state,"function"==typeof i.componentWillMount&&i.componentWillMount(),"function"==typeof i.UNSAFE_componentWillMount&&i.UNSAFE_componentWillMount(),t!==i.state&&Ni.enqueueReplaceState(i,i.state,null),null!==(o=e.updateQueue)&&(si(e,o,r,i,n),i.state=e.memoizedState)),"function"==typeof i.componentDidMount&&(e.effectTag|=4)}var Li=Array.isArray;function Ui(e,t,r){if(null!==(e=r.ref)&&"function"!=typeof e&&"object"!=typeof e){if(r._owner){var n=void 0;(r=r._owner)&&(1!==r.tag&&a("289"),n=r.stateNode),n||a("147",e);var i=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===i?t.ref:((t=function(e){var t=n.refs;t===Ri&&(t=n.refs={}),null===e?delete t[i]:t[i]=e})._stringRef=i,t)}"string"!=typeof e&&a("284"),r._owner||a("290",e)}return e}function Vi(e,t){"textarea"!==e.type&&a("31","[object Object]"===Object.prototype.toString.call(t)?"object with keys {"+Object.keys(t).join(", ")+"}":t,"")}function Bi(e){function t(t,r){if(e){var n=t.lastEffect;null!==n?(n.nextEffect=r,t.lastEffect=r):t.firstEffect=t.lastEffect=r,r.nextEffect=null,r.effectTag=8}}function r(r,n){if(!e)return null;for(;null!==n;)t(r,n),n=n.sibling;return null}function n(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function i(e,t,r){return(e=jn(e,t)).index=0,e.sibling=null,e}function o(t,r,n){return t.index=n,e?null!==(n=t.alternate)?(n=n.index)<r?(t.effectTag=2,r):n:(t.effectTag=2,r):r}function s(t){return e&&null===t.alternate&&(t.effectTag=2),t}function l(e,t,r,n){return null===t||6!==t.tag?((t=Wn(r,e.mode,n)).return=e,t):((t=i(t,r)).return=e,t)}function u(e,t,r,n){return null!==t&&t.elementType===r.type?((n=i(t,r.props)).ref=Ui(e,t,r),n.return=e,n):((n=Hn(r.type,r.key,r.props,null,e.mode,n)).ref=Ui(e,t,r),n.return=e,n)}function c(e,t,r,n){return null===t||4!==t.tag||t.stateNode.containerInfo!==r.containerInfo||t.stateNode.implementation!==r.implementation?((t=qn(r,e.mode,n)).return=e,t):((t=i(t,r.children||[])).return=e,t)}function h(e,t,r,n,o){return null===t||7!==t.tag?((t=$n(r,e.mode,n,o)).return=e,t):((t=i(t,r)).return=e,t)}function p(e,t,r){if("string"==typeof t||"number"==typeof t)return(t=Wn(""+t,e.mode,r)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case qe:return(r=Hn(t.type,t.key,t.props,null,e.mode,r)).ref=Ui(e,null,t),r.return=e,r;case Xe:return(t=qn(t,e.mode,r)).return=e,t}if(Li(t)||at(t))return(t=$n(t,e.mode,r,null)).return=e,t;Vi(e,t)}return null}function d(e,t,r,n){var i=null!==t?t.key:null;if("string"==typeof r||"number"==typeof r)return null!==i?null:l(e,t,""+r,n);if("object"==typeof r&&null!==r){switch(r.$$typeof){case qe:return r.key===i?r.type===Ke?h(e,t,r.props.children,n,i):u(e,t,r,n):null;case Xe:return r.key===i?c(e,t,r,n):null}if(Li(r)||at(r))return null!==i?null:h(e,t,r,n,null);Vi(e,r)}return null}function f(e,t,r,n,i){if("string"==typeof n||"number"==typeof n)return l(t,e=e.get(r)||null,""+n,i);if("object"==typeof n&&null!==n){switch(n.$$typeof){case qe:return e=e.get(null===n.key?r:n.key)||null,n.type===Ke?h(t,e,n.props.children,i,n.key):u(t,e,n,i);case Xe:return c(t,e=e.get(null===n.key?r:n.key)||null,n,i)}if(Li(n)||at(n))return h(t,e=e.get(r)||null,n,i,null);Vi(t,n)}return null}function m(i,a,s,l){for(var u=null,c=null,h=a,m=a=0,g=null;null!==h&&m<s.length;m++){h.index>m?(g=h,h=null):g=h.sibling;var v=d(i,h,s[m],l);if(null===v){null===h&&(h=g);break}e&&h&&null===v.alternate&&t(i,h),a=o(v,a,m),null===c?u=v:c.sibling=v,c=v,h=g}if(m===s.length)return r(i,h),u;if(null===h){for(;m<s.length;m++)(h=p(i,s[m],l))&&(a=o(h,a,m),null===c?u=h:c.sibling=h,c=h);return u}for(h=n(i,h);m<s.length;m++)(g=f(h,i,m,s[m],l))&&(e&&null!==g.alternate&&h.delete(null===g.key?m:g.key),a=o(g,a,m),null===c?u=g:c.sibling=g,c=g);return e&&h.forEach(function(e){return t(i,e)}),u}function g(i,s,l,u){var c=at(l);"function"!=typeof c&&a("150"),null==(l=c.call(l))&&a("151");for(var h=c=null,m=s,g=s=0,v=null,y=l.next();null!==m&&!y.done;g++,y=l.next()){m.index>g?(v=m,m=null):v=m.sibling;var b=d(i,m,y.value,u);if(null===b){m||(m=v);break}e&&m&&null===b.alternate&&t(i,m),s=o(b,s,g),null===h?c=b:h.sibling=b,h=b,m=v}if(y.done)return r(i,m),c;if(null===m){for(;!y.done;g++,y=l.next())null!==(y=p(i,y.value,u))&&(s=o(y,s,g),null===h?c=y:h.sibling=y,h=y);return c}for(m=n(i,m);!y.done;g++,y=l.next())null!==(y=f(m,i,g,y.value,u))&&(e&&null!==y.alternate&&m.delete(null===y.key?g:y.key),s=o(y,s,g),null===h?c=y:h.sibling=y,h=y);return e&&m.forEach(function(e){return t(i,e)}),c}return function(e,n,o,l){var u="object"==typeof o&&null!==o&&o.type===Ke&&null===o.key;u&&(o=o.props.children);var c="object"==typeof o&&null!==o;if(c)switch(o.$$typeof){case qe:e:{for(c=o.key,u=n;null!==u;){if(u.key===c){if(7===u.tag?o.type===Ke:u.elementType===o.type){r(e,u.sibling),(n=i(u,o.type===Ke?o.props.children:o.props)).ref=Ui(e,u,o),n.return=e,e=n;break e}r(e,u);break}t(e,u),u=u.sibling}o.type===Ke?((n=$n(o.props.children,e.mode,l,o.key)).return=e,e=n):((l=Hn(o.type,o.key,o.props,null,e.mode,l)).ref=Ui(e,n,o),l.return=e,e=l)}return s(e);case Xe:e:{for(u=o.key;null!==n;){if(n.key===u){if(4===n.tag&&n.stateNode.containerInfo===o.containerInfo&&n.stateNode.implementation===o.implementation){r(e,n.sibling),(n=i(n,o.children||[])).return=e,e=n;break e}r(e,n);break}t(e,n),n=n.sibling}(n=qn(o,e.mode,l)).return=e,e=n}return s(e)}if("string"==typeof o||"number"==typeof o)return o=""+o,null!==n&&6===n.tag?(r(e,n.sibling),(n=i(n,o)).return=e,e=n):(r(e,n),(n=Wn(o,e.mode,l)).return=e,e=n),s(e);if(Li(o))return m(e,n,o,l);if(at(o))return g(e,n,o,l);if(c&&Vi(e,o),void 0===o&&!u)switch(e.tag){case 1:case 0:a("152",(l=e.type).displayName||l.name||"Component")}return r(e,n)}}var zi=Bi(!0),ji=Bi(!1),Hi=null,$i=null,Gi=!1;function Wi(e,t){var r=Bn(5,null,null,0);r.elementType="DELETED",r.type="DELETED",r.stateNode=t,r.return=e,r.effectTag=8,null!==e.lastEffect?(e.lastEffect.nextEffect=r,e.lastEffect=r):e.firstEffect=e.lastEffect=r}function qi(e,t){switch(e.tag){case 5:var r=e.type;return null!==(t=1!==t.nodeType||r.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,!0);default:return!1}}function Xi(e){if(Gi){var t=$i;if(t){var r=t;if(!qi(e,t)){if(!(t=bn(r))||!qi(e,t))return e.effectTag|=2,Gi=!1,void(Hi=e);Wi(Hi,r)}Hi=e,$i=wn(t)}else e.effectTag|=2,Gi=!1,Hi=e}}function Ki(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag;)e=e.return;Hi=e}function Yi(e){if(e!==Hi)return!1;if(!Gi)return Ki(e),Gi=!0,!1;var t=e.type;if(5!==e.tag||"head"!==t&&"body"!==t&&!gn(t,e.memoizedProps))for(t=$i;t;)Wi(e,t),t=bn(t);return Ki(e),$i=Hi?bn(e.stateNode):null,!0}function Zi(){$i=Hi=null,Gi=!1}var Ji=$e.ReactCurrentOwner;function Qi(e,t,r,n){t.child=null===e?ji(t,null,r,n):zi(t,e.child,r,n)}function eo(e,t,r,n,i){r=r.render;var o=t.ref;return vi(t),n=r(n,o),t.effectTag|=1,Qi(e,t,n,i),t.child}function to(e,t,r,n,i,o){if(null===e){var a=r.type;return"function"!=typeof a||zn(a)||void 0!==a.defaultProps||null!==r.compare?((e=Hn(r.type,null,n,null,t.mode,o)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=a,ro(e,t,a,n,i,o))}return a=e.child,i<o&&(i=a.memoizedProps,(r=null!==(r=r.compare)?r:er)(i,n)&&e.ref===t.ref)?co(e,t,o):((e=jn(a,n)).ref=t.ref,e.return=t,t.child=e)}function ro(e,t,r,n,i,o){return null!==e&&i<o&&er(e.memoizedProps,n)&&e.ref===t.ref?co(e,t,o):io(e,t,r,n,o)}function no(e,t){var r=t.ref;(null===e&&null!==r||null!==e&&e.ref!==r)&&(t.effectTag|=128)}function io(e,t,r,n,i){var o=Rn(r)?En:Tn.current;return o=Pn(t,o),vi(t),r=r(n,o),t.effectTag|=1,Qi(e,t,r,i),t.child}function oo(e,t,r,n,i){if(Rn(r)){var o=!0;On(t)}else o=!1;if(vi(t),null===t.stateNode)null!==e&&(e.alternate=null,t.alternate=null,t.effectTag|=2),ki(t,r,n),Fi(t,r,n,i),n=!0;else if(null===e){var a=t.stateNode,s=t.memoizedProps;a.props=s;var l=a.context,u=r.contextType;"object"==typeof u&&null!==u?u=Pi.currentDispatcher.readContext(u):u=Pn(t,u=Rn(r)?En:Tn.current);var c=r.getDerivedStateFromProps,h="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;h||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(s!==n||l!==u)&&Oi(t,a,n,u),Jn=!1;var p=t.memoizedState;l=a.state=p;var d=t.updateQueue;null!==d&&(si(t,d,n,a,i),l=t.memoizedState),s!==n||p!==l||An.current||Jn?("function"==typeof c&&(Ii(t,r,c,n),l=t.memoizedState),(s=Jn||Di(t,r,s,n,p,l,u))?(h||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(t.effectTag|=4)):("function"==typeof a.componentDidMount&&(t.effectTag|=4),t.memoizedProps=n,t.memoizedState=l),a.props=n,a.state=l,a.context=u,n=s):("function"==typeof a.componentDidMount&&(t.effectTag|=4),n=!1)}else a=t.stateNode,s=t.memoizedProps,a.props=t.type===t.elementType?s:Ei(t.type,s),l=a.context,"object"==typeof(u=r.contextType)&&null!==u?u=Pi.currentDispatcher.readContext(u):u=Pn(t,u=Rn(r)?En:Tn.current),(h="function"==typeof(c=r.getDerivedStateFromProps)||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(s!==n||l!==u)&&Oi(t,a,n,u),Jn=!1,l=t.memoizedState,p=a.state=l,null!==(d=t.updateQueue)&&(si(t,d,n,a,i),p=t.memoizedState),s!==n||l!==p||An.current||Jn?("function"==typeof c&&(Ii(t,r,c,n),p=t.memoizedState),(c=Jn||Di(t,r,s,n,l,p,u))?(h||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(n,p,u),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(n,p,u)),"function"==typeof a.componentDidUpdate&&(t.effectTag|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(t.effectTag|=256)):("function"!=typeof a.componentDidUpdate||s===e.memoizedProps&&l===e.memoizedState||(t.effectTag|=4),"function"!=typeof a.getSnapshotBeforeUpdate||s===e.memoizedProps&&l===e.memoizedState||(t.effectTag|=256),t.memoizedProps=n,t.memoizedState=p),a.props=n,a.state=p,a.context=u,n=c):("function"!=typeof a.componentDidUpdate||s===e.memoizedProps&&l===e.memoizedState||(t.effectTag|=4),"function"!=typeof a.getSnapshotBeforeUpdate||s===e.memoizedProps&&l===e.memoizedState||(t.effectTag|=256),n=!1);return ao(e,t,r,n,o,i)}function ao(e,t,r,n,i,o){no(e,t);var a=0!=(64&t.effectTag);if(!n&&!a)return i&&Fn(t,r,!1),co(e,t,o);n=t.stateNode,Ji.current=t;var s=a&&"function"!=typeof r.getDerivedStateFromError?null:n.render();return t.effectTag|=1,null!==e&&a?(t.child=zi(t,e.child,null,o),t.child=zi(t,null,s,o)):Qi(e,t,s,o),t.memoizedState=n.state,i&&Fn(t,r,!0),t.child}function so(e){var t=e.stateNode;t.pendingContext?Dn(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Dn(0,t.context,!1),Ci(e,t.containerInfo)}function lo(e,t,r){var n=t.mode,i=t.pendingProps,o=t.memoizedState;if(0==(64&t.effectTag)){o=null;var a=!1}else o={timedOutAt:null!==o?o.timedOutAt:0},a=!0,t.effectTag&=-65;return null===e?a?(a=i.fallback,i=$n(null,n,0,null),0==(1&t.mode)&&uo(t,i,null!==t.memoizedState?t.child.child:t.child),n=$n(a,n,r,null),i.sibling=n,(r=i).return=n.return=t):r=n=ji(t,null,i.children,r):null!==e.memoizedState?(e=(n=e.child).sibling,a?(r=i.fallback,(i=jn(n,n.pendingProps)).effectTag|=2,0==(1&t.mode)&&((a=null!==t.memoizedState?t.child.child:t.child)!==n.child&&uo(t,i,a)),(n=i.sibling=jn(e,r,e.expirationTime)).effectTag|=2,r=i,i.childExpirationTime=0,r.return=n.return=t):(a=e.child,n=zi(t,n.child,i.children,r),zi(t,a,null,r),r=n)):(e=e.child,a?(a=i.fallback,(i=$n(null,n,0,null)).effectTag|=2,i.child=e,e.return=i,0==(1&t.mode)&&uo(t,i,null!==t.memoizedState?t.child.child:t.child),(n=i.sibling=$n(a,n,r,null)).effectTag|=2,r=i,i.childExpirationTime=0,r.return=n.return=t):n=r=zi(t,e,i.children,r)),t.memoizedState=o,t.child=r,n}function uo(e,t,r){for(r=t.child=r;null!==r;)null===t.firstEffect&&(t.firstEffect=r.firstEffect),null!==r.lastEffect&&(null!==t.lastEffect&&(t.lastEffect.nextEffect=r.firstEffect),t.lastEffect=r.lastEffect),1<r.effectTag&&(null!==t.lastEffect?t.lastEffect.nextEffect=r:t.firstEffect=r,t.lastEffect=r),r.return=t,r=r.sibling;e.firstEffect=t.firstEffect,e.lastEffect=t.lastEffect}function co(e,t,r){if(null!==e&&(t.firstContextDependency=e.firstContextDependency),t.childExpirationTime<r)return null;if(null!==e&&t.child!==e.child&&a("153"),null!==t.child){for(r=jn(e=t.child,e.pendingProps,e.expirationTime),t.child=r,r.return=t;null!==e.sibling;)e=e.sibling,(r=r.sibling=jn(e,e.pendingProps,e.expirationTime)).return=t;r.sibling=null}return t.child}function ho(e,t,r){var n=t.expirationTime;if(null!==e&&e.memoizedProps===t.pendingProps&&!An.current&&n<r){switch(t.tag){case 3:so(t),Zi();break;case 5:Ti(t);break;case 1:Rn(t.type)&&On(t);break;case 4:Ci(t,t.stateNode.containerInfo);break;case 10:mi(t,t.memoizedProps.value);break;case 13:if(null!==t.memoizedState)return 0!==(n=t.child.childExpirationTime)&&n>=r?lo(e,t,r):null!==(t=co(e,t,r))?t.sibling:null}return co(e,t,r)}switch(t.expirationTime=0,t.tag){case 2:n=t.elementType,null!==e&&(e.alternate=null,t.alternate=null,t.effectTag|=2),e=t.pendingProps;var i=Pn(t,Tn.current);if(vi(t),i=n(e,i),t.effectTag|=1,"object"==typeof i&&null!==i&&"function"==typeof i.render&&void 0===i.$$typeof){if(t.tag=1,Rn(n)){var o=!0;On(t)}else o=!1;t.memoizedState=null!==i.state&&void 0!==i.state?i.state:null;var s=n.getDerivedStateFromProps;"function"==typeof s&&Ii(t,n,s,e),i.updater=Ni,t.stateNode=i,i._reactInternalFiber=t,Fi(t,n,e,r),t=ao(null,t,n,!0,o,r)}else t.tag=0,Qi(null,t,i,r),t=t.child;return t;case 16:switch(i=t.elementType,null!==e&&(e.alternate=null,t.alternate=null,t.effectTag|=2),o=t.pendingProps,e=function(e){var t=e._result;switch(e._status){case 1:return t;case 2:case 0:throw t;default:throw e._status=0,(t=(t=e._ctor)()).then(function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)},function(t){0===e._status&&(e._status=2,e._result=t)}),e._result=t,t}}(i),t.type=e,i=t.tag=function(e){if("function"==typeof e)return zn(e)?1:0;if(void 0!==e&&null!==e){if((e=e.$$typeof)===tt)return 11;if(e===nt)return 14}return 2}(e),o=Ei(e,o),s=void 0,i){case 0:s=io(null,t,e,o,r);break;case 1:s=oo(null,t,e,o,r);break;case 11:s=eo(null,t,e,o,r);break;case 14:s=to(null,t,e,Ei(e.type,o),n,r);break;default:a("283",e)}return s;case 0:return n=t.type,i=t.pendingProps,io(e,t,n,i=t.elementType===n?i:Ei(n,i),r);case 1:return n=t.type,i=t.pendingProps,oo(e,t,n,i=t.elementType===n?i:Ei(n,i),r);case 3:return so(t),null===(n=t.updateQueue)&&a("282"),i=null!==(i=t.memoizedState)?i.element:null,si(t,n,t.pendingProps,null,r),(n=t.memoizedState.element)===i?(Zi(),t=co(e,t,r)):(i=t.stateNode,(i=(null===e||null===e.child)&&i.hydrate)&&($i=wn(t.stateNode.containerInfo),Hi=t,i=Gi=!0),i?(t.effectTag|=2,t.child=ji(t,null,n,r)):(Qi(e,t,n,r),Zi()),t=t.child),t;case 5:return Ti(t),null===e&&Xi(t),n=t.type,i=t.pendingProps,o=null!==e?e.memoizedProps:null,s=i.children,gn(n,i)?s=null:null!==o&&gn(n,o)&&(t.effectTag|=16),no(e,t),1!==r&&1&t.mode&&i.hidden?(t.expirationTime=1,t=null):(Qi(e,t,s,r),t=t.child),t;case 6:return null===e&&Xi(t),null;case 13:return lo(e,t,r);case 4:return Ci(t,t.stateNode.containerInfo),n=t.pendingProps,null===e?t.child=zi(t,null,n,r):Qi(e,t,n,r),t.child;case 11:return n=t.type,i=t.pendingProps,eo(e,t,n,i=t.elementType===n?i:Ei(n,i),r);case 7:return Qi(e,t,t.pendingProps,r),t.child;case 8:case 12:return Qi(e,t,t.pendingProps.children,r),t.child;case 10:e:{if(n=t.type._context,i=t.pendingProps,s=t.memoizedProps,mi(t,o=i.value),null!==s){var l=s.value;if(0===(o=l===o&&(0!==l||1/l==1/o)||l!=l&&o!=o?0:0|("function"==typeof n._calculateChangedBits?n._calculateChangedBits(l,o):1073741823))){if(s.children===i.children&&!An.current){t=co(e,t,r);break e}}else for(null!==(s=t.child)&&(s.return=t);null!==s;){if(null!==(l=s.firstContextDependency))do{if(l.context===n&&0!=(l.observedBits&o)){if(1===s.tag){var u=ti(r);u.tag=2,ni(s,u)}s.expirationTime<r&&(s.expirationTime=r),null!==(u=s.alternate)&&u.expirationTime<r&&(u.expirationTime=r);for(var c=s.return;null!==c;){if(u=c.alternate,c.childExpirationTime<r)c.childExpirationTime=r,null!==u&&u.childExpirationTime<r&&(u.childExpirationTime=r);else{if(!(null!==u&&u.childExpirationTime<r))break;u.childExpirationTime=r}c=c.return}}u=s.child,l=l.next}while(null!==l);else u=10===s.tag&&s.type===t.type?null:s.child;if(null!==u)u.return=s;else for(u=s;null!==u;){if(u===t){u=null;break}if(null!==(s=u.sibling)){s.return=u.return,u=s;break}u=u.return}s=u}}Qi(e,t,i.children,r),t=t.child}return t;case 9:return i=t.type,n=(o=t.pendingProps).children,vi(t),n=n(i=yi(i,o.unstable_observedBits)),t.effectTag|=1,Qi(e,t,n,r),t.child;case 14:return to(e,t,i=t.type,o=Ei(i.type,t.pendingProps),n,r);case 15:return ro(e,t,t.type,t.pendingProps,n,r);case 17:return n=t.type,i=t.pendingProps,i=t.elementType===n?i:Ei(n,i),null!==e&&(e.alternate=null,t.alternate=null,t.effectTag|=2),t.tag=1,Rn(n)?(e=!0,On(t)):e=!1,vi(t),ki(t,n,i),Fi(t,n,i,r),ao(null,t,n,!0,e,r);default:a("156")}}function po(e){e.effectTag|=4}var fo=void 0,mo=void 0,go=void 0,vo=void 0;function yo(e,t){var r=t.source,n=t.stack;null===n&&null!==r&&(n=lt(r)),null!==r&&st(r.type),t=t.value,null!==e&&1===e.tag&&st(e.type);try{console.error(t)}catch(e){setTimeout(function(){throw e})}}function bo(e){var t=e.ref;if(null!==t)if("function"==typeof t)try{t(null)}catch(t){Xo(e,t)}else t.current=null}function wo(e){switch("function"==typeof Un&&Un(e),e.tag){case 0:case 11:case 14:case 15:var t=e.updateQueue;if(null!==t&&null!==(t=t.lastEffect)){var r=t=t.next;do{var n=r.destroy;if(null!==n){var i=e;try{n()}catch(e){Xo(i,e)}}r=r.next}while(r!==t)}break;case 1:if(bo(e),"function"==typeof(t=e.stateNode).componentWillUnmount)try{t.props=e.memoizedProps,t.state=e.memoizedState,t.componentWillUnmount()}catch(t){Xo(e,t)}break;case 5:bo(e);break;case 4:So(e)}}function xo(e){return 5===e.tag||3===e.tag||4===e.tag}function _o(e){e:{for(var t=e.return;null!==t;){if(xo(t)){var r=t;break e}t=t.return}a("160"),r=void 0}var n=t=void 0;switch(r.tag){case 5:t=r.stateNode,n=!1;break;case 3:case 4:t=r.stateNode.containerInfo,n=!0;break;default:a("161")}16&r.effectTag&&(rn(t,""),r.effectTag&=-17);e:t:for(r=e;;){for(;null===r.sibling;){if(null===r.return||xo(r.return)){r=null;break e}r=r.return}for(r.sibling.return=r.return,r=r.sibling;5!==r.tag&&6!==r.tag;){if(2&r.effectTag)continue t;if(null===r.child||4===r.tag)continue t;r.child.return=r,r=r.child}if(!(2&r.effectTag)){r=r.stateNode;break e}}for(var i=e;;){if(5===i.tag||6===i.tag)if(r)if(n){var o=t,s=i.stateNode,l=r;8===o.nodeType?o.parentNode.insertBefore(s,l):o.insertBefore(s,l)}else t.insertBefore(i.stateNode,r);else n?(s=t,l=i.stateNode,8===s.nodeType?(o=s.parentNode).insertBefore(l,s):(o=s).appendChild(l),null!==(s=s._reactRootContainer)&&void 0!==s||null!==o.onclick||(o.onclick=pn)):t.appendChild(i.stateNode);else if(4!==i.tag&&null!==i.child){i.child.return=i,i=i.child;continue}if(i===e)break;for(;null===i.sibling;){if(null===i.return||i.return===e)return;i=i.return}i.sibling.return=i.return,i=i.sibling}}function So(e){for(var t=e,r=!1,n=void 0,i=void 0;;){if(!r){r=t.return;e:for(;;){switch(null===r&&a("160"),r.tag){case 5:n=r.stateNode,i=!1;break e;case 3:case 4:n=r.stateNode.containerInfo,i=!0;break e}r=r.return}r=!0}if(5===t.tag||6===t.tag){e:for(var o=t,s=o;;)if(wo(s),null!==s.child&&4!==s.tag)s.child.return=s,s=s.child;else{if(s===o)break;for(;null===s.sibling;){if(null===s.return||s.return===o)break e;s=s.return}s.sibling.return=s.return,s=s.sibling}i?(o=n,s=t.stateNode,8===o.nodeType?o.parentNode.removeChild(s):o.removeChild(s)):n.removeChild(t.stateNode)}else if(4===t.tag?(n=t.stateNode.containerInfo,i=!0):wo(t),null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return;4===(t=t.return).tag&&(r=!1)}t.sibling.return=t.return,t=t.sibling}}function Co(e,t){switch(t.tag){case 0:case 11:case 14:case 15:case 1:break;case 5:var r=t.stateNode;if(null!=r){var n=t.memoizedProps,i=null!==e?e.memoizedProps:n;e=t.type;var o=t.updateQueue;if(t.updateQueue=null,null!==o){for(r[k]=n,"input"===e&&"radio"===n.type&&null!=n.name&&xt(r,n),cn(e,i),t=cn(e,n),i=0;i<o.length;i+=2){var s=o[i],l=o[i+1];"style"===s?sn(r,l):"dangerouslySetInnerHTML"===s?tn(r,l):"children"===s?rn(r,l):vt(r,s,l,t)}switch(e){case"input":_t(r,n);break;case"textarea":Kr(r,n);break;case"select":t=r._wrapperState.wasMultiple,r._wrapperState.wasMultiple=!!n.multiple,null!=(e=n.value)?Wr(r,!!n.multiple,e,!1):t!==!!n.multiple&&(null!=n.defaultValue?Wr(r,!!n.multiple,n.defaultValue,!0):Wr(r,!!n.multiple,n.multiple?[]:"",!1))}}}break;case 6:null===t.stateNode&&a("162"),t.stateNode.nodeValue=t.memoizedProps;break;case 3:case 12:break;case 13:if(e=t,null===(r=t.memoizedState)?n=!1:(n=!0,e=t.child,0===r.timedOutAt&&(r.timedOutAt=Sa())),null!==e)e:for(t=r=e;;){if(5===t.tag)e=t.stateNode,n?e.style.display="none":(e=t.stateNode,o=void 0!==(o=t.memoizedProps.style)&&null!==o&&o.hasOwnProperty("display")?o.display:null,e.style.display=an("display",o));else if(6===t.tag)t.stateNode.nodeValue=n?"":t.memoizedProps;else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===r)break e;for(;null===t.sibling;){if(null===t.return||t.return===r)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}break;case 17:break;default:a("163")}}function Mo(e,t,r){(r=ti(r)).tag=3,r.payload={element:null};var n=t.value;return r.callback=function(){Da(n),yo(e,t)},r}function To(e,t,r){(r=ti(r)).tag=3;var n=e.type.getDerivedStateFromError;if("function"==typeof n){var i=t.value;r.payload=function(){return n(i)}}var o=e.stateNode;return null!==o&&"function"==typeof o.componentDidCatch&&(r.callback=function(){"function"!=typeof n&&(null===jo?jo=new Set([this]):jo.add(this));var r=t.value,i=t.stack;yo(e,t),this.componentDidCatch(r,{componentStack:null!==i?i:""})}),r}function Ao(e){switch(e.tag){case 1:Rn(e.type)&&In();var t=e.effectTag;return 2048&t?(e.effectTag=-2049&t|64,e):null;case 3:return Mi(),Nn(),0!=(64&(t=e.effectTag))&&a("285"),e.effectTag=-2049&t|64,e;case 5:return Ai(e),null;case 13:return 2048&(t=e.effectTag)?(e.effectTag=-2049&t|64,e):null;case 4:return Mi(),null;case 10:return gi(e),null;default:return null}}fo=function(e,t){for(var r=t.child;null!==r;){if(5===r.tag||6===r.tag)e.appendChild(r.stateNode);else if(4!==r.tag&&null!==r.child){r.child.return=r,r=r.child;continue}if(r===t)break;for(;null===r.sibling;){if(null===r.return||r.return===t)return;r=r.return}r.sibling.return=r.return,r=r.sibling}},mo=function(){},go=function(e,t,r,n,o){var a=e.memoizedProps;if(a!==n){var s=t.stateNode;switch(Si(wi.current),e=null,r){case"input":a=bt(s,a),n=bt(s,n),e=[];break;case"option":a=Gr(s,a),n=Gr(s,n),e=[];break;case"select":a=i({},a,{value:void 0}),n=i({},n,{value:void 0}),e=[];break;case"textarea":a=qr(s,a),n=qr(s,n),e=[];break;default:"function"!=typeof a.onClick&&"function"==typeof n.onClick&&(s.onclick=pn)}un(r,n),s=r=void 0;var l=null;for(r in a)if(!n.hasOwnProperty(r)&&a.hasOwnProperty(r)&&null!=a[r])if("style"===r){var u=a[r];for(s in u)u.hasOwnProperty(s)&&(l||(l={}),l[s]="")}else"dangerouslySetInnerHTML"!==r&&"children"!==r&&"suppressContentEditableWarning"!==r&&"suppressHydrationWarning"!==r&&"autoFocus"!==r&&(b.hasOwnProperty(r)?e||(e=[]):(e=e||[]).push(r,null));for(r in n){var c=n[r];if(u=null!=a?a[r]:void 0,n.hasOwnProperty(r)&&c!==u&&(null!=c||null!=u))if("style"===r)if(u){for(s in u)!u.hasOwnProperty(s)||c&&c.hasOwnProperty(s)||(l||(l={}),l[s]="");for(s in c)c.hasOwnProperty(s)&&u[s]!==c[s]&&(l||(l={}),l[s]=c[s])}else l||(e||(e=[]),e.push(r,l)),l=c;else"dangerouslySetInnerHTML"===r?(c=c?c.__html:void 0,u=u?u.__html:void 0,null!=c&&u!==c&&(e=e||[]).push(r,""+c)):"children"===r?u===c||"string"!=typeof c&&"number"!=typeof c||(e=e||[]).push(r,""+c):"suppressContentEditableWarning"!==r&&"suppressHydrationWarning"!==r&&(b.hasOwnProperty(r)?(null!=c&&hn(o,r),e||u===c||(e=[])):(e=e||[]).push(r,c))}l&&(e=e||[]).push("style",l),o=e,(t.updateQueue=o)&&po(t)}},vo=function(e,t,r,n){r!==n&&po(t)};var Eo={readContext:yi},Po=$e.ReactCurrentOwner,Ro=1073741822,Io=0,No=!1,Do=null,ko=null,Oo=0,Fo=-1,Lo=!1,Uo=null,Vo=!1,Bo=null,zo=null,jo=null;function Ho(){if(null!==Do)for(var e=Do.return;null!==e;){var t=e;switch(t.tag){case 1:var r=t.type.childContextTypes;null!==r&&void 0!==r&&In();break;case 3:Mi(),Nn();break;case 5:Ai(t);break;case 4:Mi();break;case 10:gi(t)}e=e.return}ko=null,Oo=0,Fo=-1,Lo=!1,Do=null}function $o(){null!==zo&&(o.unstable_cancelCallback(Bo),zo())}function Go(e){for(;;){var t=e.alternate,r=e.return,n=e.sibling;if(0==(1024&e.effectTag)){Do=e;e:{var o=t,s=Oo,l=(t=e).pendingProps;switch(t.tag){case 2:case 16:break;case 15:case 0:break;case 1:Rn(t.type)&&In();break;case 3:Mi(),Nn(),(l=t.stateNode).pendingContext&&(l.context=l.pendingContext,l.pendingContext=null),null!==o&&null!==o.child||(Yi(t),t.effectTag&=-3),mo(t);break;case 5:Ai(t);var u=Si(_i.current);if(s=t.type,null!==o&&null!=t.stateNode)go(o,t,s,l,u),o.ref!==t.ref&&(t.effectTag|=128);else if(l){var c=Si(wi.current);if(Yi(t)){o=(l=t).stateNode;var h=l.type,p=l.memoizedProps,d=u;switch(o[D]=l,o[k]=p,s=void 0,u=h){case"iframe":case"object":Cr("load",o);break;case"video":case"audio":for(h=0;h<te.length;h++)Cr(te[h],o);break;case"source":Cr("error",o);break;case"img":case"image":case"link":Cr("error",o),Cr("load",o);break;case"form":Cr("reset",o),Cr("submit",o);break;case"details":Cr("toggle",o);break;case"input":wt(o,p),Cr("invalid",o),hn(d,"onChange");break;case"select":o._wrapperState={wasMultiple:!!p.multiple},Cr("invalid",o),hn(d,"onChange");break;case"textarea":Xr(o,p),Cr("invalid",o),hn(d,"onChange")}for(s in un(u,p),h=null,p)p.hasOwnProperty(s)&&(c=p[s],"children"===s?"string"==typeof c?o.textContent!==c&&(h=["children",c]):"number"==typeof c&&o.textContent!==""+c&&(h=["children",""+c]):b.hasOwnProperty(s)&&null!=c&&hn(d,s));switch(u){case"input":je(o),St(o,p,!0);break;case"textarea":je(o),Yr(o);break;case"select":case"option":break;default:"function"==typeof p.onClick&&(o.onclick=pn)}s=h,l.updateQueue=s,(l=null!==s)&&po(t)}else{p=t,o=s,d=l,h=9===u.nodeType?u:u.ownerDocument,c===Zr.html&&(c=Jr(o)),c===Zr.html?"script"===o?((o=h.createElement("div")).innerHTML="<script><\/script>",h=o.removeChild(o.firstChild)):"string"==typeof d.is?h=h.createElement(o,{is:d.is}):(h=h.createElement(o),"select"===o&&d.multiple&&(h.multiple=!0)):h=h.createElementNS(c,o),(o=h)[D]=p,o[k]=l,fo(o,t,!1,!1),d=o;var f=u,m=cn(h=s,p=l);switch(h){case"iframe":case"object":Cr("load",d),u=p;break;case"video":case"audio":for(u=0;u<te.length;u++)Cr(te[u],d);u=p;break;case"source":Cr("error",d),u=p;break;case"img":case"image":case"link":Cr("error",d),Cr("load",d),u=p;break;case"form":Cr("reset",d),Cr("submit",d),u=p;break;case"details":Cr("toggle",d),u=p;break;case"input":wt(d,p),u=bt(d,p),Cr("invalid",d),hn(f,"onChange");break;case"option":u=Gr(d,p);break;case"select":d._wrapperState={wasMultiple:!!p.multiple},u=i({},p,{value:void 0}),Cr("invalid",d),hn(f,"onChange");break;case"textarea":Xr(d,p),u=qr(d,p),Cr("invalid",d),hn(f,"onChange");break;default:u=p}un(h,u),c=void 0;var g=h,v=d,y=u;for(c in y)if(y.hasOwnProperty(c)){var w=y[c];"style"===c?sn(v,w):"dangerouslySetInnerHTML"===c?null!=(w=w?w.__html:void 0)&&tn(v,w):"children"===c?"string"==typeof w?("textarea"!==g||""!==w)&&rn(v,w):"number"==typeof w&&rn(v,""+w):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(b.hasOwnProperty(c)?null!=w&&hn(f,c):null!=w&&vt(v,c,w,m))}switch(h){case"input":je(d),St(d,p,!1);break;case"textarea":je(d),Yr(d);break;case"option":null!=p.value&&d.setAttribute("value",""+yt(p.value));break;case"select":(u=d).multiple=!!p.multiple,null!=(d=p.value)?Wr(u,!!p.multiple,d,!1):null!=p.defaultValue&&Wr(u,!!p.multiple,p.defaultValue,!0);break;default:"function"==typeof u.onClick&&(d.onclick=pn)}(l=mn(s,l))&&po(t),t.stateNode=o}null!==t.ref&&(t.effectTag|=128)}else null===t.stateNode&&a("166");break;case 6:o&&null!=t.stateNode?vo(o,t,o.memoizedProps,l):("string"!=typeof l&&(null===t.stateNode&&a("166")),o=Si(_i.current),Si(wi.current),Yi(t)?(s=(l=t).stateNode,o=l.memoizedProps,s[D]=l,(l=s.nodeValue!==o)&&po(t)):(s=t,(l=(9===o.nodeType?o:o.ownerDocument).createTextNode(l))[D]=t,s.stateNode=l));break;case 11:break;case 13:if(l=t.memoizedState,0!=(64&t.effectTag)){t.expirationTime=s,t.firstEffect=t.lastEffect=null,Do=t;break e}((l=null!==l)!==(null!==o&&null!==o.memoizedState)||0==(1&t.effectTag)&&l)&&(t.effectTag|=4);break;case 7:case 8:case 12:break;case 4:Mi(),mo(t);break;case 10:gi(t);break;case 9:case 14:break;case 17:Rn(t.type)&&In();break;default:a("156")}Do=null}if(t=e,1===Oo||1!==t.childExpirationTime){for(l=0,s=t.child;null!==s;)o=s.expirationTime,u=s.childExpirationTime,o>l&&(l=o),u>l&&(l=u),s=s.sibling;t.childExpirationTime=l}if(null!==Do)return Do.firstEffect=Do.lastEffect=null,Do;null!==r&&0==(1024&r.effectTag)&&(null===r.firstEffect&&(r.firstEffect=e.firstEffect),null!==e.lastEffect&&(null!==r.lastEffect&&(r.lastEffect.nextEffect=e.firstEffect),r.lastEffect=e.lastEffect),1<e.effectTag&&(null!==r.lastEffect?r.lastEffect.nextEffect=e:r.firstEffect=e,r.lastEffect=e))}else{if(null!==(e=Ao(e)))return e.effectTag&=1023,e;null!==r&&(r.firstEffect=r.lastEffect=null,r.effectTag|=1024)}if(null!==n)return n;if(null===r)break;e=r}return null}function Wo(e){var t=ho(e.alternate,e,Oo);return e.memoizedProps=e.pendingProps,null===t&&(t=Go(e)),Po.current=null,t}function qo(e,t){No&&a("243"),$o(),No=!0,Po.currentDispatcher=Eo;var r=e.nextExpirationTimeToWorkOn;r===Oo&&e===ko&&null!==Do||(Ho(),Oo=r,Do=jn((ko=e).current,null),e.pendingCommitExpirationTime=0);for(var n=!1;;){try{if(t)for(;null!==Do&&!Aa();)Do=Wo(Do);else for(;null!==Do;)Do=Wo(Do)}catch(t){if(fi=di=pi=null,null===Do)n=!0,Da(t);else{null===Do&&a("271");var i=Do,o=i.return;if(null!==o){e:{var s=e,l=o,u=i,c=t;if(o=Oo,u.effectTag|=1024,u.firstEffect=u.lastEffect=null,null!==c&&"object"==typeof c&&"function"==typeof c.then){var h=c;c=l;var p=-1,d=-1;do{if(13===c.tag){var f=c.alternate;if(null!==f&&null!==(f=f.memoizedState)){d=10*(1073741822-f.timedOutAt);break}"number"==typeof(f=c.pendingProps.maxDuration)&&(0>=f?p=0:(-1===p||f<p)&&(p=f))}c=c.return}while(null!==c);c=l;do{if((f=13===c.tag)&&(f=void 0!==c.memoizedProps.fallback&&null===c.memoizedState),f){if(l=Yo.bind(null,s,c,u,0==(1&c.mode)?1073741823:o),h.then(l,l),0==(1&c.mode)){c.effectTag|=64,Qi(u.alternate,u,null,o),u.effectTag&=-1025,u.effectTag&=-933,1===u.tag&&null===u.alternate&&(u.tag=17),u.expirationTime=o;break e}-1===p?s=1073741823:(-1===d&&(d=10*(1073741822-Yn(s,o))-5e3),s=d+p),0<=s&&Fo<s&&(Fo=s),c.effectTag|=2048,c.expirationTime=o;break e}c=c.return}while(null!==c);c=Error((st(u.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+lt(u))}Lo=!0,c=ci(c,u),s=l;do{switch(s.tag){case 3:u=c,s.effectTag|=2048,s.expirationTime=o,ii(s,o=Mo(s,u,o));break e;case 1:if(u=c,l=s.type,h=s.stateNode,0==(64&s.effectTag)&&("function"==typeof l.getDerivedStateFromError||null!==h&&"function"==typeof h.componentDidCatch&&(null===jo||!jo.has(h)))){s.effectTag|=2048,s.expirationTime=o,ii(s,o=To(s,u,o));break e}}s=s.return}while(null!==s)}Do=Go(i);continue}n=!0,Da(t)}}break}if(No=!1,fi=di=pi=Po.currentDispatcher=null,n)ko=null,e.finishedWork=null;else if(null!==Do)e.finishedWork=null;else{if(null===(n=e.current.alternate)&&a("281"),ko=null,Lo){if(i=e.latestPendingTime,o=e.latestSuspendedTime,s=e.latestPingedTime,0!==i&&i<r||0!==o&&o<r||0!==s&&s<r)return Kn(e,r),void _a(e,n,r,e.expirationTime,-1);if(!e.didError&&t)return e.didError=!0,r=e.nextExpirationTimeToWorkOn=r,t=e.expirationTime=1073741823,void _a(e,n,r,t,-1)}t&&-1!==Fo?(Kn(e,r),(t=10*(1073741822-Yn(e,r)))<Fo&&(Fo=t),t=10*(1073741822-Sa()),t=Fo-t,_a(e,n,r,e.expirationTime,0>t?0:t)):(e.pendingCommitExpirationTime=r,e.finishedWork=n)}}function Xo(e,t){for(var r=e.return;null!==r;){switch(r.tag){case 1:var n=r.stateNode;if("function"==typeof r.type.getDerivedStateFromError||"function"==typeof n.componentDidCatch&&(null===jo||!jo.has(n)))return ni(r,e=To(r,e=ci(t,e),1073741823)),void Jo(r,1073741823);break;case 3:return ni(r,e=Mo(r,e=ci(t,e),1073741823)),void Jo(r,1073741823)}r=r.return}3===e.tag&&(ni(e,r=Mo(e,r=ci(t,e),1073741823)),Jo(e,1073741823))}function Ko(e,t){return 0!==Io?e=Io:No?e=Vo?1073741823:Oo:1&t.mode?(e=pa?1073741822-10*(1+((1073741822-e+15)/10|0)):1073741822-25*(1+((1073741822-e+500)/25|0)),null!==ko&&e===Oo&&--e):e=1073741823,pa&&(0===sa||e<sa)&&(sa=e),e}function Yo(e,t,r,n){var i=e.earliestSuspendedTime,o=e.latestSuspendedTime;if(0!==i&&n<=i&&n>=o){o=i=n,e.didError=!1;var a=e.latestPingedTime;(0===a||a>o)&&(e.latestPingedTime=o),Zn(o,e)}else Xn(e,i=Ko(i=Sa(),t));0!=(1&t.mode)&&e===ko&&Oo===n&&(ko=null),Zo(t,i),0==(1&t.mode)&&(Zo(r,i),1===r.tag&&null!==r.stateNode&&((t=ti(i)).tag=2,ni(r,t))),0!==(r=e.expirationTime)&&Ca(e,r)}function Zo(e,t){e.expirationTime<t&&(e.expirationTime=t);var r=e.alternate;null!==r&&r.expirationTime<t&&(r.expirationTime=t);var n=e.return,i=null;if(null===n&&3===e.tag)i=e.stateNode;else for(;null!==n;){if(r=n.alternate,n.childExpirationTime<t&&(n.childExpirationTime=t),null!==r&&r.childExpirationTime<t&&(r.childExpirationTime=t),null===n.return&&3===n.tag){i=n.stateNode;break}n=n.return}return null===i?null:i}function Jo(e,t){null!==(e=Zo(e,t))&&(!No&&0!==Oo&&t>Oo&&Ho(),Xn(e,t),No&&!Vo&&ko===e||Ca(e,e.expirationTime),ya>va&&(ya=0,a("185")))}function Qo(e,t,r,n,i){var o=Io;Io=1073741823;try{return e(t,r,n,i)}finally{Io=o}}var ea=null,ta=null,ra=0,na=void 0,ia=!1,oa=null,aa=0,sa=0,la=!1,ua=null,ca=!1,ha=!1,pa=!1,da=null,fa=o.unstable_now(),ma=1073741822-(fa/10|0),ga=ma,va=50,ya=0,ba=null;function wa(){ma=1073741822-((o.unstable_now()-fa)/10|0)}function xa(e,t){if(0!==ra){if(t<ra)return;null!==na&&o.unstable_cancelCallback(na)}ra=t,e=o.unstable_now()-fa,na=o.unstable_scheduleCallback(Ea,{timeout:10*(1073741822-t)-e})}function _a(e,t,r,n,i){e.expirationTime=n,0!==i||Aa()?0<i&&(e.timeoutHandle=vn(function(e,t,r){e.pendingCommitExpirationTime=r,e.finishedWork=t,wa(),ga=ma,Ra(e,r)}.bind(null,e,t,r),i)):(e.pendingCommitExpirationTime=r,e.finishedWork=t)}function Sa(){return ia?ga:(Ma(),0!==aa&&1!==aa||(wa(),ga=ma),ga)}function Ca(e,t){null===e.nextScheduledRoot?(e.expirationTime=t,null===ta?(ea=ta=e,e.nextScheduledRoot=e):(ta=ta.nextScheduledRoot=e).nextScheduledRoot=ea):t>e.expirationTime&&(e.expirationTime=t),ia||(ca?ha&&(oa=e,aa=1073741823,Ia(e,1073741823,!1)):1073741823===t?Pa(1073741823,!1):xa(e,t))}function Ma(){var e=0,t=null;if(null!==ta)for(var r=ta,n=ea;null!==n;){var i=n.expirationTime;if(0===i){if((null===r||null===ta)&&a("244"),n===n.nextScheduledRoot){ea=ta=n.nextScheduledRoot=null;break}if(n===ea)ea=i=n.nextScheduledRoot,ta.nextScheduledRoot=i,n.nextScheduledRoot=null;else{if(n===ta){(ta=r).nextScheduledRoot=ea,n.nextScheduledRoot=null;break}r.nextScheduledRoot=n.nextScheduledRoot,n.nextScheduledRoot=null}n=r.nextScheduledRoot}else{if(i>e&&(e=i,t=n),n===ta)break;if(1073741823===e)break;r=n,n=n.nextScheduledRoot}}oa=t,aa=e}var Ta=!1;function Aa(){return!!Ta||!!o.unstable_shouldYield()&&(Ta=!0)}function Ea(){try{if(!Aa()&&null!==ea){wa();var e=ea;do{var t=e.expirationTime;0!==t&&ma<=t&&(e.nextExpirationTimeToWorkOn=ma),e=e.nextScheduledRoot}while(e!==ea)}Pa(0,!0)}finally{Ta=!1}}function Pa(e,t){if(Ma(),t)for(wa(),ga=ma;null!==oa&&0!==aa&&e<=aa&&!(Ta&&ma>aa);)Ia(oa,aa,ma>aa),Ma(),wa(),ga=ma;else for(;null!==oa&&0!==aa&&e<=aa;)Ia(oa,aa,!1),Ma();if(t&&(ra=0,na=null),0!==aa&&xa(oa,aa),ya=0,ba=null,null!==da)for(e=da,da=null,t=0;t<e.length;t++){var r=e[t];try{r._onComplete()}catch(e){la||(la=!0,ua=e)}}if(la)throw e=ua,ua=null,la=!1,e}function Ra(e,t){ia&&a("253"),oa=e,aa=t,Ia(e,t,!1),Pa(1073741823,!1)}function Ia(e,t,r){if(ia&&a("245"),ia=!0,r){var n=e.finishedWork;null!==n?Na(e,n,t):(e.finishedWork=null,-1!==(n=e.timeoutHandle)&&(e.timeoutHandle=-1,yn(n)),qo(e,r),null!==(n=e.finishedWork)&&(Aa()?e.finishedWork=n:Na(e,n,t)))}else null!==(n=e.finishedWork)?Na(e,n,t):(e.finishedWork=null,-1!==(n=e.timeoutHandle)&&(e.timeoutHandle=-1,yn(n)),qo(e,r),null!==(n=e.finishedWork)&&Na(e,n,t));ia=!1}function Na(e,t,r){var n=e.firstBatch;if(null!==n&&n._expirationTime>=r&&(null===da?da=[n]:da.push(n),n._defer))return e.finishedWork=t,void(e.expirationTime=0);e.finishedWork=null,e===ba?ya++:(ba=e,ya=0),Vo=No=!0,e.current===t&&a("177"),0===(r=e.pendingCommitExpirationTime)&&a("261"),e.pendingCommitExpirationTime=0,n=t.expirationTime;var i=t.childExpirationTime;if(n=i>n?i:n,e.didError=!1,0===n?(e.earliestPendingTime=0,e.latestPendingTime=0,e.earliestSuspendedTime=0,e.latestSuspendedTime=0,e.latestPingedTime=0):(0!==(i=e.latestPendingTime)&&(i>n?e.earliestPendingTime=e.latestPendingTime=0:e.earliestPendingTime>n&&(e.earliestPendingTime=e.latestPendingTime)),0===(i=e.earliestSuspendedTime)?Xn(e,n):n<e.latestSuspendedTime?(e.earliestSuspendedTime=0,e.latestSuspendedTime=0,e.latestPingedTime=0,Xn(e,n)):n>i&&Xn(e,n)),Zn(0,e),Po.current=null,1<t.effectTag?null!==t.lastEffect?(t.lastEffect.nextEffect=t,n=t.firstEffect):n=t:n=t.firstEffect,dn=Sr,Fr(i=Or())){if("selectionStart"in i)var o={start:i.selectionStart,end:i.selectionEnd};else e:{var s=(o=(o=i.ownerDocument)&&o.defaultView||window).getSelection&&o.getSelection();if(s&&0!==s.rangeCount){o=s.anchorNode;var l=s.anchorOffset,u=s.focusNode;s=s.focusOffset;try{o.nodeType,u.nodeType}catch(e){o=null;break e}var c=0,h=-1,p=-1,d=0,f=0,m=i,g=null;t:for(;;){for(var v;m!==o||0!==l&&3!==m.nodeType||(h=c+l),m!==u||0!==s&&3!==m.nodeType||(p=c+s),3===m.nodeType&&(c+=m.nodeValue.length),null!==(v=m.firstChild);)g=m,m=v;for(;;){if(m===i)break t;if(g===o&&++d===l&&(h=c),g===u&&++f===s&&(p=c),null!==(v=m.nextSibling))break;g=(m=g).parentNode}m=v}o=-1===h||-1===p?null:{start:h,end:p}}else o=null}o=o||{start:0,end:0}}else o=null;for(fn={focusedElem:i,selectionRange:o},Sr=!1,Uo=n;null!==Uo;){i=!1,o=void 0;try{for(;null!==Uo;){if(256&Uo.effectTag)e:{var y=Uo.alternate;switch((l=Uo).tag){case 0:case 11:case 15:break e;case 1:if(256&l.effectTag&&null!==y){var b=y.memoizedProps,w=y.memoizedState,x=l.stateNode,_=x.getSnapshotBeforeUpdate(l.elementType===l.type?b:Ei(l.type,b),w);x.__reactInternalSnapshotBeforeUpdate=_}break e;case 3:case 5:case 6:case 4:case 17:break e;default:a("163")}}Uo=Uo.nextEffect}}catch(e){i=!0,o=e}i&&(null===Uo&&a("178"),Xo(Uo,o),null!==Uo&&(Uo=Uo.nextEffect))}for(Uo=n;null!==Uo;){y=!1,b=void 0;try{for(;null!==Uo;){var S=Uo.effectTag;if(16&S&&rn(Uo.stateNode,""),128&S){var C=Uo.alternate;if(null!==C){var M=C.ref;null!==M&&("function"==typeof M?M(null):M.current=null)}}switch(14&S){case 2:_o(Uo),Uo.effectTag&=-3;break;case 6:_o(Uo),Uo.effectTag&=-3,Co(Uo.alternate,Uo);break;case 4:Co(Uo.alternate,Uo);break;case 8:So(w=Uo),w.return=null,w.child=null,w.alternate&&(w.alternate.child=null,w.alternate.return=null)}Uo=Uo.nextEffect}}catch(e){y=!0,b=e}y&&(null===Uo&&a("178"),Xo(Uo,b),null!==Uo&&(Uo=Uo.nextEffect))}if(M=fn,C=Or(),S=M.focusedElem,b=M.selectionRange,C!==S&&S&&S.ownerDocument&&function e(t,r){return!(!t||!r)&&(t===r||(!t||3!==t.nodeType)&&(r&&3===r.nodeType?e(t,r.parentNode):"contains"in t?t.contains(r):!!t.compareDocumentPosition&&!!(16&t.compareDocumentPosition(r))))}(S.ownerDocument.documentElement,S)){null!==b&&Fr(S)&&(C=b.start,void 0===(M=b.end)&&(M=C),"selectionStart"in S?(S.selectionStart=C,S.selectionEnd=Math.min(M,S.value.length)):(M=(C=S.ownerDocument||document)&&C.defaultView||window).getSelection&&(M=M.getSelection(),w=S.textContent.length,y=Math.min(b.start,w),b=void 0===b.end?y:Math.min(b.end,w),!M.extend&&y>b&&(w=b,b=y,y=w),w=kr(S,y),x=kr(S,b),w&&x&&(1!==M.rangeCount||M.anchorNode!==w.node||M.anchorOffset!==w.offset||M.focusNode!==x.node||M.focusOffset!==x.offset)&&((C=C.createRange()).setStart(w.node,w.offset),M.removeAllRanges(),y>b?(M.addRange(C),M.extend(x.node,x.offset)):(C.setEnd(x.node,x.offset),M.addRange(C))))),C=[];for(M=S;M=M.parentNode;)1===M.nodeType&&C.push({element:M,left:M.scrollLeft,top:M.scrollTop});for("function"==typeof S.focus&&S.focus(),S=0;S<C.length;S++)(M=C[S]).element.scrollLeft=M.left,M.element.scrollTop=M.top}for(fn=null,Sr=!!dn,dn=null,e.current=t,Uo=n;null!==Uo;){n=!1,S=void 0;try{for(C=r;null!==Uo;){var T=Uo.effectTag;if(36&T){var A=Uo.alternate;switch(y=C,(M=Uo).tag){case 0:case 11:case 15:break;case 1:var E=M.stateNode;if(4&M.effectTag)if(null===A)E.componentDidMount();else{var P=M.elementType===M.type?A.memoizedProps:Ei(M.type,A.memoizedProps);E.componentDidUpdate(P,A.memoizedState,E.__reactInternalSnapshotBeforeUpdate)}var R=M.updateQueue;null!==R&&li(0,R,E);break;case 3:var I=M.updateQueue;if(null!==I){if(b=null,null!==M.child)switch(M.child.tag){case 5:b=M.child.stateNode;break;case 1:b=M.child.stateNode}li(0,I,b)}break;case 5:var N=M.stateNode;null===A&&4&M.effectTag&&mn(M.type,M.memoizedProps)&&N.focus();break;case 6:case 4:case 12:case 13:case 17:break;default:a("163")}}if(128&T){var D=Uo.ref;if(null!==D){var k=Uo.stateNode;switch(Uo.tag){case 5:var O=k;break;default:O=k}"function"==typeof D?D(O):D.current=O}}Uo=Uo.nextEffect}}catch(e){n=!0,S=e}n&&(null===Uo&&a("178"),Xo(Uo,S),null!==Uo&&(Uo=Uo.nextEffect))}No=Vo=!1,"function"==typeof Ln&&Ln(t.stateNode),T=t.expirationTime,0===(t=(t=t.childExpirationTime)>T?t:T)&&(jo=null),e.expirationTime=t,e.finishedWork=null}function Da(e){null===oa&&a("246"),oa.expirationTime=0,la||(la=!0,ua=e)}function ka(e,t){var r=ca;ca=!0;try{return e(t)}finally{(ca=r)||ia||Pa(1073741823,!1)}}function Oa(e,t){if(ca&&!ha){ha=!0;try{return e(t)}finally{ha=!1}}return e(t)}function Fa(e,t,r){if(pa)return e(t,r);ca||ia||0===sa||(Pa(sa,!1),sa=0);var n=pa,i=ca;ca=pa=!0;try{return e(t,r)}finally{pa=n,(ca=i)||ia||Pa(1073741823,!1)}}function La(e,t,r,n,i){var o=t.current;e:if(r){r=r._reactInternalFiber;t:{2===tr(r)&&1===r.tag||a("170");var s=r;do{switch(s.tag){case 3:s=s.stateNode.context;break t;case 1:if(Rn(s.type)){s=s.stateNode.__reactInternalMemoizedMergedChildContext;break t}}s=s.return}while(null!==s);a("171"),s=void 0}if(1===r.tag){var l=r.type;if(Rn(l)){r=kn(r,l,s);break e}}r=s}else r=Mn;return null===t.context?t.context=r:t.pendingContext=r,t=i,(i=ti(n)).payload={element:e},null!==(t=void 0===t?null:t)&&(i.callback=t),$o(),ni(o,i),Jo(o,n),n}function Ua(e,t,r,n){var i=t.current;return La(e,t,r,i=Ko(Sa(),i),n)}function Va(e){if(!(e=e.current).child)return null;switch(e.child.tag){case 5:default:return e.child.stateNode}}function Ba(e){var t=1073741822-25*(1+((1073741822-Sa()+500)/25|0));t>=Ro&&(t=Ro-1),this._expirationTime=Ro=t,this._root=e,this._callbacks=this._next=null,this._hasChildren=this._didComplete=!1,this._children=null,this._defer=!0}function za(){this._callbacks=null,this._didCommit=!1,this._onCommit=this._onCommit.bind(this)}function ja(e,t,r){e={current:t=Bn(3,null,null,t?3:0),containerInfo:e,pendingChildren:null,earliestPendingTime:0,latestPendingTime:0,earliestSuspendedTime:0,latestSuspendedTime:0,latestPingedTime:0,didError:!1,pendingCommitExpirationTime:0,finishedWork:null,timeoutHandle:-1,context:null,pendingContext:null,hydrate:r,nextExpirationTimeToWorkOn:0,expirationTime:0,firstBatch:null,nextScheduledRoot:null},this._internalRoot=t.stateNode=e}function Ha(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function $a(e,t,r,n,i){Ha(r)||a("200");var o=r._reactRootContainer;if(o){if("function"==typeof i){var s=i;i=function(){var e=Va(o._internalRoot);s.call(e)}}null!=e?o.legacy_renderSubtreeIntoContainer(e,t,i):o.render(t,i)}else{if(o=r._reactRootContainer=function(e,t){if(t||(t=!(!(t=e?9===e.nodeType?e.documentElement:e.firstChild:null)||1!==t.nodeType||!t.hasAttribute("data-reactroot"))),!t)for(var r;r=e.lastChild;)e.removeChild(r);return new ja(e,!1,t)}(r,n),"function"==typeof i){var l=i;i=function(){var e=Va(o._internalRoot);l.call(e)}}Oa(function(){null!=e?o.legacy_renderSubtreeIntoContainer(e,t,i):o.render(t,i)})}return Va(o._internalRoot)}function Ga(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return Ha(t)||a("200"),function(e,t,r){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:Xe,key:null==n?null:""+n,children:e,containerInfo:t,implementation:r}}(e,t,null,r)}Te=function(e,t,r){switch(t){case"input":if(_t(e,r),t=r.name,"radio"===r.type&&null!=t){for(r=e;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<r.length;t++){var n=r[t];if(n!==e&&n.form===e.form){var i=U(n);i||a("90"),He(n),_t(n,i)}}}break;case"textarea":Kr(e,r);break;case"select":null!=(t=r.value)&&Wr(e,!!r.multiple,t,!1)}},Ba.prototype.render=function(e){this._defer||a("250"),this._hasChildren=!0,this._children=e;var t=this._root._internalRoot,r=this._expirationTime,n=new za;return La(e,t,null,r,n._onCommit),n},Ba.prototype.then=function(e){if(this._didComplete)e();else{var t=this._callbacks;null===t&&(t=this._callbacks=[]),t.push(e)}},Ba.prototype.commit=function(){var e=this._root._internalRoot,t=e.firstBatch;if(this._defer&&null!==t||a("251"),this._hasChildren){var r=this._expirationTime;if(t!==this){this._hasChildren&&(r=this._expirationTime=t._expirationTime,this.render(this._children));for(var n=null,i=t;i!==this;)n=i,i=i._next;null===n&&a("251"),n._next=i._next,this._next=t,e.firstBatch=this}this._defer=!1,Ra(e,r),t=this._next,this._next=null,null!==(t=e.firstBatch=t)&&t._hasChildren&&t.render(t._children)}else this._next=null,this._defer=!1},Ba.prototype._onComplete=function(){if(!this._didComplete){this._didComplete=!0;var e=this._callbacks;if(null!==e)for(var t=0;t<e.length;t++)(0,e[t])()}},za.prototype.then=function(e){if(this._didCommit)e();else{var t=this._callbacks;null===t&&(t=this._callbacks=[]),t.push(e)}},za.prototype._onCommit=function(){if(!this._didCommit){this._didCommit=!0;var e=this._callbacks;if(null!==e)for(var t=0;t<e.length;t++){var r=e[t];"function"!=typeof r&&a("191",r),r()}}},ja.prototype.render=function(e,t){var r=this._internalRoot,n=new za;return null!==(t=void 0===t?null:t)&&n.then(t),Ua(e,r,null,n._onCommit),n},ja.prototype.unmount=function(e){var t=this._internalRoot,r=new za;return null!==(e=void 0===e?null:e)&&r.then(e),Ua(null,t,null,r._onCommit),r},ja.prototype.legacy_renderSubtreeIntoContainer=function(e,t,r){var n=this._internalRoot,i=new za;return null!==(r=void 0===r?null:r)&&i.then(r),Ua(t,n,e,i._onCommit),i},ja.prototype.createBatch=function(){var e=new Ba(this),t=e._expirationTime,r=this._internalRoot,n=r.firstBatch;if(null===n)r.firstBatch=e,e._next=null;else{for(r=null;null!==n&&n._expirationTime>=t;)r=n,n=n._next;e._next=n,null!==r&&(r._next=e)}return e},Ne=ka,De=Fa,ke=function(){ia||0===sa||(Pa(sa,!1),sa=0)};var Wa={createPortal:Ga,findDOMNode:function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternalFiber;return void 0===t&&("function"==typeof e.render?a("188"):a("268",Object.keys(e))),e=null===(e=nr(t))?null:e.stateNode},hydrate:function(e,t,r){return $a(null,e,t,!0,r)},render:function(e,t,r){return $a(null,e,t,!1,r)},unstable_renderSubtreeIntoContainer:function(e,t,r,n){return(null==e||void 0===e._reactInternalFiber)&&a("38"),$a(e,t,r,!1,n)},unmountComponentAtNode:function(e){return Ha(e)||a("40"),!!e._reactRootContainer&&(Oa(function(){$a(null,null,e,!1,function(){e._reactRootContainer=null})}),!0)},unstable_createPortal:function(){return Ga.apply(void 0,arguments)},unstable_batchedUpdates:ka,unstable_interactiveUpdates:Fa,flushSync:function(e,t){ia&&a("187");var r=ca;ca=!0;try{return Qo(e,t)}finally{ca=r,Pa(1073741823,!1)}},unstable_flushControlled:function(e){var t=ca;ca=!0;try{Qo(e)}finally{(ca=t)||ia||Pa(1073741823,!1)}},__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:{Events:[F,L,U,P.injectEventPluginsByName,y,$,function(e){T(e,H)},Re,Ie,Ar,I]},unstable_createRoot:function(e,t){return Ha(e)||a("299","unstable_createRoot"),new ja(e,!0,null!=t&&!0===t.hydrate)}};!function(e){var t=e.findFiberByHostInstance;(function(e){if("undefined"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var t=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(t.isDisabled||!t.supportsFiber)return!0;try{var r=t.inject(e);Ln=Vn(function(e){return t.onCommitFiberRoot(r,e)}),Un=Vn(function(e){return t.onCommitFiberUnmount(r,e)})}catch(e){}})(i({},e,{findHostInstanceByFiber:function(e){return null===(e=nr(e))?null:e.stateNode},findFiberByHostInstance:function(e){return t?t(e):null}}))}({findFiberByHostInstance:O,bundleType:0,version:"16.6.1",rendererPackageName:"react-dom"});var qa={default:Wa},Xa=qa&&Wa||qa;e.exports=Xa.default||Xa},"./node_modules/react-dom/index.js":function(e,t,r){"use strict";!function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),e.exports=r("./node_modules/react-dom/cjs/react-dom.production.min.js")},"./node_modules/react/cjs/react.production.min.js":function(e,t,r){"use strict";
/** @license React v16.6.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var n=r("./node_modules/object-assign/index.js"),i="function"==typeof Symbol&&Symbol.for,o=i?Symbol.for("react.element"):60103,a=i?Symbol.for("react.portal"):60106,s=i?Symbol.for("react.fragment"):60107,l=i?Symbol.for("react.strict_mode"):60108,u=i?Symbol.for("react.profiler"):60114,c=i?Symbol.for("react.provider"):60109,h=i?Symbol.for("react.context"):60110,p=i?Symbol.for("react.concurrent_mode"):60111,d=i?Symbol.for("react.forward_ref"):60112,f=i?Symbol.for("react.suspense"):60113,m=i?Symbol.for("react.memo"):60115,g=i?Symbol.for("react.lazy"):60116,v="function"==typeof Symbol&&Symbol.iterator;function y(e){for(var t=arguments.length-1,r="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=0;n<t;n++)r+="&args[]="+encodeURIComponent(arguments[n+1]);!function(e,t,r,n,i,o,a,s){if(!e){if(e=void 0,void 0===t)e=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var l=[r,n,i,o,a,s],u=0;(e=Error(t.replace(/%s/g,function(){return l[u++]}))).name="Invariant Violation"}throw e.framesToPop=1,e}}(!1,"Minified React error #"+e+"; visit %s for the full message or use the non-minified dev environment for full errors and additional helpful warnings. ",r)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},w={};function x(e,t,r){this.props=e,this.context=t,this.refs=w,this.updater=r||b}function _(){}function S(e,t,r){this.props=e,this.context=t,this.refs=w,this.updater=r||b}x.prototype.isReactComponent={},x.prototype.setState=function(e,t){"object"!=typeof e&&"function"!=typeof e&&null!=e&&y("85"),this.updater.enqueueSetState(this,e,t,"setState")},x.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},_.prototype=x.prototype;var C=S.prototype=new _;C.constructor=S,n(C,x.prototype),C.isPureReactComponent=!0;var M={current:null,currentDispatcher:null},T=Object.prototype.hasOwnProperty,A={key:!0,ref:!0,__self:!0,__source:!0};function E(e,t,r){var n=void 0,i={},a=null,s=null;if(null!=t)for(n in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(a=""+t.key),t)T.call(t,n)&&!A.hasOwnProperty(n)&&(i[n]=t[n]);var l=arguments.length-2;if(1===l)i.children=r;else if(1<l){for(var u=Array(l),c=0;c<l;c++)u[c]=arguments[c+2];i.children=u}if(e&&e.defaultProps)for(n in l=e.defaultProps)void 0===i[n]&&(i[n]=l[n]);return{$$typeof:o,type:e,key:a,ref:s,props:i,_owner:M.current}}function P(e){return"object"==typeof e&&null!==e&&e.$$typeof===o}var R=/\/+/g,I=[];function N(e,t,r,n){if(I.length){var i=I.pop();return i.result=e,i.keyPrefix=t,i.func=r,i.context=n,i.count=0,i}return{result:e,keyPrefix:t,func:r,context:n,count:0}}function D(e){e.result=null,e.keyPrefix=null,e.func=null,e.context=null,e.count=0,10>I.length&&I.push(e)}function k(e,t,r){return null==e?0:function e(t,r,n,i){var s=typeof t;"undefined"!==s&&"boolean"!==s||(t=null);var l=!1;if(null===t)l=!0;else switch(s){case"string":case"number":l=!0;break;case"object":switch(t.$$typeof){case o:case a:l=!0}}if(l)return n(i,t,""===r?"."+O(t,0):r),1;if(l=0,r=""===r?".":r+":",Array.isArray(t))for(var u=0;u<t.length;u++){var c=r+O(s=t[u],u);l+=e(s,c,n,i)}else if(c=null===t||"object"!=typeof t?null:"function"==typeof(c=v&&t[v]||t["@@iterator"])?c:null,"function"==typeof c)for(t=c.call(t),u=0;!(s=t.next()).done;)l+=e(s=s.value,c=r+O(s,u++),n,i);else"object"===s&&y("31","[object Object]"==(n=""+t)?"object with keys {"+Object.keys(t).join(", ")+"}":n,"");return l}(e,"",t,r)}function O(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+(""+e).replace(/[=:]/g,function(e){return t[e]})}(e.key):t.toString(36)}function F(e,t){e.func.call(e.context,t,e.count++)}function L(e,t,r){var n=e.result,i=e.keyPrefix;e=e.func.call(e.context,t,e.count++),Array.isArray(e)?U(e,n,r,function(e){return e}):null!=e&&(P(e)&&(e=function(e,t){return{$$typeof:o,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(e,i+(!e.key||t&&t.key===e.key?"":(""+e.key).replace(R,"$&/")+"/")+r)),n.push(e))}function U(e,t,r,n,i){var o="";null!=r&&(o=(""+r).replace(R,"$&/")+"/"),k(e,L,t=N(t,o,n,i)),D(t)}var V={Children:{map:function(e,t,r){if(null==e)return e;var n=[];return U(e,n,null,t,r),n},forEach:function(e,t,r){if(null==e)return e;k(e,F,t=N(null,null,t,r)),D(t)},count:function(e){return k(e,function(){return null},null)},toArray:function(e){var t=[];return U(e,t,null,function(e){return e}),t},only:function(e){return P(e)||y("143"),e}},createRef:function(){return{current:null}},Component:x,PureComponent:S,createContext:function(e,t){return void 0===t&&(t=null),(e={$$typeof:h,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,Provider:null,Consumer:null}).Provider={$$typeof:c,_context:e},e.Consumer=e},forwardRef:function(e){return{$$typeof:d,render:e}},lazy:function(e){return{$$typeof:g,_ctor:e,_status:-1,_result:null}},memo:function(e,t){return{$$typeof:m,type:e,compare:void 0===t?null:t}},Fragment:s,StrictMode:l,Suspense:f,createElement:E,cloneElement:function(e,t,r){(null===e||void 0===e)&&y("267",e);var i=void 0,a=n({},e.props),s=e.key,l=e.ref,u=e._owner;if(null!=t){void 0!==t.ref&&(l=t.ref,u=M.current),void 0!==t.key&&(s=""+t.key);var c=void 0;for(i in e.type&&e.type.defaultProps&&(c=e.type.defaultProps),t)T.call(t,i)&&!A.hasOwnProperty(i)&&(a[i]=void 0===t[i]&&void 0!==c?c[i]:t[i])}if(1===(i=arguments.length-2))a.children=r;else if(1<i){c=Array(i);for(var h=0;h<i;h++)c[h]=arguments[h+2];a.children=c}return{$$typeof:o,type:e.type,key:s,ref:l,props:a,_owner:u}},createFactory:function(e){var t=E.bind(null,e);return t.type=e,t},isValidElement:P,version:"16.6.1",__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:{ReactCurrentOwner:M,assign:n}};V.unstable_ConcurrentMode=p,V.unstable_Profiler=u;var B={default:V},z=B&&V||B;e.exports=z.default||z},"./node_modules/react/index.js":function(e,t,r){"use strict";e.exports=r("./node_modules/react/cjs/react.production.min.js")},"./node_modules/scheduler/cjs/scheduler.production.min.js":function(e,t,r){"use strict";
/** @license React v16.6.1
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */Object.defineProperty(t,"__esModule",{value:!0});var n=null,i=!1,o=3,a=-1,s=-1,l=!1,u=!1;function c(){if(!l){var e=n.expirationTime;u?v():u=!0,g(d,e)}}function h(){var e=n,t=n.next;if(n===t)n=null;else{var r=n.previous;n=r.next=t,t.previous=r}e.next=e.previous=null,r=e.callback,t=e.expirationTime,e=e.priorityLevel;var i=o,a=s;o=e,s=t;try{var l=r()}finally{o=i,s=a}if("function"==typeof l)if(l={callback:l,priorityLevel:e,expirationTime:t,next:null,previous:null},null===n)n=l.next=l.previous=l;else{r=null,e=n;do{if(e.expirationTime>=t){r=e;break}e=e.next}while(e!==n);null===r?r=n:r===n&&(n=l,c()),(t=r.previous).next=r.previous=l,l.next=r,l.previous=t}}function p(){if(-1===a&&null!==n&&1===n.priorityLevel){l=!0;try{do{h()}while(null!==n&&1===n.priorityLevel)}finally{l=!1,null!==n?c():u=!1}}}function d(e){l=!0;var r=i;i=e;try{if(e)for(;null!==n;){var o=t.unstable_now();if(!(n.expirationTime<=o))break;do{h()}while(null!==n&&n.expirationTime<=o)}else if(null!==n)do{h()}while(null!==n&&!y())}finally{l=!1,i=r,null!==n?c():u=!1,p()}}var f,m,g,v,y,b=Date,w="function"==typeof setTimeout?setTimeout:void 0,x="function"==typeof clearTimeout?clearTimeout:void 0,_="function"==typeof requestAnimationFrame?requestAnimationFrame:void 0,S="function"==typeof cancelAnimationFrame?cancelAnimationFrame:void 0;function C(e){f=_(function(t){x(m),e(t)}),m=w(function(){S(f),e(t.unstable_now())},100)}if("object"==typeof performance&&"function"==typeof performance.now){var M=performance;t.unstable_now=function(){return M.now()}}else t.unstable_now=function(){return b.now()};if("undefined"!=typeof window&&window._schedMock){var T=window._schedMock;g=T[0],v=T[1],y=T[2]}else if("undefined"==typeof window||"function"!=typeof window.addEventListener){var A=null,E=-1,P=function(e,t){if(null!==A){var r=A;A=null;try{E=t,r(e)}finally{E=-1}}};g=function(e,t){-1!==E?setTimeout(g,0,e,t):(A=e,setTimeout(P,t,!0,t),setTimeout(P,1073741823,!1,1073741823))},v=function(){A=null},y=function(){return!1},t.unstable_now=function(){return-1===E?0:E}}else{"undefined"!=typeof console&&("function"!=typeof _&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),"function"!=typeof S&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));var R=null,I=!1,N=-1,D=!1,k=!1,O=0,F=33,L=33;y=function(){return O<=t.unstable_now()};var U="__reactIdleCallback$"+Math.random().toString(36).slice(2);window.addEventListener("message",function(e){if(e.source===window&&e.data===U){I=!1,e=R;var r=N;R=null,N=-1;var n=t.unstable_now(),i=!1;if(0>=O-n){if(!(-1!==r&&r<=n))return D||(D=!0,C(V)),R=e,void(N=r);i=!0}if(null!==e){k=!0;try{e(i)}finally{k=!1}}}},!1);var V=function(e){if(null!==R){C(V);var t=e-O+L;t<L&&F<L?(8>t&&(t=8),L=t<F?F:t):F=t,O=e+L,I||(I=!0,window.postMessage(U,"*"))}else D=!1};g=function(e,t){R=e,N=t,k||0>t?window.postMessage(U,"*"):D||(D=!0,C(V))},v=function(){R=null,I=!1,N=-1}}t.unstable_ImmediatePriority=1,t.unstable_UserBlockingPriority=2,t.unstable_NormalPriority=3,t.unstable_IdlePriority=4,t.unstable_runWithPriority=function(e,r){switch(e){case 1:case 2:case 3:case 4:break;default:e=3}var n=o,i=a;o=e,a=t.unstable_now();try{return r()}finally{o=n,a=i,p()}},t.unstable_scheduleCallback=function(e,r){var i=-1!==a?a:t.unstable_now();if("object"==typeof r&&null!==r&&"number"==typeof r.timeout)r=i+r.timeout;else switch(o){case 1:r=i+-1;break;case 2:r=i+250;break;case 4:r=i+1073741823;break;default:r=i+5e3}if(e={callback:e,priorityLevel:o,expirationTime:r,next:null,previous:null},null===n)n=e.next=e.previous=e,c();else{i=null;var s=n;do{if(s.expirationTime>r){i=s;break}s=s.next}while(s!==n);null===i?i=n:i===n&&(n=e,c()),(r=i.previous).next=i.previous=e,e.next=i,e.previous=r}return e},t.unstable_cancelCallback=function(e){var t=e.next;if(null!==t){if(t===e)n=null;else{e===n&&(n=t);var r=e.previous;r.next=t,t.previous=r}e.next=e.previous=null}},t.unstable_wrapCallback=function(e){var r=o;return function(){var n=o,i=a;o=r,a=t.unstable_now();try{return e.apply(this,arguments)}finally{o=n,a=i,p()}}},t.unstable_getCurrentPriorityLevel=function(){return o},t.unstable_shouldYield=function(){return!i&&(null!==n&&n.expirationTime<s||y())}},"./node_modules/scheduler/index.js":function(e,t,r){"use strict";e.exports=r("./node_modules/scheduler/cjs/scheduler.production.min.js")},"./node_modules/setimmediate/setImmediate.js":function(e,t,r){(function(e,t){!function(e,r){"use strict";if(!e.setImmediate){var n,i=1,o={},a=!1,s=e.document,l=Object.getPrototypeOf&&Object.getPrototypeOf(e);l=l&&l.setTimeout?l:e,"[object process]"==={}.toString.call(e.process)?n=function(e){t.nextTick(function(){c(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,r=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=r,t}}()?function(){var t="setImmediate$"+Math.random()+"$",r=function(r){r.source===e&&"string"==typeof r.data&&0===r.data.indexOf(t)&&c(+r.data.slice(t.length))};e.addEventListener?e.addEventListener("message",r,!1):e.attachEvent("onmessage",r),n=function(r){e.postMessage(t+r,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){c(e.data)},n=function(t){e.port2.postMessage(t)}}():s&&"onreadystatechange"in s.createElement("script")?function(){var e=s.documentElement;n=function(t){var r=s.createElement("script");r.onreadystatechange=function(){c(t),r.onreadystatechange=null,e.removeChild(r),r=null},e.appendChild(r)}}():n=function(e){setTimeout(c,0,e)},l.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),r=0;r<t.length;r++)t[r]=arguments[r+1];var a={callback:e,args:t};return o[i]=a,n(i),i++},l.clearImmediate=u}function u(e){delete o[e]}function c(e){if(a)setTimeout(c,0,e);else{var t=o[e];if(t){a=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(r,n)}}(t)}finally{u(e),a=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,r("./node_modules/webpack/buildin/global.js"),r("./node_modules/node-libs-browser/node_modules/process/browser.js"))},"./node_modules/timers-browserify/main.js":function(e,t,r){(function(e){var n=void 0!==e&&e||"undefined"!=typeof self&&self||window,i=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(i.call(setTimeout,n,arguments),clearTimeout)},t.setInterval=function(){return new o(i.call(setInterval,n,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(n,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},r("./node_modules/setimmediate/setImmediate.js"),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,r("./node_modules/webpack/buildin/global.js"))},"./node_modules/webpack/buildin/amd-options.js":function(e,t){(function(t){e.exports=t}).call(this,{})},"./node_modules/webpack/buildin/global.js":function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(r=window)}e.exports=r},"./node_modules/webpack/buildin/harmony-module.js":function(e,t){e.exports=function(e){if(!e.webpackPolyfill){var t=Object.create(e);t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1}return t}},"./node_modules/webpack/buildin/module.js":function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}}}]);